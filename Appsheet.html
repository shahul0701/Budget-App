<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-Code Dashboard App Builder</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.9/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        .draggable { 
            cursor: move; 
            transition: all 0.3s ease; 
            user-select: none;
        }
        .draggable:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .dropzone { 
            min-height: 300px; 
            border: 2px dashed #d1d5db; 
            padding: 20px; 
            background: #f9fafb; 
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .dropzone.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        .form-field { 
            margin-bottom: 15px; 
            padding: 15px; 
            background: #ffffff; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            border-left: 4px solid #3b82f6;
            position: relative;
        }
        .form-field:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .tab { 
            cursor: pointer; 
            padding: 14px 24px; 
            background: #f3f4f6; 
            margin-right: 5px; 
            border-radius: 8px 8px 0 0; 
            font-weight: 600;
            transition: all 0.2s ease;
            color: #6b7280;
        }
        .tab.active { 
            background: #ffffff; 
            border: 1px solid #e5e7eb; 
            border-bottom: none; 
            color: #3b82f6; 
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        .tab:hover:not(.active) {
            background: #e5e7eb;
            color: #4b5563;
        }
        .bg-gradient-blue { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .field-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .form-field:hover .field-actions {
            opacity: 1;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn i {
            margin-right: 6px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .sidebar {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }
        @media (max-width: 640px) {
            .tab { padding: 10px 16px; font-size: 14px; }
            .form-field { padding: 12px; }
            .dropzone { min-height: 250px; padding: 15px; }
        }
        .grid-stack {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        .grid-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: move;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .grid-item i {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration (replace with your Firebase project config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.auth().signInAnonymously()
            .then(() => console.log("Signed in anonymously"))
            .catch(error => console.error("Anonymous auth error:", error));

        function App() {
            const [tables, setTables] = useState(['default']);
            const [currentTable, setCurrentTable] = useState('default');
            const [tableFields, setTableFields] = useState({ default: [] });
            const [computedFields, setComputedFields] = useState({ default: [] });
            const [records, setRecords] = useState([]);
            const [newRecord, setNewRecord] = useState({});
            const [dragField, setDragField] = useState(null);
            const [activeTab, setActiveTab] = useState('builder');
            const [chartType, setChartType] = useState('bar');
            const [chartFieldX, setChartFieldX] = useState('');
            const [chartFieldY, setChartFieldY] = useState('');
            const [isDraggingOver, setIsDraggingOver] = useState(false);
            const [editingFieldIndex, setEditingFieldIndex] = useState(null);
            const chartInstance = useRef(null);
            const canvasRef = useRef(null);
            const unsubscribe = useRef(null);

            // Fetch table configurations and records
            useEffect(() => {
                // Fetch table list
                db.collection('tables').onSnapshot(snapshot => {
                    const tableNames = snapshot.docs.map(doc => doc.id);
                    setTables(tableNames.length > 0 ? tableNames : ['default']);
                    const configs = {};
                    const computedConfigs = {};
                    snapshot.docs.forEach(doc => {
                        configs[doc.id] = doc.data().fields || [];
                        computedConfigs[doc.id] = doc.data().computedFields || [];
                    });
                    setTableFields(configs);
                    setComputedFields(computedConfigs);
                });
            }, []);

            // Fetch records for current table
            useEffect(() => {
                if (unsubscribe.current) unsubscribe.current();
                unsubscribe.current = db.collection('tables').doc(currentTable).collection('records').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRecords(data);
                });
                return () => unsubscribe.current && unsubscribe.current();
            }, [currentTable]);

            // Handle drag start
            const handleDragStart = (e, fieldType) => {
                setDragField(fieldType);
                e.dataTransfer.setData("text/plain", fieldType);
            };

            // Handle drag over
            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDraggingOver(true);
            };

            // Handle drag leave
            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDraggingOver(false);
            };

            // Handle drop
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDraggingOver(false);
                if (dragField) {
                    const newField = { 
                        type: dragField, 
                        label: `${dragField.charAt(0).toUpperCase() + dragField.slice(1)} Field`,
                        id: Date.now().toString() // Unique ID for each field
                    };
                    const newFields = [...(tableFields[currentTable] || []), newField];
                    setTableFields({ ...tableFields, [currentTable]: newFields });
                    // Save to Firebase
                    db.collection('tables').doc(currentTable).set({ 
                        fields: newFields, 
                        computedFields: computedFields[currentTable] || [] 
                    }, { merge: true });
                }
                setDragField(null);
            };

            // Delete a field
            const deleteField = (index) => {
                const newFields = [...(tableFields[currentTable] || [])];
                newFields.splice(index, 1);
                setTableFields({ ...tableFields, [currentTable]: newFields });
                db.collection('tables').doc(currentTable).set({ 
                    fields: newFields, 
                    computedFields: computedFields[currentTable] || [] 
                }, { merge: true });
            };

            // Handle form input change
            const handleInputChange = (e, key) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                setNewRecord({ ...newRecord, [key]: value });
            };

            // Update field label
            const updateFieldLabel = (index, newLabel) => {
                const newFields = [...(tableFields[currentTable] || [])];
                newFields[index].label = newLabel;
                setTableFields({ ...tableFields, [currentTable]: newFields });
                db.collection('tables').doc(currentTable).set({ 
                    fields: newFields, 
                    computedFields: computedFields[currentTable] || [] 
                }, { merge: true });
            };

            // Update field type
            const updateFieldType = (index, newType) => {
                const newFields = [...(tableFields[currentTable] || [])];
                newFields[index].type = newType;
                setTableFields({ ...tableFields, [currentTable]: newFields });
                db.collection('tables').doc(currentTable).set({ 
                    fields: newFields, 
                    computedFields: computedFields[currentTable] || [] 
                }, { merge: true });
            };

            // Save record to Firebase
            const saveRecord = () => {
                if (Object.keys(newRecord).length > 0) {
                    let data = { ...newRecord };
                    (computedFields[currentTable] || []).forEach(cf => {
                        let expr = cf.formula;
                        expr = expr.replace(/\[(.*?)\]/g, (match, f) => newRecord[f] !== undefined ? (typeof newRecord[f] === 'string' ? `"${newRecord[f]}"` : newRecord[f]) : '0');
                        try {
                            data[cf.name] = eval(expr); // Unsafe; use math.js in production
                        } catch (err) {
                            data[cf.name] = 'Error';
                        }
                    });
                    db.collection('tables').doc(currentTable).collection('records').add(data)
                        .then(() => {
                            setNewRecord({});
                            document.getElementById("record-form").reset();
                        })
                        .catch(error => console.error("Error saving record:", error));
                }
            };

            // Add computed field
            const addComputedField = () => {
                const name = document.getElementById('comp-name').value;
                const formula = document.getElementById('comp-formula').value;
                if (name && formula) {
                    const newComputed = [...(computedFields[currentTable] || []), { name, formula }];
                    setComputedFields({ ...computedFields, [currentTable]: newComputed });
                    db.collection('tables').doc(currentTable).set({ 
                        fields: tableFields[currentTable] || [], 
                        computedFields: newComputed 
                    }, { merge: true });
                    // Update existing records
                    db.collection('tables').doc(currentTable).collection('records').get().then(snapshot => {
                        snapshot.docs.forEach(doc => {
                            const record = doc.data();
                            let expr = formula;
                            expr = expr.replace(/\[(.*?)\]/g, (match, f) => record[f] !== undefined ? (typeof record[f] === 'string' ? `"${record[f]}"` : record[f]) : '0');
                            try {
                                db.collection('tables').doc(currentTable).collection('records').doc(doc.id).update({ [name]: eval(expr) });
                            } catch (err) {
                                db.collection('tables').doc(currentTable).collection('records').doc(doc.id).update({ [name]: 'Error' });
                            }
                        });
                    });
                    document.getElementById('comp-name').value = '';
                    document.getElementById('comp-formula').value = '';
                }
            };

            // Delete computed field
            const deleteComputedField = (index) => {
                const newComputed = [...(computedFields[currentTable] || [])];
                newComputed.splice(index, 1);
                setComputedFields({ ...computedFields, [currentTable]: newComputed });
                db.collection('tables').doc(currentTable).set({ 
                    fields: tableFields[currentTable] || [], 
                    computedFields: newComputed 
                }, { merge: true });
            };

            // Add new table
            const addNewTable = () => {
                const name = document.getElementById('newTable').value.trim();
                if (name && !tables.includes(name)) {
                    setTables([...tables, name]);
                    setTableFields({ ...tableFields, [name]: [] });
                    setComputedFields({ ...computedFields, [name]: [] });
                    setCurrentTable(name);
                    db.collection('tables').doc(name).set({ fields: [], computedFields: [] });
                    document.getElementById('newTable').value = '';
                }
            };

            // Delete table
            const deleteTable = (tableName) => {
                if (tables.length <= 1) {
                    alert("You cannot delete the only table.");
                    return;
                }
                
                if (window.confirm(`Are you sure you want to delete the table "${tableName}"? This will also delete all its data.`)) {
                    // Delete from Firebase
                    db.collection('tables').doc(tableName).delete()
                        .then(() => {
                            // Update local state
                            const newTables = tables.filter(t => t !== tableName);
                            setTables(newTables);
                            setCurrentTable(newTables[0]);
                            
                            // Delete all records in the table
                            db.collection('tables').doc(tableName).collection('records').get()
                                .then(snapshot => {
                                    const batch = db.batch();
                                    snapshot.docs.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });
                                    return batch.commit();
                                });
                        })
                        .catch(error => console.error("Error deleting table:", error));
                }
            };

            // Render chart
            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                if (canvasRef.current && chartFieldX && chartFieldY && records.length > 0) {
                    const labels = records.map(r => r[chartFieldX] || 'Unknown');
                    const data = records.map(r => parseFloat(r[chartFieldY]) || 0);
                    chartInstance.current = new Chart(canvasRef.current, {
                        type: chartType,
                        data: {
                            labels,
                            datasets: [{
                                label: chartFieldY,
                                data,
                                backgroundColor: chartType === 'pie' ? [
                                    'rgba(239, 68, 68, 0.7)',
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(16, 185, 129, 0.7)',
                                    'rgba(245, 158, 11, 0.7)',
                                    'rgba(139, 92, 246, 0.7)',
                                    'rgba(236, 72, 153, 0.7)'
                                ] : 'rgba(59,130,246,0.4)',
                                borderColor: 'rgba(59,130,246,1)',
                                borderWidth: 1
                            }]
                        },
                        options: { 
                            scales: { y: { beginAtZero: true } }, 
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `${chartFieldY} by ${chartFieldX}`
                                }
                            }
                        }
                    });
                }
            }, [chartType, chartFieldX, chartFieldY, records]);

            // Render input based on field type
            const renderInput = (field, index) => {
                const key = field.label;
                if (field.type === 'checkbox') {
                    return <input type="checkbox" checked={newRecord[key] || false} onChange={(e) => handleInputChange(e, key)} className="h-5 w-5" />;
                } else if (field.type === 'select') {
                    return (
                        <select className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)}>
                            <option value="">Select...</option>
                            <option value="Option A">Option A</option>
                            <option value="Option B">Option B</option>
                            <option value="Option C">Option C</option>
                        </select>
                    );
                } else if (field.type === 'yesno') {
                    return (
                        <select className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)}>
                            <option value="">Select...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    );
                } else if (field.type === 'textarea') {
                    return <textarea className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} rows="4" />;
                } else if (field.type === 'date') {
                    return <input type="date" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} />;
                } else if (field.type === 'time') {
                    return <input type="time" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} />;
                } else if (field.type === 'color') {
                    return <input type="color" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 h-10" value={newRecord[key] || '#3b82f6'} onChange={(e) => handleInputChange(e, key)} />;
                } else if (field.type === 'range') {
                    return <input type="range" className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || 50} onChange={(e) => handleInputChange(e, key)} min="0" max="100" />;
                } else {
                    return <input type={field.type} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} placeholder={`Enter ${field.label}`} />;
                }
            };

            const allFields = [...(tableFields[currentTable] || []).map(f => f.label), ...(computedFields[currentTable] || []).map(cf => cf.name)];

            // Field type options
            const fieldTypes = [
                { value: 'text', label: 'Text', icon: 'font' },
                { value: 'number', label: 'Number', icon: 'hashtag' },
                { value: 'email', label: 'Email', icon: 'envelope' },
                { value: 'tel', label: 'Phone', icon: 'phone' },
                { value: 'date', label: 'Date', icon: 'calendar' },
                { value: 'time', label: 'Time', icon: 'clock' },
                { value: 'checkbox', label: 'Checkbox', icon: 'square-check' },
                { value: 'select', label: 'Dropdown', icon: 'caret-down' },
                { value: 'textarea', label: 'Text Area', icon: 'align-left' },
                { value: 'yesno', label: 'Yes/No', icon: 'circle-question' },
                { value: 'color', label: 'Color', icon: 'palette' },
                { value: 'range', label: 'Range', icon: 'sliders' }
            ];

            return (
                <div className="container mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen">
                    <h1 className="text-3xl font-bold text-white bg-gradient-blue p-6 rounded-xl shadow-lg mb-6 flex items-center">
                        <i className="fas fa-chart-dashboard mr-3"></i>
                        No-Code Dashboard App Builder
                    </h1>
                    
                    <div className="flex flex-wrap mb-4 border-b-2 border-gray-200">
                        <div className={`tab ${activeTab === 'builder' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('builder')}>
                            <i className="fas fa-wrench mr-2"></i>Form Builder
                        </div>
                        <div className={`tab ${activeTab === 'data' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('data')}>
                            <i className="fas fa-table mr-2"></i>Data Table
                        </div>
                        <div className={`tab ${activeTab === 'formulas' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('formulas')}>
                            <i className="fas fa-calculator mr-2"></i>Formulas
                        </div>
                        <div className={`tab ${activeTab === 'charts' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('charts')}>
                            <i className="fas fa-chart-bar mr-2"></i>Charts
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6">
                        {activeTab === 'builder' && (
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div className="lg:col-span-1 sidebar">
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <i className="fas fa-table-cells-large mr-2"></i>Table Management
                                    </h3>
                                    <div className="mb-4 flex flex-col gap-2">
                                        <select value={currentTable} onChange={(e) => setCurrentTable(e.target.value)} className="p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                            {tables.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                        <div className="flex gap-2">
                                            <input id="newTable" placeholder="New Table Name" className="p-2 border rounded flex-grow focus:ring-2 focus:ring-blue-500" />
                                            <button className="btn btn-success" onClick={addNewTable} title="Add Table">
                                                <i className="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        {tables.length > 1 && (
                                            <button className="btn btn-danger" onClick={() => deleteTable(currentTable)}>
                                                <i className="fas fa-trash mr-1"></i>Delete Current Table
                                            </button>
                                        )}
                                    </div>
                                    
                                    <h3 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                        <i className="fas fa-shapes mr-2"></i>Available Fields
                                    </h3>
                                    <div className="grid-stack">
                                        {fieldTypes.map(fieldType => (
                                            <div key={fieldType.value} className="grid-item draggable" draggable onDragStart={(e) => handleDragStart(e, fieldType.value)}>
                                                <i className={`fas fa-${fieldType.icon}`}></i>
                                                {fieldType.label}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="lg:col-span-3">
                                    <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                        <i className="fas fa-pen-to-square mr-2"></i>Form Builder for {currentTable}
                                    </h2>
                                    
                                    <div 
                                        className={`dropzone ${isDraggingOver ? 'drag-over' : ''}`} 
                                        onDragOver={handleDragOver}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleDrop}
                                    >
                                        <h3 className="text-lg font-medium text-gray-700 mb-4">Form Preview</h3>
                                        
                                        {(tableFields[currentTable] || []).length === 0 ? (
                                            <div className="text-center py-10 text-gray-400">
                                                <i className="fas fa-cloud-arrow-down text-4xl mb-3"></i>
                                                <p>Drag and drop fields from the sidebar to build your form</p>
                                            </div>
                                        ) : (
                                            <form id="record-form" className="space-y-4">
                                                {(tableFields[currentTable] || []).map((field, index) => (
                                                    <div key={field.id || index} className="form-field">
                                                        <div className="field-actions flex gap-2">
                                                            <button 
                                                                className="text-blue-500 hover:text-blue-700" 
                                                                onClick={() => setEditingFieldIndex(editingFieldIndex === index ? null : index)}
                                                                title="Edit Field"
                                                            >
                                                                <i className="fas fa-edit"></i>
                                                            </button>
                                                            <button 
                                                                className="text-red-500 hover:text-red-700" 
                                                                onClick={() => deleteField(index)}
                                                                title="Delete Field"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        
                                                        {editingFieldIndex === index ? (
                                                            <div className="space-y-3">
                                                                <input
                                                                    type="text"
                                                                    value={field.label}
                                                                    onChange={(e) => updateFieldLabel(index, e.target.value)}
                                                                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"
                                                                    placeholder="Field Label"
                                                                />
                                                                <select
                                                                    value={field.type}
                                                                    onChange={(e) => updateFieldType(index, e.target.value)}
                                                                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"
                                                                >
                                                                    {fieldTypes.map(ft => (
                                                                        <option key={ft.value} value={ft.value}>{ft.label}</option>
                                                                    ))}
                                                                </select>
                                                                <button 
                                                                    className="btn btn-primary w-full"
                                                                    onClick={() => setEditingFieldIndex(null)}
                                                                >
                                                                    <i className="fas fa-check mr-1"></i>Done
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <>
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                    {field.label} <span className="text-xs text-gray-400">({field.type})</span>
                                                                </label>
                                                                {renderInput(field, index)}
                                                            </>
                                                        )}
                                                    </div>
                                                ))}
                                            </form>
                                        )}
                                    </div>
                                    
                                    {(tableFields[currentTable] || []).length > 0 && (
                                        <button className="btn btn-primary mt-4 w-full" onClick={saveRecord}>
                                            <i className="fas fa-save mr-2"></i>Save Record
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'data' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                    <i className="fas fa-database mr-2"></i>Data Records for {currentTable}
                                </h2>
                                
                                {records.length === 0 ? (
                                    <div className="text-center py-10 text-gray-400">
                                        <i className="fas fa-inbox text-4xl mb-3"></i>
                                        <p>No records found. Add some data using the Form Builder.</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto rounded-lg shadow">
                                        <table className="w-full border-collapse bg-white">
                                            <thead>
                                                <tr className="bg-blue-50">
                                                    {allFields.map((header, index) => (
                                                        <th key={index} className="border border-gray-200 p-3 text-left text-gray-700 font-semibold">{header}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {records.map(record => (
                                                    <tr key={record.id} className="border border-gray-200 hover:bg-gray-50 even:bg-gray-50">
                                                        {allFields.map((header, index) => (
                                                            <td key={index} className="border border-gray-200 p-3">
                                                                {record[header] !== undefined ? String(record[header]) : '-'}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'formulas' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                    <i className="fas fa-square-root-variable mr-2"></i>Formulas for {currentTable}
                                </h2>
                                <p className="mb-4 text-gray-600">Add computed fields with formulas (e.g., [number] * 2, [number] > 100 ? 'Yes' : 'No'). Use [field] to reference fields.</p>
                                
                                <div className="card mb-6">
                                    <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                        <input id="comp-name" className="p-2 border rounded focus:ring-2 focus:ring-blue-500" placeholder="Field Name" />
                                        <input id="comp-formula" className="p-2 border rounded flex-grow focus:ring-2 focus:ring-blue-500" placeholder="Formula e.g. [number] + 100 or [number] > 100 ? 'Yes' : 'No'" />
                                        <button className="btn btn-success" onClick={addComputedField}>
                                            <i className="fas fa-plus mr-1"></i>Add Formula
                                        </button>
                                    </div>
                                </div>
                                
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Existing Formulas</h3>
                                
                                {(computedFields[currentTable] || []).length === 0 ? (
                                    <div className="text-center py-6 text-gray-400">
                                        <i className="fas fa-calculator text-3xl mb-2"></i>
                                        <p>No formulas added yet.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {(computedFields[currentTable] || []).map((cf, index) => (
                                            <div key={index} className="card relative">
                                                <button 
                                                    className="absolute top-3 right-3 text-red-500 hover:text-red-700" 
                                                    onClick={() => deleteComputedField(index)}
                                                    title="Delete Formula"
                                                >
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                                <h4 className="font-medium text-blue-600">{cf.name}</h4>
                                                <p className="text-sm text-gray-600 mt-1 font-mono bg-gray-100 p-2 rounded">{cf.formula}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'charts' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                    <i className="fas fa-chart-pie mr-2"></i>Charts for {currentTable}
                                </h2>
                                
                                <div className="card mb-6">
                                    <div className="flex flex-col sm:flex-row gap-4 mb-4">
                                        <div className="flex-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Chart Type:</label>
                                            <select value={chartType} onChange={(e) => setChartType(e.target.value)} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                                <option value="bar">Bar Chart</option>
                                                <option value="line">Line Chart</option>
                                                <option value="pie">Pie Chart</option>
                                                <option value="doughnut">Doughnut Chart</option>
                                                <option value="polarArea">Polar Area</option>
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">X Axis Field:</label>
                                            <select value={chartFieldX} onChange={(e) => setChartFieldX(e.target.value)} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select Field</option>
                                                {allFields.map(f => <option key={f} value={f}>{f}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Y Axis Field:</label>
                                            <select value={chartFieldY} onChange={(e) => setChartFieldY(e.target.value)} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                                <option value="">Select Field</option>
                                                {allFields.filter(f => {
                                                    // For better charts, try to filter to numeric fields
                                                    const sampleValue = records[0] && records[0][f];
                                                    return !isNaN(parseFloat(sampleValue));
                                                }).map(f => <option key={f} value={f}>{f}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                {chartFieldX && chartFieldY ? (
                                    <div className="bg-white p-4 rounded-xl shadow">
                                        <canvas ref={canvasRef} className="w-full" style={{ maxHeight: '400px' }}></canvas>
                                    </div>
                                ) : (
                                    <div className="text-center py-10 text-gray-400">
                                        <i className="fas fa-chart-line text-4xl mb-3"></i>
                                        <p>Select X and Y fields to generate a chart.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>