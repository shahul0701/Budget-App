<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-Code Dashboard App Builder</title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.9/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        .draggable { cursor: move; transition: transform 0.2s; }
        .draggable:hover { transform: scale(1.05); }
        .dropzone { min-height: 200px; border: 2px dashed #ccc; padding: 10px; background: #f8fafc; }
        .form-field { margin-bottom: 10px; padding: 10px; background: #fefefe; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab { cursor: pointer; padding: 12px 20px; background: #e5e7eb; margin-right: 5px; border-radius: 8px 8px 0 0; font-weight: 500; }
        .tab.active { background: #ffffff; border: 1px solid #e2e8f0; border-bottom: none; color: #1e40af; }
        .bg-gradient-blue { background: linear-gradient(135deg, #3b82f6, #1e40af); }
        @media (max-width: 640px) {
            .tab { padding: 8px 12px; font-size: 14px; }
            .form-field { padding: 8px; }
            .dropzone { min-height: 150px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration (replace with your Firebase project config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        firebase.auth().signInAnonymously()
            .then(() => console.log("Signed in anonymously"))
            .catch(error => console.error("Anonymous auth error:", error));

        function App() {
            const [tables, setTables] = useState(['default']);
            const [currentTable, setCurrentTable] = useState('default');
            const [tableFields, setTableFields] = useState({ default: [] });
            const [computedFields, setComputedFields] = useState({ default: [] });
            const [records, setRecords] = useState([]);
            const [newRecord, setNewRecord] = useState({});
            const [dragField, setDragField] = useState(null);
            const [activeTab, setActiveTab] = useState('builder');
            const [chartType, setChartType] = useState('bar');
            const [chartFieldX, setChartFieldX] = useState('');
            const [chartFieldY, setChartFieldY] = useState('');
            const chartInstance = useRef(null);
            const canvasRef = useRef(null);
            const unsubscribe = useRef(null);

            // Fetch table configurations and records
            useEffect(() => {
                // Fetch table list
                db.collection('tables').onSnapshot(snapshot => {
                    const tableNames = snapshot.docs.map(doc => doc.id);
                    setTables(tableNames.length > 0 ? tableNames : ['default']);
                    const configs = {};
                    snapshot.docs.forEach(doc => {
                        configs[doc.id] = doc.data().fields || [];
                        computedFields[doc.id] = doc.data().computedFields || [];
                    });
                    setTableFields(configs);
                    setComputedFields(computedFields);
                });
            }, []);

            // Fetch records for current table
            useEffect(() => {
                if (unsubscribe.current) unsubscribe.current();
                unsubscribe.current = db.collection('tables').doc(currentTable).collection('records').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setRecords(data);
                });
                return () => unsubscribe.current && unsubscribe.current();
            }, [currentTable]);

            // Handle drag start
            const handleDragStart = (e, fieldType) => {
                setDragField(fieldType);
                e.dataTransfer.setData("text/plain", fieldType);
            };

            // Handle drop
            const handleDrop = (e) => {
                e.preventDefault();
                if (dragField) {
                    const newField = { type: dragField, label: `${dragField.charAt(0).toUpperCase() + dragField.slice(1)} Field` };
                    const newFields = [...(tableFields[currentTable] || []), newField];
                    setTableFields({ ...tableFields, [currentTable]: newFields });
                    // Save to Firebase
                    db.collection('tables').doc(currentTable).set({ fields: newFields, computedFields: computedFields[currentTable] || [] }, { merge: true });
                }
                setDragField(null);
            };

            // Handle form input change
            const handleInputChange = (e, key) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                setNewRecord({ ...newRecord, [key]: value });
            };

            // Update field label
            const updateFieldLabel = (index, newLabel) => {
                const newFields = [...(tableFields[currentTable] || [])];
                newFields[index].label = newLabel;
                setTableFields({ ...tableFields, [currentTable]: newFields });
                db.collection('tables').doc(currentTable).set({ fields: newFields, computedFields: computedFields[currentTable] || [] }, { merge: true });
            };

            // Save record to Firebase
            const saveRecord = () => {
                if (Object.keys(newRecord).length > 0) {
                    let data = { ...newRecord };
                    (computedFields[currentTable] || []).forEach(cf => {
                        let expr = cf.formula;
                        expr = expr.replace(/\[(.*?)\]/g, (match, f) => newRecord[f] !== undefined ? (typeof newRecord[f] === 'string' ? `"${newRecord[f]}"` : newRecord[f]) : '0');
                        try {
                            data[cf.name] = eval(expr); // Unsafe; use math.js in production
                        } catch (err) {
                            data[cf.name] = 'Error';
                        }
                    });
                    db.collection('tables').doc(currentTable).collection('records').add(data)
                        .then(() => {
                            setNewRecord({});
                            document.getElementById("record-form").reset();
                        })
                        .catch(error => console.error("Error saving record:", error));
                }
            };

            // Add computed field
            const addComputedField = () => {
                const name = document.getElementById('comp-name').value;
                const formula = document.getElementById('comp-formula').value;
                if (name && formula) {
                    const newComputed = [...(computedFields[currentTable] || []), { name, formula }];
                    setComputedFields({ ...computedFields, [currentTable]: newComputed });
                    db.collection('tables').doc(currentTable).set({ fields: tableFields[currentTable] || [], computedFields: newComputed }, { merge: true });
                    // Update existing records
                    db.collection('tables').doc(currentTable).collection('records').get().then(snapshot => {
                        snapshot.docs.forEach(doc => {
                            const record = doc.data();
                            let expr = formula;
                            expr = expr.replace(/\[(.*?)\]/g, (match, f) => record[f] !== undefined ? (typeof record[f] === 'string' ? `"${record[f]}"` : record[f]) : '0');
                            try {
                                db.collection('tables').doc(currentTable).collection('records').doc(doc.id).update({ [name]: eval(expr) });
                            } catch (err) {
                                db.collection('tables').doc(currentTable).collection('records').doc(doc.id).update({ [name]: 'Error' });
                            }
                        });
                    });
                    document.getElementById('comp-name').value = '';
                    document.getElementById('comp-formula').value = '';
                }
            };

            // Add new table
            const addNewTable = () => {
                const name = document.getElementById('newTable').value.trim();
                if (name && !tables.includes(name)) {
                    setTables([...tables, name]);
                    setTableFields({ ...tableFields, [name]: [] });
                    setComputedFields({ ...computedFields, [name]: [] });
                    setCurrentTable(name);
                    db.collection('tables').doc(name).set({ fields: [], computedFields: [] });
                    document.getElementById('newTable').value = '';
                }
            };

            // Render chart
            useEffect(() => {
                if (chartInstance.current) chartInstance.current.destroy();
                if (canvasRef.current && chartFieldX && chartFieldY && records.length > 0) {
                    const labels = records.map(r => r[chartFieldX] || 'Unknown');
                    const data = records.map(r => parseFloat(r[chartFieldY]) || 0);
                    chartInstance.current = new Chart(canvasRef.current, {
                        type: chartType,
                        data: {
                            labels,
                            datasets: [{
                                label: chartFieldY,
                                data,
                                backgroundColor: chartType === 'pie' ? ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'] : 'rgba(59,130,246,0.4)',
                                borderColor: 'rgba(59,130,246,1)',
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } }, responsive: true }
                    });
                }
            }, [chartType, chartFieldX, chartFieldY, records]);

            // Render input based on field type
            const renderInput = (field, index) => {
                const key = field.label;
                if (field.type === 'checkbox') {
                    return <input type="checkbox" checked={newRecord[key] || false} onChange={(e) => handleInputChange(e, key)} className="h-5 w-5" />;
                } else if (field.type === 'select') {
                    return (
                        <select className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)}>
                            <option value="">Select...</option>
                            <option value="Option A">Option A</option>
                            <option value="Option B">Option B</option>
                            <option value="Option C">Option C</option>
                        </select>
                    );
                } else if (field.type === 'yesno') {
                    return (
                        <select className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)}>
                            <option value="">Select...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    );
                } else if (field.type === 'textarea') {
                    return <textarea className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} rows="4" />;
                } else {
                    return <input type={field.type} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" value={newRecord[key] || ''} onChange={(e) => handleInputChange(e, key)} placeholder={`Enter ${field.label}`} />;
                }
            };

            const allFields = [...(tableFields[currentTable] || []).map(f => f.label), ...(computedFields[currentTable] || []).map(cf => cf.name)];

            return (
                <div className="container mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen">
                    <h1 className="text-3xl font-bold text-white bg-gradient-blue p-4 rounded-lg shadow-md mb-6">No-Code Dashboard App Builder</h1>
                    <div className="flex flex-wrap mb-4 border-b-2 border-gray-200">
                        <div className={`tab ${activeTab === 'builder' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('builder')}>Form Builder</div>
                        <div className={`tab ${activeTab === 'data' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('data')}>Data Table</div>
                        <div className={`tab ${activeTab === 'formulas' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('formulas')}>Formulas</div>
                        <div className={`tab ${activeTab === 'charts' ? 'active' : ''} sm:text-lg`} onClick={() => setActiveTab('charts')}>Charts</div>
                    </div>
                    <div className="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                        {activeTab === 'builder' && (
                            <div>
                                <div className="mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-2">
                                    <h3 className="text-lg font-semibold text-gray-700">Table Management</h3>
                                    <select value={currentTable} onChange={(e) => setCurrentTable(e.target.value)} className="p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                        {tables.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    <input id="newTable" placeholder="New Table Name" className="p-2 border rounded focus:ring-2 focus:ring-blue-500" />
                                    <button className="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition" onClick={addNewTable}>Add Table</button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <h2 className="text-xl font-semibold text-gray-800 mb-2">Build Your Form</h2>
                                        <div className="mb-4">
                                            <h3 className="text-lg font-medium text-gray-700">Available Fields</h3>
                                            {['text', 'number', 'date', 'email', 'tel', 'checkbox', 'select', 'textarea', 'time', 'yesno'].map(fieldType => (
                                                <div key={fieldType} className="draggable p-2 bg-blue-100 rounded mb-2 hover:bg-blue-200 transition" draggable onDragStart={(e) => handleDragStart(e, fieldType)}>
                                                    {fieldType === 'yesno' ? 'Yes/No Field' : `${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)} Field`}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="dropzone" onDragOver={(e) => e.preventDefault()} onDrop={handleDrop}>
                                            <h3 className="text-lg font-medium text-gray-700">Form Preview</h3>
                                            <form id="record-form">
                                                {(tableFields[currentTable] || []).map((field, index) => (
                                                    <div key={index} className="form-field">
                                                        <input
                                                            type="text"
                                                            value={field.label}
                                                            onChange={(e) => updateFieldLabel(index, e.target.value)}
                                                            className="w-full p-2 border rounded mb-1 focus:ring-2 focus:ring-blue-500"
                                                            placeholder="Field Label"
                                                        />
                                                        {renderInput(field, index)}
                                                    </div>
                                                ))}
                                            </form>
                                        </div>
                                        {(tableFields[currentTable] || []).length > 0 && (
                                            <button className="mt-4 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition" onClick={saveRecord}>
                                                Save Record
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'data' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-2">Data Records for {currentTable}</h2>
                                <div className="overflow-x-auto">
                                    <table className="w-full border-collapse border border-gray-200">
                                        <thead>
                                            <tr className="bg-blue-100">
                                                {allFields.map((header, index) => (
                                                    <th key={index} className="border border-gray-300 p-2 text-left text-gray-700">{header}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.map(record => (
                                                <tr key={record.id} className="border border-gray-300 hover:bg-gray-50">
                                                    {allFields.map((header, index) => (
                                                        <td key={index} className="border border-gray-300 p-2">
                                                            {record[header] !== undefined ? String(record[header]) : '-'}
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {activeTab === 'formulas' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-2">Formulas for {currentTable}</h2>
                                <p className="mb-4 text-gray-600">Add computed fields with formulas (e.g., [number] * 2, [number] > 100 ? 'Yes' : 'No'). Use [field] to reference fields.</p>
                                <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                    <input id="comp-name" className="p-2 border rounded focus:ring-2 focus:ring-blue-500" placeholder="Field Name" />
                                    <input id="comp-formula" className="p-2 border rounded flex-grow focus:ring-2 focus:ring-blue-500" placeholder="Formula e.g. [number] + 100 or [number] > 100 ? 'Yes' : 'No'" />
                                    <button className="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition" onClick={addComputedField}>Add Formula</button>
                                </div>
                                <ul className="space-y-2">
                                    {(computedFields[currentTable] || []).map((cf, index) => (
                                        <li key={index} className="p-2 bg-gray-100 rounded">{cf.name}: {cf.formula}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        {activeTab === 'charts' && (
                            <div>
                                <h2 className="text-xl font-semibold text-gray-800 mb-2">Charts for {currentTable}</h2>
                                <div className="flex flex-col sm:flex-row gap-2 mb-4">
                                    <div className="flex items-center">
                                        <label className="mr-2 text-gray-700">Chart Type:</label>
                                        <select value={chartType} onChange={(e) => setChartType(e.target.value)} className="p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                            <option>bar</option>
                                            <option>line</option>
                                            <option>pie</option>
                                        </select>
                                    </div>
                                    <div className="flex items-center">
                                        <label className="mr-2 text-gray-700">X Field:</label>
                                        <select value={chartFieldX} onChange={(e) => setChartFieldX(e.target.value)} className="p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                            <option value="">Select</option>
                                            {allFields.map(f => <option key={f} value={f}>{f}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-center">
                                        <label className="mr-2 text-gray-700">Y Field:</label>
                                        <select value={chartFieldY} onChange={(e) => setChartFieldY(e.target.value)} className="p-2 border rounded focus:ring-2 focus:ring-blue-500">
                                            <option value="">Select</option>
                                            {allFields.filter(f => f === 'number' || (computedFields[currentTable] || []).some(cf => cf.name === f)).map(f => <option key={f} value={f}>{f}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <canvas ref={canvasRef} className="border rounded-lg shadow-sm" style={{ maxWidth: '100%', height: 'auto' }}></canvas>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
