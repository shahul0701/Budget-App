<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transaction Manager</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <style>
    body {
      background: #f9fafc;
      font-family: Arial, sans-serif;
    }
    .container {
      max-width: 1000px;
      margin-top: 40px;
    }
    #filePreview img {
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 5px;
    }
    .transaction-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center mb-4">ðŸ’° Transaction Manager</h2>

  <!-- Transaction Form -->
  <form id="transactionForm" class="row g-3 border p-3 rounded bg-light shadow-sm">
    <div class="col-md-6">
      <label class="form-label">Type</label>
      <select id="formTYPE" name="formTYPE" class="form-select" required>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Category</label>
      <input type="text" id="formCATEGORY" name="formCATEGORY" class="form-control" placeholder="E.g. Salary, Food" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Amount</label>
      <input type="number" id="formAMOUNT" name="formAMOUNT" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Date</label>
      <input type="date" id="formDATE" name="formDATE" class="form-control" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Mode</label>
      <select id="formMODE" name="formMODE" class="form-select" required>
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Bank</label>
      <select id="formBANK" name="formBANK" class="form-select">
        <option value="Bank Account 1">Bank Account 1</option>
        <option value="Bank Account 2">Bank Account 2</option>
      </select>
    </div>

    <div class="col-md-12">
      <label class="form-label">Notes</label>
      <textarea id="formNOTES" name="formNOTES" class="form-control" placeholder="Add details..."></textarea>
    </div>

    <div class="col-md-12">
      <label class="form-label">Attachment</label>
      <input type="file" id="formATTACHFILE" name="formATTACHFILE" class="form-control" />
      <div id="filePreview"></div>
    </div>

    <div class="col-md-12 text-center">
      <button type="submit" class="btn btn-primary px-4">ðŸ’¾ Save Transaction</button>
    </div>
  </form>

  <hr class="my-4">

  <!-- Transaction List -->
  <h4>ðŸ“œ Transactions</h4>
  <div id="transactionList"></div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase + Logic -->
<script type="module">
  // Firebase Initialization & Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBd_AftLq8zPriz3D6ZKZApk9nYbe5L7tw",
    authDomain: "firstproject-37258.firebaseapp.com",
    projectId: "firstproject-37258",
    storageBucket: "firstproject-37258.appspot.com",
    messagingSenderId: "9118407687",
    appId: "1:9118407687:web:50bb61fc7998ea6a51ed94",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM Elements
  const transactionForm = document.getElementById("transactionForm");
  const transactionList = document.getElementById("transactionList");
  const formATTACHFILE = document.getElementById("formATTACHFILE");
  const previewContainer = document.getElementById("filePreview");

  // Balances
  let lastBalances = {
    Cash: 0,
    "Bank Account 1": 0,
    "Bank Account 2": 0
  };

  // File Preview
  formATTACHFILE.addEventListener("change", function () {
    previewContainer.innerHTML = "";
    const file = this.files[0];
    if (file) {
      const fileName = document.createElement("p");
      fileName.textContent = `Selected file: ${file.name}`;
      previewContainer.appendChild(fileName);

      if (file.type.startsWith("image/")) {
        const imgPreview = document.createElement("img");
        imgPreview.src = URL.createObjectURL(file);
        imgPreview.style.maxWidth = "120px";
        imgPreview.style.marginTop = "5px";
        previewContainer.appendChild(imgPreview);
      }
    }
  });

  // Save Transaction
  transactionForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formDATA = new FormData(transactionForm);
    let attachmentUrl = "";

    // Upload to Cloudinary if file selected
    const file = formDATA.get("formATTACHFILE");
    if (file && file.size > 0) {
      const cloudName = "dxkfd0crn";
      const uploadPreset = "ShaFinanceApp";
      const cloudFormData = new FormData();
      cloudFormData.append("file", file);
      cloudFormData.append("upload_preset", uploadPreset);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
          method: "POST",
          body: cloudFormData,
        });
        const data = await res.json();
        attachmentUrl = data.secure_url;
      } catch (err) {
        console.error("Cloudinary Upload Error:", err);
      }
    }

    // Build Transaction
    const transaction = {
      type: formDATA.get("formTYPE"),
      category: formDATA.get("formCATEGORY"),
      amount: parseFloat(formDATA.get("formAMOUNT")),
      date: formDATA.get("formDATE"),
      mode: formDATA.get("formMODE"),
      bank: formDATA.get("formBANK"),
      notes: formDATA.get("formNOTES"),
      attachment: attachmentUrl,
      balance: 0,
    };

    // Balance update
    const key = transaction.mode === "Cash" ? "Cash" : transaction.bank;
    let balance = lastBalances[key] || 0;
    balance += transaction.type === "Income" ? transaction.amount : -transaction.amount;
    transaction.balance = balance;
    lastBalances[key] = balance;

    // Save to Firestore
    try {
      await addDoc(collection(db, "transactions"), transaction);
      alert("Transaction Saved âœ…");
      transactionForm.reset();
      previewContainer.innerHTML = "";
      loadTransactions();
    } catch (err) {
      console.error("Firestore Save Error:", err);
    }
  });

  // Load Transactions
  async function loadTransactions() {
    transactionList.innerHTML = "";
    const snapshot = await getDocs(collection(db, "transactions"));
    snapshot.forEach((doc) => {
      const t = doc.data();
      const div = document.createElement("div");
      div.className = "transaction-card";
      div.innerHTML = `
        <strong>${t.type}</strong> - ${t.category} <br>
        Amount: â‚¹${t.amount} | Date: ${t.date} <br>
        Mode: ${t.mode}${t.mode === "Bank" ? " ("+t.bank+")" : ""} <br>
        Balance: â‚¹${t.balance} <br>
        Notes: ${t.notes || ""} <br>
        ${t.attachment ? `<a href="${t.attachment}" target="_blank">ðŸ“Ž View Attachment</a>` : ""}
      `;
      transactionList.appendChild(div);
    });
  }

  loadTransactions();
</script>
</body>
</html>
