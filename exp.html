<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transaction Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f8f9fa;
    }
    header {
      background: #343a40;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
    }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    form label {
      font-weight: bold;
      font-size: 14px;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form button {
      grid-column: span 2;
      padding: 10px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    form button:hover { background: #218838; }

    #filePreview {
      grid-column: span 2;
      font-size: 14px;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    table th {
      background: #343a40;
      color: white;
    }
    .actions button {
      margin: 0 4px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    .edit-btn { background: #ffc107; color: black; }
    .delete-btn { background: #dc3545; color: white; }
    .edit-btn:hover { background: #e0a800; }
    .delete-btn:hover { background: #c82333; }
  </style>
</head>
<body>
  <header>ðŸ’° Transaction Manager</header>

  <div class="container">
    <h2>Add / Edit Transaction</h2>
    <form id="transactionForm">
      <label>Type</label>
      <select name="formTYPE" required>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>

      <label>Category</label>
      <input type="text" name="formCATEGORY" placeholder="e.g., Food, Salary" required/>

      <label>Amount</label>
      <input type="number" name="formAMOUNT" required/>

      <label>Date</label>
      <input type="date" name="formDATE" required/>

      <label>Mode</label>
      <select name="formMODE">
        <option value="Cash">Cash</option>
        <option value="Bank">Bank</option>
      </select>

      <label>Bank</label>
      <select name="formBANK">
        <option value="Cash">Cash</option>
        <option value="Bank Account 1">Bank Account 1</option>
        <option value="Bank Account 2">Bank Account 2</option>
      </select>

      <label>Notes</label>
      <textarea name="formNOTES" rows="2"></textarea>

      <label>Attachment</label>
      <input type="file" id="formATTACHFILE" name="formATTACHFILE" accept="image/*,.pdf,.doc,.docx"/>
      <div id="filePreview"></div>

      <button type="submit">ðŸ’¾ Save Transaction</button>
    </form>

    <h2>Transactions</h2>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Mode</th>
          <th>Bank</th>
          <th>Notes</th>
          <th>Attachment</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="transactionList"></tbody>
    </table>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBd_AftLq8zPriz3D6ZKZApk9nYbe5L7tw",
      authDomain: "firstproject-37258.firebaseapp.com",
      projectId: "firstproject-37258",
      storageBucket: "firstproject-37258.appspot.com",
      messagingSenderId: "9118407687",
      appId: "1:9118407687:web:50bb61fc7998ea6a51ed94",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const transactionForm = document.getElementById("transactionForm");
    const transactionList = document.getElementById("transactionList");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const previewContainer = document.getElementById("filePreview");

    let editingId = null;
    let lastBalances = { Cash: 0, "Bank Account 1": 0, "Bank Account 2": 0 };

    // File Preview
    formATTACHFILE.addEventListener("change", () => {
      previewContainer.innerHTML = "";
      const file = formATTACHFILE.files[0];
      if (file) {
        previewContainer.innerHTML = `<p>Selected: ${file.name}</p>`;
        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style.maxWidth = "100px";
          img.style.marginTop = "5px";
          previewContainer.appendChild(img);
        }
      }
    });

    // Save Transaction
    transactionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formDATA = new FormData(transactionForm);
      let attachmentUrl = "";

      const file = formDATA.get("formATTACHFILE");
      if (file && file.size > 0) {
        const cloudName = "dxkfd0crn";
        const uploadPreset = "ShaFinanceApp";
        const cloudFormData = new FormData();
        cloudFormData.append("file", file);
        cloudFormData.append("upload_preset", uploadPreset);
        try {
          const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
            method: "POST",
            body: cloudFormData,
          });
          const data = await res.json();
          attachmentUrl = data.secure_url;
        } catch (err) {
          console.error("Upload Error:", err);
        }
      }

      const transaction = {
        type: formDATA.get("formTYPE"),
        category: formDATA.get("formCATEGORY"),
        amount: parseFloat(formDATA.get("formAMOUNT")),
        date: formDATA.get("formDATE"),
        mode: formDATA.get("formMODE"),
        bank: formDATA.get("formBANK"),
        notes: formDATA.get("formNOTES"),
        attachment: attachmentUrl,
        balance: 0,
      };

      if (transaction.type === "Income") {
        lastBalances[transaction.bank] += transaction.amount;
      } else {
        lastBalances[transaction.bank] -= transaction.amount;
      }
      transaction.balance = lastBalances[transaction.bank];

      try {
        if (editingId) {
          await updateDoc(doc(db, "transactions", editingId), transaction);
          editingId = null;
        } else {
          await addDoc(collection(db, "transactions"), transaction);
        }
        transactionForm.reset();
        previewContainer.innerHTML = "";
        loadTransactions();
      } catch (err) {
        console.error("Save Error:", err);
      }
    });

    // Load Transactions
    async function loadTransactions() {
      transactionList.innerHTML = "";
      lastBalances = { Cash: 0, "Bank Account 1": 0, "Bank Account 2": 0 };

      const snapshot = await getDocs(collection(db, "transactions"));
      snapshot.forEach((docSnap) => {
        const tx = docSnap.data();
        tx.id = docSnap.id;

        if (tx.type === "Income") {
          lastBalances[tx.bank] += tx.amount;
        } else {
          lastBalances[tx.bank] -= tx.amount;
        }
        tx.balance = lastBalances[tx.bank];

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${tx.type}</td>
          <td>${tx.category}</td>
          <td>${tx.amount}</td>
          <td>${tx.date}</td>
          <td>${tx.mode}</td>
          <td>${tx.bank}</td>
          <td>${tx.notes}</td>
          <td>${tx.attachment ? `<a href="${tx.attachment}" target="_blank">View</a>` : ""}</td>
          <td>${tx.balance}</td>
          <td class="actions">
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </td>
        `;
        row.querySelector(".edit-btn").addEventListener("click", () => editTransaction(tx));
        row.querySelector(".delete-btn").addEventListener("click", () => deleteTransaction(tx.id));
        transactionList.appendChild(row);
      });
    }

    function editTransaction(tx) {
      editingId = tx.id;
      transactionForm.formTYPE.value = tx.type;
      transactionForm.formCATEGORY.value = tx.category;
      transactionForm.formAMOUNT.value = tx.amount;
      transactionForm.formDATE.value = tx.date;
      transactionForm.formMODE.value = tx.mode;
      transactionForm.formBANK.value = tx.bank;
      transactionForm.formNOTES.value = tx.notes;
    }

    async function deleteTransaction(id) {
      if (confirm("Delete this transaction?")) {
        await deleteDoc(doc(db, "transactions", id));
        loadTransactions();
      }
    }

    loadTransactions();
  </script>
</body>
</html>
