<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF‑8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
      body { font-family: Arial, sans-serif; background: #eef2f5; margin:0; padding:0; }
      .header { background:#fff; padding:12px 20px; display:flex; justify-content:space-between;
        align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
      .header-left a { text-decoration:none; color:#007bff; font-weight:bold; font-size:18px; }
      .header-right { display:flex; align-items:center; gap:12px; }
      #userInitials { background:#007bff; color:#fff; border-radius:50%; width:32px; height:32px;
        display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; }
      #username { font-weight:bold; font-size:16px; }
      button#logoutBtn { background:#dc3545; color:#fff; border:none; border-radius:4px;
        padding:6px 12px; cursor:pointer; }
      button#logoutBtn:hover { background:#a71d2a; }

      .container { max-width:1200px; margin:30px auto; background:#fff; padding:20px 30px 60px;
        border-radius:8px; box-shadow:0 0 12px rgba(0,0,0,0.1); position: relative;
       }

      h2 { text-align:center; margin-bottom:20px; color:#333; }

      .filter-section { margin-bottom:20px; background:#f9f9f9; padding:15px 20px;
        border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
      .filters-row { display:flex; flex-wrap:wrap; gap:15px; align-items:center; }
      .filters-row label { font-size:14px; display:flex; flex-direction:column; min-width:140px; }
      .filters-row select, .filters-row input { margin-top:5px; padding:5px 8px; font-size:14px;
        border-radius:4px; border:1px solid #ccc; }
      #applyFiltersBtn { background:#007bff; padding:8px 16px; color:#fff; border:none;
        border-radius:5px; cursor:pointer; margin-top:10px; }
      #applyFiltersBtn:hover { background:#0056b3; }

      table { width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px; }
      th, td { border:1px solid #ccc; padding:8px 10px; text-align:left; }
      th { background:#007bff; color:#fff; }
      tbody tr:nth-child(even) { background:#f3f8fc; }
      tbody tr:hover { background:#ddeffb; }

.attachment-cell a {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 4px;
    background-color: #f0f8ff;
    display: inline-block;
}

.attachment-cell a:hover {
    text-decoration: underline;
    background-color: #e0f0ff;
}

      .pagination { text-align:center; margin-top:10px; }
      .pagination button { margin:0 3px; padding:6px 10px; border:none;
        background:#007bff; color:#fff; border-radius:4px; cursor:pointer; }
      .pagination button.disabled { background:#aaa; cursor:not-allowed; }
      .pagination button.active { background:#0056b3; }

      #addTransactionBtn {
        position: fixed; bottom:30px; right:30px; background:#28a745; color:white;
        border:none; border-radius:50%; width:60px; height:60px; font-size:32px;
        cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); display:flex;
        align-items:center; justify-content:center; z-index:1000;
      }
      #addTransactionBtn:hover { background:#218838; }

      .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1001; }
      .modal-content { background:white; padding:20px; border-radius:8px; width:90%;
        max-width:450px; display:flex; flex-direction:column; gap:10px; position:relative; }
      .modal-content label { font-size:14px; display:flex; flex-direction:column; }
      .modal-content input { padding:6px; border:1px solid #ccc; border-radius:4px; }
      .modal-content button { background:#007bff; color:white; padding:8px;
        border:none; border-radius:4px; font-size:16px; cursor:pointer; }
      .modal-content button:hover { background:#0056b3; }
      .close { position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; }

      .loading-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
  }

  .loading-content {
    text-align: center;
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    color: #007bff;
    font-size: 18px;
  }

.btn-edit {
  background: linear-gradient(to right, #ffca28, #ffeb3b); /* vibrant yellow */
  color: #212529;
  border: none;
  padding: 6px 12px;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
  transition: all 0.3s ease;
}

.btn-edit:hover {
  background: linear-gradient(to right, #ffc107, #fff176);
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6);
}

.btn-delete {
  background: linear-gradient(to right, #dc3545, #ff6f61); /* red to coral */
  color: white;
  border: none;
  padding: 6px 12px;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
  transition: all 0.3s ease;
}

.btn-delete:hover {
  background: linear-gradient(to right, #c82333, #ff4c4c);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6);
}


  .create-mode .modal-content {
    border-left: 6px solid #28a745; /* Green for add */
  }

  .edit-mode .modal-content {
    border-left: 6px solid #ffc107; /* Yellow for edit */
  }

  /* 3D modal content with soft shadows */
  .modal-content {
    background: linear-gradient(to bottom, #ffffff, #f9f9f9);
    padding: 25px 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 480px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), inset 0 0 5px rgba(255, 255, 255, 0.3);
    font-size: 15px;
    transition: all 0.3s ease;
    border-left: 10px solid #28a745; /* default to Create green */
  }

  /* Create mode: vibrant green gradient edge */
  .create-mode .modal-content {
    border-left: 10px solid transparent;
    background-image: linear-gradient(to right, #28a745 10px, #aafdd6 10px);
  }

  /* Edit mode: vibrant yellow gradient edge */
  .edit-mode .modal-content {
    border-left: 10px solid transparent;
    background-image: linear-gradient(to right, #ffc107 10px, #3c90ff 10px);
  }

  /* Stylish form labels */
  .modal-content label {
    font-weight: 600;
    color: #333;
    font-size: 14px;
    margin-bottom: 4px;
  }

  /* Inputs, Selects, and Textareas with depth */
  .modal-content input,
  .modal-content select,
  .modal-content textarea {
    padding: 10px 12px;
    font-size: 15px;
    border-radius: 6px;
    border: 1.5px solid #ccc;
    background: #fefefe;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: all 0.25s ease-in-out;
    font-family: inherit;
    width: 100%;
  }

  .modal-content input:focus,
  .modal-content select:focus,
  .modal-content textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 6px rgba(0, 123, 255, 0.35);
    background: #fff;
  }

  /* Buttons row */
  .modal-content .buttons-row {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 10px;
  }

  /* Primary button with 3D look */
  .modal-content button.primary-btn {
    background: linear-gradient(to top, #007bff, #3399ff);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 100px;
  }

  .modal-content button.primary-btn:hover {
    background: linear-gradient(to top, #0056b3, #1a75ff);
    box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
  }

  /* Cancel button with softer gray 3D */
  .modal-content button.cancel-btn {
    background: linear-gradient(to top, #6c757d, #868e96);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(108, 117, 125, 0.25);
    cursor: pointer;
    min-width: 100px;
    transition: background 0.3s ease;
  }

  .modal-content button.cancel-btn:hover {
    background: linear-gradient(to top, #545b62, #6c757d);
    box-shadow: 0 6px 16px rgba(108, 117, 125, 0.35);
  }

  /* Close icon with hover effect */
  .close {
    position: absolute;
    top: 12px;
    right: 18px;
    font-size: 26px;
    font-weight: bold;
    color: #888;
    cursor: pointer;
    transition: color 0.25s ease;
  }
  .close:hover {
    color: #000;
  }


  /* Mode specific border color */
  .create-mode .modal-content {
    border-left: 8px solid #28a745; /* Green for Create */
  }

  .edit-mode .modal-content {
    border-left: 8px solid #ffc107; /* Yellow for Edit */
  }

  /* Responsive tweaks for smaller screens */
  @media (max-width: 480px) {
    .modal-content {
      padding: 20px 20px;
      width: 95%;
    }
    .modal-content .buttons-row {
      flex-direction: column-reverse;
      gap: 12px;
    }
    .modal-content button {
      width: 100%;
      min-width: auto;
    }
  }

  /* Responsive horizontal scroll container */
  .table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
    margin-top: 10px;
    box-shadow: inset 0 -1px 5px rgba(0,0,0,0.1);
  }

  /* Optional: make table min width for scroll */
  .table-responsive table {
    min-width: 700px; /* or any width based on your columns */
    border-collapse: collapse;
  }

/* Add to your CSS */
/* Make modal content scrollable */
#transactionModal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  overflow: auto; /* <-- allow scrolling */
}

/* Form box inside modal */
#transactionModal .modal-content {
  background: white;
  padding: 20px;
  width: 95%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
}




.floating-button {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background-color: #28a745; /* Bootstrap success green */
  color: white;
  font-size: 36px;
  border: none;
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.3s ease;
  z-index: 1000;
}

.floating-button:hover {
  background-color: #218838; /* Darker green on hover */
}

  </style>
</head>
<body>

<h2 id="accountTitle" style="text-align:center;"></h2>

<div class="header">
    <div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
    <div class="header-right">
        <div id="userInitials">U</div>
        <div id="username">User</div>
        <button id="logoutBtn">Logout</button>
    </div>
</div>

<div class="container">
    <h2><i class="fa fa-money-bill-wave"></i> Expense Tracker</h2>
    <input type="file" id="csvInput" accept=".csv" />

    <div class="filter-section">
        <div class="filters-row">
            <label>Date Filter:
                <select id="dateFilter"><option value="all">All</option><option value="week">This Week</option>
                    <option value="month">This Month</option><option value="year">This Year</option>
                    <option value="custom">Custom Range</option></select>
            </label>
            <label id="customDateRange" style="display:none;">
                From: <input type="date" id="startDate" />
                To: <input type="date" id="endDate" />
            </label>          
            <label>Income/Expense:
                <select id="incomeExpenseFilter"><option value="all">All</option><option value="income">Income Only</option>
                    <option value="expense">Expense Only</option></select>
            </label>
            <label>Description contains:<input type="text" id="descFilter" placeholder="Search…"/></label>
            <label>Mode:<select id="modeFilter"><option value="all">All</option></select></label>
            <label>Bank:<select id="bankFilter"><option value="all">All</option></select></label>
            <button id="applyFiltersBtn">Apply Filters</button>
        </div>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>SINO</th><th>DATE</th><th>TIME</th><th>ACCOUNT HEADER</th><th>MODE</th>
                    <th>BANK NAME</th><th>INCOME</th><th>EXPENSE</th><th>DESCRIPTION</th>
                    <th>BALANCE</th><th>ATTACHMENT</th><th>ACTION</th>
                </tr>
            </thead>
            <tbody id="transactionsTableBody">
                <tr><td colspan="12" style="text-align:center; color:#777;">No transactions loaded.</td></tr>
            </tbody>
        </table>
    </div>
    <div id="paginationControls" style="text-align:center; margin:10px;">
        <button id="prevPageBtn">Previous</button>
        <span id="paginationInfo"></span>
        <button id="nextPageBtn">Next</button>
    </div>
    
    <!-- Add Transaction Button -->
    <button id="addTransactionBtn" class="floating-button">+</button>
    
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="formTitle">Add Transaction</h2>
            <form id="transactionForm">
                <input type="hidden" id="txId" />
                <label>SINO: <input type="text" id="formSINO" required /></label>
                <label>DATE: <input type="date" id="formDATE" required /></label>
                <label>TIME: <input type="time" id="formTIME" required /></label>
                <label>ACCOUNT HEADER: 
                    <select id="formHEADER">
                        <option value="">Select Account</option>
                    </select>
                </label>
                <label>MODE: 
                    <select id="formMODE" onchange="toggleBankDropdown()" required>
                        <option value="">Select Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank">Bank</option>
                        <option value="Transfer">Transfer</option>
                    </select>
                </label>
                <div id="bankFieldGroup">
                    <label for="formBANKNAME">Bank Name</label>
                    <select id="formBANKNAME"></select>
                </div>

                <div id="toBankGroup" style="display:none;">
                    <label for="toBank">Transfer To Bank:</label>
                    <select id="toBank">
                        <option value="">Select Bank</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="typeSelector">Transaction Type</label>
                    <select id="typeSelector" required>
                        <option value="">Select Type</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>

                <div id="incomeGroup" class="form-group">
                    <label for="formINCOME">Income</label>
                    <input type="number" id="formINCOME" step="0.01" min="0" />
                </div>

                <div id="expenseGroup" class="form-group">
                    <label for="formEXPENSE">Expense</label>
                    <input type="number" id="formEXPENSE" step="0.01" min="0" />
                </div>
                <label>DESCRIPTION: <input type="text" id="formDESC" /></label>
                <label>BALANCE: <input type="number" step="0.01" id="formBALANCE" readonly /></label>
                <label>ATTACHMENT FILE: <input type="file" id="formATTACHFILE" /></label>
                <input type="hidden" id="formATTACH" />
                <div class="buttons-row">
                    <button type="button" class="cancel-btn" id="cancelFormBtn">Cancel</button>
                    <button type="submit" class="primary-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <p id="dateRangeDisplay" class="range-display"></p>
    
    <div id="loadingModal" class="loading-modal">
        <div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;"></i>
            <p>Loading, please wait…</p>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" id="closeConfirmDelete">&times;</span>
            <h3 style="margin-bottom: 10px;">Confirm Delete</h3>
            <p>Are you sure you want to delete this transaction?</p>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button id="cancelDeleteBtn" style="background:#6c757d;">Cancel</button>
                <button id="confirmDeleteBtn" style="background:#dc3545;">Delete</button>
            </div>
        </div>
    </div>

<script type="module">
    // Firebase Initialization & Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        query,
        getDocs,
        updateDoc,
        deleteDoc,
        doc,
        where,
        getDoc,
        orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp({
        apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
        authDomain: "budget-app-1365f.firebaseapp.com",
        projectId: "budget-app-1365f",
        storageBucket: "budget-app-1365f.appspot.com",
        messagingSenderId: "1036194450411",
        appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
        measurementId: "G-YFFJL2H54X"
    });

    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM references
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const addTransactionBtn = document.getElementById("addTransactionBtn");
    const tableBody = document.getElementById("transactionsTableBody");
    const loadingModal = document.getElementById("loadingModal");
    const modal = document.getElementById("transactionModal");
    const form = document.getElementById("transactionForm");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const cancelFormBtn = document.getElementById("cancelFormBtn");
    const closeBtn = document.querySelector(".close-btn");

    const dateFilter = document.getElementById("dateFilter");
    document.getElementById("dateRangeDisplay").textContent = "";
    const incomeExpenseFilter = document.getElementById("incomeExpenseFilter");
    const descFilter = document.getElementById("descFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const dateRangeDisplay = document.getElementById("dateRangeDisplay");
    const modeFilter = document.getElementById("modeFilter");
    const bankFilter = document.getElementById("bankFilter");

    const formSINO = document.getElementById("formSINO");
    const formDATE = document.getElementById("formDATE");
    const formTIME = document.getElementById("formTIME");
    const formHEADER = document.getElementById("formHEADER");
    const formMODE = document.getElementById("formMODE");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formDESC = document.getElementById("formDESC");
    const formBALANCE = document.getElementById("formBALANCE");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const txIdInput = document.getElementById("txId");

    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const paginationInfo = document.getElementById("paginationInfo");

    const typeSelector = document.getElementById("typeSelector");
    const incomeGroup = document.getElementById("incomeGroup");
    const expenseGroup = document.getElementById("expenseGroup");

    const toBankGroup = document.getElementById("toBankGroup");
    const toBankSelect = document.getElementById("toBank");

    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let txMap = {};
    let currentPage = 1;
    const rowsPerPage = 10;
    let lastBalance = 0; // Track the last balance for calculations

    // Listen for auth state change
    onAuthStateChanged(auth, async user => {
        if (user) {
            currentUser = user;
            const name = user.displayName || user.email || "User";
            usernameElem.textContent = name;
            initialsElem.textContent = name.charAt(0).toUpperCase();

            await loadAccounts();
            await loadTransactions();
            await populateBankAccounts();
        } else {
            alert("Please login first.");
            window.location.href = "index.html";
        }
    });

    logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
    });

    // Event listeners for Add Transaction button
    addTransactionBtn.addEventListener("click", () => {
        openAddModal();
    });

    // Event listener for form submission
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveTransaction();
    });

    // Event listener for cancel button
    cancelFormBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    // Event listener for close button
    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    // Load chart of accounts for dropdown
    async function loadAccounts() {
        const q = query(
            collection(db, "chartOfAccounts"),
            where("userId", "==", currentUser.uid)
        );
        const snapshot = await getDocs(q);
        formHEADER.innerHTML = '<option value="">Select Account</option>';
        snapshot.forEach(doc => {
            const data = doc.data();
            const option = document.createElement("option");
            option.value = data.name;
            option.textContent = data.name;
            formHEADER.appendChild(option);
        });
    }

    // Populate Bank Accounts dropdown for filters and form
    async function populateBankAccounts() {
        bankFilter.innerHTML = `<option value="all">All</option>`;
        formBANKNAME.innerHTML = `<option value="">Select Bank</option>`;
        toBankSelect.innerHTML = `<option value="">Select Bank</option>`;
        
        try {
            const q = query(
                collection(db, "chartOfAccounts"),
                where("userId", "==", currentUser.uid),
                where("type", "==", "Asset"),
                where("category", "==", "Bank")
            );
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                bankFilter.innerHTML = `<option value="all">No Bank Accounts Found</option>`;
                formBANKNAME.innerHTML = `<option value="">No Bank Accounts</option>`;
                toBankSelect.innerHTML = `<option value="">No Bank Accounts</option>`;
            } else {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // For bank filter
                    const option1 = document.createElement("option");
                    option1.value = data.name;
                    option1.textContent = data.name;
                    bankFilter.appendChild(option1);

                    // For form bank name
                    const option2 = document.createElement("option");
                    option2.value = data.name;
                    option2.textContent = data.name;
                    formBANKNAME.appendChild(option2);

                    // For toBank select
                    const option3 = document.createElement("option");
                    option3.value = data.name;
                    option3.textContent = data.name;
                    toBankSelect.appendChild(option3);
                });
            }
        } catch (err) {
            console.error("Error loading bank accounts:", err);
            bankFilter.innerHTML = `<option value="all">Failed to Load</option>`;
            formBANKNAME.innerHTML = `<option value="">Failed to Load</option>`;
            toBankSelect.innerHTML = `<option value="">Failed to Load</option>`;
        }
    }

    // Debug function to check attachment data
function debugAttachments() {
    console.log("=== DEBUG ATTACHMENTS ===");
    allTransactions.forEach((tx, index) => {
        console.log(`Transaction ${index}:`, {
            id: tx.id,
            hasAttachment: !!tx.ATTACHMENT,
            attachment: tx.ATTACHMENT,
            attachmentType: typeof tx.ATTACHMENT,
            DESCRIPTION: tx.DESCRIPTION
        });
    });
    console.log("=== END DEBUG ===");
}
    // Load all transactions for user
async function loadTransactions() {
    loadingModal.style.display = "flex";
    try {
        // Try the original query first
        let q;
        try {
            q = query(
                collection(db, "users", currentUser.uid, "transactions"),
                orderBy("DATE", "desc"),
                orderBy("TIME", "desc")
            );
            const snap = await getDocs(q);
            processTransactions(snap);
        } catch (error) {
            if (error.code === 'failed-precondition') {
                // Fallback to single field ordering if index doesn't exist
                console.warn("Composite index not found, using date-only sorting");
                q = query(
                    collection(db, "users", currentUser.uid, "transactions"),
                    orderBy("DATE", "desc")
                );
                const snap = await getDocs(q);
                processTransactions(snap);
            } else {
                throw error;
            }
        }

        function processTransactions(snap) {
            let transactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Get account from URL
            const selectedAccount = getAccountFromURL();

            // Filter if opened from trial balance
            if (selectedAccount) {
                transactions = transactions.filter(tx => tx.ACCOUNT_HEADER === selectedAccount);
                document.getElementById("accountTitle").textContent = selectedAccount + " Transactions";
            } else {
                document.getElementById("accountTitle").textContent = "All Transactions";
            }

            allTransactions = transactions;

            // Calculate running balance
            calculateRunningBalance(allTransactions);
            populateFiltersOptions(allTransactions);
            applyFilters();
        }

    } catch (err) {
        console.error("Error loading transactions:", err);
        alert("Error loading transactions. Please check console for details.");
    } finally {
        loadingModal.style.display = "none";
    }
}

// Calculate running balance for transactions per bank
function calculateRunningBalance(transactions) {
    // Create a map to track balances for each bank
    const bankBalances = {};
    
    // Sort transactions by date and time
    const sortedTransactions = [...transactions].sort((a, b) => {
        const dateA = new Date(a.DATE + ' ' + (a.TIME || '00:00'));
        const dateB = new Date(b.DATE + ' ' + (b.TIME || '00:00'));
        return dateA - dateB;
    });
    
    // Calculate balance for each transaction based on its bank
    sortedTransactions.forEach(transaction => {
        const income = parseFloat(transaction.INCOME) || 0;
        const expense = parseFloat(transaction.EXPENSE) || 0;
        
        // Determine which bank this transaction belongs to
        let bankKey = "Cash"; // Default for cash transactions
        
        if (transaction.MODE === "Bank" && transaction.BANK_NAME) {
            bankKey = transaction.BANK_NAME;
        } else if (transaction.MODE === "Transfer") {
            // For transfers, we need special handling
            // This is a simplified approach - you might need to adjust based on your data structure
            if (transaction.BANK_NAME) {
                bankKey = transaction.BANK_NAME;
            }
        }
        
        // Initialize bank balance if not exists
        if (!bankBalances[bankKey]) {
            bankBalances[bankKey] = 0;
        }
        
        // Update the balance for this bank
        bankBalances[bankKey] += income - expense;
        transaction.BALANCE = parseFloat(bankBalances[bankKey].toFixed(2));
    });
    
    // Update the last balances for new transactions
    lastBalances = bankBalances;
    
    return sortedTransactions;
}

// Update the updateBalance function to handle per-bank calculations
function updateBalance() {
    const income = parseFloat(formINCOME.value) || 0;
    const expense = parseFloat(formEXPENSE.value) || 0;
    
    // Determine which bank this transaction belongs to
    let bankKey = "Cash"; // Default for cash
    
    if (formMODE.value === "Bank" && formBANKNAME.value) {
        bankKey = formBANKNAME.value;
    } else if (formMODE.value === "Transfer" && formBANKNAME.value) {
        bankKey = formBANKNAME.value;
    }
    
    // Get the current balance for this bank
    const currentBankBalance = lastBalances[bankKey] || 0;
    
    // For new transactions, calculate based on the bank's last balance
    if (!txIdInput.value) {
        formBALANCE.value = (currentBankBalance + income - expense).toFixed(2);
    } else {
        // For editing existing transactions, we need to recalculate
        const tx = txMap[txIdInput.value];
        if (tx) {
            const oldIncome = parseFloat(tx.INCOME) || 0;
            const oldExpense = parseFloat(tx.EXPENSE) || 0;
            const balanceChange = (income - expense) - (oldIncome - oldExpense);
            formBALANCE.value = (parseFloat(tx.BALANCE) + balanceChange).toFixed(2);
        }
    }
}

// Update the clearForm function to use lastBalances instead of lastBalance
function clearForm() {
    form.reset();
    txIdInput.value = "";
    incomeGroup.style.display = "none";
    expenseGroup.style.display = "none";
    toBankGroup.style.display = "none";

    // Auto-generate SINO (next number)
    const nextSINO = allTransactions.length > 0 
        ? Math.max(...allTransactions.map(tx => parseInt(tx.SINO) || 0)) + 1
        : 1;
    formSINO.value = nextSINO;

    // Set current date and time
    const now = new Date();
    formDATE.value = now.toISOString().slice(0, 10); // yyyy-mm-dd
    formTIME.value = now.toTimeString().slice(0, 5);  // hh:mm
    
    // Set initial balance to last known balance for the selected bank
    // Default to Cash if no bank is selected yet
    let bankKey = "Cash";
    if (formMODE.value === "Bank" && formBANKNAME.value) {
        bankKey = formBANKNAME.value;
    } else if (formMODE.value === "Transfer" && formBANKNAME.value) {
        bankKey = formBANKNAME.value;
    }
    
    formBALANCE.value = (lastBalances[bankKey] || 0).toFixed(2);
}

// Update the variable declaration to track balances per bank
let lastBalances = {}; // Track the last balances for each bank

// Update the saveTransaction function to ensure proper handling of the ATTACHMENT field
async function saveTransaction() {
    loadingModal.style.display = "flex";
    
    try {
        // Determine which bank this transaction belongs to
        let bankName = "";
        if (formMODE.value === "Bank" || formMODE.value === "Transfer") {
            bankName = formBANKNAME.value;
        }
        
        // Create the base transaction data
        const transactionData = {
            SINO: formSINO.value,
            DATE: formDATE.value,
            TIME: formTIME.value,
            ACCOUNT_HEADER: formHEADER.value,
            MODE: formMODE.value,
            BANK_NAME: bankName,
            INCOME: parseFloat(formINCOME.value) || 0,
            EXPENSE: parseFloat(formEXPENSE.value) || 0,
            DESCRIPTION: formDESC.value,
            BALANCE: parseFloat(formBALANCE.value) || 0,
            userId: currentUser.uid
        };

// Allowed file types (all docs & images, no video)
const allowedTypes = [
  "application/pdf",
  "application/msword",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  "image/jpeg",
  "image/png",
  "image/gif",
  "image/webp",
  "text/plain"
];

// Handle file upload / attachment
if (formATTACHFILE.files.length > 0) {
    const file = formATTACHFILE.files[0];

    // ✅ Check file type before upload
    if (!allowedTypes.includes(file.type)) {
        alert("Only images and documents (PDF, DOC, XLS, TXT) are allowed. No videos.");
        return;
    }

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "my_app_uploadst"); // your preset
    formData.append("resource_type", "auto"); // auto = supports image/docs

    const res = await fetch("https://api.cloudinary.com/v1_1/dpwdsyvz8/upload", {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    transactionData.ATTACHMENT = data.secure_url || "";
    formATTACH.value = transactionData.ATTACHMENT;

} else if (txIdInput.value) {
    // Editing: keep old attachment if no new file
    transactionData.ATTACHMENT = formATTACH.value || "";
} else {
    // New tx, no file
    transactionData.ATTACHMENT = "";
}




        // Prepare data for Firestore - remove any undefined values
        const firestoreData = {};
        Object.keys(transactionData).forEach(key => {
            if (transactionData[key] !== undefined && transactionData[key] !== null) {
                firestoreData[key] = transactionData[key];
            }
        });

        if (txIdInput.value) {
            // For updates, handle the case where we want to remove attachment
            if (!firestoreData.ATTACHMENT && formATTACH.value === "") {
                firestoreData.ATTACHMENT = ""; // Explicitly set to empty string to remove it
            }
            
            await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), firestoreData);
            Swal.fire("Success", "Transaction updated successfully!", "success");
        } else {
            await addDoc(collection(db, "users", currentUser.uid, "transactions"), firestoreData);
            Swal.fire("Success", "Transaction added successfully!", "success");
        }

        await loadTransactions();
        modal.style.display = "none";
        
    } catch (error) {
        console.error("Error saving transaction:", error);
        Swal.fire("Error", "Failed to save transaction: " + error.message, "error");
    } finally {
        loadingModal.style.display = "none";
    }
}
// Add event listeners to update the balance when bank selection changes
formMODE.addEventListener("change", () => {
    toggleToBankGroup(formMODE.value);
    updateBalance(); // Update balance when mode changes
});

formBANKNAME.addEventListener("change", () => {
    updateBalance(); // Update balance when bank selection changes
});

// Populate filter dropdowns with unique values
function populateFiltersOptions(data) {
    const modes = new Set();
    const banks = new Set();
    data.forEach(t => {
        if (t.MODE) modes.add(t.MODE);
        if (t.BANK_NAME) banks.add(t.BANK_NAME);
    });
    modeFilter.innerHTML =
        `<option value="all">All</option>` +
        [...modes].sort().map(m => `<option>${escapeHtml(m)}</option>`).join("");
    bankFilter.innerHTML =
        `<option value="all">All</option>` +
        [...banks].sort().map(b => `<option>${escapeHtml(b)}</option>`).join("");
}

// Filter transactions according to selected criteria
function applyFilters() {
    filteredTransactions = allTransactions.slice();
    const now = new Date();

    // Helper to check if date is within range safely
    const isInRange = (dateStr, start, end) => {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        if (isNaN(d)) return false; // Ignore invalid dates
        return d >= start && d <= end;
    };

    switch (dateFilter.value) {
        case "week": {
            const start = new Date(now);
            start.setHours(0, 0, 0, 0);
            start.setDate(now.getDate() - now.getDay());
            filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, now));
            break;
        }
        case "month": {
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, now));
            break;
        }
        case "year": {
            const start = new Date(now.getFullYear(), 0, 1);
            filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, now));
            break;
        }
        case "custom":
            if (startDateInput.value && endDateInput.value) {
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                end.setHours(23, 59, 59, 999);
                if (!isNaN(start) && !isNaN(end)) {
                    filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, end));
                    // Display range below filters
                    dateRangeDisplay.textContent = `Showing: ${start.toLocaleDateString()} to ${end.toLocaleDateString()}`;
                }
            }
            break;
    }

    if (incomeExpenseFilter.value === "income")
        filteredTransactions = filteredTransactions.filter(t => (t.INCOME ?? 0) > 0);
    else if (incomeExpenseFilter.value === "expense")
        filteredTransactions = filteredTransactions.filter(t => (t.EXPENSE ?? 0) > 0);

    if (descFilter.value.trim()) {
        const search = descFilter.value.trim().toLowerCase();
        filteredTransactions = filteredTransactions.filter(t => (t.DESCRIPTION ?? "").toLowerCase().includes(search));
    }

    if (modeFilter.value !== "all")
        filteredTransactions = filteredTransactions.filter(t => t.MODE === modeFilter.value);

    if (bankFilter.value !== "all")
        filteredTransactions = filteredTransactions.filter(t => t.BANK_NAME === bankFilter.value);

    currentPage = 1;
    buildTable();
}

// Build table rows for current page
// Build table rows for current page
function buildTable() {
    txMap = {};
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageItems = filteredTransactions.slice(start, end);
    tableBody.innerHTML = "";

    if (pageItems.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:#777;">No transactions found.</td></tr>`;
        updatePagination();
        return;
    }

    pageItems.forEach(d => {
        txMap[d.id] = d;
        const incomeCell = (d.INCOME ?? 0) > 0 ? `<span style="color:green;">${(d.INCOME || 0).toFixed(2)}</span>` : "";
        const expenseCell = (d.EXPENSE ?? 0) > 0 ? `<span style="color:red;">${(d.EXPENSE || 0).toFixed(2)}</span>` : "";
        const balanceCell = (d.BALANCE != null) ? (d.BALANCE || 0).toFixed(2) : "";
        
        // Fix for attachment display - check if attachment exists and is a valid URL
// Replace the attachment cell code with this:
let attachmentCell = "";
if (d.ATTACHMENT && d.ATTACHMENT.trim() !== "") {
  attachmentCell = `<a href="${escapeHtml(d.ATTACHMENT)}" target="_blank" rel="noopener noreferrer" class="btn-view">View</a>`;
} 



const row = document.createElement("tr");
row.innerHTML = `
    <td>${escapeHtml(d.SINO || '')}</td>
    <td>${escapeHtml(d.DATE || '')}</td>
    <td>${escapeHtml(d.TIME || '')}</td>
    <td>${escapeHtml(d.ACCOUNT_HEADER || '')}</td>
    <td>${escapeHtml(d.MODE || '')}</td>
    <td>${escapeHtml(d.BANK_NAME || '')}</td>
    <td>${incomeCell}</td>
    <td>${expenseCell}</td>
    <td>${escapeHtml(d.DESCRIPTION || '')}</td>
    <td>${balanceCell}</td>
    <td>${attachmentCell}</td>
    <td>
        <button class="btn-edit" data-id="${d.id}">Edit</button>
        <button class="btn-delete" data-id="${d.id}">Delete</button>
    </td>
`;
tableBody.appendChild(row);


    });

    setupTableButtons();
    updatePagination();
}

// Update pagination controls
function updatePagination() {
    const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage) || 1;
    paginationInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
}

prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        buildTable();
    }
});

nextPageBtn.addEventListener("click", () => {
    const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        buildTable();
    }
});

// Attach event listeners to Edit/Delete buttons
function setupTableButtons() {
    document.querySelectorAll(".btn-edit").forEach(btn => {
        btn.onclick = () => openEditModal(btn.dataset.id);
    });
    document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.onclick = () => deleteTransaction(btn.dataset.id);
    });
}

// Open modal for adding a new transaction
function openAddModal() {
    modal.style.display = 'flex';
    modal.querySelector('.modal-content').classList.add('create-mode');
    modal.querySelector('.modal-content').classList.remove('edit-mode');
    
    document.getElementById('formTitle').textContent = 'Add Transaction';
    
    clearForm();
}

// Open modal and populate for editing
function openEditModal(id) {
    const tx = txMap[id];
    if (!tx) return;

    modal.style.display = 'flex';
    modal.querySelector('.modal-content').classList.add('edit-mode');
    modal.querySelector('.modal-content').classList.remove('create-mode');
    
    document.getElementById('formTitle').textContent = 'Edit Transaction';

    txIdInput.value = id;
    formSINO.value = tx.SINO || '';
    formDATE.value = tx.DATE || '';
    formTIME.value = tx.TIME || '';
    formHEADER.value = tx.ACCOUNT_HEADER || '';
    formMODE.value = tx.MODE || '';
    formBANKNAME.value = tx.BANK_NAME || '';
    formINCOME.value = tx.INCOME || '';
    formEXPENSE.value = tx.EXPENSE || '';
    formDESC.value = tx.DESCRIPTION || '';
    formBALANCE.value = tx.BALANCE || '';
    formATTACH.value = tx.ATTACHMENT || '';

    toggleIncomeExpenseGroups(tx.INCOME, tx.EXPENSE);
    toggleToBankGroup(tx.MODE);
}

// Toggle income/expense input visibility based on values
function toggleIncomeExpenseGroups(income, expense) {
    income = parseFloat(income) || 0;
    expense = parseFloat(expense) || 0;

    if (income > 0) {
        typeSelector.value = "income";
        incomeGroup.style.display = "block";
        expenseGroup.style.display = "none";
        formINCOME.value = income;
        formEXPENSE.value = "";
    } else if (expense > 0) {
        typeSelector.value = "expense";
        incomeGroup.style.display = "none";
        expenseGroup.style.display = "block";
        formINCOME.value = "";
        formEXPENSE.value = expense;
    } else {
        typeSelector.value = "";
        incomeGroup.style.display = "none";
        expenseGroup.style.display = "none";
        formINCOME.value = "";
        formEXPENSE.value = "";
    }
}

// Toggle toBankGroup based on mode
function toggleToBankGroup(mode) {
    if (mode === "Transfer") {
        toBankGroup.style.display = "block";
    } else {
        toBankGroup.style.display = "none";
        toBankSelect.value = "";
    }
}

// Form "type" selector change to show relevant fields
typeSelector.addEventListener("change", () => {
    if (typeSelector.value === "income") {
        incomeGroup.style.display = "block";
        expenseGroup.style.display = "none";
        formINCOME.value = formINCOME.value || "0";
        formEXPENSE.value = "";
    } else if (typeSelector.value === "expense") {
        incomeGroup.style.display = "none";
        expenseGroup.style.display = "block";
        formINCOME.value = "";
        formEXPENSE.value = formEXPENSE.value || "0";
    } else {
        incomeGroup.style.display = "none";
        expenseGroup.style.display = "none";
        formINCOME.value = "";
        formEXPENSE.value = "";
    }
    
    // Update balance when type changes
    updateBalance();
});

// Update balance when income or expense values change
formINCOME.addEventListener("input", updateBalance);
formEXPENSE.addEventListener("input", updateBalance);

// Mode select change to toggle bank transfer fields
formMODE.addEventListener("change", () => {
    toggleToBankGroup(formMODE.value);
});

// Close modal on click outside form
modal.addEventListener("click", e => {
    if (e.target === modal) modal.style.display = "none";
});

function escapeHtml(text) {
    if (typeof text !== "string") {
        if (text === undefined || text === null) {
            return "";
        }
        try {
            text = String(text);
        } catch {
            return "";
        }
    }

    return text.replace(/[&<>"']/g, m =>
        ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;"
        })[m]
    );
}

// Get account name from URL param 'account'
function getAccountFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("account");
}

// Filter apply button
applyFiltersBtn.addEventListener("click", () => {
    applyFilters();
});

// Date filter change toggles custom date inputs
dateFilter.addEventListener("change", () => {
    if (dateFilter.value === "custom") {
        document.getElementById("customDateRange").style.display = "flex";
    } else {
        document.getElementById("customDateRange").style.display = "none";
        dateRangeDisplay.textContent = "";
    }
});

// Delete transaction
async function deleteTransaction(txId) {
    if (!confirm("Are you sure you want to delete this transaction?")) return;

    try {
        await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txId));
        Swal.fire("Success", "Transaction deleted successfully!", "success");
        await loadTransactions(); // Refresh list
    } catch (err) {
        console.error("Error deleting transaction:", err);
        Swal.fire("Error", "Failed to delete transaction: " + err.message, "error");
    }
}

// Handle attachment file upload
formATTACHFILE.addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    try {
        loadingModal.style.display = "flex";
        
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "my_app_uploadst");
        formData.append("cloud_name", "dpwdsyvz8");

        const res = await fetch("https://api.cloudinary.com/v1_1/dpwdsyvz8/upload", {
            method: "POST",
            body: formData
        });

        const data = await res.json();
        formATTACH.value = data.secure_url;
        
        Swal.fire("Success", "File uploaded successfully!", "success");
    } catch (error) {
        console.error("Error uploading file:", error);
        Swal.fire("Error", "Failed to upload file: " + error.message, "error");
    } finally {
        loadingModal.style.display = "none";
    }
});
    



</script>

</body>
</html>
