<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <meta charset="UTFâ€‘8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f5; margin:0; padding:0; }
    .header { background:#fff; padding:12px 20px; display:flex; justify-content:space-between;
      align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header-left a { text-decoration:none; color:#007bff; font-weight:bold; font-size:18px; }
    .header-right { display:flex; align-items:center; gap:12px; }
    #userInitials { background:#007bff; color:#fff; border-radius:50%; width:32px; height:32px;
      display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; }
    #username { font-weight:bold; font-size:16px; }
    button#logoutBtn { background:#dc3545; color:#fff; border:none; border-radius:4px;
      padding:6px 12px; cursor:pointer; }
    button#logoutBtn:hover { background:#a71d2a; }

    .container { max-width:1200px; margin:30px auto; background:#fff; padding:20px 30px 60px;
      border-radius:8px; box-shadow:0 0 12px rgba(0,0,0,0.1); position: relative; }

    h2 { text-align:center; margin-bottom:20px; color:#333; }

    .filter-section { margin-bottom:20px; background:#f9f9f9; padding:15px 20px;
      border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
    .filters-row { display:flex; flex-wrap:wrap; gap:15px; align-items:center; }
    .filters-row label { font-size:14px; display:flex; flex-direction:column; min-width:140px; }
    .filters-row select, .filters-row input { margin-top:5px; padding:5px 8px; font-size:14px;
      border-radius:4px; border:1px solid #ccc; }
    #applyFiltersBtn { background:#007bff; padding:8px 16px; color:#fff; border:none;
      border-radius:5px; cursor:pointer; margin-top:10px; }
    #applyFiltersBtn:hover { background:#0056b3; }

    table { width:100%; border-collapse:collapse; font-size:14px; margin-bottom:20px; }
    th, td { border:1px solid #ccc; padding:8px 10px; text-align:left; }
    th { background:#007bff; color:#fff; }
    tbody tr:nth-child(even) { background:#f3f8fc; }
    tbody tr:hover { background:#ddeffb; }

    .attachment-cell a { color:#007bff; text-decoration:none; }
    .attachment-cell a:hover { text-decoration:underline; }

    .pagination { text-align:center; margin-top:10px; }
    .pagination button { margin:0 3px; padding:6px 10px; border:none;
      background:#007bff; color:#fff; border-radius:4px; cursor:pointer; }
    .pagination button.disabled { background:#aaa; cursor:not-allowed; }
    .pagination button.active { background:#0056b3; }

    #addTransactionBtn {
      position: fixed; bottom:30px; right:30px; background:#28a745; color:white;
      border:none; border-radius:50%; width:60px; height:60px; font-size:32px;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); display:flex;
      align-items:center; justify-content:center; z-index:1000;
    }
    #addTransactionBtn:hover { background:#218838; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1001; }
    .modal-content { background:white; padding:20px; border-radius:8px; width:90%;
      max-width:450px; display:flex; flex-direction:column; gap:10px; position:relative; }
    .modal-content label { font-size:14px; display:flex; flex-direction:column; }
    .modal-content input { padding:6px; border:1px solid #ccc; border-radius:4px; }
    .modal-content button { background:#007bff; color:white; padding:8px;
      border:none; border-radius:4px; font-size:16px; cursor:pointer; }
    .modal-content button:hover { background:#0056b3; }
    .close { position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; }

    .loading-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}

.loading-content {
  text-align: center;
  background: white;
  padding: 30px 40px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  color: #007bff;
  font-size: 18px;
}

.btn-edit {
  background: #eccc6c;
  color: #000;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-edit:hover {
  background: #eccc6c;
}

.btn-delete {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.btn-delete:hover {
  background: #c82333;
}

.create-mode .modal-content {
  border-left: 6px solid #28a745; /* Green for add */
}

.edit-mode .modal-content {
  border-left: 6px solid #ffc107; /* Yellow for edit */
}

/* 3D modal content with soft shadows */
.modal-content {
  background: linear-gradient(to bottom, #ffffff, #f9f9f9);
  padding: 25px 30px;
  border-radius: 12px;
  width: 90%;
  max-width: 480px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  position: relative;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), inset 0 0 5px rgba(255, 255, 255, 0.3);
  font-size: 15px;
  transition: all 0.3s ease;
  border-left: 10px solid #28a745; /* default to Create green */
}

/* Create mode: vibrant green gradient edge */
.create-mode .modal-content {
  border-left: 10px solid transparent;
  background-image: linear-gradient(to right, #28a745 10px, #aafdd6 10px);
}

/* Edit mode: vibrant yellow gradient edge */
.edit-mode .modal-content {
  border-left: 10px solid transparent;
  background-image: linear-gradient(to right, #ffc107 10px, #3c90ff 10px);
}

/* Stylish form labels */
.modal-content label {
  font-weight: 600;
  color: #333;
  font-size: 14px;
  margin-bottom: 4px;
}

/* Inputs, Selects, and Textareas with depth */
.modal-content input,
.modal-content select,
.modal-content textarea {
  padding: 10px 12px;
  font-size: 15px;
  border-radius: 6px;
  border: 1.5px solid #ccc;
  background: #fefefe;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
  transition: all 0.25s ease-in-out;
  font-family: inherit;
  width: 100%;
}

.modal-content input:focus,
.modal-content select:focus,
.modal-content textarea:focus {
  border-color: #007bff;
  box-shadow: 0 0 6px rgba(0, 123, 255, 0.35);
  background: #fff;
}

/* Buttons row */
.modal-content .buttons-row {
  display: flex;
  justify-content: flex-end;
  gap: 15px;
  margin-top: 10px;
}

/* Primary button with 3D look */
.modal-content button.primary-btn {
  background: linear-gradient(to top, #007bff, #3399ff);
  color: white;
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 100px;
}

.modal-content button.primary-btn:hover {
  background: linear-gradient(to top, #0056b3, #1a75ff);
  box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
}

/* Cancel button with softer gray 3D */
.modal-content button.cancel-btn {
  background: linear-gradient(to top, #6c757d, #868e96);
  color: white;
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(108, 117, 125, 0.25);
  cursor: pointer;
  min-width: 100px;
  transition: background 0.3s ease;
}

.modal-content button.cancel-btn:hover {
  background: linear-gradient(to top, #545b62, #6c757d);
  box-shadow: 0 6px 16px rgba(108, 117, 125, 0.35);
}

/* Close icon with hover effect */
.close {
  position: absolute;
  top: 12px;
  right: 18px;
  font-size: 26px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
  transition: color 0.25s ease;
}
.close:hover {
  color: #000;
}


/* Mode specific border color */
.create-mode .modal-content {
  border-left: 8px solid #28a745; /* Green for Create */
}

.edit-mode .modal-content {
  border-left: 8px solid #ffc107; /* Yellow for Edit */
}

/* Responsive tweaks for smaller screens */
@media (max-width: 480px) {
  .modal-content {
    padding: 20px 20px;
    width: 95%;
  }
  .modal-content .buttons-row {
    flex-direction: column-reverse;
    gap: 12px;
  }
  .modal-content button {
    width: 100%;
    min-width: auto;
  }
}

/* Responsive horizontal scroll container */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
  margin-top: 10px;
  box-shadow: inset 0 -1px 5px rgba(0,0,0,0.1);
}

/* Optional: make table min width for scroll */
.table-responsive table {
  min-width: 700px; /* or any width based on your columns */
  border-collapse: collapse;
}



  </style>
</head>
<body>

  <div class="header">
    <div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
    <div class="header-right">
      <div id="userInitials">U</div>
      <div id="username">User</div>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
    <h2><i class="fa fa-money-bill-wave"></i> Expense Tracker</h2>
    <input type="file" id="csvInput" accept=".csv" />

    <div class="filter-section">
      <div class="filters-row">
        <label>Date Filter:
          <select id="dateFilter"><option value="all">All</option><option value="week">This Week</option>
              <option value="month">This Month</option><option value="year">This Year</option>
              <option value="custom">Custom Range</option></select>
        </label>
        <label id="customDateRange" style="display:none;">From:
          <input type="date" id="startDate" /> To: <input type="date" id="endDate" />
        </label>
        <label>Income/Expense:
          <select id="incomeExpenseFilter"><option value="all">All</option><option value="income">Income Only</option>
            <option value="expense">Expense Only</option></select>
        </label>
        <label>Description contains:<input type="text" id="descFilter" placeholder="Searchâ€¦"/></label>
        <label>Mode:<select id="modeFilter"><option value="all">All</option></select></label>
        <label>Bank:<select id="bankFilter"><option value="all">All</option></select></label>
        <button id="applyFiltersBtn">Apply Filters</button>
      </div>
    </div>

<div class="table-responsive">
  <table>
    <thead>
      <tr>
        <th>SINO</th><th>DATE</th><th>TIME</th><th>ACCOUNT HEADER</th><th>MODE</th>
        <th>BANK NAME</th><th>INCOME</th><th>EXPENSE</th><th>DESCRIPTION</th>
        <th>BALANCE</th><th>ATTACHMENT</th><th>ACTION</th>
      </tr>
    </thead>
    <tbody id="transactionsTableBody">
      <tr><td colspan="12" style="text-align:center; color:#777;">No transactions loaded.</td></tr>
    </tbody>
  </table>
</div>


    <div class="pagination" id="pagination"></div>
  </div>

  <button id="addTransactionBtn" title="Add Transaction"><i class="fa fa-plus"></i></button>

  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle">Add Transaction</h3>
      <form id="transactionForm">
        <input type="hidden" id="txId" />
        <label>SINO: <input type="text" id="formSINO" required /></label>
        <label>DATE: <input type="date" id="formDATE" required /></label>
        <label>TIME: <input type="time" id="formTIME" required /></label>
        <label>ACCOUNT HEADER: 
  <select id="formHEADER" required><option value="">Loading...</option></select>
</label>
        <label>MODE: 
  <select id="formMODE" onchange="toggleBankDropdown()" required>
    <option value="">Select Mode</option>
    <option value="Cash">Cash</option>
    <option value="Bank">Bank</option>
  </select>
</label>
<div id="bankField" style="display:none;">
  <label for="formBANKNAME">Bank Name:</label>
  <select id="formBANKNAME" name="bankname">
    <option value="">Select Bank</option>
  </select>
</div>


        <label>INCOME: <input type="number" step="0.01" id="formINCOME" /></label>
        <label>EXPENSE: <input type="number" step="0.01" id="formEXPENSE" /></label>
        <label>DESCRIPTION: <input type="text" id="formDESC" /></label>
        <label>BALANCE: <input type="number" step="0.01" id="formBALANCE" /></label>
        <label>ATTACHMENT FILE: <input type="file" id="formATTACH" accept="image/*,application/pdf" /></label>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <div id="loadingModal" class="loading-modal">
    <div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;"></i>
      <p>Loading, please waitâ€¦</p></div>
  </div>

<div id="confirmDeleteModal" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <span class="close" id="closeConfirmDelete">&times;</span>
    <h3 style="margin-bottom: 10px;">Confirm Delete</h3>
    <p>Are you sure you want to delete this transaction?</p>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button id="cancelDeleteBtn" style="background:#6c757d;">Cancel</button>
      <button id="confirmDeleteBtn" style="background:#dc3545;">Delete</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, getDocs, writeBatch, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let txMap = {};

const app = initializeApp({
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
});
const db = getFirestore(app), auth = getAuth(app);

const usernameElem = document.getElementById("username"), initialsElem = document.getElementById("userInitials"), logoutBtn = document.getElementById("logoutBtn");
const csvInput = document.getElementById("csvInput"), tableBody = document.getElementById("transactionsTableBody");
const loadingModal = document.getElementById("loadingModal"), dateFilter = document.getElementById("dateFilter");
const customDateRange = document.getElementById("customDateRange"), startDateInput = document.getElementById("startDate"), endDateInput = document.getElementById("endDate");
const incomeExpenseFilter = document.getElementById("incomeExpenseFilter"), descFilter = document.getElementById("descFilter");
const modeFilter = document.getElementById("modeFilter"), bankFilter = document.getElementById("bankFilter");
const applyFiltersBtn = document.getElementById("applyFiltersBtn");
const addBtn = document.getElementById("addTransactionBtn"), modal = document.getElementById("transactionModal");
addBtn.onclick = async () => {
  document.getElementById("modalTitle").innerText = "Add Transaction";
  modal.classList.remove("edit-mode");
  modal.classList.add("create-mode");
  modal.style.display = "flex";

  form.reset();
  document.getElementById("transactionForm").reset();
  document.getElementById("txId").value = "";

  // Auto-generate SINO
  const lastSino = Math.max(0, ...allTransactions.map(tx => parseInt(tx.SINO) || 0));
  document.getElementById("formSINO").value = lastSino + 1;
  document.getElementById("formMODE").value = ""; // clear Mode on add new

  toggleBankDropdown();
  await loadExpenseAccounts();
  await loadBankAccounts();
};


const closeModal = () => modal.style.display = "none";
const form = document.getElementById("transactionForm");
let currentUser=null, allTransactions = [], filteredTransactions = [];
let currentPage = 1, rowsPerPage = 10;

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const name = user.displayName || user.email || "User";
    usernameElem.textContent = name;
    initialsElem.textContent = name.charAt(0).toUpperCase();
    await loadTransactions();
    await loadExpenseAccounts();
    await loadBankAccounts(); 
  } else {
    alert("Please login first."); window.location.href="index.html";
  }
});
logoutBtn.addEventListener("click", async ()=>{
  await signOut(auth); window.location.href="index.html";
});

csvInput.addEventListener("change", async e=>{
  const file=e.target.files[0];
  if(!file||!file.name.toLowerCase().endsWith(".csv")) return alert("Please upload a valid CSV file.");
  loadingModal.style.display="flex";
  const text=await file.text(), parsed=parseCSV(text);
  const requiredCols=["SINO","DATE","TIME","ACCOUNT HEADER","MODE","BANK NAME","INCOME","EXPENSE","DESCRIPTION","BALANCE","ATTACHMENT"];
  for(let h of requiredCols) if(!parsed[0]?.[h]){ alert(`Missing column "${h}"`); loadingModal.style.display="none"; return; }
  try {
    await clearUserTransactions();
    const txRef = collection(db,"users",currentUser.uid,"transactions");
    for(let row of parsed){
      await addDoc(txRef,{
        SINO:row.SINO, DATE:row.DATE, TIME:row.TIME,
        ACCOUNT_HEADER:row["ACCOUNT HEADER"], MODE:row.MODE, BANK_NAME:row["BANK NAME"],
        INCOME:parseFloat(row.INCOME)||0, EXPENSE:parseFloat(row.EXPENSE)||0,
        DESCRIPTION:row.DESCRIPTION, BALANCE:parseFloat(row.BALANCE)||0,
        ATTACHMENT:row["ATTACHMENT"]||""
      });
    }
    alert("CSV uploaded successfully!"); csvInput.value=""; await loadTransactions();
  } catch(err){ alert("Error saving data: "+err.message); }
  finally{ loadingModal.style.display="none"; }
});

dateFilter.addEventListener("change", ()=>{
  customDateRange.style.display = dateFilter.value==="custom"?"inline-flex":"none";
  if(dateFilter.value!=="custom"){ startDateInput.value=""; endDateInput.value=""; }
});
applyFiltersBtn.addEventListener("click", applyFilters);

window.editTransaction = (tx) => {
  document.getElementById("modalTitle").innerText = "Edit Transaction";
  modal.classList.remove("create-mode");
  modal.classList.add("edit-mode");
  modal.style.display = "flex";

  document.getElementById("txId").value = tx.id;
  formSINO.value = tx.SINO || "";
  formDATE.value = tx.DATE || "";
  formTIME.value = (tx.TIME || "").slice(0, 5);
  formHEADER.value = tx.ACCOUNT_HEADER || "";
  formMODE.value = tx.MODE || "";
 formBANKNAME.value = tx.BANK_NAME || "";
  formINCOME.value = tx.INCOME || "";
  formEXPENSE.value = tx.EXPENSE || "";
  formDESC.value = tx.DESCRIPTION || "";
  formBALANCE.value = tx.BALANCE || "";
  formATTACH.value = tx.ATTACHMENT || "";
};

document.querySelector(".close").addEventListener("click", closeModal);
window.addEventListener("click", e=>{ if(e.target===modal) closeModal(); });

form.addEventListener("submit", async e => {
  e.preventDefault();
  const txId = document.getElementById("txId").value;
  const file = formATTACH.files[0];
const data = {
  SINO: formSINO.value,
  DATE: formDATE.value,
  ACCOUNT_HEADER: formHEADER.value,
  MODE: formMODE.value,
  BANK_NAME: formBANK.value,
  BANK_NAME: formBANK.value,
  INCOME: parseFloat(formINCOME.value) || 0,
  EXPENSE: parseFloat(formEXPENSE.value) || 0,
  DESCRIPTION: formDESC.value,
  BALANCE: parseFloat(formBALANCE.value) || 0,
};

  try {
    loadingModal.style.display = "flex";



async function loadExpenseAccounts() {
  const q = query(
    collection(db, "chartOfAccounts"),
    where("userId", "==", currentUser.uid),
    where("type", "==", "Expense")
  );
  const snapshot = await getDocs(q);
  const select = document.getElementById("formHEADER");
  select.innerHTML = `<option value="">Select Account</option>`;
  snapshot.forEach(doc => {
    const data = doc.data();
    const option = document.createElement("option");
    option.value = data.name;
    option.textContent = `${data.category} - ${data.name}`;
    select.appendChild(option);
  });
}

// Load banks from Firestore chartOfAccounts (Asset > Bank)
async function loadBankAccounts() {
  const q = query(
    collection(db, "chartOfAccounts"),
    where("userId", "==", currentUser.uid),
    where("type", "==", "Asset"),
    where("category", "==", "Bank")
  );
  const snapshot = await getDocs(q);
  const select = document.getElementById("formBANKNAME");
  select.innerHTML = `<option value="">Select Bank</option>`;
  snapshot.forEach(doc => {
    const data = doc.data();
    const option = document.createElement("option");
    option.value = data.name;
    option.textContent = data.name;
    select.appendChild(option);
  });
}

document.getElementById("formMODE").addEventListener("change", toggleBankDropdown);

function toggleBankDropdown() {
  const mode = document.getElementById("formMODE").value;
  const bankField = document.getElementById("bankField");
  if (mode === "Bank") {
    bankField.style.display = "block";
  } else {
    bankField.style.display = "none";
    document.getElementById("formBANKNAME").value = "";
  }
}





    // Upload attachment if exists
if (file) {
  // Replace these with your Cloudinary info
  const cloudName = "dpwdsyvz8";
  const unsignedUploadPreset = "my_app_uploads";

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", unsignedUploadPreset);

  // Upload to Cloudinary
  const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
    method: "POST",
    body: formData
  });

  if (!response.ok) throw new Error("Failed to upload attachment to Cloudinary");

  const json = await response.json();
  data.ATTACHMENT = json.secure_url; // Cloudinary URL
} else if (txId) {
  // Keep existing attachment if editing and no new file uploaded
  const existing = allTransactions.find(t => t.id === txId);
  if (existing?.ATTACHMENT) {
    data.ATTACHMENT = existing.ATTACHMENT;
  }
}

    if (txId) {
      await updateDoc(doc(db, "users", currentUser.uid, "transactions", txId), data);
    } else {
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), data);
    }

    closeModal();
    await loadTransactions();
  } catch (err) {
    alert("Error saving transaction: " + err.message);
  } finally {
    loadingModal.style.display = "none";
  }
});

async function deleteTransaction(id) {
const result = await Swal.fire({
  title: 'Are you sure?',
  text: "This transaction will be permanently deleted.",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonColor: '#dc3545',
  cancelButtonColor: '#6c757d',
  confirmButtonText: 'Yes, delete it!'
});

  if (result.isConfirmed) {
    try {
      loadingModal.style.display = "flex";
      await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id));
      await loadTransactions();
      Swal.fire('Deleted!', 'Transaction has been deleted.', 'success');
    } catch (err) {
      Swal.fire('Error!', err.message, 'error');
    } finally {
      loadingModal.style.display = "none";
    }
  }
}


async function loadTransactions() {
  loadingModal.style.display="flex";
  try {
    const snap = await getDocs(collection(db,"users",currentUser.uid,"transactions"));
    allTransactions = snap.docs.map(d=>({ id:d.id,...d.data() }));
    allTransactions.sort((a,b)=>(parseInt(b.SINO)||0)-(parseInt(a.SINO)||0));
    populateOptions(allTransactions);
    applyFilters(); // will also trigger pagination
  } catch(err){ alert("Error loading transactions: "+err.message); }
  finally { loadingModal.style.display="none"; }
}

function populateOptions(data){
  const modes=new Set(), banks=new Set();
  data.forEach(t=>{ if(t.MODE) modes.add(t.MODE); if(t.BANK_NAME) banks.add(t.BANK_NAME); });
  modeFilter.innerHTML = `<option value="all">All</option>` + [...modes].sort().map(v=>`<option>${v}</option>`).join("");
  bankFilter.innerHTML = `<option value="all">All</option>` + [...banks].sort().map(v=>`<option>${v}</option>`).join("");
}

function applyFilters(){
  filteredTransactions = allTransactions.slice();
  const now = new Date();
  const isIn = (str,s,e)=> str && new Date(str)>=s && new Date(str)<=e;

  switch(dateFilter.value){
    case "week": { const s=new Date(now); s.setHours(0,0,0,0); s.setDate(now.getDate()-now.getDay());
      filteredTransactions = filteredTransactions.filter(t=>isIn(t.DATE,s,now)); break; }
    case "month": { const s=new Date(now.getFullYear(),now.getMonth(),1);
      filteredTransactions = filteredTransactions.filter(t=>isIn(t.DATE,s,now)); break; }
    case "year": { const s=new Date(now.getFullYear(),0,1);
      filteredTransactions = filteredTransactions.filter(t=>isIn(t.DATE,s,now)); break; }
    case "custom":
      if(startDateInput.value && endDateInput.value){
        let s=new Date(startDateInput.value), e=new Date(endDateInput.value);
        e.setHours(23,59,59,999);
        filteredTransactions = filteredTransactions.filter(t=>isIn(t.DATE,s,e));
      }
      break;
  }

  if(incomeExpenseFilter.value==="income")
    filteredTransactions = filteredTransactions.filter(t=>t.INCOME>0);
  else if(incomeExpenseFilter.value==="expense")
    filteredTransactions = filteredTransactions.filter(t=>t.EXPENSE>0);

  if(descFilter.value.trim()){
    const search = descFilter.value.trim().toLowerCase();
    filteredTransactions = filteredTransactions.filter(t=> (t.DESCRIPTION||"").toLowerCase().includes(search));
  }
  if(modeFilter.value!=="all") filteredTransactions = filteredTransactions.filter(t=>t.MODE===modeFilter.value);
  if(bankFilter.value!=="all") filteredTransactions = filteredTransactions.filter(t=>t.BANK_NAME===bankFilter.value);

  currentPage = 1;
  buildTable();
}

function buildTable() {
  txMap = {}; // reset map
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageItems = filteredTransactions.slice(start, end);
  tableBody.innerHTML = "";

  if (pageItems.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:#777;">No transactions found.</td></tr>`;
    return;
  }

  pageItems.forEach(d => {
    txMap[d.id] = d;
    const incomeCell = d.INCOME > 0 ? `<span style="color:green;">${d.INCOME.toFixed(2)}</span>` : "";
    const expenseCell = d.EXPENSE > 0 ? `<span style="color:red;">${d.EXPENSE.toFixed(2)}</span>` : "";
    const balanceCell = d.BALANCE ? d.BALANCE.toFixed(2) : "";
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${escapeHtml(d.SINO)}</td>
      <td>${escapeHtml(d.DATE)}</td>
      <td>${escapeHtml(d.TIME)}</td>
      <td>${escapeHtml(d.ACCOUNT_HEADER)}</td>
      <td>${escapeHtml(d.MODE)}</td>
      <td>${escapeHtml(d.BANK_NAME)}</td>
      <td>${incomeCell}</td>
      <td>${expenseCell}</td>
      <td>${escapeHtml(d.DESCRIPTION)}</td>
      <td>${balanceCell}</td>
      <td class="attachment-cell">${d.ATTACHMENT ? `<a href="${escapeHtml(d.ATTACHMENT)}" target="_blank" rel="noopener noreferrer">View</a>` : ""}</td>
      <td>
        <button class="btn-edit" onclick='editTransactionById("${d.id}")'>Edit</button>
        <button class="btn-delete" onclick='showDeleteConfirm("${d.id}")'>Delete</button>
      </td>
    `;

    tableBody.appendChild(row);
  });

  renderPagination();
}


function editTransactionById(id) {
  const tx = txMap[id];
  if (tx) editTransaction(tx);
}
function renderPagination() {
  const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage) || 1;
  const container = document.getElementById("pagination");
  container.innerHTML = "";

  if (totalPages <= 1) return;

  const createButton = (text, page, disabled = false, active = false) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    if (active) btn.classList.add("active");
    if (disabled) {
      btn.classList.add("disabled");
      btn.disabled = true;
    } else {
      btn.onclick = () => {
        currentPage = page;
        buildTable();
      };
    }
    container.appendChild(btn);
  };

  const addEllipsis = () => {
    const span = document.createElement("span");
    span.textContent = "...";
    span.style.margin = "0 5px";
    span.style.color = "#666";
    container.appendChild(span);
  };

  const pageRange = [];
  if (totalPages <= 7) {
    for (let i = 1; i <= totalPages; i++) pageRange.push(i);
  } else {
    pageRange.push(1);

    if (currentPage > 4) addEllipsis();

    const start = Math.max(2, currentPage - 1);
    const end = Math.min(totalPages - 1, currentPage + 1);
    for (let i = start; i <= end; i++) pageRange.push(i);

    if (currentPage < totalPages - 3) addEllipsis();

    pageRange.push(totalPages);
  }

  pageRange.forEach(p => {
    if (typeof p === "number") {
      createButton(p, p, false, p === currentPage);
    }
  });
}



function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"']/g, function(m) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m];
  });
}

let transactionToDelete = null;
const confirmDeleteModal = document.getElementById("confirmDeleteModal");
const closeConfirmDelete = document.getElementById("closeConfirmDelete");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

function showDeleteConfirm(id) {
  transactionToDelete = id;
  confirmDeleteModal.style.display = "flex";
}

closeConfirmDelete.onclick = () => confirmDeleteModal.style.display = "none";
cancelDeleteBtn.onclick = () => confirmDeleteModal.style.display = "none";
window.onclick = (e) => {
  if (e.target === confirmDeleteModal) confirmDeleteModal.style.display = "none";
};

confirmDeleteBtn.onclick = async () => {
  if (!transactionToDelete) return;
  confirmDeleteModal.style.display = "none";
  try {
    loadingModal.style.display = "flex";
    await deleteDoc(doc(db, "users", currentUser.uid, "transactions", transactionToDelete));
    await loadTransactions();
  } catch (err) {
    alert("Error deleting: " + err.message);
  } finally {
    loadingModal.style.display = "none";
    transactionToDelete = null;
  }
};
function convertTo24Hour(timeStr) {
  const [time, modifier] = timeStr.split(' ');
  let [hours, minutes] = time.split(':');
  if (modifier === 'PM' && hours !== '12') hours = String(+hours + 12);
  if (modifier === 'AM' && hours === '12') hours = '00';
  return `${hours.padStart(2, '0')}:${minutes}`;
}
window.editTransactionById = editTransactionById;
window.showDeleteConfirm = showDeleteConfirm;


function convertTo12Hour(timeStr) {
  const [h,m] = timeStr.split(':');
  let hour = parseInt(h);
  const suffix = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${m} ${suffix}`;
}


</script>
</body>
</html>
