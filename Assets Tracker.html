<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Security Rules Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #4285f4;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #5f6368;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        h2 {
            font-size: 1.8rem;
            color: #4285f4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaecef;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-right: 12px;
        }
        
        h3 {
            font-size: 1.4rem;
            color: #5f6368;
            margin: 25px 0 15px;
        }
        
        .rules-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        pre {
            font-family: 'Source Code Pro', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #2e3338;
            white-space: pre-wrap;
            tab-size: 2;
            -moz-tab-size: 2;
            -o-tab-size: 2;
        }
        
        .code-keyword {
            color: #a71d5d;
            font-weight: 500;
        }
        
        .code-comment {
            color: #969896;
        }
        
        .code-function {
            color: #005cc5;
        }
        
        .code-value {
            color: #032f62;
        }
        
        .analysis {
            background: #e7f3ff;
            border-left: 4px solid #4285f4;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .recommendation {
            background: #e6f7ee;
            border-left: 4px solid #34a853;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .warning {
            background: #fef7e0;
            border-left: 4px solid #fbbc04;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        ul {
            padding-left: 25px;
            margin: 15px 0;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .icon-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .rules-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }
        
        .diagram-row {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .diagram-item {
            padding: 15px 25px;
            background: #e7f3ff;
            border: 2px solid #4285f4;
            border-radius: 8px;
            margin: 0 10px;
            text-align: center;
            min-width: 180px;
        }
        
        .diagram-arrow {
            font-size: 24px;
            color: #5f6368;
            margin: 0 5px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Firestore Security Rules Analysis</h1>
        <p class="subtitle">Reviewing and enhancing security rules for an asset tracker application with Cloudinary integration</p>
    </header>
    
    <div class="container">
        <div>
            <div class="card">
                <h2><div class="icon-box"><i class="fas fa-lock"></i></div> Current Rules Analysis</h2>
                
                <div class="rules-container">
                    <pre><span class="code-keyword">rules_version</span> = <span class="code-value">'2'</span>;
<span class="code-keyword">service</span> cloud.firestore {
  <span class="code-keyword">function</span> <span class="code-function">isAuthenticated</span>() {
    <span class="code-keyword">return</span> request.auth != <span class="code-keyword">null</span>;
  }

  <span class="code-keyword">function</span> <span class="code-function">isAdmin</span>() {
    <span class="code-keyword">return</span> isAuthenticated() && request.auth.token.admin == <span class="code-keyword">true</span>;
  }

  <span class="code-keyword">match</span> /databases/{database}/documents {
    <span class="code-comment">// Public data (read-only, no writes)</span>
    <span class="code-keyword">match</span> /publicdata/{document=**} {
      <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> <span class="code-keyword">true</span>;
      <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> <span class="code-keyword">false</span>;
    }

    <span class="code-comment">// Main users collection</span>
    <span class="code-keyword">match</span> /users/{userId} {
      <span class="code-comment">// A user can read/write only their own user doc</span>
      <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());

      <span class="code-comment">// Subcollections: transactions</span>
      <span class="code-keyword">match</span> /transactions/{txId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }

      <span class="code-comment">// Subcollections: chartOfAccounts</span>
      <span class="code-keyword">match</span> /chartOfAccounts/{docId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }

      <span class="code-comment">// Subcollections: categories</span>
      <span class="code-keyword">match</span> /categories/{docId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }

      <span class="code-comment">// Subcollections: bankAccounts</span>
      <span class="code-keyword">match</span> /bankAccounts/{docId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }

      <span class="code-comment">// Subcollections: reminders</span>
      <span class="code-keyword">match</span> /users/{userId}/reminders/{reminderId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());	
      }
      
      <span class="code-comment">// Subcollections: documents (for invoices, receipts, etc.)</span>
      <span class="code-keyword">match</span> /documents/{docId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }

      <span class="code-comment">// Subcollections: any future features (budgets, tasks, notes, etc.)</span>
      <span class="code-keyword">match</span> /{featureCollection}/{docId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (request.auth.uid == userId || isAdmin());
      }
    }

    <span class="code-comment">// Deny everything else</span>
    <span class="code-keyword">match</span> /{document=**} {
      <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> <span class="code-keyword">false</span>;
    }
  }
}</pre>
                </div>
                
                <div class="analysis">
                    <h3>Analysis of Current Rules</h3>
                    <p>The current rules provide a solid foundation with:</p>
                    <ul>
                        <li>Authentication requirement for most data access</li>
                        <li>User isolation - users can only access their own data</li>
                        <li>Admin override capability for support purposes</li>
                        <li>Clear public data section with read-only access</li>
                        <li>Default-deny strategy for unmatched paths</li>
                    </ul>
                </div>
                
                <div class="warning">
                    <h3>Potential Issues</h3>
                    <ul>
                        <li>The reminders subcollection path is incorrect (duplicate "users" segment)</li>
                        <li>No specific rules for the asset tracker functionality</li>
                        <li>No validation for data structure</li>
                        <li>No separation of create/update/delete permissions</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div>
            <div class="card">
                <h2><div class="icon-box"><i class="fas fa-shield-alt"></i></div> Enhanced Rules</h2>
                
                <div class="rules-container">
                    <pre><span class="code-keyword">rules_version</span> = <span class="code-value">'2'</span>;
<span class="code-keyword">service</span> cloud.firestore {
  <span class="code-keyword">function</span> <span class="code-function">isAuthenticated</span>() {
    <span class="code-keyword">return</span> request.auth != <span class="code-keyword">null</span>;
  }

  <span class="code-keyword">function</span> <span class="code-function">isAdmin</span>() {
    <span class="code-keyword">return</span> isAuthenticated() && request.auth.token.admin == <span class="code-keyword">true</span>;
  }
  
  <span class="code-keyword">function</span> <span class="code-function">isUser</span>(userId) {
    <span class="code-keyword">return</span> isAuthenticated() && request.auth.uid == userId;
  }

  <span class="code-keyword">match</span> /databases/{database}/documents {
    <span class="code-comment">// Public data (read-only, no writes)</span>
    <span class="code-keyword">match</span> /publicdata/{document=**} {
      <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> <span class="code-keyword">true</span>;
      <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> <span class="code-keyword">false</span>;
    }

    <span class="code-comment">// Main users collection</span>
    <span class="code-keyword">match</span> /users/{userId} {
      <span class="code-comment">// A user can read their own doc, but only update specific fields</span>
      <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      <span class="code-keyword">allow</span> create: <span class="code-keyword">if</span> isAuthenticated() && isUser(userId);
      <span class="code-keyword">allow</span> update, delete: <span class="code-keyword">if</span> isAdmin(); <span class="code-comment">// Only admins can modify user docs</span>

      <span class="code-comment">// Subcollections: transactions</span>
      <span class="code-keyword">match</span> /transactions/{txId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }

      <span class="code-comment">// Subcollections: chartOfAccounts</span>
      <span class="code-keyword">match</span> /chartOfAccounts/{docId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }

      <span class="code-comment">// Subcollections: categories</span>
      <span class="code-keyword">match</span> /categories/{docId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }

      <span class="code-comment">// Subcollections: bankAccounts</span>
      <span class="code-keyword">match</span> /bankAccounts/{docId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }

      <span class="code-comment">// Subcollections: reminders</span>
      <span class="code-keyword">match</span> /reminders/{reminderId} {
        <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());	
      }
      
      <span class="code-comment">// Subcollections: documents (for invoices, receipts, etc.)</span>
      <span class="code-keyword">match</span> /documents/{docId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }
      
      <span class="code-comment">// ASSET TRACKER: Subcollection for asset management</span>
      <span class="code-keyword">match</span> /assets/{assetId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        
        <span class="code-comment">// Subcollection for asset attachments (Cloudinary info)</span>
        <span class="code-keyword">match</span> /attachments/{attachmentId} {
          <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
          <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        }
        
        <span class="code-comment">// Subcollection for journal entries</span>
        <span class="code-keyword">match</span> /journal/{entryId} {
          <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
          <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        }
      }

      <span class="code-comment">// Subcollections: any future features (budgets, tasks, notes, etc.)</span>
      <span class="code-keyword">match</span> /{featureCollection}/{docId} {
        <span class="code-keyword">allow</span> read: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
        <span class="code-keyword">allow</span> write: <span class="code-keyword">if</span> isAuthenticated() && (isUser(userId) || isAdmin());
      }
    }

    <span class="code-comment">// Deny everything else</span>
    <span class="code-keyword">match</span> /{document=**} {
      <span class="code-keyword">allow</span> read, write: <span class="code-keyword">if</span> <span class="code-keyword">false</span>;
    }
  }
}</pre>
                </div>
                
                <div class="recommendation">
                    <h3>Enhancements Made</h3>
                    <ul>
                        <li>Fixed the reminders subcollection path</li>
                        <li>Added dedicated asset tracker subcollections (assets, attachments, journal)</li>
                        <li>Created a helper function <code>isUser()</code> for cleaner rules</li>
                        <li>Separated read and write permissions for finer control</li>
                        <li>Added specific create/update/delete rules for user documents</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <h2><div class="icon-box"><i class="fas fa-sitemap"></i></div> Data Structure</h2>
                
                <div class="rules-diagram">
                    <div class="diagram-row">
                        <div class="diagram-item">users/{userId}</div>
                    </div>
                    
                    <div class="diagram-row">
                        <i class="fas fa-arrow-down diagram-arrow"></i>
                    </div>
                    
                    <div class="diagram-row">
                        <div class="diagram-item">assets/{assetId}</div>
                    </div>
                    
                    <div class="diagram-row">
                        <i class="fas fa-arrow-down diagram-arrow"></i>
                    </div>
                    
                    <div class="diagram-row">
                        <div class="diagram-item">attachments/{attachmentId}</div>
                        <div class="diagram-item">journal/{entryId}</div>
                    </div>
                </div>
                
                <div class="analysis">
                    <h3>Asset Document Structure</h3>
                    <p>Each asset document should contain:</p>
                    <ul>
                        <li><strong>name</strong>: Name of the asset</li>
                        <li><strong>type</strong>: Type of asset (electronics, vehicle, property, etc.)</li>
                        <li><strong>value</strong>: Monetary value of the asset</li>
                        <li><strong>purchaseDate</strong>: When the asset was acquired</li>
                        <li><strong>description</strong>: Additional details about the asset</li>
                        <li><strong>cloudinaryFolder</strong>: Path to Cloudinary folder (e.g., "user_assets/user_id/asset_id")</li>
                    </ul>
                </div>
                
                <div class="recommendation">
                    <h3>Cloudinary Integration</h3>
                    <p>For Cloudinary integration with the rules:</p>
                    <ul>
                        <li>Store Cloudinary credentials in Firebase Functions or secure environment</li>
                        <li>Use Firebase Functions to generate secure upload signatures</li>
                        <li>Store attachment metadata in the attachments subcollection</li>
                        <li>Include Cloudinary public_id, version, and format in attachment documents</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple syntax highlighting
        document.addEventListener('DOMContentLoaded', function() {
            const rulesContainers = document.querySelectorAll('.rules-container');
            
            rulesContainers.forEach(container => {
                const code = container.querySelector('pre');
                let html = code.innerHTML;
                
                // Highlight keywords
                html = html.replace(/(rules_version|service|function|return|match|allow|if|true|false|null)/g, 
                    '<span class="code-keyword">$1</span>');
                
                // Highlight functions
                html = html.replace(/(isAuthenticated|isAdmin|isUser)/g, 
                    '<span class="code-function">$1</span>');
                
                // Highlight values
                html = html.replace(/('2'|'[^']*')/g, 
                    '<span class="code-value">$1</span>');
                
                // Highlight comments
                html = html.replace(/(\/\/.*)/g, 
                    '<span class="code-comment">$1</span>');
                
                code.innerHTML = html;
            });
        });
    </script>
</body>
</html>