<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body{font-family:Arial,sans-serif;background:#f7f7f7;margin:0;padding:0}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.header-left{font-weight:bold; display:flex; align-items:center; gap:15px;}
.header-right{display:flex;align-items:center;gap:10px}
#userInitials{background:#007bff;color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:bold}
#username{font-weight:bold}
#logoutBtn{background:#dc3545;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer}
#logoutBtn:hover{background:#a71d2a}
.container{max-width:1200px;margin:30px auto;background:#fff;padding:30px;border-radius:8px}
h2{text-align:center;margin-bottom:10px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{padding:12px;border:1px solid #ccc;text-align:left}
th{background:#f1f1f1}
button{background:#28a745;color:#fff;padding:8px 16px;border:none;border-radius:5px;cursor:pointer}
button:hover{background:#218838}
input[type=date]{padding:6px;border-radius:4px;border:1px solid #ccc}
.pointer{cursor:pointer}
#totals{margin-top:20px;font-weight:bold;font-size:16px;}
#totals span{margin-right:20px;}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none;color:#007bff;font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
<h2>General Report (Bank-wise)</h2>

<div style="margin-bottom:15px;">
  <label>From: <input type="date" id="fromDate"></label>
  <label style="margin-left:10px;">To: <input type="date" id="toDate"></label>
</div>

<table>
  <thead>
    <tr>
      <th>Bank Name</th>
      <th>Total Income</th>
      <th>Total Expenses</th>
      <th>Net Balance</th>
    </tr>
  </thead>
  <tbody id="reportTable"></tbody>
</table>

<div id="totals"></div>

<h3 id="transactionsTitle" style="margin-top:30px;"></h3>
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Account</th>
      <th>Type</th>
      <th>Amount</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody id="transactionsTable"></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const usernameElem = document.getElementById("username");
const profileCircle = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const datetimeElem = document.getElementById("datetime");
const reportTable = document.getElementById("reportTable");
const transactionsTable = document.getElementById("transactionsTable");
const transactionsTitle = document.getElementById("transactionsTitle");
const fromDateInput = document.getElementById("fromDate");
const toDateInput = document.getElementById("toDate");
const totalsDiv = document.getElementById("totals");

let currentUser = null;
let transactions = [];
let coaAccounts = [];

// Clock
function updateTime(){datetimeElem.textContent=(new Date()).toLocaleString();}
setInterval(updateTime,1000); updateTime();

// Auth check
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    const storedUsername = user.displayName || user.email;
    usernameElem.textContent=storedUsername;
    profileCircle.textContent=storedUsername.charAt(0).toUpperCase();
    loadReport();
  }else{
    window.location.href="login.html";
  }
});

logoutBtn.addEventListener("click", async()=>{await signOut(auth);window.location.href="login.html";});

// Load CoA (Bank accounts) & Transactions
async function loadReport(){
  try{
    // Load CoA accounts
    const coaSnap = await getDocs(collection(db,"chartOfAccounts"));
    coaAccounts = coaSnap.docs.filter(d=>d.data().userId===currentUser.uid && d.data().type==="Asset" && ["Bank","Cash"].includes(d.data().category))
                              .map(d=>({id:d.id,...d.data()}));

    // Load all transactions
    const txSnap = await getDocs(collection(db,"users",currentUser.uid,"transactions"));
    transactions = txSnap.docs.map(d=>({id:d.id,...d.data()}));

    renderReport();
  }catch(err){console.error(err); alert("Failed to load report: "+err.message);}
}

// Render Bank-wise summary
function renderReport(){
  reportTable.innerHTML="";
  totalsDiv.innerHTML="";
  const bankTotals = {};

  coaAccounts.forEach(acc=>{
    bankTotals[acc.name] = {income:0, expense:0};
  });

  transactions.forEach(tx=>{
    const acc = coaAccounts.find(a=>a.id===tx.accountId || a.name===tx.ACCOUNT_HEADER);
    if(acc){
      const income = Number(tx.INCOME||0);
      const expense = Number(tx.EXPENSE||0);
      bankTotals[acc.name].income += income;
      bankTotals[acc.name].expense += expense;
    }
  });

  let totalIncome=0, totalExpenses=0;

  for(const bank in bankTotals){
    const data = bankTotals[bank];
    const net = data.income - data.expense;
    totalIncome += data.income;
    totalExpenses += data.expense;

    const tr = document.createElement("tr");
    tr.classList.add("pointer");
    tr.innerHTML = `<td>${bank}</td>
                    <td>₹${data.income.toFixed(2)}</td>
                    <td>₹${data.expense.toFixed(2)}</td>
                    <td style="color:${net>=0?'green':'red'}">₹${net.toFixed(2)}</td>`;
    tr.addEventListener("click",()=>showTransactions(bank));
    reportTable.appendChild(tr);
  }

  totalsDiv.innerHTML = `<span>Total Income: ₹${totalIncome.toFixed(2)}</span>
                         <span>Total Expenses: ₹${totalExpenses.toFixed(2)}</span>
                         <span>Net: ₹${(totalIncome-totalExpenses).toFixed(2)}</span>`;
}

// Show transactions for a bank with optional date filter
function showTransactions(bankName){
  transactionsTitle.textContent=`Transactions for ${bankName}`;
  transactionsTable.innerHTML="";

  const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
  const toDate = toDateInput.value ? new Date(toDateInput.value) : null;

  const filteredTx = transactions.filter(tx=>{
    const acc = coaAccounts.find(a=>a.id===tx.accountId || a.name===tx.ACCOUNT_HEADER);
    if(!acc || acc.name!==bankName) return false;

    if(fromDate || toDate){
      const txDate = new Date(tx.date || tx.transactionDate || (tx.createdAt?.seconds?tx.createdAt.seconds*1000:null));
      if(txDate){
        if(fromDate && txDate<fromDate) return false;
        if(toDate && txDate>toDate) return false;
      }
    }
    return true;
  });

  filteredTx.forEach(tx=>{
    const type = Number(tx.INCOME||0) > 0 ? "Income" : "Expense";
    const amount = type==="Income"?Number(tx.INCOME||0):Number(tx.EXPENSE||0);
    const dateStr = tx.date||tx.transactionDate||"";
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${dateStr}</td><td>${tx.ACCOUNT_HEADER||""}</td><td>${type}</td><td>₹${amount.toFixed(2)}</td><td>${tx.notes||""}</td>`;
    transactionsTable.appendChild(tr);
  });
}

// Reload transactions on date change
fromDateInput.addEventListener("change",()=>{ const firstBank = reportTable.querySelector("tr")?.children[0].textContent; if(firstBank) showTransactions(firstBank); });
toDateInput.addEventListener("change",()=>{ const firstBank = reportTable.querySelector("tr")?.children[0].textContent; if(firstBank) showTransactions(firstBank); });

  let currentPage = 1;
const pageSize = 10; // 10 transactions per page

function showTransactions(bankName){
  transactionsTitle.textContent=`Transactions for ${bankName}`;
  const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
  const toDate = toDateInput.value ? new Date(toDateInput.value) : null;

  const filteredTx = transactions.filter(tx=>{
    const acc = coaAccounts.find(a=>a.id===tx.accountId || a.name===tx.ACCOUNT_HEADER);
    if(!acc || acc.name!==bankName) return false;

    const txDate = new Date(tx.date || tx.transactionDate || (tx.createdAt?.seconds*1000));
    if(fromDate && txDate<fromDate) return false;
    if(toDate && txDate>toDate) return false;

    return true;
  });

  const totalPages = Math.ceil(filteredTx.length / pageSize);
  currentPage = 1;

  function renderPage(page){
    transactionsTable.innerHTML="";
    const start = (page-1)*pageSize;
    const end = start + pageSize;
    const pageTx = filteredTx.slice(start,end);

    pageTx.forEach(tx=>{
      const type = Number(tx.INCOME||0)>0?"Income":"Expense";
      const amount = type==="Income"?Number(tx.INCOME||0):Number(tx.EXPENSE||0);
      const dateStr = tx.date||tx.transactionDate||"";
      const tr = document.createElement("tr");
      tr.innerHTML=`<td>${dateStr}</td>
                    <td>${tx.ACCOUNT_HEADER||""}</td>
                    <td>${type}</td>
                    <td>₹${amount.toFixed(2)}</td>
                    <td>${tx.notes||""}</td>`;
      transactionsTable.appendChild(tr);
    });

    // Pagination controls
    let paginationDiv = document.getElementById("pagination");
    if(!paginationDiv){
      paginationDiv = document.createElement("div");
      paginationDiv.id="pagination";
      paginationDiv.style.margin="15px 0";
      transactionsTable.parentNode.insertBefore(paginationDiv, transactionsTable.nextSibling);
    }
    paginationDiv.innerHTML="";
    for(let i=1;i<=totalPages;i++){
      const btn = document.createElement("button");
      btn.textContent=i;
      btn.style.marginRight="5px";
      btn.disabled = (i===page);
      btn.addEventListener("click",()=>renderPage(i));
      paginationDiv.appendChild(btn);
    }
  }

  renderPage(currentPage);
}
</script>

</body>
</html>
