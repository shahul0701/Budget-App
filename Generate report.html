<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body{font-family:Arial,sans-serif;background:#f7f7f7;margin:0;padding:0}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.header-left{font-weight:bold; display:flex; align-items:center; gap:15px;}
.header-right{display:flex;align-items:center;gap:10px}
#userInitials{background:#007bff;color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:bold}
#username{font-weight:bold}
#logoutBtn{background:#dc3545;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer}
#logoutBtn:hover{background:#a71d2a}
.container{max-width:1200px;margin:30px auto;background:#fff;padding:30px;border-radius:8px}
h2{text-align:center;margin-bottom:10px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{padding:12px;border:1px solid #ccc;text-align:left}
th{background:#f1f1f1}
button{background:#28a745;color:#fff;padding:8px 16px;border:none;border-radius:5px;cursor:pointer}
button:hover{background:#218838}
input[type=date]{padding:6px;border-radius:4px;border:1px solid #ccc}
.pointer{cursor:pointer}
#totals{margin-top:20px;font-weight:bold;font-size:16px;}
#totals span{margin-right:20px;}
.pagination{display:flex;justify-content:center;margin-top:20px;gap:5px}
.pagination button{background:#007bff;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer}
.pagination button:disabled{background:#6c757d;cursor:not-allowed}
.pagination button:hover:not(:disabled){background:#0056b3}
.loading{text-align:center;padding:20px;color:#6c757d}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none;color:#007bff;font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
<h2>General Report (Bank-wise)</h2>

<div style="margin-bottom:15px;">
  <label>From: <input type="date" id="fromDate"></label>
  <label style="margin-left:10px;">To: <input type="date" id="toDate"></label>
  <button id="applyFilterBtn" style="margin-left:10px;">Apply Filter</button>
</div>

<table>
  <thead>
    <tr>
      <th>Bank Name</th>
      <th>Total Income</th>
      <th>Total Expenses</th>
      <th>Net Balance</th>
    </tr>
  </thead>
  <tbody id="reportTable">
    <tr><td colspan="4" class="loading">Loading bank data...</td></tr>
  </tbody>
</table>

<div id="totals"></div>

<h3 id="transactionsTitle" style="margin-top:30px;"></h3>
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Account</th>
      <th>Type</th>
      <th>Amount</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody id="transactionsTable"></tbody>
</table>
<div id="pagination" class="pagination"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const usernameElem = document.getElementById("username");
const profileCircle = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const datetimeElem = document.getElementById("datetime");
const reportTable = document.getElementById("reportTable");
const transactionsTable = document.getElementById("transactionsTable");
const transactionsTitle = document.getElementById("transactionsTitle");
const fromDateInput = document.getElementById("fromDate");
const toDateInput = document.getElementById("toDate");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const totalsDiv = document.getElementById("totals");
const paginationDiv = document.getElementById("pagination");

let currentUser = null;
let transactions = [];
let coaAccounts = [];
let currentBank = null;
let currentPage = 1;
const pageSize = 10;

// Set default date range (current month)
const today = new Date();
const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

fromDateInput.value = formatDate(firstDayOfMonth);
toDateInput.value = formatDate(lastDayOfMonth);

// Clock
function updateTime(){datetimeElem.textContent=(new Date()).toLocaleString();}
setInterval(updateTime,1000); updateTime();

// Format date to YYYY-MM-DD
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Auth check
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    const storedUsername = user.displayName || user.email;
    usernameElem.textContent = storedUsername;
    profileCircle.textContent = storedUsername.charAt(0).toUpperCase();
    loadReport();
  } else {
    window.location.href = "login.html";
  }
});

logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

applyFilterBtn.addEventListener("click", () => {
  if (currentBank) {
    showTransactions(currentBank);
  } else {
    loadReport();
  }
});

// Load CoA (Bank accounts) & Transactions
async function loadReport() {
  try {
    reportTable.innerHTML = '<tr><td colspan="4" class="loading">Loading bank data...</td></tr>';
    
    // Load CoA accounts (Bank and Cash types)
    const coaQuery = query(
      collection(db, "chartOfAccounts"),
      where("userId", "==", currentUser.uid),
      where("type", "==", "Asset")
    );
    
    const coaSnap = await getDocs(coaQuery);
    coaAccounts = coaSnap.docs
      .filter(doc => ["Bank", "Cash"].includes(doc.data().category))
      .map(doc => ({ id: doc.id, ...doc.data() }));
    
    if (coaAccounts.length === 0) {
      reportTable.innerHTML = '<tr><td colspan="4" class="loading">No bank accounts found.</td></tr>';
      return;
    }

    // Load transactions for the date range
    await loadTransactions();
    renderReport();
  } catch (err) {
    console.error("Error loading report:", err);
    reportTable.innerHTML = '<tr><td colspan="4" class="loading">Error loading data. Please try again.</td></tr>';
  }
}

// Load transactions with date filtering
async function loadTransactions() {
  try {
    const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
    const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
    
    // Adjust toDate to include the entire day
    if (toDate) {
      toDate.setHours(23, 59, 59, 999);
    }
    
    // Create query constraints
    const constraints = [where("userId", "==", currentUser.uid)];
    
    if (fromDate && toDate) {
      constraints.push(where("date", ">=", fromDate));
      constraints.push(where("date", "<=", toDate));
    } else if (fromDate) {
      constraints.push(where("date", ">=", fromDate));
    } else if (toDate) {
      constraints.push(where("date", "<=", toDate));
    }
    
    // Query transactions
    const txQuery = query(collection(db, "users", currentUser.uid, "transactions"), ...constraints);
    const txSnap = await getDocs(txQuery);
    
    transactions = txSnap.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        ...data,
        // Convert Firestore Timestamp to Date if needed
        date: data.date ? (data.date.toDate ? data.date.toDate() : new Date(data.date)) : null
      };
    });
  } catch (err) {
    console.error("Error loading transactions:", err);
    transactions = [];
  }
}

// Render Bank-wise summary
function renderReport() {
  reportTable.innerHTML = "";
  totalsDiv.innerHTML = "";
  const bankTotals = {};

  // Initialize bank totals
  coaAccounts.forEach(acc => {
    bankTotals[acc.id] = {
      name: acc.name,
      income: 0,
      expense: 0
    };
  });

  // Calculate totals
  transactions.forEach(tx => {
    const bankId = tx.accountId;
    if (bankTotals[bankId]) {
      const income = Number(tx.INCOME || 0);
      const expense = Number(tx.EXPENSE || 0);
      bankTotals[bankId].income += income;
      bankTotals[bankId].expense += expense;
    }
  });

  let totalIncome = 0, totalExpenses = 0;

  // Create table rows
  for (const bankId in bankTotals) {
    const data = bankTotals[bankId];
    const net = data.income - data.expense;
    totalIncome += data.income;
    totalExpenses += data.expense;

    const tr = document.createElement("tr");
    tr.classList.add("pointer");
    tr.innerHTML = `<td>${data.name}</td>
                    <td>₹${data.income.toFixed(2)}</td>
                    <td>₹${data.expense.toFixed(2)}</td>
                    <td style="color:${net >= 0 ? 'green' : 'red'}">₹${net.toFixed(2)}</td>`;
    tr.addEventListener("click", () => showTransactions(bankId));
    reportTable.appendChild(tr);
  }

  // Display totals
  totalsDiv.innerHTML = `<span>Total Income: ₹${totalIncome.toFixed(2)}</span>
                         <span>Total Expenses: ₹${totalExpenses.toFixed(2)}</span>
                         <span>Net: ₹${(totalIncome - totalExpenses).toFixed(2)}</span>`;
}

// Show transactions for a bank with pagination
function showTransactions(bankId) {
  currentBank = bankId;
  const bank = coaAccounts.find(acc => acc.id === bankId);
  if (!bank) return;
  
  transactionsTitle.textContent = `Transactions for ${bank.name}`;
  transactionsTable.innerHTML = '<tr><td colspan="5" class="loading">Loading transactions...</td></tr>';
  
  const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
  const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
  
  // Adjust toDate to include the entire day
  if (toDate) {
    toDate.setHours(23, 59, 59, 999);
  }
  
  // Filter transactions by bank and date
  const filteredTx = transactions.filter(tx => {
    if (tx.accountId !== bankId) return false;
    
    if (fromDate || toDate) {
      const txDate = tx.date ? new Date(tx.date) : null;
      if (!txDate) return false;
      
      if (fromDate && txDate < fromDate) return false;
      if (toDate && txDate > toDate) return false;
    }
    
    return true;
  });
  
  // Sort by date (newest first)
  filteredTx.sort((a, b) => {
    const dateA = a.date ? new Date(a.date) : new Date(0);
    const dateB = b.date ? new Date(b.date) : new Date(0);
    return dateB - dateA;
  });
  
  const totalPages = Math.ceil(filteredTx.length / pageSize);
  currentPage = 1;
  
  renderTransactionPage(filteredTx, currentPage, totalPages);
}

// Render a page of transactions
function renderTransactionPage(transactions, page, totalPages) {
  transactionsTable.innerHTML = "";
  
  if (transactions.length === 0) {
    transactionsTable.innerHTML = '<tr><td colspan="5" class="loading">No transactions found.</td></tr>';
    paginationDiv.innerHTML = "";
    return;
  }
  
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, transactions.length);
  const pageTx = transactions.slice(start, end);
  
  pageTx.forEach(tx => {
    const type = Number(tx.INCOME || 0) > 0 ? "Income" : "Expense";
    const amount = type === "Income" ? Number(tx.INCOME || 0) : Number(tx.EXPENSE || 0);
    const dateStr = tx.date ? formatDateDisplay(tx.date) : "No date";
    
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${dateStr}</td>
                    <td>${tx.ACCOUNT_HEADER || ""}</td>
                    <td>${type}</td>
                    <td>₹${amount.toFixed(2)}</td>
                    <td>${tx.notes || ""}</td>`;
    transactionsTable.appendChild(tr);
  });
  
  renderPagination(page, totalPages);
}

// Format date for display
function formatDateDisplay(date) {
  if (!date) return "";
  
  const d = new Date(date);
  return d.toLocaleDateString();
}

// Render pagination controls
function renderPagination(currentPage, totalPages) {
  paginationDiv.innerHTML = "";
  
  if (totalPages <= 1) return;
  
  // Previous button
  const prevBtn = document.createElement("button");
  prevBtn.innerHTML = "&laquo;";
  prevBtn.disabled = currentPage === 1;
  prevBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      showTransactions(currentBank);
    }
  });
  paginationDiv.appendChild(prevBtn);
  
  // Page buttons
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, startPage + 4);
  
  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement("button");
    pageBtn.textContent = i;
    pageBtn.disabled = i === currentPage;
    pageBtn.addEventListener("click", () => {
      currentPage = i;
      showTransactions(currentBank);
    });
    paginationDiv.appendChild(pageBtn);
  }
  
  // Next button
  const nextBtn = document.createElement("button");
  nextBtn.innerHTML = "&raquo;";
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.addEventListener("click", () => {
    if (currentPage < totalPages) {
      currentPage++;
      showTransactions(currentBank);
    }
  });
  paginationDiv.appendChild(nextBtn);
}
</script>

</body>
</html>
