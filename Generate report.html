<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Financial Reports</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
    }

    html,body { 
      height:100%; 
      background:#f4f6fb; 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:#222; 
    }

    .page {
      max-width:1200px;
      margin:36px auto;
      padding:22px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(4,1fr); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,#fff,#fbfdff);
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid rgba(20,20,20,0.02);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }

    /* info banner */
    .info-banner { padding:14px 22px; border-top:1px solid #f1f1f5; border-bottom:1px solid #f1f1f5; background:#f6fbff; color:#234; }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .report-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid rgba(20,20,20,0.03); 
      background:white; 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
    }
    .report-table table { margin:0; min-width: 1000px; }
    .report-table thead th { 
      background:transparent; 
      color:#6b6f77; 
      font-weight:600; 
      border-bottom:1px solid #eef0f4; 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
    }
    .report-table tbody td { padding:14px 16px; vertical-align:middle; border-bottom:1px solid #f2f4f7; }
    .report-table tbody tr:nth-child(even) td { background: #fbfcff; }

    .badge-income { color:#0f7a3a; font-weight:700; }
    .badge-expense { color:#c92a2a; font-weight:700; }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }

    /* Bank balances section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .bank-balance-item {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: #0f7a3a; }
    .negative-balance { color: #c92a2a; }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: #0f7a3a;
    }
    .expense-color {
      color: #c92a2a;
    }
    
    /* Report type selector */
    .report-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .report-type-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .report-type-btn.active {
      background: var(--purple-1);
      color: white;
      border-color: var(--purple-1);
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    /* Transaction details modal */
    .transaction-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .transaction-item:last-child {
      border-bottom: none;
    }
    
    /* Modal export buttons */
    .modal-export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Navigation buttons -->
    <div class="nav-buttons">
      <button id="backBtn" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left me-1"></i> Back
      </button>
      <button id="homeBtn" class="btn btn-outline-secondary">
        <i class="fa fa-home me-1"></i> Home
      </button>
      <button id="transactionBtn" class="btn btn-outline-info">
        <i class="fa fa-money-bill-wave me-1"></i> Transactions
      </button>
    </div>
    
    <div class="app-card">
      <!-- header -->
      <div class="tm-header">
        <h2><i class="fa fa-chart-bar"></i> Financial Reports</h2>
        <div class="header-actions">
          <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
            <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
            <div style="color:white; font-weight:600;" id="username">User</div>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
          </div>
        </div>
      </div>

      <!-- top cards -->
      <div class="top-cards" id="topCards">
        <div class="stat-card">
          <div class="stat-label">Total Income</div>
          <div id="statIncome" class="stat-value income-color">$0.00</div>
          <div class="small-muted"><i class="fa fa-arrow-up text-success"></i> 0.0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Expenses</div>
          <div id="statExpense" class="stat-value expense-color">$0.00</div>
          <div class="small-muted"><i class="fa fa-arrow-down text-danger"></i> 0.0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Current Balance</div>
          <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
          <div class="small-muted">
            <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Transactions</div>
          <div id="statCount" class="stat-value">0</div>
          <div class="small-muted">This period</div>
        </div>
      </div>
      
      <!-- Report type selector -->
      <div class="report-type-selector">
        <div class="report-type-btn active" data-report-type="bank">
          <i class="fa fa-university me-1"></i> Bank-wise Report
        </div>
        <div class="report-type-btn" data-report-type="category">
          <i class="fa fa-chart-pie me-1"></i> Category-wise Report
        </div>
        <div class="report-type-btn" data-report-type="monthly">
          <i class="fa fa-calendar me-1"></i> Monthly Summary
        </div>
      </div>
      
      <div class="info-banner">
        <i class="fa fa-info-circle me-2"></i> Generate detailed financial reports with filtering options.
      </div>
      
      <div class="content-body">
        <!-- Bank balances -->
        <div id="bankBalances" class="bank-balances">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- filters -->
        <div class="filters mb-2">
          <select id="dateFilter" class="form-select form-select-sm">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>

          <div id="customRangeControls" style="display:none; display:flex; gap:8px;">
            <input id="startDate" type="date" class="form-control form-control-sm" />
            <input id="endDate" type="date" class="form-control form-control-sm" />
          </div>

          <select id="typeFilter" class="form-select form-select-sm">
            <option value="all">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>

          <!-- Bank Filter -->
          <select id="bankFilter" class="form-select form-select-sm">
            <option value="all">All Banks</option>
            <!-- Will be populated dynamically -->
          </select>

          <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-filter me-1"></i> Apply Filters</button>
          <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
        </div>

        <!-- Report table -->
        <div class="report-table">
          <table class="table mb-0">
            <thead id="reportTableHeader">
              <tr>
                <th>Bank Name</th>
                <th style="text-align:right;">Total Income</th>
                <th style="text-align:right;">Total Expenses</th>
                <th style="text-align:right;">Net Balance</th>
                <th style="text-align:center;">Actions</th>
              </tr>
            </thead>
            <tbody id="reportTableBody">
              <tr><td colspan="5" class="text-center text-muted py-4">No data available. Apply filters to generate report.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Export buttons -->
        <div class="export-buttons">
          <button id="exportPDFBtn" class="btn btn-outline-danger">
            <i class="fa fa-file-pdf me-1"></i> Export PDF
          </button>
          <button id="exportExcelBtn" class="btn btn-outline-success">
            <i class="fa fa-file-excel me-1"></i> Export Excel
          </button>
          <button id="printReportBtn" class="btn btn-outline-primary">
            <i class="fa fa-print me-1"></i> Print Report
          </button>
        </div>

        <!-- pagination -->
        <div class="pagination-wrap mt-3" id="paginationControls"></div>
      </div>
    </div>
  </div>

  <!-- Transaction Details Modal -->
  <div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailsModalTitle">Transaction Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="transactionDetailsBody">
          <!-- Transaction details will be populated here -->
        </div>
        <div class="modal-footer">
          <div class="modal-export-buttons">
            <button id="modalExportPDFBtn" class="btn btn-outline-danger btn-sm">
              <i class="fa fa-file-pdf me-1"></i> Export PDF
            </button>
            <button id="modalExportExcelBtn" class="btn btn-outline-success btn-sm">
              <i class="fa fa-file-excel me-1"></i> Export Excel
            </button>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM refs
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const transactionBtn = document.getElementById("transactionBtn");
    const balanceToggle = document.getElementById("balanceToggle");

    // Filters
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");

    // Report elements
    const reportTableHeader = document.getElementById("reportTableHeader");
    const reportTableBody = document.getElementById("reportTableBody");
    const paginationControls = document.getElementById("paginationControls");
    const bankBalancesContainer = document.getElementById("bankBalances");
    const reportTypeButtons = document.querySelectorAll('.report-type-btn');
    
    // Export buttons
    const exportPDFBtn = document.getElementById("exportPDFBtn");
    const exportExcelBtn = document.getElementById("exportExcelBtn");
    const printReportBtn = document.getElementById("printReportBtn");

    // Modal elements
    const transactionDetailsModal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
    const detailsModalTitle = document.getElementById('detailsModalTitle');
    const transactionDetailsBody = document.getElementById('transactionDetailsBody');
    
    // Modal export buttons
    const modalExportPDFBtn = document.getElementById("modalExportPDFBtn");
    const modalExportExcelBtn = document.getElementById("modalExportExcelBtn");

    // Stats
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");

    // State
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let coaAccounts = [];
    let coaBanks = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let balanceVisible = false;
    let currentReportType = 'bank';
    let currentModalTransactions = []; // Store transactions shown in modal

    // Navigation button handlers
    backBtn.addEventListener("click", () => {
      window.history.back();
    });
    
    homeBtn.addEventListener("click", () => {
      window.location.href = "home.html";
    });
    
    transactionBtn.addEventListener("click", () => {
      window.location.href = "transactions.html";
    });

    // Report type selector
    reportTypeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        reportTypeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentReportType = btn.getAttribute('data-report-type');
        generateReport();
      });
    });

    // Auth handling
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        await loadCOAData();
        await loadTransactions();
      } else {
        // not logged in
        Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // Balance visibility toggle
    balanceToggle.addEventListener("click", () => {
      balanceVisible = !balanceVisible;
      updateBalanceVisibility();
    });

    // Date filter change
    dateFilter.addEventListener("change", () => {
      if (dateFilter.value === "custom") {
        customRangeControls.style.display = "flex";
      } else {
        customRangeControls.style.display = "none";
      }
    });

    // Apply filters
    applyFiltersBtn.addEventListener("click", () => { 
      applyFilters(); 
    });
    
    // Reset filters
    resetFiltersBtn.addEventListener("click", () => {
      dateFilter.value = "all";
      typeFilter.value = "all";
      bankFilter.value = "all";
      startDateInput.value = "";
      endDateInput.value = "";
      customRangeControls.style.display = "none";
      applyFilters();
    });

    // Export buttons
    exportPDFBtn.addEventListener("click", () => {
      exportToPDF();
    });
    
    exportExcelBtn.addEventListener("click", () => {
      exportToExcel();
    });
    
    printReportBtn.addEventListener("click", () => {
      window.print();
    });
    
    // Modal export buttons
    modalExportPDFBtn.addEventListener("click", () => {
      exportModalToPDF();
    });
    
    modalExportExcelBtn.addEventListener("click", () => {
      exportModalToExcel();
    });

    // Load COA data
    async function loadCOAData() {
      try {
        if (!currentUser) return;
        
        // Get account headers from chartOfAccounts collection
        const accountsQuery = query(
  collection(db, "users", currentUser.uid, "chartOfAccounts"), 
  where("type", "in", ["Asset", "Liability", "Equity", "Income", "Expense", "COGS", "OtherIncome", "OtherExpense"])
);
        const accountsSnapshot = await getDocs(accountsQuery);
        coaAccounts = accountsSnapshot.docs.map(doc => doc.data().name);
        
        // Get bank accounts from chartOfAccounts collection
        const banksQuery = query(
  collection(db, "users", currentUser.uid, "chartOfAccounts"), 
  where("category", "in", ["Bank", "Cash"])
);
        
        // If no accounts found, set default accounts
        if (coaAccounts.length === 0) {
          coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM"];
        }
        
        if (coaBanks.length === 0) {
          coaBanks = ["AXIS", "BOM"];
        }
        
        // Populate the bank filter dropdown
        populateBankFilter();
        
      } catch (error) {
        console.warn('Error loading COA data:', error.message);
        // Use default accounts if COA is not available
        coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM"];
        coaBanks = ["AXIS", "BOM"];
        populateBankFilter();
      }
    }
    
    function populateBankFilter() {
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      
      // Add bank names to filter
      coaBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        bankFilter.appendChild(option);
      });
    }

    // Load transactions
    async function loadTransactions() {
      try {
        reportTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 small-muted">Loading transactions...</td></tr>`;
        const q = query(collection(db, "users", currentUser.uid, "transactions"), orderBy("DATE", "desc"));
        const snap = await getDocs(q);
        const txs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        allTransactions = txs;
        filteredTransactions = allTransactions.slice();
        applyFilters();
      } catch (err) {
        console.error("loadTransactions", err);
        reportTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Failed to load transactions</td></tr>`;
      }
    }

    // Apply filters
    function applyFilters() {
      filteredTransactions = allTransactions.slice();
      const now = new Date();

      function inRange(dateStr, start, end) {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        return d >= start && d <= end;
      }

      // Date filter
      if (dateFilter.value !== "all") {
        let start, end;
        switch (dateFilter.value) {
          case "today":
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "week":
            const day = now.getDay();
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
            break;
          case "month":
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
          case "year":
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear() + 1, 0, 1);
            break;
          case "custom":
            if (startDateInput.value && endDateInput.value) {
              start = new Date(startDateInput.value);
              end = new Date(endDateInput.value);
              end.setDate(end.getDate() + 1); // include end date
            }
            break;
        }
        if (start && end) {
          filteredTransactions = filteredTransactions.filter(t => inRange(t.DATE, start, end));
        }
      }

      // Type filter
      if (typeFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
      }

      // Bank filter
      if (bankFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          (t.BANK_NAME || t.MODE || "") === bankFilter.value
        );
      }

      currentPage = 1;
      generateReport();
      updateStats();
      updateBankBalances();
    }

    // Generate report based on current report type
    function generateReport() {
      switch (currentReportType) {
        case 'bank':
          generateBankReport();
          break;
        case 'category':
          generateCategoryReport();
          break;
        case 'monthly':
          generateMonthlyReport();
          break;
        default:
          generateBankReport();
      }
    }

    // Generate bank-wise report
    function generateBankReport() {
      // Update table headers
      reportTableHeader.innerHTML = `
        <tr>
          <th>Bank Name</th>
          <th style="text-align:right;">Total Income</th>
          <th style="text-align:right;">Total Expenses</th>
          <th style="text-align:right;">Net Balance</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      `;

      // Calculate bank totals
      const bankTotals = {};
      
      // Initialize all known banks
      coaBanks.forEach(bank => {
        bankTotals[bank] = {
          income: 0,
          expense: 0,
          balance: 0
        };
      });
      
      // Calculate totals from filtered transactions
      filteredTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME || tx.MODE || "Unknown";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        
        if (!bankTotals[bankName]) {
          bankTotals[bankName] = {
            income: 0,
            expense: 0,
            balance: 0
          };
        }
        
        bankTotals[bankName].income += income;
        bankTotals[bankName].expense += expense;
        bankTotals[bankName].balance += (income - expense);
      });
      
      // Generate table rows
      let html = "";
      Object.entries(bankTotals).forEach(([bankName, data]) => {
        if (data.income === 0 && data.expense === 0) return; // Skip banks with no transactions
        
        html += `
          <tr>
            <td>${escapeHtml(bankName)}</td>
            <td style="text-align:right;" class="income-color">$${data.income.toFixed(2)}</td>
            <td style="text-align:right;" class="expense-color">$${data.expense.toFixed(2)}</td>
            <td style="text-align:right;" class="${data.balance >= 0 ? 'income-color' : 'expense-color'}">$${data.balance.toFixed(2)}</td>
            <td style="text-align:center;">
              <button class="btn btn-sm btn-outline-primary view-bank-details" data-bank="${escapeHtml(bankName)}">
                <i class="fa fa-eye me-1"></i> Details
              </button>
            </td>
          </tr>
        `;
      });
      
      if (html === "") {
        html = `<tr><td colspan="5" class="text-center text-muted py-4">No data available for the selected filters.</td></tr>`;
      }
      
      reportTableBody.innerHTML = html;
      
      // Add event listeners to view details buttons
      document.querySelectorAll(".view-bank-details").forEach(btn => {
        btn.addEventListener("click", e => {
          const bankName = e.currentTarget.getAttribute("data-bank");
          viewBankDetails(bankName);
        });
      });
      
      buildPagination();
    }

    // Generate category-wise report
    function generateCategoryReport() {
      // Update table headers
      reportTableHeader.innerHTML = `
        <tr>
          <th>Category</th>
          <th style="text-align:right;">Total Income</th>
          <th style="text-align:right;">Total Expenses</th>
          <th style="text-align:right;">Net Balance</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      `;

      // Calculate category totals
      const categoryTotals = {};
      
      // Calculate totals from filtered transactions
      filteredTransactions.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || "Uncategorized";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        
        if (!categoryTotals[category]) {
          categoryTotals[category] = {
            income: 0,
            expense: 0,
            balance: 0
          };
        }
        
        categoryTotals[category].income += income;
        categoryTotals[category].expense += expense;
        categoryTotals[category].balance += (income - expense);
      });
      
      // Generate table rows
      let html = "";
      Object.entries(categoryTotals).forEach(([category, data]) => {
        html += `
          <tr>
            <td>${escapeHtml(category)}</td>
            <td style="text-align:right;" class="income-color">$${data.income.toFixed(2)}</td>
            <td style="text-align:right;" class="expense-color">$${data.expense.toFixed(2)}</td>
            <td style="text-align:right;" class="${data.balance >= 0 ? 'income-color' : 'expense-color'}">$${data.balance.toFixed(2)}</td>
            <td style="text-align:center;">
              <button class="btn btn-sm btn-outline-primary view-category-details" data-category="${escapeHtml(category)}">
                <i class="fa fa-eye me-1"></i> Details
              </button>
            </td>
          </tr>
        `;
      });
      
      if (html === "") {
        html = `<tr><td colspan="5" class="text-center text-muted py-4">No data available for the selected filters.</td></tr>`;
      }
      
      reportTableBody.innerHTML = html;
      
      // Add event listeners to view details buttons
      document.querySelectorAll(".view-category-details").forEach(btn => {
        btn.addEventListener("click", e => {
          const category = e.currentTarget.getAttribute("data-category");
          viewCategoryDetails(category);
        });
      });
      
      buildPagination();
    }

    // Generate monthly report
    function generateMonthlyReport() {
      // Update table headers
      reportTableHeader.innerHTML = `
        <tr>
          <th>Month</th>
          <th style="text-align:right;">Total Income</th>
          <th style="text-align:right;">Total Expenses</th>
          <th style="text-align:right;">Net Balance</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      `;

      // Calculate monthly totals
      const monthlyTotals = {};
      
      // Calculate totals from filtered transactions
      filteredTransactions.forEach(tx => {
        if (!tx.DATE) return;
        
        const date = new Date(tx.DATE);
        const monthYear = `${date.toLocaleString('default', { month: 'long' })} ${date.getFullYear()}`;
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        
        if (!monthlyTotals[monthYear]) {
          monthlyTotals[monthYear] = {
            income: 0,
            expense: 0,
            balance: 0
          };
        }
        
        monthlyTotals[monthYear].income += income;
        monthlyTotals[monthYear].expense += expense;
        monthlyTotals[monthYear].balance += (income - expense);
      });
      
      // Generate table rows
      let html = "";
      Object.entries(monthlyTotals).forEach(([monthYear, data]) => {
        html += `
          <tr>
            <td>${escapeHtml(monthYear)}</td>
            <td style="text-align:right;" class="income-color">$${data.income.toFixed(2)}</td>
            <td style="text-align:right;" class="expense-color">$${data.expense.toFixed(2)}</td>
            <td style="text-align:right;" class="${data.balance >= 0 ? 'income-color' : 'expense-color'}">$${data.balance.toFixed(2)}</td>
            <td style="text-align:center;">
              <button class="btn btn-sm btn-outline-primary view-month-details" data-month="${escapeHtml(monthYear)}">
                <i class="fa fa-eye me-1"></i> Details
              </button>
            </td>
          </tr>
        `;
      });
      
      if (html === "") {
        html = `<tr><td colspan="5" class="text-center text-muted py-4">No data available for the selected filters.</td></tr>`;
      }
      
      reportTableBody.innerHTML = html;
      
      // Add event listeners to view details buttons
      document.querySelectorAll(".view-month-details").forEach(btn => {
        btn.addEventListener("click", e => {
          const monthYear = e.currentTarget.getAttribute("data-month");
          viewMonthDetails(monthYear);
        });
      });
      
      buildPagination();
    }

    // View bank details
    function viewBankDetails(bankName) {
      currentModalTransactions = filteredTransactions.filter(tx => 
        (tx.BANK_NAME || tx.MODE || "") === bankName
      );
      
      showTransactionDetails(currentModalTransactions, `Transactions for ${bankName}`);
    }

    // View category details
    function viewCategoryDetails(category) {
      currentModalTransactions = filteredTransactions.filter(tx => 
        (tx.ACCOUNT_HEADER || "") === category
      );
      
      showTransactionDetails(currentModalTransactions, `Transactions for ${category}`);
    }

    // View month details
    function viewMonthDetails(monthYear) {
      const [month, year] = monthYear.split(' ');
      currentModalTransactions = filteredTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const date = new Date(tx.DATE);
        return date.toLocaleString('default', { month: 'long' }) === month && 
               date.getFullYear().toString() === year;
      });
      
      showTransactionDetails(currentModalTransactions, `Transactions for ${monthYear}`);
    }

    // Show transaction details in modal
    function showTransactionDetails(transactions, title) {
      detailsModalTitle.textContent = title;
      
      if (transactions.length === 0) {
        transactionDetailsBody.innerHTML = '<p class="text-center text-muted">No transactions found.</p>';
      } else {
        let html = '';
        transactions.forEach(tx => {
          const amount = parseFloat(tx.INCOME) || parseFloat(tx.EXPENSE) || 0;
          const type = tx.INCOME ? 'income' : 'expense';
          
          html += `
            <div class="transaction-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${escapeHtml(tx.DESCRIPTION || 'No description')}</strong>
                  <div class="small text-muted">${formatDate(tx.DATE)}</div>
                </div>
                <div class="text-end">
                  <div class="${type === 'income' ? 'income-color' : 'expense-color'} fw-bold">
                    ${type === 'income' ? '+' : '-'}$${amount.toFixed(2)}
                  </div>
                  <div class="small text-muted">${escapeHtml(tx.BANK_NAME || tx.MODE || '')}</div>
                </div>
              </div>
            </div>
          `;
        });
        transactionDetailsBody.innerHTML = html;
      }
      
      transactionDetailsModal.show();
    }

    // Export modal transactions to PDF
    function exportModalToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text(detailsModalTitle.textContent, 14, 22);
      
      // Add date
      doc.setFontSize(12);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
      
      // Add summary
      const totalIncome = currentModalTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = currentModalTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      doc.text(`Total Income: $${totalIncome.toFixed(2)}`, 14, 40);
      doc.text(`Total Expenses: $${totalExpense.toFixed(2)}`, 14, 48);
      doc.text(`Net Balance: $${balance.toFixed(2)}`, 14, 56);
      doc.text(`Total Transactions: ${currentModalTransactions.length}`, 14, 64);
      
      // Prepare table data
      const tableColumn = [['Date', 'Description', 'Bank', 'Type', 'Amount']];
      const tableRows = [];
      
      currentModalTransactions.forEach(tx => {
        const date = formatDate(tx.DATE);
        const description = tx.DESCRIPTION || 'No description';
        const bank = tx.BANK_NAME || tx.MODE || '';
        const type = tx.INCOME ? 'Income' : 'Expense';
        const amount = parseFloat(tx.INCOME) || parseFloat(tx.EXPENSE) || 0;
        
        tableRows.push([date, description, bank, type, `$${amount.toFixed(2)}`]);
      });
      
      // Add table to PDF
      doc.autoTable({
        head: tableColumn,
        body: tableRows,
        startY: 75,
        theme: 'grid',
        styles: { fontSize: 10 },
        headStyles: { fillColor: [111, 66, 193] } // Purple color
      });
      
      // Save the PDF
      doc.save(`${detailsModalTitle.textContent.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0, 10)}.pdf`);
    }
    
    // Export modal transactions to Excel
    function exportModalToExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Prepare data
      const data = [
        ['Date', 'Description', 'Bank', 'Type', 'Amount']
      ];
      
      currentModalTransactions.forEach(tx => {
        const date = formatDate(tx.DATE);
        const description = tx.DESCRIPTION || 'No description';
        const bank = tx.BANK_NAME || tx.MODE || '';
        const type = tx.INCOME ? 'Income' : 'Expense';
        const amount = parseFloat(tx.INCOME) || parseFloat(tx.EXPENSE) || 0;
        
        data.push([date, description, bank, type, amount]);
      });
      
      // Add summary data
      const totalIncome = currentModalTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = currentModalTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      data.push([]);
      data.push(['Summary', '', '', '', '']);
      data.push(['Total Income', '', '', '', totalIncome]);
      data.push(['Total Expenses', '', '', '', totalExpense]);
      data.push(['Net Balance', '', '', '', balance]);
      data.push(['Total Transactions', '', '', '', currentModalTransactions.length]);
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Transaction Details");
      
      // Generate Excel file and trigger download
      XLSX.writeFile(wb, `${detailsModalTitle.textContent.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // Build pagination
    function buildPagination() {
      // For reports, we don't need pagination as the number of rows is limited
      paginationControls.innerHTML = "";
    }

    // Update stats
    function updateStats() {
      const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      statIncome.textContent = `$${totalIncome.toFixed(2)}`;
      statExpense.textContent = `$${totalExpense.toFixed(2)}`;
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
      statCount.textContent = filteredTransactions.length;
      
      // Apply color coding
      statIncome.className = "stat-value income-color";
      statExpense.className = "stat-value expense-color";
    }

    // Calculate bank balances
    function calculateBankBalances() {
      const bankBalances = {};
      
      // Initialize all known banks with 0 balance
      coaBanks.forEach(bank => {
        bankBalances[bank] = 0;
      });
      
      // Calculate balances based on transactions
      filteredTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME || tx.MODE || "";
        if (bankName && coaBanks.includes(bankName)) {
          const income = parseFloat(tx.INCOME) || 0;
          const expense = parseFloat(tx.EXPENSE) || 0;
          bankBalances[bankName] += (income - expense);
        }
      });
      
      return bankBalances;
    }
    
    // Update bank balances display
    function updateBankBalances() {
      const bankBalances = calculateBankBalances();
      
      bankBalancesContainer.innerHTML = "";
      
      // Add bank balances
      Object.entries(bankBalances).forEach(([bankName, balance]) => {
        const bankItem = document.createElement("div");
        bankItem.className = "bank-balance-item";
        bankItem.innerHTML = `
          <div class="bank-balance-name">${escapeHtml(bankName)}</div>
          <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? `$${balance.toFixed(2)}` : '••••'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(bankItem);
        
        // Add event listener to the bank balance toggle
        bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
          balanceVisible = !balanceVisible;
          updateBalanceVisibility();
        });
      });
    }
    
    // Update balance visibility across the app
    function updateBalanceVisibility() {
      // Update main balance
      const totalIncome = filteredTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
      const totalExpense = filteredTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
      const balance = totalIncome - totalExpense;
      
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
      statBalance.classList.toggle('balance-hidden', !balanceVisible);
      
      // Update toggle button icon
      balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
      
      // Update bank balances
      updateBankBalances();
    }
    
    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text('Financial Report', 14, 22);
      
      // Add date
      doc.setFontSize(12);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
      
      // Add summary
      const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      doc.text(`Total Income: $${totalIncome.toFixed(2)}`, 14, 40);
      doc.text(`Total Expenses: $${totalExpense.toFixed(2)}`, 14, 48);
      doc.text(`Net Balance: $${balance.toFixed(2)}`, 14, 56);
      
      // Add table
      const tableColumn = [];
      const tableRows = [];
      
      // Determine columns based on report type
      switch(currentReportType) {
        case 'bank':
          tableColumn.push(['Bank Name', 'Income', 'Expenses', 'Balance']);
          
          const bankTotals = {};
          coaBanks.forEach(bank => {
            bankTotals[bank] = { income: 0, expense: 0, balance: 0 };
          });
          
          filteredTransactions.forEach(tx => {
            const bankName = tx.BANK_NAME || tx.MODE || "Unknown";
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!bankTotals[bankName]) {
              bankTotals[bankName] = { income: 0, expense: 0, balance: 0 };
            }
            
            bankTotals[bankName].income += income;
            bankTotals[bankName].expense += expense;
            bankTotals[bankName].balance += (income - expense);
          });
          
          Object.entries(bankTotals).forEach(([bankName, data]) => {
            if (data.income !== 0 || data.expense !== 0) {
              tableRows.push([bankName, `$${data.income.toFixed(2)}`, `$${data.expense.toFixed(2)}`, `$${data.balance.toFixed(2)}`]);
            }
          });
          break;
          
        case 'category':
          tableColumn.push(['Category', 'Income', 'Expenses', 'Balance']);
          
          const categoryTotals = {};
          filteredTransactions.forEach(tx => {
            const category = tx.ACCOUNT_HEADER || "Uncategorized";
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!categoryTotals[category]) {
              categoryTotals[category] = { income: 0, expense: 0, balance: 0 };
            }
            
            categoryTotals[category].income += income;
            categoryTotals[category].expense += expense;
            categoryTotals[category].balance += (income - expense);
          });
          
          Object.entries(categoryTotals).forEach(([category, data]) => {
            tableRows.push([category, `$${data.income.toFixed(2)}`, `$${data.expense.toFixed(2)}`, `$${data.balance.toFixed(2)}`]);
          });
          break;
          
        case 'monthly':
          tableColumn.push(['Month', 'Income', 'Expenses', 'Balance']);
          
          const monthlyTotals = {};
          filteredTransactions.forEach(tx => {
            if (!tx.DATE) return;
            const date = new Date(tx.DATE);
            const monthYear = `${date.toLocaleString('default', { month: 'long' })} ${date.getFullYear()}`;
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!monthlyTotals[monthYear]) {
              monthlyTotals[monthYear] = { income: 0, expense: 0, balance: 0 };
            }
            
            monthlyTotals[monthYear].income += income;
            monthlyTotals[monthYear].expense += expense;
            monthlyTotals[monthYear].balance += (income - expense);
          });
          
          Object.entries(monthlyTotals).forEach(([monthYear, data]) => {
            tableRows.push([monthYear, `$${data.income.toFixed(2)}`, `$${data.expense.toFixed(2)}`, `$${data.balance.toFixed(2)}`]);
          });
          break;
      }
      
      // Add table to PDF
      doc.autoTable({
        head: tableColumn,
        body: tableRows,
        startY: 65,
        theme: 'grid',
        styles: { fontSize: 10 },
        headStyles: { fillColor: [111, 66, 193] } // Purple color
      });
      
      // Save the PDF
      doc.save(`financial-report-${new Date().toISOString().slice(0, 10)}.pdf`);
    }
    
    // Export to Excel
    function exportToExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Prepare data based on report type
      let data = [];
      
      switch(currentReportType) {
        case 'bank':
          data.push(['Bank Name', 'Income', 'Expenses', 'Balance']);
          
          const bankTotals = {};
          coaBanks.forEach(bank => {
            bankTotals[bank] = { income: 0, expense: 0, balance: 0 };
          });
          
          filteredTransactions.forEach(tx => {
            const bankName = tx.BANK_NAME || tx.MODE || "Unknown";
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!bankTotals[bankName]) {
              bankTotals[bankName] = { income: 0, expense: 0, balance: 0 };
            }
            
            bankTotals[bankName].income += income;
            bankTotals[bankName].expense += expense;
            bankTotals[bankName].balance += (income - expense);
          });
          
          Object.entries(bankTotals).forEach(([bankName, totals]) => {
            if (totals.income !== 0 || totals.expense !== 0) {
              data.push([bankName, totals.income, totals.expense, totals.balance]);
            }
          });
          break;
          
        case 'category':
          data.push(['Category', 'Income', 'Expenses', 'Balance']);
          
          const categoryTotals = {};
          filteredTransactions.forEach(tx => {
            const category = tx.ACCOUNT_HEADER || "Uncategorized";
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!categoryTotals[category]) {
              categoryTotals[category] = { income: 0, expense: 0, balance: 0 };
            }
            
            categoryTotals[category].income += income;
            categoryTotals[category].expense += expense;
            categoryTotals[category].balance += (income - expense);
          });
          
          Object.entries(categoryTotals).forEach(([category, totals]) => {
            data.push([category, totals.income, totals.expense, totals.balance]);
          });
          break;
          
        case 'monthly':
          data.push(['Month', 'Income', 'Expenses', 'Balance']);
          
          const monthlyTotals = {};
          filteredTransactions.forEach(tx => {
            if (!tx.DATE) return;
            const date = new Date(tx.DATE);
            const monthYear = `${date.toLocaleString('default', { month: 'long' })} ${date.getFullYear()}`;
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            
            if (!monthlyTotals[monthYear]) {
              monthlyTotals[monthYear] = { income: 0, expense: 0, balance: 0 };
            }
            
            monthlyTotals[monthYear].income += income;
            monthlyTotals[monthYear].expense += expense;
            monthlyTotals[monthYear].balance += (income - expense);
          });
          
          Object.entries(monthlyTotals).forEach(([monthYear, totals]) => {
            data.push([monthYear, totals.income, totals.expense, totals.balance]);
          });
          break;
      }
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Financial Report");
      
      // Generate Excel file and trigger download
      XLSX.writeFile(wb, `financial-report-${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return "N/A";
      const date = new Date(dateString);
      return date.toLocaleDateString();
    }
    
    // Initialize with balance hidden
    updateBalanceVisibility();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>