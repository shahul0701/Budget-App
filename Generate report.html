<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body{font-family:Arial,sans-serif;background:#f7f7f7;margin:0;padding:0}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.header-left{font-weight:bold}
.header-right{display:flex;align-items:center;gap:10px}
#userInitials{background:#007bff;color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:bold}
#username{font-weight:bold}
#logoutBtn{background:#dc3545;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer}
#logoutBtn:hover{background:#a71d2a}
.container{max-width:1200px;margin:30px auto;background:#fff;padding:30px;border-radius:8px}
h2{text-align:center;margin-bottom:10px}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{padding:12px;border:1px solid #ccc;text-align:left}
th{background:#f1f1f1}
button{background:#28a745;color:#fff;padding:8px 16px;border:none;border-radius:5px;cursor:pointer}
button:hover{background:#218838}
input[type=date]{padding:6px;border-radius:4px;border:1px solid #ccc}
.pointer{cursor:pointer}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none;color:#007bff;font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left:20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
<h2>General Report (Bank-wise)</h2>

<div style="margin-bottom:15px;">
  <label>From: <input type="date" id="fromDate"></label>
  <label style="margin-left:10px;">To: <input type="date" id="toDate"></label>
</div>

<table>
  <thead>
    <tr>
      <th>Bank Name</th>
      <th>Type</th>
      <th>Total Transactions</th>
    </tr>
  </thead>
  <tbody id="reportTable"></tbody>
</table>

<h3 id="transactionsTitle" style="margin-top:30px;"></h3>
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Account</th>
      <th>Amount</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody id="transactionsTable"></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const usernameElem = document.getElementById("username");
const profileCircle = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const datetimeElem = document.getElementById("datetime");
const reportTable = document.getElementById("reportTable");
const transactionsTable = document.getElementById("transactionsTable");
const transactionsTitle = document.getElementById("transactionsTitle");
const fromDateInput = document.getElementById("fromDate");
const toDateInput = document.getElementById("toDate");

let currentUser = null;
let transactions = [];
let coaAccounts = [];

// Clock
function updateTime(){datetimeElem.textContent=(new Date()).toLocaleString();}
setInterval(updateTime,1000);updateTime();

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    const storedUsername = user.displayName || user.email;
    usernameElem.textContent=storedUsername;
    profileCircle.textContent=storedUsername.charAt(0).toUpperCase();
    loadReport();
  }else{
    setTimeout(()=>window.location.href="index.html",500);
  }
});

logoutBtn.addEventListener("click", async()=>{await signOut(auth);window.location.href="index.html";});

async function loadReport(){
  try{
    // Load CoA accounts (Bank type)
    const coaSnap = await getDocs(collection(db,"chartOfAccounts"));
    coaAccounts = coaSnap.docs.filter(d=>d.data().userId===currentUser.uid && d.data().type==="Asset" && ["Bank","Cash"].includes(d.data().category)).map(d=>({id:d.id,...d.data()}));

    // Load transactions
    const txSnap = await getDocs(collection(db,"users",currentUser.uid,"transactions"));
    transactions = txSnap.docs.map(d=>({id:d.id,...d.data()}));

    renderReport();
  }catch(err){console.error(err); alert("Failed to load report: "+err.message);}
}

function renderReport(){
  reportTable.innerHTML="";
  const bankTotals={};

  coaAccounts.forEach(acc=>{bankTotals[acc.name]=0;});

  transactions.forEach(tx=>{
    const acc = coaAccounts.find(a=>a.id===tx.accountId || a.name===tx.ACCOUNT_HEADER);
    if(acc){
      const amt = Number(tx.amount || tx.INCOME || tx.EXPENSE || 0);
      bankTotals[acc.name]+=amt;
    }
  });

  for(const bank in bankTotals){
    const tr=document.createElement("tr");
    tr.classList.add("pointer");
    tr.innerHTML=`<td>${bank}</td><td>Bank</td><td>₹${bankTotals[bank].toFixed(2)}</td>`;
    tr.addEventListener("click",()=>showTransactions(bank));
    reportTable.appendChild(tr);
  }
}

function showTransactions(bankName){
  transactionsTitle.textContent=`Transactions for ${bankName}`;
  transactionsTable.innerHTML="";

  const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
  const toDate = toDateInput.value ? new Date(toDateInput.value) : null;

  const filteredTx = transactions.filter(tx=>{
    const acc = coaAccounts.find(a=>a.id===tx.accountId || a.name===tx.ACCOUNT_HEADER);
    if(!acc || acc.name!==bankName) return false;

    if(fromDate || toDate){
      const txDate = new Date(tx.date || tx.transactionDate || tx.createdAt?.seconds*1000);
      if(fromDate && txDate<fromDate) return false;
      if(toDate && txDate>toDate) return false;
    }
    return true;
  });

  filteredTx.forEach(tx=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${tx.date||tx.transactionDate||""}</td><td>${tx.ACCOUNT_HEADER||""}</td><td>₹${Number(tx.amount||0).toFixed(2)}</td><td>${tx.notes||""}</td>`;
    transactionsTable.appendChild(tr);
  });
}
  // ===== Load Transactions from Firebase =====
async function loadTransactions(startDate, endDate) {
    loadingModal.style.display = "flex";
    try {
        // Query all transactions for the current user, ordered by DATE
        const txRef = collection(db, "users", currentUser.uid, "transactions");
        const q = query(txRef, orderBy("DATE", "desc"));
        const snap = await getDocs(q);

        // Map and filter by date range
        allTransactions = snap.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id,
                DATE: data.DATE,
                ACCOUNT_HEADER: data.ACCOUNT_HEADER,
                INCOME: parseFloat(data.INCOME) || 0,
                EXPENSE: parseFloat(data.EXPENSE) || 0,
                NOTES: data.NOTES || ""
            };
        }).filter(tx => {
            const txDate = new Date(tx.DATE);
            return txDate >= startDate && txDate <= endDate;
        });

        return allTransactions;
    } catch (err) {
        console.error("Error loading transactions:", err);
        alert("Failed to load transactions: " + err.message);
        return [];
    } finally {
        loadingModal.style.display = "none";
    }
}

  async function generateReport() {
    const { startDate, endDate } = getDateRange();
    reportPeriodDisplay.textContent = `Report: ${formatDisplay(startDate)} to ${formatDisplay(endDate)}`;

    // Load transactions dynamically from Firebase
    const transactions = await loadTransactions(startDate, endDate);

    if (transactions.length === 0) {
        resetReport();
        return;
    }

    // Total Income & Expenses
    const totalIncome = transactions.reduce((sum, tx) => sum + (tx.INCOME || 0), 0);
    const totalExpenses = transactions.reduce((sum, tx) => sum + (tx.EXPENSE || 0), 0);
    const netProfit = totalIncome - totalExpenses;

    totalIncomeElem.textContent = `₹${totalIncome.toFixed(2)}`;
    totalExpensesElem.textContent = `₹${totalExpenses.toFixed(2)}`;
    netProfitElem.textContent = `₹${netProfit.toFixed(2)}`;
    netProfitElem.style.color = netProfit > 0 ? "#2ecc71" : netProfit < 0 ? "#e74c3c" : "#3498db";

    // Breakdown by category
    updateBreakdown(transactions, "INCOME", incomeBreakdownElem);
    updateBreakdown(transactions, "EXPENSE", expenseBreakdownElem);

    // Update Chart
    updateChart(transactions);
}


// Reload transactions when date filter changes
fromDateInput.addEventListener("change",()=>{const firstBank = reportTable.querySelector("tr")?.children[0].textContent; if(firstBank) showTransactions(firstBank);});
toDateInput.addEventListener("change",()=>{const firstBank = reportTable.querySelector("tr")?.children[0].textContent; if(firstBank) showTransactions(firstBank);});
</script>

</body>
</html>
