<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --muted: #64748b;
            --border: #e2e8f0;
            --card-bg: #ffffff;
            --sidebar-bg: #f1f5f9;
            --gradient-primary: linear-gradient(135deg, #6366f1, #8b5cf6);
            --gradient-secondary: linear-gradient(135deg, #06b6d4, #3b82f6);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .logo i {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 700px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .sidebar {
            background: var(--sidebar-bg);
            padding: 25px;
            border-right: 1px solid var(--border);
        }
        
        .vehicle-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .vehicle-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .vehicle-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .vehicle-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eff6ff, #f0f9ff);
        }
        
        .vehicle-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: white;
            font-size: 1.2rem;
        }
        
        .vehicle-info {
            flex: 1;
        }
        
        .vehicle-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .vehicle-info p {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .vehicle-actions {
            display: flex;
            gap: 8px;
        }
        
        .add-vehicle-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-success);
            color: white;
            border: none;
            border-radius: 12px;
            margin-top: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .add-vehicle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
        }
        
        .content-area {
            padding: 25px;
            background: white;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .stat-card:nth-child(2)::before { background: var(--gradient-success); }
        .stat-card:nth-child(3)::before { background: var(--gradient-secondary); }
        .stat-card:nth-child(4)::before { background: var(--gradient-warning); }
        .stat-card:nth-child(5)::before { background: var(--info); }
        .stat-card:nth-child(6)::before { background: var(--danger); }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            font-size: 0.95rem;
            color: var(--muted);
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-card .unit {
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 500;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: var(--sidebar-bg);
            padding: 10px;
            border-radius: 12px;
        }
        
        .tab {
            padding: 12px 20px;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--muted);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .tab:hover:not(.active) {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        .expense-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            background: var(--sidebar-bg);
            padding: 25px;
            border-radius: 16px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .input-group input, .input-group select, .input-group textarea {
            padding: 14px;
            border-radius: 10px;
            border: 2px solid var(--border);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-secondary {
            background: var(--sidebar-bg);
            color: var(--dark);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .history-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background: #f8fafc;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.1);
        }
        
        .delete-btn {
            color: var(--danger);
        }
        
        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: var(--sidebar-bg);
            color: var(--muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
        }
        
        .no-vehicle {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }
        
        .no-vehicle i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--border);
            opacity: 0.5;
        }
        
        .chart-container {
            height: 350px;
            background: white;
            border-radius: 16px;
            margin: 25px 0;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        
        .report-section {
            margin: 25px 0;
            padding: 20px;
            background: var(--sidebar-bg);
            border-radius: 16px;
        }
        
        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .report-controls .input-group {
            margin-bottom: 0;
        }
        
        .report-controls select, .report-controls input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: white;
        }
        
        .report-results {
            margin-top: 25px;
        }
        
        .login-prompt {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }
        
        .login-prompt i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--border);
            opacity: 0.5;
        }

        .service-reminder {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            border-left: 5px solid;
        }
        
        .service-reminder i {
            font-size: 1.5rem;
        }
        
        .service-reminder.green {
            background-color: #d1fae5;
            color: #065f46;
            border-left-color: #10b981;
        }
        
        .service-reminder.light-green {
            background-color: #ecfdf5;
            color: #047857;
            border-left-color: #34d399;
        }
        
        .service-reminder.yellow {
            background-color: #fef3c7;
            color: #92400e;
            border-left-color: #f59e0b;
        }
        
        .service-reminder.orange {
            background-color: #ffedd5;
            color: #9a3412;
            border-left-color: #f97316;
        }
        
        .service-reminder.red {
            background-color: #fee2e2;
            color: #991b1b;
            border-left-color: #ef4444;
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .summary-card h4 {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .summary-card .unit {
            font-size: 0.8rem;
            color: var(--muted);
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .report-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
        }
        
        .report-table tr:hover {
            background: #f8fafc;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }
        
        .loading i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: translateX(150%);
            transition: transform 0.4s ease;
            backdrop-filter: blur(10px);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--gradient-success);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.info {
            background: var(--gradient-secondary);
        }
        
        .notification.warning {
            background: var(--gradient-warning);
        }
        
        .filter-section {
            background: var(--sidebar-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 25px;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-controls .input-group {
            margin-bottom: 0;
        }
        
        .filter-controls select, .filter-controls input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: white;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .summary-item .label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 5px;
        }
        
        .summary-item .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .mileage-graph-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .mileage-graph-controls button {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .mileage-graph-controls button.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
        }
        
        .mileage-graph-controls button:hover:not(.active) {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-car"></i>
                <span>Vehicle Manager Pro</span>
            </div>
            <div class="auth-section" id="auth-section">
                <div id="user-info" class="user-info" style="display: none;">
                    <span id="user-name"></span>
                    <button id="sign-out-btn" class="auth-btn">Sign Out</button>
                </div>
                <div id="auth-buttons">
                    <button id="sign-in-btn" class="auth-btn">Sign In</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <h2>My Vehicles</h2>
                <div class="vehicle-list" id="vehicle-list">
                    <!-- Vehicle cards will be added here dynamically -->
                </div>
                <button class="add-vehicle-btn" id="add-vehicle-btn">
                    <i class="fas fa-plus"></i> Add New Vehicle
                </button>
                
                <!-- Smart Alerts Section -->
                <div class="smart-alerts" id="smart-alerts-sidebar" style="margin-top: 25px; display: none;">
                    <h3>Smart Alerts</h3>
                    <div id="alerts-list">
                        <!-- Alerts will be added here dynamically -->
                    </div>
                </div>
            </aside>
            
            <main class="content-area">
                <div id="login-prompt" class="login-prompt">
                    <i class="fas fa-user-lock"></i>
                    <h2>Please Sign In</h2>
                    <p>Sign in to access your vehicle data and reports.</p>
                    <button id="prompt-sign-in-btn" class="btn btn-primary" style="margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                
                <div id="no-vehicle" class="no-vehicle" style="display: none;">
                    <i class="fas fa-car-side"></i>
                    <h2>No Vehicle Selected</h2>
                    <p>Select a vehicle from the list or add a new one to get started.</p>
                </div>
                
                <div id="vehicle-details" style="display: none;">
                    <div class="dashboard">
                        <div class="stat-card">
                            <h3>Current Odometer</h3>
                            <div class="value" id="current-odometer">0</div>
                            <div class="unit">kilometers</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Spent</h3>
                            <div class="value" id="total-spent">0</div>
                            <div class="unit">currency</div>
                        </div>
                        <div class="stat-card">
                            <h3>Average Mileage</h3>
                            <div class="value" id="avg-mileage">0</div>
                            <div class="unit">km/L</div>
                        </div>
                        <div class="stat-card">
                            <h3>Next Service</h3>
                            <div class="value" id="next-service">-</div>
                            <div class="unit">due</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total KM Driven</h3>
                            <div class="value" id="total-km-driven">0</div>
                            <div class="unit">kilometers</div>
                        </div>
                        <div class="stat-card">
                            <h3>Cost per KM</h3>
                            <div class="value" id="cost-per-km">0</div>
                            <div class="unit">currency/km</div>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="trips">Trips</div>
                        <div class="tab" data-tab="expenses">Expenses</div>
                        <div class="tab" data-tab="mileage">Mileage</div>
                        <div class="tab" data-tab="services">Services</div>
                        <div class="tab" data-tab="reports">Reports</div>
                        <div class="tab" data-tab="budget">Budget</div>
                        <div class="tab" data-tab="tools">Tools</div>
                    </div>
                    
                    <div class="panels">
                        <!-- Trips Panel - Now First -->
                        <div class="panel active" id="trips-panel">
                            <h3>Trip Log</h3>
                            <p>Record your journeys and track travel expenses.</p>
                            
                            <!-- Filter Section -->
                            <div class="filter-section">
                                <h4>Filter Trips</h4>
                                <div class="filter-controls">
                                    <div class="input-group">
                                        <label for="trip-filter-period">Time Period</label>
                                        <select id="trip-filter-period">
                                            <option value="all">All Time</option>
                                            <option value="thisMonth" selected>This Month</option>
                                            <option value="lastMonth">Last Month</option>
                                            <option value="thisYear">This Year</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                    <div class="input-group" id="trip-custom-range" style="display: none;">
                                        <label for="trip-start-date">Start Date</label>
                                        <input type="date" id="trip-start-date">
                                        <label for="trip-end-date">End Date</label>
                                        <input type="date" id="trip-end-date">
                                    </div>
                                    <button id="apply-trip-filter" class="btn btn-primary">
                                        <i class="fas fa-filter"></i> Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Trip Summary -->
                                <div class="data-summary" id="trip-summary">
                                    <div class="summary-item">
                                        <div class="label">Total Trips</div>
                                        <div class="value" id="total-trips">0</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">Total Distance</div>
                                        <div class="value" id="total-distance">0 km</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">Avg. Distance</div>
                                        <div class="value" id="avg-distance">0 km</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">Fuel Cost</div>
                                        <div class="value" id="trip-fuel-cost">$0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trip Planner -->
                            <div class="trip-planner" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Trip Planner</h4>
                                <form id="trip-planner-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="input-group">
                                        <label for="planner-start">Start Location</label>
                                        <input type="text" id="planner-start" placeholder="Starting point">
                                    </div>
                                    <div class="input-group">
                                        <label for="planner-end">End Location</label>
                                        <input type="text" id="planner-end" placeholder="Destination">
                                    </div>
                                    <div class="input-group">
                                        <label for="planner-distance">Distance (km)</label>
                                        <input type="number" id="planner-distance" placeholder="Total distance">
                                    </div>
                                    <div class="input-group">
                                        <label for="planner-fuel-price">Fuel Price (per L)</label>
                                        <input type="number" id="planner-fuel-price" step="0.01" placeholder="Current fuel price">
                                    </div>
                                    <div class="input-group" style="grid-column: span 2;">
                                        <button type="button" class="btn btn-primary" id="calculate-trip-btn">
                                            <i class="fas fa-calculator"></i> Calculate Trip Cost
                                        </button>
                                    </div>
                                </form>
                                <div class="trip-estimate" id="trip-estimate" style="display: none; margin-top: 20px;">
                                    <h4>Trip Estimate</h4>
                                    <div class="cost-breakdown" style="background: white; padding: 15px; border-radius: 12px;">
                                        <div class="cost-item">
                                            <span>Fuel Cost:</span>
                                            <span id="estimate-fuel">$0.00</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Maintenance Cost:</span>
                                            <span id="estimate-maintenance">$0.00</span>
                                        </div>
                                        <div class="cost-item">
                                            <span>Other Costs:</span>
                                            <span id="estimate-other">$0.00</span>
                                        </div>
                                        <div class="cost-item total">
                                            <span>Total Estimated Cost:</span>
                                            <span id="estimate-total">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="trip-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                                <div class="input-group">
                                    <label for="trip-date">Date</label>
                                    <input type="date" id="trip-date" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-input-type">Input Type</label>
                                    <select id="trip-input-type" required>
                                        <option value="distance">Total Distance</option>
                                        <option value="odometer">Odometer Reading</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="trip-start-odometer">Start Odometer (km)</label>
                                    <input type="number" id="trip-start-odometer" readonly>
                                </div>
                                <div class="input-group">
                                    <label for="trip-end-odometer">End Odometer (km) / Total Distance</label>
                                    <input type="number" id="trip-end-odometer" step="0.1" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-start">Start Location</label>
                                    <input type="text" id="trip-start" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-end">End Location</label>
                                    <input type="text" id="trip-end" required>
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <label for="trip-purpose">Purpose</label>
                                    <input type="text" id="trip-purpose">
                                </div>
                                <input type="hidden" id="trip-id">
                                <div class="input-group" style="grid-column: span 2;">
                                    <button type="submit" class="btn btn-primary" id="trip-submit-btn">
                                        <i class="fas fa-save"></i> Add Trip
                                    </button>
                                </div>
                            </form>
                            
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Route</th>
                                        <th>Distance</th>
                                        <th>Purpose</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trip-history">
                                    <!-- Trip history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Expenses Panel - Now Second -->
                        <div class="panel" id="expenses-panel">
                            <h3>Expense Tracking</h3>
                            <p>Track all your vehicle-related expenses.</p>
                            
                            <!-- Filter Section -->
                            <div class="filter-section">
                                <h4>Filter Expenses</h4>
                                <div class="filter-controls">
                                    <div class="input-group">
                                        <label for="expense-filter-period">Time Period</label>
                                        <select id="expense-filter-period">
                                            <option value="all">All Time</option>
                                            <option value="thisMonth" selected>This Month</option>
                                            <option value="lastMonth">Last Month</option>
                                            <option value="thisYear">This Year</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="expense-filter-category">Category</label>
                                        <select id="expense-filter-category">
                                            <option value="all">All Categories</option>
                                            <option value="fuel">Fuel</option>
                                            <option value="service">Service</option>
                                            <option value="repair">Repair</option>
                                            <option value="insurance">Insurance</option>
                                            <option value="tax">Tax</option>
                                            <option value="toll">Toll</option>
                                            <option value="parking">Parking</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="input-group" id="expense-custom-range" style="display: none;">
                                        <label for="expense-start-date">Start Date</label>
                                        <input type="date" id="expense-start-date">
                                        <label for="expense-end-date">End Date</label>
                                        <input type="date" id="expense-end-date">
                                    </div>
                                    <button id="apply-expense-filter" class="btn btn-primary">
                                        <i class="fas fa-filter"></i> Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Expense Summary -->
                                <div class="data-summary" id="expense-summary">
                                    <div class="summary-item">
                                        <div class="label">Total Expenses</div>
                                        <div class="value" id="total-expenses">$0</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">This Month</div>
                                        <div class="value" id="month-expenses">$0</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">Avg. per Month</div>
                                        <div class="value" id="avg-month-expenses">$0</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="label">Fuel Expenses</div>
                                        <div class="value" id="fuel-expenses">$0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3>Add New Expense</h3>
                            <form class="expense-form" id="expense-form">
                                <div class="input-group">
                                    <label for="expense-type">Expense Type</label>
                                    <select id="expense-type" required>
                                        <option value="">Select type</option>
                                        <option value="fuel">Fuel</option>
                                        <option value="service">Service</option>
                                        <option value="repair">Repair</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="tax">Tax</option>
                                        <option value="toll">Toll</option>
                                        <option value="parking">Parking</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="expense-amount">Amount</label>
                                    <input type="number" id="expense-amount" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="input-group" id="fuel-volume-group" style="display: none;">
                                    <label for="expense-fuel-volume">Fuel Volume (L)</label>
                                    <input type="number" id="expense-fuel-volume" step="0.01" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label for="expense-date">Date</label>
                                    <input type="date" id="expense-date" required>
                                </div>
                                <div class="input-group">
                                    <label for="expense-odometer">Odometer (km)</label>
                                    <input type="number" id="expense-odometer" placeholder="Current reading">
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <label for="expense-notes">Notes</label>
                                    <textarea id="expense-notes" rows="2" placeholder="Additional details"></textarea>
                                </div>
                                <input type="hidden" id="expense-id">
                                <div class="input-group" style="grid-column: span 2;">
                                    <button type="submit" class="btn btn-primary" id="expense-submit-btn">
                                        <i class="fas fa-save"></i> Add Expense
                                    </button>
                                </div>
                            </form>
                            
                            <h3>Expense History</h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Volume (L)</th>
                                        <th>Odometer</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-history">
                                    <!-- Expense history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mileage Panel -->
                        <div class="panel" id="mileage-panel">
                            <h3>Mileage Tracking</h3>
                            <p>Track your vehicle's fuel efficiency over time.</p>
                            
                            <!-- Mileage Graph Controls -->
                            <div class="mileage-graph-controls">
                                <button class="active" data-period="all">All Time</button>
                                <button data-period="thisMonth">This Month</button>
                                <button data-period="thisYear">This Year</button>
                                <button data-period="lastYear">Last Year</button>
                            </div>
                            
                            <div id="mileage-chart" class="chart-container">
                                <!-- Mileage chart will be displayed here -->
                            </div>
                            
                            <!-- Fuel Price Tracker -->
                            <div class="fuel-price-tracker" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Fuel Price Tracker</h4>
                                <form class="fuel-price-form" id="fuel-price-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div class="input-group">
                                        <label for="fuel-station">Station</label>
                                        <input type="text" id="fuel-station" placeholder="Station name">
                                    </div>
                                    <div class="input-group">
                                        <label for="fuel-price">Price per Liter</label>
                                        <input type="number" id="fuel-price" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="input-group">
                                        <label for="fuel-type-select">Fuel Type</label>
                                        <select id="fuel-type-select">
                                            <option value="petrol">Petrol</option>
                                            <option value="diesel">Diesel</option>
                                            <option value="premium">Premium</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="fuel-date">Date</label>
                                        <input type="date" id="fuel-date">
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="align-self: end;">Add Price</button>
                                </form>
                                <div class="fuel-price-history" id="fuel-price-history"></div>
                            </div>
                            
                            <h3>Mileage Records</h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Distance (km)</th>
                                        <th>Fuel (L)</th>
                                        <th>Mileage (km/L)</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="mileage-history">
                                    <!-- Mileage history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Services Panel -->
                        <div class="panel" id="services-panel">
                            <h3>Service History</h3>
                            <p>Keep track of all services and repairs for your vehicle.</p>
                            <div id="service-reminder" class="service-reminder" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="service-reminder-text"></span>
                            </div>
                            <button class="btn btn-primary" id="add-service-btn" style="margin: 20px 0;">
                                <i class="fas fa-plus"></i> Add Service Record
                            </button>
                            
                            <!-- Maintenance Schedule -->
                            <div class="maintenance-schedule" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Maintenance Schedule</h4>
                                <div id="maintenance-list">
                                    <!-- Maintenance items will be added here dynamically -->
                                </div>
                            </div>
                            
                            <!-- Parts Inventory -->
                            <div class="parts-inventory" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Parts Inventory</h4>
                                <button class="btn btn-secondary" id="add-part-btn" style="margin-bottom: 15px;">
                                    <i class="fas fa-plus"></i> Add Part
                                </button>
                                <div id="parts-list">
                                    <!-- Parts will be added here dynamically -->
                                </div>
                            </div>
                            
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service Type</th>
                                        <th>Odometer</th>
                                        <th>Cost</th>
                                        <th>Details</th>
                                        <th>Next Service</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="service-history">
                                    <!-- Service history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Reports Panel -->
                        <div class="panel" id="reports-panel">
                            <h3>Reports</h3>
                            <p>Generate detailed reports for your vehicle expenses and usage.</p>
                            
                            <div class="report-section">
                                <h4>Expense Report</h4>
                                <div class="report-controls">
                                    <div class="input-group">
                                        <label for="report-type">Report Type</label>
                                        <select id="report-type">
                                            <option value="monthly">Monthly Summary</option>
                                            <option value="category">By Category</option>
                                            <option value="custom">Custom Date Range</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="report-month">Month</label>
                                        <select id="report-month">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="report-year">Year</label>
                                        <select id="report-year">
                                            <!-- Years will be populated dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="input-group" id="custom-date-range" style="display: none;">
                                        <label for="report-start-date">Start Date</label>
                                        <input type="date" id="report-start-date">
                                        <label for="report-end-date">End Date</label>
                                        <input type="date" id="report-end-date">
                                    </div>
                                    
                                    <button id="generate-report-btn" class="btn btn-primary">
                                        <i class="fas fa-chart-bar"></i> Generate Report
                                    </button>
                                    
                                    <button id="export-report-btn" class="btn btn-success">
                                        <i class="fas fa-download"></i> Export to PDF
                                    </button>
                                </div>
                                
                                <div id="expense-chart" class="chart-container">
                                    <!-- Expense chart will be displayed here -->
                                </div>
                                
                                <div class="report-results" id="report-results">
                                    <!-- Report results will be displayed here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Budget Panel -->
                        <div class="panel" id="budget-panel">
                            <h3>Budget & Financial Planning</h3>
                            <p>Set budgets and track your vehicle expenses against them.</p>
                            
                            <div class="budget-section" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Monthly Budget</h4>
                                <form id="budget-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div class="input-group">
                                        <label for="budget-month">Month</label>
                                        <select id="budget-month">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="budget-year">Year</label>
                                        <select id="budget-year">
                                            <!-- Years will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="budget-amount">Budget Amount</label>
                                        <input type="number" id="budget-amount" step="0.01" placeholder="0.00" required>
                                    </div>
                                    <div class="input-group" style="grid-column: span 2;">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Set Budget
                                        </button>
                                    </div>
                                </form>
                                
                                <div id="budget-progress" class="budget-progress">
                                    <!-- Budget progress will be displayed here -->
                                </div>
                                
                                <div id="budget-history">
                                    <!-- Budget history will be displayed here -->
                                </div>
                            </div>
                            
                            <!-- Cost Analysis -->
                            <div class="cost-breakdown" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px;">
                                <h4>Cost Analysis</h4>
                                <div id="cost-analysis">
                                    <!-- Cost analysis will be displayed here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tools Panel -->
                        <div class="panel" id="tools-panel">
                            <h3>Vehicle Tools & Calculators</h3>
                            <p>Useful tools for vehicle management and planning.</p>
                            
                            <!-- Carbon Footprint Calculator -->
                            <div class="carbon-calculator" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin: 20px 0;">
                                <h4>Carbon Footprint Calculator</h4>
                                <form id="carbon-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="input-group">
                                        <label for="carbon-distance">Distance (km)</label>
                                        <input type="number" id="carbon-distance" placeholder="Distance traveled">
                                    </div>
                                    <div class="input-group">
                                        <label for="carbon-fuel-type">Fuel Type</label>
                                        <select id="carbon-fuel-type">
                                            <option value="petrol">Petrol</option>
                                            <option value="diesel">Diesel</option>
                                            <option value="electric">Electric</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label for="carbon-efficiency">Fuel Efficiency (km/L)</label>
                                        <input type="number" id="carbon-efficiency" placeholder="Your vehicle's efficiency">
                                    </div>
                                    <div class="input-group" style="grid-column: span 2;">
                                        <button type="button" class="btn btn-primary" id="calculate-carbon-btn">
                                            <i class="fas fa-leaf"></i> Calculate Carbon Footprint
                                        </button>
                                    </div>
                                </form>
                                <div class="carbon-result" id="carbon-result" style="display: none; background: white; padding: 20px; border-radius: 12px; margin-top: 15px;">
                                    <h4>Your Carbon Footprint</h4>
                                    <div class="carbon-value" id="carbon-value" style="font-size: 2rem; font-weight: 700; color: var(--success); margin: 10px 0;">0 kg CO</div>
                                    <div class="carbon-comparison" id="carbon-comparison">
                                        This is equivalent to...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vehicle Valuation -->
                            <div class="cost-breakdown" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin-top: 20px;">
                                <h4>Vehicle Valuation</h4>
                                <form id="valuation-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="input-group">
                                        <label for="vehicle-purchase-price">Purchase Price</label>
                                        <input type="number" id="vehicle-purchase-price" placeholder="Original price">
                                    </div>
                                    <div class="input-group">
                                        <label for="vehicle-purchase-year">Purchase Year</label>
                                        <input type="number" id="vehicle-purchase-year" placeholder="Year of purchase">
                                    </div>
                                    <div class="input-group">
                                        <label for="vehicle-current-year">Current Year</label>
                                        <input type="number" id="vehicle-current-year" placeholder="Current year">
                                    </div>
                                    <div class="input-group">
                                        <label for="vehicle-condition">Condition</label>
                                        <select id="vehicle-condition">
                                            <option value="excellent">Excellent</option>
                                            <option value="good">Good</option>
                                            <option value="fair">Fair</option>
                                            <option value="poor">Poor</option>
                                        </select>
                                    </div>
                                    <div class="input-group" style="grid-column: span 2;">
                                        <button type="button" class="btn btn-primary" id="calculate-valuation-btn">
                                            <i class="fas fa-calculator"></i> Estimate Current Value
                                        </button>
                                    </div>
                                </form>
                                <div class="carbon-result" id="valuation-result" style="display: none; background: white; padding: 20px; border-radius: 12px; margin-top: 15px;">
                                    <h4>Estimated Current Value</h4>
                                    <div class="carbon-value" id="valuation-value" style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 10px 0;">$0</div>
                                    <div class="carbon-comparison" id="valuation-comparison">
                                        Depreciation details...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Smart Alerts -->
                            <div class="smart-alerts" style="background: var(--sidebar-bg); padding: 20px; border-radius: 16px; margin-top: 20px;">
                                <h4>Smart Alerts</h4>
                                <div id="alerts-container">
                                    <!-- Alerts will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer>
            <p>Vehicle Manager Pro &copy; 2023 - Track all your vehicles in one place</p>
        </footer>
    </div>
    
    <!-- Notification Element -->
    <div id="notification" class="notification"></div>
    
    <!-- Add Vehicle Modal -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="vehicle-modal-title">Add New Vehicle</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="vehicle-form">
                <div class="input-group">
                    <label for="vehicle-name">Vehicle Name</label>
                    <input type="text" id="vehicle-name" placeholder="e.g., My Honda City" required>
                </div>
                <div class="input-group">
                    <label for="vehicle-type">Vehicle Type</label>
                    <select id="vehicle-type" required>
                        <option value="">Select type</option>
                        <option value="car">Car</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="suv">SUV</option>
                        <option value="truck">Truck</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="vehicle-model">Model</label>
                    <input type="text" id="vehicle-model" placeholder="e.g., Honda City">
                </div>
                <div class="input-group">
                    <label for="vehicle-year">Year</label>
                    <input type="number" id="vehicle-year" min="1950" max="2030" placeholder="e.g., 2020">
                </div>
                <div class="input-group">
                    <label for="initial-odometer">Current Odometer (km)</label>
                    <input type="number" id="initial-odometer" placeholder="Current reading">
                </div>
                <div class="input-group">
                    <label for="fuel-type">Fuel Type</label>
                    <select id="fuel-type">
                        <option value="">Select fuel type</option>
                        <option value="petrol">Petrol</option>
                        <option value="diesel">Diesel</option>
                        <option value="electric">Electric</option>
                        <option value="hybrid">Hybrid</option>
                        <option value="cng">CNG</option>
                    </select>
                </div>
                <input type="hidden" id="vehicle-id">
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Service Modal -->
    <div class="modal" id="add-service-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="service-modal-title">Add Service Record</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="service-form">
                <div class="input-group">
                    <label for="service-type">Service Type</label>
                    <select id="service-type" required>
                        <option value="">Select type</option>
                        <option value="oil_change">Oil Change</option>
                        <option value="tire_rotation">Tire Rotation</option>
                        <option value="brake_service">Brake Service</option>
                        <option value="filter_replacement">Filter Replacement</option>
                        <option value="battery_replacement">Battery Replacement</option>
                        <option value="general_service">General Service</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="service-date">Date</label>
                    <input type="date" id="service-date" required>
                </div>
                <div class="input-group">
                    <label for="service-odometer">Odometer (km)</label>
                    <input type="number" id="service-odometer" placeholder="Current reading" required>
                </div>
                <div class="input-group">
                    <label for="service-cost">Cost</label>
                    <input type="number" id="service-cost" step="0.01" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label for="service-days-interval">Next Service Interval (days)</label>
                    <input type="number" id="service-days-interval" placeholder="e.g., 180" min="0">
                </div>
                <div class="input-group">
                    <label for="service-km-interval">Next Service Interval (km)</label>
                    <input type="number" id="service-km-interval" placeholder="e.g., 5000" min="0">
                </div>
                <div class="input-group">
                    <label for="service-details">Details</label>
                    <textarea id="service-details" rows="3" placeholder="Service details"></textarea>
                </div>
                <input type="hidden" id="service-id">
                <div class="input-group">
                    <button type="submit" class="btn btn-primary" id="service-submit-btn">
                        <i class="fas fa-save"></i> Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Part Modal -->
    <div class="modal" id="add-part-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Part to Inventory</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="part-form">
                <div class="input-group">
                    <label for="part-name">Part Name</label>
                    <input type="text" id="part-name" placeholder="e.g., Oil Filter" required>
                </div>
                <div class="input-group">
                    <label for="part-category">Category</label>
                    <select id="part-category" required>
                        <option value="">Select category</option>
                        <option value="engine">Engine</option>
                        <option value="brakes">Brakes</option>
                        <option value="electrical">Electrical</option>
                        <option value="tires">Tires</option>
                        <option value="filters">Filters</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="part-quantity">Quantity</label>
                    <input type="number" id="part-quantity" placeholder="0" required>
                </div>
                <div class="input-group">
                    <label for="part-minimum">Minimum Stock Level</label>
                    <input type="number" id="part-minimum" placeholder="Minimum quantity to maintain">
                </div>
                <div class="input-group">
                    <label for="part-location">Storage Location</label>
                    <input type="text" id="part-location" placeholder="Where it's stored">
                </div>
                <div class="input-group">
                    <label for="part-notes">Notes</label>
                    <textarea id="part-notes" rows="2" placeholder="Additional details"></textarea>
                </div>
                <input type="hidden" id="part-id">
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Part
                    </button>
                </div>
            </form>
        </div>
    </div>
<script>
    // Firebase configuration and initialization
    const firebaseConfig = {
        apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
        authDomain: "budget-app-1365f.firebaseapp.com",
        projectId: "budget-app-1365f",
        storageBucket: "budget-app-1365f.firebasestorage.app",
        messagingSenderId: "1036194450411",
        appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
        measurementId: "G-YFFJL2H54X"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    google.charts.load('current', {'packages':['corechart']});
    
    // Global variables
    let vehicles = [];
    let selectedVehicleId = null;
    let expenses = [];
    let services = [];
    let trips = [];
    let mileageRecords = [];
    let fuelPrices = [];
    let parts = [];
    let budgets = [];
    
    // DOM Elements
    const vehicleList = document.getElementById('vehicle-list');
    const noVehicle = document.getElementById('no-vehicle');
    const vehicleDetails = document.getElementById('vehicle-details');
    const loginPrompt = document.getElementById('login-prompt');
    const addVehicleBtn = document.getElementById('add-vehicle-btn');
    const addVehicleModal = document.getElementById('add-vehicle-modal');
    const addServiceModal = document.getElementById('add-service-modal');
    const addServiceBtn = document.getElementById('add-service-btn');
    const addPartModal = document.getElementById('add-part-modal');
    const addPartBtn = document.getElementById('add-part-btn');
    const closeModals = document.querySelectorAll('.close-modal');
    const vehicleForm = document.getElementById('vehicle-form');
    const serviceForm = document.getElementById('service-form');
    const partForm = document.getElementById('part-form');
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');
    const expenseForm = document.getElementById('expense-form');
    const tripForm = document.getElementById('trip-form');
    const fuelPriceForm = document.getElementById('fuel-price-form');
    const expenseHistory = document.getElementById('expense-history');
    const serviceHistory = document.getElementById('service-history');
    const tripHistory = document.getElementById('trip-history');
    const mileageHistory = document.getElementById('mileage-history');
    const fuelPriceHistory = document.getElementById('fuel-price-history');
    const signInBtn = document.getElementById('sign-in-btn');
    const promptSignInBtn = document.getElementById('prompt-sign-in-btn');
    const signOutBtn = document.getElementById('sign-out-btn');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const exportReportBtn = document.getElementById('export-report-btn');
    const reportResults = document.getElementById('report-results');
    const serviceReminder = document.getElementById('service-reminder');
    const serviceReminderText = document.getElementById('service-reminder-text');
    const tripInputType = document.getElementById('trip-input-type');
    const tripStartOdometer = document.getElementById('trip-start-odometer');
    const tripEndOdometer = document.getElementById('trip-end-odometer');
    const reportTypeSelect = document.getElementById('report-type');
    const customDateRange = document.getElementById('custom-date-range');
    const vehicleModalTitle = document.getElementById('vehicle-modal-title');
    const vehicleIdInput = document.getElementById('vehicle-id');
    const serviceModalTitle = document.getElementById('service-modal-title');
    const expenseSubmitBtn = document.getElementById('expense-submit-btn');
    const serviceSubmitBtn = document.getElementById('service-submit-btn');
    const tripSubmitBtn = document.getElementById('trip-submit-btn');
    const expenseType = document.getElementById('expense-type');
    const fuelVolumeGroup = document.getElementById('fuel-volume-group');
    const notification = document.getElementById('notification');
    const maintenanceList = document.getElementById('maintenance-list');
    const partsList = document.getElementById('parts-list');
    const budgetForm = document.getElementById('budget-form');
    const budgetProgress = document.getElementById('budget-progress');
    const budgetHistory = document.getElementById('budget-history');
    const costAnalysis = document.getElementById('cost-analysis');
    const calculateTripBtn = document.getElementById('calculate-trip-btn');
    const tripEstimate = document.getElementById('trip-estimate');
    const calculateCarbonBtn = document.getElementById('calculate-carbon-btn');
    const carbonResult = document.getElementById('carbon-result');
    const calculateValuationBtn = document.getElementById('calculate-valuation-btn');
    const valuationResult = document.getElementById('valuation-result');
    const alertsContainer = document.getElementById('alerts-container');
    const smartAlertsSidebar = document.getElementById('smart-alerts-sidebar');
    const alertsList = document.getElementById('alerts-list');
    
    // New Filter Elements
    const tripFilterPeriod = document.getElementById('trip-filter-period');
    const tripCustomRange = document.getElementById('trip-custom-range');
    const applyTripFilter = document.getElementById('apply-trip-filter');
    const expenseFilterPeriod = document.getElementById('expense-filter-period');
    const expenseFilterCategory = document.getElementById('expense-filter-category');
    const expenseCustomRange = document.getElementById('expense-custom-range');
    const applyExpenseFilter = document.getElementById('apply-expense-filter');
    const mileageGraphControls = document.querySelectorAll('.mileage-graph-controls button');
    
    // Initialize the application
    function init() {
        setupEventListeners();
        setCurrentDate();
        populateYearDropdown();
        initAuth();
    }
    
    // Authentication
    function initAuth() {
        auth.onAuthStateChanged(user => {
            if (user) {
                userInfo.style.display = 'flex';
                document.getElementById('auth-buttons').style.display = 'none';
                userName.textContent = user.displayName || user.email;
                loginPrompt.style.display = 'none';
                loadUserData();
            } else {
                userInfo.style.display = 'none';
                document.getElementById('auth-buttons').style.display = 'block';
                loginPrompt.style.display = 'block';
                vehicleDetails.style.display = 'none';
                noVehicle.style.display = 'none';
                vehicles = [];
                selectedVehicleId = null;
                renderVehicles();
            }
        });
    }
    
    function signIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(result => {
                console.log('Signed in successfully:', result.user);
                showNotification('Signed in successfully!', 'success');
            })
            .catch(error => {
                console.error('Sign in error:', error);
                showNotification('Sign in failed: ' + error.message, 'error');
            });
    }
    
    function signOut() {
        auth.signOut()
            .then(() => {
                console.log('Signed out successfully');
                showNotification('Signed out successfully!', 'info');
            })
            .catch(error => {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            });
    }
    
    // Data Loading
    function loadUserData() {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                vehicles = [];
                snapshot.forEach(doc => {
                    vehicles.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderVehicles();
                
                if (selectedVehicleId) {
                    const vehicleExists = vehicles.some(v => v.id === selectedVehicleId);
                    if (vehicleExists) {
                        selectVehicle(selectedVehicleId);
                    } else {
                        selectedVehicleId = null;
                        noVehicle.style.display = 'block';
                        vehicleDetails.style.display = 'none';
                    }
                }
            }, error => {
                console.error('Error loading vehicles:', error);
                showNotification('Error loading vehicles: ' + error.message, 'error');
            });
    }
    
    function loadExpenses(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('expenses')
            .orderBy('date', 'desc')
            .onSnapshot(snapshot => {
                expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderExpenseHistory();
                updateVehicleDashboard();
                updateBudgetProgress();
                generateCostAnalysis();
                updateExpenseSummary();
            }, error => {
                console.error('Error loading expenses:', error);
                showNotification('Error loading expenses: ' + error.message, 'error');
            });
    }
    
    function loadServices(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('services')
            .orderBy('date', 'desc')
            .onSnapshot(snapshot => {
                services = [];
                snapshot.forEach(doc => {
                    services.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderServiceHistory();
                updateVehicleDashboard();
                checkServiceReminders();
                generateMaintenanceSchedule();
            }, error => {
                console.error('Error loading services:', error);
                showNotification('Error loading services: ' + error.message, 'error');
            });
    }
    
    function loadTrips(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('trips')
            .orderBy('date', 'desc')
            .onSnapshot(snapshot => {
                trips = [];
                snapshot.forEach(doc => {
                    trips.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderTripHistory();
                updateVehicleDashboard();
                updateTripSummary();
            }, error => {
                console.error('Error loading trips:', error);
                showNotification('Error loading trips: ' + error.message, 'error');
            });
    }
    
    function loadFuelPrices(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('fuelPrices')
            .orderBy('date', 'desc')
            .onSnapshot(snapshot => {
                fuelPrices = [];
                snapshot.forEach(doc => {
                    fuelPrices.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderFuelPriceHistory();
            }, error => {
                console.error('Error loading fuel prices:', error);
            });
    }
    
    function loadParts(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('parts')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
                parts = [];
                snapshot.forEach(doc => {
                    parts.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderPartsList();
            }, error => {
                console.error('Error loading parts:', error);
            });
    }
    
    function loadBudgets(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('budgets')
            .orderBy('year', 'desc')
            .orderBy('month', 'desc')
            .onSnapshot(snapshot => {
                budgets = [];
                snapshot.forEach(doc => {
                    budgets.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderBudgetHistory();
            }, error => {
                console.error('Error loading budgets:', error);
            });
    }
    
    // Rendering Functions
    function renderVehicles() {
        vehicleList.innerHTML = '';
        
        if (vehicles.length === 0) {
            vehicleList.innerHTML = '<p>No vehicles added yet.</p>';
            return;
        }
        
        vehicles.forEach(vehicle => {
            const vehicleCard = document.createElement('div');
            vehicleCard.className = 'vehicle-card';
            if (vehicle.id === selectedVehicleId) {
                vehicleCard.classList.add('active');
            }
            
            vehicleCard.innerHTML = `
                <div class="vehicle-icon">
                    <i class="fas ${getVehicleIcon(vehicle.type)}"></i>
                </div>
                <div class="vehicle-info">
                    <h3>${vehicle.name}</h3>
                    <p>${vehicle.model || 'No model'}  ${vehicle.odometer} km</p>
                </div>
                <div class="vehicle-actions">
                    <button class="action-btn" onclick="editVehicle('${vehicle.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" onclick="deleteVehicle('${vehicle.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            vehicleCard.addEventListener('click', (e) => {
                if (!e.target.closest('.action-btn')) {
                    selectVehicle(vehicle.id);
                }
            });
            vehicleList.appendChild(vehicleCard);
        });
    }
    
    function selectVehicle(vehicleId) {
        selectedVehicleId = vehicleId;
        renderVehicles();
        
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (vehicle) {
            noVehicle.style.display = 'none';
            vehicleDetails.style.display = 'block';
            updateTripStartOdometer();
            loadExpenses(vehicleId);
            loadServices(vehicleId);
            loadTrips(vehicleId);
            loadFuelPrices(vehicleId);
            loadParts(vehicleId);
            loadBudgets(vehicleId);
            generateSmartAlerts();
        }
    }
    
    // Dashboard and Analytics
    function updateVehicleDashboard() {
        calculateMileageRecords();
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return;
        
        let maxOdometer = vehicle.odometer || 0;
        let totalKmDriven = 0;
        
        expenses.forEach(expense => {
            if (expense.odometer > maxOdometer) {
                maxOdometer = expense.odometer;
            }
        });
        services.forEach(service => {
            if (service.odometer > maxOdometer) {
                maxOdometer = service.odometer;
            }
        });
        trips.forEach(trip => {
            if (trip.endOdometer && trip.endOdometer > maxOdometer) {
                maxOdometer = trip.endOdometer;
            }
            if (trip.distance) {
                totalKmDriven += trip.distance;
            }
        });
        
        document.getElementById('current-odometer').textContent = maxOdometer;
        document.getElementById('total-km-driven').textContent = totalKmDriven.toFixed(1);
        
        const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        document.getElementById('total-spent').textContent = totalSpent.toFixed(2);
        
        // Calculate cost per km
        const costPerKm = totalKmDriven > 0 ? totalSpent / totalKmDriven : 0;
        document.getElementById('cost-per-km').textContent = costPerKm.toFixed(2);
        
        if (mileageRecords.length > 0) {
            const totalMileage = mileageRecords.reduce((sum, record) => sum + record.mileage, 0);
            const avgMileage = totalMileage / mileageRecords.length;
            document.getElementById('avg-mileage').textContent = avgMileage.toFixed(1);
        } else {
            document.getElementById('avg-mileage').textContent = '0.0';
        }
        
        updateNextServiceDisplay();
    }

    function updateNextServiceDisplay() {
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return;

        let maxOdometer = vehicle.odometer;
        expenses.forEach(expense => {
            if (expense.odometer > maxOdometer) {
                maxOdometer = expense.odometer;
            }
        });
        services.forEach(service => {
            if (service.odometer > maxOdometer) {
                maxOdometer = service.odometer;
            }
        });
        trips.forEach(trip => {
            if (trip.endOdometer && trip.endOdometer > maxOdometer) {
                maxOdometer = trip.endOdometer;
            }
        });

        let nextServiceText = '-';
        let nextServiceColor = '';

        if (services.length > 0) {
            const latestService = services[0];
            let daysRemaining = null;
            let kmRemaining = null;

            if (latestService.nextServiceDays) {
                const serviceDate = new Date(latestService.date);
                const today = new Date();
                const daysSince = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
                daysRemaining = latestService.nextServiceDays - daysSince;
            }

            if (latestService.nextServiceKm) {
                const kmDriven = maxOdometer - latestService.odometer;
                kmRemaining = latestService.nextServiceKm - kmDriven;
            }

            // Determine which reminder to show
            if (daysRemaining !== null && kmRemaining !== null) {
                const kmAsDays = kmRemaining / 50;
                if (daysRemaining < kmAsDays) {
                    nextServiceText = `${daysRemaining} days remaining`;
                    nextServiceColor = getServiceReminderColor(daysRemaining, true);
                } else {
                    nextServiceText = `${kmRemaining} km remaining`;
                    nextServiceColor = getServiceReminderColor(kmRemaining / 50, true);
                }
            } else if (daysRemaining !== null) {
                nextServiceText = `${daysRemaining} days remaining`;
                nextServiceColor = getServiceReminderColor(daysRemaining, true);
            } else if (kmRemaining !== null) {
                nextServiceText = `${kmRemaining} km remaining`;
                nextServiceColor = getServiceReminderColor(kmRemaining / 50, true);
            } else {
                nextServiceText = '-';
            }
        }

        document.getElementById('next-service').textContent = nextServiceText;
        const nextServiceCard = document.querySelector('.stat-card:nth-child(4)');
        if (nextServiceColor) {
            nextServiceCard.style.borderColor = nextServiceColor;
            nextServiceCard.style.background = nextServiceColor + '20';
        } else {
            nextServiceCard.style.borderColor = '';
            nextServiceCard.style.background = '';
        }
    }

    function getServiceReminderColor(value, isRemaining = true) {
        if (value < 0) return '#ef4444';
        
        if (isRemaining) {
            if (value > 20) return '#10b981';
            if (value > 15) return '#34d399';
            if (value > 10) return '#f59e0b';
            if (value > 5) return '#f97316';
            return '#ef4444';
        }
        
        return '#ef4444';
    }

    function checkServiceReminders() {
        if (!services.length) {
            serviceReminder.style.display = 'none';
            return;
        }

        const latestService = services[0];
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle || !latestService) return;

        let maxOdometer = vehicle.odometer;
        expenses.forEach(expense => {
            if (expense.odometer > maxOdometer) {
                maxOdometer = expense.odometer;
            }
        });
        services.forEach(service => {
            if (service.odometer > maxOdometer) {
                maxOdometer = service.odometer;
            }
        });
        trips.forEach(trip => {
            if (trip.endOdometer && trip.endOdometer > maxOdometer) {
                maxOdometer = trip.endOdometer;
            }
        });

        const today = new Date();
        let reminderText = '';
        let isDue = false;
        let reminderColor = '';

        if (latestService.nextServiceDays) {
            const serviceDate = new Date(latestService.date);
            const daysSince = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
            const daysRemaining = latestService.nextServiceDays - daysSince;
            
            if (daysRemaining <= 0) {
                reminderText += `Service overdue by ${Math.abs(daysRemaining)} days. `;
                isDue = true;
                reminderColor = 'red';
            } else {
                reminderText += `Service due in ${daysRemaining} days. `;
                reminderColor = getServiceReminderColor(daysRemaining, true);
            }
        }

        if (latestService.nextServiceKm) {
            const kmDriven = maxOdometer - latestService.odometer;
            const kmRemaining = latestService.nextServiceKm - kmDriven;
            
            if (kmRemaining <= 0) {
                reminderText += `Service overdue by ${Math.abs(kmRemaining)} km.`;
                isDue = true;
                reminderColor = 'red';
            } else {
                reminderText += `Service due in ${kmRemaining} km.`;
                if (!reminderColor || kmRemaining/50 < (latestService.nextServiceDays ? (latestService.nextServiceDays - Math.floor((today - new Date(latestService.date)) / (1000 * 60 * 60 * 24))) : Infinity)) {
                    reminderColor = getServiceReminderColor(kmRemaining/50, true);
                }
            }
        }

        if (reminderText) {
            serviceReminderText.textContent = reminderText;
            serviceReminder.className = 'service-reminder ' + getServiceReminderClass(reminderColor);
            serviceReminder.style.display = 'flex';
        } else {
            serviceReminder.style.display = 'none';
        }
    }

    function getServiceReminderClass(color) {
        switch(color) {
            case '#10b981': return 'green';
            case '#34d399': return 'light-green';
            case '#f59e0b': return 'yellow';
            case '#f97316': return 'orange';
            case '#ef4444': return 'red';
            default: return 'yellow';
        }
    }
    
    function updateTripStartOdometer() {
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return;

        let maxOdometer = vehicle.odometer || 0;
        expenses.forEach(expense => {
            if (expense.odometer > maxOdometer) {
                maxOdometer = expense.odometer;
            }
        });
        services.forEach(service => {
            if (service.odometer > maxOdometer) {
                maxOdometer = service.odometer;
            }
        });
        trips.forEach(trip => {
            if (trip.endOdometer && trip.endOdometer > maxOdometer) {
                maxOdometer = trip.endOdometer;
            }
        });

        tripStartOdometer.value = maxOdometer;
    }
    
    function calculateMileageRecords() {
        const fuelExpenses = expenses.filter(e => e.type === 'fuel' && e.fuelVolume && e.odometer).map(e => ({
            type: 'expense',
            id: e.id,
            date: e.date,
            odometer: e.odometer,
            fuelAmount: e.fuelVolume,
            cost: e.amount
        }));
        const allFills = [...fuelExpenses].sort((a, b) => a.odometer - b.odometer);
        mileageRecords = [];
        for (let i = 1; i < allFills.length; i++) {
            const prevFill = allFills[i - 1];
            const currFill = allFills[i];
            const distance = currFill.odometer - prevFill.odometer;
            if (distance > 0 && currFill.fuelAmount > 0) {
                mileageRecords.push({
                    date: currFill.date,
                    distance,
                    fuelAmount: currFill.fuelAmount,
                    cost: currFill.cost,
                    mileage: distance / currFill.fuelAmount
                });
            }
        }
        mileageRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
    }
    
    // New Filter Functions
    function filterTrips() {
        const period = tripFilterPeriod.value;
        const filteredTrips = getFilteredTrips(period);
        renderFilteredTripHistory(filteredTrips);
        updateTripSummary(filteredTrips);
    }
    
    function getFilteredTrips(period) {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        switch(period) {
            case 'thisMonth':
                return trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate.getMonth() === currentMonth && tripDate.getFullYear() === currentYear;
                });
            case 'lastMonth':
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate.getMonth() === lastMonth && tripDate.getFullYear() === lastMonthYear;
                });
            case 'thisYear':
                return trips.filter(trip => {
                    const tripDate = new Date(trip.date);
                    return tripDate.getFullYear() === currentYear;
                });
            case 'custom':
                const startDate = document.getElementById('trip-start-date').value;
                const endDate = document.getElementById('trip-end-date').value;
                if (startDate && endDate) {
                    return trips.filter(trip => {
                        const tripDate = new Date(trip.date);
                        return tripDate >= new Date(startDate) && tripDate <= new Date(endDate);
                    });
                }
                return trips;
            default:
                return trips;
        }
    }
    
    function filterExpenses() {
        const period = expenseFilterPeriod.value;
        const category = expenseFilterCategory.value;
        const filteredExpenses = getFilteredExpenses(period, category);
        renderFilteredExpenseHistory(filteredExpenses);
        updateExpenseSummary(filteredExpenses);
    }
    
    function getFilteredExpenses(period, category) {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        let filtered = expenses;
        
        // Filter by period
        switch(period) {
            case 'thisMonth':
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                });
                break;
            case 'lastMonth':
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === lastMonth && expenseDate.getFullYear() === lastMonthYear;
                });
                break;
            case 'thisYear':
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === currentYear;
                });
                break;
            case 'custom':
                const startDate = document.getElementById('expense-start-date').value;
                const endDate = document.getElementById('expense-end-date').value;
                if (startDate && endDate) {
                    filtered = filtered.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate >= new Date(startDate) && expenseDate <= new Date(endDate);
                    });
                }
                break;
        }
        
        // Filter by category
        if (category !== 'all') {
            filtered = filtered.filter(expense => expense.type === category);
        }
        
        return filtered;
    }
    
    function updateMileageGraph(period) {
        let filteredMileage = mileageRecords;
        
        if (period !== 'all') {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            switch(period) {
                case 'thisMonth':
                    filteredMileage = mileageRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                    });
                    break;
                case 'thisYear':
                    filteredMileage = mileageRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate.getFullYear() === currentYear;
                    });
                    break;
                case 'lastYear':
                    filteredMileage = mileageRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate.getFullYear() === currentYear - 1;
                    });
                    break;
            }
        }
        
        drawMileageChart(filteredMileage);
    }
    
    function updateTripSummary(filteredTrips = trips) {
        const totalTrips = filteredTrips.length;
        const totalDistance = filteredTrips.reduce((sum, trip) => sum + trip.distance, 0);
        const avgDistance = totalTrips > 0 ? totalDistance / totalTrips : 0;
        
        // Calculate fuel cost (estimate based on average mileage and fuel price)
        const avgMileage = mileageRecords.length > 0 ? 
            mileageRecords.reduce((sum, record) => sum + record.mileage, 0) / mileageRecords.length : 10;
        const latestFuelPrice = fuelPrices.length > 0 ? fuelPrices[0].price : 1.5;
        const fuelCost = totalDistance / avgMileage * latestFuelPrice;
        
        document.getElementById('total-trips').textContent = totalTrips;
        document.getElementById('total-distance').textContent = totalDistance.toFixed(1) + ' km';
        document.getElementById('avg-distance').textContent = avgDistance.toFixed(1) + ' km';
        document.getElementById('trip-fuel-cost').textContent = '$' + fuelCost.toFixed(2);
    }
    
    function updateExpenseSummary(filteredExpenses = expenses) {
        const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        
        // This month expenses
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const thisMonthExpenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
        }).reduce((sum, expense) => sum + expense.amount, 0);
        
        // Average monthly expenses
        const monthlyExpenses = {};
        expenses.forEach(expense => {
            const expenseDate = new Date(expense.date);
            const monthYear = `${expenseDate.getFullYear()}-${expenseDate.getMonth()}`;
            if (!monthlyExpenses[monthYear]) {
                monthlyExpenses[monthYear] = 0;
            }
            monthlyExpenses[monthYear] += expense.amount;
        });
        const avgMonthlyExpenses = Object.keys(monthlyExpenses).length > 0 ? 
            Object.values(monthlyExpenses).reduce((sum, amount) => sum + amount, 0) / Object.keys(monthlyExpenses).length : 0;
        
        // Fuel expenses
        const fuelExpenses = expenses.filter(expense => expense.type === 'fuel')
            .reduce((sum, expense) => sum + expense.amount, 0);
        
        document.getElementById('total-expenses').textContent = '$' + totalExpenses.toFixed(2);
        document.getElementById('month-expenses').textContent = '$' + thisMonthExpenses.toFixed(2);
        document.getElementById('avg-month-expenses').textContent = '$' + avgMonthlyExpenses.toFixed(2);
        document.getElementById('fuel-expenses').textContent = '$' + fuelExpenses.toFixed(2);
    }
    
    function renderFilteredTripHistory(filteredTrips) {
        tripHistory.innerHTML = '';
        
        if (filteredTrips.length === 0) {
            tripHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No trips found for the selected filter</td></tr>';
            return;
        }
        
        filteredTrips.forEach(trip => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(trip.date)}</td>
                <td>${trip.startLocation} to ${trip.endLocation}</td>
                <td>${trip.distance} km</td>
                <td>${trip.purpose || '-'}</td>
                <td>
                    <button class="action-btn" onclick="editTrip('${trip.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" onclick="deleteTrip('${trip.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tripHistory.appendChild(row);
        });
    }
    
    function renderFilteredExpenseHistory(filteredExpenses) {
        expenseHistory.innerHTML = '';
        
        if (filteredExpenses.length === 0) {
            expenseHistory.innerHTML = '<tr><td colspan="7" style="text-align: center;">No expenses found for the selected filter</td></tr>';
            return;
        }
        
        filteredExpenses.forEach(expense => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(expense.date)}</td>
                <td>${formatExpenseType(expense.type)}</td>
                <td>${expense.amount.toFixed(2)}</td>
                <td>${expense.fuelVolume ? expense.fuelVolume.toFixed(2) : '-'}</td>
                <td>${expense.odometer || '-'}</td>
                <td>${expense.notes || '-'}</td>
                <td>
                    <button class="action-btn" onclick="editExpense('${expense.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" onclick="deleteExpense('${expense.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            expenseHistory.appendChild(row);
        });
    }
    
    function renderExpenseHistory() {
        renderFilteredExpenseHistory(expenses);
    }
    
    function renderTripHistory() {
        renderFilteredTripHistory(trips);
    }
    
    function renderServiceHistory() {
        serviceHistory.innerHTML = '';
        
        if (services.length === 0) {
            serviceHistory.innerHTML = '<tr><td colspan="7" style="text-align: center;">No services recorded yet</td></tr>';
            return;
        }
        
        services.forEach(service => {
            const nextService = [];
            if (service.nextServiceDays) {
                const serviceDate = new Date(service.date);
                const nextServiceDate = new Date(serviceDate.getTime() + service.nextServiceDays * 24 * 60 * 60 * 1000);
                nextService.push(formatDate(nextServiceDate));
            }
            if (service.nextServiceKm) {
                nextService.push(`${service.odometer + service.nextServiceKm} km`);
            }
            const nextServiceText = nextService.length > 0 ? nextService.join(' or ') : '-';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(service.date)}</td>
                <td>${formatServiceType(service.type)}</td>
                <td>${service.odometer}</td>
                <td>${service.cost.toFixed(2)}</td>
                <td>${service.details || '-'}</td>
                <td>${nextServiceText}</td>
                <td>
                    <button class="action-btn" onclick="editService('${service.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" onclick="deleteService('${service.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            serviceHistory.appendChild(row);
        });
    }
    
    function renderMileageHistory() {
        mileageHistory.innerHTML = '';
        
        if (mileageRecords.length === 0) {
            mileageHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No mileage records yet</td></tr>';
            return;
        }
        
        mileageRecords.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(record.date)}</td>
                <td>${record.distance.toFixed(1)}</td>
                <td>${record.fuelAmount.toFixed(2)}</td>
                <td>${record.mileage.toFixed(1)}</td>
                <td>${record.cost ? record.cost.toFixed(2) : '-'}</td>
            `;
            mileageHistory.appendChild(row);
        });
    }
    
    function renderFuelPriceHistory() {
        fuelPriceHistory.innerHTML = '';
        
        if (fuelPrices.length === 0) {
            fuelPriceHistory.innerHTML = '<p>No fuel prices recorded yet.</p>';
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'history-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Station</th>
                    <th>Fuel Type</th>
                    <th>Price (per L)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        fuelPrices.forEach(price => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(price.date)}</td>
                <td>${price.station}</td>
                <td>${price.fuelType}</td>
                <td>${price.price.toFixed(2)}</td>
                <td>
                    <button class="action-btn delete-btn" onclick="deleteFuelPrice('${price.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        fuelPriceHistory.appendChild(table);
    }
    
    function renderPartsList() {
        partsList.innerHTML = '';
        
        if (parts.length === 0) {
            partsList.innerHTML = '<p>No parts in inventory.</p>';
            return;
        }
        
        parts.forEach(part => {
            const partItem = document.createElement('div');
            partItem.className = 'part-item';
            
            let stockStatus = 'good';
            if (part.quantity <= 0) {
                stockStatus = 'low';
            } else if (part.quantity <= (part.minimum || 2)) {
                stockStatus = 'medium';
            }
            
            partItem.innerHTML = `
                <div class="part-info">
                    <h4>${part.name}</h4>
                    <p>${part.category}  Location: ${part.location || 'Not specified'}</p>
                </div>
                <div class="part-stock ${stockStatus}">
                    ${part.quantity} in stock
                </div>
            `;
            partsList.appendChild(partItem);
        });
    }
    
    function drawMileageChart(filteredMileage = mileageRecords) {
        if (filteredMileage.length === 0) {
            document.getElementById('mileage-chart').innerHTML = '<p>No mileage data available for chart</p>';
            return;
        }
        
        const data = new google.visualization.DataTable();
        data.addColumn('date', 'Date');
        data.addColumn('number', 'Mileage (km/L)');
        
        const chartData = filteredMileage
            .map(record => {
                return [new Date(record.date), record.mileage];
            });
        
        data.addRows(chartData);
        
        const options = {
            title: 'Fuel Efficiency Over Time',
            curveType: 'function',
            legend: { position: 'bottom' },
            hAxis: { title: 'Date', format: 'MMM yyyy' },
            vAxis: { title: 'Mileage (km/L)', minValue: 0 },
            colors: ['#6366f1'],
            backgroundColor: '#f8fafc'
        };
        
        const chart = new google.visualization.LineChart(document.getElementById('mileage-chart'));
        chart.draw(data, options);
    }
    
    function generateExpenseReport() {
        const reportType = reportTypeSelect.value;
        const month = parseInt(document.getElementById('report-month').value);
        const year = parseInt(document.getElementById('report-year').value);
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        
        let filteredExpenses = [];
        
        if (reportType === 'monthly') {
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === month && 
                       expenseDate.getFullYear() === year;
            });
        } else if (reportType === 'category') {
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getFullYear() === year;
            });
        } else if (reportType === 'custom' && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= start && expenseDate <= end;
            });
        }
        
        if (filteredExpenses.length === 0) {
            reportResults.innerHTML = '<p>No expenses found for the selected criteria.</p>';
            document.getElementById('expense-chart').innerHTML = '';
            return;
        }
        
        let totalAmount = 0;
        const byCategory = {};
        
        filteredExpenses.forEach(expense => {
            totalAmount += expense.amount;
            if (!byCategory[expense.type]) {
                byCategory[expense.type] = 0;
            }
            byCategory[expense.type] += expense.amount;
        });
        
        let html = `
            <div class="report-summary">
                <div class="summary-card">
                    <h4>Total Expenses</h4>
                    <div class="value">${totalAmount.toFixed(2)}</div>
                    <div class="unit">currency</div>
                </div>
                <div class="summary-card">
                    <h4>Number of Expenses</h4>
                    <div class="value">${filteredExpenses.length}</div>
                    <div class="unit">records</div>
                </div>
                <div class="summary-card">
                    <h4>Average Expense</h4>
                    <div class="value">${(totalAmount / filteredExpenses.length).toFixed(2)}</div>
                    <div class="unit">per record</div>
                </div>
            </div>
        `;
        
        let tableHtml = `
            <h4>Expenses by Category</h4>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        for (const category in byCategory) {
            const percentage = ((byCategory[category] / totalAmount) * 100).toFixed(1);
            tableHtml += `
                <tr>
                    <td>${formatExpenseType(category)}</td>
                    <td>${byCategory[category].toFixed(2)}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        }
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        reportResults.innerHTML = html + tableHtml;
        drawExpenseChart(byCategory);
    }
    
    function drawExpenseChart(byCategory) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Category');
        data.addColumn('number', 'Amount');
        
        for (const category in byCategory) {
            data.addRow([formatExpenseType(category), byCategory[category]]);
        }
        
        const options = {
            title: 'Expenses by Category',
            is3D: true,
            pieSliceText: 'value',
            sliceVisibilityThreshold: 0.01,
            colors: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
            backgroundColor: '#f8fafc'
        };
        
        const chart = new google.visualization.PieChart(document.getElementById('expense-chart'));
        chart.draw(data, options);
    }
    
    function updateBudgetProgress() {
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        
        const currentBudget = budgets.find(b => b.month === currentMonth && b.year === currentYear);
        if (!currentBudget) {
            budgetProgress.innerHTML = '<p>No budget set for this month.</p>';
            return;
        }
        
        const monthlyExpenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate.getMonth() + 1 === currentMonth && 
                   expenseDate.getFullYear() === currentYear;
        });
        
        const spentAmount = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        const percentage = (spentAmount / currentBudget.amount) * 100;
        
        let progressClass = '';
        if (percentage > 100) {
            progressClass = 'danger';
        } else if (percentage > 80) {
            progressClass = 'warning';
        }
        
        budgetProgress.innerHTML = `
            <h4>Current Month Budget Progress</h4>
            <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                <span>Budget: ${currentBudget.amount.toFixed(2)}</span>
                <span>Spent: ${spentAmount.toFixed(2)}</span>
                <span>Remaining: ${(currentBudget.amount - spentAmount).toFixed(2)}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            <p style="text-align: center; margin-top: 8px; font-size: 0.9rem;">
                ${percentage.toFixed(1)}% of budget used
            </p>
        `;
    }
    
    function renderBudgetHistory() {
        budgetHistory.innerHTML = '';
        
        if (budgets.length === 0) {
            budgetHistory.innerHTML = '<p>No budgets set yet.</p>';
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'history-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Budget Amount</th>
                    <th>Actual Spent</th>
                    <th>Difference</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        budgets.forEach(budget => {
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === budget.month && 
                       expenseDate.getFullYear() === budget.year;
            });
            
            const spentAmount = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const difference = budget.amount - spentAmount;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${getMonthName(budget.month)}</td>
                <td>${budget.year}</td>
                <td>${budget.amount.toFixed(2)}</td>
                <td>${spentAmount.toFixed(2)}</td>
                <td style="color: ${difference >= 0 ? 'green' : 'red'}">
                    ${difference.toFixed(2)}
                </td>
                <td>
                    <button class="action-btn delete-btn" onclick="deleteBudget('${budget.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        budgetHistory.appendChild(table);
    }
    
    function generateCostAnalysis() {
        const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const byCategory = {};
        
        expenses.forEach(expense => {
            if (!byCategory[expense.type]) {
                byCategory[expense.type] = 0;
            }
            byCategory[expense.type] += expense.amount;
        });
        
        let html = '<h4>Total Cost Breakdown</h4>';
        
        for (const category in byCategory) {
            const percentage = ((byCategory[category] / totalSpent) * 100).toFixed(1);
            html += `
                <div class="cost-item">
                    <span>${formatExpenseType(category)}:</span>
                    <span>${byCategory[category].toFixed(2)} (${percentage}%)</span>
                </div>
            `;
        }
        
        html += `
            <div class="cost-item total">
                <span>Total:</span>
                <span>${totalSpent.toFixed(2)}</span>
            </div>
        `;
        
        costAnalysis.innerHTML = html;
    }
    
    function generateMaintenanceSchedule() {
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return;
        
        let maxOdometer = vehicle.odometer;
        expenses.forEach(expense => {
            if (expense.odometer > maxOdometer) {
                maxOdometer = expense.odometer;
            }
        });
        services.forEach(service => {
            if (service.odometer > maxOdometer) {
                maxOdometer = service.odometer;
            }
        });
        trips.forEach(trip => {
            if (trip.endOdometer && trip.endOdometer > maxOdometer) {
                maxOdometer = trip.endOdometer;
            }
        });
        
        const today = new Date();
        const maintenanceItems = [];
        
        // Check for upcoming services
        services.forEach(service => {
            if (service.nextServiceDays || service.nextServiceKm) {
                let status = 'ok';
                let description = '';
                
                if (service.nextServiceDays) {
                    const serviceDate = new Date(service.date);
                    const daysSince = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
                    const daysRemaining = service.nextServiceDays - daysSince;
                    
                    if (daysRemaining <= 0) {
                        status = 'due';
                        description = `Overdue by ${Math.abs(daysRemaining)} days`;
                    } else if (daysRemaining <= 30) {
                        status = 'upcoming';
                        description = `Due in ${daysRemaining} days`;
                    } else {
                        description = `Due in ${daysRemaining} days`;
                    }
                }
                
                if (service.nextServiceKm) {
                    const kmDriven = maxOdometer - service.odometer;
                    const kmRemaining = service.nextServiceKm - kmDriven;
                    
                    if (kmRemaining <= 0) {
                        status = 'due';
                        description = `Overdue by ${Math.abs(kmRemaining)} km`;
                    } else if (kmRemaining <= 500) {
                        if (status !== 'due') status = 'upcoming';
                        description = `Due in ${kmRemaining} km`;
                    } else {
                        if (status === 'ok') description = `Due in ${kmRemaining} km`;
                    }
                }
                
                maintenanceItems.push({
                    type: service.type,
                    status,
                    description
                });
            }
        });
        
        // Add standard maintenance items if no services are recorded
        if (maintenanceItems.length === 0) {
            maintenanceItems.push(
                { type: 'Oil Change', status: 'upcoming', description: 'Check manufacturer recommendation' },
                { type: 'Tire Rotation', status: 'upcoming', description: 'Check every 10,000 km' },
                { type: 'Brake Inspection', status: 'ok', description: 'Check every 10,000 km' }
            );
        }
        
        renderMaintenanceSchedule(maintenanceItems);
    }
    
    function renderMaintenanceSchedule(items) {
        maintenanceList.innerHTML = '';
        
        if (items.length === 0) {
            maintenanceList.innerHTML = '<p>No maintenance items scheduled.</p>';
            return;
        }
        
        items.forEach(item => {
            const maintenanceItem = document.createElement('div');
            maintenanceItem.className = 'maintenance-item';
            maintenanceItem.innerHTML = `
                <div class="maintenance-info">
                    <h4>${formatServiceType(item.type)}</h4>
                    <p>${item.description}</p>
                </div>
                <div class="maintenance-status ${item.status}">
                    ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                </div>
            `;
            maintenanceList.appendChild(maintenanceItem);
        });
    }
    
    function generateSmartAlerts() {
        const alerts = [];
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (!vehicle) return;
        
        // Check for overdue services
        services.forEach(service => {
            if (service.nextServiceDays || service.nextServiceKm) {
                const today = new Date();
                let maxOdometer = vehicle.odometer;
                
                expenses.forEach(expense => {
                    if (expense.odometer > maxOdometer) maxOdometer = expense.odometer;
                });
                services.forEach(s => {
                    if (s.odometer > maxOdometer) maxOdometer = s.odometer;
                });
                trips.forEach(trip => {
                    if (trip.endOdometer && trip.endOdometer > maxOdometer) maxOdometer = trip.endOdometer;
                });
                
                if (service.nextServiceDays) {
                    const serviceDate = new Date(service.date);
                    const daysSince = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
                    const daysRemaining = service.nextServiceDays - daysSince;
                    
                    if (daysRemaining <= 0) {
                        alerts.push({
                            type: 'danger',
                            title: 'Service Overdue',
                            message: `${formatServiceType(service.type)} is overdue by ${Math.abs(daysRemaining)} days`,
                            icon: 'fa-exclamation-triangle'
                        });
                    } else if (daysRemaining <= 7) {
                        alerts.push({
                            type: 'warning',
                            title: 'Service Due Soon',
                            message: `${formatServiceType(service.type)} due in ${daysRemaining} days`,
                            icon: 'fa-calendar-exclamation'
                        });
                    }
                }
                
                if (service.nextServiceKm) {
                    const kmDriven = maxOdometer - service.odometer;
                    const kmRemaining = service.nextServiceKm - kmDriven;
                    
                    if (kmRemaining <= 0) {
                        alerts.push({
                            type: 'danger',
                            title: 'Service Overdue',
                            message: `${formatServiceType(service.type)} is overdue by ${Math.abs(kmRemaining)} km`,
                            icon: 'fa-exclamation-triangle'
                        });
                    } else if (kmRemaining <= 200) {
                        alerts.push({
                            type: 'warning',
                            title: 'Service Due Soon',
                            message: `${formatServiceType(service.type)} due in ${kmRemaining} km`,
                            icon: 'fa-tachometer-alt'
                        });
                    }
                }
            }
        });
        
        // Check for low stock parts
        parts.forEach(part => {
            if (part.quantity <= (part.minimum || 2)) {
                alerts.push({
                    type: 'warning',
                    title: 'Low Stock Alert',
                    message: `${part.name} is running low (${part.quantity} left)`,
                    icon: 'fa-box-open'
                });
            }
        });
        
        // Check for budget overruns
        const currentMonth = new Date().getMonth() + 1;
        const currentYear = new Date().getFullYear();
        const currentBudget = budgets.find(b => b.month === currentMonth && b.year === currentYear);
        
        if (currentBudget) {
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const spentAmount = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const percentage = (spentAmount / currentBudget.amount) * 100;
            
            if (percentage > 100) {
                alerts.push({
                    type: 'danger',
                    title: 'Budget Exceeded',
                    message: `Monthly budget exceeded by ${(spentAmount - currentBudget.amount).toFixed(2)}`,
                    icon: 'fa-money-bill-wave'
                });
            } else if (percentage > 80) {
                alerts.push({
                    type: 'warning',
                    title: 'Budget Warning',
                    message: `${percentage.toFixed(1)}% of monthly budget used`,
                    icon: 'fa-money-bill-wave'
                });
            }
        }
        
        renderSmartAlerts(alerts);
    }
    
    function renderSmartAlerts(alerts) {
        alertsContainer.innerHTML = '';
        alertsList.innerHTML = '';
        
        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<p>No alerts at this time.</p>';
            smartAlertsSidebar.style.display = 'none';
            return;
        }
        
        smartAlertsSidebar.style.display = 'block';
        
        alerts.forEach(alert => {
            // Main alerts container
            const alertItem = document.createElement('div');
            alertItem.className = 'alert-item';
            alertItem.innerHTML = `
                <div class="alert-icon ${alert.type}">
                    <i class="fas ${alert.icon}"></i>
                </div>
                <div class="alert-content">
                    <h4>${alert.title}</h4>
                    <p>${alert.message}</p>
                </div>
            `;
            alertsContainer.appendChild(alertItem);
            
            // Sidebar alerts
            const sidebarAlert = document.createElement('div');
            sidebarAlert.className = 'alert-item';
            sidebarAlert.innerHTML = `
                <div class="alert-icon ${alert.type}">
                    <i class="fas ${alert.icon}"></i>
                </div>
                <div class="alert-content">
                    <h4>${alert.title}</h4>
                    <p>${alert.message}</p>
                </div>
            `;
            alertsList.appendChild(sidebarAlert);
        });
    }
    
    // Utility Functions
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }
    
    function formatExpenseType(type) {
        const typeMap = {
            'fuel': 'Fuel',
            'service': 'Service',
            'repair': 'Repair',
            'insurance': 'Insurance',
            'tax': 'Tax',
            'toll': 'Toll',
            'parking': 'Parking',
            'other': 'Other'
        };
        return typeMap[type] || type;
    }
    
    function formatServiceType(type) {
        const typeMap = {
            'oil_change': 'Oil Change',
            'tire_rotation': 'Tire Rotation',
            'brake_service': 'Brake Service',
            'filter_replacement': 'Filter Replacement',
            'battery_replacement': 'Battery Replacement',
            'general_service': 'General Service',
            'other': 'Other'
        };
        return typeMap[type] || type;
    }
    
    function getMonthName(monthNumber) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return months[monthNumber - 1];
    }
    
    function getVehicleIcon(type) {
        switch(type) {
            case 'car': return 'fa-car';
            case 'motorcycle': return 'fa-motorcycle';
            case 'suv': return 'fa-truck-monster';
            case 'truck': return 'fa-truck';
            default: return 'fa-car';
        }
    }
    
    function setCurrentDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expense-date').value = today;
        document.getElementById('service-date').value = today;
        document.getElementById('trip-date').value = today;
        document.getElementById('fuel-date').value = today;
        document.getElementById('report-start-date').value = today;
        document.getElementById('report-end-date').value = today;
        document.getElementById('trip-start-date').value = today;
        document.getElementById('trip-end-date').value = today;
        document.getElementById('expense-start-date').value = today;
        document.getElementById('expense-end-date').value = today;
    }
    
    function populateYearDropdown() {
        const yearSelect = document.getElementById('report-year');
        const budgetYearSelect = document.getElementById('budget-year');
        const currentYear = new Date().getFullYear();
        
        [yearSelect, budgetYearSelect].forEach(select => {
            select.innerHTML = '';
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        });
        
        const currentMonth = new Date().getMonth() + 1;
        document.getElementById('report-month').value = currentMonth;
        document.getElementById('budget-month').value = currentMonth;
    }
    
    function showNotification(message, type) {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // Event Listeners Setup
    function setupEventListeners() {
        // Authentication
        signInBtn.addEventListener('click', signIn);
        promptSignInBtn.addEventListener('click', signIn);
        signOutBtn.addEventListener('click', signOut);
        
        // Vehicle Management
        addVehicleBtn.addEventListener('click', () => {
            vehicleModalTitle.textContent = 'Add New Vehicle';
            vehicleForm.reset();
            vehicleIdInput.value = '';
            addVehicleModal.style.display = 'flex';
        });
        
        addServiceBtn.addEventListener('click', () => {
            serviceModalTitle.textContent = 'Add Service Record';
            serviceForm.reset();
            document.getElementById('service-id').value = '';
            serviceSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Save Service';
            addServiceModal.style.display = 'flex';
        });
        
        addPartBtn.addEventListener('click', () => {
            document.getElementById('part-form').reset();
            document.getElementById('part-id').value = '';
            addPartModal.style.display = 'flex';
        });
        
        closeModals.forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            });
        });
        
        // Form Submissions
        vehicleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (vehicleIdInput.value) {
                updateVehicle();
            } else {
                addNewVehicle();
            }
        });
        
        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('service-id').value) {
                updateService();
            } else {
                addNewService();
            }
        });
        
        partForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addNewPart();
        });
        
        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('expense-id').value) {
                updateExpense();
            } else {
                addNewExpense();
            }
        });
        
        tripForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('trip-id').value) {
                updateTrip();
            } else {
                addNewTrip();
            }
        });
        
        fuelPriceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addNewFuelPrice();
        });
        
        budgetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addNewBudget();
        });
        
        // Tab Navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                switchTab(tabName);
                
                if (tabName === 'trips') {
                    filterTrips();
                } else if (tabName === 'expenses') {
                    filterExpenses();
                } else if (tabName === 'mileage') {
                    google.charts.setOnLoadCallback(() => {
                        calculateMileageRecords();
                        renderMileageHistory();
                        updateMileageGraph('all');
                    });
                } else if (tabName === 'reports') {
                    google.charts.setOnLoadCallback(generateExpenseReport);
                } else if (tabName === 'budget') {
                    updateBudgetProgress();
                } else if (tabName === 'tools') {
                    generateSmartAlerts();
                }
            });
        });
        
        // Filter Controls
        tripFilterPeriod.addEventListener('change', () => {
            tripCustomRange.style.display = tripFilterPeriod.value === 'custom' ? 'block' : 'none';
        });
        
        expenseFilterPeriod.addEventListener('change', () => {
            expenseCustomRange.style.display = expenseFilterPeriod.value === 'custom' ? 'block' : 'none';
        });
        
        applyTripFilter.addEventListener('click', filterTrips);
        applyExpenseFilter.addEventListener('click', filterExpenses);
        
        // Mileage Graph Controls
        mileageGraphControls.forEach(button => {
            button.addEventListener('click', () => {
                mileageGraphControls.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const period = button.getAttribute('data-period');
                updateMileageGraph(period);
            });
        });
        
        // Report Controls
        reportTypeSelect.addEventListener('change', () => {
            customDateRange.style.display = reportTypeSelect.value === 'custom' ? 'block' : 'none';
            document.getElementById('report-month').parentElement.style.display = reportTypeSelect.value === 'custom' ? 'none' : 'block';
        });
        
        generateReportBtn.addEventListener('click', generateExpenseReport);
        
        exportReportBtn.addEventListener('click', exportReportToPDF);
        
        // Trip Planner
        calculateTripBtn.addEventListener('click', calculateTripCost);
        
        // Carbon Calculator
        calculateCarbonBtn.addEventListener('click', calculateCarbonFootprint);
        
        // Vehicle Valuation
        calculateValuationBtn.addEventListener('click', calculateVehicleValuation);
        
        // Expense Type Change
        expenseType.addEventListener('change', () => {
            fuelVolumeGroup.style.display = expenseType.value === 'fuel' ? 'block' : 'none';
        });
        
        // Trip Input Type Change
        tripInputType.addEventListener('change', () => {
            const label = document.querySelector('label[for="trip-end-odometer"]');
            if (tripInputType.value === 'distance') {
                label.textContent = 'Total Distance (km)';
            } else {
                label.textContent = 'End Odometer (km)';
            }
        });
        
        // Window Events
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    }
    
    function switchTab(tabName) {
        tabs.forEach(tab => {
            if (tab.getAttribute('data-tab') === tabName) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        panels.forEach(panel => {
            if (panel.id === `${tabName}-panel`) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        });
    }
    
    // Data Management Functions
    function addNewVehicle() {
        const user = auth.currentUser;
        if (!user) {
            showNotification('Please sign in to add a vehicle', 'warning');
            return;
        }
        
        const name = document.getElementById('vehicle-name').value;
        const type = document.getElementById('vehicle-type').value;
        const model = document.getElementById('vehicle-model').value;
        const year = document.getElementById('vehicle-year').value;
        const odometer = document.getElementById('initial-odometer').value || 0;
        const fuelType = document.getElementById('fuel-type').value;
        
        const vehicleData = {
            name,
            type,
            model,
            year: year ? parseInt(year) : null,
            odometer: parseInt(odometer),
            fuelType,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').add(vehicleData)
            .then(docRef => {
                console.log('Vehicle added with ID: ', docRef.id);
                addVehicleModal.style.display = 'none';
                vehicleForm.reset();
                selectVehicle(docRef.id);
                showNotification('Vehicle added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding vehicle: ', error);
                showNotification('Error adding vehicle: ' + error.message, 'error');
            });
    }
    
    function editVehicle(vehicleId) {
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (!vehicle) return;
        
        document.getElementById('vehicle-name').value = vehicle.name;
        document.getElementById('vehicle-type').value = vehicle.type;
        document.getElementById('vehicle-model').value = vehicle.model || '';
        document.getElementById('vehicle-year').value = vehicle.year || '';
        document.getElementById('initial-odometer').value = vehicle.odometer || '';
        document.getElementById('fuel-type').value = vehicle.fuelType || '';
        vehicleIdInput.value = vehicleId;
        vehicleModalTitle.textContent = 'Edit Vehicle';
        addVehicleModal.style.display = 'flex';
    }
    
    function updateVehicle() {
        const user = auth.currentUser;
        if (!user) {
            showNotification('Please sign in to update a vehicle', 'warning');
            return;
        }
        
        const vehicleId = vehicleIdInput.value;
        const name = document.getElementById('vehicle-name').value;
        const type = document.getElementById('vehicle-type').value;
        const model = document.getElementById('vehicle-model').value;
        const year = document.getElementById('vehicle-year').value;
        const odometer = document.getElementById('initial-odometer').value || 0;
        const fuelType = document.getElementById('fuel-type').value;
        
        const vehicleData = {
            name,
            type,
            model,
            year: year ? parseInt(year) : null,
            odometer: parseInt(odometer),
            fuelType,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId)
            .update(vehicleData)
            .then(() => {
                console.log('Vehicle updated successfully');
                addVehicleModal.style.display = 'none';
                vehicleForm.reset();
                vehicleIdInput.value = '';
                if (selectedVehicleId === vehicleId) {
                    selectVehicle(vehicleId);
                }
                showNotification('Vehicle updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error updating vehicle: ', error);
                showNotification('Error updating vehicle: ' + error.message, 'error');
            });
    }
    
    function deleteVehicle(vehicleId) {
        const user = auth.currentUser;
        if (!user) return;
        
        if (confirm('Are you sure you want to delete this vehicle and all its associated data?')) {
            const vehicleRef = db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId);
            
            // Delete all subcollections
            Promise.all([
                deleteCollection(db, vehicleRef.collection('expenses')),
                deleteCollection(db, vehicleRef.collection('services')),
                deleteCollection(db, vehicleRef.collection('trips')),
                deleteCollection(db, vehicleRef.collection('fuelPrices')),
                deleteCollection(db, vehicleRef.collection('parts')),
                deleteCollection(db, vehicleRef.collection('budgets'))
            ]).then(() => {
                // Delete the vehicle document
                vehicleRef.delete()
                    .then(() => {
                        console.log('Vehicle deleted successfully');
                        if (selectedVehicleId === vehicleId) {
                            selectedVehicleId = null;
                            vehicleDetails.style.display = 'none';
                            noVehicle.style.display = 'block';
                        }
                        showNotification('Vehicle deleted successfully!', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting vehicle: ', error);
                        showNotification('Error deleting vehicle: ' + error.message, 'error');
                    });
            });
        }
    }
    
    // Helper function to delete a collection
    async function deleteCollection(db, collectionRef) {
        const snapshot = await collectionRef.get();
        const batch = db.batch();
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
    }
    
    function addNewExpense() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const type = document.getElementById('expense-type').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        const odometer = document.getElementById('expense-odometer').value;
        const notes = document.getElementById('expense-notes').value;
        const fuelVolume = type === 'fuel' ? parseFloat(document.getElementById('expense-fuel-volume').value) || null : null;
        
        const expenseData = {
            type,
            amount,
            date,
            odometer: odometer ? parseInt(odometer) : null,
            notes,
            fuelVolume,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('expenses').add(expenseData)
            .then(() => {
                console.log('Expense added successfully');
                resetExpenseForm();
                
                if (odometer) {
                    updateVehicleOdometer(parseInt(odometer));
                }
                showNotification('Expense added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding expense: ', error);
                showNotification('Error adding expense: ' + error.message, 'error');
            });
    }
    
    function updateExpense() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const expenseId = document.getElementById('expense-id').value;
        const type = document.getElementById('expense-type').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        const odometer = document.getElementById('expense-odometer').value;
        const notes = document.getElementById('expense-notes').value;
        const fuelVolume = type === 'fuel' ? parseFloat(document.getElementById('expense-fuel-volume').value) || null : null;
        
        const expenseData = {
            type,
            amount,
            date,
            odometer: odometer ? parseInt(odometer) : null,
            notes,
            fuelVolume,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('expenses').doc(expenseId).update(expenseData)
            .then(() => {
                console.log('Expense updated successfully');
                resetExpenseForm();
                
                if (odometer) {
                    updateVehicleOdometer(parseInt(odometer));
                }
                showNotification('Expense updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error updating expense: ', error);
                showNotification('Error updating expense: ' + error.message, 'error');
            });
    }
    
    function resetExpenseForm() {
        expenseForm.reset();
        setCurrentDate();
        document.getElementById('expense-id').value = '';
        expenseSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Add Expense';
        fuelVolumeGroup.style.display = 'none';
    }
    
    function addNewService() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const type = document.getElementById('service-type').value;
        const date = document.getElementById('service-date').value;
        const odometer = document.getElementById('service-odometer').value;
        const cost = parseFloat(document.getElementById('service-cost').value);
        const daysInterval = document.getElementById('service-days-interval').value;
        const kmInterval = document.getElementById('service-km-interval').value;
        const details = document.getElementById('service-details').value;
        
        const serviceData = {
            type,
            date,
            odometer: parseInt(odometer),
            cost,
            nextServiceDays: daysInterval ? parseInt(daysInterval) : null,
            nextServiceKm: kmInterval ? parseInt(kmInterval) : null,
            details,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('services').add(serviceData)
            .then(() => {
                console.log('Service added successfully');
                addServiceModal.style.display = 'none';
                serviceForm.reset();
                setCurrentDate();
                updateVehicleOdometer(parseInt(odometer));
                showNotification('Service added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding service: ', error);
                showNotification('Error adding service: ' + error.message, 'error');
            });
    }
    
    function updateService() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const serviceId = document.getElementById('service-id').value;
        const type = document.getElementById('service-type').value;
        const date = document.getElementById('service-date').value;
        const odometer = document.getElementById('service-odometer').value;
        const cost = parseFloat(document.getElementById('service-cost').value);
        const daysInterval = document.getElementById('service-days-interval').value;
        const kmInterval = document.getElementById('service-km-interval').value;
        const details = document.getElementById('service-details').value;
        
        const serviceData = {
            type,
            date,
            odometer: parseInt(odometer),
            cost,
            nextServiceDays: daysInterval ? parseInt(daysInterval) : null,
            nextServiceKm: kmInterval ? parseInt(kmInterval) : null,
            details,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('services').doc(serviceId).update(serviceData)
            .then(() => {
                console.log('Service updated successfully');
                addServiceModal.style.display = 'none';
                serviceForm.reset();
                setCurrentDate();
                document.getElementById('service-id').value = '';
                serviceModalTitle.textContent = 'Add Service Record';
                serviceSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Save Service';
                updateVehicleOdometer(parseInt(odometer));
                showNotification('Service updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error updating service: ', error);
                showNotification('Error updating service: ' + error.message, 'error');
            });
    }
    
    function addNewTrip() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const date = document.getElementById('trip-date').value;
        const inputType = document.getElementById('trip-input-type').value;
        const startOdometer = parseFloat(document.getElementById('trip-start-odometer').value);
        const endOdometerInput = parseFloat(document.getElementById('trip-end-odometer').value);
        const startLocation = document.getElementById('trip-start').value;
        const endLocation = document.getElementById('trip-end').value;
        const purpose = document.getElementById('trip-purpose').value;
        
        let distance;
        let endOdometer;
        
        if (inputType === 'distance') {
            distance = endOdometerInput;
            endOdometer = startOdometer + distance;
        } else {
            endOdometer = endOdometerInput;
            distance = endOdometer - startOdometer;
        }
        
        if (distance <= 0) {
            showNotification('End odometer must be greater than start odometer', 'warning');
            return;
        }
        
        const tripData = {
            date,
            startOdometer,
            endOdometer,
            distance,
            startLocation,
            endLocation,
            purpose,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('trips').add(tripData)
            .then(() => {
                console.log('Trip added successfully');
                resetTripForm();
                updateVehicleOdometer(endOdometer);
                showNotification('Trip added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding trip: ', error);
                showNotification('Error adding trip: ' + error.message, 'error');
            });
    }
    
    function updateTrip() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const tripId = document.getElementById('trip-id').value;
        const date = document.getElementById('trip-date').value;
        const inputType = document.getElementById('trip-input-type').value;
        const startOdometer = parseFloat(document.getElementById('trip-start-odometer').value);
        const endOdometerInput = parseFloat(document.getElementById('trip-end-odometer').value);
        const startLocation = document.getElementById('trip-start').value;
        const endLocation = document.getElementById('trip-end').value;
        const purpose = document.getElementById('trip-purpose').value;
        
        let distance;
        let endOdometer;
        
        if (inputType === 'distance') {
            distance = endOdometerInput;
            endOdometer = startOdometer + distance;
        } else {
            endOdometer = endOdometerInput;
            distance = endOdometer - startOdometer;
        }
        
        if (distance <= 0) {
            showNotification('End odometer must be greater than start odometer', 'warning');
            return;
        }
        
        const tripData = {
            date,
            startOdometer,
            endOdometer,
            distance,
            startLocation,
            endLocation,
            purpose,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('trips').doc(tripId).update(tripData)
            .then(() => {
                console.log('Trip updated successfully');
                resetTripForm();
                updateVehicleOdometer(endOdometer);
                showNotification('Trip updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error updating trip: ', error);
                showNotification('Error updating trip: ' + error.message, 'error');
            });
    }
    
    function resetTripForm() {
        tripForm.reset();
        setCurrentDate();
        document.getElementById('trip-id').value = '';
        tripSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Add Trip';
        updateTripStartOdometer();
    }
    
    function addNewFuelPrice() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const station = document.getElementById('fuel-station').value;
        const price = parseFloat(document.getElementById('fuel-price').value);
        const fuelType = document.getElementById('fuel-type-select').value;
        const date = document.getElementById('fuel-date').value;
        
        const fuelPriceData = {
            station,
            price,
            fuelType,
            date,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('fuelPrices').add(fuelPriceData)
            .then(() => {
                console.log('Fuel price added successfully');
                fuelPriceForm.reset();
                setCurrentDate();
                showNotification('Fuel price added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding fuel price: ', error);
                showNotification('Error adding fuel price: ' + error.message, 'error');
            });
    }
    
    function addNewPart() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const name = document.getElementById('part-name').value;
        const category = document.getElementById('part-category').value;
        const quantity = parseInt(document.getElementById('part-quantity').value);
        const minimum = document.getElementById('part-minimum').value ? parseInt(document.getElementById('part-minimum').value) : 2;
        const location = document.getElementById('part-location').value;
        const notes = document.getElementById('part-notes').value;
        
        const partData = {
            name,
            category,
            quantity,
            minimum,
            location,
            notes,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('parts').add(partData)
            .then(() => {
                console.log('Part added successfully');
                addPartModal.style.display = 'none';
                partForm.reset();
                showNotification('Part added to inventory!', 'success');
            })
            .catch(error => {
                console.error('Error adding part: ', error);
                showNotification('Error adding part: ' + error.message, 'error');
            });
    }
    
    function addNewBudget() {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const month = parseInt(document.getElementById('budget-month').value);
        const year = parseInt(document.getElementById('budget-year').value);
        const amount = parseFloat(document.getElementById('budget-amount').value);
        
        const budgetData = {
            month,
            year,
            amount,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
            .collection('budgets').add(budgetData)
            .then(() => {
                console.log('Budget added successfully');
                budgetForm.reset();
                setCurrentDate();
                showNotification('Budget set successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding budget: ', error);
                showNotification('Error adding budget: ' + error.message, 'error');
            });
    }
    
    function updateVehicleOdometer(newOdometer) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        const vehicleRef = db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId);
        vehicleRef.get().then(doc => {
            if (doc.exists) {
                const vehicle = doc.data();
                if (newOdometer > vehicle.odometer) {
                    vehicleRef.update({
                        odometer: newOdometer,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }
        });
    }
    
    // Delete Functions
    function deleteExpense(expenseId) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        if (confirm('Are you sure you want to delete this expense?')) {
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('expenses').doc(expenseId).delete()
                .then(() => {
                    console.log('Expense deleted successfully');
                    showNotification('Expense deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting expense: ', error);
                    showNotification('Error deleting expense: ' + error.message, 'error');
                });
        }
    }
    
    function deleteService(serviceId) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        if (confirm('Are you sure you want to delete this service record?')) {
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('services').doc(serviceId).delete()
                .then(() => {
                    console.log('Service deleted successfully');
                    showNotification('Service deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting service: ', error);
                    showNotification('Error deleting service: ' + error.message, 'error');
                });
        }
    }
    
    function deleteTrip(tripId) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        if (confirm('Are you sure you want to delete this trip?')) {
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('trips').doc(tripId).delete()
                .then(() => {
                    console.log('Trip deleted successfully');
                    showNotification('Trip deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting trip: ', error);
                    showNotification('Error deleting trip: ' + error.message, 'error');
                });
        }
    }
    
    function deleteFuelPrice(priceId) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        if (confirm('Are you sure you want to delete this fuel price record?')) {
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('fuelPrices').doc(priceId).delete()
                .then(() => {
                    console.log('Fuel price deleted successfully');
                    showNotification('Fuel price deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting fuel price: ', error);
                    showNotification('Error deleting fuel price: ' + error.message, 'error');
                });
        }
    }
    
    function deleteBudget(budgetId) {
        const user = auth.currentUser;
        if (!user || !selectedVehicleId) return;
        
        if (confirm('Are you sure you want to delete this budget?')) {
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('budgets').doc(budgetId).delete()
                .then(() => {
                    console.log('Budget deleted successfully');
                    showNotification('Budget deleted successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error deleting budget: ', error);
                    showNotification('Error deleting budget: ' + error.message, 'error');
                });
        }
    }
    
    // Edit Functions
    function editExpense(expenseId) {
        const expense = expenses.find(e => e.id === expenseId);
        if (!expense) return;
        
        document.getElementById('expense-type').value = expense.type;
        document.getElementById('expense-amount').value = expense.amount;
        document.getElementById('expense-date').value = expense.date;
        document.getElementById('expense-odometer').value = expense.odometer || '';
        document.getElementById('expense-notes').value = expense.notes || '';
        document.getElementById('expense-fuel-volume').value = expense.fuelVolume || '';
        document.getElementById('expense-id').value = expenseId;
        expenseSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Expense';
        expenseType.dispatchEvent(new Event('change'));
        expenseForm.scrollIntoView({behavior: 'smooth'});
    }
    
    function editService(serviceId) {
        const service = services.find(s => s.id === serviceId);
        if (!service) return;
        
        document.getElementById('service-type').value = service.type;
        document.getElementById('service-date').value = service.date;
        document.getElementById('service-odometer').value = service.odometer;
        document.getElementById('service-cost').value = service.cost;
        document.getElementById('service-days-interval').value = service.nextServiceDays || '';
        document.getElementById('service-km-interval').value = service.nextServiceKm || '';
        document.getElementById('service-details').value = service.details || '';
        document.getElementById('service-id').value = serviceId;
        serviceModalTitle.textContent = 'Edit Service Record';
        serviceSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Service';
        addServiceModal.style.display = 'flex';
    }
    
    function editTrip(tripId) {
        const trip = trips.find(t => t.id === tripId);
        if (!trip) return;
        
        document.getElementById('trip-date').value = trip.date;
        document.getElementById('trip-input-type').value = 'odometer';
        document.getElementById('trip-start-odometer').value = trip.startOdometer;
        document.getElementById('trip-end-odometer').value = trip.endOdometer;
        document.getElementById('trip-start').value = trip.startLocation;
        document.getElementById('trip-end').value = trip.endLocation;
        document.getElementById('trip-purpose').value = trip.purpose || '';
        document.getElementById('trip-id').value = tripId;
        tripSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Trip';
        const label = document.querySelector('label[for="trip-end-odometer"]');
        label.textContent = 'End Odometer (km)';
        tripForm.scrollIntoView({behavior: 'smooth'});
    }
    
    // Calculator Functions
    function calculateTripCost() {
        const distance = parseFloat(document.getElementById('planner-distance').value);
        const fuelPrice = parseFloat(document.getElementById('planner-fuel-price').value);
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        
        if (!distance || !fuelPrice || !vehicle) {
            showNotification('Please enter distance and fuel price', 'warning');
            return;
        }
        
        // Calculate fuel cost based on average mileage
        const avgMileage = mileageRecords.length > 0 ? 
            mileageRecords.reduce((sum, record) => sum + record.mileage, 0) / mileageRecords.length : 10;
        
        const fuelNeeded = distance / avgMileage;
        const fuelCost = fuelNeeded * fuelPrice;
        
        // Calculate maintenance cost (estimated 0.05 per km)
        const maintenanceCost = distance * 0.05;
        
        // Calculate other costs (tolls, parking, etc.)
        const otherCosts = distance * 0.02;
        
        const totalCost = fuelCost + maintenanceCost + otherCosts;
        
        document.getElementById('estimate-fuel').textContent = `$${fuelCost.toFixed(2)}`;
        document.getElementById('estimate-maintenance').textContent = `$${maintenanceCost.toFixed(2)}`;
        document.getElementById('estimate-other').textContent = `$${otherCosts.toFixed(2)}`;
        document.getElementById('estimate-total').textContent = `$${totalCost.toFixed(2)}`;
        
        tripEstimate.style.display = 'block';
    }
    
    function calculateCarbonFootprint() {
        const distance = parseFloat(document.getElementById('carbon-distance').value);
        const fuelType = document.getElementById('carbon-fuel-type').value;
        const efficiency = parseFloat(document.getElementById('carbon-efficiency').value);
        
        if (!distance || !efficiency) {
            showNotification('Please enter distance and fuel efficiency', 'warning');
            return;
        }
        
        // Carbon emission factors (kg CO2 per liter)
        const emissionFactors = {
            'petrol': 2.31,
            'diesel': 2.68,
            'electric': 0.05 // kg CO2 per kWh (average grid electricity)
        };
        
        let carbonEmissions;
        if (fuelType === 'electric') {
            // For electric vehicles, assume 0.2 kWh per km
            const energyUsed = distance * 0.2;
            carbonEmissions = energyUsed * emissionFactors[fuelType];
        } else {
            const fuelUsed = distance / efficiency;
            carbonEmissions = fuelUsed * emissionFactors[fuelType];
        }
        
        // Comparisons
        const treesNeeded = carbonEmissions / 21.77; // Average tree absorbs 21.77 kg CO2 per year
        const phoneCharges = carbonEmissions / 0.008; // Average phone charge produces 0.008 kg CO2
        
        document.getElementById('carbon-value').textContent = `${carbonEmissions.toFixed(2)} kg CO`;
        document.getElementById('carbon-comparison').innerHTML = `
            This is equivalent to:<br>
             ${treesNeeded.toFixed(1)} trees needed to absorb this carbon in a year<br>
             ${phoneCharges.toFixed(0)} smartphone charges
        `;
        
        carbonResult.style.display = 'block';
    }
    
    function calculateVehicleValuation() {
        const purchasePrice = parseFloat(document.getElementById('vehicle-purchase-price').value);
        const purchaseYear = parseInt(document.getElementById('vehicle-purchase-year').value);
        const currentYear = parseInt(document.getElementById('vehicle-current-year').value);
        const condition = document.getElementById('vehicle-condition').value;
        
        if (!purchasePrice || !purchaseYear || !currentYear) {
            showNotification('Please enter all required fields', 'warning');
            return;
        }
        
        const age = currentYear - purchaseYear;
        
        // Depreciation factors based on condition
        const conditionFactors = {
            'excellent': 0.85,
            'good': 0.75,
            'fair': 0.60,
            'poor': 0.40
        };
        
        // Calculate depreciation (15% first year, 10% subsequent years)
        let currentValue = purchasePrice;
        if (age > 0) {
            // First year depreciation
            currentValue *= 0.85;
            // Subsequent years
            for (let i = 1; i < age; i++) {
                currentValue *= 0.90;
            }
        }
        
        // Apply condition factor
        currentValue *= conditionFactors[condition];
        
        const totalDepreciation = purchasePrice - currentValue;
        const depreciationPercentage = ((totalDepreciation / purchasePrice) * 100).toFixed(1);
        
        document.getElementById('valuation-value').textContent = `$${currentValue.toFixed(0)}`;
        document.getElementById('valuation-comparison').innerHTML = `
            Vehicle Details:<br>
             Original Price: $${purchasePrice.toFixed(2)}<br>
             Total Depreciation: $${totalDepreciation.toFixed(2)} (${depreciationPercentage}%)<br>
             Vehicle Age: ${age} years<br>
             Condition: ${condition.charAt(0).toUpperCase() + condition.slice(1)}
        `;
        
        valuationResult.style.display = 'block';
    }
    
    // PDF Export Function
    function exportReportToPDF() {
        const reportType = reportTypeSelect.value;
        const month = parseInt(document.getElementById('report-month').value);
        const year = parseInt(document.getElementById('report-year').value);
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        
        let filteredExpenses = [];
        let reportTitle = '';
        
        if (reportType === 'monthly') {
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === month && 
                       expenseDate.getFullYear() === year;
            });
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            reportTitle = `${monthNames[month-1]} ${year} Expense Report`;
        } else if (reportType === 'category') {
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getFullYear() === year;
            });
            reportTitle = `${year} Expense Report by Category`;
        } else if (reportType === 'custom' && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= start && expenseDate <= end;
            });
            reportTitle = `Expense Report from ${formatDate(startDate)} to ${formatDate(endDate)}`;
        }
        
        if (filteredExpenses.length === 0) {
            showNotification('No data to export for the selected criteria', 'warning');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(18);
        doc.text(reportTitle, 20, 20);
        
        // Add vehicle info
        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        if (vehicle) {
            doc.setFontSize(12);
            doc.text(`Vehicle: ${vehicle.name} (${vehicle.model || 'No model'})`, 20, 35);
            doc.text(`Report generated on: ${new Date().toLocaleDateString()}`, 20, 45);
        }
        
        // Calculate summary data
        let totalAmount = 0;
        const byCategory = {};
        
        filteredExpenses.forEach(expense => {
            totalAmount += expense.amount;
            if (!byCategory[expense.type]) {
                byCategory[expense.type] = 0;
            }
            byCategory[expense.type] += expense.amount;
        });
        
        // Add summary
        doc.setFontSize(14);
        doc.text('Summary', 20, 65);
        doc.setFontSize(10);
        doc.text(`Total Expenses: $${totalAmount.toFixed(2)}`, 20, 75);
        doc.text(`Number of Expenses: ${filteredExpenses.length}`, 20, 85);
        doc.text(`Average Expense: $${(totalAmount / filteredExpenses.length).toFixed(2)}`, 20, 95);
        
        // Add category breakdown
        let yPos = 115;
        doc.setFontSize(14);
        doc.text('Expenses by Category', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        for (const category in byCategory) {
            const percentage = ((byCategory[category] / totalAmount) * 100).toFixed(1);
            doc.text(`${formatExpenseType(category)}: $${byCategory[category].toFixed(2)} (${percentage}%)`, 20, yPos);
            yPos += 7;
            
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
        }
        
        // Add expense details table
        yPos += 10;
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Expense Details', 20, yPos);
        yPos += 10;
        
        // Create table data
        const tableData = [];
        tableData.push(['Date', 'Type', 'Amount', 'Odometer', 'Notes']);
        
        filteredExpenses.forEach(expense => {
            tableData.push([
                formatDate(expense.date),
                formatExpenseType(expense.type),
                `$${expense.amount.toFixed(2)}`,
                expense.odometer || '-',
                expense.notes || '-'
            ]);
        });
        
        // Add table
        doc.autoTable({
            startY: yPos,
            head: [tableData[0]],
            body: tableData.slice(1),
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [99, 102, 241] }
        });
        
        // Save the PDF
        doc.save(`${reportTitle.replace(/\s+/g, '_')}.pdf`);
        showNotification('PDF report downloaded successfully!', 'success');
    }
    
    // Initialize the app
    init();
</script>