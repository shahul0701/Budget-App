<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Manager & Travel Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #0ea5e9;
            --accent: #0ea5a4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --muted: #64748b;
            --border: #e2e8f0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: background 0.2s;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.4rem;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 600px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .sidebar {
            background: var(--light);
            padding: 20px;
            border-right: 1px solid var(--border);
        }
        
        .vehicle-list {
            margin-top: 15px;
        }
        
        .vehicle-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .vehicle-card.active {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .vehicle-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
        }
        
        .vehicle-info h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .vehicle-info p {
            font-size: 0.85rem;
            color: var(--muted);
        }
        
        .add-vehicle-btn {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .add-vehicle-btn:hover {
            background: #0da271;
        }
        
        .content-area {
            padding: 20px;
            background: white;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-card .unit {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 16px;
            background: var(--light);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            border: 1px solid var(--border);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .expense-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .input-group input, .input-group select, .input-group textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #0da271;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .history-table th {
            background: var(--light);
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background: #f8fafc;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
        }
        
        .delete-btn {
            color: var(--danger);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: var(--light);
            color: var(--muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
        }
        
        .no-vehicle {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }
        
        .no-vehicle i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border);
        }
        
        .chart-container {
            height: 300px;
            background: #f1f5f9;
            border-radius: 8px;
            margin: 20px 0;
            padding: 15px;
        }
        
        .report-section {
            margin: 20px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .report-controls select, .report-controls input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .report-results {
            margin-top: 20px;
        }
        
        .login-prompt {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }
        
        .login-prompt i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--border);
        }

        .service-reminder {
            background: var(--warning);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .service-reminder i {
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-car"></i>
                <span>Vehicle Manager Pro</span>
            </div>
            <div class="auth-section" id="auth-section">
                <div id="user-info" class="user-info" style="display: none;">
                    <span id="user-name"></span>
                    <button id="sign-out-btn" class="auth-btn">Sign Out</button>
                </div>
                <div id="auth-buttons">
                    <button id="sign-in-btn" class="auth-btn">Sign In</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <h2>My Vehicles</h2>
                <div class="vehicle-list" id="vehicle-list">
                    <!-- Vehicle cards will be added here dynamically -->
                </div>
                <button class="add-vehicle-btn" id="add-vehicle-btn">
                    <i class="fas fa-plus"></i> Add New Vehicle
                </button>
            </aside>
            
            <main class="content-area">
                <div id="login-prompt" class="login-prompt">
                    <i class="fas fa-user-lock"></i>
                    <h2>Please Sign In</h2>
                    <p>Sign in to access your vehicle data and reports.</p>
                    <button id="prompt-sign-in-btn" class="btn btn-primary" style="margin-top: 15px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                
                <div id="no-vehicle" class="no-vehicle" style="display: none;">
                    <i class="fas fa-car-side"></i>
                    <h2>No Vehicle Selected</h2>
                    <p>Select a vehicle from the list or add a new one to get started.</p>
                </div>
                
                <div id="vehicle-details" style="display: none;">
                    <div class="dashboard">
                        <div class="stat-card">
                            <h3>Total Distance</h3>
                            <div class="value" id="total-distance">0</div>
                            <div class="unit">kilometers</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Spent</h3>
                            <div class="value" id="total-spent">0</div>
                            <div class="unit">currency</div>
                        </div>
                        <div class="stat-card">
                            <h3>Average Mileage</h3>
                            <div class="value" id="avg-mileage">0</div>
                            <div class="unit">km/L</div>
                        </div>
                        <div class="stat-card">
                            <h3>Next Service</h3>
                            <div class="value" id="next-service">-</div>
                            <div class="unit">due</div>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="expenses">Expenses</div>
                        <div class="tab" data-tab="mileage">Mileage</div>
                        <div class="tab" data-tab="services">Services</div>
                        <div class="tab" data-tab="trips">Trips</div>
                        <div class="tab" data-tab="reports">Reports</div>
                    </div>
                    
                    <div class="panels">
                        <div class="panel active" id="expenses-panel">
                            <h3>Add New Expense</h3>
                            <form class="expense-form" id="expense-form">
                                <div class="input-group">
                                    <label for="expense-type">Expense Type</label>
                                    <select id="expense-type" required>
                                        <option value="">Select type</option>
                                        <option value="fuel">Fuel</option>
                                        <option value="service">Service</option>
                                        <option value="repair">Repair</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="expense-amount">Amount</label>
                                    <input type="number" id="expense-amount" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="input-group">
                                    <label for="expense-date">Date</label>
                                    <input type="date" id="expense-date" required>
                                </div>
                                <div class="input-group">
                                    <label for="expense-odometer">Odometer (km)</label>
                                    <input type="number" id="expense-odometer" placeholder="Current reading">
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <label for="expense-notes">Notes</label>
                                    <textarea id="expense-notes" rows="2" placeholder="Additional details"></textarea>
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Add Expense
                                    </button>
                                </div>
                            </form>
                            
                            <h3>Expense History</h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Odometer</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-history">
                                    <!-- Expense history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="panel" id="mileage-panel">
                            <h3>Mileage Tracking</h3>
                            <p>Track your vehicle's fuel efficiency over time.</p>
                            <div id="mileage-chart" class="chart-container">
                                <!-- Mileage chart will be displayed here -->
                            </div>
                            
                            <h3>Mileage Records</h3>
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Distance (km)</th>
                                        <th>Fuel (L)</th>
                                        <th>Mileage (km/L)</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="mileage-history">
                                    <!-- Mileage history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="panel" id="services-panel">
                            <h3>Service History</h3>
                            <p>Keep track of all services and repairs for your vehicle.</p>
                            <div id="service-reminder" class="service-reminder" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="service-reminder-text"></span>
                            </div>
                            <button class="btn btn-primary" id="add-service-btn" style="margin: 15px 0;">
                                <i class="fas fa-plus"></i> Add Service Record
                            </button>
                            
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service Type</th>
                                        <th>Odometer</th>
                                        <th>Cost</th>
                                        <th>Details</th>
                                        <th>Next Service</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="service-history">
                                    <!-- Service history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="panel" id="trips-panel">
                            <h3>Trip Log</h3>
                            <p>Record your journeys and track travel expenses.</p>
                            
                            <form id="trip-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                                <div class="input-group">
                                    <label for="trip-date">Date</label>
                                    <input type="date" id="trip-date" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-distance">Distance (km)</label>
                                    <input type="number" id="trip-distance" step="0.1" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-start">Start Location</label>
                                    <input type="text" id="trip-start" required>
                                </div>
                                <div class="input-group">
                                    <label for="trip-end">End Location</label>
                                    <input type="text" id="trip-end" required>
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <label for="trip-purpose">Purpose</label>
                                    <input type="text" id="trip-purpose">
                                </div>
                                <div class="input-group" style="grid-column: span 2;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Add Trip
                                    </button>
                                </div>
                            </form>
                            
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Route</th>
                                        <th>Distance</th>
                                        <th>Purpose</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trip-history">
                                    <!-- Trip history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="panel" id="reports-panel">
                            <h3>Reports</h3>
                            <p>Generate detailed reports for your vehicle expenses and usage.</p>
                            
                            <div class="report-section">
                                <h4>Expense Report</h4>
                                <div class="report-controls">
                                    <select id="report-type">
                                        <option value="monthly">Monthly Summary</option>
                                        <option value="category">By Category</option>
                                        <option value="custom">Custom Date Range</option>
                                    </select>
                                    
                                    <select id="report-month">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                    
                                    <select id="report-year">
                                        <!-- Years will be populated dynamically -->
                                    </select>
                                    
                                    <button id="generate-report-btn" class="btn btn-primary">
                                        <i class="fas fa-chart-bar"></i> Generate Report
                                    </button>
                                    
                                    <button id="export-report-btn" class="btn btn-success">
                                        <i class="fas fa-download"></i> Export to PDF
                                    </button>
                                </div>
                                
                                <div id="expense-chart" class="chart-container">
                                    <!-- Expense chart will be displayed here -->
                                </div>
                                
                                <div class="report-results" id="report-results">
                                    <!-- Report results will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer>
            <p>Vehicle Manager Pro &copy; 2023 - Track all your vehicles in one place</p>
        </footer>
    </div>
    
    <!-- Add Vehicle Modal -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Vehicle</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="vehicle-form">
                <div class="input-group">
                    <label for="vehicle-name">Vehicle Name</label>
                    <input type="text" id="vehicle-name" placeholder="e.g., My Honda City" required>
                </div>
                <div class="input-group">
                    <label for="vehicle-type">Vehicle Type</label>
                    <select id="vehicle-type" required>
                        <option value="">Select type</option>
                        <option value="car">Car</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="suv">SUV</option>
                        <option value="truck">Truck</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="vehicle-model">Model</label>
                    <input type="text" id="vehicle-model" placeholder="e.g., Honda City">
                </div>
                <div class="input-group">
                    <label for="vehicle-year">Year</label>
                    <input type="number" id="vehicle-year" min="1950" max="2030" placeholder="e.g., 2020">
                </div>
                <div class="input-group">
                    <label for="initial-odometer">Current Odometer (km)</label>
                    <input type="number" id="initial-odometer" placeholder="Current reading">
                </div>
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Service Modal -->
    <div class="modal" id="add-service-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Service Record</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="service-form">
                <div class="input-group">
                    <label for="service-type">Service Type</label>
                    <select id="service-type" required>
                        <option value="">Select type</option>
                        <option value="oil_change">Oil Change</option>
                        <option value="tire_rotation">Tire Rotation</option>
                        <option value="brake_service">Brake Service</option>
                        <option value="filter_replacement">Filter Replacement</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="service-date">Date</label>
                    <input type="date" id="service-date" required>
                </div>
                <div class="input-group">
                    <label for="service-odometer">Odometer (km)</label>
                    <input type="number" id="service-odometer" placeholder="Current reading" required>
                </div>
                <div class="input-group">
                    <label for="service-cost">Cost</label>
                    <input type="number" id="service-cost" step="0.01" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label for="service-days-interval">Next Service Interval (days)</label>
                    <input type="number" id="service-days-interval" placeholder="e.g., 180" min="0">
                </div>
                <div class="input-group">
                    <label for="service-km-interval">Next Service Interval (km)</label>
                    <input type="number" id="service-km-interval" placeholder="e.g., 5000" min="0">
                </div>
                <div class="input-group">
                    <label for="service-details">Details</label>
                    <textarea id="service-details" rows="3" placeholder="Service details"></textarea>
                </div>
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart']});
        
        let vehicles = [];
        let selectedVehicleId = null;
        let expenses = [];
        let services = [];
        let trips = [];
        let mileageRecords = [];
        
        // DOM Elements
        const vehicleList = document.getElementById('vehicle-list');
        const noVehicle = document.getElementById('no-vehicle');
        const vehicleDetails = document.getElementById('vehicle-details');
        const loginPrompt = document.getElementById('login-prompt');
        const addVehicleBtn = document.getElementById('add-vehicle-btn');
        const addVehicleModal = document.getElementById('add-vehicle-modal');
        const addServiceModal = document.getElementById('add-service-modal');
        const addServiceBtn = document.getElementById('add-service-btn');
        const closeModals = document.querySelectorAll('.close-modal');
        const vehicleForm = document.getElementById('vehicle-form');
        const serviceForm = document.getElementById('service-form');
        const tabs = document.querySelectorAll('.tab');
        const panels = document.querySelectorAll('.panel');
        const expenseForm = document.getElementById('expense-form');
        const tripForm = document.getElementById('trip-form');
        const expenseHistory = document.getElementById('expense-history');
        const serviceHistory = document.getElementById('service-history');
        const tripHistory = document.getElementById('trip-history');
        const mileageHistory = document.getElementById('mileage-history');
        const signInBtn = document.getElementById('sign-in-btn');
        const promptSignInBtn = document.getElementById('prompt-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const exportReportBtn = document.getElementById('export-report-btn');
        const reportResults = document.getElementById('report-results');
        const serviceReminder = document.getElementById('service-reminder');
        const serviceReminderText = document.getElementById('service-reminder-text');
        
        // Initialize the app
        function init() {
            setupEventListeners();
            setCurrentDate();
            populateYearDropdown();
            initAuth();
        }
        
        // Initialize authentication
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    userInfo.style.display = 'flex';
                    document.getElementById('auth-buttons').style.display = 'none';
                    userName.textContent = user.displayName || user.email;
                    loginPrompt.style.display = 'none';
                    
                    // Load user data
                    loadUserData();
                } else {
                    // User is signed out
                    userInfo.style.display = 'none';
                    document.getElementById('auth-buttons').style.display = 'block';
                    loginPrompt.style.display = 'block';
                    vehicleDetails.style.display = 'none';
                    noVehicle.style.display = 'none';
                    
                    // Clear data
                    vehicles = [];
                    selectedVehicleId = null;
                    renderVehicles();
                }
            });
        }
        
        // Sign in with Google
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    console.log('Signed in successfully:', result.user);
                })
                .catch(error => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }
        
        // Sign out
        function signOut() {
            auth.signOut()
                .then(() => {
                    console.log('Signed out successfully');
                })
                .catch(error => {
                    console.error('Sign out error:', error);
                });
        }
        
        // Load user data from Firestore
        function loadUserData() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Load vehicles
            db.collection('users').doc(user.uid).collection('vehicles')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    vehicles = [];
                    snapshot.forEach(doc => {
                        vehicles.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderVehicles();
                    
                    // If a vehicle was previously selected, try to select it again
                    if (selectedVehicleId) {
                        const vehicleExists = vehicles.some(v => v.id === selectedVehicleId);
                        if (vehicleExists) {
                            selectVehicle(selectedVehicleId);
                        } else {
                            selectedVehicleId = null;
                            noVehicle.style.display = 'block';
                            vehicleDetails.style.display = 'none';
                        }
                    }
                }, error => {
                    console.error('Error loading vehicles:', error);
                });
        }
        
        // Load expenses for selected vehicle
        function loadExpenses(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('expenses')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    expenses = [];
                    snapshot.forEach(doc => {
                        expenses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderExpenseHistory();
                    updateVehicleDashboard();
                }, error => {
                    console.error('Error loading expenses:', error);
                });
        }
        
        // Load services for selected vehicle
        function loadServices(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('services')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    services = [];
                    snapshot.forEach(doc => {
                        services.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderServiceHistory();
                    updateVehicleDashboard();
                    checkServiceReminders();
                }, error => {
                    console.error('Error loading services:', error);
                });
        }
        
        // Load trips for selected vehicle
        function loadTrips(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('trips')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    trips = [];
                    snapshot.forEach(doc => {
                        trips.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderTripHistory();
                }, error => {
                    console.error('Error loading trips:', error);
                });
        }
        
        // Load mileage records for selected vehicle
        function loadMileageRecords(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('mileageRecords')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    mileageRecords = [];
                    snapshot.forEach(doc => {
                        mileageRecords.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderMileageHistory();
                    drawMileageChart();
                }, error => {
                    console.error('Error loading mileage records:', error);
                });
        }
        
        // Render vehicle list
        function renderVehicles() {
            vehicleList.innerHTML = '';
            
            if (vehicles.length === 0) {
                vehicleList.innerHTML = '<p>No vehicles added yet.</p>';
                return;
            }
            
            vehicles.forEach(vehicle => {
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card';
                if (vehicle.id === selectedVehicleId) {
                    vehicleCard.classList.add('active');
                }
                
                vehicleCard.innerHTML = `
                    <div class="vehicle-icon">
                        <i class="fas ${getVehicleIcon(vehicle.type)}"></i>
                    </div>
                    <div class="vehicle-info">
                        <h3>${vehicle.name}</h3>
                        <p>${vehicle.model || 'No model'} â€¢ ${vehicle.odometer} km</p>
                    </div>
                `;
                
                vehicleCard.addEventListener('click', () => selectVehicle(vehicle.id));
                vehicleList.appendChild(vehicleCard);
            });
        }
        
        // Get appropriate icon for vehicle type
        function getVehicleIcon(type) {
            switch(type) {
                case 'car': return 'fa-car';
                case 'motorcycle': return 'fa-motorcycle';
                case 'suv': return 'fa-truck-monster';
                case 'truck': return 'fa-truck';
                default: return 'fa-vehicle';
            }
        }
        
        // Select a vehicle
        function selectVehicle(vehicleId) {
            selectedVehicleId = vehicleId;
            renderVehicles();
            
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                noVehicle.style.display = 'none';
                vehicleDetails.style.display = 'block';
                
                // Load vehicle-specific data
                loadExpenses(vehicleId);
                loadServices(vehicleId);
                loadTrips(vehicleId);
                loadMileageRecords(vehicleId);
            }
        }
        
        // Update dashboard with vehicle stats
        function updateVehicleDashboard() {
            const vehicle = vehicles.find(v => v.id === selectedVehicleId);
            if (!vehicle) return;
            
            // Calculate total spent
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('total-spent').textContent = totalSpent.toFixed(2);
            
            // Calculate average mileage
            if (mileageRecords.length > 0) {
                const totalMileage = mileageRecords.reduce((sum, record) => {
                    if (record.distance && record.fuelAmount && record.fuelAmount > 0) {
                        return sum + (record.distance / record.fuelAmount);
                    }
                    return sum;
                }, 0);
                const avgMileage = totalMileage / mileageRecords.length;
                document.getElementById('avg-mileage').textContent = avgMileage.toFixed(1);
            } else {
                document.getElementById('avg-mileage').textContent = '0.0';
            }
            
            // Update odometer (use the highest value from expenses or the vehicle's odometer)
            let maxOdometer = vehicle.odometer;
            expenses.forEach(expense => {
                if (expense.odometer > maxOdometer) {
                    maxOdometer = expense.odometer;
                }
            });
            services.forEach(service => {
                if (service.odometer > maxOdometer) {
                    maxOdometer = service.odometer;
                }
            });
            
            document.getElementById('total-distance').textContent = maxOdometer;

            // Calculate next service due
            let nextServiceText = '-';
            if (services.length > 0) {
                const latestService = services[0];
                let dueByDate = '';
                let dueByKm = '';

                if (latestService.nextServiceDays) {
                    const serviceDate = new Date(latestService.date);
                    const nextServiceDate = new Date(serviceDate.getTime() + latestService.nextServiceDays * 24 * 60 * 60 * 1000);
                    dueByDate = `Due by ${formatDate(nextServiceDate)}`;
                }
                if (latestService.nextServiceKm) {
                    const nextServiceKm = latestService.odometer + latestService.nextServiceKm;
                    dueByKm = ` or ${nextServiceKm} km`;
                }
                nextServiceText = dueByDate + dueByKm;
            }
            document.getElementById('next-service').textContent = nextServiceText;
        }

        // Check service reminders
        function checkServiceReminders() {
            if (!services.length) {
                serviceReminder.style.display = 'none';
                return;
            }

            const latestService = services[0];
            const vehicle = vehicles.find(v => v.id === selectedVehicleId);
            if (!vehicle || !latestService) return;

            let maxOdometer = vehicle.odometer;
            expenses.forEach(expense => {
                if (expense.odometer > maxOdometer) {
                    maxOdometer = expense.odometer;
                }
            });
            services.forEach(service => {
                if (service.odometer > maxOdometer) {
                    maxOdometer = service.odometer;
                }
            });

            const today = new Date();
            let reminderText = '';
            let isDue = false;

            if (latestService.nextServiceDays) {
                const serviceDate = new Date(latestService.date);
                const daysSince = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
                if (daysSince >= latestService.nextServiceDays) {
                    reminderText += `Service due: ${daysSince - latestService.nextServiceDays} days overdue. `;
                    isDue = true;
                }
            }

            if (latestService.nextServiceKm) {
                const kmDriven = maxOdometer - latestService.odometer;
                if (kmDriven >= latestService.nextServiceKm) {
                    reminderText += `Service due: ${kmDriven - latestService.nextServiceKm} km over limit.`;
                    isDue = true;
                }
            }

            if (isDue) {
                serviceReminderText.textContent = reminderText;
                serviceReminder.style.display = 'flex';
            } else {
                serviceReminder.style.display = 'none';
            }
        }
        
        // Render expense history
        function renderExpenseHistory() {
            expenseHistory.innerHTML = '';
            
            if (expenses.length === 0) {
                expenseHistory.innerHTML = '<tr><td colspan="6" style="text-align: center;">No expenses recorded yet</td></tr>';
                return;
            }
            
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td>${expense.type}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td>${expense.odometer || '-'}</td>
                    <td>${expense.notes || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editExpense('${expense.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteExpense('${expense.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                expenseHistory.appendChild(row);
            });
        }
        
        // Render service history
        function renderServiceHistory() {
            serviceHistory.innerHTML = '';
            
            if (services.length === 0) {
                serviceHistory.innerHTML = '<tr><td colspan="7" style="text-align: center;">No services recorded yet</td></tr>';
                return;
            }
            
            services.forEach(service => {
                const nextService = [];
                if (service.nextServiceDays) {
                    const serviceDate = new Date(service.date);
                    const nextServiceDate = new Date(serviceDate.getTime() + service.nextServiceDays * 24 * 60 * 60 * 1000);
                    nextService.push(formatDate(nextServiceDate));
                }
                if (service.nextServiceKm) {
                    nextService.push(`${service.odometer + service.nextServiceKm} km`);
                }
                const nextServiceText = nextService.length > 0 ? nextService.join(' or ') : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(service.date)}</td>
                    <td>${service.type}</td>
                    <td>${service.odometer}</td>
                    <td>${service.cost.toFixed(2)}</td>
                    <td>${service.details || '-'}</td>
                    <td>${nextServiceText}</td>
                    <td>
                        <button class="action-btn" onclick="editService('${service.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteService('${service.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                serviceHistory.appendChild(row);
            });
        }
        
        // Render trip history
        function renderTripHistory() {
            tripHistory.innerHTML = '';
            
            if (trips.length === 0) {
                tripHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No trips recorded yet</td></tr>';
                return;
            }
            
            trips.forEach(trip => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(trip.date)}</td>
                    <td>${trip.startLocation} to ${trip.endLocation}</td>
                    <td>${trip.distance} km</td>
                    <td>${trip.purpose || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editTrip('${trip.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteTrip('${trip.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tripHistory.appendChild(row);
            });
        }
        
        // Render mileage history
        function renderMileageHistory() {
            mileageHistory.innerHTML = '';
            
            if (mileageRecords.length === 0) {
                mileageHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No mileage records yet</td></tr>';
                return;
            }
            
            mileageRecords.forEach(record => {
                const mileage = record.fuelAmount > 0 ? (record.distance / record.fuelAmount).toFixed(1) : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.distance}</td>
                    <td>${record.fuelAmount}</td>
                    <td>${mileage}</td>
                    <td>${record.cost ? record.cost.toFixed(2) : '-'}</td>
                `;
                mileageHistory.appendChild(row);
            });
        }
        
        // Draw mileage chart
        function drawMileageChart() {
            if (mileageRecords.length === 0) {
                document.getElementById('mileage-chart').innerHTML = '<p>No mileage data available for chart</p>';
                return;
            }
            
            const data = new google.visualization.DataTable();
            data.addColumn('date', 'Date');
            data.addColumn('number', 'Mileage (km/L)');
            
            const chartData = mileageRecords
                .filter(record => record.fuelAmount > 0)
                .map(record => {
                    const mileage = record.distance / record.fuelAmount;
                    return [new Date(record.date), mileage];
                });
            
            data.addRows(chartData);
            
            const options = {
                title: 'Fuel Efficiency Over Time',
                curveType: 'function',
                legend: { position: 'bottom' },
                hAxis: {
                    title: 'Date',
                    format: 'MMM yyyy'
                },
                vAxis: {
                    title: 'Mileage (km/L)'
                }
            };
            
            const chart = new google.visualization.LineChart(document.getElementById('mileage-chart'));
            chart.draw(data, options);
        }
        
        // Generate expense report
        function generateExpenseReport() {
            const reportType = document.getElementById('report-type').value;
            const month = document.getElementById('report-month').value;
            const year = document.getElementById('report-year').value;
            
            let filteredExpenses = [];
            
            if (reportType === 'monthly') {
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() + 1 === parseInt(month) && 
                           expenseDate.getFullYear() === parseInt(year);
                });
            } else if (reportType === 'category') {
                // Group by category for the selected year
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === parseInt(year);
                });
            } else if (reportType === 'custom') {
                // For custom date range, you would need to add date inputs
                // This is a simplified version using the selected month/year
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() + 1 === parseInt(month) && 
                           expenseDate.getFullYear() === parseInt(year);
                });
            }
            
            // Display report results
            if (filteredExpenses.length === 0) {
                reportResults.innerHTML = '<p>No expenses found for the selected criteria.</p>';
                return;
            }
            
            let totalAmount = 0;
            const byCategory = {};
            
            filteredExpenses.forEach(expense => {
                totalAmount += expense.amount;
                
                if (!byCategory[expense.type]) {
                    byCategory[expense.type] = 0;
                }
                byCategory[expense.type] += expense.amount;
            });
            
            let html = `
                <h4>Expense Report Summary</h4>
                <p>Total Expenses: $${totalAmount.toFixed(2)}</p>
                <p>Number of Expenses: ${filteredExpenses.length}</p>
                
                <h4>Expenses by Category</h4>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const category in byCategory) {
                const percentage = ((byCategory[category] / totalAmount) * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${category}</td>
                        <td>$${byCategory[category].toFixed(2)}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            reportResults.innerHTML = html;
            
            // Draw chart
            drawExpenseChart(byCategory);
        }
        
        // Draw expense chart
        function drawExpenseChart(byCategory) {
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Category');
            data.addColumn('number', 'Amount');
            
            for (const category in byCategory) {
                data.addRow([category, byCategory[category]]);
            }
            
            const options = {
                title: 'Expenses by Category',
                is3D: true,
                pieSliceText: 'value',
                sliceVisibilityThreshold: 0.01
            };
            
            const chart = new google.visualization.PieChart(document.getElementById('expense-chart'));
            chart.draw(data, options);
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Set current date in date fields
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            document.getElementById('service-date').value = today;
            document.getElementById('trip-date').value = today;
        }
        
        // Populate year dropdown for reports
        function populateYearDropdown() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
            
            // Set current month
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('report-month').value = currentMonth;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Auth buttons
            signInBtn.addEventListener('click', signIn);
            promptSignInBtn.addEventListener('click', signIn);
            signOutBtn.addEventListener('click', signOut);
            
            // Add vehicle button
            addVehicleBtn.addEventListener('click', () => {
                addVehicleModal.style.display = 'flex';
            });
            
            // Add service button
            addServiceBtn.addEventListener('click', () => {
                addServiceModal.style.display = 'flex';
            });
            
            // Close modals
            closeModals.forEach(closeBtn => {
                closeBtn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Vehicle form submission
            vehicleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewVehicle();
            });
            
            // Service form submission
            serviceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewService();
            });
            
            // Expense form submission
            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewExpense();
            });
            
            // Trip form submission
            tripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewTrip();
            });
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                    
                    // Load charts when relevant tabs are selected
                    if (tabName === 'mileage') {
                        google.charts.setOnLoadCallback(drawMileageChart);
                    } else if (tabName === 'reports') {
                        google.charts.setOnLoadCallback(() => {
                            generateExpenseReport();
                        });
                    }
                });
            });
            
            // Report generation
            generateReportBtn.addEventListener('click', () => {
                generateExpenseReport();
            });
            
            // Export report
            exportReportBtn.addEventListener('click', () => {
                alert('PDF export functionality would be implemented here. This could use a library like jsPDF.');
            });
            
            // Close modal if clicked outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }
        
        // Switch between tabs
        function switchTab(tabName) {
            // Update active tab
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Show active panel
            panels.forEach(panel => {
                if (panel.id === `${tabName}-panel`) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }
        
        // Add new vehicle
        function addNewVehicle() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in to add a vehicle');
                return;
            }
            
            const name = document.getElementById('vehicle-name').value;
            const type = document.getElementById('vehicle-type').value;
            const model = document.getElementById('vehicle-model').value;
            const year = document.getElementById('vehicle-year').value;
            const odometer = document.getElementById('initial-odometer').value || 0;
            
            const vehicleData = {
                name,
                type,
                model,
                year: year ? parseInt(year) : null,
                odometer: parseInt(odometer),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(user.uid).collection('vehicles').add(vehicleData)
                .then(docRef => {
                    console.log('Vehicle added with ID: ', docRef.id);
                    addVehicleModal.style.display = 'none';
                    vehicleForm.reset();
                    
                    // Select the new vehicle
                    selectVehicle(docRef.id);
                })
                .catch(error => {
                    console.error('Error adding vehicle: ', error);
                    alert('Error adding vehicle: ' + error.message);
                });
        }
        
        // Add new expense
        function addNewExpense() {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            const type = document.getElementById('expense-type').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            const odometer = document.getElementById('expense-odometer').value;
            const notes = document.getElementById('expense-notes').value;
            
            const expenseData = {
                type,
                amount,
                date,
                odometer: odometer ? parseInt(odometer) : null,
                notes,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('expenses').add(expenseData)
                .then(() => {
                    console.log('Expense added successfully');
                    expenseForm.reset();
                    setCurrentDate();
                    
                    // Update vehicle odometer if the new odometer is higher
                    if (odometer) {
                        const vehicleRef = db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId);
                        vehicleRef.get().then(doc => {
                            if (doc.exists) {
                                const vehicle = doc.data();
                                if (parseInt(odometer) > vehicle.odometer) {
                                    vehicleRef.update({
                                        odometer: parseInt(odometer),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error adding expense: ', error);
                    alert('Error adding expense: ' + error.message);
                });
        }
        
        // Add new service
        function addNewService() {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            const type = document.getElementById('service-type').value;
            const date = document.getElementById('service-date').value;
            const odometer = document.getElementById('service-odometer').value;
            const cost = parseFloat(document.getElementById('service-cost').value);
            const daysInterval = document.getElementById('service-days-interval').value;
            const kmInterval = document.getElementById('service-km-interval').value;
            const details = document.getElementById('service-details').value;
            
            const serviceData = {
                type,
                date,
                odometer: parseInt(odometer),
                cost,
                nextServiceDays: daysInterval ? parseInt(daysInterval) : null,
                nextServiceKm: kmInterval ? parseInt(kmInterval) : null,
                details,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('services').add(serviceData)
                .then(() => {
                    console.log('Service added successfully');
                    addServiceModal.style.display = 'none';
                    serviceForm.reset();
                    setCurrentDate();
                    
                    // Update vehicle odometer if the new odometer is higher
                    const vehicleRef = db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId);
                    vehicleRef.get().then(doc => {
                        if (doc.exists) {
                            const vehicle = doc.data();
                            if (parseInt(odometer) > vehicle.odometer) {
                                vehicleRef.update({
                                    odometer: parseInt(odometer),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error adding service: ', error);
                    alert('Error adding service: ' + error.message);
                });
        }
        
        // Add new trip
        function addNewTrip() {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            const date = document.getElementById('trip-date').value;
            const distance = parseFloat(document.getElementById('trip-distance').value);
            const startLocation = document.getElementById('trip-start').value;
            const endLocation = document.getElementById('trip-end').value;
            const purpose = document.getElementById('trip-purpose').value;
            
            const tripData = {
                date,
                distance,
                startLocation,
                endLocation,
                purpose,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('trips').add(tripData)
                .then(() => {
                    console.log('Trip added successfully');
                    tripForm.reset();
                    setCurrentDate();
                })
                .catch(error => {
                    console.error('Error adding trip: ', error);
                    alert('Error adding trip: ' + error.message);
                });
        }
        
        // Delete expense
        function deleteExpense(expenseId) {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            if (confirm('Are you sure you want to delete this expense?')) {
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('expenses').doc(expenseId).delete()
                    .then(() => {
                        console.log('Expense deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting expense: ', error);
                        alert('Error deleting expense: ' + error.message);
                    });
            }
        }
        
        // Delete service
        function deleteService(serviceId) {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            if (confirm('Are you sure you want to delete this service record?')) {
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('services').doc(serviceId).delete()
                    .then(() => {
                        console.log('Service deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting service: ', error);
                        alert('Error deleting service: ' + error.message);
                    });
            }
        }
        
        // Delete trip
        function deleteTrip(tripId) {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            if (confirm('Are you sure you want to delete this trip?')) {
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('trips').doc(tripId).delete()
                    .then(() => {
                        console.log('Trip deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting trip: ', error);
                        alert('Error deleting trip: ' + error.message);
                    });
            }
        }
        
        // Edit expense (placeholder function)
        function editExpense(expenseId) {
            alert('Edit functionality would be implemented here.');
        }
        
        // Edit service (placeholder function)
        function editService(serviceId) {
            alert('Edit functionality would be implemented here.');
        }
        
        // Edit trip (placeholder function)
        function editTrip(tripId) {
            alert('Edit functionality would be implemented here.');
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>
