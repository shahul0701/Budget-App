<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Manager & Travel Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        /* ... (previous CSS remains the same) ... */
        
        /* New styles for service reminders */
        .reminder-card {
            background: #fff8e6;
            border-left: 4px solid var(--warning);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .reminder-card h4 {
            color: var(--warning);
            margin-bottom: 8px;
        }
        
        .reminder-card p {
            margin-bottom: 5px;
        }
        
        .reminder-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .vehicle-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }
        
        .delete-vehicle-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-vehicle-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-car"></i>
                <span>Vehicle Manager Pro</span>
            </div>
            <div class="auth-section" id="auth-section">
                <div id="user-info" class="user-info" style="display: none;">
                    <span id="user-name"></span>
                    <button id="sign-out-btn" class="auth-btn">Sign Out</button>
                </div>
                <div id="auth-buttons">
                    <button id="sign-in-btn" class="auth-btn">Sign In</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <h2>My Vehicles</h2>
                <div class="vehicle-list" id="vehicle-list">
                    <!-- Vehicle cards will be added here dynamically -->
                </div>
                <button class="add-vehicle-btn" id="add-vehicle-btn">
                    <i class="fas fa-plus"></i> Add New Vehicle
                </button>
            </aside>
            
            <main class="content-area">
                <div id="login-prompt" class="login-prompt">
                    <i class="fas fa-user-lock"></i>
                    <h2>Please Sign In</h2>
                    <p>Sign in to access your vehicle data and reports.</p>
                    <button id="prompt-sign-in-btn" class="btn btn-primary" style="margin-top: 15px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                
                <div id="no-vehicle" class="no-vehicle" style="display: none;">
                    <i class="fas fa-car-side"></i>
                    <h2>No Vehicle Selected</h2>
                    <p>Select a vehicle from the list or add a new one to get started.</p>
                </div>
                
                <div id="vehicle-details" style="display: none;">
                    <div class="vehicle-actions">
                        <button class="btn btn-secondary" id="edit-vehicle-btn">
                            <i class="fas fa-edit"></i> Edit Vehicle
                        </button>
                        <button class="btn delete-vehicle-btn" id="delete-vehicle-btn">
                            <i class="fas fa-trash"></i> Delete Vehicle
                        </button>
                    </div>
                    
                    <div class="dashboard">
                        <div class="stat-card">
                            <h3>Total Distance</h3>
                            <div class="value" id="total-distance">0</div>
                            <div class="unit">kilometers</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Spent</h3>
                            <div class="value" id="total-spent">0</div>
                            <div class="unit">currency</div>
                        </div>
                        <div class="stat-card">
                            <h3>Average Mileage</h3>
                            <div class="value" id="avg-mileage">0</div>
                            <div class="unit">km/L</div>
                        </div>
                        <div class="stat-card">
                            <h3>Last Service</h3>
                            <div class="value" id="last-service">-</div>
                            <div class="unit">days ago</div>
                        </div>
                    </div>
                    
                    <!-- Service Reminders Section -->
                    <div id="service-reminders" style="margin-bottom: 20px;">
                        <!-- Service reminders will be added here dynamically -->
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="expenses">Expenses</div>
                        <div class="tab" data-tab="mileage">Mileage</div>
                        <div class="tab" data-tab="services">Services</div>
                        <div class="tab" data-tab="trips">Trips</div>
                        <div class="tab" data-tab="reports">Reports</div>
                    </div>
                    
                    <div class="panels">
                        <!-- ... (other panels remain the same) ... -->
                        
                        <div class="panel" id="services-panel">
                            <h3>Service History</h3>
                            <p>Keep track of all services and repairs for your vehicle.</p>
                            
                            <button class="btn btn-primary" id="add-service-btn" style="margin: 15px 0;">
                                <i class="fas fa-plus"></i> Add Service Record
                            </button>
                            
                            <div class="service-settings" style="margin-bottom: 20px;">
                                <h4>Service Reminder Settings</h4>
                                <form id="service-settings-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="input-group">
                                        <label for="service-interval-days">Remind me every (days)</label>
                                        <input type="number" id="service-interval-days" min="0" placeholder="e.g., 90 days">
                                    </div>
                                    <div class="input-group">
                                        <label for="service-interval-km">Remind me every (km)</label>
                                        <input type="number" id="service-interval-km" min="0" placeholder="e.g., 5000 km">
                                    </div>
                                    <div class="input-group" style="grid-column: span 2;">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Settings
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service Type</th>
                                        <th>Odometer</th>
                                        <th>Cost</th>
                                        <th>Details</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="service-history">
                                    <!-- Service history will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ... (other panels remain the same) ... -->
                    </div>
                </div>
            </main>
        </div>
        
        <footer>
            <p>Vehicle Manager Pro &copy; 2023 - Track all your vehicles in one place</p>
        </footer>
    </div>
    
    <!-- Add Vehicle Modal -->
    <div class="modal" id="add-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Vehicle</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="vehicle-form">
                <div class="input-group">
                    <label for="vehicle-name">Vehicle Name</label>
                    <input type="text" id="vehicle-name" placeholder="e.g., My Honda City" required>
                </div>
                <div class="input-group">
                    <label for="vehicle-type">Vehicle Type</label>
                    <select id="vehicle-type" required>
                        <option value="">Select type</option>
                        <option value="car">Car</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="suv">SUV</option>
                        <option value="truck">Truck</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="vehicle-model">Model</label>
                    <input type="text" id="vehicle-model" placeholder="e.g., Honda City">
                </div>
                <div class="input-group">
                    <label for="vehicle-year">Year</label>
                    <input type="number" id="vehicle-year" min="1950" max="2030" placeholder="e.g., 2020">
                </div>
                <div class="input-group">
                    <label for="initial-odometer">Current Odometer (km)</label>
                    <input type="number" id="initial-odometer" placeholder="Current reading">
                </div>
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Vehicle Modal -->
    <div class="modal" id="edit-vehicle-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Vehicle</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-vehicle-form">
                <div class="input-group">
                    <label for="edit-vehicle-name">Vehicle Name</label>
                    <input type="text" id="edit-vehicle-name" placeholder="e.g., My Honda City" required>
                </div>
                <div class="input-group">
                    <label for="edit-vehicle-type">Vehicle Type</label>
                    <select id="edit-vehicle-type" required>
                        <option value="">Select type</option>
                        <option value="car">Car</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="suv">SUV</option>
                        <option value="truck">Truck</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="edit-vehicle-model">Model</label>
                    <input type="text" id="edit-vehicle-model" placeholder="e.g., Honda City">
                </div>
                <div class="input-group">
                    <label for="edit-vehicle-year">Year</label>
                    <input type="number" id="edit-vehicle-year" min="1950" max="2030" placeholder="e.g., 2020">
                </div>
                <div class="input-group">
                    <label for="edit-odometer">Current Odometer (km)</label>
                    <input type="number" id="edit-odometer" placeholder="Current reading">
                </div>
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Vehicle
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Service Modal -->
    <div class="modal" id="add-service-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Service Record</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="service-form">
                <div class="input-group">
                    <label for="service-type">Service Type</label>
                    <select id="service-type" required>
                        <option value="">Select type</option>
                        <option value="oil_change">Oil Change</option>
                        <option value="tire_rotation">Tire Rotation</option>
                        <option value="brake_service">Brake Service</option>
                        <option value="filter_replacement">Filter Replacement</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="service-date">Date</label>
                    <input type="date" id="service-date" required>
                </div>
                <div class="input-group">
                    <label for="service-odometer">Odometer (km)</label>
                    <input type="number" id="service-odometer" placeholder="Current reading" required>
                </div>
                <div class="input-group">
                    <label for="service-cost">Cost</label>
                    <input type="number" id="service-cost" step="0.01" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label for="service-details">Details</label>
                    <textarea id="service-details" rows="3" placeholder="Service details"></textarea>
                </div>
                <div class="input-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase configuration and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Initialize Google Charts
        google.charts.load('current', {'packages':['corechart']});
        
        let vehicles = [];
        let selectedVehicleId = null;
        let expenses = [];
        let services = [];
        let trips = [];
        let mileageRecords = [];
        let serviceSettings = {};
        
        // DOM Elements
        const vehicleList = document.getElementById('vehicle-list');
        const noVehicle = document.getElementById('no-vehicle');
        const vehicleDetails = document.getElementById('vehicle-details');
        const loginPrompt = document.getElementById('login-prompt');
        const addVehicleBtn = document.getElementById('add-vehicle-btn');
        const addVehicleModal = document.getElementById('add-vehicle-modal');
        const editVehicleModal = document.getElementById('edit-vehicle-modal');
        const addServiceModal = document.getElementById('add-service-modal');
        const addServiceBtn = document.getElementById('add-service-btn');
        const closeModals = document.querySelectorAll('.close-modal');
        const vehicleForm = document.getElementById('vehicle-form');
        const editVehicleForm = document.getElementById('edit-vehicle-form');
        const serviceForm = document.getElementById('service-form');
        const serviceSettingsForm = document.getElementById('service-settings-form');
        const tabs = document.querySelectorAll('.tab');
        const panels = document.querySelectorAll('.panel');
        const expenseForm = document.getElementById('expense-form');
        const tripForm = document.getElementById('trip-form');
        const expenseHistory = document.getElementById('expense-history');
        const serviceHistory = document.getElementById('service-history');
        const tripHistory = document.getElementById('trip-history');
        const mileageHistory = document.getElementById('mileage-history');
        const signInBtn = document.getElementById('sign-in-btn');
        const promptSignInBtn = document.getElementById('prompt-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const exportReportBtn = document.getElementById('export-report-btn');
        const reportResults = document.getElementById('report-results');
        const editVehicleBtn = document.getElementById('edit-vehicle-btn');
        const deleteVehicleBtn = document.getElementById('delete-vehicle-btn');
        const serviceReminders = document.getElementById('service-reminders');
        
        // Initialize the app
        function init() {
            setupEventListeners();
            setCurrentDate();
            populateYearDropdown();
            initAuth();
        }
        
        // Initialize authentication
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    userInfo.style.display = 'flex';
                    document.getElementById('auth-buttons').style.display = 'none';
                    userName.textContent = user.displayName || user.email;
                    loginPrompt.style.display = 'none';
                    
                    // Load user data
                    loadUserData();
                } else {
                    // User is signed out
                    userInfo.style.display = 'none';
                    document.getElementById('auth-buttons').style.display = 'block';
                    loginPrompt.style.display = 'block';
                    vehicleDetails.style.display = 'none';
                    noVehicle.style.display = 'none';
                    
                    // Clear data
                    vehicles = [];
                    selectedVehicleId = null;
                    renderVehicles();
                }
            });
        }
        
        // Sign in with Google
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    console.log('Signed in successfully:', result.user);
                })
                .catch(error => {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                });
        }
        
        // Sign out
        function signOut() {
            auth.signOut()
                .then(() => {
                    console.log('Signed out successfully');
                })
                .catch(error => {
                    console.error('Sign out error:', error);
                });
        }
        
        // Load user data from Firestore
        function loadUserData() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Load vehicles
            db.collection('users').doc(user.uid).collection('vehicles')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    vehicles = [];
                    snapshot.forEach(doc => {
                        vehicles.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderVehicles();
                    
                    // If a vehicle was previously selected, try to select it again
                    if (selectedVehicleId) {
                        const vehicleExists = vehicles.some(v => v.id === selectedVehicleId);
                        if (vehicleExists) {
                            selectVehicle(selectedVehicleId);
                        } else {
                            selectedVehicleId = null;
                            noVehicle.style.display = 'block';
                            vehicleDetails.style.display = 'none';
                        }
                    }
                }, error => {
                    console.error('Error loading vehicles:', error);
                });
        }
        
        // Load service settings for selected vehicle
        function loadServiceSettings(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId)
                .collection('settings').doc('service')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        serviceSettings = doc.data();
                        document.getElementById('service-interval-days').value = serviceSettings.intervalDays || '';
                        document.getElementById('service-interval-km').value = serviceSettings.intervalKm || '';
                    } else {
                        serviceSettings = {};
                        document.getElementById('service-interval-days').value = '';
                        document.getElementById('service-interval-km').value = '';
                    }
                    checkServiceReminders();
                }, error => {
                    console.error('Error loading service settings:', error);
                });
        }
        
        // Check service reminders based on settings
        function checkServiceReminders() {
            serviceReminders.innerHTML = '';
            
            if (!selectedVehicleId || services.length === 0) return;
            
            const vehicle = vehicles.find(v => v.id === selectedVehicleId);
            if (!vehicle) return;
            
            const lastService = services[0];
            const lastServiceDate = new Date(lastService.date);
            const today = new Date();
            const daysSinceService = Math.floor((today - lastServiceDate) / (1000 * 60 * 60 * 24));
            const kmSinceService = vehicle.odometer - lastService.odometer;
            
            let showReminder = false;
            let reminderMessage = '';
            
            if (serviceSettings.intervalDays && daysSinceService >= serviceSettings.intervalDays) {
                showReminder = true;
                reminderMessage = `Service is overdue by ${daysSinceService - serviceSettings.intervalDays} days. `;
            }
            
            if (serviceSettings.intervalKm && kmSinceService >= serviceSettings.intervalKm) {
                showReminder = true;
                reminderMessage += `Service is overdue by ${kmSinceService - serviceSettings.intervalKm} km. `;
            }
            
            if (showReminder) {
                const reminderCard = document.createElement('div');
                reminderCard.className = 'reminder-card';
                reminderCard.innerHTML = `
                    <h4><i class="fas fa-exclamation-triangle"></i> Service Reminder</h4>
                    <p>${reminderMessage}</p>
                    <p>Last service: ${formatDate(lastService.date)} at ${lastService.odometer} km</p>
                    <div class="reminder-actions">
                        <button class="btn btn-primary" id="add-service-from-reminder">
                            <i class="fas fa-tools"></i> Add Service Now
                        </button>
                        <button class="btn btn-secondary" id="snooze-reminder">
                            <i class="fas fa-clock"></i> Remind Later
                        </button>
                    </div>
                `;
                serviceReminders.appendChild(reminderCard);
                
                // Add event listeners to reminder buttons
                document.getElementById('add-service-from-reminder').addEventListener('click', () => {
                    document.getElementById('service-odometer').value = vehicle.odometer;
                    setCurrentDate();
                    addServiceModal.style.display = 'flex';
                });
                
                document.getElementById('snooze-reminder').addEventListener('click', () => {
                    reminderCard.style.display = 'none';
                });
            }
        }
        
        // Load expenses for selected vehicle
        function loadExpenses(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('expenses')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    expenses = [];
                    snapshot.forEach(doc => {
                        expenses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderExpenseHistory();
                    updateVehicleDashboard();
                }, error => {
                    console.error('Error loading expenses:', error);
                });
        }
        
        // Load services for selected vehicle
        function loadServices(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('services')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    services = [];
                    snapshot.forEach(doc => {
                        services.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderServiceHistory();
                    updateVehicleDashboard();
                    checkServiceReminders();
                }, error => {
                    console.error('Error loading services:', error);
                });
        }
        
        // Load trips for selected vehicle
        function loadTrips(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('trips')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    trips = [];
                    snapshot.forEach(doc => {
                        trips.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderTripHistory();
                }, error => {
                    console.error('Error loading trips:', error);
                });
        }
        
        // Load mileage records for selected vehicle
        function loadMileageRecords(vehicleId) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).collection('mileageRecords')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    mileageRecords = [];
                    snapshot.forEach(doc => {
                        mileageRecords.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderMileageHistory();
                    drawMileageChart();
                }, error => {
                    console.error('Error loading mileage records:', error);
                });
        }
        
        // Render vehicle list
        function renderVehicles() {
            vehicleList.innerHTML = '';
            
            if (vehicles.length === 0) {
                vehicleList.innerHTML = '<p>No vehicles added yet.</p>';
                return;
            }
            
            vehicles.forEach(vehicle => {
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card';
                if (vehicle.id === selectedVehicleId) {
                    vehicleCard.classList.add('active');
                }
                
                vehicleCard.innerHTML = `
                    <div class="vehicle-icon">
                        <i class="fas ${getVehicleIcon(vehicle.type)}"></i>
                    </div>
                    <div class="vehicle-info">
                        <h3>${vehicle.name}</h3>
                        <p>${vehicle.model || 'No model'} â€¢ ${vehicle.odometer} km</p>
                    </div>
                `;
                
                vehicleCard.addEventListener('click', () => selectVehicle(vehicle.id));
                vehicleList.appendChild(vehicleCard);
            });
        }
        
        // Get appropriate icon for vehicle type
        function getVehicleIcon(type) {
            switch(type) {
                case 'car': return 'fa-car';
                case 'motorcycle': return 'fa-motorcycle';
                case 'suv': return 'fa-truck-monster';
                case 'truck': return 'fa-truck';
                default: return 'fa-vehicle';
            }
        }
        
        // Select a vehicle
        function selectVehicle(vehicleId) {
            selectedVehicleId = vehicleId;
            renderVehicles();
            
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                noVehicle.style.display = 'none';
                vehicleDetails.style.display = 'block';
                
                // Load vehicle-specific data
                loadExpenses(vehicleId);
                loadServices(vehicleId);
                loadTrips(vehicleId);
                loadMileageRecords(vehicleId);
                loadServiceSettings(vehicleId);
            }
        }
        
        // Update dashboard with vehicle stats
        function updateVehicleDashboard() {
            const vehicle = vehicles.find(v => v.id === selectedVehicleId);
            if (!vehicle) return;
            
            // Calculate total spent
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('total-spent').textContent = totalSpent.toFixed(2);
            
            // Calculate average mileage
            if (mileageRecords.length > 0) {
                const totalMileage = mileageRecords.reduce((sum, record) => {
                    if (record.distance && record.fuelAmount && record.fuelAmount > 0) {
                        return sum + (record.distance / record.fuelAmount);
                    }
                    return sum;
                }, 0);
                const avgMileage = totalMileage / mileageRecords.length;
                document.getElementById('avg-mileage').textContent = avgMileage.toFixed(1);
            } else {
                document.getElementById('avg-mileage').textContent = '0.0';
            }
            
            // Calculate last service
            if (services.length > 0) {
                const lastService = services[0];
                const serviceDate = new Date(lastService.date);
                const today = new Date();
                const daysDiff = Math.floor((today - serviceDate) / (1000 * 60 * 60 * 24));
                document.getElementById('last-service').textContent = daysDiff;
            } else {
                document.getElementById('last-service').textContent = '-';
            }
            
            // Update odometer (use the highest value from expenses or the vehicle's odometer)
            let maxOdometer = vehicle.odometer;
            expenses.forEach(expense => {
                if (expense.odometer > maxOdometer) {
                    maxOdometer = expense.odometer;
                }
            });
            services.forEach(service => {
                if (service.odometer > maxOdometer) {
                    maxOdometer = service.odometer;
                }
            });
            
            document.getElementById('total-distance').textContent = maxOdometer;
        }
        
        // Render expense history
        function renderExpenseHistory() {
            expenseHistory.innerHTML = '';
            
            if (expenses.length === 0) {
                expenseHistory.innerHTML = '<tr><td colspan="6" style="text-align: center;">No expenses recorded yet</td></tr>';
                return;
            }
            
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td>${expense.type}</td>
                    <td>${expense.amount.toFixed(2)}</td>
                    <td>${expense.odometer || '-'}</td>
                    <td>${expense.notes || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editExpense('${expense.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteExpense('${expense.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                expenseHistory.appendChild(row);
            });
        }
        
        // Render service history
        function renderServiceHistory() {
            serviceHistory.innerHTML = '';
            
            if (services.length === 0) {
                serviceHistory.innerHTML = '<tr><td colspan="6" style="text-align: center;">No services recorded yet</td></tr>';
                return;
            }
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(service.date)}</td>
                    <td>${service.type}</td>
                    <td>${service.odometer}</td>
                    <td>${service.cost.toFixed(2)}</td>
                    <td>${service.details || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editService('${service.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteService('${service.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                serviceHistory.appendChild(row);
            });
        }
        
        // Render trip history
        function renderTripHistory() {
            tripHistory.innerHTML = '';
            
            if (trips.length === 0) {
                tripHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No trips recorded yet</td></tr>';
                return;
            }
            
            trips.forEach(trip => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(trip.date)}</td>
                    <td>${trip.startLocation} to ${trip.endLocation}</td>
                    <td>${trip.distance} km</td>
                    <td>${trip.purpose || '-'}</td>
                    <td>
                        <button class="action-btn" onclick="editTrip('${trip.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteTrip('${trip.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tripHistory.appendChild(row);
            });
        }
        
        // Render mileage history
        function renderMileageHistory() {
            mileageHistory.innerHTML = '';
            
            if (mileageRecords.length === 0) {
                mileageHistory.innerHTML = '<tr><td colspan="5" style="text-align: center;">No mileage records yet</td></tr>';
                return;
            }
            
            mileageRecords.forEach(record => {
                const mileage = record.fuelAmount > 0 ? (record.distance / record.fuelAmount).toFixed(1) : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(record.date)}</td>
                    <td>${record.distance}</td>
                    <td>${record.fuelAmount}</td>
                    <td>${mileage}</td>
                    <td>${record.cost ? record.cost.toFixed(2) : '-'}</td>
                `;
                mileageHistory.appendChild(row);
            });
        }
        
        // Draw mileage chart
        function drawMileageChart() {
            if (mileageRecords.length === 0) {
                document.getElementById('mileage-chart').innerHTML = '<p>No mileage data available for chart</p>';
                return;
            }
            
            const data = new google.visualization.DataTable();
            data.addColumn('date', 'Date');
            data.addColumn('number', 'Mileage (km/L)');
            
            const chartData = mileageRecords
                .filter(record => record.fuelAmount > 0)
                .map(record => {
                    const mileage = record.distance / record.fuelAmount;
                    return [new Date(record.date), mileage];
                });
            
            data.addRows(chartData);
            
            const options = {
                title: 'Fuel Efficiency Over Time',
                curveType: 'function',
                legend: { position: 'bottom' },
                hAxis: {
                    title: 'Date',
                    format: 'MMM yyyy'
                },
                vAxis: {
                    title: 'Mileage (km/L)'
                }
            };
            
            const chart = new google.visualization.LineChart(document.getElementById('mileage-chart'));
            chart.draw(data, options);
        }
        
        // Generate expense report
        function generateExpenseReport() {
            const reportType = document.getElementById('report-type').value;
            const month = document.getElementById('report-month').value;
            const year = document.getElementById('report-year').value;
            
            let filteredExpenses = [];
            
            if (reportType === 'monthly') {
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() + 1 === parseInt(month) && 
                           expenseDate.getFullYear() === parseInt(year);
                });
            } else if (reportType === 'category') {
                // Group by category for the selected year
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === parseInt(year);
                });
            } else if (reportType === 'custom') {
                // For custom date range, you would need to add date inputs
                // This is a simplified version using the selected month/year
                filteredExpenses = expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() + 1 === parseInt(month) && 
                           expenseDate.getFullYear() === parseInt(year);
                });
            }
            
            // Display report results
            if (filteredExpenses.length === 0) {
                reportResults.innerHTML = '<p>No expenses found for the selected criteria.</p>';
                return;
            }
            
            let totalAmount = 0;
            let reportHTML = `
                <h3>Expense Report</h3>
                <p>Report Type: ${reportType}, Period: ${month}/${year}</p>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Odometer</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredExpenses.forEach(expense => {
                totalAmount += expense.amount;
                reportHTML += `
                    <tr>
                        <td>${formatDate(expense.date)}</td>
                        <td>${expense.type}</td>
                        <td>${expense.amount.toFixed(2)}</td>
                        <td>${expense.odometer || '-'}</td>
                        <td>${expense.notes || '-'}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2"><strong>Total</strong></td>
                            <td><strong>${totalAmount.toFixed(2)}</strong></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            reportResults.innerHTML = reportHTML;
        }
        
        // Export report to CSV
        function exportReportToCSV() {
            const reportTable = reportResults.querySelector('table');
            if (!reportTable) {
                alert('No report data to export');
                return;
            }
            
            let csv = [];
            const rows = reportTable.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    // Clean text and add to row
                    let text = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
                    row.push(`"${text}"`);
                }
                
                csv.push(row.join(','));
            }
            
            // Download CSV file
            const csvString = csv.join('\n');
            const filename = `expense-report-${new Date().toISOString().slice(0, 10)}.csv`;
            const link = document.createElement('a');
            link.style.display = 'none';
            link.setAttribute('target', '_blank');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Add a new vehicle
        function addVehicle(vehicleData) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').add({
                ...vehicleData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(docRef => {
                console.log('Vehicle added with ID: ', docRef.id);
                addVehicleModal.style.display = 'none';
                vehicleForm.reset();
            })
            .catch(error => {
                console.error('Error adding vehicle: ', error);
                alert('Error adding vehicle: ' + error.message);
            });
        }
        
        // Update a vehicle
        function updateVehicle(vehicleId, vehicleData) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId).update({
                ...vehicleData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('Vehicle updated successfully');
                editVehicleModal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error updating vehicle: ', error);
                alert('Error updating vehicle: ' + error.message);
            });
        }
        
        // Delete a vehicle
        function deleteVehicle(vehicleId) {
            if (!confirm('Are you sure you want to delete this vehicle? All associated data will be lost.')) {
                return;
            }
            
            const user = auth.currentUser;
            if (!user) return;
            
            // First delete all subcollections (expenses, services, trips, etc.)
            const vehicleRef = db.collection('users').doc(user.uid).collection('vehicles').doc(vehicleId);
            
            // This is a simplified approach - in a real app, you'd want to handle this more thoroughly
            Promise.all([
                deleteCollection(vehicleRef.collection('expenses')),
                deleteCollection(vehicleRef.collection('services')),
                deleteCollection(vehicleRef.collection('trips')),
                deleteCollection(vehicleRef.collection('mileageRecords')),
                deleteCollection(vehicleRef.collection('settings'))
            ])
            .then(() => {
                // Then delete the vehicle itself
                return vehicleRef.delete();
            })
            .then(() => {
                console.log('Vehicle and all associated data deleted successfully');
                selectedVehicleId = null;
                noVehicle.style.display = 'block';
                vehicleDetails.style.display = 'none';
            })
            .catch(error => {
                console.error('Error deleting vehicle: ', error);
                alert('Error deleting vehicle: ' + error.message);
            });
        }
        
        // Helper function to delete a collection
        function deleteCollection(collectionRef) {
            return collectionRef.get().then(querySnapshot => {
                const deletePromises = [];
                querySnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                return Promise.all(deletePromises);
            });
        }
        
        // Add a new service record
        function addService(serviceData) {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('services').add({
                    ...serviceData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log('Service record added successfully');
                    addServiceModal.style.display = 'none';
                    serviceForm.reset();
                    
                    // Update vehicle odometer if service odometer is higher
                    const vehicle = vehicles.find(v => v.id === selectedVehicleId);
                    if (vehicle && serviceData.odometer > vehicle.odometer) {
                        updateVehicle(selectedVehicleId, { odometer: serviceData.odometer });
                    }
                })
                .catch(error => {
                    console.error('Error adding service record: ', error);
                    alert('Error adding service record: ' + error.message);
                });
        }
        
        // Save service settings
        function saveServiceSettings(settings) {
            const user = auth.currentUser;
            if (!user || !selectedVehicleId) return;
            
            db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                .collection('settings').doc('service').set(settings)
                .then(() => {
                    console.log('Service settings saved successfully');
                    alert('Service reminder settings saved!');
                })
                .catch(error => {
                    console.error('Error saving service settings: ', error);
                    alert('Error saving service settings: ' + error.message);
                });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Set current date in date inputs
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            document.getElementById('trip-date').value = today;
            document.getElementById('service-date').value = today;
        }
        
        // Populate year dropdown
        function populateYearDropdown() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            yearSelect.value = currentYear;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Auth buttons
            signInBtn.addEventListener('click', signIn);
            promptSignInBtn.addEventListener('click', signIn);
            signOutBtn.addEventListener('click', signOut);
            
            // Modal buttons
            addVehicleBtn.addEventListener('click', () => {
                addVehicleModal.style.display = 'flex';
            });
            
            addServiceBtn.addEventListener('click', () => {
                const vehicle = vehicles.find(v => v.id === selectedVehicleId);
                if (vehicle) {
                    document.getElementById('service-odometer').value = vehicle.odometer;
                }
                setCurrentDate();
                addServiceModal.style.display = 'flex';
            });
            
            closeModals.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Forms
            vehicleForm.addEventListener('submit', e => {
                e.preventDefault();
                const vehicleData = {
                    name: document.getElementById('vehicle-name').value,
                    type: document.getElementById('vehicle-type').value,
                    model: document.getElementById('vehicle-model').value,
                    year: document.getElementById('vehicle-year').value ? parseInt(document.getElementById('vehicle-year').value) : null,
                    odometer: document.getElementById('initial-odometer').value ? parseInt(document.getElementById('initial-odometer').value) : 0
                };
                addVehicle(vehicleData);
            });
            
            editVehicleForm.addEventListener('submit', e => {
                e.preventDefault();
                if (!selectedVehicleId) return;
                
                const vehicleData = {
                    name: document.getElementById('edit-vehicle-name').value,
                    type: document.getElementById('edit-vehicle-type').value,
                    model: document.getElementById('edit-vehicle-model').value,
                    year: document.getElementById('edit-vehicle-year').value ? parseInt(document.getElementById('edit-vehicle-year').value) : null,
                    odometer: document.getElementById('edit-odometer').value ? parseInt(document.getElementById('edit-odometer').value) : 0
                };
                updateVehicle(selectedVehicleId, vehicleData);
            });
            
            serviceForm.addEventListener('submit', e => {
                e.preventDefault();
                const serviceData = {
                    type: document.getElementById('service-type').value,
                    date: document.getElementById('service-date').value,
                    odometer: parseInt(document.getElementById('service-odometer').value),
                    cost: parseFloat(document.getElementById('service-cost').value),
                    details: document.getElementById('service-details').value
                };
                addService(serviceData);
            });
            
            serviceSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                const settings = {
                    intervalDays: document.getElementById('service-interval-days').value ? parseInt(document.getElementById('service-interval-days').value) : null,
                    intervalKm: document.getElementById('service-interval-km').value ? parseInt(document.getElementById('service-interval-km').value) : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                saveServiceSettings(settings);
            });
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding panel
                    panels.forEach(panel => {
                        if (panel.id === `${tabName}-panel`) {
                            panel.style.display = 'block';
                        } else {
                            panel.style.display = 'none';
                        }
                    });
                    
                    // Draw chart if on mileage tab
                    if (tabName === 'mileage') {
                        google.charts.setOnLoadCallback(drawMileageChart);
                    }
                });
            });
            
            // Report generation
            generateReportBtn.addEventListener('click', generateExpenseReport);
            exportReportBtn.addEventListener('click', exportReportToCSV);
            
            // Vehicle actions
            editVehicleBtn.addEventListener('click', () => {
                const vehicle = vehicles.find(v => v.id === selectedVehicleId);
                if (vehicle) {
                    document.getElementById('edit-vehicle-name').value = vehicle.name;
                    document.getElementById('edit-vehicle-type').value = vehicle.type;
                    document.getElementById('edit-vehicle-model').value = vehicle.model || '';
                    document.getElementById('edit-vehicle-year').value = vehicle.year || '';
                    document.getElementById('edit-odometer').value = vehicle.odometer;
                    editVehicleModal.style.display = 'flex';
                }
            });
            
            deleteVehicleBtn.addEventListener('click', () => {
                if (selectedVehicleId) {
                    deleteVehicle(selectedVehicleId);
                }
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', e => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Global functions for inline event handlers
        window.editExpense = function(id) {
            // Implementation for editing expenses
            alert('Edit expense functionality would be implemented here');
        };
        
        window.deleteExpense = function(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                const user = auth.currentUser;
                if (!user || !selectedVehicleId) return;
                
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('expenses').doc(id).delete()
                    .then(() => {
                        console.log('Expense deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting expense: ', error);
                        alert('Error deleting expense: ' + error.message);
                    });
            }
        };
        
        window.editService = function(id) {
            // Implementation for editing services
            alert('Edit service functionality would be implemented here');
        };
        
        window.deleteService = function(id) {
            if (confirm('Are you sure you want to delete this service record?')) {
                const user = auth.currentUser;
                if (!user || !selectedVehicleId) return;
                
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('services').doc(id).delete()
                    .then(() => {
                        console.log('Service record deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting service record: ', error);
                        alert('Error deleting service record: ' + error.message);
                    });
            }
        };
        
        window.editTrip = function(id) {
            // Implementation for editing trips
            alert('Edit trip functionality would be implemented here');
        };
        
        window.deleteTrip = function(id) {
            if (confirm('Are you sure you want to delete this trip?')) {
                const user = auth.currentUser;
                if (!user || !selectedVehicleId) return;
                
                db.collection('users').doc(user.uid).collection('vehicles').doc(selectedVehicleId)
                    .collection('trips').doc(id).delete()
                    .then(() => {
                        console.log('Trip deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting trip: ', error);
                        alert('Error deleting trip: ' + error.message);
                    });
            }
        };
    </script>
</body>
</html>
