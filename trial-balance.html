<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trial Balance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: right; }
    th { background-color: #f4f4f4; text-align: left; }
    .balance-positive { color: green; }
    .balance-negative { color: red; }
  </style>
</head>
<body>

<h2><i class="fa fa-balance-scale"></i> Trial Balance</h2>
<table id="trialBalanceTable">
  <thead>
    <tr>
      <th>Account Header</th>
      <th>Total Debit (Expense)</th>
      <th>Total Credit (Income)</th>
      <th>Balance (Credit - Debit)</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  });

  const db = getFirestore(app);
  const auth = getAuth(app);

  const tableBody = document.querySelector("#trialBalanceTable tbody");

  function formatCurrency(num) {
    return num.toFixed(2);
  }

  onAuthStateChanged(auth, async user => {
    if (!user) {
      alert("Please login first.");
      window.location.href = "index.html";
      return;
    }

    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>`;

    try {
      const snap = await getDocs(collection(db, "users", user.uid, "transactions"));
      const transactions = snap.docs.map(doc => doc.data());

      // Group by Account Header
      const grouped = {};

      transactions.forEach(tx => {
        const header = tx.ACCOUNT_HEADER || "Uncategorized";
        if (!grouped[header]) {
          grouped[header] = { debit: 0, credit: 0 };
        }
        // Expense as Debit
        grouped[header].debit += parseFloat(tx.EXPENSE || 0);
        // Income as Credit
        grouped[header].credit += parseFloat(tx.INCOME || 0);
      });

      if (Object.keys(grouped).length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No transactions found.</td></tr>`;
        return;
      }

      // Build table rows
      let rows = "";
      for (const [header, amounts] of Object.entries(grouped)) {
        const balance = amounts.credit - amounts.debit;
        rows += `<tr>
          <td style="text-align:left;">${header}</td>
          <td>${formatCurrency(amounts.debit)}</td>
          <td>${formatCurrency(amounts.credit)}</td>
          <td class="${balance >= 0 ? "balance-positive" : "balance-negative"}">${formatCurrency(balance)}</td>
        </tr>`;
      }
      tableBody.innerHTML = rows;

    } catch (err) {
      tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Failed to load: ${err.message}</td></tr>`;
    }
  });
</script>

</body>
</html>
