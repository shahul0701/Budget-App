<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profit & Loss Report</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* Basic Styles */
body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;color:#333;line-height:1.6;margin:0;padding:0;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
header{background:white;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;border-radius:8px;}
.header-left a{text-decoration:none;color:#3498db;font-weight:bold;font-size:18px;display:flex;align-items:center;gap:8px;}
.header-right{display:flex;align-items:center;gap:15px;}
#userInitials{background:#3498db;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
#logoutBtn{background:#e74c3c;color:white;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
#logoutBtn:hover{background:#c0392b;}
h1{text-align:center;margin-bottom:30px;}
.date-controls{background:white;padding:20px;border-radius:8px;display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.date-controls select,input{padding:6px 10px;border-radius:4px;border:1px solid #ddd;}
#generateReportBtn{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
#generateReportBtn:hover{background:#2980b9;}
.export-buttons{display:flex;gap:10px;margin-bottom:20px;}
.export-buttons button{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
.export-buttons button:hover{background:#2980b9;}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px;}
.summary-card{background:white;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.summary-card.income{border-top:4px solid #2ecc71;}
.summary-card.expenses{border-top:4px solid #e74c3c;}
.summary-card.net{border-top:4px solid #3498db;}
.card-title{font-size:16px;color:#95a5a6;margin-bottom:10px;}
.card-value{font-size:24px;font-weight:700;}
.income .card-value{color:#2ecc71;}
.expenses .card-value{color:#e74c3c;}
.net .card-value{color:#3498db;}
.chart-container{background:white;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.details-section{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.details-section{grid-template-columns:1fr;}}
.income-details,.expense-details{background:white;border-radius:8px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.section-title{font-size:18px;color:#2c3e50;margin-bottom:10px;border-bottom:1px solid #ecf0f1;padding-bottom:5px;}
.transaction-item{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f1f1f1;}
.transaction-item:last-child{border-bottom:none;}
.transaction-category{font-weight:600;}
.transaction-amount{font-weight:600;}
.income-details .transaction-amount{color:#2ecc71;}
.expense-details .transaction-amount{color:#e74c3c;}
.loading-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;}
.loading-content{background:white;padding:30px;border-radius:8px;text-align:center;}
.empty-state{text-align:center;padding:20px;color:#95a5a6;}
.report-period{text-align:center;margin-bottom:20px;font-style:italic;color:#95a5a6;}
</style>
</head>
<body>

<header>
<div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
<div class="header-right">
<div id="userInitials">U</div>
<div id="username">User</div>
<button id="logoutBtn">Logout</button>
</div>
</header>

<div class="container">
<h1><i class="fas fa-chart-line"></i> Profit & Loss Report</h1>

<div class="date-controls">
<label>Period:
<select id="reportPeriod">
<option value="month">This Month</option>
<option value="lastMonth">Last Month</option>
<option value="quarter">This Quarter</option>
<option value="year">This Year</option>
<option value="custom">Custom</option>
</select></label>

<div id="customDateRange" style="display:none;flex-wrap:wrap;gap:10px;">
<label>From:<input type="date" id="startDate"></label>
<label>To:<input type="date" id="endDate"></label>
</div>

<button id="generateReportBtn">Generate</button>

<label>Chart Type:
<select id="chartType">
<option value="bar">Bar</option>
<option value="line">Line</option>
<option value="pie">Pie</option>
</select>
</label>
</div>

<div class="export-buttons">
<button id="exportCSV"><i class="fa fa-file-csv"></i> CSV</button>
<button id="exportPDF"><i class="fa fa-file-pdf"></i> PDF</button>
</div>

<div id="reportPeriodDisplay" class="report-period"></div>

<div class="summary-cards">
<div class="summary-card income"><div class="card-title">Total Income</div><div class="card-value" id="totalIncome">₹0.00</div></div>
<div class="summary-card expenses"><div class="card-title">Total Expenses</div><div class="card-value" id="totalExpenses">₹0.00</div></div>
<div class="summary-card net"><div class="card-title">Net Profit/Loss</div><div class="card-value" id="netProfit">₹0.00</div></div>
</div>

<div class="chart-container">
<canvas id="profitLossChart"></canvas>
</div>

<div class="details-section">
<div class="income-details">
<h3 class="section-title">Income Breakdown</h3>
<div id="incomeBreakdown"></div>
</div>
<div class="expense-details">
<h3 class="section-title">Expense Breakdown</h3>
<div id="expenseBreakdown"></div>
</div>
</div>
</div>

<div id="loadingModal" class="loading-modal">
<div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;margin-bottom:15px;"></i><p>Generating report...</p></div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.appspot.com",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        });


const db = getFirestore(app);
const auth = getAuth(app);

// DOM Elements
const usernameElem=document.getElementById("username");
const initialsElem=document.getElementById("userInitials");
const logoutBtn=document.getElementById("logoutBtn");
const reportPeriod=document.getElementById("reportPeriod");
const startDateInput=document.getElementById("startDate");
const endDateInput=document.getElementById("endDate");
const customDateRange=document.getElementById("customDateRange");
const generateReportBtn=document.getElementById("generateReportBtn");
const reportPeriodDisplay=document.getElementById("reportPeriodDisplay");
const totalIncomeElem=document.getElementById("totalIncome");
const totalExpensesElem=document.getElementById("totalExpenses");
const netProfitElem=document.getElementById("netProfit");
const incomeBreakdownElem=document.getElementById("incomeBreakdown");
const expenseBreakdownElem=document.getElementById("expenseBreakdown");
const chartTypeSelect=document.getElementById("chartType");
const exportCSVBtn=document.getElementById("exportCSV");
const exportPDFBtn=document.getElementById("exportPDF");
const loadingModal=document.getElementById("loadingModal");

let currentUser=null;
let allTransactions=[];
let profitLossChart=null;

// ===== Auth Listener =====
onAuthStateChanged(auth,user=>{
if(user){
currentUser=user;
const name=user.displayName||user.email||"User";
usernameElem.textContent=name;
initialsElem.textContent=name.charAt(0).toUpperCase();
setDefaultDates();
generateReport();
}else{alert("Login first.");window.location.href="index.html";}});

// ===== Logout =====
logoutBtn.addEventListener("click",async()=>{await signOut(auth);window.location.href="index.html";});

// ===== Date Controls =====
reportPeriod.addEventListener("change",()=>{customDateRange.style.display=reportPeriod.value==="custom"?"flex":"none";});
generateReportBtn.addEventListener("click",generateReport);
chartTypeSelect.addEventListener("change",()=>{if(allTransactions.length>0)generateReport();});
exportCSVBtn.addEventListener("click",exportCSV);
exportPDFBtn.addEventListener("click",exportPDF);

function setDefaultDates(){
const today=new Date();
const firstDay=new Date(today.getFullYear(),today.getMonth(),1);
const lastDay=new Date(today.getFullYear(),today.getMonth()+1,0);
startDateInput.value=formatDate(firstDay);
endDateInput.value=formatDate(lastDay);
}

function formatDate(date){return`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;}
function formatDisplay(date){return date.toLocaleDateString("en-IN",{year:"numeric",month:"long",day:"numeric"});}

// ===== Date Range =====
function getDateRange(){
const today=new Date();
let startDate,endDate;
switch(reportPeriod.value){
case"month":startDate=new Date(today.getFullYear(),today.getMonth(),1);endDate=new Date(today.getFullYear(),today.getMonth()+1,0);break;
case"lastMonth":startDate=new Date(today.getFullYear(),today.getMonth()-1,1);endDate=new Date(today.getFullYear(),today.getMonth(),0);break;
case"quarter":const q=Math.floor(today.getMonth()/3);startDate=new Date(today.getFullYear(),q*3,1);endDate=new Date(today.getFullYear(),(q+1)*3,0);break;
case"year":startDate=new Date(today.getFullYear(),0,1);endDate=new Date(today.getFullYear(),11,31);break;
case"custom":startDate=new Date(startDateInput.value);endDate=new Date(endDateInput.value);break;}
startDate.setHours(0,0,0,0);endDate.setHours(23,59,59,999);
return{startDate,endDate};
}

// ===== Load Transactions =====
async function loadTransactions(startDate,endDate){
loadingModal.style.display="flex";
try{
const q=query(collection(db,"users",currentUser.uid,"transactions"),orderBy("DATE","desc"));
const snap=await getDocs(q);
allTransactions=snap.docs.map(d=>({id:d.id,...d.data()})).filter(tx=>{const d=new Date(tx.DATE);return d>=startDate && d<=endDate;});
return allTransactions;
}catch(err){console.error(err);alert("Error: "+err.message);return[];}finally{loadingModal.style.display="none";}
}

// ===== Generate Report =====
async function generateReport(){
const {startDate,endDate}=getDateRange();
reportPeriodDisplay.textContent=`Report: ${formatDisplay(startDate)} to ${formatDisplay(endDate)}`;
const transactions=await loadTransactions(startDate,endDate);
if(transactions.length===0){resetReport();return;}

const totalIncome=transactions.filter(tx=>parseFloat(tx.INCOME)>0).reduce((s,tx)=>s+parseFloat(tx.INCOME),0);
const totalExpenses=transactions.filter(tx=>parseFloat(tx.EXPENSE)>0).reduce((s,tx)=>s+parseFloat(tx.EXPENSE),0);
const netProfit=totalIncome-totalExpenses;

totalIncomeElem.textContent=`₹${totalIncome.toFixed(2)}`;
totalExpensesElem.textContent=`₹${totalExpenses.toFixed(2)}`;
netProfitElem.textContent=`₹${netProfit.toFixed(2)}`;
netProfitElem.style.color=netProfit>0?"#2ecc71":netProfit<0?"#e74c3c":"#3498db";

// Breakdown
updateBreakdown(transactions,"INCOME",incomeBreakdownElem);
updateBreakdown(transactions,"EXPENSE",expenseBreakdownElem);

// Chart
updateChart(transactions);
}

function resetReport(){
totalIncomeElem.textContent="₹0.00";totalExpensesElem.textContent="₹0.00";netProfitElem.textContent="₹0.00";incomeBreakdownElem.innerHTML="";expenseBreakdownElem.innerHTML="";
if(profitLossChart){profitLossChart.destroy();}
}

function updateBreakdown(transactions,type,container){
const byCat={};
transactions.filter(tx=>parseFloat(tx[type])>0).forEach(tx=>{const cat=tx.ACCOUNT_HEADER||"Uncategorized";byCat[cat]=(byCat[cat]||0)+parseFloat(tx[type]);});
container.innerHTML=Object.keys(byCat).length===0?'<p class="empty-state"><i class="fa fa-info-circle"></i> No data</p>':Object.entries(byCat).map(([k,v])=>`<div class="transaction-item"><div class="transaction-category">${k}</div><div class="transaction-amount">₹${v.toFixed(2)}</div></div>`).join("");
}

function updateChart(transactions){
const byCatIncome={},byCatExpense={};
transactions.forEach(tx=>{if(parseFloat(tx.INCOME)>0){const cat=tx.ACCOUNT_HEADER||"Income";byCatIncome[cat]=(byCatIncome[cat]||0)+parseFloat(tx.INCOME);}
if(parseFloat(tx.EXPENSE)>0){const cat=tx.ACCOUNT_HEADER||"Expense";byCatExpense[cat]=(byCatExpense[cat]||0)+parseFloat(tx.EXPENSE);}});
const labels=[...new Set([...Object.keys(byCatIncome),...Object.keys(byCatExpense)])];
const incomeData=labels.map(l=>byCatIncome[l]||0);const expenseData=labels.map(l=>byCatExpense[l]||0);
const ctx=document.getElementById("profitLossChart").getContext("2d");
if(profitLossChart){profitLossChart.destroy();}
profitLossChart=new Chart(ctx,{type:chartTypeSelect.value,data:{labels, datasets:[{label:"Income",data:incomeData,backgroundColor:"#2ecc71"},{label:"Expenses",data:expenseData,backgroundColor:"#e74c3c"}]},options:{responsive:true}});
}

// ===== Export =====
function exportCSV(){
if(allTransactions.length===0){alert("No data to export.");return;}
let csv="DATE,ACCOUNT_HEADER,INCOME,EXPENSE,NOTES\n";
allTransactions.forEach(tx=>{csv+=`${tx.DATE},${tx.ACCOUNT_HEADER||""},${tx.INCOME||0},${tx.EXPENSE||0},${tx.NOTES||""}\n`;});
const blob=new Blob([csv],{type:"text/csv"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");a.href=url;a.download="ProfitLossReport.csv";a.click();URL.revokeObjectURL(url);
}

function exportPDF(){
if(allTransactions.length===0){alert("No data to export.");return;}
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.setFontSize(18);doc.text("Profit & Loss Report",105,15,null,null,"center");
doc.setFontSize(12);doc.text(`Generated for ${currentUser.email||"User"}`,105,23,null,null,"center");
doc.text(reportPeriodDisplay.textContent,105,30,null,null,"center");

// Summary
doc.setFontSize(14);doc.text("Summary",14,45);
doc.setFontSize(12);
doc.text(`Total Income: ₹${totalIncomeElem.textContent.replace("₹","")}`,14,53);
doc.text(`Total Expenses: ₹${totalExpensesElem.textContent.replace("₹","")}`,14,60);
doc.text(`Net Profit/Loss: ₹${netProfitElem.textContent.replace("₹","")}`,14,67);

// Transactions Table
doc.autoTable({startY:75,head:[["Date","Category","Income","Expense","Notes"]],
body:allTransactions.map(tx=>[tx.DATE,tx.ACCOUNT_HEADER||"",tx.INCOME||0,tx.EXPENSE||0,tx.NOTES||""]),theme:"grid"});
doc.save("ProfitLossReport.pdf");
}
</script>
</body>
</html>
