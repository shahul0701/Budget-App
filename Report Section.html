<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profit & Loss Report</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* Basic Styles */
body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;color:#333;line-height:1.6;margin:0;padding:0;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
header{background:white;padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;border-radius:8px;}
.header-left a{text-decoration:none;color:#3498db;font-weight:bold;font-size:18px;display:flex;align-items:center;gap:8px;}
.header-right{display:flex;align-items:center;gap:15px;}
#userInitials{background:#3498db;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
#logoutBtn{background:#e74c3c;color:white;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
#logoutBtn:hover{background:#c0392b;}
h1{text-align:center;margin-bottom:30px;}
.date-controls{background:white;padding:20px;border-radius:8px;display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.date-controls select,input{padding:6px 10px;border-radius:4px;border:1px solid #ddd;}
#generateReportBtn{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
#generateReportBtn:hover{background:#2980b9;}
.export-buttons{display:flex;gap:10px;margin-bottom:20px;}
.export-buttons button{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
.export-buttons button:hover{background:#2980b9;}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px;}
.summary-card{background:white;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.summary-card.income{border-top:4px solid #2ecc71;}
.summary-card.expenses{border-top:4px solid #e74c3c;}
.summary-card.net{border-top:4px solid #3498db;}
.card-title{font-size:16px;color:#95a5a6;margin-bottom:10px;}
.card-value{font-size:24px;font-weight:700;}
.income .card-value{color:#2ecc71;}
.expenses .card-value{color:#e74c3c;}
.net .card-value{color:#3498db;}
.chart-container{background:white;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.details-section{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.details-section{grid-template-columns:1fr;}}
.income-details,.expense-details{background:white;border-radius:8px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.section-title{font-size:18px;color:#2c3e50;margin-bottom:10px;border-bottom:1px solid #ecf0f1;padding-bottom:5px;}
.transaction-item{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f1f1f1;}
.transaction-item:last-child{border-bottom:none;}
.transaction-category{font-weight:600;}
.transaction-amount{font-weight:600;}
.income-details .transaction-amount{color:#2ecc71;}
.expense-details .transaction-amount{color:#e74c3c;}
.loading-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;}
.loading-content{background:white;padding:30px;border-radius:8px;text-align:center;}
.empty-state{text-align:center;padding:20px;color:#95a5a6;}
.report-period{text-align:center;margin-bottom:20px;font-style:italic;color:#95a5a6;}
.email-section{background:white;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.email-section h3{margin-top:0;}
.email-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.insights-section{background:#f8f9fa;border-radius:8px;padding:20px;margin-bottom:20px;border-left:4px solid #3498db;}
.insight-item{margin-bottom:15px;padding:10px;background:white;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.insight-header{display:flex;align-items:center;gap:10px;margin-bottom:5px;}
.insight-icon{font-size:18px;}
.insight-high{color:#e74c3c;}
.insight-medium{color:#f39c12;}
.insight-low{color:#2ecc71;}
</style>
</head>
<body>

<header>
<div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
<div class="header-right">
<div id="userInitials">U</div>
<div id="username">User</div>
<button id="logoutBtn">Logout</button>
</div>
</header>

<div class="container">
<h1><i class="fas fa-chart-line"></i> Profit & Loss Report</h1>

<div class="date-controls">
<label>Period:
<select id="reportPeriod">
<option value="month">This Month</option>
<option value="lastMonth">Last Month</option>
<option value="quarter">This Quarter</option>
<option value="year">This Year</option>
<option value="custom">Custom</option>
</select></label>

<div id="customDateRange" style="display:none;flex-wrap:wrap;gap:10px;">
<label>From:<input type="date" id="startDate"></label>
<label>To:<input type="date" id="endDate"></label>
</div>

<button id="generateReportBtn">Generate</button>

<label>Chart Type:
<select id="chartType">
<option value="bar">Bar</option>
<option value="line">Line</option>
<option value="pie">Pie</option>
</select>
</label>
</div>

<div class="email-section">
<h3><i class="fas fa-envelope"></i> Monthly Report</h3>
<div class="email-controls">
<button id="generateMonthlyBtn"><i class="fas fa-file-pdf"></i> Generate Monthly Report</button>
<button id="emailReportBtn"><i class="fas fa-paper-plane"></i> Email This Report</button>
<button id="autoEmailBtn"><i class="fas fa-robot"></i> Setup Auto Email</button>
</div>
</div>

<div class="export-buttons">
<button id="exportCSV"><i class="fa fa-file-csv"></i> CSV</button>
<button id="exportPDF"><i class="fa fa-file-pdf"></i> PDF</button>
</div>

<div id="reportPeriodDisplay" class="report-period"></div>

<div class="summary-cards">
<div class="summary-card income"><div class="card-title">Total Income</div><div class="card-value" id="totalIncome">‚Çπ0.00</div></div>
<div class="summary-card expenses"><div class="card-title">Total Expenses</div><div class="card-value" id="totalExpenses">‚Çπ0.00</div></div>
<div class="summary-card net"><div class="card-title">Net Profit/Loss</div><div class="card-value" id="netProfit">‚Çπ0.00</div></div>
</div>

<div class="insights-section">
<h3><i class="fas fa-lightbulb"></i> Spending Insights</h3>
<div id="spendingInsights"></div>
</div>

<div class="chart-container">
<canvas id="profitLossChart"></canvas>
</div>

<div class="details-section">
<div class="income-details">
<h3 class="section-title">Income Breakdown</h3>
<div id="incomeBreakdown"></div>
</div>
<div class="expense-details">
<h3 class="section-title">Expense Breakdown</h3>
<div id="expenseBreakdown"></div>
</div>
</div>
</div>

<div id="loadingModal" class="loading-modal">
<div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;margin-bottom:15px;"></i><p>Generating report...</p></div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    query, 
    getDocs, 
    orderBy, 
    doc, 
    setDoc, 
    getDoc,
    updateDoc,
    serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
});

const db = getFirestore(app);
const auth = getAuth(app);

// DOM Elements
const usernameElem = document.getElementById("username");
const initialsElem = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const reportPeriod = document.getElementById("reportPeriod");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const customDateRange = document.getElementById("customDateRange");
const generateReportBtn = document.getElementById("generateReportBtn");
const reportPeriodDisplay = document.getElementById("reportPeriodDisplay");
const totalIncomeElem = document.getElementById("totalIncome");
const totalExpensesElem = document.getElementById("totalExpenses");
const netProfitElem = document.getElementById("netProfit");
const incomeBreakdownElem = document.getElementById("incomeBreakdown");
const expenseBreakdownElem = document.getElementById("expenseBreakdown");
const chartTypeSelect = document.getElementById("chartType");
const exportCSVBtn = document.getElementById("exportCSV");
const exportPDFBtn = document.getElementById("exportPDF");
const loadingModal = document.getElementById("loadingModal");
const generateMonthlyBtn = document.getElementById("generateMonthlyBtn");
const emailReportBtn = document.getElementById("emailReportBtn");
const autoEmailBtn = document.getElementById("autoEmailBtn");
const spendingInsightsElem = document.getElementById("spendingInsights");

let currentUser = null;
let allTransactions = [];
let profitLossChart = null;
let currentReportData = null;

// ===== Auth Listener =====
onAuthStateChanged(auth, async user => {
    if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = name.charAt(0).toUpperCase();
        
        setDefaultDates();
        await checkAndSendMonthlyEmail();
        generateReport();
    } else {
        alert("Login first.");
        window.location.href = "index.html";
    }
});

// ===== Logout =====
logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
});

// ===== Date Controls =====
reportPeriod.addEventListener("change", () => {
    customDateRange.style.display = reportPeriod.value === "custom" ? "flex" : "none";
});
generateReportBtn.addEventListener("click", generateReport);
chartTypeSelect.addEventListener("change", () => {
    if (allTransactions.length > 0) generateReport();
});
exportCSVBtn.addEventListener("click", exportCSV);
exportPDFBtn.addEventListener("click", exportPDF);
generateMonthlyBtn.addEventListener("click", generateMonthlyReport);
emailReportBtn.addEventListener("click", emailReport);
autoEmailBtn.addEventListener("click", setupAutoEmail);

// ===== Auto Email Setup =====
async function setupAutoEmail() {
    const result = await Swal.fire({
        title: 'Setup Auto Monthly Email',
        html: `
            <p>We will automatically send you a monthly financial report at the end of each month.</p>
            <p>The email will include:</p>
            <ul style="text-align: left; margin: 10px 0;">
                <li>PDF report attachment</li>
                <li>Top spending categories</li>
                <li>Financial insights</li>
                <li>Profit/Loss summary</li>
            </ul>
        `,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Enable Auto Emails',
        cancelButtonText: 'Cancel'
    });

    if (result.isConfirmed) {
        try {
            const userSettingsRef = doc(db, "users", currentUser.uid, "settings", "emailPreferences");
            await setDoc(userSettingsRef, {
                autoMonthlyEmail: true,
                lastEmailSent: null,
                updatedAt: serverTimestamp()
            });
            
            Swal.fire('Success!', 'Auto monthly emails have been enabled. You will receive a report at the end of each month.', 'success');
        } catch (error) {
            console.error("Error setting up auto email:", error);
            Swal.fire('Error', 'Failed to setup auto emails. Please try again.', 'error');
        }
    }
}

// ===== Check and Send Monthly Email =====
async function checkAndSendMonthlyEmail() {
    try {
        const userSettingsRef = doc(db, "users", currentUser.uid, "settings", "emailPreferences");
        const settingsDoc = await getDoc(userSettingsRef);
        
        if (!settingsDoc.exists() || !settingsDoc.data().autoMonthlyEmail) {
            return; // Auto email not enabled
        }

        const lastEmailSent = settingsDoc.data().lastEmailSent;
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // Check if we already sent email this month
        if (lastEmailSent) {
            const lastSentDate = lastEmailSent.toDate ? lastEmailSent.toDate() : new Date(lastEmailSent);
            if (lastSentDate.getMonth() === currentMonth && lastSentDate.getFullYear() === currentYear) {
                return; // Already sent this month
            }
        }

        // Check if it's the last day of the month (or 28th-31st for simplicity)
        const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        if (now.getDate() >= 28 && now.getDate() <= lastDayOfMonth) {
            // Generate and send monthly report
            await generateAndSendMonthlyEmail();
            
            // Update last sent date
            await updateDoc(userSettingsRef, {
                lastEmailSent: serverTimestamp()
            });
        }
    } catch (error) {
        console.error("Error in monthly email check:", error);
    }
}

// ===== Generate and Send Monthly Email =====
async function generateAndSendMonthlyEmail() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const transactions = await loadTransactions(startDate, endDate);
    
    if (transactions.length === 0) {
        return; // No transactions to report
    }

    // Generate PDF
    const pdfBlob = await generateMonthlyPDF(transactions, startDate, endDate);
    
    // Get spending insights for email content
    const spendingInsights = generateEmailSpendingInsights(transactions);
    
    // Create email content
    const monthName = startDate.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
    const subject = `üìä Your Monthly Financial Report - ${monthName}`;
    
    const body = `Hello ${currentUser.displayName || currentUser.email || 'Valued Customer'},

Here's your monthly financial report for ${monthName}:

üí∞ FINANCIAL SUMMARY:
‚Ä¢ Total Income: ‚Çπ${calculateTotalIncome(transactions).toFixed(2)}
‚Ä¢ Total Expenses: ‚Çπ${calculateTotalExpenses(transactions).toFixed(2)}
‚Ä¢ Net ${calculateNetProfit(transactions) >= 0 ? 'Profit' : 'Loss'}: ‚Çπ${Math.abs(calculateNetProfit(transactions)).toFixed(2)}

üìà SPENDING INSIGHTS:
${spendingInsights}

üí° KEY OBSERVATIONS:
${generateKeyObservations(transactions)}

Attached is your detailed PDF report with complete transaction breakdown.

Thank you for using our Budget App!

Best regards,
Budget App Team

This is an automated monthly report. To disable these emails, please update your preferences in the app.
`;

    // Create email with attachment simulation
    await sendEmailWithReport(subject, body, pdfBlob, monthName);
}

function generateEmailSpendingInsights(transactions) {
    const expensesByCategory = {};
    const expenses = transactions.filter(tx => parseFloat(tx.EXPENSE) > 0);
    
    expenses.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || "Uncategorized";
        expensesByCategory[category] = (expensesByCategory[category] || 0) + parseFloat(tx.EXPENSE);
    });
    
    const totalExpenses = expenses.reduce((sum, tx) => sum + parseFloat(tx.EXPENSE), 0);
    
    // Sort categories by amount
    const sortedCategories = Object.entries(expensesByCategory)
        .sort((a, b) => b[1] - a[1]);
    
    if (sortedCategories.length === 0) {
        return "No spending data available for this month.";
    }
    
    let insights = "";
    
    // üèÜ TOP EXPENSES (2 highest)
    insights += "üèÜ TOP EXPENSES:\n";
    for (let i = 0; i < Math.min(2, sortedCategories.length); i++) {
        const [category, amount] = sortedCategories[i];
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        insights += `‚Ä¢ ${category}: ‚Çπ${amount.toFixed(2)} (${percentage}%)\n`;
    }
    
    insights += "\n";
    
    // üìä AVERAGE EXPENSES (2 middle ones)
    insights += "üìä AVERAGE EXPENSES:\n";
    const midIndex = Math.floor(sortedCategories.length / 2);
    const averageCategories = [];
    
    // Get 2 categories from the middle
    if (sortedCategories.length >= 3) {
        averageCategories.push(sortedCategories[midIndex]);
        if (sortedCategories.length >= 4) {
            averageCategories.push(sortedCategories[midIndex + 1]);
        } else if (sortedCategories.length >= 2 && midIndex > 0) {
            averageCategories.push(sortedCategories[midIndex - 1]);
        }
    } else if (sortedCategories.length === 2) {
        // If only 2 categories, show the second one as average
        averageCategories.push(sortedCategories[1]);
    }
    
    if (averageCategories.length > 0) {
        averageCategories.forEach(([category, amount]) => {
            const percentage = ((amount / totalExpenses) * 100).toFixed(1);
            insights += `‚Ä¢ ${category}: ‚Çπ${amount.toFixed(2)} (${percentage}%)\n`;
        });
    } else {
        insights += "‚Ä¢ No average spending categories available\n";
    }
    
    insights += "\n";
    
    // üå± LEAST EXPENSES (2 lowest)
    insights += "üå± LEAST EXPENSES:\n";
    for (let i = Math.max(0, sortedCategories.length - 2); i < sortedCategories.length; i++) {
        const [category, amount] = sortedCategories[i];
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        insights += `‚Ä¢ ${category}: ‚Çπ${amount.toFixed(2)} (${percentage}%)\n`;
    }
    
    return insights;
}

function generateKeyObservations(transactions) {
    const totalIncome = calculateTotalIncome(transactions);
    const totalExpenses = calculateTotalExpenses(transactions);
    const netProfit = calculateNetProfit(transactions);
    
    let observations = "";
    
    if (netProfit > 0) {
        observations += `‚Ä¢ Great job! You saved ‚Çπ${netProfit.toFixed(2)} this month\n`;
        observations += `‚Ä¢ Your savings rate is ${((netProfit / totalIncome) * 100).toFixed(1)}% of income\n`;
    } else {
        observations += `‚Ä¢ Expenses exceeded income by ‚Çπ${Math.abs(netProfit).toFixed(2)}\n`;
        observations += `‚Ä¢ Consider reviewing your spending habits\n`;
    }
    
    // Add observation about largest expense category
    const expensesByCategory = {};
    transactions.filter(tx => parseFloat(tx.EXPENSE) > 0)
        .forEach(tx => {
            const category = tx.ACCOUNT_HEADER || "Uncategorized";
            expensesByCategory[category] = (expensesByCategory[category] || 0) + parseFloat(tx.EXPENSE);
        });
    
    const largestCategory = Object.entries(expensesByCategory)
        .sort((a, b) => b[1] - a[1])[0];
    
    if (largestCategory) {
        observations += `‚Ä¢ Largest expense category: ${largestCategory[0]} (‚Çπ${largestCategory[1].toFixed(2)})`;
    }
    
    return observations;
}

// ===== Email with PDF Attachment =====
async function sendEmailWithReport(subject, body, pdfBlob, monthName) {
    // For demo purposes, we'll create a downloadable PDF and show email content
    const pdfUrl = URL.createObjectURL(pdfBlob);
    
    // Show success message with download option
    const result = await Swal.fire({
        title: 'Monthly Report Ready!',
        html: `
            <div style="text-align: left;">
                <p>Your monthly financial report for ${monthName} is ready to be sent.</p>
                <p><strong>Email will include:</strong></p>
                <ul>
                    <li>PDF Report Attachment</li>
                    <li>Financial Summary</li>
                    <li>Spending Insights</li>
                    <li>Top/Average/Least Expenses</li>
                </ul>
                <p><strong>Recipient:</strong> ${currentUser.email}</p>
            </div>
        `,
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: 'Send Email & Download PDF',
        cancelButtonText: 'Just Download PDF',
        showDenyButton: true,
        denyButtonText: 'View Email Content'
    });

    if (result.isConfirmed) {
        // Download PDF
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfUrl;
        downloadLink.download = `Monthly_Report_${monthName.replace(' ', '_')}.pdf`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Simulate email sending
        Swal.fire('Email Sent!', `Report has been sent to ${currentUser.email} with PDF attachment.`, 'success');
        
    } else if (result.isDenied) {
        // Show email content preview
        Swal.fire({
            title: 'Email Content Preview',
            html: `
                <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                    <p><strong>To:</strong> ${currentUser.email}</p>
                    <p><strong>Subject:</strong> ${subject}</p>
                    <hr>
                    <pre style="white-space: pre-wrap; font-family: inherit;">${body}</pre>
                    <hr>
                    <p><em>+ PDF Attachment: Monthly_Report_${monthName.replace(' ', '_')}.pdf</em></p>
                </div>
            `,
            width: 800,
            confirmButtonText: 'Download PDF'
        }).then(() => {
            // Download PDF after viewing
            const downloadLink = document.createElement('a');
            downloadLink.href = pdfUrl;
            downloadLink.download = `Monthly_Report_${monthName.replace(' ', '_')}.pdf`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        });
    } else if (result.dismiss === Swal.DismissReason.cancel) {
        // Just download PDF
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfUrl;
        downloadLink.download = `Monthly_Report_${monthName.replace(' ', '_')}.pdf`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
}

// ===== Manual Email Report with PDF =====
async function emailReport() {
    if (!currentReportData || currentReportData.transactions.length === 0) {
        Swal.fire("Info", "No report data to email. Generate a report first.", "info");
        return;
    }
    
    const { period, totalIncome, totalExpenses, netProfit, transactions } = currentReportData;
    
    // Generate PDF for current report
    const { startDate, endDate } = getDateRange();
    const pdfBlob = await generateMonthlyPDF(transactions, startDate, endDate);
    
    // Get spending insights
    const spendingInsights = generateEmailSpendingInsights(transactions);
    
    const subject = `üìä Financial Report - ${period}`;
    
    const body = `Hello ${currentUser.displayName || currentUser.email || 'Valued Customer'},

Here's your financial report:

üìÖ PERIOD: ${period}

üí∞ FINANCIAL SUMMARY:
‚Ä¢ Total Income: ‚Çπ${totalIncome.toFixed(2)}
‚Ä¢ Total Expenses: ‚Çπ${totalExpenses.toFixed(2)}
‚Ä¢ Net ${netProfit >= 0 ? 'Profit' : 'Loss'}: ‚Çπ${Math.abs(netProfit).toFixed(2)}

üìà SPENDING INSIGHTS:
${spendingInsights}

üí° KEY OBSERVATIONS:
${generateKeyObservations(transactions)}

Attached is your detailed PDF report with complete transaction breakdown.

Thank you for using our Budget App!

Best regards,
Budget App Team
`;

    // Use the same email sending function
    const monthName = new Date().toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
    await sendEmailWithReport(subject, body, pdfBlob, monthName);
}

// ===== Generate Monthly PDF =====
async function generateMonthlyPDF(transactions, startDate, endDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const monthName = startDate.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
    
    // Header
    doc.setFontSize(18);
    doc.text("Monthly Financial Report", 105, 20, null, null, "center");
    doc.setFontSize(14);
    doc.text(monthName, 105, 30, null, null, "center");
    doc.setFontSize(10);
    doc.text(`Generated for: ${currentUser.email}`, 105, 37, null, null, "center");
    doc.text(`Period: ${formatDisplay(startDate)} to ${formatDisplay(endDate)}`, 105, 44, null, null, "center");
    
    // Summary Section
    doc.setFontSize(12);
    doc.text("Financial Summary", 14, 60);
    doc.setFontSize(10);
    
    const totalIncome = calculateTotalIncome(transactions);
    const totalExpenses = calculateTotalExpenses(transactions);
    const netProfit = calculateNetProfit(transactions);
    
    doc.text(`Total Income: ‚Çπ${totalIncome.toFixed(2)}`, 20, 70);
    doc.text(`Total Expenses: ‚Çπ${totalExpenses.toFixed(2)}`, 20, 77);
    doc.text(`Net ${netProfit >= 0 ? 'Profit' : 'Loss'}: ‚Çπ${Math.abs(netProfit).toFixed(2)}`, 20, 84);
    
    // Spending Insights
    const insights = generateEmailSpendingInsights(transactions);
    doc.setFontSize(12);
    doc.text("Spending Insights", 14, 100);
    doc.setFontSize(9);
    const splitInsights = doc.splitTextToSize(insights, 180);
    doc.text(splitInsights, 20, 110);
    
    // Key Observations
    const observations = generateKeyObservations(transactions);
    doc.setFontSize(12);
    doc.text("Key Observations", 14, 140);
    doc.setFontSize(9);
    const splitObservations = doc.splitTextToSize(observations, 180);
    doc.text(splitObservations, 20, 150);
    
    // Transactions Table
    doc.autoTable({
        startY: 170,
        head: [["Date", "Category", "Income", "Expense", "Notes"]],
        body: transactions.map(tx => [
            tx.DATE, 
            tx.ACCOUNT_HEADER || "", 
            tx.INCOME || 0, 
            tx.EXPENSE || 0, 
            (tx.NOTES || "").substring(0, 30)
        ]),
        theme: "grid",
        styles: { fontSize: 8 },
        headStyles: { fontSize: 8 }
    });
    
    // Return as blob
    return new Blob([doc.output('blob')], { type: 'application/pdf' });
}

// ===== Helper Functions =====
function calculateTotalIncome(transactions) {
    return transactions.filter(tx => parseFloat(tx.INCOME) > 0)
        .reduce((sum, tx) => sum + parseFloat(tx.INCOME), 0);
}

function calculateTotalExpenses(transactions) {
    return transactions.filter(tx => parseFloat(tx.EXPENSE) > 0)
        .reduce((sum, tx) => sum + parseFloat(tx.EXPENSE), 0);
}

function calculateNetProfit(transactions) {
    return calculateTotalIncome(transactions) - calculateTotalExpenses(transactions);
}

// ===== Set Default Dates =====
function setDefaultDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    startDateInput.value = formatDate(firstDay);
    endDateInput.value = formatDate(lastDay);
}

function formatDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
}

function formatDisplay(date) {
    return date.toLocaleDateString("en-IN", { year: "numeric", month: "long", day: "numeric" });
}

// ===== Date Range =====
function getDateRange() {
    const today = new Date();
    let startDate, endDate;
    
    switch (reportPeriod.value) {
        case "month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case "lastMonth":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case "quarter":
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
            break;
        case "year":
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
        case "custom":
            startDate = new Date(startDateInput.value);
            endDate = new Date(endDateInput.value);
            break;
        default:
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    }
    
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);
    
    return { startDate, endDate };
}

// ===== Load Transactions =====
async function loadTransactions(startDate, endDate) {
    loadingModal.style.display = "flex";
    try {
        const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
        const q = query(transactionsRef, orderBy("DATE", "desc"));
        
        const snap = await getDocs(q);
        
        allTransactions = snap.docs
            .map(d => ({ id: d.id, ...d.data() }))
            .filter(tx => {
                if (!tx.DATE) return false;
                
                let transactionDate;
                if (typeof tx.DATE === 'string') {
                    transactionDate = new Date(tx.DATE);
                } else if (tx.DATE && typeof tx.DATE.toDate === 'function') {
                    transactionDate = tx.DATE.toDate();
                } else if (tx.DATE && typeof tx.DATE === 'object') {
                    transactionDate = new Date(tx.DATE);
                } else {
                    return false;
                }
                
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        
        return allTransactions;
    } catch (err) {
        console.error("Error loading transactions:", err);
        Swal.fire("Error", "Failed to load transactions: " + err.message, "error");
        return [];
    } finally {
        loadingModal.style.display = "none";
    }
}

// ===== Generate Report =====
async function generateReport() {
    const { startDate, endDate } = getDateRange();
    reportPeriodDisplay.textContent = `Report: ${formatDisplay(startDate)} to ${formatDisplay(endDate)}`;
    
    const transactions = await loadTransactions(startDate, endDate);
    
    if (transactions.length === 0) {
        resetReport();
        Swal.fire("Info", "No transactions found in the selected date range.", "info");
        return;
    }

    const totalIncome = calculateTotalIncome(transactions);
    const totalExpenses = calculateTotalExpenses(transactions);
    const netProfit = calculateNetProfit(transactions);

    totalIncomeElem.textContent = `‚Çπ${totalIncome.toFixed(2)}`;
    totalExpensesElem.textContent = `‚Çπ${totalExpenses.toFixed(2)}`;
    netProfitElem.textContent = `‚Çπ${netProfit.toFixed(2)}`;
    netProfitElem.style.color = netProfit > 0 ? "#2ecc71" : netProfit < 0 ? "#e74c3c" : "#3498db";

    currentReportData = {
        period: reportPeriodDisplay.textContent,
        totalIncome,
        totalExpenses,
        netProfit,
        transactions
    };

    updateBreakdown(transactions, "INCOME", incomeBreakdownElem);
    updateBreakdown(transactions, "EXPENSE", expenseBreakdownElem);
    generateSpendingInsights(transactions);
    updateChart(transactions);
}

function resetReport() {
    totalIncomeElem.textContent = "‚Çπ0.00";
    totalExpensesElem.textContent = "‚Çπ0.00";
    netProfitElem.textContent = "‚Çπ0.00";
    incomeBreakdownElem.innerHTML = "";
    expenseBreakdownElem.innerHTML = "";
    spendingInsightsElem.innerHTML = "";
    if (profitLossChart) {
        profitLossChart.destroy();
    }
}

function updateBreakdown(transactions, type, container) {
    const byCat = {};
    transactions.filter(tx => parseFloat(tx[type]) > 0)
        .forEach(tx => {
            const cat = tx.ACCOUNT_HEADER || "Uncategorized";
            byCat[cat] = (byCat[cat] || 0) + parseFloat(tx[type]);
        });
    
    container.innerHTML = Object.keys(byCat).length === 0 
        ? '<p class="empty-state"><i class="fa fa-info-circle"></i> No data</p>'
        : Object.entries(byCat).map(([k, v]) => 
            `<div class="transaction-item">
                <div class="transaction-category">${k}</div>
                <div class="transaction-amount">‚Çπ${v.toFixed(2)}</div>
            </div>`
        ).join("");
}

function generateSpendingInsights(transactions) {
    const expensesByCategory = {};
    const expenses = transactions.filter(tx => parseFloat(tx.EXPENSE) > 0);
    
    expenses.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || "Uncategorized";
        expensesByCategory[category] = (expensesByCategory[category] || 0) + parseFloat(tx.EXPENSE);
    });
    
    const totalExpenses = expenses.reduce((sum, tx) => sum + parseFloat(tx.EXPENSE), 0);
    
    const sortedCategories = Object.entries(expensesByCategory)
        .sort((a, b) => b[1] - a[1]);
    
    spendingInsightsElem.innerHTML = "";
    
    if (sortedCategories.length === 0) {
        spendingInsightsElem.innerHTML = '<p class="empty-state">No spending data available for insights.</p>';
        return;
    }
    
    const [topCategory, topAmount] = sortedCategories[0];
    const topPercentage = ((topAmount / totalExpenses) * 100).toFixed(1);
    
    let insightHTML = `
        <div class="insight-item">
            <div class="insight-header">
                <i class="fas fa-chart-pie insight-high"></i>
                <strong>Top Spending Category</strong>
            </div>
            <p>Your highest spending was on <strong>${topCategory}</strong> at ‚Çπ${topAmount.toFixed(2)} (${topPercentage}% of total expenses).</p>
        </div>
    `;
    
    const highSpendCategories = sortedCategories.filter(([cat, amount]) => 
        (amount / totalExpenses) >= 0.3);
    
    if (highSpendCategories.length > 0 && highSpendCategories[0][0] !== topCategory) {
        insightHTML += `
            <div class="insight-item">
                <div class="insight-header">
                    <i class="fas fa-exclamation-triangle insight-high"></i>
                    <strong>High Spending Alert</strong>
                </div>
                <p>${highSpendCategories.map(([cat, amount]) => 
                    `${cat} (${((amount / totalExpenses) * 100).toFixed(1)}% of expenses)`
                ).join(', ')} account for a significant portion of your spending. Consider reviewing these areas.</p>
            </div>
        `;
    }
    
    if (sortedCategories.length >= 3) {
        const [first, second, third] = sortedCategories;
        insightHTML += `
            <div class="insight-item">
                <div class="insight-header">
                    <i class="fas fa-balance-scale insight-medium"></i>
                    <strong>Spending Distribution</strong>
                </div>
                <p>Your top 3 spending categories are: 
                <strong>${first[0]}</strong> (${((first[1] / totalExpenses) * 100).toFixed(1)}%), 
                <strong>${second[0]}</strong> (${((second[1] / totalExpenses) * 100).toFixed(1)}%), 
                and <strong>${third[0]}</strong> (${((third[1] / totalExpenses) * 100).toFixed(1)}%).</p>
            </div>
        `;
    }
    
    const totalIncome = calculateTotalIncome(transactions);
    const netProfit = calculateNetProfit(transactions);
    const profitPercentage = totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) : 0;
    
    if (netProfit > 0) {
        insightHTML += `
            <div class="insight-item">
                <div class="insight-header">
                    <i class="fas fa-smile insight-low"></i>
                    <strong>Positive Cash Flow</strong>
                </div>
                <p>Great job! You have a net profit of ‚Çπ${netProfit.toFixed(2)} (${profitPercentage}% of income).</p>
            </div>
        `;
    } else {
        insightHTML += `
            <div class="insight-item">
                <div class="insight-header">
                    <i class="fas fa-exclamation-circle insight-high"></i>
                    <strong>Negative Cash Flow</strong>
                </div>
                <p>Your expenses exceed your income by ‚Çπ${Math.abs(netProfit).toFixed(2)}. Consider reviewing your spending habits.</p>
            </div>
        `;
    }
    
    spendingInsightsElem.innerHTML = insightHTML;
}

function updateChart(transactions) {
    const byCatIncome = {}, byCatExpense = {};
    
    transactions.forEach(tx => {
        if (parseFloat(tx.INCOME) > 0) {
            const cat = tx.ACCOUNT_HEADER || "Income";
            byCatIncome[cat] = (byCatIncome[cat] || 0) + parseFloat(tx.INCOME);
        }
        if (parseFloat(tx.EXPENSE) > 0) {
            const cat = tx.ACCOUNT_HEADER || "Expense";
            byCatExpense[cat] = (byCatExpense[cat] || 0) + parseFloat(tx.EXPENSE);
        }
    });
    
    const labels = [...new Set([...Object.keys(byCatIncome), ...Object.keys(byCatExpense)])];
    const incomeData = labels.map(l => byCatIncome[l] || 0);
    const expenseData = labels.map(l => byCatExpense[l] || 0);
    
    const ctx = document.getElementById("profitLossChart").getContext("2d");
    if (profitLossChart) {
        profitLossChart.destroy();
    }
    
    profitLossChart = new Chart(ctx, {
        type: chartTypeSelect.value,
        data: {
            labels,
            datasets: [
                {
                    label: "Income",
                    data: incomeData,
                    backgroundColor: "#2ecc71"
                },
                {
                    label: "Expenses",
                    data: expenseData,
                    backgroundColor: "#e74c3c"
                }
            ]
        },
        options: {
            responsive: true
        }
    });
}

// ===== Monthly Report =====
async function generateMonthlyReport() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const endDate = new Date(today.getFullYear(), today.getMonth(), 0);
    
    reportPeriod.value = "lastMonth";
    startDateInput.value = formatDate(startDate);
    endDateInput.value = formatDate(endDate);
    
    await generateReport();
    exportPDF(true);
}

// ===== Export =====
function exportCSV() {
    if (allTransactions.length === 0) {
        alert("No data to export.");
        return;
    }
    
    let csv = "DATE,ACCOUNT_HEADER,INCOME,EXPENSE,NOTES\n";
    allTransactions.forEach(tx => {
        csv += `${tx.DATE},${tx.ACCOUNT_HEADER || ""},${tx.INCOME || 0},${tx.EXPENSE || 0},${tx.NOTES || ""}\n`;
    });
    
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ProfitLossReport.csv";
    a.click();
    URL.revokeObjectURL(url);
}

function exportPDF(isMonthly = false) {
    if (allTransactions.length === 0) {
        alert("No data to export.");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const reportTitle = isMonthly ? "Monthly Financial Report" : "Profit & Loss Report";
    
    doc.setFontSize(18);
    doc.text(reportTitle, 105, 15, null, null, "center");
    doc.setFontSize(12);
    doc.text(`Generated for ${currentUser.email || "User"}`, 105, 23, null, null, "center");
    doc.text(reportPeriodDisplay.textContent, 105, 30, null, null, "center");

    doc.setFontSize(14);
    doc.text("Summary", 14, 45);
    doc.setFontSize(12);
    doc.text(`Total Income: ‚Çπ${totalIncomeElem.textContent.replace("‚Çπ", "")}`, 14, 53);
    doc.text(`Total Expenses: ‚Çπ${totalExpensesElem.textContent.replace("‚Çπ", "")}`, 14, 60);
    doc.text(`Net Profit/Loss: ‚Çπ${netProfitElem.textContent.replace("‚Çπ", "")}`, 14, 67);

    if (isMonthly) {
        const insights = spendingInsightsElem.innerText;
        if (insights) {
            doc.text("Spending Insights", 14, 80);
            const splitInsights = doc.splitTextToSize(insights, 180);
            doc.text(splitInsights, 14, 88);
        }
    }

    doc.autoTable({
        startY: isMonthly ? 110 : 75,
        head: [["Date", "Category", "Income", "Expense", "Notes"]],
        body: allTransactions.map(tx => [
            tx.DATE, 
            tx.ACCOUNT_HEADER || "", 
            tx.INCOME || 0, 
            tx.EXPENSE || 0, 
            tx.NOTES || ""
        ]),
        theme: "grid"
    });
    
    const fileName = isMonthly ? 
        `Monthly_Report_${new Date().getFullYear()}_${new Date().getMonth()}.pdf` : 
        "ProfitLossReport.pdf";
    
    doc.save(fileName);
}
</script>
</body>
</html>