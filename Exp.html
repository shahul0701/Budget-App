<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Transactions</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Keep your styling consistent */
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-left {
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #userInitials {
      background: #007bff;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    #username {
      font-weight: bold;
    }

    #logoutBtn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #a71d2a;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      background-color: #fff;
      padding: 20px 30px 40px;
      border-radius: 8px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background-color: #f1f1f1;
      font-weight: bold;
    }

    .pagination {
      margin-top: 15px;
      text-align: center;
    }

    .pagination button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 8px 12px;
      margin: 0 3px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
    }

    .pagination button:disabled {
      background-color: #cccccc;
      cursor: default;
    }

    /* Attachment link styling */
    .attachment-link {
      color: #007bff;
      text-decoration: none;
    }

    .attachment-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<!-- Top Header -->
<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left: 20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <h2>User Transactions</h2>

  <table>
    <thead>
      <tr>
        <th>SINO</th>
        <th>DATE</th>
        <th>TIME</th>
        <th>ACCOUNT HEADER</th>
        <th>MODE</th>
        <th>BANK NAME</th>
        <th>INCOME</th>
        <th>EXPENSES</th>
        <th>DESCRIPTION</th>
        <th>BALANCE</th>
        <th>ATTACHMENT</th>
      </tr>
    </thead>
    <tbody id="transactionsTableBody"></tbody>
  </table>

  <div class="pagination" id="paginationControls">
    <button id="prevPage" disabled>Previous</button>
    <span id="pageInfo"></span>
    <button id="nextPage" disabled>Next</button>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    orderBy,
    limit,
    startAfter,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const userInitialsElem = document.getElementById("userInitials");
  const usernameElem = document.getElementById("username");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");

  const transactionsTableBody = document.getElementById("transactionsTableBody");
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  const pageInfo = document.getElementById("pageInfo");

  let currentUser = null;
  let transactions = [];
  let currentPage = 1;
  const pageSize = 10;
  let totalPages = 1;

  // Show date/time live
  function updateDateTime() {
    const now = new Date();
    datetimeElem.textContent = now.toLocaleString();
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  // Format date to YYYY-MM-DD
  function formatDate(timestamp) {
    if (!timestamp) return "";
    const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return d.toLocaleDateString();
  }

  // Format time HH:mm:ss
  function formatTime(timestamp) {
    if (!timestamp) return "";
    const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return d.toLocaleTimeString();
  }

  // Render transactions for the current page
  function renderTransactions() {
    transactionsTableBody.innerHTML = "";

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = transactions.slice(start, end);

    if (pageItems.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 11;
      td.style.textAlign = "center";
      td.textContent = "No transactions found.";
      tr.appendChild(td);
      transactionsTableBody.appendChild(tr);
      pageInfo.textContent = "";
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
      return;
    }

    pageItems.forEach((txn, index) => {
      const tr = document.createElement("tr");

      const attachmentCell = document.createElement("td");
      if (txn.attachmentUrl) {
        const link = document.createElement("a");
        link.href = txn.attachmentUrl;
        link.target = "_blank";
        link.textContent = "View";
        link.className = "attachment-link";
        attachmentCell.appendChild(link);
      } else {
        attachmentCell.textContent = "â€”";
      }

      tr.innerHTML = `
        <td>${start + index + 1}</td>
        <td>${txn.date || ""}</td>
        <td>${txn.time || ""}</td>
        <td>${txn.accountHeader || ""}</td>
        <td>${txn.mode || ""}</td>
        <td>${txn.bankName || ""}</td>
        <td>${txn.income || ""}</td>
        <td>${txn.expenses || ""}</td>
        <td>${txn.description || ""}</td>
        <td>${txn.balance || ""}</td>
      `;
      tr.appendChild(attachmentCell);

      transactionsTableBody.appendChild(tr);
    });

    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    prevPageBtn.disabled = currentPage === 1;
    nextPageBtn.disabled = currentPage === totalPages;
  }

  // Pagination handlers
  prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderTransactions();
    }
  });

  nextPageBtn.addEventListener("click", () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderTransactions();
    }
  });

  // Load user transactions from Firestore
  async function loadTransactions(userId) {
    const q = query(
      collection(db, "transactions"),
      where("userId", "==", userId),
      orderBy("date", "desc"),
      orderBy("time", "desc")
    );
    const querySnapshot = await getDocs(q);
    transactions = [];

    querySnapshot.forEach(doc => {
      const data = doc.data();
      transactions.push({
        id: doc.id,
        date: data.date || "",
        time: data.time || "",
        accountHeader: data.accountHeader || "",
        mode: data.mode || "",
        bankName: data.bankName || "",
        income: data.income || "",
        expenses: data.expenses || "",
        description: data.description || "",
        balance: data.balance || "",
        attachmentUrl: data.attachmentUrl || ""
      });
    });

    totalPages = Math.ceil(transactions.length / pageSize) || 1;
    currentPage = 1;
    renderTransactions();
  }

  // Show user info
  function displayUser(user) {
    const displayName = user.displayName || user.email || "User";
    usernameElem.textContent = displayName;
    const initials = displayName.split(" ").map(n => n[0]).join("").toUpperCase();
    userInitialsElem.textContent = initials || "U";
  }

  // Logout handler
  logoutBtn.addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        window.location.href = "login.html";
      })
      .catch(console.error);
  });

  // Auth state listener
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      displayUser(user);
      loadTransactions(user.uid);
    } else {
      // No user signed in, redirect to login
      window.location.href = "login.html";
    }
  });
</script>

</body>
</html>
