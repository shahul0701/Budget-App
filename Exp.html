<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense & Income Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0; padding: 0;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 20px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header-left {
      font-weight: bold;
    }
    .header-right {
      display: flex; align-items: center; gap: 10px;
    }
    #userInitials {
      background: #007bff; color: white; border-radius: 50%;
      width: 32px; height: 32px;
      display: flex; justify-content: center; align-items: center;
      font-weight: bold;
    }
    #username {
      font-weight: bold;
    }
    #logoutBtn {
      background: #dc3545; color: white; border: none;
      border-radius: 4px; padding: 6px 12px; cursor: pointer;
    }
    #logoutBtn:hover {
      background: #a71d2a;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    form {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 15px 20px;
      align-items: center;
    }
    label {
      font-weight: bold;
    }
    select, input[type="text"], input[type="number"], input[type="date"] {
      padding: 8px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      grid-column: 2 / 3;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      width: fit-content;
    }
    button:hover {
      background: #218838;
    }
    #uploadCSVBtn {
      background: #007bff;
      margin-left: 10px;
    }
    #uploadCSVBtn:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #f1f1f1;
    }
    .Income {
      color: green;
    }
    .Expense {
      color: red;
    }
    .action-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      margin-right: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    .action-btn:hover {
      background: #0056b3;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left: 20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
  <h2>Expense & Income Manager</h2>

  <!-- Upload CSV file -->
  <div style="margin-bottom: 20px;">
    <label for="csvFile">Upload CSV: </label>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="uploadCSVBtn">Upload CSV</button>
  </div>

  <!-- Add/Edit Form -->
  <form id="entryForm">
    <input type="hidden" id="entryId" />
    <label for="entryType">Type</label>
    <select id="entryType" required>
      <option value="">Select Type</option>
      <option value="Income">Income</option>
      <option value="Expense">Expense</option>
    </select>

    <label for="entryCategory">Category</label>
    <input type="text" id="entryCategory" placeholder="e.g. Sales, Rent" required />

    <label for="entryAmount">Amount</label>
    <input type="number" id="entryAmount" min="0" step="0.01" placeholder="0.00" required />

    <label for="entryDate">Date</label>
    <input type="date" id="entryDate" required />

    <label for="entryDescription">Description</label>
    <input type="text" id="entryDescription" placeholder="Optional" />

    <div></div>
    <button type="submit" id="submitBtn">Add Entry</button>
    <button type="button" id="cancelEditBtn" style="display:none; margin-left:10px;">Cancel Edit</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="entriesTable"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const entryForm = document.getElementById("entryForm");
  const entryTypeSelect = document.getElementById("entryType");
  const entryCategoryInput = document.getElementById("entryCategory");
  const entryAmountInput = document.getElementById("entryAmount");
  const entryDateInput = document.getElementById("entryDate");
  const entryDescriptionInput = document.getElementById("entryDescription");
  const entryIdInput = document.getElementById("entryId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const entriesTable = document.getElementById("entriesTable");

  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");
  const csvFileInput = document.getElementById("csvFile");
  const uploadCSVBtn = document.getElementById("uploadCSVBtn");

  let currentUser = null;

  // Real-time clock
  function updateTime() {
    const now = new Date();
    datetimeElem.textContent = now.toLocaleString();
  }
  setInterval(updateTime, 1000);
  updateTime();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const storedUsername = localStorage.getItem("username");
      const displayName = storedUsername || user.displayName || user.email;
      usernameElem.textContent = displayName;
      profileCircle.textContent = displayName.charAt(0).toUpperCase();
      await loadEntries();
    } else {
      setTimeout(() => {
        if (!auth.currentUser) {
          alert("You must be logged in.");
          window.location.href = "index.html";
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    localStorage.removeItem("username");
    await signOut(auth);
    window.location.href = "index.html";
  });

  function resetForm() {
    entryForm.reset();
    entryIdInput.value = "";
    submitBtn.textContent = "Add Entry";
    cancelEditBtn.style.display = "none";
  }

  cancelEditBtn.addEventListener("click", () => {
    resetForm();
  });

  entryForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentUser) return alert("User not authenticated.");

    const entryData = {
      type: entryTypeSelect.value,
      category: entryCategoryInput.value.trim(),
      amount: parseFloat(entryAmountInput.value),
      date: entryDateInput.value,
      description: entryDescriptionInput.value.trim(),
      userId: currentUser.uid,
      timestamp: serverTimestamp(),
    };

    if (!entryData.type || !entryData.category || isNaN(entryData.amount) || !entryData.date) {
      return alert("Please fill in all required fields.");
    }

    try {
      if (entryIdInput.value) {
        // Update existing
        const docRef = doc(db, "expensesIncome", entryIdInput.value);
        await updateDoc(docRef, entryData);
        alert("Entry updated.");
      } else {
        // Add new
        await addDoc(collection(db, "expensesIncome"), entryData);
        alert("Entry added.");
      }
      resetForm();
      loadEntries();
    } catch (err) {
      console.error("Error adding/updating entry:", err);
      alert("Error saving entry.");
    }
  });

  async function loadEntries() {
    if (!currentUser) return;

    entriesTable.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
    try {
      const q = query(collection(db, "expensesIncome"), where("userId", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        entriesTable.innerHTML = "<tr><td colspan='6'>No entries found.</td></tr>";
        return;
      }

      entriesTable.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const entry = docSnap.data();
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="${entry.type}">${entry.type}</td>
          <td>${entry.category}</td>
          <td>${entry.amount.toFixed(2)}</td>
          <td>${entry.date}</td>
          <td>${entry.description || ""}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${docSnap.id}"><i class="fa fa-edit"></i></button>
            <button class="action-btn delete-btn" data-id="${docSnap.id}"><i class="fa fa-trash"></i></button>
          </td>
        `;

        entriesTable.appendChild(tr);
      });

      // Attach edit/delete handlers
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          editEntry(id);
        });
      });
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          deleteEntry(id);
        });
      });
    } catch (err) {
      console.error("Error loading entries:", err);
      entriesTable.innerHTML = "<tr><td colspan='6'>Failed to load entries.</td></tr>";
    }
  }

  async function editEntry(id) {
    const docRef = doc(db, "expensesIncome", id);
    const docSnap = await getDocs(query(collection(db, "expensesIncome"), where("__name__", "==", id)));
    // or getDoc from firestore
    import { getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const docSnapshot = await getDoc(docRef);
    if (!docSnapshot.exists()) {
      alert("Entry not found.");
      return;
    }
    const data = docSnapshot.data();

    entryIdInput.value = id;
    entryTypeSelect.value = data.type;
    entryCategoryInput.value = data.category;
    entryAmountInput.value = data.amount;
    entryDateInput.value = data.date;
    entryDescriptionInput.value = data.description || "";

    submitBtn.textContent = "Update Entry";
    cancelEditBtn.style.display = "inline-block";
  }

  async function deleteEntry(id) {
    if (!confirm("Are you sure you want to delete this entry?")) return;

    try {
      await deleteDoc(doc(db, "expensesIncome", id));
      alert("Entry deleted.");
      loadEntries();
    } catch (err) {
      console.error("Error deleting entry:", err);
      alert("Failed to delete entry.");
    }
  }

  // CSV Upload logic
  function parseCSV(text) {
    // Very simple CSV parser: expects header row: type,category,amount,date,description
    const lines = text.trim().split("\n");
    if (lines.length < 2) return [];

    const header = lines[0].toLowerCase().split(",").map(h => h.trim());
    const rows = lines.slice(1);
    return rows.map(row => {
      const cols = row.split(",");
      const obj = {};
      header.forEach((h, i) => {
        obj[h] = cols[i]?.trim() || "";
      });
      return obj;
    });
  }

  uploadCSVBtn.addEventListener("click", async () => {
    if (!csvFileInput.files.length) return alert("Please select a CSV file first.");
    const file = csvFileInput.files[0];
    const text = await file.text();
    const entries = parseCSV(text);

    if (!entries.length) return alert("No valid entries found in CSV.");

    let failed = 0;
    for (const entry of entries) {
      if (!entry.type || !entry.category || !entry.amount || !entry.date) {
        failed++;
        continue;
      }
      if (!["Income", "Expense"].includes(entry.type)) {
        failed++;
        continue;
      }
      try {
        await addDoc(collection(db, "expensesIncome"), {
          type: entry.type,
          category: entry.category,
          amount: parseFloat(entry.amount),
          date: entry.date,
          description: entry.description || "",
          userId: currentUser.uid,
          timestamp: serverTimestamp(),
        });
      } catch (e) {
        failed++;
      }
    }
    alert(`Upload completed. Failed entries: ${failed}`);
    csvFileInput.value = "";
    loadEntries();
  });
</script>
</body>
</html>
