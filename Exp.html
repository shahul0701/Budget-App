<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‑8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Transactions Upload</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
    .header { background:#fff; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header-left a { text-decoration:none; color:#007bff; font-weight:bold; font-size:18px; }
    .header-right { display:flex; align-items:center; gap:12px; }
    #userInitials { background:#007bff; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; }
    #username { font-weight:bold; font-size:16px; }
    #logoutBtn { background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; }
    #logoutBtn:hover { background:#a71d2a; }
    .container { max-width:1200px; margin:30px auto; background:#fff; padding:20px 30px 40px; border-radius:8px; box-shadow:0 0 12px rgba(0,0,0,0.1); }
    h2 { text-align:center; margin-bottom:20px; }
    #csvInput { margin-bottom:20px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border:1px solid #ccc; padding:8px 10px; text-align:left; }
    th { background:#f1f1f1; }
    td.attachment-cell a { color:#007bff; text-decoration:none; }
    td.attachment-cell a:hover { text-decoration:underline; }
    .filter-section { margin-bottom:20px; background:#f9f9f9; padding:15px 20px; border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
    .filters-row { display:flex; flex-wrap:wrap; gap:15px; align-items:center; }
    .filters-row label { font-size:14px; display:flex; flex-direction:column; min-width:140px; }
    .filters-row select, .filters-row input { margin-top:5px; padding:5px 8px; font-size:14px; border-radius:4px; border:1px solid #ccc; }
    #applyFiltersBtn { background:#007bff; padding:8px 16px; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-top:20px; }
    #applyFiltersBtn:hover { background:#0056b3; }
    .loading-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .loading-content { text-align:center; font-size:18px; color:#007bff; }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
    <div class="header-right">
      <div id="userInitials">U</div>
      <div id="username">User</div>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
    <h2>Upload Expense Transactions CSV</h2>
    <input type="file" id="csvInput" accept=".csv" />

    <div class="filter-section">
      <div class="filters-row">
        <label>Date Filter:
          <select id="dateFilter"><option value="all">All</option><option value="week">This Week</option><option value="month">This Month</option><option value="year">This Year</option><option value="custom">Custom Range</option></select>
        </label>
        <label id="customDateRange" style="display:none;">From: <input type="date" id="startDate" /> To: <input type="date" id="endDate" /></label>
        <label>Income/Expense:
          <select id="incomeExpenseFilter"><option value="all">All</option><option value="income">Income Only</option><option value="expense">Expense Only</option></select>
        </label>
        <label>Description contains:<input type="text" id="descFilter" placeholder="Search…"/></label>
        <label>Mode:<select id="modeFilter"><option value="all">All</option></select></label>
        <label>Bank:<select id="bankFilter"><option value="all">All</option></select></label>
        <button id="applyFiltersBtn">Apply Filters</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>SINO</th><th>DATE</th><th>TIME</th><th>ACCOUNT HEADER</th><th>MODE</th><th>BANK NAME</th><th>INCOME</th><th>EXPENSES</th><th>DESCRIPTION</th><th>BALANCE</th><th>ATTACHMENT</th>
        </tr>
      </thead>
      <tbody id="transactionsTableBody">
        <tr><td colspan="11" style="text-align:center; color:#777;">No transactions loaded.</td></tr>
      </tbody>
    </table>
  </div>

  <div id="loadingModal" class="loading-modal" style="display:none;">
    <div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;"></i><p>Loading, please wait…</p></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp({
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    });
    const db = getFirestore(app), auth = getAuth(app);

    const usernameElem = document.getElementById("username"), initialsElem = document.getElementById("userInitials"), logoutBtn = document.getElementById("logoutBtn");
    const csvInput = document.getElementById("csvInput"), tableBody = document.getElementById("transactionsTableBody");
    const loadingModal = document.getElementById("loadingModal"), dateFilter = document.getElementById("dateFilter");
    const customDateRange = document.getElementById("customDateRange"), startDateInput = document.getElementById("startDate"), endDateInput = document.getElementById("endDate");
    const incomeExpenseFilter = document.getElementById("incomeExpenseFilter"), descFilter = document.getElementById("descFilter");
    const modeFilter = document.getElementById("modeFilter"), bankFilter = document.getElementById("bankFilter");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");

    let currentUser = null, allTransactions = [];

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = name.charAt(0).toUpperCase();
        await loadTransactions();
      } else {
        alert("Please login first.");
        window.location.href = "index.html";
      }
    });

    logoutBtn.addEventListener("click", async () => { await signOut(auth); window.location.href = "index.html"; });

    csvInput.addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file || !file.name.toLowerCase().endsWith(".csv")) return alert("Please upload a valid CSV file.");

      loadingModal.style.display = "flex";
      const text = await file.text(), parsed = parseCSV(text);
 const requiredCols = [
  "SINO", "DATE", "TIME", "ACCOUNT HEADER", "MODE", "BANK NAME",
  "INCOME", "EXPENSES", "DESCRIPTION", "BALANCE", "ATTACHEMENT"
];
for (let h of requiredCols) {
  if (!parsed[0]?.[h]) {
    alert(`Missing column "${h}"`);
    loadingModal.style.display = "none";
    return;
  }
}


      try {
        await clearUserTransactions();
        const txRef = collection(db, "users", currentUser.uid, "transactions");
        for (let row of parsed) {
          await addDoc(txRef, {
            SINO: row.SINO, DATE: row.DATE, TIME: row.TIME,
            ACCOUNT_HEADER: row["ACCOUNT HEADER"], MODE: row.MODE, BANK_NAME: row["BANK NAME"],
            INCOME: parseFloat(row.INCOME)||0, EXPENSES: parseFloat(row.EXPENSES)||0,
            DESCRIPTION: row.DESCRIPTION, BALANCE: parseFloat(row.BALANCE)||0,
            ATTACHMENT: row["ATTACHMENT"] || ""
          });
        }
        alert("CSV uploaded successfully!");
        csvInput.value="";
        await loadTransactions();
      } catch (err) {
        alert("Error saving data: " + err.message);
      } finally {
        loadingModal.style.display = "none";
      }
    });

    dateFilter.addEventListener("change", () => {
      customDateRange.style.display = dateFilter.value==="custom"?"inline-flex":"none";
      if (dateFilter.value !== "custom") startDateInput.value = "", endDateInput.value = "";
    });

    applyFiltersBtn.addEventListener("click", applyFilters);

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/), headers = lines[0].split(",").map(h=>h.trim());
      return lines.slice(1).map(line => {
        const vals = line.split(",").map(v=>v.trim()), obj={};
        headers.forEach((h,i)=>obj[h] = vals[i]||"");
        return obj;
      });
    }

    async function clearUserTransactions() {
      const txRef = collection(db, "users", currentUser.uid, "transactions"), snap = await getDocs(txRef);
      if (snap.empty) return;
      const batch = writeBatch(db);
      snap.docs.forEach(d=>batch.delete(d.ref));
      await batch.commit();
    }

    async function loadTransactions() {
      tableBody.innerHTML = "";
      loadingModal.style.display = "flex";
      try {
        const txRef = collection(db, "users", currentUser.uid, "transactions"), snap = await getDocs(txRef);
        allTransactions = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        allTransactions.sort((a,b)=>(parseInt(b.SINO)||0)-(parseInt(a.SINO)||0));
        populateOptions(allTransactions);
        renderTable(allTransactions);
      } catch (err) {
        alert("Error loading transactions: " + err.message);
      } finally {
        loadingModal.style.display = "none";
      }
    }

    function populateOptions(data) {
      const modes = new Set(), banks = new Set();
      data.forEach(t=>{ if(t.MODE) modes.add(t.MODE); if(t.BANK_NAME) banks.add(t.BANK_NAME); });
      modeFilter.innerHTML = `<option value="all">All</option>`+[...modes].sort().map(v=>`<option>${v}</option>`).join("");
      bankFilter.innerHTML = `<option value="all">All</option>`+[...banks].sort().map(v=>`<option>${v}</option>`).join("");
    }

    function applyFilters() {
      let filtered = allTransactions.slice(), now = new Date();
      const isIn = (str,s,e)=>str && new Date(str)>=s && new Date(str)<=e;

      switch(dateFilter.value) {
        case "week": {
          let s = new Date(now); s.setHours(0,0,0,0); s.setDate(now.getDate()-now.getDay());
          filtered = filtered.filter(t=>isIn(t.DATE, s, now)); break;
        }
        case "month": {
          let s = new Date(now.getFullYear(), now.getMonth(),1);
          filtered = filtered.filter(t=>isIn(t.DATE, s, now)); break;
        }
        case "year": {
          let s = new Date(now.getFullYear(),0,1);
          filtered = filtered.filter(t=>isIn(t.DATE, s, now)); break;
        }
        case "custom":
          if(startDateInput.value && endDateInput.value){
            let s = new Date(startDateInput.value), e = new Date(endDateInput.value);
            e.setHours(23,59,59,999);
            filtered = filtered.filter(t=>isIn(t.DATE, s, e));
          }
      }

      if(incomeExpenseFilter.value==="income") filtered = filtered.filter(t => (t.INCOME||0)>0);
      else if(incomeExpenseFilter.value==="expense") filtered = filtered.filter(t => (t.EXPENSES||0)>0);

      if(descFilter.value.trim()){
        const search=descFilter.value.trim().toLowerCase();
        filtered = filtered.filter(t=> (t.DESCRIPTION||"").toLowerCase().includes(search));
      }

      if(modeFilter.value!=="all") filtered = filtered.filter(t=>t.MODE===modeFilter.value);
      if(bankFilter.value!=="all") filtered = filtered.filter(t=>t.BANK_NAME===bankFilter.value);

      renderTable(filtered);
    }

function renderTable(data) {
  tableBody.innerHTML = "";
  if (data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:#777;">No transactions match the filters.</td></tr>`;
    return;
  }

  data.forEach(d => {
    const tr = document.createElement("tr");
    const incomeCell = d.INCOME > 0 ? `<span style="color:green;">${d.INCOME.toFixed(2)}</span>` : "";
    const expenseCell = d.EXPENSES > 0 ? `<span style="color:red;">${d.EXPENSES.toFixed(2)}</span>` : "";
    const balanceCell = d.BALANCE !== 0 ? d.BALANCE.toFixed(2) : "";

    tr.innerHTML = `
      <td>${escapeHtml(d.SINO)}</td>
      <td>${escapeHtml(d.DATE)}</td>
      <td>${escapeHtml(d.TIME)}</td>
      <td>${escapeHtml(d.ACCOUNT_HEADER)}</td>
      <td>${escapeHtml(d.MODE)}</td>
      <td>${escapeHtml(d.BANK_NAME)}</td>
      <td>${incomeCell}</td>
      <td>${expenseCell}</td>
      <td>${escapeHtml(d.DESCRIPTION)}</td>
      <td>${balanceCell}</td>
      <td class="attachment-cell">
        ${d.ATTACHMENT ? `<a href="${escapeHtml(d.ATTACHMENT)}" target="_blank">View</a>` : "-"}
      </td>
    `;
    tableBody.appendChild(tr);
  });
}


    function escapeHtml(t) {
      if(!t) return "";
      return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
              .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
  </script>
</body>
</html>
