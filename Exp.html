<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense & Income Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .header-left{font-weight:bold;}
    .header-right{display:flex; align-items:center; gap:10px;}
    #userInitials {background:#007bff; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold;}
    #username{font-weight:bold;}
    #logoutBtn{background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 12px; cursor:pointer;}
    #logoutBtn:hover{background:#a71d2a;}
    .container{max-width:900px; margin:30px auto; background:#fff; padding:30px; border-radius:8px;}
    h2{text-align:center; margin-bottom:20px;}
    form{display:grid; grid-template-columns:150px 1fr; gap:15px 20px; align-items:center;}
    label{font-weight:bold;}
    select,input[type="text"],input[type="number"],input[type="date"]{padding:8px; font-size:1rem; width:100%; box-sizing:border-box;}
    button{grid-column:2; background:#28a745; color:#fff; padding:10px 20px; border:none; font-size:1rem; border-radius:5px; cursor:pointer; margin-top:10px; width:fit-content;}
    button:hover{background:#218838;}
    #uploadCSVBtn{background:#007bff; margin-left:10px;}
    #uploadCSVBtn:hover{background:#0056b3;}
    table{width:100%; border-collapse:collapse; margin-top:30px;}
    th,td{padding:12px; border:1px solid #ccc; text-align:left;}
    th{background:#f1f1f1;}
    .Income{color:green;}
    .Expense{color:red;}
    .action-btn{background:#007bff; color:#fff; border:none; padding:6px 10px; margin-right:5px; cursor:pointer; border-radius:4px;}
    .action-btn:hover{background:#0056b3;}
    .delete-btn{background:#dc3545;}
    .delete-btn:hover{background:#a71d2a;}
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left:20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
  <h2>Expense & Income Manager</h2>

  <div style="margin-bottom:20px;">
    <label for="csvFile">Upload CSV:</label>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="uploadCSVBtn">Upload CSV</button>
  </div>

  <form id="entryForm">
    <input type="hidden" id="entryId" />

    <label for="entryType">Type</label>
    <select id="entryType" required>
      <option value="">Select Type</option>
      <option value="Income">Income</option>
      <option value="Expense">Expense</option>
    </select>

    <label for="accountHeader">Account Header</label>
    <select id="accountHeader" required>
      <option value="">Loading...</option>
    </select>

    <label for="entryMode">Mode</label>
    <select id="entryMode" required>
      <option value="">Select Mode</option>
      <option value="Bank">Bank</option>
      <option value="Cash">Cash</option>
    </select>

    <div id="bankNameGroup" style="display:none;">
      <label for="bankName">Bank Name</label>
      <select id="bankName">
        <option value="">Select Bank</option>
      </select>
    </div>

    <label for="entryAmount">Amount</label>
    <input type="number" id="entryAmount" required placeholder="0.00" step="0.01" min="0" />

    <label for="entryDate">Date</label>
    <input type="date" id="entryDate" required />

    <label for="entryDescription">Description</label>
    <input type="text" id="entryDescription" placeholder="Optional" />

    <div></div>
    <button type="submit" id="submitBtn">Add Entry</button>
    <button type="button" id="cancelEditBtn" style="display:none; margin-left:10px;">Cancel Edit</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Header</th>
        <th>Mode</th>
        <th>Bank</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="entriesTable"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = { /* same as in coa.html */ };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const accountHeaderSelect = document.getElementById('accountHeader');
  const entryMode = document.getElementById('entryMode');
  const bankNameGroup = document.getElementById('bankNameGroup');
  const bankNameSelect = document.getElementById('bankName');
  const entryForm = document.getElementById('entryForm');
  const entriesTable = document.getElementById('entriesTable');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const entryIdInput = document.getElementById('entryId');
  const entryTypeSelect = document.getElementById('entryType');
  const entryAmountInput = document.getElementById('entryAmount');
  const entryDateInput = document.getElementById('entryDate');
  const entryDescriptionInput = document.getElementById('entryDescription');
  const csvFileInput = document.getElementById('csvFile');
  const uploadCSVBtn = document.getElementById('uploadCSVBtn');
  const usernameElem = document.getElementById('username');
  const profileCircle = document.getElementById('userInitials');
  const logoutBtn = document.getElementById('logoutBtn');
  const datetimeElem = document.getElementById('datetime');

  let currentUser = null;
  let coaEntries = [];

  function updateTime(){ datetimeElem.textContent = new Date().toLocaleString(); }
  setInterval(updateTime,1000); updateTime();

  onAuthStateChanged(auth, async user => {
    if (!user) { setTimeout(()=>{alert("Login required."); location.href = 'index.html';},500); return; }
    currentUser = user;
    const name = localStorage.getItem('username') || user.displayName || user.email;
    usernameElem.textContent = name;
    profileCircle.textContent = name.charAt(0).toUpperCase();
    await loadCOA();
    await loadEntries();
  });

  logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); localStorage.removeItem('username'); location.href='index.html'; });

  async function loadCOA(){
    accountHeaderSelect.innerHTML = '<option value="">Select Header</option>';
    bankNameSelect.innerHTML = '<option value="">Select Bank</option>';
    const q = query(collection(db,'chartOfAccounts'), where('userId','==',currentUser.uid));
    const snap = await getDocs(q);
    coaEntries = snap.docs.map(d => ({id:d.id, ...d.data()}));
    const headers = new Set();
    const banks = new Set();
    coaEntries.forEach(e => {
      headers.add(e.name);
      if (e.category === 'Bank') banks.add(e.name);
    });
    Array.from(headers).forEach(h => {
      const opt = document.createElement('option'); opt.value = h; opt.textContent = h;
      accountHeaderSelect.appendChild(opt);
    });
    Array.from(banks).forEach(b => {
      const opt = document.createElement('option'); opt.value = b; opt.textContent = b;
      bankNameSelect.appendChild(opt);
    });
  }

  entryMode.addEventListener('change', _=>{
    bankNameGroup.style.display = entryMode.value==='Bank' ? 'block' : 'none';
  });

  function resetForm(){ entryForm.reset(); entryIdInput.value=''; submitBtn.textContent='Add Entry'; cancelEditBtn.style.display='none'; bankNameGroup.style.display='none'; }

  cancelEditBtn.addEventListener('click', resetForm);

  entryForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentUser) return alert('Not authenticated');

    const data = {
      type: entryTypeSelect.value,
      accountHeader: accountHeaderSelect.value,
      mode: entryMode.value,
      bankName: entryMode.value==='Bank' ? bankNameSelect.value : '',
      amount: parseFloat(entryAmountInput.value),
      date: entryDateInput.value,
      description: entryDescriptionInput.value.trim(),
      userId: currentUser.uid,
      timestamp: serverTimestamp()
    };
    if (!data.type||!data.accountHeader||!data.mode||isNaN(data.amount)||!data.date||(data.mode==='Bank'&&!data.bankName)){
      return alert('Please complete all required fields');
    }
    try {
      if (entryIdInput.value) {
        await updateDoc(doc(db,'expensesIncome', entryIdInput.value), data);
        alert('Updated');
      } else {
        await addDoc(collection(db,'expensesIncome'), data);
        alert('Added');
      }
      resetForm(); loadEntries();
    } catch (err){ alert('Error: '+err.message); }
  });

  async function loadEntries(){
    entriesTable.innerHTML = '';
    if (!currentUser) return;
    const q = query(collection(db,'expensesIncome'), where('userId','==',currentUser.uid));
    const snap = await getDocs(q);
    if (snap.empty) {
      entriesTable.innerHTML = '<tr><td colspan="8" style="text-align:center;">No entries.</td></tr>'; return;
    }
    snap.forEach(docSnap => {
      const d=docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="${d.type}">${d.type}</td>
        <td>${d.accountHeader}</td>
        <td>${d.mode}</td>
        <td>${d.bankName||''}</td>
        <td>${d.amount.toFixed(2)}</td>
        <td>${d.date}</td>
        <td>${d.description||''}</td>
        <td>
          <button class="action-btn">Edit</button>
          <button class="action-btn delete-btn">Delete</button>
        </td>`;
      tr.querySelector('.action-btn').addEventListener('click', ()=>editEntry(docSnap.id));
      tr.querySelector('.delete-btn').addEventListener('click', ()=>deleteEntry(docSnap.id));
      entriesTable.appendChild(tr);
    });
  }

  async function editEntry(id){
    try {
      const docSnap = await getDoc(doc(db,'expensesIncome',id));
      if (!docSnap.exists()) return alert('Not found');
      const d = docSnap.data();
      entryIdInput.value = id;
      entryTypeSelect.value = d.type;
      accountHeaderSelect.value = d.accountHeader;
      entryMode.value = d.mode;
      entryMode.dispatchEvent(new Event('change'));
      if (d.mode==='Bank') bankNameSelect.value = d.bankName;
      entryAmountInput.value = d.amount;
      entryDateInput.value = d.date;
      entryDescriptionInput.value = d.description;
      submitBtn.textContent = 'Update Entry';
      cancelEditBtn.style.display = 'inline-block';
    } catch(err){ alert('Error: '+err.message); }
  }

  async function deleteEntry(id){
    if (!confirm('Delete this entry?')) return;
    await deleteDoc(doc(db,'expensesIncome',id));
    loadEntries();
  }

  function parseCsv(text){
    const lines = text.trim().split(/\r?\n/);
    const header = lines[0].split(',');
    const idx = name => header.indexOf(name);
    const iDate=idx('DATE'), iAccount=idx('ACCOUNT HEADER'), iInc=idx('INCOME'),
          iExp=idx('EXPENSES'), iMode=idx('MODE'), iDesc=idx('DESCRIPTION');
    if (iDate<0||iAccount<0||iInc<0||iExp<0||iMode<0) {
      alert('CSV headers missing'); return [];
    }
    return lines.slice(1).map(line => {
      const cols = line.split(',');
      const inc = parseFloat(cols[iInc])||0, exp = parseFloat(cols[iExp])||0;
      let type='', amount=0;
      if (inc>0){type='Income'; amount=inc;}
      else if(exp>0){type='Expense'; amount=exp;}
      else return null;
      const mode=cols[iMode].trim();
      const bank=mode==='Bank'&& cols[ header.indexOf('MODE')+1 ] ? cols[ header.indexOf('MODE')+1 ].trim() : '';
      return {type, accountHeader:cols[iAccount].trim(), mode, bankName:bank, amount, date:cols[iDate].trim(), description: iDesc>=0 ? cols[iDesc].trim():'' };
    }).filter(x=>x);
  }

  uploadCSVBtn.addEventListener('click', async ()=>{
    if (!currentUser) return alert('Login required');
    const file = csvFileInput.files[0];
    if (!file) return alert('Select CSV');
    const text = await file.text();
    const entries = parseCsv(text);
    if (!entries.length) return alert('No valid rows');
    for (const e of entries){
      e.userId = currentUser.uid; e.timestamp = serverTimestamp();
      await addDoc(collection(db,'expensesIncome'),e);
    }
    alert(`Uploaded ${entries.length} entries`);
    csvFileInput.value='';
    loadEntries();
  });

</script>
</body>
</html>
