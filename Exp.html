<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense & Income Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin:0; padding:0; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .header-left{font-weight:bold;}
    .header-right{display:flex; align-items:center; gap:10px;}
    #userInitials {background:#007bff; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold;}
    #username{font-weight:bold;}
    #logoutBtn{background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 12px; cursor:pointer;}
    #logoutBtn:hover{background:#a71d2a;}
    .container{max-width:900px; margin:30px auto; background:#fff; padding:30px; border-radius:8px;}
    h2{text-align:center; margin-bottom:20px;}
    form{display:grid; grid-template-columns:150px 1fr; gap:15px 20px; align-items:center;}
    label{font-weight:bold;}
    select,input[type="text"],input[type="number"],input[type="date"]{padding:8px; font-size:1rem; width:100%; box-sizing:border-box;}
    button{grid-column:2; background:#28a745; color:#fff; padding:10px 20px; border:none; font-size:1rem; border-radius:5px; cursor:pointer; margin-top:10px; width:fit-content;}
    button:hover:not(:disabled){background:#218838;}
    button:disabled {opacity: 0.6; cursor: not-allowed;}
    #uploadCSVBtn{background:#007bff; margin-left:10px;}
    #uploadCSVBtn:hover:not(:disabled){background:#0056b3;}
    table{width:100%; border-collapse:collapse; margin-top:30px;}
    th,td{padding:12px; border:1px solid #ccc; text-align:left;}
    th{background:#f1f1f1;}
    .Income{color:green;}
    .Expense{color:red;}
    .action-btn{background:#007bff; color:#fff; border:none; padding:6px 10px; margin-right:5px; cursor:pointer; border-radius:4px;}
    .action-btn:hover{background:#0056b3;}
    .delete-btn{background:#dc3545;}
    .delete-btn:hover{background:#a71d2a;}
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left:20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">
  <h2>Expense & Income Manager</h2>

  <div style="margin-bottom:20px; display:flex; align-items:center;">
    <label for="csvFile" style="margin-right:10px;">Upload CSV:</label>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="uploadCSVBtn">Upload CSV</button>
  </div>

  <form id="entryForm" novalidate>
    <input type="hidden" id="entryId" />

    <label for="entryType">Type</label>
    <select id="entryType" required>
      <option value="">Select Type</option>
      <option value="Income">Income</option>
      <option value="Expense">Expense</option>
    </select>

    <label for="accountHeader">Account Header</label>
    <select id="accountHeader" required>
      <option value="">Loading...</option>
    </select>

    <label for="entryMode">Mode</label>
    <select id="entryMode" required>
      <option value="">Select Mode</option>
      <option value="Bank">Bank</option>
      <option value="Cash">Cash</option>
    </select>

    <div id="bankNameGroup" style="display:none;">
      <label for="bankName">Bank Name</label>
      <select id="bankName">
        <option value="">Select Bank</option>
      </select>
    </div>

    <label for="entryAmount">Amount</label>
    <input type="number" id="entryAmount" required placeholder="0.00" step="0.01" min="0" />

    <label for="entryDate">Date</label>
    <input type="date" id="entryDate" required />

    <label for="entryDescription">Description</label>
    <input type="text" id="entryDescription" placeholder="Optional" />

    <div></div>
    <button type="submit" id="submitBtn">Add Entry</button>
    <button type="button" id="cancelEditBtn" style="display:none; margin-left:10px;">Cancel Edit</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Header</th>
        <th>Mode</th>
        <th>Bank</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="entriesTable"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.firebasestorage.app",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM Elements
  const accountHeaderSelect = document.getElementById('accountHeader');
  const entryMode = document.getElementById('entryMode');
  const bankNameGroup = document.getElementById('bankNameGroup');
  const bankNameSelect = document.getElementById('bankName');
  const entryForm = document.getElementById('entryForm');
  const entriesTable = document.getElementById('entriesTable');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const entryIdInput = document.getElementById('entryId');
  const entryTypeSelect = document.getElementById('entryType');
  const entryAmountInput = document.getElementById('entryAmount');
  const entryDateInput = document.getElementById('entryDate');
  const entryDescriptionInput = document.getElementById('entryDescription');
  const csvFileInput = document.getElementById('csvFile');
  const uploadCSVBtn = document.getElementById('uploadCSVBtn');
  const usernameElem = document.getElementById('username');
  const profileCircle = document.getElementById('userInitials');
  const logoutBtn = document.getElementById('logoutBtn');
  const datetimeElem = document.getElementById('datetime');

  let currentUser = null;
  let coaEntries = [];

  // Update datetime every second
  function updateTime() {
    datetimeElem.textContent = new Date().toLocaleString();
  }
  setInterval(updateTime, 1000);
  updateTime();

  // Auth state listener
  onAuthStateChanged(auth, async user => {
    if (!user) {
      location.href = 'index.html';
      return;
    }
    currentUser = user;
    const name = localStorage.getItem('username') || user.displayName || user.email || "User";
    usernameElem.textContent = name;
    profileCircle.textContent = name.charAt(0).toUpperCase();
    await loadCOA();
    await loadEntries();
  });

  // Logout handler
  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
    localStorage.removeItem('username');
    location.href = 'index.html';
  });

  // Load Chart of Accounts (COA) for user
  async function loadCOA() {
    accountHeaderSelect.innerHTML = '<option value="">Select Header</option>';
    bankNameSelect.innerHTML = '<option value="">Select Bank</option>';
    const q = query(collection(db, 'chartOfAccounts'), where('userId', '==', currentUser.uid));
    const snap = await getDocs(q);
    coaEntries = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Distinct headers and banks
    const headers = new Set();
    const banks = new Set();
    coaEntries.forEach(e => {
      headers.add(e.name);
      if (e.category === 'Bank') banks.add(e.name);
    });

    headers.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h;
      opt.textContent = h;
      accountHeaderSelect.appendChild(opt);
    });

    banks.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b;
      opt.textContent = b;
      bankNameSelect.appendChild(opt);
    });
  }

  // Show/hide bank name dropdown if mode is Bank
  entryMode.addEventListener('change', () => {
    bankNameGroup.style.display = entryMode.value === 'Bank' ? 'block' : 'none';
    if (entryMode.value !== 'Bank') {
      bankNameSelect.value = '';
    }
  });

  // Reset form to default state
  function resetForm() {
    entryForm.reset();
    entryIdInput.value = '';
    submitBtn.textContent = 'Add Entry';
    cancelEditBtn.style.display = 'none';
    bankNameGroup.style.display = 'none';
  }
  cancelEditBtn.addEventListener('click', resetForm);

  // Validate date string YYYY-MM-DD
  function isValidDate(dateStr) {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return false;
    return dateStr === date.toISOString().slice(0,10);
  }

  // Add or update entry on submit
  entryForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentUser) return alert('Not authenticated');

    const data = {
      type: entryTypeSelect.value,
      accountHeader: accountHeaderSelect.value,
      mode: entryMode.value,
      bankName: entryMode.value === 'Bank' ? bankNameSelect.value : '',
      amount: parseFloat(entryAmountInput.value),
      date: entryDateInput.value,
      description: entryDescriptionInput.value.trim(),
      userId: currentUser.uid,
      timestamp: serverTimestamp()
    };

    if (
      !data.type || !data.accountHeader || !data.mode ||
      isNaN(data.amount) || data.amount <= 0 ||
      !data.date || !isValidDate(data.date) ||
      (data.mode === 'Bank' && !data.bankName)
    ) {
      return alert('Please complete all required fields with valid data');
    }

    try {
      submitBtn.disabled = true;
      if (entryIdInput.value) {
        await updateDoc(doc(db, 'expensesIncome', entryIdInput.value), data);
        alert('Entry updated');
      } else {
        await addDoc(collection(db, 'expensesIncome'), data);
        alert('Entry added');
      }
      resetForm();
      await loadEntries();
    } catch (err) {
      alert('Error: ' + err.message);
    } finally {
      submitBtn.disabled = false;
    }
  });

  // Load entries from Firestore and display
  async function loadEntries() {
    entriesTable.innerHTML = '';
    const q = query(collection(db, 'expensesIncome'), where('userId', '==', currentUser.uid));
    const snap = await getDocs(q);
    if (snap.empty) {
      entriesTable.innerHTML = '<tr><td colspan="8" style="text-align:center;">No entries found.</td></tr>';
      return;
    }
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="${d.type}">${d.type}</td>
        <td>${d.accountHeader}</td>
        <td>${d.mode}</td>
        <td>${d.bankName || ''}</td>
        <td>${d.amount.toFixed(2)}</td>
        <td>${d.date}</td>
        <td>${d.description || ''}</td>
        <td>
          <button class="action-btn" onclick="editEntry('${docSnap.id}')">Edit</button>
          <button class="action-btn delete-btn" onclick="deleteEntry('${docSnap.id}')">Delete</button>
        </td>
      `;
      entriesTable.appendChild(tr);
    });
  }

  // Edit entry
  window.editEntry = async function(id) {
    const docRef = doc(db, 'expensesIncome', id);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return alert('Entry not found');

    const data = docSnap.data();
    entryIdInput.value = id;
    entryTypeSelect.value = data.type;
    accountHeaderSelect.value = data.accountHeader;
    entryMode.value = data.mode;
    if (data.mode === 'Bank') {
      bankNameGroup.style.display = 'block';
      bankNameSelect.value = data.bankName || '';
    } else {
      bankNameGroup.style.display = 'none';
      bankNameSelect.value = '';
    }
    entryAmountInput.value = data.amount;
    entryDateInput.value = data.date;
    entryDescriptionInput.value = data.description || '';
    submitBtn.textContent = 'Update Entry';
    cancelEditBtn.style.display = 'inline-block';
    window.scrollTo({top:0, behavior:'smooth'});
  };

  // Delete entry
  window.deleteEntry = async function(id) {
    if (!confirm('Are you sure you want to delete this entry?')) return;
    try {
      await deleteDoc(doc(db, 'expensesIncome', id));
      alert('Entry deleted');
      await loadEntries();
    } catch (err) {
      alert('Error deleting entry: ' + err.message);
    }
  };

  // CSV parsing & upload
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) throw new Error('CSV must have a header and at least one data line.');

    const header = lines[0].split(',').map(h => h.trim().toLowerCase());
    // Expected CSV headers:
    // type,accountheader,mode,bankname,amount,date,description
    const requiredHeaders = ['type', 'accountheader', 'mode', 'amount', 'date'];
    for (const rh of requiredHeaders) {
      if (!header.includes(rh)) throw new Error(`CSV missing required header: ${rh}`);
    }

    const data = [];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].split(',');
      if (line.length !== header.length) continue; // skip malformed
      const obj = {};
      for (let j = 0; j < header.length; j++) {
        obj[header[j]] = line[j].trim();
      }
      // Validate required fields
      if (!obj.type || !obj.accountheader || !obj.mode || !obj.amount || !obj.date) continue;
      data.push(obj);
    }
    return data;
  }

  uploadCSVBtn.addEventListener('click', async () => {
    if (!csvFileInput.files.length) {
      return alert('Please select a CSV file first.');
    }
    const file = csvFileInput.files[0];
    if (!file.name.toLowerCase().endsWith('.csv')) {
      return alert('Please upload a valid CSV file.');
    }
    try {
      const text = await file.text();
      const entries = parseCSV(text);

      // Add entries to Firestore
      for (const entry of entries) {
        // Normalize and validate fields
        const type = entry.type.charAt(0).toUpperCase() + entry.type.slice(1).toLowerCase();
        const mode = entry.mode.charAt(0).toUpperCase() + entry.mode.slice(1).toLowerCase();
        const bankName = mode === 'Bank' ? (entry.bankname || '') : '';
        const amount = parseFloat(entry.amount);
        const date = entry.date;
        if (!['Income', 'Expense'].includes(type) || !['Bank', 'Cash'].includes(mode) || isNaN(amount) || amount <= 0 || !isValidDate(date)) {
          continue; // skip invalid rows
        }
        await addDoc(collection(db, 'expensesIncome'), {
          type,
          accountHeader: entry.accountheader,
          mode,
          bankName,
          amount,
          date,
          description: entry.description || '',
          userId: currentUser.uid,
          timestamp: serverTimestamp()
        });
      }
      alert('CSV upload completed.');
      csvFileInput.value = '';
      await loadEntries();
    } catch (err) {
      alert('Error uploading CSV: ' + err.message);
    }
  });

</script>
</body>
</html>
