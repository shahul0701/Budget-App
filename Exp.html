<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Expense Ledger</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      getDocs,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let allEntries = [];
    let filteredEntries = [];
    let currentPage = 1;
    const pageSize = 10;
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("user-name").textContent = user.displayName || user.email || "User";
        document.getElementById("user-photo").src = user.photoURL || "https://via.placeholder.com/40";
        await loadEntries(user.uid);
        applyFilters(); // Apply default filters
      } else {
        window.location.href = "login.html";
      }
    });

    async function loadEntries(uid) {
      const entriesRef = collection(db, "users", uid, "entries");
      const q = query(entriesRef, orderBy("date", "desc"));
      const querySnapshot = await getDocs(q);
      allEntries = [];
      querySnapshot.forEach(doc => {
        allEntries.push({ id: doc.id, ...doc.data() });
      });
    }

    function applyFilters() {
      const type = document.getElementById("typeFilter").value;
      const search = document.getElementById("searchFilter").value.toLowerCase();
      const dateRange = document.getElementById("dateFilter").value;

      const now = new Date();
      let startDate = new Date(0);
      let endDate = new Date();

      if (dateRange === "week") {
        startDate = new Date();
        startDate.setDate(now.getDate() - 7);
      } else if (dateRange === "month") {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      } else if (dateRange === "year") {
        startDate = new Date(now.getFullYear(), 0, 1);
      } else if (dateRange === "all") {
        startDate = new Date(0); // from epoch start
      }

      filteredEntries = allEntries.filter(entry => {
        const entryDate = new Date(entry.date);
        const matchesDate = entryDate >= startDate && entryDate <= endDate;
        const matchesType = type === "all" || entry.type === type;
        const matchesSearch = search === "" || (entry.note || "").toLowerCase().includes(search) || (entry.account || "").toLowerCase().includes(search);
        return matchesDate && matchesType && matchesSearch;
      });

      currentPage = 1;
      renderTable();
      renderPagination();
    }

    function renderTable() {
      const tbody = document.getElementById("entry-table-body");
      tbody.innerHTML = "";

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const entriesToShow = filteredEntries.slice(start, end);

      let index = start + 1;
      let runningBalance = 0;

      entriesToShow.forEach(entry => {
        if (entry.type === "income") {
          runningBalance += entry.amount;
        } else {
          runningBalance -= entry.amount;
        }

        const date = new Date(entry.date);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index++}</td>
          <td>${date.toLocaleDateString()}</td>
          <td>${date.toLocaleTimeString()}</td>
          <td>${entry.account || ''}</td>
          <td>${entry.mode || ''}</td>
          <td>${entry.bank || ''}</td>
          <td>${entry.type === "income" ? entry.amount.toFixed(2) : ''}</td>
          <td>${entry.type === "expense" ? entry.amount.toFixed(2) : ''}</td>
          <td>${entry.note || ''}</td>
          <td>${runningBalance.toFixed(2)}</td>
          <td>${entry.attachment ? `<a href="${entry.attachment}" target="_blank">View</a>` : ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredEntries.length / pageSize);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const startPage = Math.max(1, currentPage - 1);
      const endPage = Math.min(totalPages, startPage + 2);

      if (currentPage > 1) {
        const prev = document.createElement("button");
        prev.textContent = "« Prev";
        prev.onclick = () => { currentPage--; renderTable(); renderPagination(); };
        pagination.appendChild(prev);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.style.fontWeight = "bold";
        btn.onclick = () => { currentPage = i; renderTable(); renderPagination(); };
        pagination.appendChild(btn);
      }

      if (currentPage < totalPages) {
        const next = document.createElement("button");
        next.textContent = "Next »";
        next.onclick = () => { currentPage++; renderTable(); renderPagination(); };
        pagination.appendChild(next);
      }
    }

    // Show the add entry modal
    window.uploadEntry = () => {
      document.getElementById("uploadModal").style.display = "block";
    };

    // Show the CSV upload modal
    window.openCsvModal = () => {
      document.getElementById("csvUploadModal").style.display = "block";
    };

    // Close modals
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
      if (id === "uploadModal") {
        document.getElementById("uploadForm").reset();
      } else if (id === "csvUploadModal") {
        document.getElementById("csvUploadForm").reset();
      }
    }
    window.closeModal = closeModal;

    // Upload form submission handler for single entry
    async function handleUpload(event) {
      event.preventDefault();

      if (!currentUser) {
        alert("User not logged in");
        return;
      }

      const form = event.target;
      const type = form.type.value;
      const amount = parseFloat(form.amount.value);
      if (isNaN(amount) || amount <= 0) {
        alert("Please enter a valid positive amount");
        return;
      }
      const note = form.note.value.trim();
      const account = form.account.value.trim();
      const mode = form.mode.value.trim();
      const bank = form.bank.value.trim();
      const dateStr = form.date.value;
      const timeStr = form.time.value;
      if (!dateStr || !timeStr) {
        alert("Please select both date and time");
        return;
      }
      const date = new Date(dateStr + "T" + timeStr);
      const file = form.attachment.files[0];

      // Upload attachment if present
      let attachmentURL = "";
      if (file) {
        try {
          const storageRef = ref(storage, `users/${currentUser.uid}/attachments/${Date.now()}_${file.name}`);
          const snapshot = await uploadBytes(storageRef, file);
          attachmentURL = await getDownloadURL(snapshot.ref);
        } catch (err) {
          alert("Attachment upload failed: " + err.message);
          return;
        }
      }

      // Save entry to Firestore
      try {
        await addDoc(collection(db, "users", currentUser.uid, "entries"), {
          type,
          amount,
          note,
          account,
          mode,
          bank,
          date: date.toISOString(),
          attachment: attachmentURL,
          createdAt: serverTimestamp()
        });
        alert("Entry added successfully!");
        closeModal("uploadModal");
        await loadEntries(currentUser.uid);
        applyFilters();
      } catch (err) {
        alert("Failed to save entry: " + err.message);
      }
    }
    window.handleUpload = handleUpload;

    // Handle CSV upload form submit
    async function handleCSVUpload(event) {
      event.preventDefault();

      if (!currentUser) {
        alert("User not logged in");
        return;
      }

      const form = event.target;
      const file = form.csvfile.files[0];
      if (!file) {
        alert("Please select a CSV file.");
        return;
      }

      const text = await file.text();

      // Parse CSV (simple, assuming header row)
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) {
        alert("CSV file is empty or has no data.");
        return;
      }

      // Expected headers:
      // type,amount,date,time,account,mode,bank,note
      // Example:
      // income,1000,2025-07-28,14:30,My Account,Cash,My Bank,Salary for July

      const header = lines[0].toLowerCase().split(",");
      const expectedHeaders = ["type","amount","date","time","account","mode","bank","note"];

      // Check if headers are correct (order insensitive)
      const missingHeaders = expectedHeaders.filter(h => !header.includes(h));
      if (missingHeaders.length > 0) {
        alert("Missing headers in CSV: " + missingHeaders.join(", "));
        return;
      }

      // Map header indexes for flexibility
      const idxMap = {};
      expectedHeaders.forEach(h => {
        idxMap[h] = header.indexOf(h);
      });

      let addedCount = 0;
      let failedCount = 0;

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(",");

        // Read values using idxMap
        const type = (row[idxMap.type] || "").trim().toLowerCase();
        const amountStr = (row[idxMap.amount] || "").trim();
        const dateStr = (row[idxMap.date] || "").trim();
        const timeStr = (row[idxMap.time] || "").trim();
        const account = (row[idxMap.account] || "").trim();
        const mode = (row[idxMap.mode] || "").trim();
        const bank = (row[idxMap.bank] || "").trim();
        const note = (row[idxMap.note] || "").trim();

        const amount = parseFloat(amountStr);
        if (!["income", "expense"].includes(type) || isNaN(amount) || amount <= 0 || !dateStr || !timeStr) {
          failedCount++;
          continue; // skip invalid rows
        }

        const date = new Date(dateStr + "T" + timeStr);
        if (isNaN(date.getTime())) {
          failedCount++;
          continue;
        }

        try {
          await addDoc(collection(db, "users", currentUser.uid, "entries"), {
            type,
            amount,
            note,
            account,
            mode,
            bank,
            date: date.toISOString(),
            attachment: "",
            createdAt: serverTimestamp()
          });
          addedCount++;
        } catch {
          failedCount++;
        }
      }

      alert(`CSV upload completed.\nAdded: ${addedCount}\nFailed: ${failedCount}`);
      closeModal("csvUploadModal");
      await loadEntries(currentUser.uid);
      applyFilters();
    }
    window.handleCSVUpload = handleCSVUpload;

    // Close modal if clicked outside the modal content
    window.onclick = function(event) {
      const uploadModal = document.getElementById("uploadModal");
      const csvModal = document.getElementById("csvUploadModal");
      if (event.target === uploadModal) {
        closeModal("uploadModal");
      } else if (event.target === csvModal) {
        closeModal("csvUploadModal");
      }
    };
  </script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }

    .header,
    .filters {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-info img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .buttons {
      display: flex;
      gap: 10px;
    }

    button {
      padding: 6px 12px;
      background: #2c7be5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    select,
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    input[type="file"] {
      padding: 5px;
      margin: 0 5px 5px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #007BFF;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #pagination {
      margin-top: 10px;
      text-align: center;
    }

    #pagination button {
      margin: 0 3px;
      padding: 5px 10px;
    }

    /* Modal styles */
    #uploadModal, #csvUploadModal {
      display: none;
      position: fixed;
      z-index: 999;
      padding-top: 80px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    #uploadModal .modal-content, #csvUploadModal .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }

    #uploadModal h2, #csvUploadModal h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #007BFF;
    }

    #uploadModal label, #csvUploadModal label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }

    #uploadModal input, #uploadModal select, #csvUploadModal input {
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
    }

    #uploadModal .modal-actions, #csvUploadModal .modal-actions {
      margin-top: 15px;
      text-align: right;
    }

    #uploadModal .close, #csvUploadModal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }

    #uploadModal .close:hover, #csvUploadModal .close:hover {
      color: #000;
    }

    #csvInstructions {
      font-size: 0.9em;
      color: #333;
      background: #eef5ff;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="user-info">
      <img id="user-photo" src="https://via.placeholder.com/40" alt="User" />
      <div id="user-name">User</div>
    </div>
    <div class="buttons">
      <button onclick="uploadEntry()">Add Entry</button>
      <button onclick="openCsvModal()">Upload CSV</button>
    </div>
  </div>

  <div class="filters">
    <select id="typeFilter" onchange="applyFilters()">
      <option value="all">All Types</option>
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>

    <input type="text" id="searchFilter" placeholder="Search notes or account" oninput="applyFilters()" />

    <select id="dateFilter" onchange="applyFilters()">
      <option value="all">All Time</option>
      <option value="week">Past Week</option>
      <option value="month">This Month</option>
      <option value="year">This Year</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Time</th>
        <th>Account</th>
        <th>Mode</th>
        <th>Bank</th>
        <th>Income</th>
        <th>Expense</th>
        <th>Note</th>
        <th>Balance</th>
        <th>Attachment</th>
      </tr>
    </thead>
    <tbody id="entry-table-body"></tbody>
  </table>

  <div id="pagination"></div>

  <!-- Add Entry Modal -->
  <div id="uploadModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('uploadModal')">&times;</span>
      <h2>Add Entry</h2>
      <form id="uploadForm" onsubmit="handleUpload(event)">
        <label for="type">Type</label>
        <select id="type" name="type" required>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>

        <label for="amount">Amount</label>
        <input type="number" name="amount" id="amount" step="0.01" min="0" required />

        <label for="date">Date</label>
        <input type="date" name="date" id="date" required />

        <label for="time">Time</label>
        <input type="time" name="time" id="time" required />

        <label for="account">Account</label>
        <input type="text" name="account" id="account" />

        <label for="mode">Mode</label>
        <input type="text" name="mode" id="mode" />

        <label for="bank">Bank</label>
        <input type="text" name="bank" id="bank" />

        <label for="note">Note</label>
        <input type="text" name="note" id="note" />

        <label for="attachment">Attachment (optional)</label>
        <input type="file" name="attachment" id="attachment" accept="image/*,application/pdf" />

        <div class="modal-actions">
          <button type="submit">Save</button>
          <button type="button" onclick="closeModal('uploadModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CSV Upload Modal -->
  <div id="csvUploadModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('csvUploadModal')">&times;</span>
      <h2>Upload CSV</h2>
      <div id="csvInstructions">
        CSV Format (Headers): type,amount,date,time,account,mode,bank,note
        Example:
        income,1000,2025-07-28,14:30,My Account,Cash,My Bank,Salary for July
      </div>
      <form id="csvUploadForm" onsubmit="handleCSVUpload(event)">
        <input type="file" name="csvfile" accept=".csv" required />
        <div class="modal-actions">
          <button type="submit">Upload</button>
          <button type="button" onclick="closeModal('csvUploadModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

</body>
</html>
