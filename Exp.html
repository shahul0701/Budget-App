<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Transaction CSV</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 14px; }
    th { background: #eee; }
  </style>
</head>
<body>

<h2>Upload Transactions CSV</h2>
<input type="file" id="csvFileInput" accept=".csv" />
<button id="uploadBtn">Upload & Save</button>

<table id="transactionsTable">
  <thead>
    <tr>
      <th>SINO</th>
      <th>DATE</th>
      <th>TIME</th>
      <th>ACCOUNT HEADER</th>
      <th>MODE</th>
      <th>BANK NAME</th>
      <th>INCOME</th>
      <th>EXPENSES</th>
      <th>DESCRIPTION</th>
      <th>BALANCE</th>
      <th>ATTACHMENT</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;

  // Parse CSV with your exact columns
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(/\t|,/).map(h => h.trim().toUpperCase());
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(/\t|,/);
      let obj = {};
      headers.forEach((header, idx) => {
        obj[header] = row[idx]?.trim() || '';
      });
      data.push(obj);
    }
    return data;
  }

  async function loadTransactions() {
    const tbody = document.querySelector("#transactionsTable tbody");
    tbody.innerHTML = '';
    if (!currentUser) return;

    const q = query(collection(db, "transactions"), where("userId", "==", currentUser.uid));
    const snapshot = await getDocs(q);

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.SINO || ''}</td>
        <td>${d.DATE || ''}</td>
        <td>${d.TIME || ''}</td>
        <td>${d["ACCOUNT HEADER"] || ''}</td>
        <td>${d.MODE || ''}</td>
        <td>${d["BANK NAME"] || ''}</td>
        <td>${d.INCOME || ''}</td>
        <td>${d.EXPENSES || ''}</td>
        <td>${d.DESCRIPTION || ''}</td>
        <td>${d.BALANCE || ''}</td>
        <td>${d.ATTACHMENT || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function uploadCSVData(rows) {
    if (!currentUser) {
      alert("User not logged in.");
      return;
    }

    for (const row of rows) {
      await addDoc(collection(db, "transactions"), {
        userId: currentUser.uid,
        ...row,
        createdAt: serverTimestamp(),
      });
    }
  }

  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('csvFileInput');
    if (!fileInput.files.length) {
      alert("Please select a CSV file.");
      return;
    }

    const file = fileInput.files[0];
    const text = await file.text();
    const data = parseCSV(text);

    if (!data.length) {
      alert("No data found in CSV.");
      return;
    }

    try {
      await uploadCSVData(data);
      alert("Transactions uploaded successfully!");
      fileInput.value = "";
      loadTransactions();
    } catch (e) {
      alert("Error uploading: " + e.message);
    }
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      loadTransactions();
    } else {
      signInAnonymously(auth).catch(console.error);
    }
  });
</script>

</body>
</html>
