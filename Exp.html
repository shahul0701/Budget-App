<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense & Income Manager</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .header-left {
      font-weight: bold;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #userInitials {
      background: #007bff;
      color: #fff;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      text-transform: uppercase;
    }
    #username {
      font-weight: bold;
    }
    #logoutBtn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #logoutBtn:hover {
      background: #a71d2a;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    form {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 15px 20px;
      align-items: center;
    }
    label {
      font-weight: bold;
    }
    select,
    input[type='text'],
    input[type='number'],
    input[type='date'] {
      padding: 8px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      grid-column: 2;
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      width: fit-content;
    }
    button:hover:not(:disabled) {
      background: #218838;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #uploadCSVBtn {
      background: #007bff;
      margin-left: 10px;
    }
    #uploadCSVBtn:hover:not(:disabled) {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th,
    td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
      word-break: break-word;
    }
    th {
      background: #f1f1f1;
    }
    .Income {
      color: green;
      font-weight: bold;
    }
    .Expense {
      color: red;
      font-weight: bold;
    }
    .action-btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 6px 10px;
      margin-right: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    .action-btn:hover {
      background: #0056b3;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <a
        href="home.html"
        style="text-decoration: none; color: #007bff; font-weight: bold"
        ><i class="fa fa-home"></i> Home</a
      >
      <span style="margin-left: 20px;" id="datetime">Loading time...</span>
    </div>
    <div class="header-right">
      <div id="userInitials">U</div>
      <span id="username">User</span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
    <h2>Expense & Income Manager</h2>

    <div style="margin-bottom: 20px; display: flex; align-items: center">
      <label for="csvFile" style="margin-right: 10px">Upload CSV:</label>
      <input type="file" id="csvFile" accept=".csv" />
      <button id="uploadCSVBtn">Upload CSV</button>
    </div>

    <form id="entryForm" novalidate>
      <input type="hidden" id="entryId" />

      <label for="entryType">Type</label>
      <select id="entryType" required>
        <option value="">Select Type</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
      </select>

      <label for="accountHeader">Account Header</label>
      <select id="accountHeader" required>
        <option value="">Loading...</option>
      </select>

      <label for="entryMode">Mode</label>
      <select id="entryMode" required>
        <option value="">Select Mode</option>
        <option value="Bank">Bank</option>
        <option value="Cash">Cash</option>
      </select>

      <div id="bankNameGroup" style="display: none">
        <label for="bankName">Bank Name</label>
        <select id="bankName">
          <option value="">Select Bank</option>
        </select>
      </div>

      <label for="entryAmount">Amount</label>
      <input
        type="number"
        id="entryAmount"
        required
        placeholder="0.00"
        step="0.01"
        min="0"
      />

      <label for="entryDate">Date</label>
      <input type="date" id="entryDate" required />

      <label for="entryDescription">Description</label>
      <input type="text" id="entryDescription" placeholder="Optional" />

      <div></div>
      <button type="submit" id="submitBtn">Add Entry</button>
      <button
        type="button"
        id="cancelEditBtn"
        style="display: none; margin-left: 10px"
      >
        Cancel Edit
      </button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Header</th>
          <th>Mode</th>
          <th>Bank</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="entriesTable"></tbody>
    </table>
  </div>

  <script type="module">
    import {
      initializeApp,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      doc,
      updateDoc,
      deleteDoc,
      getDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.firebasestorage.app",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const accountHeaderSelect = document.getElementById("accountHeader");
    const entryMode = document.getElementById("entryMode");
    const bankNameGroup = document.getElementById("bankNameGroup");
    const bankNameSelect = document.getElementById("bankName");
    const entryForm = document.getElementById("entryForm");
    const entriesTable = document.getElementById("entriesTable");
    const submitBtn = document.getElementById("submitBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const entryIdInput = document.getElementById("entryId");
    const entryTypeSelect = document.getElementById("entryType");
    const entryAmountInput = document.getElementById("entryAmount");
    const entryDateInput = document.getElementById("entryDate");
    const entryDescriptionInput = document.getElementById("entryDescription");
    const csvFileInput = document.getElementById("csvFile");
    const uploadCSVBtn = document.getElementById("uploadCSVBtn");
    const usernameElem = document.getElementById("username");
    const profileCircle = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const datetimeElem = document.getElementById("datetime");

    let currentUser = null;
    let coaEntries = [];

    // Update datetime every second
    function updateTime() {
      datetimeElem.textContent = new Date().toLocaleString();
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "index.html";
        return;
      }
      currentUser = user;
      const name =
        localStorage.getItem("username") || user.displayName || user.email || "User";
      usernameElem.textContent = name;
      profileCircle.textContent = name.charAt(0).toUpperCase();
      await loadCOA();
      await loadEntries();
    });

    // Logout handler
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      localStorage.removeItem("username");
      location.href = "index.html";
    });

    // Load Chart of Accounts (COA) for user
    async function loadCOA() {
      accountHeaderSelect.innerHTML = '<option value="">Select Header</option>';
      bankNameSelect.innerHTML = '<option value="">Select Bank</option>';
      const q = query(collection(db, "chartOfAccounts"), where("userId", "==", currentUser.uid));
      const snap = await getDocs(q);
      coaEntries = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

      // Distinct headers and banks
      const headers = new Set();
      const banks = new Set();
      coaEntries.forEach((e) => {
        headers.add(e.name);
        if (e.category && e.category.toLowerCase() === "bank") banks.add(e.name);
      });

      headers.forEach((h) => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        accountHeaderSelect.appendChild(opt);
      });

      banks.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        bankNameSelect.appendChild(opt);
      });
    }

    // Show/hide bank name dropdown if mode is Bank
    entryMode.addEventListener("change", () => {
      bankNameGroup.style.display = entryMode.value === "Bank" ? "block" : "none";
      if (entryMode.value !== "Bank") {
        bankNameSelect.value = "";
      }
    });

    // Reset form to default state
    function resetForm() {
      entryForm.reset();
      entryIdInput.value = "";
      submitBtn.textContent = "Add Entry";
      cancelEditBtn.style.display = "none";
      bankNameGroup.style.display = "none";
    }
    cancelEditBtn.addEventListener("click", resetForm);

    // Validate date string YYYY-MM-DD
    function isValidDate(dateStr) {
      if (!dateStr) return false;
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return false;
      return dateStr === date.toISOString().slice(0, 10);
    }

    // Add or update entry on submit
    entryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Not authenticated");

      const data = {
        type:
          entryTypeSelect.value.charAt(0).toUpperCase() +
          entryTypeSelect.value.slice(1).toLowerCase(),
        accountHeader: accountHeaderSelect.value.trim(),
        mode: entryMode.value,
        bankName: bankNameSelect.value,
        amount: Number(entryAmountInput.value),
        date: entryDateInput.value,
        description: entryDescriptionInput.value.trim(),
        userId: currentUser.uid,
        timestamp: serverTimestamp(),
      };

      // Validation
      if (!data.type || !["Income", "Expense"].includes(data.type)) {
        return alert("Please select a valid Type.");
      }
      if (!data.accountHeader) {
        return alert("Please select an Account Header.");
      }
      if (!data.mode || !["Bank", "Cash"].includes(data.mode)) {
        return alert("Please select a valid Mode.");
      }
      if (data.mode === "Bank" && !data.bankName) {
        return alert("Please select a Bank Name.");
      }
      if (isNaN(data.amount) || data.amount <= 0) {
        return alert("Please enter a valid positive amount.");
      }
      if (!isValidDate(data.date)) {
        return alert("Please enter a valid date.");
      }

      const docId = entryIdInput.value;
      try {
        if (docId) {
          // Update
          const entryRef = doc(db, "entries", docId);
          await updateDoc(entryRef, data);
          alert("Entry updated successfully.");
        } else {
          // Add new
          await addDoc(collection(db, "entries"), data);
          alert("Entry added successfully.");
        }
        resetForm();
        loadEntries();
      } catch (error) {
        alert("Error saving entry: " + error.message);
      }
    });

    // Load entries from Firestore
    async function loadEntries() {
      entriesTable.innerHTML = "";
      if (!currentUser) return;
      const q = query(collection(db, "entries"), where("userId", "==", currentUser.uid));
      const snap = await getDocs(q);
      if (snap.empty) {
        entriesTable.innerHTML = `<tr><td colspan="8" style="text-align:center">No entries found.</td></tr>`;
        return;
      }
      snap.docs.forEach((docSnap) => {
        const entry = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="${entry.type === "Income" ? "Income" : "Expense"}">${entry.type}</td>
          <td>${entry.accountHeader || ""}</td>
          <td>${entry.mode || ""}</td>
          <td>${entry.mode === "Bank" ? entry.bankName || "" : "-"}</td>
          <td>${Number(entry.amount).toFixed(2)}</td>
          <td>${entry.date || ""}</td>
          <td>${entry.description || ""}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${docSnap.id}">Edit</button>
            <button class="action-btn delete-btn" data-id="${docSnap.id}">Delete</button>
          </td>
        `;
        entriesTable.appendChild(tr);
      });

      // Add event listeners for edit and delete buttons
      entriesTable.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          const docRef = doc(db, "entries", id);
          const docSnap = await getDoc(docRef);
          if (!docSnap.exists()) return alert("Entry not found");
          const data = docSnap.data();

          entryIdInput.value = id;
          entryTypeSelect.value = data.type;
          accountHeaderSelect.value = data.accountHeader;
          entryMode.value = data.mode;
          bankNameGroup.style.display = data.mode === "Bank" ? "block" : "none";
          bankNameSelect.value = data.bankName || "";
          entryAmountInput.value = data.amount;
          entryDateInput.value = data.date;
          entryDescriptionInput.value = data.description || "";
          submitBtn.textContent = "Update Entry";
          cancelEditBtn.style.display = "inline-block";
        });
      });

      entriesTable.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          if (confirm("Are you sure you want to delete this entry?")) {
            await deleteDoc(doc(db, "entries", id));
            alert("Entry deleted.");
            loadEntries();
            if (entryIdInput.value === id) resetForm();
          }
        });
      });
    }

    // CSV upload parsing & processing
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];
      // Extract headers from first line
      const headers = lines[0]
        .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
        .map((h) => h.trim().replace(/^"|"$/g, ""));

      const entries = [];
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = lines[i]
          .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
          .map((v) => v.trim().replace(/^"|"$/g, ""));
        if (values.length !== headers.length) continue;

        const obj = {};
        headers.forEach((h, idx) => (obj[h] = values[idx]));
        entries.push(obj);
      }
      return entries;
    }

    uploadCSVBtn.addEventListener("click", async () => {
      const file = csvFileInput.files[0];
      if (!file) return alert("Please select a CSV file.");

      uploadCSVBtn.disabled = true;
      uploadCSVBtn.textContent = "Uploading...";

      try {
        const text = await file.text();
        const data = parseCSV(text);
        if (!data.length) throw new Error("No valid data found in CSV.");

for (const item of data) {
  // Determine type and amount
  let type = "";
  let amount = 0;

  if (item.INCOME && Number(item.INCOME) > 0) {
    type = "Income";
    amount = parseFloat(item.INCOME);
  } else if (item.EXPENSES && Number(item.EXPENSES) > 0) {
    type = "Expense";
    amount = parseFloat(item.EXPENSES);
  } else {
    // Skip entries without valid amount
    continue;
  }

  const accountHeader = (item["ACCOUNT HEADER"] || item["Account Header"] || "").trim();
  const mode = (item.MODE || item.Mode || "").trim();
  const bankName = (item["BANK NAME"] || item["Bank Name"] || "").trim();
  const date = (item.DATE || item.Date || "").trim();
  const description = (item.DESCRIPTION || item.Description || "").trim();

  if (!accountHeader || !mode || !date) continue; // basic validation

  // Validate date format (reuse your existing isValidDate function)
  if (!isValidDate(date)) continue;

  await addDoc(collection(db, "entries"), {
    type,
    accountHeader,
    mode,
    bankName,
    amount,
    date,
    description,
    userId: currentUser.uid,
    timestamp: serverTimestamp(),
  });
}


        alert("CSV uploaded successfully!");
        csvFileInput.value = "";
        await loadEntries();
      } catch (error) {
        alert("Error uploading CSV: " + error.message);
      } finally {
        uploadCSVBtn.disabled = false;
        uploadCSVBtn.textContent = "Upload CSV";
      }
    });
  </script>
</body>
</html>
