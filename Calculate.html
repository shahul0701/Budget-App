<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All-in-One Calculator & Live Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{--accent:#0ea5a4;--good:#10b981;--danger:#ef4444;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:linear-gradient(180deg,#0f1724,#0b1220);min-height:100vh;padding:18px;display:flex;justify-content:center;align-items:flex-start}
    .app{width:100%;max-width:1200px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
    header{background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    header h1{font-size:1.05rem;display:flex;gap:10px;align-items:center}
    .country-selector{display:flex;align-items:center;gap:8px;margin-left:auto}
    .country-selector select{padding:6px 10px;border-radius:6px;border:none;background:rgba(255,255,255,0.2);color:#fff}
    .layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:680px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
    .main{padding:18px;background:#fff}
    .sidebar{background:#f8fafc;padding:18px;border-left:1px solid #e6eef6}
    .modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:1px solid #e6eef6;cursor:pointer;font-weight:700;color:#0f1724}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .panel{display:none}
    .panel.active{display:block;animation:fadeIn .25s ease}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .input, input, select, textarea, button{font-family:inherit}
    .input{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
    button.btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.btn.ghost{background:#eef2ff;color:#0f1724;border:1px solid #e6eef6}
    .display{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef6;background:#f8fafc;text-align:right;font-size:1.25rem}
    .result-box{margin-top:12px;padding:12px;border-left:4px solid var(--accent);background:#f0f9ff;border-radius:8px}
    .section{margin-bottom:14px}
    .small{font-size:0.92rem;color:var(--muted)}
    .history{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef5fb}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef5fb;text-align:left;font-size:0.92rem}
    .live-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef5fb;margin-bottom:10px}
    .live-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .tiny{font-size:0.85rem}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .delete{color:var(--danger);cursor:pointer}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    footer{padding:10px 18px;background:#f8fafc;border-top:1px solid #eef5fb;font-size:0.9rem;color:var(--muted)}
    .note {font-size:0.85rem;color:#374151;margin-top:8px}
    .country-flag {width: 20px; height: 15px; display: inline-block; margin-right: 5px; vertical-align: middle; background-size: cover;}
  </style>
</head>
<body>

<div class="app" role="application" aria-label="All-in-One Calculator">
  <header>
    <h1><i class="fas fa-calculator"></i> All-in-One Calculator â€” Live</h1>
    <div class="country-selector">
      <i class="fas fa-globe"></i>
      <select id="country-select">
        <option value="US" data-flag="ðŸ‡ºðŸ‡¸">United States</option>
        <option value="IN" data-flag="ðŸ‡®ðŸ‡³" selected>India</option>
        <option value="GB" data-flag="ðŸ‡¬ðŸ‡§">United Kingdom</option>
        <option value="DE" data-flag="ðŸ‡©ðŸ‡ª">Germany</option>
        <option value="JP" data-flag="ðŸ‡¯ðŸ‡µ">Japan</option>
        <option value="AU" data-flag="ðŸ‡¦ðŸ‡º">Australia</option>
        <option value="CA" data-flag="ðŸ‡¨ðŸ‡¦">Canada</option>
        <option value="FR" data-flag="ðŸ‡«ðŸ‡·">France</option>
        <option value="BR" data-flag="ðŸ‡§ðŸ‡·">Brazil</option>
        <option value="CN" data-flag="ðŸ‡¨ðŸ‡³">China</option>
      </select>
    </div>
    <div class="small">Currency (live) Â· Gold Â· Crypto Â· Mileage Â· Loan Â· Tax Â· Date Â· Measure</div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main" aria-live="polite">
      <div class="modes" role="tablist">
        <div class="tab active" data-tab="standard">Standard</div>
        <div class="tab" data-tab="scientific">Scientific</div>
        <div class="tab" data-tab="currency">Currency</div>
        <div class="tab" data-tab="mileage">Mileage</div>
        <div class="tab" data-tab="loan">Loan</div>
        <div class="tab" data-tab="tax">Tax</div>
        <div class="tab" data-tab="date">Date</div>
        <div class="tab" data-tab="measure">Measure</div>
        <div class="tab" data-tab="bmi">BMI</div>
        <div class="tab" data-tab="discount">Discount</div>
        <div class="tab" data-tab="tip">Tip</div>
      </div>

      <!-- Standard -->
      <section id="standard" class="panel active section">
        <div class="small">Basic arithmetic</div>
        <input id="std-display" class="display" readonly value="0" aria-label="Standard display">
        <div style="margin-top:10px" class="grid-4">
          <button class="btn ghost" onclick="stdClear()">C</button>
          <button class="btn ghost" onclick="stdBack()">âŒ«</button>
          <button class="btn ghost" onclick="stdAppend('%')">%</button>
          <button class="btn ghost" onclick="stdAppend('/')">/</button>

          <button class="btn" onclick="stdAppend('7')">7</button>
          <button class="btn" onclick="stdAppend('8')">8</button>
          <button class="btn" onclick="stdAppend('9')">9</button>
          <button class="btn ghost" onclick="stdAppend('*')">Ã—</button>

          <button class="btn" onclick="stdAppend('4')">4</button>
          <button class="btn" onclick="stdAppend('5')">5</button>
          <button class="btn" onclick="stdAppend('6')">6</button>
          <button class="btn ghost" onclick="stdAppend('-')">-</button>

          <button class="btn" onclick="stdAppend('1')">1</button>
          <button class="btn" onclick="stdAppend('2')">2</button>
          <button class="btn" onclick="stdAppend('3')">3</button>
          <button class="btn ghost" onclick="stdAppend('+')">+</button>

          <button class="btn" onclick="stdAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="stdAppend('.')">.</button>
          <button class="btn" onclick="stdCalculate()">=</button>
        </div>
      </section>

      <!-- Scientific -->
      <section id="scientific" class="panel section" aria-hidden="true">
        <div class="small">Scientific (trig in degrees)</div>
        <input id="sci-display" class="display" readonly value="0">
        <div style="margin-top:10px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
          <button class="btn ghost" onclick="sciClear()">C</button>
          <button class="btn ghost" onclick="sciBack()">âŒ«</button>
          <button class="btn ghost" onclick="sciAppend('(')">(</button>
          <button class="btn ghost" onclick="sciAppend('')">)</button>
          <button class="btn ghost" onclick="sciAppend('**')">^</button>

          <button class="btn" onclick="sciFunc('sin')">sin</button>
          <button class="btn" onclick="sciFunc('cos')">cos</button>
          <button class="btn" onclick="sciFunc('tan')">tan</button>
          <button class="btn" onclick="sciFunc('sqrt')">âˆš</button>
          <button class="btn" onclick="sciAppend('Math.PI')">Ï€</button>

          <button class="btn" onclick="sciFunc('log')">log</button>
          <button class="btn" onclick="sciFunc('ln')">ln</button>
          <button class="btn" onclick="sciAppend('Math.E')">e</button>
          <button class="btn" onclick="sciFact()">x!</button>
          <button class="btn" onclick="sciAppend('%')">%</button>

          <button class="btn" onclick="sciAppend('7')">7</button>
          <button class="btn" onclick="sciAppend('8')">8</button>
          <button class="btn" onclick="sciAppend('9')">9</button>
          <button class="btn ghost" onclick="sciAppend('/')">/</button>
          <button class="btn ghost" onclick="sciAppend('*')">Ã—</button>

          <button class="btn" onclick="sciAppend('4')">4</button>
          <button class="btn" onclick="sciAppend('5')">5</button>
          <button class="btn" onclick="sciAppend('6')">6</button>
          <button class="btn ghost" onclick="sciAppend('-')">-</button>
          <button class="btn ghost" onclick="sciAppend('+')">+</button>

          <button class="btn" onclick="sciAppend('1')">1</button>
          <button class="btn" onclick="sciAppend('2')">2</button>
          <button class="btn" onclick="sciAppend('3')">3</button>
          <button class="btn" onclick="sciCalculate()" style="grid-column:span 2">=</button>

          <button class="btn" onclick="sciAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="sciAppend('.')">.</button>
        </div>
      </section>

      <!-- Currency -->
      <section id="currency" class="panel section" aria-hidden="true">
        <div class="small">Live currency conversion (exchangerate.host)</div>
        <div style="display:grid;grid-template-columns:1fr 180px;gap:8px;margin-top:8px">
          <input id="cur-amount" class="input" type="number" value="1" min="0" step="any">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="convertCurrency()">Convert</button>
            <button class="btn ghost" onclick="swapCurrency()">Swap</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="from-currency" class="input"></select>
          <select id="to-currency" class="input"></select>
        </div>

        <div class="result-box" id="cur-result">Result will appear here</div>
        <div class="small" style="margin-top:6px">If conversion fails, there will be a helpful error message (CORS or network)</div>
      </section>

      <!-- Mileage -->
      <section id="mileage" class="panel section" aria-hidden="true">
        <div class="small">Mileage tracker (saved to Firebase & localStorage)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="vehicle" class="input" placeholder="Vehicle name">
          <input id="odo" class="input" placeholder="Odometer (km)" type="number" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="fuel" class="input" placeholder="Fuel (L)" type="number" step="any">
          <input id="cost" class="input" placeholder="Fuel cost" type="number" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="mdate" class="input" type="date" style="flex:1">
          <button class="btn" onclick="addMileage()">Add</button>
          <button class="btn ghost" onclick="clearMileageForm()">Clear</button>
        </div>

        <div class="result-box" id="mileage-summary">No records yet</div>

        <h3 style="margin-top:12px">History</h3>
        <div style="overflow:auto;max-height:220px">
          <table id="mileage-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Loan -->
      <section id="loan" class="panel section" aria-hidden="true">
        <div class="small">Loan / EMI</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loan-p" class="input" placeholder="Principal" type="number" value="100000">
          <input id="loan-r" class="input" placeholder="Annual rate (%)" type="number" value="7.5">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="loan-n" class="input" placeholder="Years" type="number" value="5">
          <button class="btn" onclick="calcLoan()">Calculate</button>
          <button class="btn ghost" onclick="clearLoan()">Clear</button>
        </div>
        <div class="result-box" id="loan-result">EMI result</div>
      </section>

      <!-- Tax -->
      <section id="tax" class="panel section" aria-hidden="true">
        <div class="small">Tax helper (country-specific tax calculation)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tax-income" class="input" placeholder="Taxable income" type="number" value="500000">
          <select id="tax-country" class="input">
            <option value="US">United States</option>
            <option value="IN" selected>India</option>
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="AU">Australia</option>
            <option value="CA">Canada</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcTax()">Calculate Tax</button>
          <button class="btn ghost" onclick="clearTax()">Clear</button>
        </div>
        <div class="result-box" id="tax-result">Tax result</div>
      </section>

      <!-- Date -->
      <section id="date" class="panel section" aria-hidden="true">
        <div class="small">Age, days between and add/subtract days</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="dob" type="date" class="input"><div style="display:flex;gap:8px"><button class="btn" onclick="calcAge()">Age</button><button class="btn ghost" onclick="clearAge()">Clear</button></div>
        </div>
        <div class="result-box" id="age-result">Age result</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="start-date" type="date" class="input"><input id="end-date" type="date" class="input">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="daysBetween()">Days between</button>
          <button class="btn ghost" onclick="clearDates()">Clear</button>
        </div>
        <div class="result-box" id="date-diff-result">Days difference</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="base-date" type="date" class="input"><input id="days-add" type="number" class="input" value="0">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addDays()">Add/Subtract</button><button class="btn ghost" onclick="clearAddDays()">Clear</button>
        </div>
        <div class="result-box" id="add-days-result">Add/Sub result</div>
      </section>

      <!-- Measure -->
      <section id="measure" class="panel section" aria-hidden="true">
        <div class="small">Length, Weight, Temperature conversions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="measure-type" class="input" onchange="populateUnits()"><option value="length">Length</option><option value="weight">Weight</option><option value="temperature">Temperature</option></select>
          <input id="measure-value" class="input" type="number" value="1" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="measure-from" class="input"></select>
          <select id="measure-to" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="convertMeasure()">Convert</button>
          <button class="btn ghost" onclick="resetMeasure()">Clear</button>
        </div>
        <div class="result-box" id="measure-result">Conversion</div>
      </section>

      <!-- BMI -->
      <section id="bmi" class="panel section" aria-hidden="true">
        <div class="small">Body Mass Index calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="bmi-height" class="input" placeholder="Height (cm)" type="number" value="170">
          <input id="bmi-weight" class="input" placeholder="Weight (kg)" type="number" value="70">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcBMI()">Calculate BMI</button>
          <button class="btn ghost" onclick="clearBMI()">Clear</button>
        </div>
        <div class="result-box" id="bmi-result">BMI result</div>
        <div class="small" style="margin-top:6px">Underweight: <18.5, Normal: 18.5-24.9, Overweight: 25-29.9, Obesity: â‰¥30</div>
      </section>

      <!-- Discount -->
      <section id="discount" class="panel section" aria-hidden="true">
        <div class="small">Discount and sale price calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="discount-price" class="input" placeholder="Original price" type="number" value="100">
          <input id="discount-percent" class="input" placeholder="Discount (%)" type="number" value="20">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcDiscount()">Calculate</button>
          <button class="btn ghost" onclick="clearDiscount()">Clear</button>
        </div>
        <div class="result-box" id="discount-result">Discount result</div>
      </section>

      <!-- Tip -->
      <section id="tip" class="panel section" aria-hidden="true">
        <div class="small">Tip calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tip-amount" class="input" placeholder="Bill amount" type="number" value="100">
          <input id="tip-percent" class="input" placeholder="Tip percentage" type="number" value="15">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="tip-people" class="input" placeholder="Number of people" type="number" value="2">
          <button class="btn" onclick="calcTip()">Calculate</button>
        </div>
        <div class="result-box" id="tip-result">Tip result</div>
      </section>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Recent calculations</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="copyHistory()">Copy</button>
          <button class="btn ghost" onclick="downloadHistory()">Export CSV</button>
          <button class="btn" onclick="resetAll()">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="history" id="history"></div>
    </main>

    <!-- SIDEBAR / LIVE PANEL -->
    <aside class="sidebar" aria-label="Live market data">
      <div class="live-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Snapshot</strong>
          <div class="tiny muted" id="live-updated">--</div>
        </div>

        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">USD â†’ <span id="local-currency">INR</span></div><div id="usd-local" style="font-weight:800">--</div></div>
          <div><div class="small muted">EUR â†’ USD</div><div id="eur-usd" style="font-weight:800">--</div></div>

          <div><div class="small muted">Gold (<span id="gold-unit">oz</span>)</div><div id="gold" style="font-weight:800">--</div></div>
          <div><div class="small muted">Silver (<span id="silver-unit">oz</span>)</div><div id="silver" style="font-weight:800">--</div></div>

          <div><div class="small muted">Bitcoin (USD)</div><div id="btc" style="font-weight:800">--</div></div>
          <div><div class="small muted">Ethereum (USD)</div><div id="eth" style="font-weight:800">--</div></div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="refreshLive()">Refresh</button>
          <button class="btn ghost" onclick="toggleAuto()">Auto: <span id="auto-status">ON</span></button>
        </div>

        <div class="tiny muted" style="margin-top:8px">Data sources: exchangerate.host, CoinGecko, GoldPrice (public endpoints).</div>
      </div>

      <div class="live-card">
        <strong>Quick Converter</strong>
        <div style="margin-top:8px">
          <input id="quick-amt" class="input" value="1" type="number" step="any">
          <select id="quick-from" class="input" style="margin-top:6px"></select>
          <select id="quick-to" class="input" style="margin-top:6px"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="quickConvert()">Convert</button>
            <button class="btn ghost" onclick="fillQuick()">Use main</button>
          </div>
          <div class="result-box" id="quick-result">Quick result</div>
        </div>
      </div>

      <div class="live-card">
        <strong>Country Data</strong>
        <div class="small muted" style="margin-top:8px">Local time & info for <span id="current-country">India</span></div>
        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">Local Time</div><div id="local-time" style="font-weight:800">--:--:--</div></div>
          <div><div class="small muted">Date</div><div id="local-date" style="font-weight:800">--</div></div>
        </div>
        <div class="small muted" style="margin-top:8px">Currency: <span id="country-currency">INR</span></div>
      </div>

      <div class="live-card">
        <strong>Mileage Export</strong>
        <div class="small muted" style="margin-top:8px">Export or clear mileage (local fallback)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="exportMileageCSV()">Export CSV</button>
          <button class="btn ghost" onclick="clearMileageStorage()">Clear</button>
        </div>
        <div class="note">If Firestore is accessible you'll see saved records from your Firebase project; otherwise localStorage backup is used.</div>
      </div>
    </aside>
  </div>

  <footer>Open dev console to see detailed errors if any API fails. If CORS errors appear, run a local web server (e.g. <code>python -m http.server 8000</code>) and open the page at <code>http://localhost:8000/</code>.</footer>
</div>

<script type="module">
/* ======================= MODULE SCRIPT - ALL FEATURES ======================= */

/* ------------------ Firebase (optional) ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---- Replace with your Firebase config if you want a different project ---- */
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

let db = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  console.info('Firestore initialized');
} catch (e) {
  console.warn('Firestore init failed (or blocked):', e);
}

/* ------------------ API endpoints ------------------ */
const API = {
  SYMBOLS: "https://api.exchangerate.host/symbols",
  CONVERT: "https://api.exchangerate.host/convert",
  LATEST: "https://api.exchangerate.host/latest",
  GOLDPRICE: "https://data-asg.goldprice.org/dbXRates/",
  COINGECKO_SIMPLE: "https://api.coingecko.com/api/v3/simple/price",
  COUNTRIES: "https://restcountries.com/v3.1/alpha/"
};

/* ------------------ Country data ------------------ */
let currentCountry = "IN";
let countryCurrency = "INR";
let countryTimeZone = "Asia/Kolkata";
let countryCurrencySymbol = "â‚¹";

// Country to currency mapping (fallback)
const countryCurrencyMap = {
  "US": "USD", "IN": "INR", "GB": "GBP", "DE": "EUR", "JP": "JPY",
  "AU": "AUD", "CA": "CAD", "FR": "EUR", "BR": "BRL", "CN": "CNY"
};

// Country to currency symbol mapping
const countryCurrencySymbolMap = {
  "US": "$", "IN": "â‚¹", "GB": "Â£", "DE": "â‚¬", "JP": "Â¥",
  "AU": "$", "CA": "$", "FR": "â‚¬", "BR": "R$", "CN": "Â¥"
};

// Country to timezone mapping (fallback)
const countryTimeZoneMap = {
  "US": "America/New_York", "IN": "Asia/Kolkata", "GB": "Europe/London", 
  "DE": "Europe/Berlin", "JP": "Asia/Tokyo", "AU": "Australia/Sydney",
  "CA": "America/Toronto", "FR": "Europe/Paris", "BR": "America/Sao_Paulo", 
  "CN": "Asia/Shanghai"
};

// Country names mapping
const countryNames = {
  "US": "United States", "IN": "India", "GB": "United Kingdom", 
  "DE": "Germany", "JP": "Japan", "AU": "Australia", "CA": "Canada",
  "FR": "France", "BR": "Brazil", "CN": "China"
};

// Country-specific tax brackets (simplified examples)
const taxBrackets = {
  "US": [
    { min: 0, max: 10275, rate: 10 },
    { min: 10275, max: 41775, rate: 12 },
    { min: 41775, max: 89075, rate: 22 },
    { min: 89075, max: 170050, rate: 24 },
    { min: 170050, max: 215950, rate: 32 },
    { min: 215950, max: 539900, rate: 35 },
    { min: 539900, max: Infinity, rate: 37 }
  ],
  "IN": [
    { min: 0, max: 250000, rate: 0 },
    { min: 250000, max: 500000, rate: 5 },
    { min: 500000, max: 1000000, rate: 20 },
    { min: 1000000, max: Infinity, rate: 30 }
  ],
  "GB": [
    { min: 0, max: 12570, rate: 0 },
    { min: 12570, max: 50270, rate: 20 },
    { min: 50270, max: 150000, rate: 40 },
    { min: 150000, max: Infinity, rate: 45 }
  ],
  "DE": [
    { min: 0, max: 9744, rate: 0 },
    { min: 9744, max: 57919, rate: 14 },
    { min: 57919, max: 274613, rate: 42 },
    { min: 274613, max: Infinity, rate: 45 }
  ],
  "AU": [
    { min: 0, max: 18200, rate: 0 },
    { min: 18200, max: 45000, rate: 19 },
    { min: 45000, max: 120000, rate: 32.5 },
    { min: 120000, max: 180000, rate: 37 },
    { min: 180000, max: Infinity, rate: 45 }
  ],
  "CA": [
    { min: 0, max: 50197, rate: 15 },
    { min: 50197, max: 100392, rate: 20.5 },
    { min: 100392, max: 155625, rate: 26 },
    { min: 155625, max: 221708, rate: 29 },
    { min: 221708, max: Infinity, rate: 33 }
  ]
};

/* ------------------ Global state ------------------ */
let autoRefresh = true;
let autoRefreshInterval = null;
let currencySymbols = [];
let historyItems = JSON.parse(localStorage.getItem('calcHistory')) || [];
let mileageRecords = [];

/* ------------------ DOM Elements ------------------ */
const elements = {
  countrySelect: document.getElementById('country-select'),
  tabs: document.querySelectorAll('.tab'),
  panels: document.querySelectorAll('.panel'),
  stdDisplay: document.getElementById('std-display'),
  sciDisplay: document.getElementById('sci-display'),
  // ... other element references would be added here
};

/* ------------------ Initialization ------------------ */
document.addEventListener('DOMContentLoaded', function() {
  initializeTabs();
  initializeCountrySelector();
  populateCurrencyDropdowns();
  populateMeasureUnits();
  loadMileageRecords();
  updateHistoryDisplay();
  startAutoRefresh();
  updateLocalTime();
  setInterval(updateLocalTime, 1000);
});

/* ------------------ Tab Management ------------------ */
function initializeTabs() {
  elements.tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
}

function switchTab(tabName) {
  // Deactivate all tabs and panels
  elements.tabs.forEach(tab => tab.classList.remove('active'));
  elements.panels.forEach(panel => {
    panel.classList.remove('active');
    panel.setAttribute('aria-hidden', 'true');
  });

  // Activate the selected tab and panel
  const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
  const activePanel = document.getElementById(tabName);
  
  if (activeTab && activePanel) {
    activeTab.classList.add('active');
    activePanel.classList.add('active');
    activePanel.setAttribute('aria-hidden', 'false');
  }
}

/* ------------------ Country Selector ------------------ */
function initializeCountrySelector() {
  elements.countrySelect.value = currentCountry;
  elements.countrySelect.addEventListener('change', function() {
    currentCountry = this.value;
    countryCurrency = countryCurrencyMap[currentCountry] || 'USD';
    countryTimeZone = countryTimeZoneMap[currentCountry] || 'UTC';
    countryCurrencySymbol = countryCurrencySymbolMap[currentCountry] || '$';
    
    document.getElementById('current-country').textContent = countryNames[currentCountry];
    document.getElementById('country-currency').textContent = countryCurrency;
    document.getElementById('local-currency').textContent = countryCurrency;
    
    refreshLiveData();
  });
}

/* ------------------ Currency Functions ------------------ */
async function populateCurrencyDropdowns() {
  try {
    const response = await fetch(API.SYMBOLS);
    const data = await response.json();
    
    if (data.success) {
      currencySymbols = Object.values(data.symbols);
      
      const fromCurrency = document.getElementById('from-currency');
      const toCurrency = document.getElementById('to-currency');
      const quickFrom = document.getElementById('quick-from');
      const quickTo = document.getElementById('quick-to');
      
      // Clear existing options
      fromCurrency.innerHTML = '';
      toCurrency.innerHTML = '';
      quickFrom.innerHTML = '';
      quickTo.innerHTML = '';
      
      // Add options to dropdowns
      currencySymbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol.code;
        option.textContent = `${symbol.code} - ${symbol.description}`;
        
        fromCurrency.appendChild(option.cloneNode(true));
        toCurrency.appendChild(option.cloneNode(true));
        quickFrom.appendChild(option.cloneNode(true));
        quickTo.appendChild(option.cloneNode(true));
      });
      
      // Set default values
      fromCurrency.value = 'USD';
      toCurrency.value = countryCurrency;
      quickFrom.value = 'USD';
      quickTo.value = countryCurrency;
    }
  } catch (error) {
    console.error('Error fetching currency symbols:', error);
  }
}

async function convertCurrency() {
  const amount = document.getElementById('cur-amount').value;
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  
  try {
    const response = await fetch(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    const data = await response.json();
    
    if (data.success) {
      const result = document.getElementById('cur-result');
      result.innerHTML = `
        <strong>${amount} ${from} = ${data.result.toFixed(2)} ${to}</strong>
        <div class="small">Rate: 1 ${from} = ${data.info.rate.toFixed(6)} ${to}</div>
      `;
      
      // Add to history
      addToHistory(`${amount} ${from} to ${to}`, `${data.result.toFixed(2)} ${to}`);
    } else {
      document.getElementById('cur-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (error) {
    console.error('Error converting currency:', error);
    document.getElementById('cur-result').textContent = 'Network error. Please check your connection.';
  }
}

function swapCurrency() {
  const from = document.getElementById('from-currency');
  const to = document.getElementById('to-currency');
  const temp = from.value;
  from.value = to.value;
  to.value = temp;
}

/* ------------------ Standard Calculator ------------------ */
let stdExpression = '0';

function stdAppend(value) {
  if (stdExpression === '0' && value !== '.') {
    stdExpression = value;
  } else {
    stdExpression += value;
  }
  elements.stdDisplay.value = stdExpression;
}

function stdClear() {
  stdExpression = '0';
  elements.stdDisplay.value = stdExpression;
}

function stdBack() {
  if (stdExpression.length > 1) {
    stdExpression = stdExpression.slice(0, -1);
  } else {
    stdExpression = '0';
  }
  elements.stdDisplay.value = stdExpression;
}

function stdCalculate() {
  try {
    // Replace visual operators with JavaScript operators
    let calcExpression = stdExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    
    // Handle percentage calculations
    if (calcExpression.includes('%')) {
      const parts = calcExpression.split(/([-+*/])/);
      if (parts.length === 3) {
        const num = parseFloat(parts[0]);
        const operator = parts[1];
        const percent = parseFloat(parts[2]);
        
        if (operator === '+' || operator === '-') {
          const percentageValue = num * (percent / 100);
          calcExpression = operator === '+' ? 
            `${num} + ${percentageValue}` : 
            `${num} - ${percentageValue}`;
        } else if (operator === '*' || operator === '/') {
          calcExpression = `${num} ${operator} ${percent / 100}`;
        }
      }
    }
    
    const result = eval(calcExpression);
    elements.stdDisplay.value = result;
    stdExpression = result.toString();
    
    addToHistory(stdExpression, result);
  } catch (error) {
    elements.stdDisplay.value = 'Error';
    stdExpression = '0';
  }
}

/* ------------------ Scientific Calculator ------------------ */
let sciExpression = '0';

function sciAppend(value) {
  if (sciExpression === '0' && value !== '.') {
    sciExpression = value;
  } else {
    sciExpression += value;
  }
  elements.sciDisplay.value = sciExpression;
}

function sciClear() {
  sciExpression = '0';
  elements.sciDisplay.value = sciExpression;
}

function sciBack() {
  if (sciExpression.length > 1) {
    sciExpression = sciExpression.slice(0, -1);
  } else {
    sciExpression = '0';
  }
  elements.sciDisplay.value = sciExpression;
}

function sciFunc(func) {
  let value = parseFloat(sciExpression);
  let result;
  
  switch(func) {
    case 'sin':
      result = Math.sin(value * Math.PI / 180); // Convert to radians
      break;
    case 'cos':
      result = Math.cos(value * Math.PI / 180);
      break;
    case 'tan':
      result = Math.tan(value * Math.PI / 180);
      break;
    case 'sqrt':
      result = Math.sqrt(value);
      break;
    case 'log':
      result = Math.log10(value);
      break;
    case 'ln':
      result = Math.log(value);
      break;
  }
  
  sciExpression = result.toString();
  elements.sciDisplay.value = sciExpression;
  addToHistory(`${func}(${value})`, result);
}

function sciFact() {
  let num = parseInt(sciExpression);
  if (num < 0) return;
  
  let result = 1;
  for (let i = 2; i <= num; i++) {
    result *= i;
  }
  
  sciExpression = result.toString();
  elements.sciDisplay.value = sciExpression;
  addToHistory(`${num}!`, result);
}

function sciCalculate() {
  try {
    // Replace visual operators with JavaScript operators
    let calcExpression = sciExpression
      .replace(/Ã—/g, '*')
      .replace(/Ã·/g, '/')
      .replace(/Ï€/g, 'Math.PI')
      .replace(/e/g, 'Math.E');
    
    const result = eval(calcExpression);
    elements.sciDisplay.value = result;
    sciExpression = result.toString();
    
    addToHistory(sciExpression, result);
  } catch (error) {
    elements.sciDisplay.value = 'Error';
    sciExpression = '0';
  }
}

/* ------------------ Live Data Functions ------------------ */
async function refreshLiveData() {
  try {
    // Update timestamp
    document.getElementById('live-updated').textContent = new Date().toLocaleTimeString();
    
    // Fetch currency rates
    const currencyResponse = await fetch(`${API.LATEST}?base=USD&symbols=${countryCurrency},EUR`);
    const currencyData = await currencyResponse.json();
    
    if (currencyData.success) {
      document.getElementById('usd-local').textContent = 
        `${currencyData.rates[countryCurrency].toFixed(2)} ${countryCurrency}`;
      document.getElementById('eur-usd').textContent = 
        `${(1 / currencyData.rates.EUR).toFixed(4)} USD`;
    }
    
    // Fetch gold and silver prices
    const goldResponse = await fetch(API.GOLDPRICE + countryCurrency);
    const goldData = await goldResponse.json();
    
    if (goldData && goldData.items) {
      document.getElementById('gold').textContent = 
        `${countryCurrencySymbol}${goldData.items[0].xauPrice.toLocaleString()}`;
      document.getElementById('silver').textContent = 
        `${countryCurrencySymbol}${goldData.items[0].xagPrice.toLocaleString()}`;
    }
    
    // Fetch cryptocurrency prices
    const cryptoResponse = await fetch(
      `${API.COINGECKO_SIMPLE}?ids=bitcoin,ethereum&vs_currencies=usd`
    );
    const cryptoData = await cryptoResponse.json();
    
    if (cryptoData.bitcoin && cryptoData.ethereum) {
      document.getElementById('btc').textContent = 
        `$${cryptoData.bitcoin.usd.toLocaleString()}`;
      document.getElementById('eth').textContent = 
        `$${cryptoData.ethereum.usd.toLocaleString()}`;
    }
  } catch (error) {
    console.error('Error fetching live data:', error);
  }
}

function startAutoRefresh() {
  if (autoRefresh) {
    refreshLiveData();
    autoRefreshInterval = setInterval(refreshLiveData, 60000); // Refresh every minute
  }
}

function toggleAuto() {
  autoRefresh = !autoRefresh;
  document.getElementById('auto-status').textContent = autoRefresh ? 'ON' : 'OFF';
  
  if (autoRefresh) {
    startAutoRefresh();
  } else {
    clearInterval(autoRefreshInterval);
  }
}

function updateLocalTime() {
  const now = new Date();
  const options = { timeZone: countryTimeZone };
  
  document.getElementById('local-time').textContent = now.toLocaleTimeString('en-US', options);
  document.getElementById('local-date').textContent = now.toLocaleDateString('en-US', {
    ...options,
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

/* ------------------ Measurement Functions ------------------ */
function populateUnits() {
  const type = document.getElementById('measure-type').value;
  const fromSelect = document.getElementById('measure-from');
  const toSelect = document.getElementById('measure-to');
  
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';
  
  let units = [];
  
  switch(type) {
    case 'length':
      units = ['Meter', 'Kilometer', 'Centimeter', 'Millimeter', 'Mile', 'Yard', 'Foot', 'Inch'];
      break;
    case 'weight':
      units = ['Kilogram', 'Gram', 'Milligram', 'Pound', 'Ounce', 'Ton'];
      break;
    case 'temperature':
      units = ['Celsius', 'Fahrenheit', 'Kelvin'];
      break;
  }
  
  units.forEach(unit => {
    const fromOption = document.createElement('option');
    fromOption.value = unit;
    fromOption.textContent = unit;
    
    const toOption = fromOption.cloneNode(true);
    
    fromSelect.appendChild(fromOption);
    toSelect.appendChild(toOption);
  });
  
  // Set default values
  if (type === 'temperature') {
    fromSelect.value = 'Celsius';
    toSelect.value = 'Fahrenheit';
  } else {
    fromSelect.value = units[0];
    toSelect.value = units[1];
  }
}

function convertMeasure() {
  const value = parseFloat(document.getElementById('measure-value').value);
  const fromUnit = document.getElementById('measure-from').value;
  const toUnit = document.getElementById('measure-to').value;
  const type = document.getElementById('measure-type').value;
  
  let result;
  
  switch(type) {
    case 'length':
      result = convertLength(value, fromUnit, toUnit);
      break;
    case 'weight':
      result = convertWeight(value, fromUnit, toUnit);
      break;
    case 'temperature':
      result = convertTemperature(value, fromUnit, toUnit);
      break;
  }
  
  document.getElementById('measure-result').innerHTML = `
    <strong>${value} ${fromUnit} = ${result.toFixed(6)} ${toUnit}</strong>
  `;
  
  addToHistory(`${value} ${fromUnit} to ${toUnit}`, `${result.toFixed(4)} ${toUnit}`);
}

function convertLength(value, fromUnit, toUnit) {
  // Convert to meters first
  let meters;
  
  switch(fromUnit) {
    case 'Kilometer': meters = value * 1000; break;
    case 'Meter': meters = value; break;
    case 'Centimeter': meters = value / 100; break;
    case 'Millimeter': meters = value / 1000; break;
    case 'Mile': meters = value * 1609.34; break;
    case 'Yard': meters = value * 0.9144; break;
    case 'Foot': meters = value * 0.3048; break;
    case 'Inch': meters = value * 0.0254; break;
  }
  
  // Convert from meters to target unit
  switch(toUnit) {
    case 'Kilometer': return meters / 1000;
    case 'Meter': return meters;
    case 'Centimeter': return meters * 100;
    case 'Millimeter': return meters * 1000;
    case 'Mile': return meters / 1609.34;
    case 'Yard': return meters / 0.9144;
    case 'Foot': return meters / 0.3048;
    case 'Inch': return meters / 0.0254;
  }
}

function convertWeight(value, fromUnit, toUnit) {
  // Convert to kilograms first
  let kilograms;
  
  switch(fromUnit) {
    case 'Kilogram': kilograms = value; break;
    case 'Gram': kilograms = value / 1000; break;
    case 'Milligram': kilograms = value / 1000000; break;
    case 'Pound': kilograms = value * 0.453592; break;
    case 'Ounce': kilograms = value * 0.0283495; break;
    case 'Ton': kilograms = value * 1000; break;
  }
  
  // Convert from kilograms to target unit
  switch(toUnit) {
    case 'Kilogram': return kilograms;
    case 'Gram': return kilograms * 1000;
    case 'Milligram': return kilograms * 1000000;
    case 'Pound': return kilograms / 0.453592;
    case 'Ounce': return kilograms / 0.0283495;
    case 'Ton': return kilograms / 1000;
  }
}

function convertTemperature(value, fromUnit, toUnit) {
  // Convert to Celsius first
  let celsius;
  
  switch(fromUnit) {
    case 'Celsius': celsius = value; break;
    case 'Fahrenheit': celsius = (value - 32) * 5/9; break;
    case 'Kelvin': celsius = value - 273.15; break;
  }
  
  // Convert from Celsius to target unit
  switch(toUnit) {
    case 'Celsius': return celsius;
    case 'Fahrenheit': return (celsius * 9/5) + 32;
    case 'Kelvin': return celsius + 273.15;
  }
}

function resetMeasure() {
  document.getElementById('measure-value').value = '1';
  populateUnits();
  document.getElementById('measure-result').textContent = 'Conversion';
}

/* ------------------ BMI Calculator ------------------ */
function calcBMI() {
  const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
  const weight = parseFloat(document.getElementById('bmi-weight').value);
  
  if (height > 0 && weight > 0) {
    const bmi = weight / (height * height);
    let category;
    
    if (bmi < 18.5) category = 'Underweight';
    else if (bmi < 25) category = 'Normal weight';
    else if (bmi < 30) category = 'Overweight';
    else category = 'Obesity';
    
    document.getElementById('bmi-result').innerHTML = `
      <strong>BMI: ${bmi.toFixed(1)}</strong>
      <div class="small">Category: ${category}</div>
    `;
    
    addToHistory('BMI Calculation', `${bmi.toFixed(1)} (${category})`);
  } else {
    document.getElementById('bmi-result').textContent = 'Please enter valid values';
  }
}

function clearBMI() {
  document.getElementById('bmi-height').value = '170';
  document.getElementById('bmi-weight').value = '70';
  document.getElementById('bmi-result').textContent = 'BMI result';
}

/* ------------------ Discount Calculator ------------------ */
function calcDiscount() {
  const price = parseFloat(document.getElementById('discount-price').value);
  const discount = parseFloat(document.getElementById('discount-percent').value);
  
  if (price > 0 && discount >= 0) {
    const discountAmount = price * (discount / 100);
    const finalPrice = price - discountAmount;
    
    document.getElementById('discount-result').innerHTML = `
      <strong>Final Price: ${countryCurrencySymbol}${finalPrice.toFixed(2)}</strong>
      <div class="small">You save: ${countryCurrencySymbol}${discountAmount.toFixed(2)} (${discount}%)</div>
    `;
    
    addToHistory('Discount Calculation', `${countryCurrencySymbol}${finalPrice.toFixed(2)} (Saved ${countryCurrencySymbol}${discountAmount.toFixed(2)})`);
  } else {
    document.getElementById('discount-result').textContent = 'Please enter valid values';
  }
}

function clearDiscount() {
  document.getElementById('discount-price').value = '100';
  document.getElementById('discount-percent').value = '20';
  document.getElementById('discount-result').textContent = 'Discount result';
}

/* ------------------ Tip Calculator ------------------ */
function calcTip() {
  const amount = parseFloat(document.getElementById('tip-amount').value);
  const tipPercent = parseFloat(document.getElementById('tip-percent').value);
  const people = parseInt(document.getElementById('tip-people').value);
  
  if (amount > 0 && tipPercent >= 0 && people > 0) {
    const tipAmount = amount * (tipPercent / 100);
    const totalAmount = amount + tipAmount;
    const perPerson = totalAmount / people;
    
    document.getElementById('tip-result').innerHTML = `
      <strong>Total: ${countryCurrencySymbol}${totalAmount.toFixed(2)}</strong>
      <div class="small">Tip: ${countryCurrencySymbol}${tipAmount.toFixed(2)}</div>
      <div class="small">Each person pays: ${countryCurrencySymbol}${perPerson.toFixed(2)}</div>
    `;
    
    addToHistory('Tip Calculation', `${countryCurrencySymbol}${totalAmount.toFixed(2)} (Tip: ${countryCurrencySymbol}${tipAmount.toFixed(2)})`);
  } else {
    document.getElementById('tip-result').textContent = 'Please enter valid values';
  }
}

/* ------------------ Loan Calculator ------------------ */
function calcLoan() {
  const principal = parseFloat(document.getElementById('loan-p').value);
  const rate = parseFloat(document.getElementById('loan-r').value) / 100 / 12; // Monthly rate
  const periods = parseInt(document.getElementById('loan-n').value) * 12; // Months
  
  if (principal > 0 && rate > 0 && periods > 0) {
    const emi = principal * rate * Math.pow(1 + rate, periods) / (Math.pow(1 + rate, periods) - 1);
    const totalPayment = emi * periods;
    const totalInterest = totalPayment - principal;
    
    document.getElementById('loan-result').innerHTML = `
      <strong>EMI: ${countryCurrencySymbol}${emi.toFixed(2)}</strong>
      <div class="small">Total Payment: ${countryCurrencySymbol}${totalPayment.toFixed(2)}</div>
      <div class="small">Total Interest: ${countryCurrencySymbol}${totalInterest.toFixed(2)}</div>
    `;
    
    addToHistory('Loan Calculation', `${countryCurrencySymbol}${emi.toFixed(2)}/month (Total: ${countryCurrencySymbol}${totalPayment.toFixed(2)})`);
  } else {
    document.getElementById('loan-result').textContent = 'Please enter valid values';
  }
}

function clearLoan() {
  document.getElementById('loan-p').value = '100000';
  document.getElementById('loan-r').value = '7.5';
  document.getElementById('loan-n').value = '5';
  document.getElementById('loan-result').textContent = 'EMI result';
}

/* ------------------ Tax Calculator ------------------ */
function calcTax() {
  const income = parseFloat(document.getElementById('tax-income').value);
  const country = document.getElementById('tax-country').value;
  
  if (income >= 0 && taxBrackets[country]) {
    let tax = 0;
    let remainingIncome = income;
    const brackets = taxBrackets[country];
    
    for (let i = 0; i < brackets.length; i++) {
      const bracket = brackets[i];
      const taxableInBracket = Math.min(remainingIncome, bracket.max - bracket.min);
      
      if (taxableInBracket > 0) {
        tax += taxableInBracket * (bracket.rate / 100);
        remainingIncome -= taxableInBracket;
      }
      
      if (remainingIncome <= 0) break;
    }
    
    const effectiveRate = (tax / income) * 100;
    
    document.getElementById('tax-result').innerHTML = `
      <strong>Tax: ${countryCurrencySymbol}${tax.toFixed(2)}</strong>
      <div class="small">Effective Tax Rate: ${effectiveRate.toFixed(2)}%</div>
      <div class="small">Net Income: ${countryCurrencySymbol}${(income - tax).toFixed(2)}</div>
    `;
    
    addToHistory('Tax Calculation', `${countryCurrencySymbol}${tax.toFixed(2)} (${effectiveRate.toFixed(2)}% effective)`);
  } else {
    document.getElementById('tax-result').textContent = 'Please enter valid values';
  }
}

function clearTax() {
  document.getElementById('tax-income').value = '500000';
  document.getElementById('tax-country').value = currentCountry;
  document.getElementById('tax-result').textContent = 'Tax result';
}

/* ------------------ Date Calculator ------------------ */
function calcAge() {
  const dob = new Date(document.getElementById('dob').value);
  const today = new Date();
  
  if (dob && dob <= today) {
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    
    document.getElementById('age-result').innerHTML = `
      <strong>Age: ${age} years</strong>
      <div class="small">Born: ${dob.toLocaleDateString()}</div>
    `;
    
    addToHistory('Age Calculation', `${age} years`);
  } else {
    document.getElementById('age-result').textContent = 'Please enter a valid date of birth';
  }
}

function clearAge() {
  document.getElementById('dob').value = '';
  document.getElementById('age-result').textContent = 'Age result';
}

function daysBetween() {
  const start = new Date(document.getElementById('start-date').value);
  const end = new Date(document.getElementById('end-date').value);
  
  if (start && end) {
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    document.getElementById('date-diff-result').innerHTML = `
      <strong>Difference: ${diffDays} days</strong>
      <div class="small">From: ${start.toLocaleDateString()} to ${end.toLocaleDateString()}</div>
    `;
    
    addToHistory('Days Between', `${diffDays} days`);
  } else {
    document.getElementById('date-diff-result').textContent = 'Please select both dates';
  }
}

function clearDates() {
  document.getElementById('start-date').value = '';
  document.getElementById('end-date').value = '';
  document.getElementById('date-diff-result').textContent = 'Days difference';
}

function addDays() {
  const baseDate = new Date(document.getElementById('base-date').value);
  const days = parseInt(document.getElementById('days-add').value);
  
  if (baseDate && !isNaN(days)) {
    const resultDate = new Date(baseDate);
    resultDate.setDate(resultDate.getDate() + days);
    
    document.getElementById('add-days-result').innerHTML = `
      <strong>Result: ${resultDate.toLocaleDateString()}</strong>
      <div class="small">${days} days ${days >= 0 ? 'after' : 'before'} ${baseDate.toLocaleDateString()}</div>
    `;
    
    addToHistory('Date Calculation', resultDate.toLocaleDateString());
  } else {
    document.getElementById('add-days-result').textContent = 'Please enter valid values';
  }
}

function clearAddDays() {
  document.getElementById('base-date').value = '';
  document.getElementById('days-add').value = '0';
  document.getElementById('add-days-result').textContent = 'Add/Sub result';
}

/* ------------------ Mileage Tracker ------------------ */
async function loadMileageRecords() {
  try {
    // Try to load from Firestore first
    if (db) {
      const querySnapshot = await getDocs(query(collection(db, 'mileage'), orderBy('date', 'desc')));
      mileageRecords = [];
      
      querySnapshot.forEach(doc => {
        mileageRecords.push({ id: doc.id, ...doc.data() });
      });
    } else {
      // Fallback to localStorage
      const stored = localStorage.getItem('mileageRecords');
      mileageRecords = stored ? JSON.parse(stored) : [];
    }
    
    updateMileageTable();
    updateMileageSummary();
  } catch (error) {
    console.error('Error loading mileage records:', error);
    
    // Fallback to localStorage
    const stored = localStorage.getItem('mileageRecords');
    mileageRecords = stored ? JSON.parse(stored) : [];
    updateMileageTable();
    updateMileageSummary();
  }
}

async function addMileage() {
  const vehicle = document.getElementById('vehicle').value;
  const odo = parseFloat(document.getElementById('odo').value);
  const fuel = parseFloat(document.getElementById('fuel').value);
  const cost = parseFloat(document.getElementById('cost').value);
  const date = document.getElementById('mdate').value || new Date().toISOString().split('T')[0];
  
  if (!vehicle || isNaN(odo) || isNaN(fuel) || isNaN(cost) || fuel <= 0) {
    alert('Please fill all fields with valid values');
    return;
  }
  
  const mileage = odo / fuel; // km per liter
  
  const record = {
    vehicle,
    odo,
    fuel,
    cost,
    date,
    mileage: mileage.toFixed(2)
  };
  
  try {
    if (db) {
      // Save to Firestore
      const docRef = await addDoc(collection(db, 'mileage'), record);
      record.id = docRef.id;
    }
    
    // Also save to localStorage as backup
    mileageRecords.unshift(record);
    localStorage.setItem('mileageRecords', JSON.stringify(mileageRecords));
    
    updateMileageTable();
    updateMileageSummary();
    clearMileageForm();
    
    addToHistory('Mileage Added', `${mileage.toFixed(2)} km/L`);
  } catch (error) {
    console.error('Error adding mileage record:', error);
    alert('Failed to save record. Please try again.');
  }
}

function updateMileageTable() {
  const tbody = document.querySelector('#mileage-table tbody');
  tbody.innerHTML = '';
  
  mileageRecords.forEach(record => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${record.date}</td>
      <td>${record.vehicle}</td>
      <td>${record.odo}</td>
      <td>${record.fuel}L</td>
      <td>${countryCurrencySymbol}${record.cost}</td>
      <td>${record.mileage} km/L</td>
      <td><span class="delete" onclick="deleteMileage('${record.id || record.date}')"><i class="fas fa-trash"></i></span></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateMileageSummary() {
  const summary = document.getElementById('mileage-summary');
  
  if (mileageRecords.length === 0) {
    summary.textContent = 'No records yet';
    return;
  }
  
  // Calculate averages
  const totalFuel = mileageRecords.reduce((sum, record) => sum + record.fuel, 0);
  const totalCost = mileageRecords.reduce((sum, record) => sum + record.cost, 0);
  const avgMileage = mileageRecords.reduce((sum, record) => sum + parseFloat(record.mileage), 0) / mileageRecords.length;
  const avgCostPerKm = totalCost / mileageRecords.reduce((sum, record) => sum + record.odo, 0);
  
  summary.innerHTML = `
    <strong>Summary: ${mileageRecords.length} records</strong>
    <div class="small">Avg. Mileage: ${avgMileage.toFixed(2)} km/L</div>
    <div class="small">Total Fuel: ${totalFuel.toFixed(2)}L | Total Cost: ${countryCurrencySymbol}${totalCost.toFixed(2)}</div>
    <div class="small">Cost per km: ${countryCurrencySymbol}${avgCostPerKm.toFixed(2)}</div>
  `;
}

function clearMileageForm() {
  document.getElementById('vehicle').value = '';
  document.getElementById('odo').value = '';
  document.getElementById('fuel').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('mdate').value = new Date().toISOString().split('T')[0];
}

async function deleteMileage(id) {
  if (confirm('Are you sure you want to delete this record?')) {
    try {
      if (db) {
        // Delete from Firestore
        await deleteDoc(doc(db, 'mileage', id));
      }
      
      // Delete from local records
      mileageRecords = mileageRecords.filter(record => 
        record.id !== id && record.date !== id
      );
      
      // Update localStorage
      localStorage.setItem('mileageRecords', JSON.stringify(mileageRecords));
      
      updateMileageTable();
      updateMileageSummary();
    } catch (error) {
      console.error('Error deleting mileage record:', error);
      alert('Failed to delete record. Please try again.');
    }
  }
}

function exportMileageCSV() {
  if (mileageRecords.length === 0) {
    alert('No records to export');
    return;
  }
  
  let csv = 'Date,Vehicle,Odometer (km),Fuel (L),Cost,Mileage (km/L)\n';
  
  mileageRecords.forEach(record => {
    csv += `${record.date},${record.vehicle},${record.odo},${record.fuel},${record.cost},${record.mileage}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  a.href = url;
  a.download = `mileage-export-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function clearMileageStorage() {
  if (confirm('Are you sure you want to clear all mileage records? This cannot be undone.')) {
    mileageRecords = [];
    localStorage.removeItem('mileageRecords');
    updateMileageTable();
    updateMileageSummary();
  }
}

/* ------------------ Quick Converter ------------------ */
function fillQuick() {
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  const amount = document.getElementById('cur-amount').value;
  
  document.getElementById('quick-from').value = from;
  document.getElementById('quick-to').value = to;
  document.getElementById('quick-amt').value = amount;
}

async function quickConvert() {
  const amount = document.getElementById('quick-amt').value;
  const from = document.getElementById('quick-from').value;
  const to = document.getElementById('quick-to').value;
  
  try {
    const response = await fetch(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('quick-result').innerHTML = `
        <strong>${amount} ${from} = ${data.result.toFixed(2)} ${to}</strong>
        <div class="small">Rate: 1 ${from} = ${data.info.rate.toFixed(6)} ${to}</div>
      `;
    } else {
      document.getElementById('quick-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (error) {
    console.error('Error converting currency:', error);
    document.getElementById('quick-result').textContent = 'Network error. Please check your connection.';
  }
}

/* ------------------ History Functions ------------------ */
function addToHistory(calculation, result) {
  historyItems.unshift({
    calculation,
    result,
    timestamp: new Date().toLocaleString()
  });
  
  // Keep only the last 50 items
  if (historyItems.length > 50) {
    historyItems.pop();
  }
  
  localStorage.setItem('calcHistory', JSON.stringify(historyItems));
  updateHistoryDisplay();
}

function updateHistoryDisplay() {
  const historyEl = document.getElementById('history');
  historyEl.innerHTML = '';
  
  if (historyItems.length === 0) {
    historyEl.innerHTML = '<div class="muted">No history yet</div>';
    return;
  }
  
  historyItems.forEach(item => {
    const div = document.createElement('div');
    div.style.padding = '6px 0';
    div.style.borderBottom = '1px solid #f1f5f9';
    div.innerHTML = `
      <div><strong>${item.calculation}</strong> = ${item.result}</div>
      <div class="tiny muted">${item.timestamp}</div>
    `;
    historyEl.appendChild(div);
  });
}

function copyHistory() {
  if (historyItems.length === 0) {
    alert('No history to copy');
    return;
  }
  
  let text = 'Calculation History\n';
  text += '-----------------\n';
  
  historyItems.forEach(item => {
    text += `${item.timestamp}: ${item.calculation} = ${item.result}\n`;
  });
  
  navigator.clipboard.writeText(text)
    .then(() => alert('History copied to clipboard'))
    .catch(err => console.error('Could not copy text: ', err));
}

function downloadHistory() {
  if (historyItems.length === 0) {
    alert('No history to export');
    return;
  }
  
  let csv = 'Timestamp,Calculation,Result\n';
  
  historyItems.forEach(item => {
    csv += `"${item.timestamp}","${item.calculation}","${item.result}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  a.href = url;
  a.download = `calculator-history-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function resetAll() {
  if (confirm('Are you sure you want to reset all data? This will clear your history and mileage records.')) {
    historyItems = [];
    mileageRecords = [];
    localStorage.removeItem('calcHistory');
    localStorage.removeItem('mileageRecords');
    updateHistoryDisplay();
    updateMileageTable();
    updateMileageSummary();
  }
}

/* ------------------ Utility Functions ------------------ */
function refreshLive() {
  refreshLiveData();
}

// Initialize measure units on page load
populateUnits();

</script>
</body>
</html>
