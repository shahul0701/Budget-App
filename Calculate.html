<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All-in-One Calculator & Live Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --accent:#0ea5a4;
      --good:#10b981;
      --danger:#ef4444;
      --muted:#6b7280;
      --india-saffron:#FF9933;
      --india-green:#138808;
      --india-blue:#000080;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:linear-gradient(180deg,#0f1724,#0b1220);min-height:100vh;padding:18px;display:flex;justify-content:center;align-items:flex-start}
    .app{width:100%;max-width:1200px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
    header{background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    header h1{font-size:1.05rem;display:flex;gap:10px;align-items:center}
    .country-selector{display:flex;align-items:center;gap:8px;margin-left:auto}
    .country-selector select{padding:6px 10px;border-radius:6px;border:none;background:rgba(255,255,255,0.2);color:#fff}
    .layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:680px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
    .main{padding:18px;background:#fff}
    .sidebar{background:#f8fafc;padding:18px;border-left:1px solid #e6eef6}
    .modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:1px solid #e6eef6;cursor:pointer;font-weight:700;color:#0f1724}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .panel{display:none}
    .panel.active{display:block;animation:fadeIn .25s ease}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .input, input, select, textarea, button{font-family:inherit}
    .input{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
    button.btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.btn.ghost{background:#eef2ff;color:#0f1724;border:1px solid #e6eef6}
    button.btn.india{background:linear-gradient(90deg,var(--india-saffron),var(--india-green));color:white}
    .display{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef6;background:#f8fafc;text-align:right;font-size:1.25rem}
    .result-box{margin-top:12px;padding:12px;border-left:4px solid var(--accent);background:#f0f9ff;border-radius:8px}
    .section{margin-bottom:14px}
    .small{font-size:0.92rem;color:var(--muted)}
    .history{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef5fb}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef5fb;text-align:left;font-size:0.92rem}
    .live-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef5fb;margin-bottom:10px}
    .live-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .tiny{font-size:0.85rem}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .delete{color:var(--danger);cursor:pointer}
    .india-badge{padding:2px 6px;background:linear-gradient(90deg,var(--india-saffron),var(--india-green));color:white;border-radius:4px;font-size:0.75rem;font-weight:bold}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    footer{padding:10px 18px;background:#f8fafc;border-top:1px solid #eef5fb;font-size:0.9rem;color:var(--muted)}
    .note {font-size:0.85rem;color:#374151;margin-top:8px}
    .country-flag {width: 20px; height: 15px; display: inline-block; margin-right: 5px; vertical-align: middle; background-size: cover;}
    .fuel-price-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
    .fuel-card {background: white; border: 1px solid #e6eef6; border-radius: 8px; padding: 12px;}
    .fuel-card h4 {margin: 0 0 8px 0; color: #374151;}
    .fuel-price {font-size: 1.2rem; font-weight: bold; color: #0ea5a4;}
    .fuel-change {font-size: 0.85rem;}
    .fuel-change.up {color: #10b981;}
    .fuel-change.down {color: #ef4444;}
    .petrol-info {background: linear-gradient(135deg,#fef3c7,#fde68a);padding: 12px;border-radius: 8px;margin-top: 10px;}
    .gold-silver-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
    .precious-card {background: white; border: 1px solid #e6eef6; border-radius: 8px; padding: 12px; position: relative;}
    .precious-card:before {content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #FFD700, #C0C0C0);}
    .metal-price {font-size: 1.3rem; font-weight: bold;}
    .metal-unit {font-size: 0.85rem; color: var(--muted);}
    .rate-change {font-size: 0.85rem; padding: 2px 6px; border-radius: 4px; display: inline-block;}
    .rate-up {background: #dcfce7; color: #166534;}
    .rate-down {background: #fee2e2; color: #991b1b;}
  </style>
</head>
<body>

<div class="app" role="application" aria-label="All-in-One Calculator">
  <header>
    <h1><i class="fas fa-calculator"></i> All-in-One Calculator â€” Live <span id="india-badge" class="india-badge">ðŸ‡®ðŸ‡³ INDIA</span></h1>
    <div class="country-selector">
      <i class="fas fa-globe"></i>
      <select id="country-select">
        <option value="US" data-flag="ðŸ‡ºðŸ‡¸">United States</option>
        <option value="IN" data-flag="ðŸ‡®ðŸ‡³" selected>India</option>
        <option value="GB" data-flag="ðŸ‡¬ðŸ‡§">United Kingdom</option>
        <option value="DE" data-flag="ðŸ‡©ðŸ‡ª">Germany</option>
        <option value="JP" data-flag="ðŸ‡¯ðŸ‡µ">Japan</option>
        <option value="AU" data-flag="ðŸ‡¦ðŸ‡º">Australia</option>
        <option value="CA" data-flag="ðŸ‡¨ðŸ‡¦">Canada</option>
        <option value="FR" data-flag="ðŸ‡«ðŸ‡·">France</option>
        <option value="BR" data-flag="ðŸ‡§ðŸ‡·">Brazil</option>
        <option value="CN" data-flag="ðŸ‡¨ðŸ‡³">China</option>
      </select>
    </div>
    <div class="small">Currency (live) Â· Gold Â· Silver Â· Petrol Â· Crypto Â· Loan Â· Tax Â· Measure</div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main" aria-live="polite">
      <div class="modes" role="tablist">
        <div class="tab active" data-tab="standard">Standard</div>
        <div class="tab" data-tab="scientific">Scientific</div>
        <div class="tab" data-tab="currency">Currency</div>
        <div class="tab" data-tab="india-rates">India Rates</div>
        <div class="tab" data-tab="mileage">Mileage</div>
        <div class="tab" data-tab="loan">Loan</div>
        <div class="tab" data-tab="tax">Tax</div>
        <div class="tab" data-tab="date">Date</div>
        <div class="tab" data-tab="measure">Measure</div>
        <div class="tab" data-tab="bmi">BMI</div>
        <div class="tab" data-tab="discount">Discount</div>
        <div class="tab" data-tab="tip">Tip</div>
      </div>

      <!-- Standard Calculator -->
      <section id="standard" class="panel active section">
        <div class="small">Basic arithmetic</div>
        <input id="std-display" class="display" readonly value="0" aria-label="Standard display">
        <div style="margin-top:10px" class="grid-4">
          <button class="btn ghost" onclick="stdClear()">C</button>
          <button class="btn ghost" onclick="stdBack()">âŒ«</button>
          <button class="btn ghost" onclick="stdAppend('%')">%</button>
          <button class="btn ghost" onclick="stdAppend('/')">/</button>
          <button class="btn" onclick="stdAppend('7')">7</button>
          <button class="btn" onclick="stdAppend('8')">8</button>
          <button class="btn" onclick="stdAppend('9')">9</button>
          <button class="btn ghost" onclick="stdAppend('*')">Ã—</button>
          <button class="btn" onclick="stdAppend('4')">4</button>
          <button class="btn" onclick="stdAppend('5')">5</button>
          <button class="btn" onclick="stdAppend('6')">6</button>
          <button class="btn ghost" onclick="stdAppend('-')">-</button>
          <button class="btn" onclick="stdAppend('1')">1</button>
          <button class="btn" onclick="stdAppend('2')">2</button>
          <button class="btn" onclick="stdAppend('3')">3</button>
          <button class="btn ghost" onclick="stdAppend('+')">+</button>
          <button class="btn" onclick="stdAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="stdAppend('.')">.</button>
          <button class="btn" onclick="stdCalculate()">=</button>
        </div>
      </section>

      <!-- Scientific Calculator -->
      <section id="scientific" class="panel section" aria-hidden="true">
        <div class="small">Scientific (trig in degrees)</div>
        <input id="sci-display" class="display" readonly value="0">
        <div style="margin-top:10px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
          <button class="btn ghost" onclick="sciClear()">C</button>
          <button class="btn ghost" onclick="sciBack()">âŒ«</button>
          <button class="btn ghost" onclick="sciAppend('(')">(</button>
          <button class="btn ghost" onclick="sciAppend('')">)</button>
          <button class="btn ghost" onclick="sciAppend('**')">^</button>
          <button class="btn" onclick="sciFunc('sin')">sin</button>
          <button class="btn" onclick="sciFunc('cos')">cos</button>
          <button class="btn" onclick="sciFunc('tan')">tan</button>
          <button class="btn" onclick="sciFunc('sqrt')">âˆš</button>
          <button class="btn" onclick="sciAppend('Math.PI')">Ï€</button>
          <button class="btn" onclick="sciFunc('log')">log</button>
          <button class="btn" onclick="sciFunc('ln')">ln</button>
          <button class="btn" onclick="sciAppend('Math.E')">e</button>
          <button class="btn" onclick="sciFact()">x!</button>
          <button class="btn" onclick="sciAppend('%')">%</button>
          <button class="btn" onclick="sciAppend('7')">7</button>
          <button class="btn" onclick="sciAppend('8')">8</button>
          <button class="btn" onclick="sciAppend('9')">9</button>
          <button class="btn ghost" onclick="sciAppend('/')">/</button>
          <button class="btn ghost" onclick="sciAppend('*')">Ã—</button>
          <button class="btn" onclick="sciAppend('4')">4</button>
          <button class="btn" onclick="sciAppend('5')">5</button>
          <button class="btn" onclick="sciAppend('6')">6</button>
          <button class="btn ghost" onclick="sciAppend('-')">-</button>
          <button class="btn ghost" onclick="sciAppend('+')">+</button>
          <button class="btn" onclick="sciAppend('1')">1</button>
          <button class="btn" onclick="sciAppend('2')">2</button>
          <button class="btn" onclick="sciAppend('3')">3</button>
          <button class="btn" onclick="sciCalculate()" style="grid-column:span 2">=</button>
          <button class="btn" onclick="sciAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="sciAppend('.')">.</button>
        </div>
      </section>

      <!-- Currency Converter -->
      <section id="currency" class="panel section" aria-hidden="true">
        <div class="small">Live currency conversion (exchangerate.host)</div>
        <div style="display:grid;grid-template-columns:1fr 180px;gap:8px;margin-top:8px">
          <input id="cur-amount" class="input" type="number" value="1" min="0" step="any">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="convertCurrency()">Convert</button>
            <button class="btn ghost" onclick="swapCurrency()">Swap</button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="from-currency" class="input"></select>
          <select id="to-currency" class="input"></select>
        </div>
        <div class="result-box" id="cur-result">Result will appear here</div>
        
        <!-- Enhanced Indian Currency Converter -->
        <div id="india-currency-converter" style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:8px; border:1px solid #e6eef6;">
          <h3 style="margin-bottom:10px;"><i class="fas fa-rupee-sign"></i> Indian Currency Converter</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
            <button class="btn ghost" onclick="setIndianConversion('USD')">USD â†’ INR</button>
            <button class="btn ghost" onclick="setIndianConversion('EUR')">EUR â†’ INR</button>
            <button class="btn ghost" onclick="setIndianConversion('GBP')">GBP â†’ INR</button>
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
            <input type="number" id="indian-amount" class="input" placeholder="Amount" value="1000" style="flex:1">
            <button class="btn india" onclick="convertIndianCurrency()"><i class="fas fa-exchange-alt"></i> Convert</button>
          </div>
          <div id="indian-result" class="result-box" style="margin-top:10px">
            Converted value will appear here
          </div>
        </div>
      </section>

      <!-- India Rates (NEW TAB) -->
      <section id="india-rates" class="panel section" aria-hidden="true">
        <div class="small">Live Indian Market Rates</div>
        
        <!-- Gold & Silver Rates -->
        <div class="gold-silver-grid">
          <div class="precious-card">
            <h4><i class="fas fa-gem" style="color:#FFD700"></i> Gold (24K)</h4>
            <div class="metal-price" id="gold-price-inr">â‚¹ 6,500 / 10g</div>
            <div class="metal-unit">Per 10 grams</div>
            <div class="rate-change rate-up" id="gold-change">+0.5% today</div>
          </div>
          <div class="precious-card">
            <h4><i class="fas fa-gem" style="color:#C0C0C0"></i> Silver</h4>
            <div class="metal-price" id="silver-price-inr">â‚¹ 78 / gram</div>
            <div class="metal-unit">Per gram</div>
            <div class="rate-change rate-down" id="silver-change">-0.2% today</div>
          </div>
        </div>

        <!-- Fuel Prices -->
        <div style="margin-top:20px">
          <h3><i class="fas fa-gas-pump"></i> Fuel Prices in India</h3>
          <div class="fuel-price-grid">
            <div class="fuel-card">
              <h4>Petrol</h4>
              <div class="fuel-price" id="petrol-price">â‚¹ 106.31</div>
              <div class="fuel-change up" id="petrol-change">+â‚¹0.20 today</div>
              <div class="tiny">New Delhi</div>
            </div>
            <div class="fuel-card">
              <h4>Diesel</h4>
              <div class="fuel-price" id="diesel-price">â‚¹ 94.27</div>
              <div class="fuel-change down" id="diesel-change">-â‚¹0.10 today</div>
              <div class="tiny">New Delhi</div>
            </div>
          </div>
          <div class="petrol-info">
            <strong>Note:</strong> Fuel prices vary by city. These are indicative rates for major cities.
            <button class="btn ghost" onclick="refreshFuelPrices()" style="margin-top:8px">
              <i class="fas fa-sync-alt"></i> Refresh Fuel Prices
            </button>
          </div>
        </div>

        <!-- Currency Rates -->
        <div style="margin-top:20px">
          <h3><i class="fas fa-chart-line"></i> Major Currency Exchange</h3>
          <table style="width:100%;margin-top:10px">
            <thead>
              <tr><th>Currency</th><th>Buy</th><th>Sell</th><th>Change</th></tr>
            </thead>
            <tbody id="forex-table">
              <tr><td>USD â†’ INR</td><td>â‚¹83.45</td><td>â‚¹83.65</td><td class="rate-up">+0.12%</td></tr>
              <tr><td>EUR â†’ INR</td><td>â‚¹89.23</td><td>â‚¹89.45</td><td class="rate-down">-0.05%</td></tr>
              <tr><td>GBP â†’ INR</td><td>â‚¹104.67</td><td>â‚¹104.90</td><td class="rate-up">+0.08%</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Investment Calculator -->
        <div style="margin-top:20px; padding:15px; background:#f0f9ff; border-radius:8px; border:1px solid #e6eef6;">
          <h3><i class="fas fa-calculator"></i> Gold Investment Calculator</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
            <input type="number" id="gold-investment" class="input" placeholder="Investment Amount (â‚¹)" value="50000">
            <select id="gold-period" class="input">
              <option value="1">1 Year</option>
              <option value="3">3 Years</option>
              <option value="5">5 Years</option>
              <option value="10">10 Years</option>
            </select>
          </div>
          <button class="btn" onclick="calculateGoldInvestment()" style="margin-top:10px">
            <i class="fas fa-chart-bar"></i> Calculate Returns
          </button>
          <div id="gold-investment-result" class="result-box" style="margin-top:10px">
            Enter amount and period to calculate
          </div>
        </div>
      </section>

      <!-- Mileage Tracker -->
      <section id="mileage" class="panel section" aria-hidden="true">
        <div class="small">Mileage tracker (saved to Firebase & localStorage)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="vehicle" class="input" placeholder="Vehicle name">
          <input id="odo" class="input" placeholder="Odometer (km)" type="number" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="fuel" class="input" placeholder="Fuel (L)" type="number" step="any">
          <input id="cost" class="input" placeholder="Fuel cost (â‚¹)" type="number" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="mdate" class="input" type="date" style="flex:1">
          <button class="btn" onclick="addMileage()">Add</button>
          <button class="btn ghost" onclick="clearMileageForm()">Clear</button>
        </div>
        <div class="result-box" id="mileage-summary">No records yet</div>
        <h3 style="margin-top:12px">History</h3>
        <div style="overflow:auto;max-height:220px">
          <table id="mileage-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Loan Calculator -->
      <section id="loan" class="panel section" aria-hidden="true">
        <div class="small">Loan / EMI Calculator (Indian rates)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loan-p" class="input" placeholder="Principal (â‚¹)" type="number" value="1000000">
          <input id="loan-r" class="input" placeholder="Annual rate (%)" type="number" value="8.5">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="loan-n" class="input" placeholder="Years" type="number" value="20">
          <button class="btn" onclick="calcLoan()">Calculate EMI</button>
          <button class="btn ghost" onclick="clearLoan()">Clear</button>
        </div>
        <div class="result-box" id="loan-result">EMI result will appear here</div>
        
        <!-- Indian Loan Types -->
        <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:8px; border:1px solid #e6eef6;">
          <h3><i class="fas fa-home"></i> Quick Loan Types (India)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
            <button class="btn ghost" onclick="setLoanType('home')">Home Loan (8.4%)</button>
            <button class="btn ghost" onclick="setLoanType('car')">Car Loan (9.5%)</button>
            <button class="btn ghost" onclick="setLoanType('personal')">Personal Loan (12%)</button>
            <button class="btn ghost" onclick="setLoanType('education')">Education Loan (9%)</button>
          </div>
        </div>
      </section>

      <!-- Tax Calculator -->
      <section id="tax" class="panel section" aria-hidden="true">
        <div class="small">Indian Income Tax Calculator (FY 2024-25)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tax-income" class="input" placeholder="Taxable income (â‚¹)" type="number" value="1000000">
          <select id="tax-regime" class="input">
            <option value="new">New Tax Regime</option>
            <option value="old">Old Tax Regime</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="tax-age" class="input" placeholder="Age" type="number" value="30">
          <select id="tax-filing" class="input">
            <option value="individual">Individual</option>
            <option value="senior">Senior Citizen</option>
            <option value="super-senior">Super Senior Citizen</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcIndianTax()">Calculate Tax</button>
          <button class="btn ghost" onclick="clearTax()">Clear</button>
        </div>
        <div class="result-box" id="tax-result">Tax result will appear here</div>
        
        <!-- Indian Tax Slabs -->
        <div style="margin-top:20px; padding:15px; background:#f0f9ff; border-radius:8px; border:1px solid #e6eef6;">
          <h3><i class="fas fa-file-invoice"></i> Indian Tax Slabs (New Regime)</h3>
          <table style="width:100%;margin-top:10px;font-size:0.85rem">
            <thead><tr><th>Income (â‚¹)</th><th>Tax Rate</th></tr></thead>
            <tbody>
              <tr><td>Up to 3,00,000</td><td>0%</td></tr>
              <tr><td>3,00,001 - 6,00,000</td><td>5%</td></tr>
              <tr><td>6,00,001 - 9,00,000</td><td>10%</td></tr>
              <tr><td>9,00,001 - 12,00,000</td><td>15%</td></tr>
              <tr><td>12,00,001 - 15,00,000</td><td>20%</td></tr>
              <tr><td>Above 15,00,000</td><td>30%</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Date Calculator -->
      <section id="date" class="panel section" aria-hidden="true">
        <div class="small">Age, days between and add/subtract days</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="dob" type="date" class="input"><div style="display:flex;gap:8px"><button class="btn" onclick="calcAge()">Age</button><button class="btn ghost" onclick="clearAge()">Clear</button></div>
        </div>
        <div class="result-box" id="age-result">Age result</div>
        <hr style="margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="start-date" type="date" class="input"><input id="end-date" type="date" class="input">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="daysBetween()">Days between</button>
          <button class="btn ghost" onclick="clearDates()">Clear</button>
        </div>
        <div class="result-box" id="date-diff-result">Days difference</div>
        <hr style="margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="base-date" type="date" class="input"><input id="days-add" type="number" class="input" value="0">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addDays()">Add/Subtract</button><button class="btn ghost" onclick="clearAddDays()">Clear</button>
        </div>
        <div class="result-box" id="add-days-result">Add/Sub result</div>
      </section>

      <!-- Measurement Converter -->
      <section id="measure" class="panel section" aria-hidden="true">
        <div class="small">Length, Weight, Temperature conversions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="measure-type" class="input" onchange="populateUnits()"><option value="length">Length</option><option value="weight">Weight</option><option value="temperature">Temperature</option><option value="area">Area</option><option value="volume">Volume</option></select>
          <input id="measure-value" class="input" type="number" value="1" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="measure-from" class="input"></select>
          <select id="measure-to" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="convertMeasure()">Convert</button>
          <button class="btn ghost" onclick="resetMeasure()">Clear</button>
        </div>
        <div class="result-box" id="measure-result">Conversion</div>
        
        <!-- Indian Units -->
        <div style="margin-top:20px; padding:15px; background:#f8fafc; border-radius:8px; border:1px solid #e6eef6;">
          <h3><i class="fas fa-balance-scale"></i> Indian Traditional Units</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
            <button class="btn ghost" onclick="setIndianUnit('bigha')">1 Bigha = 0.25 Hectare</button>
            <button class="btn ghost" onclick="setIndianUnit('acre')">1 Acre = 0.4 Hectare</button>
            <button class="btn ghost" onclick="setIndianUnit('ser')">1 Ser = 0.933 kg</button>
            <button class="btn ghost" onclick="setIndianUnit('tola')">1 Tola = 11.66 grams</button>
          </div>
        </div>
      </section>

      <!-- BMI Calculator -->
      <section id="bmi" class="panel section" aria-hidden="true">
        <div class="small">Body Mass Index calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="bmi-height" class="input" placeholder="Height (cm)" type="number" value="170">
          <input id="bmi-weight" class="input" placeholder="Weight (kg)" type="number" value="70">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcBMI()">Calculate BMI</button>
          <button class="btn ghost" onclick="clearBMI()">Clear</button>
        </div>
        <div class="result-box" id="bmi-result">BMI result</div>
        <div class="small" style="margin-top:6px">Underweight: <18.5, Normal: 18.5-24.9, Overweight: 25-29.9, Obesity: â‰¥30</div>
      </section>

      <!-- Discount Calculator -->
      <section id="discount" class="panel section" aria-hidden="true">
        <div class="small">Discount and sale price calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="discount-price" class="input" placeholder="Original price (â‚¹)" type="number" value="1000">
          <input id="discount-percent" class="input" placeholder="Discount (%)" type="number" value="20">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcDiscount()">Calculate</button>
          <button class="btn ghost" onclick="clearDiscount()">Clear</button>
        </div>
        <div class="result-box" id="discount-result">Discount result</div>
      </section>

      <!-- Tip Calculator -->
      <section id="tip" class="panel section" aria-hidden="true">
        <div class="small">Tip calculator (Indian context)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tip-amount" class="input" placeholder="Bill amount (â‚¹)" type="number" value="1000">
          <input id="tip-percent" class="input" placeholder="Tip percentage" type="number" value="10">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="tip-people" class="input" placeholder="Number of people" type="number" value="2">
          <button class="btn" onclick="calcTip()">Calculate</button>
        </div>
        <div class="result-box" id="tip-result">Tip result</div>
        <div class="small" style="margin-top:6px">Suggested: Restaurants 5-10%, Delivery 5%, Hotels 10-15%</div>
      </section>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Recent calculations</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="copyHistory()">Copy</button>
          <button class="btn ghost" onclick="downloadHistory()">Export CSV</button>
          <button class="btn" onclick="resetAll()">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="history" id="history"></div>
    </main>

    <!-- SIDEBAR / LIVE PANEL -->
    <aside class="sidebar" aria-label="Live market data">
      <div class="live-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Snapshot</strong>
          <div class="tiny muted" id="live-updated">--</div>
        </div>

        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">USD â†’ <span id="local-currency">INR</span></div><div id="usd-local" style="font-weight:800">â‚¹83.45</div></div>
          <div><div class="small muted">EUR â†’ USD</div><div id="eur-usd" style="font-weight:800">1.0824</div></div>

          <div><div class="small muted">Gold (10g)</div><div id="gold" style="font-weight:800;color:#FFD700">â‚¹6,500</div></div>
          <div><div class="small muted">Silver (g)</div><div id="silver" style="font-weight:800;color:#C0C0C0">â‚¹78</div></div>

          <div><div class="small muted">Petrol (Delhi)</div><div id="petrol" style="font-weight:800">â‚¹106.31</div></div>
          <div><div class="small muted">Diesel (Delhi)</div><div id="diesel" style="font-weight:800">â‚¹94.27</div></div>

          <div><div class="small muted">Bitcoin (USD)</div><div id="btc" style="font-weight:800">$63,450</div></div>
          <div><div class="small muted">Ethereum (USD)</div><div id="eth" style="font-weight:800">$3,450</div></div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="refreshLive()">Refresh</button>
          <button class="btn ghost" onclick="toggleAuto()">Auto: <span id="auto-status">ON</span></button>
        </div>

        <div class="tiny muted" style="margin-top:8px">Gold/Silver: MCX India, Petrol: Indian Oil Corp</div>
      </div>

      <div class="live-card">
        <strong>Quick Converter</strong>
        <div style="margin-top:8px">
          <input id="quick-amt" class="input" value="1" type="number" step="any">
          <select id="quick-from" class="input" style="margin-top:6px"></select>
          <select id="quick-to" class="input" style="margin-top:6px"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="quickConvert()">Convert</button>
            <button class="btn ghost" onclick="fillQuick()">Use main</button>
          </div>
          <div class="result-box" id="quick-result">Quick result</div>
        </div>
      </div>

      <div class="live-card">
        <strong>Country Data</strong>
        <div class="small muted" style="margin-top:8px">Local time & info for <span id="current-country">India</span></div>
        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">Local Time</div><div id="local-time" style="font-weight:800">--:--:--</div></div>
          <div><div class="small muted">Date</div><div id="local-date" style="font-weight:800">--</div></div>
        </div>
        <div class="small muted" style="margin-top:8px">Currency: <span id="country-currency">INR</span> | Symbol: â‚¹</div>
        <div class="small muted">Time Zone: <span id="country-timezone">Asia/Kolkata</span></div>
      </div>

      <div class="live-card">
        <strong>Mileage Export</strong>
        <div class="small muted" style="margin-top:8px">Export or clear mileage (local fallback)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="exportMileageCSV()">Export CSV</button>
          <button class="btn ghost" onclick="clearMileageStorage()">Clear</button>
        </div>
        <div class="note">If Firestore is accessible you'll see saved records from your Firebase project; otherwise localStorage backup is used.</div>
      </div>
    </aside>
  </div>

  <footer>Open dev console to see detailed errors if any API fails. If CORS errors appear, run a local web server (e.g. <code>python -m http.server 8000</code>) and open the page at <code>http://localhost:8000/</code>.</footer>
</div>

<script type="module">
/* ======================= MODULE SCRIPT - ALL FEATURES ======================= */

/* ------------------ Firebase (optional) ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---- Replace with your Firebase config if you want a different project ---- */
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

let db = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  console.info('Firestore initialized');
} catch (e) {
  console.warn('Firestore init failed (or blocked):', e);
}

/* ------------------ API endpoints ------------------ */
const API = {
  SYMBOLS: "https://api.exchangerate.host/symbols",
  CONVERT: "https://api.exchangerate.host/convert",
  LATEST: "https://api.exchangerate.host/latest",
  GOLDPRICE: "https://data-asg.goldprice.org/dbXRates/",
  COINGECKO_SIMPLE: "https://api.coingecko.com/api/v3/simple/price",
  COUNTRIES: "https://restcountries.com/v3.1/alpha/",
  // Indian market APIs (simulated endpoints - in production use actual APIs)
  GOLD_SILVER: "https://api.metalpriceapi.com/v1/latest", // Example API
  FUEL_PRICES: "https://fuelprice-api.herokuapp.com/latest" // Example API
};

/* ------------------ Country data ------------------ */
let currentCountry = "IN";
let countryCurrency = "INR";
let countryTimeZone = "Asia/Kolkata";
let countryCurrencySymbol = "â‚¹";

// Country to currency mapping (fallback)
const countryCurrencyMap = {
  "US": "USD", "IN": "INR", "GB": "GBP", "DE": "EUR", "JP": "JPY",
  "AU": "AUD", "CA": "CAD", "FR": "EUR", "BR": "BRL", "CN": "CNY"
};

// Country to currency symbol mapping
const countryCurrencySymbolMap = {
  "US": "$", "IN": "â‚¹", "GB": "Â£", "DE": "â‚¬", "JP": "Â¥",
  "AU": "$", "CA": "$", "FR": "â‚¬", "BR": "R$", "CN": "Â¥"
};

// Country to timezone mapping (fallback)
const countryTimeZoneMap = {
  "US": "America/New_York", "IN": "Asia/Kolkata", "GB": "Europe/London", 
  "DE": "Europe/Berlin", "JP": "Asia/Tokyo", "AU": "Australia/Sydney",
  "CA": "America/Toronto", "FR": "Europe/Paris", "BR": "America/Sao_Paulo", 
  "CN": "Asia/Shanghai"
};

// Country names mapping
const countryNames = {
  "US": "United States", "IN": "India", "GB": "United Kingdom", 
  "DE": "Germany", "JP": "Japan", "AU": "Australia", "CA": "Canada",
  "FR": "France", "BR": "Brazil", "CN": "China"
};

// Indian city data
const indianCities = {
  "Delhi": { petrol: 106.31, diesel: 94.27 },
  "Mumbai": { petrol: 111.35, diesel: 97.66 },
  "Chennai": { petrol: 102.63, diesel: 94.24 },
  "Bangalore": { petrol: 107.23, diesel: 92.89 },
  "Kolkata": { petrol: 115.11, diesel: 99.83 }
};

// Indian tax brackets (New Regime 2024-25)
const indianTaxBracketsNew = [
  { min: 0, max: 300000, rate: 0 },
  { min: 300001, max: 600000, rate: 5 },
  { min: 600001, max: 900000, rate: 10 },
  { min: 900001, max: 1200000, rate: 15 },
  { min: 1200001, max: 1500000, rate: 20 },
  { min: 1500001, max: Infinity, rate: 30 }
];

// Indian tax brackets (Old Regime)
const indianTaxBracketsOld = [
  { min: 0, max: 250000, rate: 0 },
  { min: 250001, max: 500000, rate: 5 },
  { min: 500001, max: 1000000, rate: 20 },
  { min: 1000001, max: Infinity, rate: 30 }
];

// Loan interest rates for India
const indianLoanRates = {
  "home": 8.4,
  "car": 9.5,
  "personal": 12.0,
  "education": 9.0,
  "business": 11.5
};

// Indian traditional units
const indianUnits = {
  "bigha": { toHectare: 0.25, description: "Land measurement" },
  "acre": { toHectare: 0.4, description: "Land measurement" },
  "ser": { toKg: 0.933, description: "Weight measurement" },
  "tola": { toGram: 11.66, description: "Gold weight" },
  "pound": { toKg: 0.373, description: "Weight (lbs in India)" }
};

/* ------------------ Global state ------------------ */
let autoRefresh = true;
let autoRefreshInterval = null;
let currencySymbols = [];
let historyItems = JSON.parse(localStorage.getItem('calcHistory')) || [];
let mileageRecords = [];

// Indian market data cache
let indianMarketData = {
  gold: { price: 6500, change: 0.5, unit: "10g" },
  silver: { price: 78, change: -0.2, unit: "gram" },
  petrol: { price: 106.31, change: 0.20, city: "Delhi" },
  diesel: { price: 94.27, change: -0.10, city: "Delhi" },
  forex: {
    usd: { buy: 83.45, sell: 83.65, change: 0.12 },
    eur: { buy: 89.23, sell: 89.45, change: -0.05 },
    gbp: { buy: 104.67, sell: 104.90, change: 0.08 }
  }
};

/* ------------------ DOM Elements ------------------ */
const elements = {
  countrySelect: document.getElementById('country-select'),
  tabs: document.querySelectorAll('.tab'),
  panels: document.querySelectorAll('.panel'),
  stdDisplay: document.getElementById('std-display'),
  sciDisplay: document.getElementById('sci-display'),
  // India-specific elements
  goldPriceInr: document.getElementById('gold-price-inr'),
  silverPriceInr: document.getElementById('silver-price-inr'),
  petrolPrice: document.getElementById('petrol-price'),
  dieselPrice: document.getElementById('diesel-price'),
  goldChange: document.getElementById('gold-change'),
  silverChange: document.getElementById('silver-change'),
  petrolChange: document.getElementById('petrol-change'),
  dieselChange: document.getElementById('diesel-change')
};

/* ------------------ Initialization ------------------ */
document.addEventListener('DOMContentLoaded', function() {
  initializeTabs();
  initializeCountrySelector();
  populateCurrencyDropdowns();
  populateMeasureUnits();
  loadMileageRecords();
  updateHistoryDisplay();
  startAutoRefresh();
  updateLocalTime();
  setInterval(updateLocalTime, 1000);
  
  // Initialize Indian market data
  updateIndianMarketDisplay();
  
  // Set current city in fuel prices
  document.getElementById('country-currency').textContent = countryCurrency;
  document.getElementById('local-currency').textContent = countryCurrency;
  document.getElementById('country-timezone').textContent = countryTimeZone;
});

/* ------------------ Tab Management ------------------ */
function initializeTabs() {
  elements.tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      switchTab(tabName);
    });
  });
}

function switchTab(tabName) {
  elements.tabs.forEach(tab => tab.classList.remove('active'));
  elements.panels.forEach(panel => {
    panel.classList.remove('active');
    panel.setAttribute('aria-hidden', 'true');
  });

  const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
  const activePanel = document.getElementById(tabName);
  
  if (activeTab && activePanel) {
    activeTab.classList.add('active');
    activePanel.classList.add('active');
    activePanel.setAttribute('aria-hidden', 'false');
  }
  
  // Special handling for India Rates tab
  if (tabName === 'india-rates' && currentCountry === 'IN') {
    refreshIndianMarketData();
  }
}

/* ------------------ Country Selector ------------------ */
function initializeCountrySelector() {
  elements.countrySelect.value = currentCountry;
  elements.countrySelect.addEventListener('change', function() {
    currentCountry = this.value;
    countryCurrency = countryCurrencyMap[currentCountry] || 'USD';
    countryTimeZone = countryTimeZoneMap[currentCountry] || 'UTC';
    countryCurrencySymbol = countryCurrencySymbolMap[currentCountry] || '$';
    
    document.getElementById('current-country').textContent = countryNames[currentCountry];
    document.getElementById('country-currency').textContent = countryCurrency;
    document.getElementById('local-currency').textContent = countryCurrency;
    document.getElementById('country-timezone').textContent = countryTimeZone;
    
    // Show/hide India badge
    const indiaBadge = document.getElementById('india-badge');
    if (currentCountry === 'IN') {
      indiaBadge.style.display = 'inline-block';
    } else {
      indiaBadge.style.display = 'none';
    }
    
    refreshLiveData();
  });
}

/* ------------------ Currency Functions ------------------ */
async function populateCurrencyDropdowns() {
  try {
    const response = await fetch(API.SYMBOLS);
    const data = await response.json();
    
    if (data.success) {
      currencySymbols = Object.values(data.symbols);
      
      const fromCurrency = document.getElementById('from-currency');
      const toCurrency = document.getElementById('to-currency');
      const quickFrom = document.getElementById('quick-from');
      const quickTo = document.getElementById('quick-to');
      
      fromCurrency.innerHTML = '';
      toCurrency.innerHTML = '';
      quickFrom.innerHTML = '';
      quickTo.innerHTML = '';
      
      currencySymbols.forEach(symbol => {
        const option = document.createElement('option');
        option.value = symbol.code;
        option.textContent = `${symbol.code} - ${symbol.description}`;
        
        fromCurrency.appendChild(option.cloneNode(true));
        toCurrency.appendChild(option.cloneNode(true));
        quickFrom.appendChild(option.cloneNode(true));
        quickTo.appendChild(option.cloneNode(true));
      });
      
      // Set default values
      fromCurrency.value = 'USD';
      toCurrency.value = countryCurrency;
      quickFrom.value = 'USD';
      quickTo.value = countryCurrency;
    }
  } catch (error) {
    console.error('Error fetching currency symbols:', error);
  }
}

async function convertCurrency() {
  const amount = document.getElementById('cur-amount').value;
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  
  try {
    const response = await fetch(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    const data = await response.json();
    
    if (data.success) {
      const result = document.getElementById('cur-result');
      result.innerHTML = `
        <strong>${amount} ${from} = ${data.result.toFixed(2)} ${to}</strong>
        <div class="small">Rate: 1 ${from} = ${data.info.rate.toFixed(6)} ${to}</div>
      `;
      
      addToHistory(`${amount} ${from} to ${to}`, `${data.result.toFixed(2)} ${to}`);
    } else {
      document.getElementById('cur-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (error) {
    console.error('Error converting currency:', error);
    document.getElementById('cur-result').textContent = 'Network error. Please check your connection.';
  }
}

function swapCurrency() {
  const from = document.getElementById('from-currency');
  const to = document.getElementById('to-currency');
  const temp = from.value;
  from.value = to.value;
  to.value = temp;
}

/* ------------------ Indian Market Data Functions ------------------ */
function updateIndianMarketDisplay() {
  // Update gold and silver
  elements.goldPriceInr.textContent = `â‚¹ ${indianMarketData.gold.price.toLocaleString('en-IN')} / ${indianMarketData.gold.unit}`;
  elements.silverPriceInr.textContent = `â‚¹ ${indianMarketData.silver.price.toLocaleString('en-IN')} / ${indianMarketData.silver.unit}`;
  
  // Update fuel prices
  elements.petrolPrice.textContent = `â‚¹ ${indianMarketData.petrol.price.toFixed(2)}`;
  elements.dieselPrice.textContent = `â‚¹ ${indianMarketData.diesel.price.toFixed(2)}`;
  
  // Update changes
  elements.goldChange.textContent = `${indianMarketData.gold.change > 0 ? '+' : ''}${indianMarketData.gold.change}% today`;
  elements.goldChange.className = `rate-change ${indianMarketData.gold.change > 0 ? 'rate-up' : 'rate-down'}`;
  
  elements.silverChange.textContent = `${indianMarketData.silver.change > 0 ? '+' : ''}${indianMarketData.silver.change}% today`;
  elements.silverChange.className = `rate-change ${indianMarketData.silver.change > 0 ? 'rate-up' : 'rate-down'}`;
  
  elements.petrolChange.textContent = `${indianMarketData.petrol.change > 0 ? '+' : ''}â‚¹${indianMarketData.petrol.change.toFixed(2)} today`;
  elements.petrolChange.className = `fuel-change ${indianMarketData.petrol.change > 0 ? 'up' : 'down'}`;
  
  elements.dieselChange.textContent = `${indianMarketData.diesel.change > 0 ? '+' : ''}â‚¹${indianMarketData.diesel.change.toFixed(2)} today`;
  elements.dieselChange.className = `fuel-change ${indianMarketData.diesel.change > 0 ? 'up' : 'down'}`;
  
  // Update sidebar
  document.getElementById('gold').textContent = `â‚¹${indianMarketData.gold.price.toLocaleString('en-IN')}`;
  document.getElementById('silver').textContent = `â‚¹${indianMarketData.silver.price.toLocaleString('en-IN')}`;
  document.getElementById('petrol').textContent = `â‚¹${indianMarketData.petrol.price.toFixed(2)}`;
  document.getElementById('diesel').textContent = `â‚¹${indianMarketData.diesel.price.toFixed(2)}`;
  
  // Update forex table
  const forexTable = document.getElementById('forex-table');
  forexTable.innerHTML = `
    <tr>
      <td>USD â†’ INR</td>
      <td>â‚¹${indianMarketData.forex.usd.buy.toFixed(2)}</td>
      <td>â‚¹${indianMarketData.forex.usd.sell.toFixed(2)}</td>
      <td class="${indianMarketData.forex.usd.change > 0 ? 'rate-up' : 'rate-down'}">${indianMarketData.forex.usd.change > 0 ? '+' : ''}${indianMarketData.forex.usd.change}%</td>
    </tr>
    <tr>
      <td>EUR â†’ INR</td>
      <td>â‚¹${indianMarketData.forex.eur.buy.toFixed(2)}</td>
      <td>â‚¹${indianMarketData.forex.eur.sell.toFixed(2)}</td>
      <td class="${indianMarketData.forex.eur.change > 0 ? 'rate-up' : 'rate-down'}">${indianMarketData.forex.eur.change > 0 ? '+' : ''}${indianMarketData.forex.eur.change}%</td>
    </tr>
    <tr>
      <td>GBP â†’ INR</td>
      <td>â‚¹${indianMarketData.forex.gbp.buy.toFixed(2)}</td>
      <td>â‚¹${indianMarketData.forex.gbp.sell.toFixed(2)}</td>
      <td class="${indianMarketData.forex.gbp.change > 0 ? 'rate-up' : 'rate-down'}">${indianMarketData.forex.gbp.change > 0 ? '+' : ''}${indianMarketData.forex.gbp.change}%</td>
    </tr>
  `;
}

async function refreshIndianMarketData() {
  try {
    // In a real app, you would fetch from actual APIs
    // For demo purposes, we'll simulate data updates
    const now = new Date();
    
    // Simulate price fluctuations
    const fluctuation = (Math.random() - 0.5) * 0.5;
    
    // Update gold price (simulated)
    indianMarketData.gold.price += fluctuation * 50;
    indianMarketData.gold.change = fluctuation;
    
    // Update silver price (simulated)
    indianMarketData.silver.price += fluctuation * 2;
    indianMarketData.silver.change = fluctuation * 1.5;
    
    // Update fuel prices (simulated)
    indianMarketData.petrol.price += (Math.random() - 0.5) * 0.2;
    indianMarketData.petrol.change = (Math.random() - 0.5) * 0.1;
    
    indianMarketData.diesel.price += (Math.random() - 0.5) * 0.15;
    indianMarketData.diesel.change = (Math.random() - 0.5) * 0.08;
    
    // Update forex rates (simulated)
    indianMarketData.forex.usd.buy += (Math.random() - 0.5) * 0.05;
    indianMarketData.forex.usd.sell = indianMarketData.forex.usd.buy + 0.20;
    indianMarketData.forex.usd.change = (Math.random() - 0.5) * 0.05;
    
    indianMarketData.forex.eur.buy += (Math.random() - 0.5) * 0.03;
    indianMarketData.forex.eur.sell = indianMarketData.forex.eur.buy + 0.22;
    indianMarketData.forex.eur.change = (Math.random() - 0.5) * 0.03;
    
    indianMarketData.forex.gbp.buy += (Math.random() - 0.5) * 0.04;
    indianMarketData.forex.gbp.sell = indianMarketData.forex.gbp.buy + 0.23;
    indianMarketData.forex.gbp.change = (Math.random() - 0.5) * 0.04;
    
    updateIndianMarketDisplay();
    
    // Update timestamp
    document.getElementById('live-updated').textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    console.log('Indian market data refreshed at', now.toLocaleTimeString());
  } catch (error) {
    console.error('Error refreshing Indian market data:', error);
  }
}

function refreshFuelPrices() {
  // Cycle through different cities
  const cities = Object.keys(indianCities);
  const currentCity = indianMarketData.petrol.city;
  const currentIndex = cities.indexOf(currentCity);
  const nextIndex = (currentIndex + 1) % cities.length;
  const nextCity = cities[nextIndex];
  
  // Update to next city's prices
  indianMarketData.petrol.price = indianCities[nextCity].petrol;
  indianMarketData.diesel.price = indianCities[nextCity].diesel;
  indianMarketData.petrol.city = nextCity;
  indianMarketData.diesel.city = nextCity;
  
  // Add small random change
  indianMarketData.petrol.change = (Math.random() - 0.5) * 0.15;
  indianMarketData.diesel.change = (Math.random() - 0.5) * 0.12;
  
  updateIndianMarketDisplay();
  
  alert(`Fuel prices updated for ${nextCity}`);
}

/* ------------------ Indian Currency Converter Functions ------------------ */
function setIndianConversion(currency) {
  document.getElementById('from-currency').value = currency;
  document.getElementById('to-currency').value = 'INR';
  document.getElementById('quick-from').value = currency;
  document.getElementById('quick-to').value = 'INR';
  document.getElementById('cur-amount').value = currency === 'USD' ? '100' : currency === 'EUR' ? '100' : '100';
  document.getElementById('indian-amount').value = '1000';
  
  // Switch to currency tab
  switchTab('currency');
}

async function convertIndianCurrency() {
  const amount = document.getElementById('indian-amount').value;
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  
  try {
    const response = await fetch(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    const data = await response.json();
    
    if (data.success) {
      const result = document.getElementById('indian-result');
      result.innerHTML = `
        <strong>${amount} ${from} = ${data.result.toFixed(2)} ${to}</strong>
        <div class="small">Rate: 1 ${from} = ${data.info.rate.toFixed(6)} ${to}</div>
        <div class="small">Exchange rate valid as of ${new Date().toLocaleString('en-IN')}</div>
      `;
      
      addToHistory(`Indian Convert: ${amount} ${from} to ${to}`, `${data.result.toFixed(2)} ${to}`);
    } else {
      // Fallback to simulated rate if API fails
      const simulatedRate = from === 'USD' ? 83.45 : from === 'EUR' ? 89.23 : 104.67;
      const simulatedResult = amount * simulatedRate;
      
      document.getElementById('indian-result').innerHTML = `
        <strong>${amount} ${from} â‰ˆ â‚¹ ${simulatedResult.toFixed(2)} (Simulated)</strong>
        <div class="small">Rate: 1 ${from} â‰ˆ ${simulatedRate.toFixed(2)} INR</div>
        <div class="small">Note: Using simulated rate as API is unavailable</div>
      `;
    }
  } catch (error) {
    console.error('Error converting Indian currency:', error);
    
    // Fallback simulation
    const simulatedRate = from === 'USD' ? 83.45 : from === 'EUR' ? 89.23 : 104.67;
    const simulatedResult = amount * simulatedRate;
    
    document.getElementById('indian-result').innerHTML = `
      <strong>${amount} ${from} â‰ˆ â‚¹ ${simulatedResult.toFixed(2)} (Simulated)</strong>
      <div class="small">Rate: 1 ${from} â‰ˆ ${simulatedRate.toFixed(2)} INR</div>
      <div class="small">Network error - showing simulated rate</div>
    `;
  }
}

/* ------------------ Gold Investment Calculator ------------------ */
function calculateGoldInvestment() {
  const investment = parseFloat(document.getElementById('gold-investment').value);
  const period = parseInt(document.getElementById('gold-period').value);
  
  if (investment > 0 && period > 0) {
    // Historical gold returns in India ~10-12% annually
    const annualReturnRate = 0.11; // 11% average
    const futureValue = investment * Math.pow(1 + annualReturnRate, period);
    const profit = futureValue - investment;
    const profitPercentage = (profit / investment) * 100;
    
    // Calculate with inflation (assuming 6% inflation)
    const inflationRate = 0.06;
    const realValue = futureValue / Math.pow(1 + inflationRate, period);
    
    const result = document.getElementById('gold-investment-result');
    result.innerHTML = `
      <strong>Investment Summary (${period} years)</strong>
      <div class="small">Initial Investment: â‚¹${investment.toLocaleString('en-IN')}</div>
      <div class="small">Future Value: â‚¹${futureValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Total Profit: â‚¹${profit.toLocaleString('en-IN', { maximumFractionDigits: 0 })} (${profitPercentage.toFixed(1)}%)</div>
      <div class="small">Real Value (adjusted for inflation): â‚¹${realValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Average Annual Return: ~11%</div>
    `;
    
    addToHistory(`Gold Investment: â‚¹${investment.toLocaleString('en-IN')} for ${period} years`, `Future Value: â‚¹${futureValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}`);
  } else {
    document.getElementById('gold-investment-result').textContent = 'Please enter valid investment amount and period';
  }
}

/* ------------------ Indian Tax Calculator ------------------ */
function calcIndianTax() {
  const income = parseFloat(document.getElementById('tax-income').value);
  const regime = document.getElementById('tax-regime').value;
  const age = parseInt(document.getElementById('tax-age').value);
  const filingType = document.getElementById('tax-filing').value;
  
  if (income >= 0) {
    let tax = 0;
    let brackets;
    
    // Select appropriate tax brackets
    if (regime === 'new') {
      brackets = indianTaxBracketsNew;
    } else {
      brackets = indianTaxBracketsOld;
    }
    
    // Calculate tax
    let remainingIncome = income;
    
    for (let i = 0; i < brackets.length; i++) {
      const bracket = brackets[i];
      const taxableInBracket = Math.min(remainingIncome, bracket.max - bracket.min);
      
      if (taxableInBracket > 0) {
        tax += taxableInBracket * (bracket.rate / 100);
        remainingIncome -= taxableInBracket;
      }
      
      if (remainingIncome <= 0) break;
    }
    
    // Apply senior citizen benefits for old regime
    if (regime === 'old') {
      if (filingType === 'senior' && age >= 60) {
        tax = tax * 0.8; // 20% reduction for seniors
      } else if (filingType === 'super-senior' && age >= 80) {
        tax = tax * 0.7; // 30% reduction for super seniors
      }
    }
    
    // Add cess (4% of tax)
    const cess = tax * 0.04;
    const totalTax = tax + cess;
    
    const effectiveRate = (totalTax / income) * 100;
    const netIncome = income - totalTax;
    const monthlyTakeHome = netIncome / 12;
    
    const result = document.getElementById('tax-result');
    result.innerHTML = `
      <strong>Tax Liability: â‚¹${totalTax.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</strong>
      <div class="small">Tax: â‚¹${tax.toLocaleString('en-IN', { maximumFractionDigits: 0 })} + Cess (4%): â‚¹${cess.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Effective Tax Rate: ${effectiveRate.toFixed(2)}%</div>
      <div class="small">Net Annual Income: â‚¹${netIncome.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Monthly Take-home: â‚¹${monthlyTakeHome.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Regime: ${regime === 'new' ? 'New (2024-25)' : 'Old'} | Category: ${filingType}</div>
    `;
    
    addToHistory(`Indian Tax: â‚¹${income.toLocaleString('en-IN')} (${regime} regime)`, `Tax: â‚¹${totalTax.toLocaleString('en-IN')}`);
  } else {
    document.getElementById('tax-result').textContent = 'Please enter valid income';
  }
}

/* ------------------ Indian Loan Functions ------------------ */
function setLoanType(type) {
  const rate = indianLoanRates[type];
  document.getElementById('loan-r').value = rate;
  
  // Set appropriate loan amounts
  if (type === 'home') {
    document.getElementById('loan-p').value = '5000000';
    document.getElementById('loan-n').value = '20';
  } else if (type === 'car') {
    document.getElementById('loan-p').value = '1000000';
    document.getElementById('loan-n').value = '7';
  } else if (type === 'personal') {
    document.getElementById('loan-p').value = '500000';
    document.getElementById('loan-n').value = '5';
  } else if (type === 'education') {
    document.getElementById('loan-p').value = '2000000';
    document.getElementById('loan-n').value = '10';
  }
  
  alert(`${type.charAt(0).toUpperCase() + type.slice(1)} loan parameters set (${rate}% interest)`);
}

/* ------------------ Indian Units Converter ------------------ */
function setIndianUnit(unit) {
  const unitData = indianUnits[unit];
  let conversionText = '';
  
  if (unit === 'bigha' || unit === 'acre') {
    document.getElementById('measure-type').value = 'area';
    document.getElementById('measure-from').value = 'Hectare';
    document.getElementById('measure-to').value = unit.charAt(0).toUpperCase() + unit.slice(1);
    document.getElementById('measure-value').value = '1';
    conversionText = `1 ${unit} = ${unitData.toHectare} Hectare`;
  } else if (unit === 'ser' || unit === 'pound') {
    document.getElementById('measure-type').value = 'weight';
    document.getElementById('measure-from').value = 'Kilogram';
    document.getElementById('measure-to').value = unit.charAt(0).toUpperCase() + unit.slice(1);
    document.getElementById('measure-value').value = '1';
    conversionText = `1 ${unit} = ${unitData.toKg} kg`;
  } else if (unit === 'tola') {
    document.getElementById('measure-type').value = 'weight';
    document.getElementById('measure-from').value = 'Gram';
    document.getElementById('measure-to').value = 'Tola';
    document.getElementById('measure-value').value = '1';
    conversionText = `1 tola = ${unitData.toGram} grams`;
  }
  
  populateUnits();
  convertMeasure();
  alert(conversionText);
}

/* ------------------ Standard Calculator ------------------ */
let stdExpression = '0';

function stdAppend(value) {
  if (stdExpression === '0' && value !== '.') {
    stdExpression = value;
  } else {
    stdExpression += value;
  }
  elements.stdDisplay.value = stdExpression;
}

function stdClear() {
  stdExpression = '0';
  elements.stdDisplay.value = stdExpression;
}

function stdBack() {
  if (stdExpression.length > 1) {
    stdExpression = stdExpression.slice(0, -1);
  } else {
    stdExpression = '0';
  }
  elements.stdDisplay.value = stdExpression;
}

function stdCalculate() {
  try {
    let calcExpression = stdExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    
    if (calcExpression.includes('%')) {
      const parts = calcExpression.split(/([-+*/])/);
      if (parts.length === 3) {
        const num = parseFloat(parts[0]);
        const operator = parts[1];
        const percent = parseFloat(parts[2]);
        
        if (operator === '+' || operator === '-') {
          const percentageValue = num * (percent / 100);
          calcExpression = operator === '+' ? 
            `${num} + ${percentageValue}` : 
            `${num} - ${percentageValue}`;
        } else if (operator === '*' || operator === '/') {
          calcExpression = `${num} ${operator} ${percent / 100}`;
        }
      }
    }
    
    const result = eval(calcExpression);
    elements.stdDisplay.value = result;
    stdExpression = result.toString();
    
    addToHistory(stdExpression, result);
  } catch (error) {
    elements.stdDisplay.value = 'Error';
    stdExpression = '0';
  }
}

/* ------------------ Scientific Calculator ------------------ */
let sciExpression = '0';

function sciAppend(value) {
  if (sciExpression === '0' && value !== '.') {
    sciExpression = value;
  } else {
    sciExpression += value;
  }
  elements.sciDisplay.value = sciExpression;
}

function sciClear() {
  sciExpression = '0';
  elements.sciDisplay.value = sciExpression;
}

function sciBack() {
  if (sciExpression.length > 1) {
    sciExpression = sciExpression.slice(0, -1);
  } else {
    sciExpression = '0';
  }
  elements.sciDisplay.value = sciExpression;
}

function sciFunc(func) {
  let value = parseFloat(sciExpression);
  let result;
  
  switch(func) {
    case 'sin':
      result = Math.sin(value * Math.PI / 180);
      break;
    case 'cos':
      result = Math.cos(value * Math.PI / 180);
      break;
    case 'tan':
      result = Math.tan(value * Math.PI / 180);
      break;
    case 'sqrt':
      result = Math.sqrt(value);
      break;
    case 'log':
      result = Math.log10(value);
      break;
    case 'ln':
      result = Math.log(value);
      break;
  }
  
  sciExpression = result.toString();
  elements.sciDisplay.value = sciExpression;
  addToHistory(`${func}(${value})`, result);
}

function sciFact() {
  let num = parseInt(sciExpression);
  if (num < 0) return;
  
  let result = 1;
  for (let i = 2; i <= num; i++) {
    result *= i;
  }
  
  sciExpression = result.toString();
  elements.sciDisplay.value = sciExpression;
  addToHistory(`${num}!`, result);
}

function sciCalculate() {
  try {
    let calcExpression = sciExpression
      .replace(/Ã—/g, '*')
      .replace(/Ã·/g, '/')
      .replace(/Ï€/g, 'Math.PI')
      .replace(/e/g, 'Math.E');
    
    const result = eval(calcExpression);
    elements.sciDisplay.value = result;
    sciExpression = result.toString();
    
    addToHistory(sciExpression, result);
  } catch (error) {
    elements.sciDisplay.value = 'Error';
    sciExpression = '0';
  }
}

/* ------------------ Live Data Functions ------------------ */
async function refreshLiveData() {
  try {
    // Update timestamp
    const now = new Date();
    document.getElementById('live-updated').textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    
    // If India is selected, update Indian market data
    if (currentCountry === 'IN') {
      refreshIndianMarketData();
    }
    
    // Fetch currency rates
    const currencyResponse = await fetch(`${API.LATEST}?base=USD&symbols=${countryCurrency},EUR`);
    const currencyData = await currencyResponse.json();
    
    if (currencyData.success) {
      document.getElementById('usd-local').textContent = 
        `${countryCurrencySymbol}${currencyData.rates[countryCurrency].toFixed(2)}`;
      document.getElementById('eur-usd').textContent = 
        `${(1 / currencyData.rates.EUR).toFixed(4)}`;
    }
    
    // Fetch cryptocurrency prices
    const cryptoResponse = await fetch(
      `${API.COINGECKO_SIMPLE}?ids=bitcoin,ethereum&vs_currencies=usd`
    );
    const cryptoData = await cryptoResponse.json();
    
    if (cryptoData.bitcoin && cryptoData.ethereum) {
      document.getElementById('btc').textContent = 
        `$${cryptoData.bitcoin.usd.toLocaleString()}`;
      document.getElementById('eth').textContent = 
        `$${cryptoData.ethereum.usd.toLocaleString()}`;
    }
  } catch (error) {
    console.error('Error fetching live data:', error);
    
    // Use simulated data if API fails
    if (currentCountry === 'IN') {
      updateIndianMarketDisplay();
    }
  }
}

function startAutoRefresh() {
  if (autoRefresh) {
    refreshLiveData();
    autoRefreshInterval = setInterval(refreshLiveData, 60000);
  }
}

function toggleAuto() {
  autoRefresh = !autoRefresh;
  document.getElementById('auto-status').textContent = autoRefresh ? 'ON' : 'OFF';
  
  if (autoRefresh) {
    startAutoRefresh();
  } else {
    clearInterval(autoRefreshInterval);
  }
}

function updateLocalTime() {
  const now = new Date();
  const options = { timeZone: countryTimeZone };
  
  document.getElementById('local-time').textContent = now.toLocaleTimeString('en-US', options);
  document.getElementById('local-date').textContent = now.toLocaleDateString('en-US', {
    ...options,
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

/* ------------------ Measurement Functions ------------------ */
function populateUnits() {
  const type = document.getElementById('measure-type').value;
  const fromSelect = document.getElementById('measure-from');
  const toSelect = document.getElementById('measure-to');
  
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';
  
  let units = [];
  
  switch(type) {
    case 'length':
      units = ['Meter', 'Kilometer', 'Centimeter', 'Millimeter', 'Mile', 'Yard', 'Foot', 'Inch'];
      break;
    case 'weight':
      units = ['Kilogram', 'Gram', 'Milligram', 'Pound', 'Ounce', 'Ton', 'Tola', 'Ser'];
      break;
    case 'temperature':
      units = ['Celsius', 'Fahrenheit', 'Kelvin'];
      break;
    case 'area':
      units = ['Square Meter', 'Square Kilometer', 'Square Foot', 'Acre', 'Hectare', 'Bigha'];
      break;
    case 'volume':
      units = ['Liter', 'Milliliter', 'Cubic Meter', 'Gallon', 'Cubic Foot'];
      break;
  }
  
  units.forEach(unit => {
    const fromOption = document.createElement('option');
    fromOption.value = unit;
    fromOption.textContent = unit;
    
    const toOption = fromOption.cloneNode(true);
    
    fromSelect.appendChild(fromOption);
    toSelect.appendChild(toOption);
  });
  
  // Set default values
  if (type === 'temperature') {
    fromSelect.value = 'Celsius';
    toSelect.value = 'Fahrenheit';
  } else {
    fromSelect.value = units[0];
    toSelect.value = units[1];
  }
}

function convertMeasure() {
  const value = parseFloat(document.getElementById('measure-value').value);
  const fromUnit = document.getElementById('measure-from').value;
  const toUnit = document.getElementById('measure-to').value;
  const type = document.getElementById('measure-type').value;
  
  let result;
  
  switch(type) {
    case 'length':
      result = convertLength(value, fromUnit, toUnit);
      break;
    case 'weight':
      result = convertWeight(value, fromUnit, toUnit);
      break;
    case 'temperature':
      result = convertTemperature(value, fromUnit, toUnit);
      break;
    case 'area':
      result = convertArea(value, fromUnit, toUnit);
      break;
    case 'volume':
      result = convertVolume(value, fromUnit, toUnit);
      break;
  }
  
  document.getElementById('measure-result').innerHTML = `
    <strong>${value} ${fromUnit} = ${result.toFixed(6)} ${toUnit}</strong>
  `;
  
  addToHistory(`${value} ${fromUnit} to ${toUnit}`, `${result.toFixed(4)} ${toUnit}`);
}

function convertLength(value, fromUnit, toUnit) {
  let meters;
  
  switch(fromUnit) {
    case 'Kilometer': meters = value * 1000; break;
    case 'Meter': meters = value; break;
    case 'Centimeter': meters = value / 100; break;
    case 'Millimeter': meters = value / 1000; break;
    case 'Mile': meters = value * 1609.34; break;
    case 'Yard': meters = value * 0.9144; break;
    case 'Foot': meters = value * 0.3048; break;
    case 'Inch': meters = value * 0.0254; break;
  }
  
  switch(toUnit) {
    case 'Kilometer': return meters / 1000;
    case 'Meter': return meters;
    case 'Centimeter': return meters * 100;
    case 'Millimeter': return meters * 1000;
    case 'Mile': return meters / 1609.34;
    case 'Yard': return meters / 0.9144;
    case 'Foot': return meters / 0.3048;
    case 'Inch': return meters / 0.0254;
  }
}

function convertWeight(value, fromUnit, toUnit) {
  let kilograms;
  
  switch(fromUnit) {
    case 'Kilogram': kilograms = value; break;
    case 'Gram': kilograms = value / 1000; break;
    case 'Milligram': kilograms = value / 1000000; break;
    case 'Pound': kilograms = value * 0.453592; break;
    case 'Ounce': kilograms = value * 0.0283495; break;
    case 'Ton': kilograms = value * 1000; break;
    case 'Tola': kilograms = value * 0.01166; break;
    case 'Ser': kilograms = value * 0.933; break;
  }
  
  switch(toUnit) {
    case 'Kilogram': return kilograms;
    case 'Gram': return kilograms * 1000;
    case 'Milligram': return kilograms * 1000000;
    case 'Pound': return kilograms / 0.453592;
    case 'Ounce': return kilograms / 0.0283495;
    case 'Ton': return kilograms / 1000;
    case 'Tola': return kilograms / 0.01166;
    case 'Ser': return kilograms / 0.933;
  }
}

function convertTemperature(value, fromUnit, toUnit) {
  let celsius;
  
  switch(fromUnit) {
    case 'Celsius': celsius = value; break;
    case 'Fahrenheit': celsius = (value - 32) * 5/9; break;
    case 'Kelvin': celsius = value - 273.15; break;
  }
  
  switch(toUnit) {
    case 'Celsius': return celsius;
    case 'Fahrenheit': return (celsius * 9/5) + 32;
    case 'Kelvin': return celsius + 273.15;
  }
}

function convertArea(value, fromUnit, toUnit) {
  let sqMeters;
  
  switch(fromUnit) {
    case 'Square Meter': sqMeters = value; break;
    case 'Square Kilometer': sqMeters = value * 1000000; break;
    case 'Square Foot': sqMeters = value * 0.092903; break;
    case 'Acre': sqMeters = value * 4046.86; break;
    case 'Hectare': sqMeters = value * 10000; break;
    case 'Bigha': sqMeters = value * 2500; break; // Approximate
  }
  
  switch(toUnit) {
    case 'Square Meter': return sqMeters;
    case 'Square Kilometer': return sqMeters / 1000000;
    case 'Square Foot': return sqMeters / 0.092903;
    case 'Acre': return sqMeters / 4046.86;
    case 'Hectare': return sqMeters / 10000;
    case 'Bigha': return sqMeters / 2500;
  }
}

function convertVolume(value, fromUnit, toUnit) {
  let liters;
  
  switch(fromUnit) {
    case 'Liter': liters = value; break;
    case 'Milliliter': liters = value / 1000; break;
    case 'Cubic Meter': liters = value * 1000; break;
    case 'Gallon': liters = value * 3.78541; break;
    case 'Cubic Foot': liters = value * 28.3168; break;
  }
  
  switch(toUnit) {
    case 'Liter': return liters;
    case 'Milliliter': return liters * 1000;
    case 'Cubic Meter': return liters / 1000;
    case 'Gallon': return liters / 3.78541;
    case 'Cubic Foot': return liters / 28.3168;
  }
}

function resetMeasure() {
  document.getElementById('measure-value').value = '1';
  populateUnits();
  document.getElementById('measure-result').textContent = 'Conversion';
}

/* ------------------ BMI Calculator ------------------ */
function calcBMI() {
  const height = parseFloat(document.getElementById('bmi-height').value) / 100;
  const weight = parseFloat(document.getElementById('bmi-weight').value);
  
  if (height > 0 && weight > 0) {
    const bmi = weight / (height * height);
    let category;
    
    if (bmi < 18.5) category = 'Underweight';
    else if (bmi < 25) category = 'Normal weight';
    else if (bmi < 30) category = 'Overweight';
    else category = 'Obesity';
    
    document.getElementById('bmi-result').innerHTML = `
      <strong>BMI: ${bmi.toFixed(1)}</strong>
      <div class="small">Category: ${category}</div>
    `;
    
    addToHistory('BMI Calculation', `${bmi.toFixed(1)} (${category})`);
  } else {
    document.getElementById('bmi-result').textContent = 'Please enter valid values';
  }
}

function clearBMI() {
  document.getElementById('bmi-height').value = '170';
  document.getElementById('bmi-weight').value = '70';
  document.getElementById('bmi-result').textContent = 'BMI result';
}

/* ------------------ Discount Calculator ------------------ */
function calcDiscount() {
  const price = parseFloat(document.getElementById('discount-price').value);
  const discount = parseFloat(document.getElementById('discount-percent').value);
  
  if (price > 0 && discount >= 0) {
    const discountAmount = price * (discount / 100);
    const finalPrice = price - discountAmount;
    const savedPercentage = (discountAmount / price) * 100;
    
    document.getElementById('discount-result').innerHTML = `
      <strong>Final Price: ${countryCurrencySymbol}${finalPrice.toFixed(2)}</strong>
      <div class="small">You save: ${countryCurrencySymbol}${discountAmount.toFixed(2)} (${discount}%)</div>
      <div class="small">Total Savings: ${savedPercentage.toFixed(1)}%</div>
    `;
    
    addToHistory('Discount Calculation', `${countryCurrencySymbol}${finalPrice.toFixed(2)} (Saved ${countryCurrencySymbol}${discountAmount.toFixed(2)})`);
  } else {
    document.getElementById('discount-result').textContent = 'Please enter valid values';
  }
}

function clearDiscount() {
  document.getElementById('discount-price').value = '1000';
  document.getElementById('discount-percent').value = '20';
  document.getElementById('discount-result').textContent = 'Discount result';
}

/* ------------------ Tip Calculator ------------------ */
function calcTip() {
  const amount = parseFloat(document.getElementById('tip-amount').value);
  const tipPercent = parseFloat(document.getElementById('tip-percent').value);
  const people = parseInt(document.getElementById('tip-people').value);
  
  if (amount > 0 && tipPercent >= 0 && people > 0) {
    const tipAmount = amount * (tipPercent / 100);
    const totalAmount = amount + tipAmount;
    const perPerson = totalAmount / people;
    
    document.getElementById('tip-result').innerHTML = `
      <strong>Total: ${countryCurrencySymbol}${totalAmount.toFixed(2)}</strong>
      <div class="small">Tip: ${countryCurrencySymbol}${tipAmount.toFixed(2)} (${tipPercent}%)</div>
      <div class="small">Each person pays: ${countryCurrencySymbol}${perPerson.toFixed(2)}</div>
    `;
    
    addToHistory('Tip Calculation', `${countryCurrencySymbol}${totalAmount.toFixed(2)} (Tip: ${countryCurrencySymbol}${tipAmount.toFixed(2)})`);
  } else {
    document.getElementById('tip-result').textContent = 'Please enter valid values';
  }
}

/* ------------------ Loan Calculator ------------------ */
function calcLoan() {
  const principal = parseFloat(document.getElementById('loan-p').value);
  const rate = parseFloat(document.getElementById('loan-r').value) / 100 / 12;
  const periods = parseInt(document.getElementById('loan-n').value) * 12;
  
  if (principal > 0 && rate > 0 && periods > 0) {
    const emi = principal * rate * Math.pow(1 + rate, periods) / (Math.pow(1 + rate, periods) - 1);
    const totalPayment = emi * periods;
    const totalInterest = totalPayment - principal;
    const interestPercentage = (totalInterest / principal) * 100;
    
    document.getElementById('loan-result').innerHTML = `
      <strong>EMI: ${countryCurrencySymbol}${emi.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</strong>
      <div class="small">Total Payment: ${countryCurrencySymbol}${totalPayment.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</div>
      <div class="small">Total Interest: ${countryCurrencySymbol}${totalInterest.toLocaleString('en-IN', { maximumFractionDigits: 0 })} (${interestPercentage.toFixed(1)}%)</div>
      <div class="small">Loan Tenure: ${document.getElementById('loan-n').value} years (${periods} months)</div>
    `;
    
    addToHistory('Loan Calculation', `EMI: ${countryCurrencySymbol}${emi.toLocaleString('en-IN')}/month`);
  } else {
    document.getElementById('loan-result').textContent = 'Please enter valid values';
  }
}

function clearLoan() {
  document.getElementById('loan-p').value = '1000000';
  document.getElementById('loan-r').value = '8.5';
  document.getElementById('loan-n').value = '20';
  document.getElementById('loan-result').textContent = 'EMI result will appear here';
}

/* ------------------ Tax Calculator ------------------ */
function calcTax() {
  // This is now handled by calcIndianTax for India
  if (currentCountry === 'IN') {
    calcIndianTax();
  } else {
    // Original tax calculation for other countries
    const income = parseFloat(document.getElementById('tax-income').value);
    const country = currentCountry;
    
    if (income >= 0) {
      // Use existing tax calculation logic for non-India countries
      alert('Please use the Indian tax calculator for detailed Indian tax calculation');
    }
  }
}

function clearTax() {
  document.getElementById('tax-income').value = '1000000';
  document.getElementById('tax-regime').value = 'new';
  document.getElementById('tax-age').value = '30';
  document.getElementById('tax-filing').value = 'individual';
  document.getElementById('tax-result').textContent = 'Tax result will appear here';
}

/* ------------------ Date Calculator ------------------ */
function calcAge() {
  const dob = new Date(document.getElementById('dob').value);
  const today = new Date();
  
  if (dob && dob <= today) {
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    
    document.getElementById('age-result').innerHTML = `
      <strong>Age: ${age} years</strong>
      <div class="small">Born: ${dob.toLocaleDateString('en-IN')}</div>
    `;
    
    addToHistory('Age Calculation', `${age} years`);
  } else {
    document.getElementById('age-result').textContent = 'Please enter a valid date of birth';
  }
}

function clearAge() {
  document.getElementById('dob').value = '';
  document.getElementById('age-result').textContent = 'Age result';
}

function daysBetween() {
  const start = new Date(document.getElementById('start-date').value);
  const end = new Date(document.getElementById('end-date').value);
  
  if (start && end) {
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    document.getElementById('date-diff-result').innerHTML = `
      <strong>Difference: ${diffDays} days</strong>
      <div class="small">From: ${start.toLocaleDateString('en-IN')} to ${end.toLocaleDateString('en-IN')}</div>
    `;
    
    addToHistory('Days Between', `${diffDays} days`);
  } else {
    document.getElementById('date-diff-result').textContent = 'Please select both dates';
  }
}

function clearDates() {
  document.getElementById('start-date').value = '';
  document.getElementById('end-date').value = '';
  document.getElementById('date-diff-result').textContent = 'Days difference';
}

function addDays() {
  const baseDate = new Date(document.getElementById('base-date').value);
  const days = parseInt(document.getElementById('days-add').value);
  
  if (baseDate && !isNaN(days)) {
    const resultDate = new Date(baseDate);
    resultDate.setDate(resultDate.getDate() + days);
    
    document.getElementById('add-days-result').innerHTML = `
      <strong>Result: ${resultDate.toLocaleDateString('en-IN')}</strong>
      <div class="small">${days} days ${days >= 0 ? 'after' : 'before'} ${baseDate.toLocaleDateString('en-IN')}</div>
    `;
    
    addToHistory('Date Calculation', resultDate.toLocaleDateString('en-IN'));
  } else {
    document.getElementById('add-days-result').textContent = 'Please enter valid values';
  }
}

function clearAddDays() {
  document.getElementById('base-date').value = '';
  document.getElementById('days-add').value = '0';
  document.getElementById('add-days-result').textContent = 'Add/Sub result';
}

/* ------------------ Mileage Tracker ------------------ */
async function loadMileageRecords() {
  try {
    if (db) {
      const querySnapshot = await getDocs(query(collection(db, 'mileage'), orderBy('date', 'desc')));
      mileageRecords = [];
      
      querySnapshot.forEach(doc => {
        mileageRecords.push({ id: doc.id, ...doc.data() });
      });
    } else {
      const stored = localStorage.getItem('mileageRecords');
      mileageRecords = stored ? JSON.parse(stored) : [];
    }
    
    updateMileageTable();
    updateMileageSummary();
  } catch (error) {
    console.error('Error loading mileage records:', error);
    
    const stored = localStorage.getItem('mileageRecords');
    mileageRecords = stored ? JSON.parse(stored) : [];
    updateMileageTable();
    updateMileageSummary();
  }
}

async function addMileage() {
  const vehicle = document.getElementById('vehicle').value;
  const odo = parseFloat(document.getElementById('odo').value);
  const fuel = parseFloat(document.getElementById('fuel').value);
  const cost = parseFloat(document.getElementById('cost').value);
  const date = document.getElementById('mdate').value || new Date().toISOString().split('T')[0];
  
  if (!vehicle || isNaN(odo) || isNaN(fuel) || isNaN(cost) || fuel <= 0) {
    alert('Please fill all fields with valid values');
    return;
  }
  
  const mileage = odo / fuel;
  
  const record = {
    vehicle,
    odo,
    fuel,
    cost,
    date,
    mileage: mileage.toFixed(2)
  };
  
  try {
    if (db) {
      const docRef = await addDoc(collection(db, 'mileage'), record);
      record.id = docRef.id;
    }
    
    mileageRecords.unshift(record);
    localStorage.setItem('mileageRecords', JSON.stringify(mileageRecords));
    
    updateMileageTable();
    updateMileageSummary();
    clearMileageForm();
    
    addToHistory('Mileage Added', `${mileage.toFixed(2)} km/L`);
  } catch (error) {
    console.error('Error adding mileage record:', error);
    alert('Failed to save record. Please try again.');
  }
}

function updateMileageTable() {
  const tbody = document.querySelector('#mileage-table tbody');
  tbody.innerHTML = '';
  
  mileageRecords.forEach(record => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${record.date}</td>
      <td>${record.vehicle}</td>
      <td>${record.odo}</td>
      <td>${record.fuel}L</td>
      <td>${countryCurrencySymbol}${record.cost}</td>
      <td>${record.mileage} km/L</td>
      <td><span class="delete" onclick="deleteMileage('${record.id || record.date}')"><i class="fas fa-trash"></i></span></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateMileageSummary() {
  const summary = document.getElementById('mileage-summary');
  
  if (mileageRecords.length === 0) {
    summary.textContent = 'No records yet';
    return;
  }
  
  const totalFuel = mileageRecords.reduce((sum, record) => sum + record.fuel, 0);
  const totalCost = mileageRecords.reduce((sum, record) => sum + record.cost, 0);
  const avgMileage = mileageRecords.reduce((sum, record) => sum + parseFloat(record.mileage), 0) / mileageRecords.length;
  const avgCostPerKm = totalCost / mileageRecords.reduce((sum, record) => sum + record.odo, 0);
  const totalDistance = mileageRecords.reduce((sum, record) => sum + record.odo, 0);
  
  summary.innerHTML = `
    <strong>Summary: ${mileageRecords.length} records</strong>
    <div class="small">Total Distance: ${totalDistance.toFixed(0)} km</div>
    <div class="small">Avg. Mileage: ${avgMileage.toFixed(2)} km/L</div>
    <div class="small">Total Fuel: ${totalFuel.toFixed(2)}L | Total Cost: ${countryCurrencySymbol}${totalCost.toFixed(2)}</div>
    <div class="small">Cost per km: ${countryCurrencySymbol}${avgCostPerKm.toFixed(2)}</div>
  `;
}

function clearMileageForm() {
  document.getElementById('vehicle').value = '';
  document.getElementById('odo').value = '';
  document.getElementById('fuel').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('mdate').value = new Date().toISOString().split('T')[0];
}

async function deleteMileage(id) {
  if (confirm('Are you sure you want to delete this record?')) {
    try {
      if (db) {
        await deleteDoc(doc(db, 'mileage', id));
      }
      
      mileageRecords = mileageRecords.filter(record => 
        record.id !== id && record.date !== id
      );
      
      localStorage.setItem('mileageRecords', JSON.stringify(mileageRecords));
      
      updateMileageTable();
      updateMileageSummary();
    } catch (error) {
      console.error('Error deleting mileage record:', error);
      alert('Failed to delete record. Please try again.');
    }
  }
}

function exportMileageCSV() {
  if (mileageRecords.length === 0) {
    alert('No records to export');
    return;
  }
  
  let csv = 'Date,Vehicle,Odometer (km),Fuel (L),Cost (â‚¹),Mileage (km/L)\n';
  
  mileageRecords.forEach(record => {
    csv += `${record.date},${record.vehicle},${record.odo},${record.fuel},${record.cost},${record.mileage}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  a.href = url;
  a.download = `mileage-export-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function clearMileageStorage() {
  if (confirm('Are you sure you want to clear all mileage records? This cannot be undone.')) {
    mileageRecords = [];
    localStorage.removeItem('mileageRecords');
    updateMileageTable();
    updateMileageSummary();
  }
}

/* ------------------ Quick Converter ------------------ */
function fillQuick() {
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  const amount = document.getElementById('cur-amount').value;
  
  document.getElementById('quick-from').value = from;
  document.getElementById('quick-to').value = to;
  document.getElementById('quick-amt').value = amount;
}

async function quickConvert() {
  const amount = document.getElementById('quick-amt').value;
  const from = document.getElementById('quick-from').value;
  const to = document.getElementById('quick-to').value;
  
  try {
    const response = await fetch(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('quick-result').innerHTML = `
        <strong>${amount} ${from} = ${data.result.toFixed(2)} ${to}</strong>
        <div class="small">Rate: 1 ${from} = ${data.info.rate.toFixed(6)} ${to}</div>
      `;
    } else {
      document.getElementById('quick-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (error) {
    console.error('Error converting currency:', error);
    document.getElementById('quick-result').textContent = 'Network error. Please check your connection.';
  }
}

/* ------------------ History Functions ------------------ */
function addToHistory(calculation, result) {
  historyItems.unshift({
    calculation,
    result,
    timestamp: new Date().toLocaleString('en-IN')
  });
  
  if (historyItems.length > 50) {
    historyItems.pop();
  }
  
  localStorage.setItem('calcHistory', JSON.stringify(historyItems));
  updateHistoryDisplay();
}

function updateHistoryDisplay() {
  const historyEl = document.getElementById('history');
  historyEl.innerHTML = '';
  
  if (historyItems.length === 0) {
    historyEl.innerHTML = '<div class="muted">No history yet</div>';
    return;
  }
  
  historyItems.forEach(item => {
    const div = document.createElement('div');
    div.style.padding = '6px 0';
    div.style.borderBottom = '1px solid #f1f5f9';
    div.innerHTML = `
      <div><strong>${item.calculation}</strong> = ${item.result}</div>
      <div class="tiny muted">${item.timestamp}</div>
    `;
    historyEl.appendChild(div);
  });
}

function copyHistory() {
  if (historyItems.length === 0) {
    alert('No history to copy');
    return;
  }
  
  let text = 'Calculation History\n';
  text += '-----------------\n';
  
  historyItems.forEach(item => {
    text += `${item.timestamp}: ${item.calculation} = ${item.result}\n`;
  });
  
  navigator.clipboard.writeText(text)
    .then(() => alert('History copied to clipboard'))
    .catch(err => console.error('Could not copy text: ', err));
}

function downloadHistory() {
  if (historyItems.length === 0) {
    alert('No history to export');
    return;
  }
  
  let csv = 'Timestamp,Calculation,Result\n';
  
  historyItems.forEach(item => {
    csv += `"${item.timestamp}","${item.calculation}","${item.result}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  
  a.href = url;
  a.download = `calculator-history-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function resetAll() {
  if (confirm('Are you sure you want to reset all data? This will clear your history and mileage records.')) {
    historyItems = [];
    mileageRecords = [];
    localStorage.removeItem('calcHistory');
    localStorage.removeItem('mileageRecords');
    updateHistoryDisplay();
    updateMileageTable();
    updateMileageSummary();
  }
}

/* ------------------ Utility Functions ------------------ */
function refreshLive() {
  refreshLiveData();
}

// Initialize measure units on page load
populateUnits();

</script>
</body>
</html>