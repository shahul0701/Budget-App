<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>All-in-One Calculator & Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root{--accent:#3498db;--good:#2ecc71;--danger:#e74c3c;--muted:#7f8c8d}
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  body{background:linear-gradient(135deg,#0f1724,#1f3758);min-height:100vh;padding:16px;display:flex;justify-content:center;align-items:flex-start}
  .app{width:100%;max-width:1200px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
  header{background:linear-gradient(90deg,var(--accent),#4ca1af);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center}
  header h1{font-size:1.1rem;display:flex;gap:10px;align-items:center}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:0;min-height:640px}
  @media(max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
  .main{padding:18px;background:#fff}
  .sidebar{background:#f6f8fb;padding:18px;border-left:1px solid #e6eef6}
  .modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:1px solid #e6eef6;cursor:pointer;font-weight:600;color:#1f2937}
  .tab.active{background:var(--accent);color:#fff}
  .panel{display:none}
  .panel.active{display:block;animation:fadeIn .25s ease}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .input, input, select, textarea, button{font-family:inherit}
  .input{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
  button.btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.btn.ghost{background:#eef5fb;color:#1f2937}
  .display{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef6;background:#f8fafc;text-align:right;font-size:1.25rem}
  .result-box{margin-top:12px;padding:12px;border-left:4px solid var(--accent);background:#f0f8ff;border-radius:8px}
  .section{margin-bottom:14px}
  .small{font-size:0.9rem;color:var(--muted)}
  .history{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef5fb}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef5fb;text-align:left;font-size:0.9rem}
  .live-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef5fb;margin-bottom:10px}
  .live-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .muted{color:var(--muted)}
  .tiny{font-size:0.85rem}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .delete{color:var(--danger);cursor:pointer}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="app" role="application">
  <header>
    <h1><i class="fas fa-calculator"></i> All-in-One Calculator & Dashboard</h1>
    <div class="small">Everything: math, science, finance, mileage, currency & live markets</div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main" aria-live="polite">
      <div class="modes" role="tablist" aria-label="Calculator modes">
        <div class="tab active" data-tab="standard">Standard</div>
        <div class="tab" data-tab="scientific">Scientific</div>
        <div class="tab" data-tab="currency">Currency (live)</div>
        <div class="tab" data-tab="mileage">Mileage</div>
        <div class="tab" data-tab="loan">Loan</div>
        <div class="tab" data-tab="tax">Tax</div>
        <div class="tab" data-tab="date">Date & Age</div>
        <div class="tab" data-tab="measure">Measurements</div>
      </div>

      <!-- Standard -->
      <section id="standard" class="panel active section" role="tabpanel">
        <div class="small">Basic arithmetic</div>
        <input id="std-display" class="display" readonly value="0" aria-label="Standard display">
        <div style="margin-top:10px" class="grid-4">
          <button class="btn ghost" onclick="stdClear()">C</button>
          <button class="btn ghost" onclick="stdBack()">⌫</button>
          <button class="btn ghost" onclick="stdAppend('%')">%</button>
          <button class="btn ghost" onclick="stdAppend('/')">/</button>

          <button class="btn" onclick="stdAppend('7')">7</button>
          <button class="btn" onclick="stdAppend('8')">8</button>
          <button class="btn" onclick="stdAppend('9')">9</button>
          <button class="btn ghost" onclick="stdAppend('*')">×</button>

          <button class="btn" onclick="stdAppend('4')">4</button>
          <button class="btn" onclick="stdAppend('5')">5</button>
          <button class="btn" onclick="stdAppend('6')">6</button>
          <button class="btn ghost" onclick="stdAppend('-')">-</button>

          <button class="btn" onclick="stdAppend('1')">1</button>
          <button class="btn" onclick="stdAppend('2')">2</button>
          <button class="btn" onclick="stdAppend('3')">3</button>
          <button class="btn ghost" onclick="stdAppend('+')">+</button>

          <button class="btn" onclick="stdAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="stdAppend('.')">.</button>
          <button class="btn" onclick="stdCalculate()">=</button>
        </div>
      </section>

      <!-- Scientific -->
      <section id="scientific" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Scientific functions (angle inputs in degrees for trig)</div>
        <input id="sci-display" class="display" readonly value="0">
        <div style="margin-top:10px" class="grid-5">
          <button class="btn ghost" onclick="sciClear()">C</button>
          <button class="btn ghost" onclick="sciBack()">⌫</button>
          <button class="btn ghost" onclick="sciAppend('(')">(</button>
          <button class="btn ghost" onclick="sciAppend(')')">)</button>
          <button class="btn ghost" onclick="sciAppend('**')">^</button>

          <button class="btn" onclick="sciFunc('sin')">sin</button>
          <button class="btn" onclick="sciFunc('cos')">cos</button>
          <button class="btn" onclick="sciFunc('tan')">tan</button>
          <button class="btn" onclick="sciFunc('sqrt')">√</button>
          <button class="btn" onclick="sciAppend('Math.PI')">π</button>

          <button class="btn" onclick="sciFunc('log')">log</button>
          <button class="btn" onclick="sciFunc('ln')">ln</button>
          <button class="btn" onclick="sciAppend('Math.E')">e</button>
          <button class="btn" onclick="sciFact()">x!</button>
          <button class="btn" onclick="sciAppend('%')">%</button>

          <button class="btn" onclick="sciAppend('7')">7</button>
          <button class="btn" onclick="sciAppend('8')">8</button>
          <button class="btn" onclick="sciAppend('9')">9</button>
          <button class="btn ghost" onclick="sciAppend('/')">/</button>
          <button class="btn ghost" onclick="sciAppend('*')">×</button>

          <button class="btn" onclick="sciAppend('4')">4</button>
          <button class="btn" onclick="sciAppend('5')">5</button>
          <button class="btn" onclick="sciAppend('6')">6</button>
          <button class="btn ghost" onclick="sciAppend('-')">-</button>
          <button class="btn ghost" onclick="sciAppend('+')">+</button>

          <button class="btn" onclick="sciAppend('1')">1</button>
          <button class="btn" onclick="sciAppend('2')">2</button>
          <button class="btn" onclick="sciAppend('3')">3</button>
          <button class="btn" onclick="sciCalculate()" style="grid-column:span 2">=</button>

          <button class="btn" onclick="sciAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="sciAppend('.')">.</button>
        </div>
      </section>

      <!-- Currency -->
      <section id="currency" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Live currency converter (rates from exchangerate.host)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="cur-amount" class="input" type="number" value="1" min="0" step="any">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="convertLive()">Convert</button>
            <button class="btn ghost" onclick="swapCur()">Swap</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="from-cur" class="input"></select>
          <select id="to-cur" class="input"></select>
        </div>

        <div class="result-box" id="cur-result">Result will appear here</div>
        <div class="small" style="margin-top:8px">You can refresh live rates in the right panel.</div>
      </section>

      <!-- Mileage -->
      <section id="mileage" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Mileage tracker — stored locally (localStorage)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="vehicle" class="input" placeholder="Vehicle name (e.g., Honda City)">
          <input id="odo" class="input" placeholder="Odometer (km)" type="number" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="fuel" class="input" placeholder="Fuel (L)" type="number" step="any">
          <input id="cost" class="input" placeholder="Fuel cost (₹)" type="number" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="mdate" class="input" type="date" style="flex:1">
          <button class="btn" onclick="addMileage()">Add</button>
          <button class="btn ghost" onclick="clearMileageForm()">Clear</button>
        </div>

        <div class="result-box" id="mileage-summary">No records yet</div>

        <h3 style="margin-top:12px">History</h3>
        <div style="overflow:auto;max-height:220px">
          <table id="mileage-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Loan -->
      <section id="loan" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Loan / EMI calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loan-p" class="input" placeholder="Principal" type="number" value="100000" step="any">
          <input id="loan-r" class="input" placeholder="Annual rate (%)" type="number" value="7.5" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="loan-n" class="input" placeholder="Years" type="number" value="5">
          <button class="btn" onclick="calcLoan()">Calculate</button>
          <button class="btn ghost" onclick="clearLoan()">Clear</button>
        </div>
        <div class="result-box" id="loan-result">Monthly EMI etc.</div>
      </section>

      <!-- Tax -->
      <section id="tax" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Tax helper — flat or simple slab demo</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tax-income" class="input" placeholder="Taxable income" type="number" value="500000">
          <input id="tax-rate" class="input" placeholder="Flat tax rate (%)" type="number" value="10">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcTax()">Flat tax</button>
          <button class="btn ghost" onclick="calcTaxSlab()">Slab demo</button>
        </div>
        <div class="result-box" id="tax-result">Tax will appear here</div>
      </section>

      <!-- Date & Age -->
      <section id="date" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">DOB → Age, Days between, Add/Subtract days</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="dob" type="date" class="input">
          <div style="display:flex;gap:8px"><button class="btn" onclick="calcAge()">Age</button><button class="btn ghost" onclick="clearAge()">Clear</button></div>
        </div>
        <div class="result-box" id="age-result">Age result</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="start-date" type="date" class="input"><input id="end-date" type="date" class="input">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="daysBetween()">Days between</button>
          <button class="btn ghost" onclick="clearDates()">Clear</button>
        </div>
        <div class="result-box" id="date-diff-result">Days difference</div>

        <hr style="margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="base-date" type="date" class="input"><input id="days-add" type="number" class="input" value="0">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addDays()">Add/Subtract</button><button class="btn ghost" onclick="clearAddDays()">Clear</button>
        </div>
        <div class="result-box" id="add-days-result">Add/Subtract result</div>
      </section>

      <!-- Measurements -->
      <section id="measure" class="panel section" role="tabpanel" aria-hidden="true">
        <div class="small">Measurement converters</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="measure-type" class="input" onchange="populateUnits()">
            <option value="length">Length</option>
            <option value="weight">Weight</option>
            <option value="temperature">Temperature</option>
          </select>
          <input id="measure-value" class="input" type="number" value="1" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="measure-from" class="input"></select>
          <select id="measure-to" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="convertMeasure()">Convert</button>
          <button class="btn ghost" onclick="resetMeasure()">Clear</button>
        </div>
        <div class="result-box" id="measure-result">Conversion result</div>
      </section>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Recent calculations</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="copyHistory()">Copy</button>
          <button class="btn ghost" onclick="downloadHistory()">Export CSV</button>
          <button class="btn" onclick="resetAll()">Reset App</button>
        </div>
      </div>
      <div style="margin-top:8px" class="history" id="history"></div>
    </main>

    <!-- SIDEBAR / LIVE PANEL -->
    <aside class="sidebar" aria-label="Live data">
      <div class="live-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Snapshot</strong>
          <div class="tiny muted" id="live-updated">--</div>
        </div>
        <div style="margin-top:8px" class="live-grid">
          <div>
            <div class="small muted">USD → INR</div>
            <div id="usd-inr" style="font-weight:800">--</div>
          </div>
          <div>
            <div class="small muted">EUR → USD</div>
            <div id="eur-usd" style="font-weight:800">--</div>
          </div>

          <div>
            <div class="small muted">Gold (XAU/oz)</div>
            <div id="gold" style="font-weight:800">--</div>
          </div>
          <div>
            <div class="small muted">Silver (XAG/oz)</div>
            <div id="silver" style="font-weight:800">--</div>
          </div>

          <div>
            <div class="small muted">Bitcoin (USD)</div>
            <div id="btc" style="font-weight:800">--</div>
          </div>
          <div>
            <div class="small muted">Ethereum (USD)</div>
            <div id="eth" style="font-weight:800">--</div>
          </div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="refreshLive()">Refresh</button>
          <button class="btn ghost" onclick="toggleAuto()">Auto: <span id="auto-status">ON</span></button>
        </div>
        <div class="tiny muted" style="margin-top:8px">Data from exchangerate.host &amp; CoinGecko (free public APIs)</div>
      </div>

      <div class="live-card">
        <strong>Quick Conversions</strong>
        <div style="margin-top:8px">
          <input id="quick-amt" class="input" value="1" type="number" step="any">
          <select id="quick-from" class="input" style="margin-top:6px"></select>
          <select id="quick-to" class="input" style="margin-top:6px"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="quickConvert()">Convert</button>
            <button class="btn ghost" onclick="fillQuickWithMain()">Use main</button>
          </div>
          <div class="result-box" id="quick-result">Quick result</div>
        </div>
      </div>

      <div class="live-card">
        <strong>Mileage Export</strong>
        <div class="small muted" style="margin-top:8px">Export or clear local mileage history</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="exportMileageCSV()">Export CSV</button>
          <button class="btn ghost" onclick="clearMileageStorage()">Clear</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
/* ----------------- Tabs ----------------- */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>{ p.classList.remove('active'); p.setAttribute('aria-hidden','true'); });
    const panel = document.getElementById(target);
    if(panel){ panel.classList.add('active'); panel.setAttribute('aria-hidden','false'); panel.focus?.(); }
  });
});

/* ----------------- History ----------------- */
const historyEl = document.getElementById('history');
function addHistory(txt){
  const d = new Date().toLocaleString();
  const item = document.createElement('div'); item.className='tiny'; item.textContent = `${d} — ${txt}`;
  historyEl.prepend(item);
  // keep 100 items
  while(historyEl.children.length>100) historyEl.removeChild(historyEl.lastChild);
}
function copyHistory(){ navigator.clipboard?.writeText(Array.from(historyEl.children).map(c=>c.textContent).join('\n')).then(()=>alert('History copied')) }
function downloadHistory(){
  const rows=[['timestamp','calculation']];
  Array.from(historyEl.children).forEach(ch=>rows.push([new Date().toISOString(), ch.textContent]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='history.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ----------------- Standard ----------------- */
let stdVal = '0';
const stdDisplay = document.getElementById('std-display');
function stdUpdate(){ stdDisplay.value = stdVal; }
function stdAppend(v){ if(stdVal==='0' && v!=='.') stdVal = v; else stdVal += v; stdUpdate(); }
function stdClear(){ stdVal='0'; stdUpdate(); }
function stdBack(){ stdVal = stdVal.length>1 ? stdVal.slice(0,-1) : '0'; stdUpdate(); }
function stdCalculate(){
  try{
    let expr = stdVal.replace(/×/g,'*').replace(/÷/g,'/');
    expr = expr.replace(/(\d+(\.\d+)?)%/g,'($1/100)');
    const res = Function('"use strict";return ('+expr+')')();
    addHistory(`${stdVal} = ${res}`);
    stdVal = String(res); stdUpdate();
  }catch(e){ stdVal='Error'; stdUpdate(); setTimeout(()=>{ stdVal='0'; stdUpdate(); },1400); }
}

/* ----------------- Scientific ----------------- */
let sciVal='0'; const sciDisplay = document.getElementById('sci-display');
function sciUpdate(){ sciDisplay.value = sciVal; }
function sciAppend(v){ if(sciVal==='0' && v!=='.') sciVal=v; else sciVal+=v; sciUpdate(); }
function sciClear(){ sciVal='0'; sciUpdate(); }
function sciBack(){ sciVal = sciVal.length>1 ? sciVal.slice(0,-1) : '0'; sciUpdate(); }
function sciCalculate(){ try{ let expr = sciVal.replace(/π/g,'Math.PI').replace(/\^/g,'**'); const res = Function('"use strict";return ('+expr+')')(); addHistory(`${sciVal} = ${res}`); sciVal=String(res); sciUpdate(); }catch(e){ sciVal='Error'; sciUpdate(); setTimeout(()=>sciVal='0',1200); } }
function sciFunc(fn){ try{ let v = parseFloat(sciVal); if(isNaN(v)) v=0; let r; switch(fn){ case 'sin': r = Math.sin(v*Math.PI/180); break; case 'cos': r = Math.cos(v*Math.PI/180); break; case 'tan': r = Math.tan(v*Math.PI/180); break; case 'sqrt': r = Math.sqrt(v); break; case 'log': r = Math.log10(v); break; case 'ln': r = Math.log(v); break; default: r=v; } addHistory(`${fn}(${v}) = ${r}`); sciVal = String(r); sciUpdate(); }catch(e){ sciVal='Error'; sciUpdate(); } }
function sciFact(){ const n = parseInt(sciVal); if(isNaN(n)||n<0){ sciVal='Error'; sciUpdate(); return; } let r=1; for(let i=2;i<=n;i++) r*=i; addHistory(`${n}! = ${r}`); sciVal=String(r); sciUpdate(); }

/* ----------------- Currency (exchangerate.host) ----------------- */
const symbolsUrl = 'https://api.exchangerate.host/symbols';
const convertUrl = 'https://api.exchangerate.host/convert';
const latestUrl = 'https://api.exchangerate.host/latest';
const fromCur = document.getElementById('from-cur'), toCur = document.getElementById('to-cur'), amountCur = document.getElementById('cur-amount');
const quickFrom = document.getElementById('quick-from'), quickTo = document.getElementById('quick-to'), quickAmt = document.getElementById('quick-amt');

async function loadCurrencySymbols(){
  try{
    const res = await fetch(symbolsUrl);
    const j = await res.json();
    if(j && j.symbols){
      const codes = Object.keys(j.symbols).sort();
      fromCur.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join('');
      toCur.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join('');
      quickFrom.innerHTML = fromCur.innerHTML; quickTo.innerHTML = toCur.innerHTML;
      fromCur.value = 'USD'; toCur.value = 'INR'; quickFrom.value='USD'; quickTo.value='INR';
    }
  }catch(e){ console.error('symbols',e); }
}
async function convertLive(){
  const a = parseFloat(amountCur.value); const from = fromCur.value; const to = toCur.value;
  if(isNaN(a)){ document.getElementById('cur-result').textContent='Enter valid amount'; return; }
  document.getElementById('cur-result').textContent='Converting...';
  try{
    const res = await fetch(`${convertUrl}?from=${from}&to=${to}&amount=${a}`);
    const j = await res.json();
    if(j && j.result !== undefined){
      document.getElementById('cur-result').innerHTML = `${a} ${from} = <strong>${Number(j.result).toFixed(4)} ${to}</strong>
        <div class="tiny muted">Rate: 1 ${from} = ${Number(j.info?.rate || (j.result/a)).toFixed(6)} ${to}</div>`;
      addHistory(`Currency: ${a} ${from} = ${Number(j.result).toFixed(4)} ${to}`);
    } else document.getElementById('cur-result').textContent='Conversion failed';
  }catch(e){ document.getElementById('cur-result').textContent='Error fetching rates'; console.error(e); }
}
function swapCur(){ const t = fromCur.value; fromCur.value = toCur.value; toCur.value = t; }
function quickConvert(){ const a = parseFloat(quickAmt.value); const f = quickFrom.value; const t = quickTo.value; if(isNaN(a)){ alert('Enter amount'); return; } fetch(`${convertUrl}?from=${f}&to=${t}&amount=${a}`).then(r=>r.json()).then(j=>{ if(j && j.result!==undefined){ document.getElementById('quick-result').innerHTML = `${a} ${f} = <strong>${Number(j.result).toFixed(4)} ${t}</strong>`; addHistory(`QuickConv: ${a} ${f} = ${Number(j.result).toFixed(4)} ${t}`); } else document.getElementById('quick-result').textContent='Conversion failed'; }).catch(e=>{ document.getElementById('quick-result').textContent='Error'; console.error(e); }); }
function fillQuickWithMain(){ quickFrom.value = fromCur.value; quickTo.value = toCur.value; quickAmt.value = amountCur.value; }

/* ----------------- Mileage (localStorage) ----------------- */
const mileageKey = 'app_mileage_records_v1';
let records = JSON.parse(localStorage.getItem(mileageKey) || '[]');
const mTableBody = document.querySelector('#mileage-table tbody');
function renderMileage(){
  mTableBody.innerHTML = '';
  if(records.length===0){ document.getElementById('mileage-summary').textContent = 'No records yet'; return; }
  records.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.vehicle}</td><td>${r.odometer}</td><td>${r.fuel}</td><td>₹${r.cost}</td><td>${r.mileage || '-'}</td>
      <td><span class="delete" onclick="deleteRecord(${i})"><i class="fas fa-trash"></i></span></td>`;
    mTableBody.appendChild(tr);
  });
  const last = records[records.length-1];
  document.getElementById('mileage-summary').innerHTML = `Latest: <strong>${last.vehicle}</strong> — ${last.mileage || '-'} km/L · Cost/km: ₹${last.costPerKm || '-'}`;
}
function addMileage(){
  const vehicle = document.getElementById('vehicle').value.trim();
  const odo = parseFloat(document.getElementById('odo').value);
  const fuel = parseFloat(document.getElementById('fuel').value);
  const cost = parseFloat(document.getElementById('cost').value);
  const date = document.getElementById('mdate').value || new Date().toISOString().slice(0,10);
  if(!vehicle || isNaN(odo) || isNaN(fuel) || isNaN(cost) || fuel<=0){ alert('Fill valid values'); return; }
  let mileage=0, costPerKm=0;
  if(records.length>0){
    const last = records[records.length-1];
    const dist = odo - Number(last.odometer);
    if(dist>0){ mileage = dist / fuel; costPerKm = cost / dist; }
  }
  const rec = {vehicle,odometer:odo,fuel,cost,date,mileage: mileage?mileage.toFixed(2):'-',costPerKm: costPerKm?costPerKm.toFixed(2):'-'};
  records.push(rec);
  localStorage.setItem(mileageKey, JSON.stringify(records));
  renderMileage();
  addHistory(`Mileage added: ${vehicle} — ${rec.mileage} km/L`);
  clearMileageForm();
}
function deleteRecord(idx){ if(!confirm('Delete this record?')) return; records.splice(idx,1); localStorage.setItem(mileageKey, JSON.stringify(records)); renderMileage(); addHistory('Mileage record deleted'); }
function clearMileageForm(){ document.getElementById('vehicle').value=''; document.getElementById('odo').value=''; document.getElementById('fuel').value=''; document.getElementById('cost').value=''; document.getElementById('mdate').value=''; }
function exportMileageCSV(){ if(records.length===0){ alert('No records'); return; } const rows=[['date','vehicle','odometer','fuel','cost','mileage','costPerKm']]; records.forEach(r=>rows.push([r.date,r.vehicle,r.odometer,r.fuel,r.cost,r.mileage,r.costPerKm])); const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mileage.csv'; a.click(); URL.revokeObjectURL(url); }
function clearMileageStorage(){ if(!confirm('Clear mileage history?')) return; records=[]; localStorage.removeItem(mileageKey); renderMileage(); addHistory('Mileage history cleared'); }

/* ----------------- Loan ----------------- */
function calcLoan(){
  const P = parseFloat(document.getElementById('loan-p').value);
  const rAnnual = parseFloat(document.getElementById('loan-r').value);
  const years = parseFloat(document.getElementById('loan-n').value);
  if(isNaN(P)||isNaN(rAnnual)||isNaN(years)||P<=0){ alert('Invalid loan input'); return; }
  const r = rAnnual/100/12; const n = years*12;
  const monthly = r===0 ? P/n : (P*r)/(1-Math.pow(1+r,-n));
  const total = monthly*n; const interest = total - P;
  document.getElementById('loan-result').innerHTML = `Monthly EMI: <strong>₹${monthly.toFixed(2)}</strong><br>Total paid: ₹${total.toFixed(2)} · Interest: ₹${interest.toFixed(2)}`;
  addHistory(`Loan: P=${P}, r=${rAnnual}% -> EMI ₹${monthly.toFixed(2)}`);
}
function clearLoan(){ document.getElementById('loan-p').value=''; document.getElementById('loan-r').value=''; document.getElementById('loan-n').value=''; document.getElementById('loan-result').textContent='Monthly EMI etc.'; }

/* ----------------- Tax ----------------- */
function calcTax(){ const income=parseFloat(document.getElementById('tax-income').value); const rate=parseFloat(document.getElementById('tax-rate').value); if(isNaN(income)||isNaN(rate)){ alert('Invalid'); return; } const tax = income*(rate/100); document.getElementById('tax-result').textContent = `Tax: ₹${tax.toFixed(2)} (${rate}%)`; addHistory(`Tax: income ${income} @ ${rate}% -> ${tax.toFixed(2)}`); }
function calcTaxSlab(){ // simple example slab
  const income = parseFloat(document.getElementById('tax-income').value) || 0;
  const slabs = [{limit:250000,rate:0},{limit:500000,rate:5},{limit:750000,rate:10},{limit:1000000,rate:15},{limit:Infinity,rate:20}];
  let remaining=income, lower=0, tax=0;
  for(const s of slabs){
    const amount = Math.max(0, Math.min(remaining, s.limit - lower));
    if(amount>0) tax += amount*(s.rate/100);
    lower = s.limit; remaining -= amount;
    if(remaining<=0) break;
  }
  document.getElementById('tax-result').textContent = `Estimated slab tax: ₹${tax.toFixed(2)} (demo)`;
  addHistory(`Tax slab estimate: income ${income} -> ${tax.toFixed(2)}`);
}

/* ----------------- Date & Age ----------------- */
function calcAge(){ const v=document.getElementById('dob').value; if(!v){ alert('Pick DOB'); return; } const b=new Date(v); const now=new Date(); if(b>now){ document.getElementById('age-result').textContent='DOB in future'; return; } let y=now.getFullYear()-b.getFullYear(); let m=now.getMonth()-b.getMonth(); let d=now.getDate()-b.getDate(); if(d<0){ m--; d += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); } if(m<0){ y--; m+=12; } document.getElementById('age-result').textContent = `${y} years, ${m} months, ${d} days`; addHistory(`Age calc for ${v}: ${y}y ${m}m ${d}d`); }
function clearAge(){ document.getElementById('dob').value=''; document.getElementById('age-result').textContent='Age result'; }
function daysBetween(){ const s=document.getElementById('start-date').value; const e=document.getElementById('end-date').value; if(!s||!e){ alert('Pick both'); return; } const a=new Date(s), b=new Date(e); const diff=Math.abs(b-a); const days=Math.floor(diff/(1000*60*60*24)); document.getElementById('date-diff-result').textContent = `${days} days`; addHistory(`Days between ${s} & ${e} = ${days}`); }
function clearDates(){ document.getElementById('start-date').value=''; document.getElementById('end-date').value=''; document.getElementById('date-diff-result').textContent='Days difference'; }
function addDays(){ const base=document.getElementById('base-date').value; const days=parseInt(document.getElementById('days-add').value,10); if(!base||isNaN(days)){ alert('Pick base date and days'); return; } const d=new Date(base); d.setDate(d.getDate()+days); document.getElementById('add-days-result').textContent = d.toISOString().slice(0,10); addHistory(`AddDays ${base} + ${days} = ${d.toISOString().slice(0,10)}`); }
function clearAddDays(){ document.getElementById('base-date').value=''; document.getElementById('days-add').value='0'; document.getElementById('add-days-result').textContent='Add/Sub result'; }

/* ----------------- Measurement ----------------- */
const measures = {
  length: {units:['m','km','cm','mm','in','ft'], conv:{m:1,km:1000,cm:0.01,mm:0.001,in:0.0254,ft:0.3048}},
  weight: {units:['kg','g','lb','oz'], conv:{kg:1,g:0.001,lb:0.45359237,oz:0.0283495}},
  temperature: {units:['C','F','K']}
};
function populateUnits(){
  const type = document.getElementById('measure-type').value;
  const from = document.getElementById('measure-from'), to = document.getElementById('measure-to');
  from.innerHTML = ''; to.innerHTML='';
  if(type==='temperature'){
    from.innerHTML = '<option>C</option><option>F</option><option>K</option>';
    to.innerHTML = from.innerHTML;
  } else {
    measures[type].units.forEach(u=>{ from.innerHTML += `<option>${u}</option>`; to.innerHTML += `<option>${u}</option>`; });
  }
}
function convertMeasure(){
  const type = document.getElementById('measure-type').value;
  const v = parseFloat(document.getElementById('measure-value').value);
  const from = document.getElementById('measure-from').value; const to = document.getElementById('measure-to').value;
  if(isNaN(v)){ alert('Enter value'); return; }
  let result = v;
  if(type==='temperature'){
    // convert from -> C -> to
    let c;
    if(from==='C') c=v;
    else if(from==='F') c = (v-32)*5/9;
    else if(from==='K') c = v-273.15;
    if(to==='C') result=c;
    else if(to==='F') result = c*9/5 + 32;
    else if(to==='K') result = c + 273.15;
  } else {
    const conv = measures[type].conv;
    result = v * conv[from] / conv[to];
  }
  document.getElementById('measure-result').textContent = `${v} ${from} = ${Number(result).toFixed(4)} ${to}`;
  addHistory(`Measure: ${v}${from} -> ${Number(result).toFixed(4)}${to}`);
}
function resetMeasure(){ document.getElementById('measure-value').value='1'; populateUnits(); document.getElementById('measure-result').textContent='Conversion result'; }

/* ----------------- Live market panel ----------------- */
let autoRefresh = true;
let autoTimer = null;
const autoStatus = document.getElementById('auto-status');
async function refreshLive(){
  document.getElementById('live-updated').textContent = 'Updating...';
  try{
    // 1) Currency snapshot USD base
    const r1 = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=INR,EUR');
    const j1 = await r1.json();
    if(j1 && j1.rates){ document.getElementById('usd-inr').textContent = '₹' + Number(j1.rates.INR).toFixed(4); document.getElementById('eur-usd').textContent = Number(1/(j1.rates.EUR||1)).toFixed(4); }
    // 2) Precious metals via CoinGecko (tether-gold = XAU approx). NOTE: CoinGecko 'tether-gold' gives price of XAUT (tokenized gold)
    const ids = 'tether-gold,bitcoin,ethereum,blockchain-com';
    // We'll call coingecko simple price for tether-gold, bitcoin, ethereum
    const cg = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether-gold,bitcoin,ethereum&vs_currencies=usd');
    const cj = await cg.json();
    if(cj){
      if(cj['tether-gold'] && cj['tether-gold'].usd) document.getElementById('gold').textContent = '$' + Number(cj['tether-gold'].usd).toFixed(2) + ' / oz (tokenized)';
      if(cj['bitcoin'] && cj['bitcoin'].usd) document.getElementById('btc').textContent = '$' + Number(cj['bitcoin'].usd).toLocaleString();
      if(cj['ethereum'] && cj['ethereum'].usd) document.getElementById('eth').textContent = '$' + Number(cj['ethereum'].usd).toLocaleString();
    }
    // silver: coingecko may not have silver, we'll approximate via 'xau' fallback (or show N/A)
    // Alternatively use exchangerate.host latest to fetch XAG? Not provided. Show N/A if missing.
    document.getElementById('silver').textContent = 'N/A';
    document.getElementById('live-updated').textContent = new Date().toLocaleTimeString();
  }catch(e){
    console.error('live refresh', e);
    document.getElementById('live-updated').textContent = 'Error';
  }
}
function toggleAuto(){ autoRefresh = !autoRefresh; autoStatus.textContent = autoRefresh ? 'ON' : 'OFF'; if(autoRefresh) startAuto(); else stopAuto(); }
function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = setInterval(()=>refreshLive(), 60_000); refreshLive(); }
function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = null; }

/* ----------------- Utilities ----------------- */
function resetAll(){ if(!confirm('Reset all data & history?')) return; localStorage.clear(); records=[]; renderMileage(); historyEl.innerHTML=''; addHistory('App reset'); }

/* ----------------- Init ----------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  loadCurrencySymbols();
  populateUnits();
  renderMileage();
  // preset quick selects (they will be filled by loadCurrencySymbols)
  refreshLive();
  startAuto();
  addHistory('App loaded');
});
</script>

</body>
</html>
