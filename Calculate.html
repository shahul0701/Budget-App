<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All-in-One Calculator & Live Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{--accent:#0ea5a4;--good:#10b981;--danger:#ef4444;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{background:linear-gradient(180deg,#0f1724,#0b1220);min-height:100vh;padding:18px;display:flex;justify-content:center;align-items:flex-start}
    .app{width:100%;max-width:1200px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
    header{background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    header h1{font-size:1.05rem;display:flex;gap:10px;align-items:center}
    .country-selector{display:flex;align-items:center;gap:8px;margin-left:auto}
    .country-selector select{padding:6px 10px;border-radius:6px;border:none;background:rgba(255,255,255,0.2);color:#fff}
    .layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:680px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
    .main{padding:18px;background:#fff}
    .sidebar{background:#f8fafc;padding:18px;border-left:1px solid #e6eef6}
    .modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:1px solid #e6eef6;cursor:pointer;font-weight:700;color:#0f1724}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .panel{display:none}
    .panel.active{display:block;animation:fadeIn .25s ease}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .input, input, select, textarea, button{font-family:inherit}
    .input{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
    button.btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.btn.ghost{background:#eef2ff;color:#0f1724;border:1px solid #e6eef6}
    .display{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef6;background:#f8fafc;text-align:right;font-size:1.25rem}
    .result-box{margin-top:12px;padding:12px;border-left:4px solid var(--accent);background:#f0f9ff;border-radius:8px}
    .section{margin-bottom:14px}
    .small{font-size:0.92rem;color:var(--muted)}
    .history{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef5fb}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef5fb;text-align:left;font-size:0.92rem}
    .live-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef5fb;margin-bottom:10px}
    .live-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .tiny{font-size:0.85rem}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .delete{color:var(--danger);cursor:pointer}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    footer{padding:10px 18px;background:#f8fafc;border-top:1px solid #eef5fb;font-size:0.9rem;color:var(--muted)}
    .note {font-size:0.85rem;color:#374151;margin-top:8px}
    .country-flag {width: 20px; height: 15px; display: inline-block; margin-right: 5px; vertical-align: middle; background-size: cover;}
  </style>
</head>
<body>

<div class="app" role="application" aria-label="All-in-One Calculator">
  <header>
    <h1><i class="fas fa-calculator"></i> All-in-One Calculator â€” Live</h1>
    <div class="country-selector">
      <i class="fas fa-globe"></i>
      <select id="country-select">
        <option value="US" data-flag="ðŸ‡ºðŸ‡¸">United States</option>
        <option value="IN" data-flag="ðŸ‡®ðŸ‡³" selected>India</option>
        <option value="GB" data-flag="ðŸ‡¬ðŸ‡§">United Kingdom</option>
        <option value="DE" data-flag="ðŸ‡©ðŸ‡ª">Germany</option>
        <option value="JP" data-flag="ðŸ‡¯ðŸ‡µ">Japan</option>
        <option value="AU" data-flag="ðŸ‡¦ðŸ‡º">Australia</option>
        <option value="CA" data-flag="ðŸ‡¨ðŸ‡¦">Canada</option>
        <option value="FR" data-flag="ðŸ‡«ðŸ‡·">France</option>
        <option value="BR" data-flag="ðŸ‡§ðŸ‡·">Brazil</option>
        <option value="CN" data-flag="ðŸ‡¨ðŸ‡³">China</option>
      </select>
    </div>
    <div class="small">Currency (live) Â· Gold Â· Crypto Â· Mileage Â· Loan Â· Tax Â· Date Â· Measure</div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main" aria-live="polite">
      <div class="modes" role="tablist">
        <div class="tab active" data-tab="standard">Standard</div>
        <div class="tab" data-tab="scientific">Scientific</div>
        <div class="tab" data-tab="currency">Currency</div>
        <div class="tab" data-tab="mileage">Mileage</div>
        <div class="tab" data-tab="loan">Loan</div>
        <div class="tab" data-tab="tax">Tax</div>
        <div class="tab" data-tab="date">Date</div>
        <div class="tab" data-tab="measure">Measure</div>
        <div class="tab" data-tab="bmi">BMI</div>
        <div class="tab" data-tab="discount">Discount</div>
        <div class="tab" data-tab="tip">Tip</div>
      </div>

      <!-- Standard -->
      <section id="standard" class="panel active section">
        <div class="small">Basic arithmetic</div>
        <input id="std-display" class="display" readonly value="0" aria-label="Standard display">
        <div style="margin-top:10px" class="grid-4">
          <button class="btn ghost" onclick="stdClear()">C</button>
          <button class="btn ghost" onclick="stdBack()">âŒ«</button>
          <button class="btn ghost" onclick="stdAppend('%')">%</button>
          <button class="btn ghost" onclick="stdAppend('/')">/</button>

          <button class="btn" onclick="stdAppend('7')">7</button>
          <button class="btn" onclick="stdAppend('8')">8</button>
          <button class="btn" onclick="stdAppend('9')">9</button>
          <button class="btn ghost" onclick="stdAppend('*')">Ã—</button>

          <button class="btn" onclick="stdAppend('4')">4</button>
          <button class="btn" onclick="stdAppend('5')">5</button>
          <button class="btn" onclick="stdAppend('6')">6</button>
          <button class="btn ghost" onclick="stdAppend('-')">-</button>

          <button class="btn" onclick="stdAppend('1')">1</button>
          <button class="btn" onclick="stdAppend('2')">2</button>
          <button class="btn" onclick="stdAppend('3')">3</button>
          <button class="btn ghost" onclick="stdAppend('+')">+</button>

          <button class="btn" onclick="stdAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="stdAppend('.')">.</button>
          <button class="btn" onclick="stdCalculate()">=</button>
        </div>
      </section>

      <!-- Scientific -->
      <section id="scientific" class="panel section" aria-hidden="true">
        <div class="small">Scientific (trig in degrees)</div>
        <input id="sci-display" class="display" readonly value="0">
        <div style="margin-top:10px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
          <button class="btn ghost" onclick="sciClear()">C</button>
          <button class="btn ghost" onclick="sciBack()">âŒ«</button>
          <button class="btn ghost" onclick="sciAppend('(')">(</button>
          <button class="btn ghost" onclick="sciAppend('')">)</button>
          <button class="btn ghost" onclick="sciAppend('**')">^</button>

          <button class="btn" onclick="sciFunc('sin')">sin</button>
          <button class="btn" onclick="sciFunc('cos')">cos</button>
          <button class="btn" onclick="sciFunc('tan')">tan</button>
          <button class="btn" onclick="sciFunc('sqrt')">âˆš</button>
          <button class="btn" onclick="sciAppend('Math.PI')">Ï€</button>

          <button class="btn" onclick="sciFunc('log')">log</button>
          <button class="btn" onclick="sciFunc('ln')">ln</button>
          <button class="btn" onclick="sciAppend('Math.E')">e</button>
          <button class="btn" onclick="sciFact()">x!</button>
          <button class="btn" onclick="sciAppend('%')">%</button>

          <button class="btn" onclick="sciAppend('7')">7</button>
          <button class="btn" onclick="sciAppend('8')">8</button>
          <button class="btn" onclick="sciAppend('9')">9</button>
          <button class="btn ghost" onclick="sciAppend('/')">/</button>
          <button class="btn ghost" onclick="sciAppend('*')">Ã—</button>

          <button class="btn" onclick="sciAppend('4')">4</button>
          <button class="btn" onclick="sciAppend('5')">5</button>
          <button class="btn" onclick="sciAppend('6')">6</button>
          <button class="btn ghost" onclick="sciAppend('-')">-</button>
          <button class="btn ghost" onclick="sciAppend('+')">+</button>

          <button class="btn" onclick="sciAppend('1')">1</button>
          <button class="btn" onclick="sciAppend('2')">2</button>
          <button class="btn" onclick="sciAppend('3')">3</button>
          <button class="btn" onclick="sciCalculate()" style="grid-column:span 2">=</button>

          <button class="btn" onclick="sciAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="sciAppend('.')">.</button>
        </div>
      </section>

      <!-- Currency -->
      <section id="currency" class="panel section" aria-hidden="true">
        <div class="small">Live currency conversion (exchangerate.host)</div>
        <div style="display:grid;grid-template-columns:1fr 180px;gap:8px;margin-top:8px">
          <input id="cur-amount" class="input" type="number" value="1" min="0" step="any">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="convertCurrency()">Convert</button>
            <button class="btn ghost" onclick="swapCurrency()">Swap</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="from-currency" class="input"></select>
          <select id="to-currency" class="input"></select>
        </div>

        <div class="result-box" id="cur-result">Result will appear here</div>
        <div class="small" style="margin-top:6px">If conversion fails, there will be a helpful error message (CORS or network)</div>
      </section>

      <!-- Mileage -->
      <section id="mileage" class="panel section" aria-hidden="true">
        <div class="small">Mileage tracker (saved to Firebase & localStorage)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="vehicle" class="input" placeholder="Vehicle name">
          <input id="odo" class="input" placeholder="Odometer (km)" type="number" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="fuel" class="input" placeholder="Fuel (L)" type="number" step="any">
          <input id="cost" class="input" placeholder="Fuel cost (â‚¹)" type="number" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="mdate" class="input" type="date" style="flex:1">
          <button class="btn" onclick="addMileage()">Add</button>
          <button class="btn ghost" onclick="clearMileageForm()">Clear</button>
        </div>

        <div class="result-box" id="mileage-summary">No records yet</div>

        <h3 style="margin-top:12px">History</h3>
        <div style="overflow:auto;max-height:220px">
          <table id="mileage-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Loan -->
      <section id="loan" class="panel section" aria-hidden="true">
        <div class="small">Loan / EMI</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loan-p" class="input" placeholder="Principal (â‚¹)" type="number" value="100000">
          <input id="loan-r" class="input" placeholder="Annual rate (%)" type="number" value="7.5">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="loan-n" class="input" placeholder="Years" type="number" value="5">
          <button class="btn" onclick="calcLoan()">Calculate</button>
          <button class="btn ghost" onclick="clearLoan()">Clear</button>
        </div>
        <div class="result-box" id="loan-result">EMI result</div>
      </section>

      <!-- Tax -->
      <section id="tax" class="panel section" aria-hidden="true">
        <div class="small">Tax helper (flat & demo slab)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tax-income" class="input" placeholder="Taxable income" type="number" value="500000">
          <input id="tax-rate" class="input" placeholder="Flat tax rate (%)" type="number" value="10">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcTax()">Flat tax</button>
          <button class="btn ghost" onclick="calcTaxSlab()">Slab demo</button>
        </div>
        <div class="result-box" id="tax-result">Tax result</div>
      </section>

      <!-- Date -->
      <section id="date" class="panel section" aria-hidden="true">
        <div class="small">Age, days between and add/subtract days</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="dob" type="date" class="input"><div style="display:flex;gap:8px"><button class="btn" onclick="calcAge()">Age</button><button class="btn ghost" onclick="clearAge()">Clear</button></div>
        </div>
        <div class="result-box" id="age-result">Age result</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="start-date" type="date" class="input"><input id="end-date" type="date" class="input">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="daysBetween()">Days between</button>
          <button class="btn ghost" onclick="clearDates()">Clear</button>
        </div>
        <div class="result-box" id="date-diff-result">Days difference</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="base-date" type="date" class="input"><input id="days-add" type="number" class="input" value="0">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addDays()">Add/Subtract</button><button class="btn ghost" onclick="clearAddDays()">Clear</button>
        </div>
        <div class="result-box" id="add-days-result">Add/Sub result</div>
      </section>

      <!-- Measure -->
      <section id="measure" class="panel section" aria-hidden="true">
        <div class="small">Length, Weight, Temperature conversions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="measure-type" class="input" onchange="populateUnits()"><option value="length">Length</option><option value="weight">Weight</option><option value="temperature">Temperature</option></select>
          <input id="measure-value" class="input" type="number" value="1" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="measure-from" class="input"></select>
          <select id="measure-to" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="convertMeasure()">Convert</button>
          <button class="btn ghost" onclick="resetMeasure()">Clear</button>
        </div>
        <div class="result-box" id="measure-result">Conversion</div>
      </section>

      <!-- BMI -->
      <section id="bmi" class="panel section" aria-hidden="true">
        <div class="small">Body Mass Index calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="bmi-height" class="input" placeholder="Height (cm)" type="number" value="170">
          <input id="bmi-weight" class="input" placeholder="Weight (kg)" type="number" value="70">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcBMI()">Calculate BMI</button>
          <button class="btn ghost" onclick="clearBMI()">Clear</button>
        </div>
        <div class="result-box" id="bmi-result">BMI result</div>
        <div class="small" style="margin-top:6px">Underweight: <18.5, Normal: 18.5-24.9, Overweight: 25-29.9, Obesity: â‰¥30</div>
      </section>

      <!-- Discount -->
      <section id="discount" class="panel section" aria-hidden="true">
        <div class="small">Discount and sale price calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="discount-price" class="input" placeholder="Original price" type="number" value="100">
          <input id="discount-percent" class="input" placeholder="Discount (%)" type="number" value="20">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcDiscount()">Calculate</button>
          <button class="btn ghost" onclick="clearDiscount()">Clear</button>
        </div>
        <div class="result-box" id="discount-result">Discount result</div>
      </section>

      <!-- Tip -->
      <section id="tip" class="panel section" aria-hidden="true">
        <div class="small">Tip calculator</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tip-amount" class="input" placeholder="Bill amount" type="number" value="100">
          <input id="tip-percent" class="input" placeholder="Tip percentage" type="number" value="15">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="tip-people" class="input" placeholder="Number of people" type="number" value="2">
          <button class="btn" onclick="calcTip()">Calculate</button>
        </div>
        <div class="result-box" id="tip-result">Tip result</div>
      </section>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Recent calculations</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="copyHistory()">Copy</button>
          <button class="btn ghost" onclick="downloadHistory()">Export CSV</button>
          <button class="btn" onclick="resetAll()">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="history" id="history"></div>
    </main>

    <!-- SIDEBAR / LIVE PANEL -->
    <aside class="sidebar" aria-label="Live market data">
      <div class="live-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Snapshot</strong>
          <div class="tiny muted" id="live-updated">--</div>
        </div>

        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">USD â†’ <span id="local-currency">INR</span></div><div id="usd-local" style="font-weight:800">--</div></div>
          <div><div class="small muted">EUR â†’ USD</div><div id="eur-usd" style="font-weight:800">--</div></div>

          <div><div class="small muted">Gold (XAU/oz)</div><div id="gold" style="font-weight:800">--</div></div>
          <div><div class="small muted">Silver (XAG/oz)</div><div id="silver" style="font-weight:800">--</div></div>

          <div><div class="small muted">Bitcoin (USD)</div><div id="btc" style="font-weight:800">--</div></div>
          <div><div class="small muted">Ethereum (USD)</div><div id="eth" style="font-weight:800">--</div></div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="refreshLive()">Refresh</button>
          <button class="btn ghost" onclick="toggleAuto()">Auto: <span id="auto-status">ON</span></button>
        </div>

        <div class="tiny muted" style="margin-top:8px">Data sources: exchangerate.host, CoinGecko, GoldPrice (public endpoints).</div>
      </div>

      <div class="live-card">
        <strong>Quick Converter</strong>
        <div style="margin-top:8px">
          <input id="quick-amt" class="input" value="1" type="number" step="any">
          <select id="quick-from" class="input" style="margin-top:6px"></select>
          <select id="quick-to" class="input" style="margin-top:6px"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="quickConvert()">Convert</button>
            <button class="btn ghost" onclick="fillQuick()">Use main</button>
          </div>
          <div class="result-box" id="quick-result">Quick result</div>
        </div>
      </div>

      <div class="live-card">
        <strong>Country Data</strong>
        <div class="small muted" style="margin-top:8px">Local time & info for <span id="current-country">India</span></div>
        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">Local Time</div><div id="local-time" style="font-weight:800">--:--:--</div></div>
          <div><div class="small muted">Date</div><div id="local-date" style="font-weight:800">--</div></div>
        </div>
        <div class="small muted" style="margin-top:8px">Currency: <span id="country-currency">INR</span></div>
      </div>

      <div class="live-card">
        <strong>Mileage Export</strong>
        <div class="small muted" style="margin-top:8px">Export or clear mileage (local fallback)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="exportMileageCSV()">Export CSV</button>
          <button class="btn ghost" onclick="clearMileageStorage()">Clear</button>
        </div>
        <div class="note">If Firestore is accessible you'll see saved records from your Firebase project; otherwise localStorage backup is used.</div>
      </div>
    </aside>
  </div>

  <footer>Open dev console to see detailed errors if any API fails. If CORS errors appear, run a local web server (e.g. <code>python -m http.server 8000</code>) and open the page at <code>http://localhost:8000/</code>.</footer>
</div>

<script type="module">
/* ======================= MODULE SCRIPT - ALL FEATURES ======================= */

/* ------------------ Firebase (optional) ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---- Replace with your Firebase config if you want a different project ---- */
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

let db = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  console.info('Firestore initialized');
} catch (e) {
  console.warn('Firestore init failed (or blocked):', e);
}

/* ------------------ API endpoints ------------------ */
const API = {
  SYMBOLS: "https://api.exchangerate.host/symbols",
  CONVERT: "https://api.exchangerate.host/convert",
  LATEST: "https://api.exchangerate.host/latest",
  GOLDPRICE: "https://data-asg.goldprice.org/dbXRates/USD",
  COINGECKO_SIMPLE: "https://api.coingecko.com/api/v3/simple/price",
  COUNTRIES: "https://restcountries.com/v3.1/alpha/"
};

/* ------------------ Country data ------------------ */
let currentCountry = "IN";
let countryCurrency = "INR";
let countryTimeZone = "Asia/Kolkata";

// Country to currency mapping (fallback)
const countryCurrencyMap = {
  "US": "USD", "IN": "INR", "GB": "GBP", "DE": "EUR", "JP": "JPY",
  "AU": "AUD", "CA": "CAD", "FR": "EUR", "BR": "BRL", "CN": "CNY"
};

// Country to timezone mapping (fallback)
const countryTimeZoneMap = {
  "US": "America/New_York", "IN": "Asia/Kolkata", "GB": "Europe/London", 
  "DE": "Europe/Berlin", "JP": "Asia/Tokyo", "AU": "Australia/Sydney",
  "CA": "America/Toronto", "FR": "Europe/Paris", "BR": "America/Sao_Paulo", 
  "CN": "Asia/Shanghai"
};

// Country names mapping
const countryNames = {
  "US": "United States", "IN": "India", "GB": "United Kingdom", 
  "DE": "Germany", "JP": "Japan", "AU": "Australia", "CA": "Canada",
  "FR": "France", "BR": "Brazil", "CN": "China"
};

/* ------------------ small fetch wrapper ------------------ */
async function fetchJson(url, opts = {}, timeout = 12000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    clearTimeout(id);
    if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
    return await res.json();
  } catch (err) {
    clearTimeout(id);
    throw err;
  }
}

/* ------------------ Tabs switching ------------------ */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    const id = t.dataset.tab;
    const p = document.getElementById(id);
    if (p) p.classList.add('active');
  });
});

/* ------------------ Country selection ------------------ */
const countrySelect = document.getElementById('country-select');
countrySelect.addEventListener('change', function() {
  currentCountry = this.value;
  updateCountryData();
  refreshLive(); // Refresh live data with new country
  updateCurrencySelectors(); // Update currency selectors with new country currency
});

async function updateCountryData() {
  const countryCode = currentCountry;
  const countryName = countryNames[countryCode] || countryCode;
  document.getElementById('current-country').textContent = countryName;
  
  // Try to get country info from API
  try {
    const data = await fetchJson(`${API.COUNTRIES}${countryCode}`);
    if (data && data.length > 0) {
      const country = data[0];
      countryCurrency = Object.keys(country.currencies || {})[0] || countryCurrencyMap[countryCode];
      countryTimeZone = country.timezones ? country.timezones[0] : countryTimeZoneMap[countryCode];
    }
  } catch (e) {
    console.warn('Country API failed, using fallback:', e);
    countryCurrency = countryCurrencyMap[countryCode] || "USD";
    countryTimeZone = countryTimeZoneMap[countryCode] || "UTC";
  }
  
  document.getElementById('country-currency').textContent = countryCurrency;
  document.getElementById('local-currency').textContent = countryCurrency;
  
  // Update currency selectors
  updateCurrencySelectors();
  
  // Update local time display
  updateLocalTime();
}

function updateLocalTime() {
  const now = new Date();
  const formatter = new Intl.DateTimeFormat('en-US', {
    timeZone: countryTimeZone,
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  const dateFormatter = new Intl.DateTimeFormat('en-US', {
    timeZone: countryTimeZone,
    year: 'numeric', month: 'short', day: 'numeric'
  });
  
  document.getElementById('local-time').textContent = formatter.format(now);
  document.getElementById('local-date').textContent = dateFormatter.format(now);
}

// Update local time every second
setInterval(updateLocalTime, 1000);

/* ------------------ Currency symbols ------------------ */
let currencySymbols = {};

async function loadCurrencySymbols() {
  try {
    const data = await fetchJson(API.SYMBOLS);
    if (data && data.success) {
      currencySymbols = data.symbols;
      updateCurrencySelectors();
    }
  } catch (e) {
    console.error('Failed to load currency symbols:', e);
    // Fallback to common currencies
    currencySymbols = {
      "USD": { description: "United States Dollar" },
      "EUR": { description: "Euro" },
      "GBP": { description: "British Pound Sterling" },
      "JPY": { description: "Japanese Yen" },
      "INR": { description: "Indian Rupee" },
      "AUD": { description: "Australian Dollar" },
      "CAD": { description: "Canadian Dollar" },
      "CHF": { description: "Swiss Franc" },
      "CNY": { description: "Chinese Yuan" },
      "NZD": { description: "New Zealand Dollar" }
    };
    updateCurrencySelectors();
  }
}

function updateCurrencySelectors() {
  const fromSelect = document.getElementById('from-currency');
  const toSelect = document.getElementById('to-currency');
  const quickFrom = document.getElementById('quick-from');
  const quickTo = document.getElementById('quick-to');
  
  // Clear existing options
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';
  quickFrom.innerHTML = '';
  quickTo.innerHTML = '';
  
  // Add currency options
  for (const code in currencySymbols) {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = `${code} - ${currencySymbols[code].description}`;
    
    const option2 = option.cloneNode(true);
    const option3 = option.cloneNode(true);
    const option4 = option.cloneNode(true);
    
    fromSelect.appendChild(option);
    toSelect.appendChild(option2);
    quickFrom.appendChild(option3);
    quickTo.appendChild(option4);
    
    // Set default selections
    if (code === 'USD') {
      option.selected = true;
      option3.selected = true;
    }
    if (code === countryCurrency) {
      option2.selected = true;
      option4.selected = true;
    }
  }
}

/* ------------------ Currency conversion ------------------ */
async function convertCurrency() {
  const amount = parseFloat(document.getElementById('cur-amount').value) || 1;
  const from = document.getElementById('from-currency').value;
  const to = document.getElementById('to-currency').value;
  
  try {
    const data = await fetchJson(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    if (data && data.success) {
      const result = data.result;
      document.getElementById('cur-result').innerHTML = `
        <strong>${amount} ${from} = ${result.toFixed(2)} ${to}</strong><br>
        <span class="small">Rate: 1 ${from} = ${(result/amount).toFixed(6)} ${to}</span>
      `;
      addToHistory(`${amount} ${from} â†’ ${result.toFixed(2)} ${to}`);
    } else {
      document.getElementById('cur-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (e) {
    console.error('Currency conversion error:', e);
    document.getElementById('cur-result').textContent = 'Error: ' + e.message;
  }
}

function swapCurrency() {
  const fromSelect = document.getElementById('from-currency');
  const toSelect = document.getElementById('to-currency');
  const temp = fromSelect.value;
  fromSelect.value = toSelect.value;
  toSelect.value = temp;
  convertCurrency();
}

async function quickConvert() {
  const amount = parseFloat(document.getElementById('quick-amt').value) || 1;
  const from = document.getElementById('quick-from').value;
  const to = document.getElementById('quick-to').value;
  
  try {
    const data = await fetchJson(`${API.CONVERT}?from=${from}&to=${to}&amount=${amount}`);
    if (data && data.success) {
      const result = data.result;
      document.getElementById('quick-result').innerHTML = `
        <strong>${amount} ${from} = ${result.toFixed(2)} ${to}</strong><br>
        <span class="small">Rate: 1 ${from} = ${(result/amount).toFixed(6)} ${to}</span>
      `;
    } else {
      document.getElementById('quick-result').textContent = 'Conversion failed. Please try again.';
    }
  } catch (e) {
    console.error('Quick conversion error:', e);
    document.getElementById('quick-result').textContent = 'Error: ' + e.message;
  }
}

function fillQuick() {
  document.getElementById('quick-amt').value = document.getElementById('cur-amount').value;
  document.getElementById('quick-from').value = document.getElementById('from-currency').value;
  document.getElementById('quick-to').value = document.getElementById('to-currency').value;
  quickConvert();
}

/* ------------------ Live data ------------------ */
let autoRefresh = true;
let refreshInterval = null;

async function refreshLive() {
  const updatedEl = document.getElementById('live-updated');
  updatedEl.textContent = 'Updating...';
  
  try {
    // Get USD to local currency rate
    const latestData = await fetchJson(`${API.LATEST}?base=USD&symbols=${countryCurrency}`);
    if (latestData && latestData.success) {
      const rate = latestData.rates[countryCurrency];
      document.getElementById('usd-local').textContent = rate.toFixed(2);
    }
    
    // Get EUR to USD rate
    const eurData = await fetchJson(`${API.LATEST}?base=EUR&symbols=USD`);
    if (eurData && eurData.success) {
      const rate = eurData.rates.USD;
      document.getElementById('eur-usd').textContent = rate.toFixed(2);
    }
    
    // Get gold price
    const goldData = await fetchJson(API.GOLDPRICE);
    if (goldData) {
      const goldPrice = goldData.items[0].xauPrice;
      document.getElementById('gold').textContent = `$${goldPrice.toLocaleString()}`;
      
      const silverPrice = goldData.items[0].xagPrice;
      document.getElementById('silver').textContent = `$${silverPrice.toFixed(2)}`;
    }
    
    // Get crypto prices
    const cryptoData = await fetchJson(`${API.COINGECKO_SIMPLE}?ids=bitcoin,ethereum&vs_currencies=usd`);
    if (cryptoData) {
      document.getElementById('btc').textContent = `$${cryptoData.bitcoin.usd.toLocaleString()}`;
      document.getElementById('eth').textContent = `$${cryptoData.ethereum.usd.toLocaleString()}`;
    }
    
    updatedEl.textContent = new Date().toLocaleTimeString();
  } catch (e) {
    console.error('Live data error:', e);
    updatedEl.textContent = 'Error updating';
  }
}

function toggleAuto() {
  autoRefresh = !autoRefresh;
  document.getElementById('auto-status').textContent = autoRefresh ? 'ON' : 'OFF';
  
  if (autoRefresh) {
    refreshLive();
    refreshInterval = setInterval(refreshLive, 60000); // Refresh every minute
  } else if (refreshInterval) {
    clearInterval(refreshInterval);
    refreshInterval = null;
  }
}

/* ------------------ Standard Calculator ------------------ */
let stdExpression = '0';

function stdAppend(value) {
  if (stdExpression === '0' && value !== '.') {
    stdExpression = value;
  } else {
    stdExpression += value;
  }
  document.getElementById('std-display').value = stdExpression;
}

function stdClear() {
  stdExpression = '0';
  document.getElementById('std-display').value = stdExpression;
}

function stdBack() {
  if (stdExpression.length > 1) {
    stdExpression = stdExpression.slice(0, -1);
  } else {
    stdExpression = '0';
  }
  document.getElementById('std-display').value = stdExpression;
}

function stdCalculate() {
  try {
    // Replace visual symbols with JavaScript operators
    const calcExpression = stdExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    const result = eval(calcExpression);
    document.getElementById('std-display').value = result;
    stdExpression = String(result);
    addToHistory(`${stdExpression} = ${result}`);
  } catch (e) {
    document.getElementById('std-display').value = 'Error';
    stdExpression = '0';
  }
}

/* ------------------ Scientific Calculator ------------------ */
let sciExpression = '0';

function sciAppend(value) {
  if (sciExpression === '0' && value !== '.') {
    sciExpression = value;
  } else {
    sciExpression += value;
  }
  document.getElementById('sci-display').value = sciExpression;
}

function sciClear() {
  sciExpression = '0';
  document.getElementById('sci-display').value = sciExpression;
}

function sciBack() {
  if (sciExpression.length > 1) {
    sciExpression = sciExpression.slice(0, -1);
  } else {
    sciExpression = '0';
  }
  document.getElementById('sci-display').value = sciExpression;
}

function sciFunc(func) {
  const value = parseFloat(sciExpression) || 0;
  let result = 0;
  
  switch(func) {
    case 'sin': result = Math.sin(value * Math.PI / 180); break;
    case 'cos': result = Math.cos(value * Math.PI / 180); break;
    case 'tan': result = Math.tan(value * Math.PI / 180); break;
    case 'sqrt': result = Math.sqrt(value); break;
    case 'log': result = Math.log10(value); break;
    case 'ln': result = Math.log(value); break;
  }
  
  sciExpression = String(result);
  document.getElementById('sci-display').value = sciExpression;
  addToHistory(`${func}(${value}) = ${result}`);
}

function sciFact() {
  const num = parseInt(sciExpression) || 0;
  if (num < 0) {
    document.getElementById('sci-display').value = 'Error';
    sciExpression = '0';
    return;
  }
  
  let result = 1;
  for (let i = 2; i <= num; i++) {
    result *= i;
  }
  
  sciExpression = String(result);
  document.getElementById('sci-display').value = sciExpression;
  addToHistory(`${num}! = ${result}`);
}

function sciCalculate() {
  try {
    // Replace visual symbols with JavaScript operators
    const calcExpression = sciExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    const result = eval(calcExpression);
    document.getElementById('sci-display').value = result;
    sciExpression = String(result);
    addToHistory(`${sciExpression} = ${result}`);
  } catch (e) {
    document.getElementById('sci-display').value = 'Error';
    sciExpression = '0';
  }
}

/* ------------------ History ------------------ */
function addToHistory(entry) {
  const historyEl = document.getElementById('history');
  const entryEl = document.createElement('div');
  entryEl.textContent = entry;
  entryEl.className = 'small';
  historyEl.prepend(entryEl);
  
  // Keep only the last 10 entries
  if (historyEl.children.length > 10) {
    historyEl.removeChild(historyEl.lastChild);
  }
}

function copyHistory() {
  const historyEl = document.getElementById('history');
  const text = Array.from(historyEl.children).map(el => el.textContent).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    alert('History copied to clipboard');
  });
}

function downloadHistory() {
  const historyEl = document.getElementById('history');
  const text = Array.from(historyEl.children).map(el => el.textContent).join('\n');
  const blob = new Blob([text], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'calculator-history.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function resetAll() {
  if (confirm('Are you sure you want to reset all data?')) {
    localStorage.clear();
    document.getElementById('history').innerHTML = '';
    stdClear();
    sciClear();
    location.reload();
  }
}

/* ------------------ Mileage Tracker ------------------ */
async function addMileage() {
  const vehicle = document.getElementById('vehicle').value;
  const odo = parseFloat(document.getElementById('odo').value);
  const fuel = parseFloat(document.getElementById('fuel').value);
  const cost = parseFloat(document.getElementById('cost').value);
  const date = document.getElementById('mdate').value || new Date().toISOString().split('T')[0];
  
  if (!vehicle || isNaN(odo) || isNaN(fuel) || isNaN(cost) || fuel <= 0) {
    alert('Please fill all fields with valid values');
    return;
  }
  
  const mileage = odo / fuel;
  const costPerKm = cost / odo;
  
  const record = {
    vehicle, odo, fuel, cost, date, mileage: mileage.toFixed(2), costPerKm: costPerKm.toFixed(2)
  };
  
  // Try to save to Firebase first
  if (db) {
    try {
      await addDoc(collection(db, "mileage"), record);
    } catch (e) {
      console.warn('Firestore save failed, using localStorage:', e);
      saveToLocalStorage(record);
    }
  } else {
    saveToLocalStorage(record);
  }
  
  // Update UI
  clearMileageForm();
  loadMileageData();
}

function saveToLocalStorage(record) {
  let mileageData = JSON.parse(localStorage.getItem('mileageData') || '[]');
  mileageData.push(record);
  localStorage.setItem('mileageData', JSON.stringify(mileageData));
}

async function loadMileageData() {
  let mileageData = [];
  
  // Try to load from Firebase first
  if (db) {
    try {
      const querySnapshot = await getDocs(query(collection(db, "mileage"), orderBy("date", "desc")));
      querySnapshot.forEach((doc) => {
        mileageData.push({ id: doc.id, ...doc.data() });
      });
    } catch (e) {
      console.warn('Firestore load failed, using localStorage:', e);
      mileageData = JSON.parse(localStorage.getItem('mileageData') || '[]');
    }
  } else {
    mileageData = JSON.parse(localStorage.getItem('mileageData') || '[]');
  }
  
  // Update table
  const tbody = document.getElementById('mileage-table').querySelector('tbody');
  tbody.innerHTML = '';
  
  mileageData.forEach(record => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${record.date}</td>
      <td>${record.vehicle}</td>
      <td>${record.odo}</td>
      <td>${record.fuel}</td>
      <td>${record.cost}</td>
      <td>${record.mileage}</td>
      <td><span class="delete" onclick="deleteMileage('${record.id || record.date}')">âœ•</span></td>
    `;
    tbody.appendChild(tr);
  });
  
  // Update summary
  if (mileageData.length > 0) {
    const totalKm = mileageData.reduce((sum, r) => sum + parseFloat(r.odo), 0);
    const totalFuel = mileageData.reduce((sum, r) => sum + parseFloat(r.fuel), 0);
    const totalCost = mileageData.reduce((sum, r) => sum + parseFloat(r.cost), 0);
    const avgMileage = totalKm / totalFuel;
    const avgCostPerKm = totalCost / totalKm;
    
    document.getElementById('mileage-summary').innerHTML = `
      <strong>Summary:</strong> ${mileageData.length} records<br>
      <span class="small">Avg. Mileage: ${avgMileage.toFixed(2)} km/L</span><br>
      <span class="small">Avg. Cost: ${avgCostPerKm.toFixed(2)} â‚¹/km</span>
    `;
  } else {
    document.getElementById('mileage-summary').textContent = 'No records yet';
  }
}

async function deleteMileage(id) {
  if (db) {
    try {
      await deleteDoc(doc(db, "mileage", id));
    } catch (e) {
      console.warn('Firestore delete failed, trying localStorage:', e);
      deleteFromLocalStorage(id);
    }
  } else {
    deleteFromLocalStorage(id);
  }
  
  loadMileageData();
}

function deleteFromLocalStorage(date) {
  let mileageData = JSON.parse(localStorage.getItem('mileageData') || '[]');
  mileageData = mileageData.filter(r => r.date !== date);
  localStorage.setItem('mileageData', JSON.stringify(mileageData));
}

function clearMileageForm() {
  document.getElementById('vehicle').value = '';
  document.getElementById('odo').value = '';
  document.getElementById('fuel').value = '';
  document.getElementById('cost').value = '';
  document.getElementById('mdate').value = '';
}

function clearMileageStorage() {
  if (confirm('Are you sure you want to clear all mileage data?')) {
    if (db) {
      // Note: This would require a cloud function to clear entire collection
      alert('To clear all data from Firestore, you need to implement a cloud function.');
    }
    localStorage.removeItem('mileageData');
    loadMileageData();
  }
}

function exportMileageCSV() {
  let mileageData = JSON.parse(localStorage.getItem('mileageData') || '[]');
  if (mileageData.length === 0) {
    alert('No data to export');
    return;
  }
  
  const headers = ['Date', 'Vehicle', 'Odometer (km)', 'Fuel (L)', 'Cost (â‚¹)', 'Mileage (km/L)', 'Cost per km (â‚¹)'];
  const csv = [
    headers.join(','),
    ...mileageData.map(r => [
      r.date, r.vehicle, r.odo, r.fuel, r.cost, r.mileage, r.costPerKm
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'mileage-data.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* ------------------ Loan Calculator ------------------ */
function calcLoan() {
  const principal = parseFloat(document.getElementById('loan-p').value) || 0;
  const rate = parseFloat(document.getElementById('loan-r').value) || 0;
  const years = parseFloat(document.getElementById('loan-n').value) || 0;
  
  if (principal <= 0 || rate <= 0 || years <= 0) {
    document.getElementById('loan-result').textContent = 'Please enter valid values';
    return;
  }
  
  const monthlyRate = rate / 100 / 12;
  const months = years * 12;
  const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
  const totalPayment = emi * months;
  const totalInterest = totalPayment - principal;
  
  document.getElementById('loan-result').innerHTML = `
    <strong>EMI: â‚¹${emi.toFixed(2)}</strong><br>
    <span class="small">Total Payment: â‚¹${totalPayment.toFixed(2)}</span><br>
    <span class="small">Total Interest: â‚¹${totalInterest.toFixed(2)}</span>
  `;
  
  addToHistory(`Loan: â‚¹${principal} @ ${rate}% for ${years} years = EMI â‚¹${emi.toFixed(2)}`);
}

function clearLoan() {
  document.getElementById('loan-p').value = '';
  document.getElementById('loan-r').value = '';
  document.getElementById('loan-n').value = '';
  document.getElementById('loan-result').textContent = 'EMI result';
}

/* ------------------ Tax Calculator ------------------ */
function calcTax() {
  const income = parseFloat(document.getElementById('tax-income').value) || 0;
  const rate = parseFloat(document.getElementById('tax-rate').value) || 0;
  
  if (income <= 0 || rate < 0) {
    document.getElementById('tax-result').textContent = 'Please enter valid values';
    return;
  }
  
  const tax = income * rate / 100;
  const net = income - tax;
  
  document.getElementById('tax-result').innerHTML = `
    <strong>Tax: â‚¹${tax.toFixed(2)}</strong><br>
    <span class="small">Net Income: â‚¹${net.toFixed(2)}</span><br>
    <span class="small">Effective Rate: ${rate.toFixed(2)}%</span>
  `;
  
  addToHistory(`Tax: â‚¹${income} @ ${rate}% = â‚¹${tax.toFixed(2)} tax`);
}

function calcTaxSlab() {
  const income = parseFloat(document.getElementById('tax-income').value) || 0;
  
  if (income <= 0) {
    document.getElementById('tax-result').textContent = 'Please enter valid income';
    return;
  }
  
  // Simplified tax slab (Indian system as example)
  let tax = 0;
  if (income > 1000000) {
    tax += (income - 1000000) * 0.3;
    income = 1000000;
  }
  if (income > 500000) {
    tax += (income - 500000) * 0.2;
    income = 500000;
  }
  if (income > 250000) {
    tax += (income - 250000) * 0.05;
  }
  
  const net = income - tax;
  const effectiveRate = (tax / income) * 100;
  
  document.getElementById('tax-result').innerHTML = `
    <strong>Tax: â‚¹${tax.toFixed(2)}</strong><br>
    <span class="small">Net Income: â‚¹${net.toFixed(2)}</span><br>
    <span class="small">Effective Rate: ${effectiveRate.toFixed(2)}%</span>
  `;
  
  addToHistory(`Tax Slab: â‚¹${income} = â‚¹${tax.toFixed(2)} tax`);
}

/* ------------------ Date Calculator ------------------ */
function calcAge() {
  const dob = new Date(document.getElementById('dob').value);
  if (isNaN(dob.getTime())) {
    document.getElementById('age-result').textContent = 'Please select a valid date';
    return;
  }
  
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const m = today.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
    age--;
  }
  
  document.getElementById('age-result').innerHTML = `
    <strong>Age: ${age} years</strong><br>
    <span class="small">Date of Birth: ${dob.toDateString()}</span>
  `;
  
  addToHistory(`Age: ${dob.toDateString()} = ${age} years`);
}

function clearAge() {
  document.getElementById('dob').value = '';
  document.getElementById('age-result').textContent = 'Age result';
}

function daysBetween() {
  const start = new Date(document.getElementById('start-date').value);
  const end = new Date(document.getElementById('end-date').value);
  
  if (isNaN(start.getTime()) || isNaN(end.getTime())) {
    document.getElementById('date-diff-result').textContent = 'Please select valid dates';
    return;
  }
  
  const diffTime = Math.abs(end - start);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  document.getElementById('date-diff-result').innerHTML = `
    <strong>Difference: ${diffDays} days</strong><br>
    <span class="small">From: ${start.toDateString()}</span><br>
    <span class="small">To: ${end.toDateString()}</span>
  `;
  
  addToHistory(`Days between: ${start.toDateString()} to ${end.toDateString()} = ${diffDays} days`);
}

function clearDates() {
  document.getElementById('start-date').value = '';
  document.getElementById('end-date').value = '';
  document.getElementById('date-diff-result').textContent = 'Days difference';
}

function addDays() {
  const baseDate = new Date(document.getElementById('base-date').value);
  const days = parseInt(document.getElementById('days-add').value) || 0;
  
  if (isNaN(baseDate.getTime())) {
    document.getElementById('add-days-result').textContent = 'Please select a valid date';
    return;
  }
  
  const resultDate = new Date(baseDate);
  resultDate.setDate(resultDate.getDate() + days);
  
  document.getElementById('add-days-result').innerHTML = `
    <strong>Result: ${resultDate.toDateString()}</strong><br>
    <span class="small">Base Date: ${baseDate.toDateString()}</span><br>
    <span class="small">Days ${days >= 0 ? 'Added' : 'Subtracted'}: ${Math.abs(days)}</span>
  `;
  
  addToHistory(`Date calc: ${baseDate.toDateString()} ${days >= 0 ? '+' : '-'} ${Math.abs(days)} days = ${resultDate.toDateString()}`);
}

function clearAddDays() {
  document.getElementById('base-date').value = '';
  document.getElementById('days-add').value = '0';
  document.getElementById('add-days-result').textContent = 'Add/Sub result';
}

/* ------------------ Measure Converter ------------------ */
const units = {
  length: [
    { code: 'm', name: 'Meters', factor: 1 },
    { code: 'km', name: 'Kilometers', factor: 1000 },
    { code: 'cm', name: 'Centimeters', factor: 0.01 },
    { code: 'mm', name: 'Millimeters', factor: 0.001 },
    { code: 'mi', name: 'Miles', factor: 1609.34 },
    { code: 'yd', name: 'Yards', factor: 0.9144 },
    { code: 'ft', name: 'Feet', factor: 0.3048 },
    { code: 'in', name: 'Inches', factor: 0.0254 }
  ],
  weight: [
    { code: 'kg', name: 'Kilograms', factor: 1 },
    { code: 'g', name: 'Grams', factor: 0.001 },
    { code: 'mg', name: 'Milligrams', factor: 0.000001 },
    { code: 'lb', name: 'Pounds', factor: 0.453592 },
    { code: 'oz', name: 'Ounces', factor: 0.0283495 },
    { code: 'st', name: 'Stones', factor: 6.35029 }
  ],
  temperature: [
    { code: 'c', name: 'Celsius', factor: 1 },
    { code: 'f', name: 'Fahrenheit', factor: 1 },
    { code: 'k', name: 'Kelvin', factor: 1 }
  ]
};

function populateUnits() {
  const type = document.getElementById('measure-type').value;
  const fromSelect = document.getElementById('measure-from');
  const toSelect = document.getElementById('measure-to');
  
  fromSelect.innerHTML = '';
  toSelect.innerHTML = '';
  
  units[type].forEach(unit => {
    const option1 = document.createElement('option');
    option1.value = unit.code;
    option1.textContent = `${unit.code} - ${unit.name}`;
    
    const option2 = option1.cloneNode(true);
    
    fromSelect.appendChild(option1);
    toSelect.appendChild(option2);
  });
  
  // Set default "to" unit to a different one
  if (units[type].length > 1) {
    toSelect.selectedIndex = 1;
  }
}

function convertMeasure() {
  const type = document.getElementById('measure-type').value;
  const value = parseFloat(document.getElementById('measure-value').value) || 0;
  const from = document.getElementById('measure-from').value;
  const to = document.getElementById('measure-to').value;
  
  if (type === 'temperature') {
    // Temperature needs special handling
    let result;
    if (from === 'c' && to === 'f') {
      result = (value * 9/5) + 32;
    } else if (from === 'f' && to === 'c') {
      result = (value - 32) * 5/9;
    } else if (from === 'c' && to === 'k') {
      result = value + 273.15;
    } else if (from === 'k' && to === 'c') {
      result = value - 273.15;
    } else if (from === 'f' && to === 'k') {
      result = (value - 32) * 5/9 + 273.15;
    } else if (from === 'k' && to === 'f') {
      result = (value - 273.15) * 9/5 + 32;
    } else {
      result = value; // Same unit
    }
    
    document.getElementById('measure-result').innerHTML = `
      <strong>${value}Â°${from.toUpperCase()} = ${result.toFixed(2)}Â°${to.toUpperCase()}</strong>
    `;
    
    addToHistory(`Convert: ${value}${from} â†’ ${result.toFixed(2)}${to}`);
  } else {
    // For length and weight
    const fromUnit = units[type].find(u => u.code === from);
    const toUnit = units[type].find(u => u.code === to);
    
    const baseValue = value * fromUnit.factor;
    const result = baseValue / toUnit.factor;
    
    document.getElementById('measure-result').innerHTML = `
      <strong>${value} ${from} = ${result.toFixed(6)} ${to}</strong>
    `;
    
    addToHistory(`Convert: ${value}${from} â†’ ${result.toFixed(6)}${to}`);
  }
}

function resetMeasure() {
  document.getElementById('measure-value').value = '1';
  populateUnits();
  document.getElementById('measure-result').textContent = 'Conversion';
}

/* ------------------ BMI Calculator ------------------ */
function calcBMI() {
  const height = parseFloat(document.getElementById('bmi-height').value) || 0;
  const weight = parseFloat(document.getElementById('bmi-weight').value) || 0;
  
  if (height <= 0 || weight <= 0) {
    document.getElementById('bmi-result').textContent = 'Please enter valid values';
    return;
  }
  
  // Convert height from cm to meters
  const heightM = height / 100;
  const bmi = weight / (heightM * heightM);
  
  let category = '';
  if (bmi < 18.5) category = 'Underweight';
  else if (bmi < 25) category = 'Normal weight';
  else if (bmi < 30) category = 'Overweight';
  else category = 'Obesity';
  
  document.getElementById('bmi-result').innerHTML = `
    <strong>BMI: ${bmi.toFixed(1)} (${category})</strong><br>
    <span class="small">Height: ${height} cm, Weight: ${weight} kg</span>
  `;
  
  addToHistory(`BMI: ${height}cm, ${weight}kg = ${bmi.toFixed(1)} (${category})`);
}

function clearBMI() {
  document.getElementById('bmi-height').value = '';
  document.getElementById('bmi-weight').value = '';
  document.getElementById('bmi-result').textContent = 'BMI result';
}

/* ------------------ Discount Calculator ------------------ */
function calcDiscount() {
  const price = parseFloat(document.getElementById('discount-price').value) || 0;
  const discount = parseFloat(document.getElementById('discount-percent').value) || 0;
  
  if (price <= 0 || discount < 0) {
    document.getElementById('discount-result').textContent = 'Please enter valid values';
    return;
  }
  
  const discountAmount = price * discount / 100;
  const finalPrice = price - discountAmount;
  
  document.getElementById('discount-result').innerHTML = `
    <strong>Final Price: â‚¹${finalPrice.toFixed(2)}</strong><br>
    <span class="small">Original Price: â‚¹${price.toFixed(2)}</span><br>
    <span class="small">You Save: â‚¹${discountAmount.toFixed(2)} (${discount}%)</span>
  `;
  
  addToHistory(`Discount: â‚¹${price} - ${discount}% = â‚¹${finalPrice.toFixed(2)}`);
}

function clearDiscount() {
  document.getElementById('discount-price').value = '';
  document.getElementById('discount-percent').value = '';
  document.getElementById('discount-result').textContent = 'Discount result';
}

/* ------------------ Tip Calculator ------------------ */
function calcTip() {
  const amount = parseFloat(document.getElementById('tip-amount').value) || 0;
  const tipPercent = parseFloat(document.getElementById('tip-percent').value) || 0;
  const people = parseInt(document.getElementById('tip-people').value) || 1;
  
  if (amount <= 0 || tipPercent < 0 || people <= 0) {
    document.getElementById('tip-result').textContent = 'Please enter valid values';
    return;
  }
  
  const tipAmount = amount * tipPercent / 100;
  const total = amount + tipAmount;
  const perPerson = total / people;
  
  document.getElementById('tip-result').innerHTML = `
    <strong>Total: â‚¹${total.toFixed(2)}</strong><br>
    <span class="small">Bill: â‚¹${amount.toFixed(2)}</span><br>
    <span class="small">Tip: â‚¹${tipAmount.toFixed(2)} (${tipPercent}%)</span><br>
    <span class="small">Per Person: â‚¹${perPerson.toFixed(2)}</span>
  `;
  
  addToHistory(`Tip: â‚¹${amount} + ${tipPercent}% = â‚¹${total.toFixed(2)} total`);
}

/* ------------------ Initialize ------------------ */
function init() {
  // Set today's date as default for date inputs
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('mdate').value = today;
  document.getElementById('dob').value = today;
  document.getElementById('start-date').value = today;
  document.getElementById('end-date').value = today;
  document.getElementById('base-date').value = today;
  
  // Load currency symbols
  loadCurrencySymbols();
  
  // Populate measure units
  populateUnits();
  
  // Load mileage data
  loadMileageData();
  
  // Set up auto refresh for live data
  refreshLive();
  refreshInterval = setInterval(refreshLive, 60000);
  
  // Update country data
  updateCountryData();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>