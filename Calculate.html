<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>All-in-One Calculator & Live Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root{--accent:#0ea5a4;--good:#10b981;--danger:#ef4444;--muted:#6b7280}
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{background:linear-gradient(180deg,#0f1724,#0b1220);min-height:100vh;padding:18px;display:flex;justify-content:center;align-items:flex-start}
  .app{width:100%;max-width:1200px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
  header{background:linear-gradient(90deg,var(--accent),#3b82f6);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
  header h1{font-size:1.05rem;display:flex;gap:10px;align-items:center}
  .layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:680px}
  @media(max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }
  .main{padding:18px;background:#fff}
  .sidebar{background:#f8fafc;padding:18px;border-left:1px solid #e6eef6}
  .modes{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:1px solid #e6eef6;cursor:pointer;font-weight:700;color:#0f1724}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .panel{display:none}
  .panel.active{display:block;animation:fadeIn .25s ease}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .input, input, select, textarea, button{font-family:inherit}
  .input{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff}
  button.btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.btn.ghost{background:#eef2ff;color:#0f1724;border:1px solid #e6eef6}
  .display{width:100%;padding:12px;border-radius:8px;border:1px solid #e6eef6;background:#f8fafc;text-align:right;font-size:1.25rem}
  .result-box{margin-top:12px;padding:12px;border-left:4px solid var(--accent);background:#f0f9ff;border-radius:8px}
  .section{margin-bottom:14px}
  .small{font-size:0.92rem;color:var(--muted)}
  .history{max-height:220px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef5fb}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eef5fb;text-align:left;font-size:0.92rem}
  .live-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef5fb;margin-bottom:10px}
  .live-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .muted{color:var(--muted)}
  .tiny{font-size:0.85rem}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .delete{color:var(--danger);cursor:pointer}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  footer{padding:10px 18px;background:#f8fafc;border-top:1px solid #eef5fb;font-size:0.9rem;color:var(--muted)}
  .note {font-size:0.85rem;color:#374151;margin-top:8px}
</style>
</head>
<body>

<div class="app" role="application" aria-label="All-in-One Calculator">
  <header>
    <h1><i class="fas fa-calculator"></i> All-in-One Calculator — Live</h1>
    <div class="small">Currency (live) · Gold · Crypto · Mileage · Loan · Tax · Date · Measure</div>
  </header>

  <div class="layout">
    <!-- MAIN -->
    <main class="main" aria-live="polite">
      <div class="modes" role="tablist">
        <div class="tab active" data-tab="standard">Standard</div>
        <div class="tab" data-tab="scientific">Scientific</div>
        <div class="tab" data-tab="currency">Currency</div>
        <div class="tab" data-tab="mileage">Mileage</div>
        <div class="tab" data-tab="loan">Loan</div>
        <div class="tab" data-tab="tax">Tax</div>
        <div class="tab" data-tab="date">Date</div>
        <div class="tab" data-tab="measure">Measure</div>
      </div>

      <!-- Standard -->
      <section id="standard" class="panel active section">
        <div class="small">Basic arithmetic</div>
        <input id="std-display" class="display" readonly value="0" aria-label="Standard display">
        <div style="margin-top:10px" class="grid-4">
          <button class="btn ghost" onclick="stdClear()">C</button>
          <button class="btn ghost" onclick="stdBack()">⌫</button>
          <button class="btn ghost" onclick="stdAppend('%')">%</button>
          <button class="btn ghost" onclick="stdAppend('/')">/</button>

          <button class="btn" onclick="stdAppend('7')">7</button>
          <button class="btn" onclick="stdAppend('8')">8</button>
          <button class="btn" onclick="stdAppend('9')">9</button>
          <button class="btn ghost" onclick="stdAppend('*')">×</button>

          <button class="btn" onclick="stdAppend('4')">4</button>
          <button class="btn" onclick="stdAppend('5')">5</button>
          <button class="btn" onclick="stdAppend('6')">6</button>
          <button class="btn ghost" onclick="stdAppend('-')">-</button>

          <button class="btn" onclick="stdAppend('1')">1</button>
          <button class="btn" onclick="stdAppend('2')">2</button>
          <button class="btn" onclick="stdAppend('3')">3</button>
          <button class="btn ghost" onclick="stdAppend('+')">+</button>

          <button class="btn" onclick="stdAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="stdAppend('.')">.</button>
          <button class="btn" onclick="stdCalculate()">=</button>
        </div>
      </section>

      <!-- Scientific -->
      <section id="scientific" class="panel section" aria-hidden="true">
        <div class="small">Scientific (trig in degrees)</div>
        <input id="sci-display" class="display" readonly value="0">
        <div style="margin-top:10px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
          <button class="btn ghost" onclick="sciClear()">C</button>
          <button class="btn ghost" onclick="sciBack()">⌫</button>
          <button class="btn ghost" onclick="sciAppend('(')">(</button>
          <button class="btn ghost" onclick="sciAppend(')')">)</button>
          <button class="btn ghost" onclick="sciAppend('**')">^</button>

          <button class="btn" onclick="sciFunc('sin')">sin</button>
          <button class="btn" onclick="sciFunc('cos')">cos</button>
          <button class="btn" onclick="sciFunc('tan')">tan</button>
          <button class="btn" onclick="sciFunc('sqrt')">√</button>
          <button class="btn" onclick="sciAppend('Math.PI')">π</button>

          <button class="btn" onclick="sciFunc('log')">log</button>
          <button class="btn" onclick="sciFunc('ln')">ln</button>
          <button class="btn" onclick="sciAppend('Math.E')">e</button>
          <button class="btn" onclick="sciFact()">x!</button>
          <button class="btn" onclick="sciAppend('%')">%</button>

          <button class="btn" onclick="sciAppend('7')">7</button>
          <button class="btn" onclick="sciAppend('8')">8</button>
          <button class="btn" onclick="sciAppend('9')">9</button>
          <button class="btn ghost" onclick="sciAppend('/')">/</button>
          <button class="btn ghost" onclick="sciAppend('*')">×</button>

          <button class="btn" onclick="sciAppend('4')">4</button>
          <button class="btn" onclick="sciAppend('5')">5</button>
          <button class="btn" onclick="sciAppend('6')">6</button>
          <button class="btn ghost" onclick="sciAppend('-')">-</button>
          <button class="btn ghost" onclick="sciAppend('+')">+</button>

          <button class="btn" onclick="sciAppend('1')">1</button>
          <button class="btn" onclick="sciAppend('2')">2</button>
          <button class="btn" onclick="sciAppend('3')">3</button>
          <button class="btn" onclick="sciCalculate()" style="grid-column:span 2">=</button>

          <button class="btn" onclick="sciAppend('0')" style="grid-column:span 2">0</button>
          <button class="btn" onclick="sciAppend('.')">.</button>
        </div>
      </section>

      <!-- Currency -->
      <section id="currency" class="panel section" aria-hidden="true">
        <div class="small">Live currency conversion (exchangerate.host)</div>
        <div style="display:grid;grid-template-columns:1fr 180px;gap:8px;margin-top:8px">
          <input id="cur-amount" class="input" type="number" value="1" min="0" step="any">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="convertCurrency()">Convert</button>
            <button class="btn ghost" onclick="swapCurrency()">Swap</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="from-currency" class="input"></select>
          <select id="to-currency" class="input"></select>
        </div>

        <div class="result-box" id="cur-result">Result will appear here</div>
        <div class="small" style="margin-top:6px">If conversion fails, there will be a helpful error message (CORS or network)</div>
      </section>

      <!-- Mileage -->
      <section id="mileage" class="panel section" aria-hidden="true">
        <div class="small">Mileage tracker (saved to Firebase & localStorage)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="vehicle" class="input" placeholder="Vehicle name">
          <input id="odo" class="input" placeholder="Odometer (km)" type="number" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="fuel" class="input" placeholder="Fuel (L)" type="number" step="any">
          <input id="cost" class="input" placeholder="Fuel cost (₹)" type="number" step="any">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="mdate" class="input" type="date" style="flex:1">
          <button class="btn" onclick="addMileage()">Add</button>
          <button class="btn ghost" onclick="clearMileageForm()">Clear</button>
        </div>

        <div class="result-box" id="mileage-summary">No records yet</div>

        <h3 style="margin-top:12px">History</h3>
        <div style="overflow:auto;max-height:220px">
          <table id="mileage-table"><thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Loan -->
      <section id="loan" class="panel section" aria-hidden="true">
        <div class="small">Loan / EMI</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="loan-p" class="input" placeholder="Principal (₹)" type="number" value="100000">
          <input id="loan-r" class="input" placeholder="Annual rate (%)" type="number" value="7.5">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="loan-n" class="input" placeholder="Years" type="number" value="5">
          <button class="btn" onclick="calcLoan()">Calculate</button>
          <button class="btn ghost" onclick="clearLoan()">Clear</button>
        </div>
        <div class="result-box" id="loan-result">EMI result</div>
      </section>

      <!-- Tax -->
      <section id="tax" class="panel section" aria-hidden="true">
        <div class="small">Tax helper (flat & demo slab)</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tax-income" class="input" placeholder="Taxable income" type="number" value="500000">
          <input id="tax-rate" class="input" placeholder="Flat tax rate (%)" type="number" value="10">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="calcTax()">Flat tax</button>
          <button class="btn ghost" onclick="calcTaxSlab()">Slab demo</button>
        </div>
        <div class="result-box" id="tax-result">Tax result</div>
      </section>

      <!-- Date -->
      <section id="date" class="panel section" aria-hidden="true">
        <div class="small">Age, days between and add/subtract days</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="dob" type="date" class="input"><div style="display:flex;gap:8px"><button class="btn" onclick="calcAge()">Age</button><button class="btn ghost" onclick="clearAge()">Clear</button></div>
        </div>
        <div class="result-box" id="age-result">Age result</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="start-date" type="date" class="input"><input id="end-date" type="date" class="input">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="daysBetween()">Days between</button>
          <button class="btn ghost" onclick="clearDates()">Clear</button>
        </div>
        <div class="result-box" id="date-diff-result">Days difference</div>

        <hr style="margin:12px 0">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="base-date" type="date" class="input"><input id="days-add" type="number" class="input" value="0">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="addDays()">Add/Subtract</button><button class="btn ghost" onclick="clearAddDays()">Clear</button>
        </div>
        <div class="result-box" id="add-days-result">Add/Sub result</div>
      </section>

      <!-- Measure -->
      <section id="measure" class="panel section" aria-hidden="true">
        <div class="small">Length, Weight, Temperature conversions</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="measure-type" class="input" onchange="populateUnits()"><option value="length">Length</option><option value="weight">Weight</option><option value="temperature">Temperature</option></select>
          <input id="measure-value" class="input" type="number" value="1" step="any">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <select id="measure-from" class="input"></select>
          <select id="measure-to" class="input"></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="convertMeasure()">Convert</button>
          <button class="btn ghost" onclick="resetMeasure()">Clear</button>
        </div>
        <div class="result-box" id="measure-result">Conversion</div>
      </section>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="small">Recent calculations</div>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" onclick="copyHistory()">Copy</button>
          <button class="btn ghost" onclick="downloadHistory()">Export CSV</button>
          <button class="btn" onclick="resetAll()">Reset</button>
        </div>
      </div>
      <div style="margin-top:8px" class="history" id="history"></div>
    </main>

    <!-- SIDEBAR / LIVE PANEL -->
    <aside class="sidebar" aria-label="Live market data">
      <div class="live-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Snapshot</strong>
          <div class="tiny muted" id="live-updated">--</div>
        </div>

        <div style="margin-top:8px" class="live-grid">
          <div><div class="small muted">USD → INR</div><div id="usd-inr" style="font-weight:800">--</div></div>
          <div><div class="small muted">EUR → USD</div><div id="eur-usd" style="font-weight:800">--</div></div>

          <div><div class="small muted">Gold (XAU/oz)</div><div id="gold" style="font-weight:800">--</div></div>
          <div><div class="small muted">Silver (XAG/oz)</div><div id="silver" style="font-weight:800">--</div></div>

          <div><div class="small muted">Bitcoin (USD)</div><div id="btc" style="font-weight:800">--</div></div>
          <div><div class="small muted">Ethereum (USD)</div><div id="eth" style="font-weight:800">--</div></div>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="refreshLive()">Refresh</button>
          <button class="btn ghost" onclick="toggleAuto()">Auto: <span id="auto-status">ON</span></button>
        </div>

        <div class="tiny muted" style="margin-top:8px">Data sources: exchangerate.host, CoinGecko, GoldPrice (public endpoints).</div>
      </div>

      <div class="live-card">
        <strong>Quick Converter</strong>
        <div style="margin-top:8px">
          <input id="quick-amt" class="input" value="1" type="number" step="any">
          <select id="quick-from" class="input" style="margin-top:6px"></select>
          <select id="quick-to" class="input" style="margin-top:6px"></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="quickConvert()">Convert</button>
            <button class="btn ghost" onclick="fillQuick()">Use main</button>
          </div>
          <div class="result-box" id="quick-result">Quick result</div>
        </div>
      </div>

      <div class="live-card">
        <strong>Mileage Export</strong>
        <div class="small muted" style="margin-top:8px">Export or clear mileage (local fallback)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="exportMileageCSV()">Export CSV</button>
          <button class="btn ghost" onclick="clearMileageStorage()">Clear</button>
        </div>
        <div class="note">If Firestore is accessible you'll see saved records from your Firebase project; otherwise localStorage backup is used.</div>
      </div>
    </aside>
  </div>

  <footer>Open dev console to see detailed errors if any API fails. If CORS errors appear, run a local web server (e.g. <code>python -m http.server 8000</code>) and open the page at <code>http://localhost:8000/</code>.</footer>
</div>

<script type="module">
/* ======================= MODULE SCRIPT - single script only ======================= */
/* Firebase SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ------------------ CONFIG: Use your Firebase config here (you provided it) ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};
/* Initialize Firebase (wrapped in try in case user blocks it) */
let db = null;
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
} catch (e) {
  console.warn('Firebase init failed or blocked:', e);
}

/* ------------------ API endpoints ------------------ */
const API = {
  SYMBOLS: "https://api.exchangerate.host/symbols",
  CONVERT: "https://api.exchangerate.host/convert",
  LATEST: "https://api.exchangerate.host/latest",
  GOLDPRICE: "https://data-asg.goldprice.org/dbXRates/USD",
  COINGECKO_SIMPLE: "https://api.coingecko.com/api/v3/simple/price"
};

/* ------------------ small fetch wrapper ------------------ */
async function fetchJson(url, opts = {}, timeout = 12000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    clearTimeout(id);
    if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
    return await res.json();
  } catch (err) {
    clearTimeout(id);
    throw err;
  }
}

/* ------------------ Tabs switching ------------------ */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    const id = t.dataset.tab;
    const p = document.getElementById(id);
    if (p) p.classList.add('active');
  });
});

/* ------------------ History UI ------------------ */
const historyEl = document.getElementById('history');
function addHistory(txt){
  const el = document.createElement('div'); el.className = 'tiny'; el.textContent = new Date().toLocaleString() + ' — ' + txt;
  historyEl.prepend(el);
  while(historyEl.children.length > 200) historyEl.removeChild(historyEl.lastChild);
}
function copyHistory(){ navigator.clipboard?.writeText(Array.from(historyEl.children).map(c=>c.textContent).join('\n')).then(()=>alert('Copied')) }
function downloadHistory(){
  const rows = [['timestamp','entry']];
  Array.from(historyEl.children).forEach(ch => rows.push([new Date().toISOString(), ch.textContent]));
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'calc_history.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ------------------ STANDARD calculator ------------------ */
let stdVal = '0'; const stdDisplay = document.getElementById('std-display');
function stdUpdate(){ stdDisplay.value = stdVal; }
function stdAppend(v){ if(stdVal==='0' && v!=='.') stdVal = v; else stdVal += v; stdUpdate(); }
function stdClear(){ stdVal = '0'; stdUpdate(); }
function stdBack(){ stdVal = stdVal.length>1 ? stdVal.slice(0,-1) : '0'; stdUpdate(); }
function stdCalculate(){
  try {
    let expr = stdVal.replace(/×/g,'*').replace(/÷/g,'/');
    expr = expr.replace(/(\d+(\.\d+)?)%/g,'($1/100)');
    const res = Function('"use strict";return ('+expr+')')();
    addHistory(`${stdVal} = ${res}`);
    stdVal = String(res); stdUpdate();
  } catch (e) {
    stdVal = 'Error'; stdUpdate();
    setTimeout(()=>{ stdVal='0'; stdUpdate(); },1500);
  }
}

/* ------------------ SCIENTIFIC ------------------ */
let sciVal = '0'; const sciDisplay = document.getElementById('sci-display');
function sciUpdate(){ sciDisplay.value = sciVal; }
function sciAppend(v){ if(sciVal==='0' && v!=='.') sciVal = v; else sciVal += v; sciUpdate(); }
function sciClear(){ sciVal='0'; sciUpdate(); }
function sciBack(){ sciVal = sciVal.length>1 ? sciVal.slice(0,-1) : '0'; sciUpdate(); }
function sciCalculate(){ try { let expr = sciVal.replace(/π/g,'Math.PI').replace(/\^/g,'**'); const res = Function('"use strict";return ('+expr+')')(); addHistory(`${sciVal} = ${res}`); sciVal = String(res); sciUpdate(); } catch(e){ sciVal='Error'; sciUpdate(); setTimeout(()=>sciVal='0',1200); } }
function sciFunc(fn){ try{ let v = parseFloat(sciVal); if(isNaN(v)) v = 0; let r; switch(fn){ case 'sin': r = Math.sin(v*Math.PI/180); break; case 'cos': r = Math.cos(v*Math.PI/180); break; case 'tan': r = Math.tan(v*Math.PI/180); break; case 'sqrt': r = Math.sqrt(v); break; case 'log': r = Math.log10(v); break; case 'ln': r = Math.log(v); break; default: r = v; } addHistory(`${fn}(${v}) = ${r}`); sciVal = String(r); sciUpdate(); }catch(e){ sciVal='Error'; sciUpdate(); } }
function sciFact(){ const n = parseInt(sciVal); if(isNaN(n)||n<0){ sciVal='Error'; sciUpdate(); return; } let r=1; for(let i=2;i<=n;i++) r*=i; addHistory(`${n}! = ${r}`); sciVal = String(r); sciUpdate(); }

/* ------------------ CURRENCY symbols + convert ------------------ */
const fromSelect = document.getElementById('from-currency'), toSelect = document.getElementById('to-currency'), amtInput = document.getElementById('cur-amount');
const quickFrom = document.getElementById('quick-from'), quickTo = document.getElementById('quick-to'), quickAmt = document.getElementById('quick-amt');

async function loadSymbols(){
  try {
    const j = await fetchJson(API.SYMBOLS);
    if(j && j.symbols){
      const codes = Object.keys(j.symbols).sort();
      const html = codes.map(c=>`<option value="${c}">${c}</option>`).join('');
      fromSelect.innerHTML = html; toSelect.innerHTML = html; quickFrom.innerHTML = html; quickTo.innerHTML = html;
      fromSelect.value='USD'; toSelect.value='INR'; quickFrom.value='USD'; quickTo.value='INR';
    } else throw new Error('No symbols');
  } catch (err) {
    console.warn('loadSymbols failed:', err);
    const fallback = ['USD','EUR','GBP','INR','JPY','CAD','AUD'];
    const html = fallback.map(c=>`<option value="${c}">${c}</option>`).join('');
    fromSelect.innerHTML = html; toSelect.innerHTML = html; quickFrom.innerHTML = html; quickTo.innerHTML = html;
    fromSelect.value='USD'; toSelect.value='INR';
  }
}

async function convertCurrency(){
  const amount = parseFloat(amtInput.value);
  const from = fromSelect.value;
  const to = toSelect.value;
  if(isNaN(amount)){ document.getElementById('cur-result').textContent = 'Enter valid amount'; return; }
  document.getElementById('cur-result').textContent = 'Converting…';
  try {
    const url = `${API.CONVERT}?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&amount=${encodeURIComponent(amount)}`;
    const j = await fetchJson(url, {}, 10000);
    if(j && j.result !== undefined){
      document.getElementById('cur-result').innerHTML = `${amount} ${from} = <strong>${Number(j.result).toFixed(4)} ${to}</strong>
        <div class="tiny muted">Rate: 1 ${from} = ${Number(j.info?.rate || (j.result/amount)).toFixed(6)} ${to}</div>`;
      addHistory(`Currency: ${amount} ${from} = ${Number(j.result).toFixed(4)} ${to}`);
      return;
    } else throw new Error('convert endpoint returned no result');
  } catch (err) {
    console.warn('convert endpoint failed, fallback to latest:', err);
    try {
      const j2 = await fetchJson(`${API.LATEST}?base=${encodeURIComponent(from)}&symbols=${encodeURIComponent(to)}`, {}, 10000);
      if(j2 && j2.rates && j2.rates[to] !== undefined){
        const rate = Number(j2.rates[to]);
        const result = amount * rate;
        document.getElementById('cur-result').innerHTML = `${amount} ${from} = <strong>${result.toFixed(4)} ${to}</strong>
          <div class="tiny muted">Rate: 1 ${from} = ${rate.toFixed(6)} ${to} (latest)</div>`;
        addHistory(`Currency (fallback): ${amount} ${from} = ${result.toFixed(4)} ${to}`);
        return;
      } else throw new Error('latest endpoint no rate');
    } catch (err2) {
      console.error('currency fallback failed', err2);
      document.getElementById('cur-result').textContent = 'Conversion failed — network or CORS issue. See console and try running via local server.';
    }
  }
}
function swapCurrency(){ const t = fromSelect.value; fromSelect.value = toSelect.value; toSelect.value = t; }

/* Quick converter */
function fillQuick(){ quickFrom.value = fromSelect.value; quickTo.value = toSelect.value; quickAmt.value = amtInput.value; }
async function quickConvert(){ const a = parseFloat(quickAmt.value); const f = quickFrom.value; const t = quickTo.value; if(isNaN(a)){ alert('Enter amount'); return; } document.getElementById('quick-result').textContent = 'Converting…'; try{ const j = await fetchJson(`${API.CONVERT}?from=${encodeURIComponent(f)}&to=${encodeURIComponent(t)}&amount=${encodeURIComponent(a)}`, {}, 10000); if(j && j.result !== undefined){ document.getElementById('quick-result').innerHTML = `${a} ${f} = <strong>${Number(j.result).toFixed(4)} ${t}</strong>`; addHistory(`Quick: ${a} ${f} => ${Number(j.result).toFixed(4)} ${t}`); } else document.getElementById('quick-result').textContent = 'Conversion failed'; } catch(e){ console.error(e); document.getElementById('quick-result').textContent = 'Error converting (check console)'; } }

/* ------------------ Mileage (Firestore + localStorage fallback) ------------------ */
const mileageKey = 'all_in_one_mileage_v1';
let localRecords = JSON.parse(localStorage.getItem(mileageKey) || '[]');
const mtbody = document.querySelector('#mileage-table tbody');

function renderMileageFromLocal(){
  mtbody.innerHTML = '';
  if(localRecords.length === 0){ document.getElementById('mileage-summary').textContent = 'No local records'; return; }
  localRecords.forEach((r, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.vehicle}</td><td>${r.odo}</td><td>${r.fuel}</td><td>₹${r.cost || '-'}</td><td>${r.mileage || '-'}</td><td><span class="delete" onclick="deleteLocalRecord(${index})">✖</span></td>`;
    mtbody.appendChild(tr);
  });
  const last = localRecords[localRecords.length-1];
  document.getElementById('mileage-summary').innerHTML = `Latest local: <strong>${last.vehicle}</strong> — ${last.mileage || '-'} km/L`;
}

function saveLocalRecord(rec){
  localRecords.push(rec);
  localStorage.setItem(mileageKey, JSON.stringify(localRecords));
  renderMileageFromLocal();
}

function deleteLocalRecord(i){
  if(!confirm('Delete local record?')) return;
  localRecords.splice(i,1);
  localStorage.setItem(mileageKey, JSON.stringify(localRecords));
  renderMileageFromLocal();
  addHistory('Local mileage record deleted');
}

/* Firestore: save & load. If Firestore not available, we use localStorage only. */
async function addMileage(){
  const vehicle = document.getElementById("vehicle").value.trim();
  const odo = parseFloat(document.getElementById("odo").value);
  const fuel = parseFloat(document.getElementById("fuel").value);
  const cost = parseFloat(document.getElementById("cost").value);
  const date = document.getElementById("mdate").value || new Date().toISOString().slice(0,10);

  if (!vehicle || isNaN(odo) || isNaN(fuel) || fuel <= 0){ alert("Enter valid values"); return; }
  // if there's previous record, compute distance and mileage; else store entered odo/fuel ratio as mileage
  let mileageVal = (odo / fuel).toFixed(2);
  const rec = { vehicle, odo, fuel, cost: isNaN(cost)?0:cost, date, mileage: mileageVal, createdAt: new Date().toISOString() };

  // Save to localStorage as a backup
  saveLocalRecord(rec);
  addHistory(`Mileage saved locally: ${vehicle} — ${mileageVal} km/L`);

  if (db) {
    try {
      await addDoc(collection(db, "mileage"), {
        vehicle, odo, fuel, cost: isNaN(cost)?0:cost, mileage: Number(mileageVal), date, createdAt: new Date()
      });
      addHistory('Mileage saved to Firebase');
      // refresh Firestore list to show latest if desired
      await loadMileageFromFirestore();
    } catch (e) {
      console.warn('Failed save to Firestore', e);
    }
  } else {
    console.warn('Firestore not available; data saved to localStorage only.');
  }

  // clear form
  clearMileageForm();
}

async function loadMileageFromFirestore(){
  if (!db) { renderMileageFromLocal(); return; }
  try {
    const q = query(collection(db, "mileage"), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);
    // If there are firestore records display them (and also keep local as fallback)
    const arr = [];
    snap.forEach(s => {
      const d = s.data();
      arr.push({
        id: s.id,
        date: d.date || '',
        vehicle: d.vehicle || '',
        odo: d.odo || '',
        fuel: d.fuel || '',
        cost: d.cost || '',
        mileage: (d.mileage !== undefined) ? Number(d.mileage).toFixed(2) : '-'
      });
    });
    if (arr.length > 0) {
      // Render Firestore records in table
      mtbody.innerHTML = '';
      arr.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.vehicle}</td><td>${r.odo}</td><td>${r.fuel}</td><td>₹${r.cost}</td><td>${r.mileage}</td><td><span class="delete" onclick="deleteMileageFirestore('${r.id}')">✖</span></td>`;
        mtbody.appendChild(tr);
      });
      document.getElementById('mileage-summary').innerHTML = `Latest remote: <strong>${arr[0].vehicle}</strong> — ${arr[0].mileage} km/L`;
      return;
    } else {
      // no firestore data, show local
      renderMileageFromLocal();
    }
  } catch (e) {
    console.error('Failed load firestore mileage', e);
    renderMileageFromLocal();
  }
}

async function deleteMileageFirestore(id){
  if(!confirm('Delete Firestore record?')) return;
  try {
    await deleteDoc(doc(db, "mileage", id));
    addHistory('Deleted remote mileage record');
    await loadMileageFromFirestore();
  } catch (e) {
    console.error('Failed to delete firestore doc', e);
  }
}

function clearMileageForm(){ document.getElementById('vehicle').value=''; document.getElementById('odo').value=''; document.getElementById('fuel').value=''; document.getElementById('cost').value=''; document.getElementById('mdate').value=''; }

/* Local export/clear utilities */
function exportMileageCSV(){
  // prefer firestore if available and loaded, else local
  if (db) {
    // attempt to export localRecords (these include local saves) for simplicity
  }
  const rows=[['date','vehicle','odometer','fuel','cost','mileage']];
  const source = (localRecords.length>0) ? localRecords : [];
  if(source.length===0){ alert('No local mileage to export'); return; }
  source.forEach(r=>rows.push([r.date,r.vehicle,r.odo,r.fuel,r.cost,r.mileage]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'mileage.csv'; a.click(); URL.revokeObjectURL(url);
}
function clearMileageStorage(){ if(!confirm('Clear local mileage storage?')) return; localRecords=[]; localStorage.removeItem(mileageKey); renderMileageFromLocal(); addHistory('Local mileage cleared'); }

/* ------------------ Loan/EMI ------------------ */
function calcLoan(){
  const P = parseFloat(document.getElementById('loan-p').value);
  const rAnnual = parseFloat(document.getElementById('loan-r').value);
  const years = parseFloat(document.getElementById('loan-n').value);
  if(isNaN(P)||isNaN(rAnnual)||isNaN(years)||P<=0){ alert('Invalid loan inputs'); return; }
  const r = rAnnual/100/12; const n = years*12;
  const monthly = r===0 ? P/n : (P*r)/(1-Math.pow(1+r,-n));
  const total = monthly * n; const interest = total - P;
  document.getElementById('loan-result').innerHTML = `Monthly EMI: <strong>₹${monthly.toFixed(2)}</strong><br>Total paid: ₹${total.toFixed(2)} · Interest: ₹${interest.toFixed(2)}`;
  addHistory(`Loan: P=${P} r=${rAnnual}% -> EMI ₹${monthly.toFixed(2)}`);
}
function clearLoan(){ document.getElementById('loan-p').value=''; document.getElementById('loan-r').value=''; document.getElementById('loan-n').value=''; document.getElementById('loan-result').textContent='EMI result'; }

/* ------------------ Tax ------------------ */
function calcTax(){ const income = parseFloat(document.getElementById('tax-income').value); const rate = parseFloat(document.getElementById('tax-rate').value); if(isNaN(income)||isNaN(rate)){ alert('Invalid'); return; } const tax = income * (rate/100); document.getElementById('tax-result').textContent = `Tax: ₹${tax.toFixed(2)} (${rate}%)`; addHistory(`Tax: ${income} @ ${rate}% => ${tax.toFixed(2)}`); }
function calcTaxSlab(){ const income = parseFloat(document.getElementById('tax-income').value)||0; const slabs=[{limit:250000,rate:0},{limit:500000,rate:5},{limit:750000,rate:10},{limit:1000000,rate:15},{limit:Infinity,rate:20}]; let rem=income,lower=0,tax=0; for(const s of slabs){ const amt = Math.max(0, Math.min(rem, s.limit - lower)); if(amt>0) tax+= amt*(s.rate/100); lower=s.limit; rem-=amt; if(rem<=0) break; } document.getElementById('tax-result').textContent = `Estimated slab tax: ₹${tax.toFixed(2)} (demo)`; addHistory(`Tax slab: ${income} => ${tax.toFixed(2)}`); }

/* ------------------ Date utilities ------------------ */
function calcAge(){ const v=document.getElementById('dob').value; if(!v){ alert('Pick DOB'); return; } const b=new Date(v), now=new Date(); if(b>now){ document.getElementById('age-result').textContent='DOB in future'; return; } let y=now.getFullYear()-b.getFullYear(), m=now.getMonth()-b.getMonth(), d=now.getDate()-b.getDate(); if(d<0){ m--; d += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); } if(m<0){ y--; m+=12; } document.getElementById('age-result').textContent = `${y} years, ${m} months, ${d} days`; addHistory(`Age for ${v}: ${y}y ${m}m ${d}d`); }
function clearAge(){ document.getElementById('dob').value=''; document.getElementById('age-result').textContent='Age result'; }
function daysBetween(){ const s=document.getElementById('start-date').value, e=document.getElementById('end-date').value; if(!s||!e){ alert('Pick dates'); return; } const a=new Date(s), b=new Date(e), diff=Math.abs(b-a), days=Math.floor(diff/(1000*60*60*24)); document.getElementById('date-diff-result').textContent = `${days} days`; addHistory(`Days: ${s} ↔ ${e} = ${days}`); }
function clearDates(){ document.getElementById('start-date').value=''; document.getElementById('end-date').value=''; document.getElementById('date-diff-result').textContent='Days difference'; }
function addDays(){ const base=document.getElementById('base-date').value, d=parseInt(document.getElementById('days-add').value,10); if(!base||isNaN(d)){ alert('Pick base & days'); return; } const dt=new Date(base); dt.setDate(dt.getDate()+d); document.getElementById('add-days-result').textContent = dt.toISOString().slice(0,10); addHistory(`AddDays: ${base} + ${d} => ${dt.toISOString().slice(0,10)}`); }
function clearAddDays(){ document.getElementById('base-date').value=''; document.getElementById('days-add').value='0'; document.getElementById('add-days-result').textContent='Add/Sub result'; }

/* ------------------ Measure conversions ------------------ */
const measures = { length:{units:['m','km','cm','mm','in','ft'],conv:{m:1,km:1000,cm:0.01,mm:0.001,in:0.0254,ft:0.3048}}, weight:{units:['kg','g','lb','oz'],conv:{kg:1,g:0.001,lb:0.45359237,oz:0.0283495}}, temperature:{units:['C','F','K']} };
function populateUnits(){ const t=document.getElementById('measure-type').value; const f=document.getElementById('measure-from'), to=document.getElementById('measure-to'); f.innerHTML=''; to.innerHTML=''; if(t==='temperature'){ ['C','F','K'].forEach(u=>{ f.innerHTML += `<option>${u}</option>`; to.innerHTML += `<option>${u}</option>`; }); } else { measures[t].units.forEach(u=>{ f.innerHTML += `<option>${u}</option>`; to.innerHTML += `<option>${u}</option>`; }); } }
function convertMeasure(){ const t=document.getElementById('measure-type').value; const v=parseFloat(document.getElementById('measure-value').value); const from=document.getElementById('measure-from').value, to=document.getElementById('measure-to').value; if(isNaN(v)){ alert('Enter value'); return; } let res=v; if(t==='temperature'){ let c; if(from==='C') c=v; else if(from==='F') c=(v-32)*5/9; else c=v-273.15; if(to==='C') res=c; else if(to==='F') res=c*9/5+32; else res=c+273.15; } else { const conv=measures[t].conv; res = v * conv[from] / conv[to]; } document.getElementById('measure-result').textContent = `${v} ${from} = ${Number(res).toFixed(6)} ${to}`; addHistory(`Measure: ${v}${from} -> ${Number(res).toFixed(6)}${to}`); }
function resetMeasure(){ document.getElementById('measure-value').value='1'; populateUnits(); document.getElementById('measure-result').textContent='Conversion result'; }

/* ------------------ Live data aggregator (rates, gold, crypto) ------------------ */
let auto = true, autoTimer = null;
const autoLabel = document.getElementById('auto-status');

async function refreshLive(){
  document.getElementById('live-updated').textContent = 'Refreshing...';
  try {
    // exchange rates snapshot
    try {
      const cur = await fetchJson(`${API.LATEST}?base=USD&symbols=INR,EUR,GBP,JPY,CAD,AUD`);
      if(cur && cur.rates){
        if(cur.rates.INR) document.getElementById('usd-inr').textContent = '₹' + Number(cur.rates.INR).toFixed(4);
        if(cur.rates.EUR) document.getElementById('eur-usd').textContent = Number(1/(cur.rates.EUR||1)).toFixed(4);
      }
    } catch(e){ console.warn('exchange rate failed', e); }

    // gold & silver from GoldPrice.org (public JSON)
    try {
      const goldJson = await fetchJson(API.GOLDPRICE);
      if(goldJson && goldJson.items && goldJson.items[0]){
        const it = goldJson.items[0];
        if(it.xauPrice !== undefined) document.getElementById('gold').textContent = '$' + Number(it.xauPrice).toFixed(2) + ' / oz';
        if(it.xagPrice !== undefined) document.getElementById('silver').textContent = '$' + Number(it.xagPrice).toFixed(3) + ' / oz';
      }
    } catch (gerr) {
      console.warn('goldprice failed, falling back to CoinGecko token price', gerr);
      try {
        const cgGold = await fetchJson(API.COINGECKO_SIMPLE + '?ids=tether-gold&vs_currencies=usd');
        if(cgGold && cgGold['tether-gold'] && cgGold['tether-gold'].usd) document.getElementById('gold').textContent = '$' + Number(cgGold['tether-gold'].usd).toFixed(2) + ' (token)';
        else document.getElementById('gold').textContent = 'N/A';
        document.getElementById('silver').textContent = 'N/A';
      } catch(e2){
        console.error('both gold endpoints failed', e2);
        document.getElementById('gold').textContent = 'Error';
        document.getElementById('silver').textContent = 'Error';
      }
    }

    // crypto prices (CoinGecko)
    try {
      const cg = await fetchJson(API.COINGECKO_SIMPLE + '?ids=bitcoin,ethereum&vs_currencies=usd');
      if(cg){
        if(cg.bitcoin && cg.bitcoin.usd) document.getElementById('btc').textContent = '$' + Number(cg.bitcoin.usd).toLocaleString();
        if(cg.ethereum && cg.ethereum.usd) document.getElementById('eth').textContent = '$' + Number(cg.ethereum.usd).toLocaleString();
      }
    } catch(e){ console.warn('coingecko crypto failed', e); document.getElementById('btc').textContent = 'N/A'; document.getElementById('eth').textContent = 'N/A'; }

    document.getElementById('live-updated').textContent = new Date().toLocaleTimeString();
  } catch (err) {
    console.error('refreshLive error', err);
    document.getElementById('live-updated').textContent = 'Error';
  }
}

function toggleAuto(){ auto = !auto; autoLabel.textContent = auto ? 'ON' : 'OFF'; if(auto) startAuto(); else stopAuto(); }
function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = setInterval(refreshLive, 60_000); refreshLive(); }
function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = null; }

/* ------------------ Utilities ------------------ */
function resetAll(){ if(!confirm('Reset history and local data?')) return; localStorage.clear(); localRecords=[]; renderMileageFromLocal(); historyEl.innerHTML=''; addHistory('App reset'); }

/* ------------------ Init (on load) ------------------ */
document.addEventListener('DOMContentLoaded', async () => {
  await loadSymbols(); // currency symbols
  populateUnits(); // measurement units
  renderMileageFromLocal(); // show local saved records
  await loadMileageFromFirestore(); // attempt to load firestore records (overwrites local table if remote exists)
  startAuto(); // start live auto refresh
  addHistory('App loaded');
});

/* ------------------ Expose handlers to global scope for HTML inline onclicks ------------------ */
window.stdAppend = stdAppend; window.stdClear = stdClear; window.stdBack = stdBack; window.stdCalculate = stdCalculate;
window.sciAppend = sciAppend; window.sciClear = sciClear; window.sciBack = sciBack; window.sciCalculate = sciCalculate; window.sciFunc = sciFunc; window.sciFact = sciFact;
window.convertCurrency = convertCurrency; window.swapCurrency = swapCurrency; window.fillQuick = fillQuick; window.quickConvert = quickConvert; window.loadSymbols = loadSymbols;
window.addMileage = addMileage; window.clearMileageForm = clearMileageForm; window.exportMileageCSV = exportMileageCSV; window.clearMileageStorage = clearMileageStorage;
window.deleteLocalRecord = deleteLocalRecord; window.deleteMileageFirestore = deleteMileageFirestore;
window.calcLoan = calcLoan; window.clearLoan = clearLoan;
window.calcTax = calcTax; window.calcTaxSlab = calcTaxSlab;
window.calcAge = calcAge; window.clearAge = clearAge; window.daysBetween = daysBetween; window.clearDates = clearDates; window.addDays = addDays; window.clearAddDays = clearAddDays;
window.populateUnits = populateUnits; window.convertMeasure = convertMeasure; window.resetMeasure = resetMeasure;
window.copyHistory = copyHistory; window.downloadHistory = downloadHistory; window.resetAll = resetAll;
window.refreshLive = refreshLive; window.toggleAuto = toggleAuto; window.exportMileageCSV = exportMileageCSV;

</script>
</body>
</html>
