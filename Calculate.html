<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultimate All-in-One Calculator — Live</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* --- (kept styling close to your original, trimmed slightly for readability) --- */
    *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif}
    body{background:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .calculator-container{width:100%;max-width:1200px;background:rgba(255,255,255,0.98);border-radius:16px;box-shadow:0 15px 35px rgba(0,0,0,.25);overflow:hidden}
    .calculator-header{background:linear-gradient(90deg,#2c3e50,#4ca1af);color:#fff;padding:20px;text-align:center}
    .calculator-header h1{font-size:1.6rem;margin-bottom:6px}
    .calculator-body{display:flex;flex-direction:column}
    .mode-selector{display:flex;background:#ecf0f1;border-bottom:1px solid #bdc3c7;overflow:auto}
    .mode-btn{flex:0 0 auto;padding:12px 16px;border:none;background:none;cursor:pointer;font-weight:600;color:#2c3e50;display:flex;gap:8px;align-items:center}
    .mode-btn.active{background:#3498db;color:#fff}
    .calculator-content{display:flex;flex-wrap:wrap;min-height:520px}
    .calculator-main{flex:1 1 700px;padding:20px;background:#fff;min-width:320px}
    .calculator-sidebar{width:320px;padding:20px;background:#f8f9fa;border-left:1px solid #e9ecef;min-width:260px}
    .calculator-panel{display:none}
    .calculator-panel.active{display:block;animation:fadeIn .35s ease}
    .panel-header{font-size:1.1rem;color:#2c3e50;margin-bottom:12px;border-bottom:2px solid #3498db;padding-bottom:8px}
    .input-group{margin-bottom:12px}
    .input-group label{display:block;margin-bottom:6px;font-weight:600;color:#2c3e50}
    .input-group input,.input-group select,.input-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem}
    .btn{padding:10px 14px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{transform:translateY(-2px)}
    .btn-clear{background:#e74c3c}
    .btn-calc{background:#2ecc71}
    .result-box{margin-top:12px;padding:12px;background:#e8f4fc;border-left:4px solid #3498db;border-radius:8px}
    .result-header{font-weight:700;margin-bottom:6px}
    .history{max-height:220px;overflow:auto;padding:6px}
    .history-item{padding:6px;border-bottom:1px solid #eee}
    .small{font-size:.9rem;color:#666}
    .mileage-table{width:100%;border-collapse:collapse;margin-top:12px}
    .mileage-table th,.mileage-table td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
    .delete-btn{color:#e74c3c;cursor:pointer}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @media (max-width:900px){.calculator-content{flex-direction:column}.calculator-sidebar{width:100%;border-left:none;border-top:1px solid #e9ecef}}
  </style>
</head>
<body>
  <div class="calculator-container">
    <div class="calculator-header">
      <h1><i class="fas fa-calculator"></i> Ultimate All-in-One Calculator — Live</h1>
      <div class="small">Standard · Scientific · Currency (live) · Mileage · Loan · Tax · Date & Age tools</div>
    </div>

    <div class="calculator-body">
      <div class="mode-selector" role="tablist" aria-label="Modes">
        <button class="mode-btn active" data-mode="standard"><i class="fas fa-calculator"></i> Standard</button>
        <button class="mode-btn" data-mode="scientific"><i class="fas fa-square-root-alt"></i> Scientific</button>
        <button class="mode-btn" data-mode="currency"><i class="fas fa-exchange-alt"></i> Currency</button>
        <button class="mode-btn" data-mode="mileage"><i class="fas fa-car"></i> Mileage</button>
        <button class="mode-btn" data-mode="loan"><i class="fas fa-home"></i> Loan</button>
        <button class="mode-btn" data-mode="tax"><i class="fas fa-receipt"></i> Tax</button>
        <button class="mode-btn" data-mode="date"><i class="fas fa-calendar"></i> Date & Age</button>
      </div>

      <div class="calculator-content">
        <div class="calculator-main">
          
          <!-- Standard -->
          <section id="standard-panel" class="calculator-panel active">
            <h2 class="panel-header">Standard Calculator</h2>
            <div class="input-group">
              <input id="calc-display" type="text" readonly value="0" style="text-align:right;font-size:1.25rem;background:#f8f9fa">
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
              <button class="btn btn-clear" onclick="clearDisplay()">C</button>
              <button class="btn" onclick="backspace()">⌫</button>
              <button class="btn" onclick="appendToDisplay('%')">%</button>
              <button class="btn" onclick="appendToDisplay('/')">/</button>

              <button class="btn" onclick="appendToDisplay('7')">7</button>
              <button class="btn" onclick="appendToDisplay('8')">8</button>
              <button class="btn" onclick="appendToDisplay('9')">9</button>
              <button class="btn" onclick="appendToDisplay('*')">×</button>

              <button class="btn" onclick="appendToDisplay('4')">4</button>
              <button class="btn" onclick="appendToDisplay('5')">5</button>
              <button class="btn" onclick="appendToDisplay('6')">6</button>
              <button class="btn" onclick="appendToDisplay('-')">-</button>

              <button class="btn" onclick="appendToDisplay('1')">1</button>
              <button class="btn" onclick="appendToDisplay('2')">2</button>
              <button class="btn" onclick="appendToDisplay('3')">3</button>
              <button class="btn" onclick="appendToDisplay('+')">+</button>

              <button class="btn" onclick="appendToDisplay('0')" style="grid-column:span 2">0</button>
              <button class="btn" onclick="appendToDisplay('.')">.</button>
              <button class="btn btn-calc" onclick="calculate()">=</button>
            </div>
          </section>

          <!-- Scientific -->
          <section id="scientific-panel" class="calculator-panel">
            <h2 class="panel-header">Scientific Calculator</h2>
            <div class="input-group">
              <input id="sci-display" type="text" readonly value="0" style="text-align:right;font-size:1.25rem;background:#f8f9fa">
            </div>
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
              <button class="btn btn-clear" onclick="clearSciDisplay()">C</button>
              <button class="btn" onclick="sciBackspace()">⌫</button>
              <button class="btn" onclick="appendToSciDisplay('(')">(</button>
              <button class="btn" onclick="appendToSciDisplay(')')">)</button>
              <button class="btn" onclick="appendToSciDisplay('**')">^</button>

              <button class="btn" onclick="calculateFunction('sin')">sin</button>
              <button class="btn" onclick="calculateFunction('cos')">cos</button>
              <button class="btn" onclick="calculateFunction('tan')">tan</button>
              <button class="btn" onclick="calculateFunction('sqrt')">√</button>
              <button class="btn" onclick="appendToSciDisplay('Math.PI')">π</button>

              <button class="btn" onclick="calculateFunction('log')">log</button>
              <button class="btn" onclick="calculateFunction('ln')">ln</button>
              <button class="btn" onclick="appendToSciDisplay('Math.E')">e</button>
              <button class="btn" onclick="factorial()">x!</button>
              <button class="btn" onclick="appendToSciDisplay('%')">%</button>

              <button class="btn" onclick="appendToSciDisplay('7')">7</button>
              <button class="btn" onclick="appendToSciDisplay('8')">8</button>
              <button class="btn" onclick="appendToSciDisplay('9')">9</button>
              <button class="btn" onclick="appendToSciDisplay('/')">/</button>
              <button class="btn" onclick="appendToSciDisplay('*')">×</button>

              <button class="btn" onclick="appendToSciDisplay('4')">4</button>
              <button class="btn" onclick="appendToSciDisplay('5')">5</button>
              <button class="btn" onclick="appendToSciDisplay('6')">6</button>
              <button class="btn" onclick="appendToSciDisplay('-')">-</button>
              <button class="btn" onclick="appendToSciDisplay('+')">+</button>

              <button class="btn" onclick="appendToSciDisplay('1')">1</button>
              <button class="btn" onclick="appendToSciDisplay('2')">2</button>
              <button class="btn" onclick="appendToSciDisplay('3')">3</button>
              <button class="btn btn-calc" onclick="calculateScientific()" style="grid-column:span 2">=</button>

              <button class="btn" onclick="appendToSciDisplay('0')" style="grid-column:span 2">0</button>
              <button class="btn" onclick="appendToSciDisplay('.')">.</button>
            </div>
          </section>

          <!-- Currency -->
          <section id="currency-panel" class="calculator-panel">
            <h2 class="panel-header">Currency Converter (live)</h2>
            <div class="input-group">
              <label>Amount</label>
              <input id="amount" type="number" value="1" min="0" step="any">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group">
                <label>From</label>
                <select id="from-currency"></select>
              </div>
              <div class="input-group">
                <label>To</label>
                <select id="to-currency"></select>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="btn btn-calc" onclick="convertCurrencyLive()"><i class="fas fa-exchange-alt"></i> Convert</button>
              <button class="btn" onclick="swapCurrencies()">Swap</button>
              <button class="btn btn-clear" onclick="clearCurrency()">Clear</button>
            </div>
            <div class="result-box" id="currency-result">
              <div class="result-header">Conversion Result</div>
              <div id="conversion-result">Enter values and press Convert</div>
              <div class="small" style="margin-top:8px">Rates provided by exchangerate.host (free API).</div>
            </div>
          </section>

          <!-- Mileage -->
          <section id="mileage-panel" class="calculator-panel">
            <h2 class="panel-header">Mileage Tracker</h2>
            <div class="input-group"><label>Vehicle</label><input id="vehicle-name" placeholder="Car / Bike"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Odometer (km)</label><input id="odometer" type="number" step="any"></div>
              <div class="input-group"><label>Fuel (L)</label><input id="fuel-amount" type="number" step="any"></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Fuel Cost (₹)</label><input id="fuel-cost" type="number" step="any"></div>
              <div class="input-group"><label>Date</label><input id="mileage-date" type="date"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-calc" onclick="addMileageRecord()"><i class="fas fa-save"></i> Add Record</button>
              <button class="btn" onclick="exportMileage()">Export CSV</button>
            </div>
            <div class="result-box">
              <div class="result-header">Mileage</div>
              <div id="mileage-result">Add records to calculate mileage</div>
            </div>

            <h3 style="margin-top:12px">History</h3>
            <table class="mileage-table">
              <thead><tr><th>Date</th><th>Vehicle</th><th>Odo</th><th>Fuel</th><th>Cost</th><th>Mileage</th><th>Action</th></tr></thead>
              <tbody id="mileage-history"></tbody>
            </table>
          </section>

          <!-- Loan -->
          <section id="loan-panel" class="calculator-panel">
            <h2 class="panel-header">Loan Calculator</h2>
            <div class="input-group"><label>Loan Amount (principal)</label><input id="loan-principal" type="number" value="100000" step="any"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Annual Interest Rate (%)</label><input id="loan-rate" type="number" value="7.5" step="any"></div>
              <div class="input-group"><label>Term (years)</label><input id="loan-years" type="number" value="5" step="any"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-calc" onclick="calculateLoan()">Calculate</button>
              <button class="btn" onclick="clearLoan()">Clear</button>
            </div>
            <div class="result-box">
              <div class="result-header">Loan Result</div>
              <div id="loan-result">Monthly payment, total paid and interest will appear here.</div>
            </div>
          </section>

          <!-- Tax -->
          <section id="tax-panel" class="calculator-panel">
            <h2 class="panel-header">Tax Calculator (simple)</h2>
            <div class="input-group"><label>Taxable Income</label><input id="tax-income" type="number" value="500000" step="any"></div>
            <div class="input-group"><label>Tax Rate (%) <span class="small">(flat rate)</span></label><input id="tax-rate" type="number" value="10" step="any"></div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-calc" onclick="calculateTax()">Compute</button>
              <button class="btn" onclick="fillIndianSlabs()">Fill example slabs (India)</button>
            </div>
            <div class="result-box">
              <div class="result-header">Tax Result</div>
              <div id="tax-result">Tax amount will show here.</div>
            </div>
            <div style="margin-top:10px" class="small">
              This is a flexible helper. If you want country-specific progressive slab logic added, I can add that next.
            </div>
          </section>

          <!-- Date & Age -->
          <section id="date-panel" class="calculator-panel">
            <h2 class="panel-header">Date Tools — Age, Difference, Add/Subtract Days</h2>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Date of Birth (Age)</label><input id="dob" type="date"></div>
              <div style="display:flex;align-items:end;gap:8px">
                <button class="btn btn-calc" onclick="calculateAge()">Calculate Age</button>
                <button class="btn" onclick="clearAge()">Clear</button>
              </div>
            </div>
            <div class="result-box"><div id="age-result">Age will appear here</div></div>

            <hr style="margin:12px 0">

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Start Date</label><input id="date-start" type="date"></div>
              <div class="input-group"><label>End Date</label><input id="date-end" type="date"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-calc" onclick="dateDifference()">Days Between</button>
              <button class="btn" onclick="clearDateDiff()">Clear</button>
            </div>
            <div class="result-box"><div id="date-diff-result">Difference result here</div></div>

            <hr style="margin:12px 0">

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div class="input-group"><label>Base Date</label><input id="base-date" type="date"></div>
              <div class="input-group"><label>Days to Add/Subtract</label><input id="days-add" type="number" value="0"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-calc" onclick="addDaysToDate()">Add / Subtract</button>
              <button class="btn" onclick="clearAddDays()">Clear</button>
            </div>
            <div class="result-box"><div id="add-days-result">Add / subtract result here</div></div>
          </section>

        </div>

        <!-- Sidebar -->
        <aside class="calculator-sidebar">
          <div class="sidebar-widget" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 class="widget-title">Live Rates</h3>
              <button class="btn" onclick="loadSymbols()">Refresh</button>
            </div>
            <div id="sidebar-rates" class="small">Base: USD · Loading...</div>
            <div class="small" style="margin-top:8px">Live rates come from exchangerate.host (free). :contentReference[oaicite:1]{index=1}</div>
          </div>

          <div class="sidebar-widget" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 class="widget-title">Recent Calculations</h3>
              <button class="btn" onclick="clearHistory()">Clear</button>
            </div>
            <div id="calculation-history" class="history"><div class="small">No calculations yet</div></div>
          </div>

          <div class="sidebar-widget">
            <h3 class="widget-title">Quick Helpers</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button class="btn" onclick="copyHistory()">Copy History</button>
              <button class="btn" onclick="downloadCSV()">Download History CSV</button>
              <button class="btn" onclick="resetAll()">Reset All</button>
            </div>
          </div>
        </aside>

      </div>
    </div>
  </div>

<script>
/* ----------------- Mode switching ----------------- */
document.querySelectorAll('.mode-btn').forEach(btn=>{
  btn.addEventListener('click', function(){
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
    this.classList.add('active');
    const mode = this.dataset.mode;
    document.querySelectorAll('.calculator-panel').forEach(p=>p.classList.remove('active'));
    const panel = document.getElementById(mode+'-panel');
    if(panel) panel.classList.add('active');
  });
});

/* ----------------- Utilities & history ----------------- */
const historyEl = document.getElementById('calculation-history');
function addToHistory(text){
  const item = document.createElement('div');
  item.className = 'history-item';
  item.textContent = text;
  historyEl.prepend(item);
  // limit
  while(historyEl.childElementCount > 50) historyEl.removeChild(historyEl.lastChild);
}
function clearHistory(){ historyEl.innerHTML = '<div class="small">No calculations yet</div>'; }

/* export/download history */
function downloadCSV(){
  const rows = [['Timestamp','Calculation']];
  Array.from(historyEl.children).forEach(ch=>{
    rows.push([new Date().toISOString(), ch.textContent.replace(/,/g,'')]);
  });
  const csv = rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'calculator_history.csv'; a.click();
  URL.revokeObjectURL(url);
}
function copyHistory(){
  const txt = Array.from(historyEl.children).map(c=>c.textContent).join('\n');
  navigator.clipboard?.writeText(txt).then(()=>alert('History copied to clipboard')).catch(()=>alert('Copy failed'));
}

/* --------------- Standard Calculator -------------- */
let displayValue = '0';
const calcDisplay = document.getElementById('calc-display');
function updateDisplay(){ calcDisplay.value = displayValue; }
function appendToDisplay(value){
  if(displayValue === '0' && value !== '.') displayValue = value;
  else displayValue += value;
  updateDisplay();
}
function clearDisplay(){ displayValue='0'; updateDisplay(); }
function backspace(){ displayValue = displayValue.length>1 ? displayValue.slice(0,-1) : '0'; updateDisplay(); }
function calculate(){
  try{
    // safe-ish eval: replace × with * and handle % as modulus of 100
    let expr = displayValue.replace(/×/g,'*').replace(/÷/g,'/');
    // Allow simple percent: "50%" -> "(50/100)"
    expr = expr.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
    const result = Function('"use strict";return (' + expr + ')')();
    addToHistory(`${displayValue} = ${result}`);
    displayValue = (result === undefined ? '0' : result.toString());
    updateDisplay();
  }catch(e){
    displayValue='Error'; updateDisplay();
    setTimeout(()=>{ displayValue='0'; updateDisplay(); },1500);
  }
}

/* --------------- Scientific Calculator -------------- */
let sciDisplayValue = '0';
const sciDisplay = document.getElementById('sci-display');
function updateSciDisplay(){ sciDisplay.value = sciDisplayValue; }
function appendToSciDisplay(v){
  if(sciDisplayValue==='0' && v!=='.') sciDisplayValue = v;
  else sciDisplayValue += v;
  updateSciDisplay();
}
function clearSciDisplay(){ sciDisplayValue='0'; updateSciDisplay(); }
function sciBackspace(){ sciDisplayValue = sciDisplayValue.length>1 ? sciDisplayValue.slice(0,-1) : '0'; updateSciDisplay(); }
function calculateScientific(){
  try{
    let expr = sciDisplayValue.replace(/π/g, 'Math.PI').replace(/e/g,'Math.E').replace(/\^/g,'**');
    // allow Math.* usage too
    const result = Function('"use strict";return ('+expr+')')();
    addToHistory(`${sciDisplayValue} = ${result}`);
    sciDisplayValue = String(result);
    updateSciDisplay();
  }catch(e){ sciDisplayValue='Error'; updateSciDisplay(); setTimeout(()=>sciDisplayValue='0',1200); }
}
function calculateFunction(func){
  try{
    let val = parseFloat(sciDisplayValue);
    if(isNaN(val)) val = 0;
    let res;
    switch(func){
      case 'sin': res = Math.sin(val*Math.PI/180); break;
      case 'cos': res = Math.cos(val*Math.PI/180); break;
      case 'tan': res = Math.tan(val*Math.PI/180); break;
      case 'sqrt': res = Math.sqrt(val); break;
      case 'log': res = Math.log10(val); break;
      case 'ln': res = Math.log(val); break;
      default: res = val;
    }
    addToHistory(`${func}(${val}) = ${res}`);
    sciDisplayValue = String(res); updateSciDisplay();
  }catch(e){ sciDisplayValue='Error'; updateSciDisplay(); }
}
function factorial(){
  const n = parseInt(sciDisplayValue);
  if(isNaN(n) || n<0){ sciDisplayValue='Error'; updateSciDisplay(); return; }
  let res = 1; for(let i=2;i<=n;i++) res *= i;
  addToHistory(`${n}! = ${res}`);
  sciDisplayValue = String(res); updateSciDisplay();
}

/* ---------------- Currency (live via exchangerate.host) ----------------
   Using exchangerate.host endpoints:
   - /symbols to get supported currency codes
   - /convert?from=USD&to=INR&amount=1 for live conversion
   Docs: https://exchangerate.host/documentation
*/
const SYMBOLS_URL = 'https://api.exchangerate.host/symbols';
const CONVERT_URL = 'https://api.exchangerate.host/convert';
const LATEST_URL  = 'https://api.exchangerate.host/latest';

const fromSelect = document.getElementById('from-currency');
const toSelect   = document.getElementById('to-currency');
const sidebarRates = document.getElementById('sidebar-rates');

async function loadSymbols(){
  sidebarRates.textContent = 'Loading symbols...';
  try{
    const res = await fetch(SYMBOLS_URL);
    const j = await res.json();
    if(j && j.symbols){
      const codes = Object.keys(j.symbols).sort();
      populateCurrencySelects(codes);
      sidebarRates.textContent = 'Base: USD · Rates loaded';
      // also fetch a small sample of rates to show
      const sample = await fetch(LATEST_URL + '?base=USD&symbols=EUR,INR,GBP,JPY,CAD');
      const sjson = await sample.json();
      if(sjson && sjson.rates){
        const html = Object.entries(sjson.rates).map(([k,v])=>`${k}: ${Number(v).toFixed(4)}`).join(' · ');
        sidebarRates.textContent = 'Base USD · ' + html + ' · Updated: ' + sjson.date;
      }
    } else {
      sidebarRates.textContent = 'Symbols not available';
    }
  }catch(err){
    sidebarRates.textContent = 'Failed to load symbols';
    console.error(err);
  }
}

function populateCurrencySelects(codes){
  const fill = (select, defaultCode) => {
    select.innerHTML = codes.map(c=>`<option value="${c}" ${c===defaultCode?'selected':''}>${c}</option>`).join('');
  };
  fill(fromSelect,'USD'); fill(toSelect,'INR');
}

async function convertCurrencyLive(){
  const amount = parseFloat(document.getElementById('amount').value);
  const from = fromSelect.value;
  const to = toSelect.value;
  if(isNaN(amount) || amount<=0){ document.getElementById('conversion-result').innerHTML = '<span style="color:#e74c3c">Enter valid amount</span>'; return; }
  document.getElementById('conversion-result').textContent = 'Converting...';
  try{
    // call convert endpoint
    const q = `${CONVERT_URL}?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&amount=${encodeURIComponent(amount)}`;
    const r = await fetch(q);
    const j = await r.json();
    if(j && j.result !== undefined){
      const result = Number(j.result);
      document.getElementById('conversion-result').innerHTML = `${amount} ${from} = <strong class="result-value">${result.toFixed(4)} ${to}</strong>
        <div class="small" style="margin-top:8px">Rate: 1 ${from} = ${Number(j.info?.rate || (result/amount)).toFixed(6)} ${to}</div>
        <div class="small">Updated: ${j.date || new Date().toISOString().split('T')[0]}</div>`;
      addToHistory(`Currency: ${amount} ${from} = ${result.toFixed(4)} ${to}`);
    } else {
      document.getElementById('conversion-result').textContent = 'Conversion failed';
    }
  }catch(e){
    document.getElementById('conversion-result').textContent = 'Error fetching rates';
    console.error(e);
  }
}

function swapCurrencies(){
  const a = fromSelect.value; fromSelect.value = toSelect.value; toSelect.value = a;
}
function clearCurrency(){
  document.getElementById('amount').value = 1;
  document.getElementById('conversion-result').textContent = 'Enter values and press Convert';
}

/* ---------------- Mileage ---------------- */
let mileageRecords = [];
const mileageHistory = document.getElementById('mileage-history');
document.getElementById('mileage-date').value = new Date().toISOString().split('T')[0];

function addMileageRecord(){
  const vehicle = document.getElementById('vehicle-name').value.trim();
  const odometer = parseFloat(document.getElementById('odometer').value);
  const fuel = parseFloat(document.getElementById('fuel-amount').value);
  const cost = parseFloat(document.getElementById('fuel-cost').value);
  const date = document.getElementById('mileage-date').value || new Date().toISOString().split('T')[0];

  if(!vehicle || isNaN(odometer) || isNaN(fuel) || fuel <= 0 || isNaN(cost)){
    alert('Please provide valid values for all fields');
    return;
  }

  let mileage = 0, costPerKm = 0;
  if(mileageRecords.length > 0){
    const last = mileageRecords[mileageRecords.length-1];
    const distance = odometer - Number(last.odometer);
    if(distance > 0){
      mileage = distance / fuel;
      costPerKm = cost / distance;
    } else {
      mileage = 0;
      costPerKm = 0;
    }
  } else {
    mileage = 0;
    costPerKm = 0;
  }

  const rec = {vehicle,odometer,fuel,cost,date,mileage: Number(mileage).toFixed(2),costPerKm: Number(costPerKm).toFixed(2)};
  mileageRecords.push(rec);
  updateMileageTable();
  updateMileageResult();
  addToHistory(`Mileage: ${vehicle} - ${rec.mileage} km/L`);
  // clear inputs
  document.getElementById('vehicle-name').value=''; document.getElementById('odometer').value=''; document.getElementById('fuel-amount').value=''; document.getElementById('fuel-cost').value='';
}

function updateMileageTable(){
  mileageHistory.innerHTML = '';
  mileageRecords.slice().reverse().forEach((r,i)=>{
    const row = document.createElement('tr');
    const idx = mileageRecords.length - 1 - i;
    row.innerHTML = `<td>${r.date}</td><td>${r.vehicle}</td><td>${r.odometer}</td><td>${r.fuel}</td><td>₹${r.cost}</td><td>${r.mileage} km/L</td>
      <td><span class="delete-btn" onclick="deleteMileageRecord(${idx})"><i class="fas fa-trash"></i></span></td>`;
    mileageHistory.appendChild(row);
  });
}

function updateMileageResult(){
  if(mileageRecords.length===0){ document.getElementById('mileage-result').textContent='Add records to calculate mileage'; return; }
  const last = mileageRecords[mileageRecords.length-1];
  document.getElementById('mileage-result').innerHTML = `Current Mileage: <strong>${last.mileage} km/L</strong><br>Cost per km: <strong>₹${last.costPerKm}</strong>`;
}

function deleteMileageRecord(index){
  mileageRecords.splice(index,1);
  updateMileageTable(); updateMileageResult();
}

function exportMileage(){
  if(mileageRecords.length===0) { alert('No records'); return; }
  const rows = [['Date','Vehicle','Odometer','Fuel','Cost','Mileage','CostPerKm']];
  mileageRecords.forEach(r => rows.push([r.date,r.vehicle,r.odometer,r.fuel,r.cost,r.mileage,r.costPerKm]));
  const csv = rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='mileage.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ---------------- Loan ---------------- */
function calculateLoan(){
  const P = parseFloat(document.getElementById('loan-principal').value);
  const annualRate = parseFloat(document.getElementById('loan-rate').value);
  const years = parseFloat(document.getElementById('loan-years').value);
  if(isNaN(P) || isNaN(annualRate) || isNaN(years) || P<=0){ alert('Enter valid loan data'); return; }
  const r = annualRate / 100 / 12; // monthly rate
  const n = years * 12; // months
  const monthly = (r===0) ? P / n : (P * r) / (1 - Math.pow(1 + r, -n));
  const total = monthly * n;
  const interest = total - P;
  document.getElementById('loan-result').innerHTML = `
    Monthly payment: <strong>₹${monthly.toFixed(2)}</strong><br>
    Total paid: <strong>₹${total.toFixed(2)}</strong><br>
    Total interest: <strong>₹${interest.toFixed(2)}</strong>`;
  addToHistory(`Loan: P=${P}, r=${annualRate}%, years=${years} -> EMI=${monthly.toFixed(2)}`);
}

function clearLoan(){ document.getElementById('loan-principal').value=''; document.getElementById('loan-rate').value=''; document.getElementById('loan-years').value=''; document.getElementById('loan-result').textContent='Monthly payment, total paid and interest will appear here.'; }

/* ---------------- Tax ---------------- */
function calculateTax(){
  const income = parseFloat(document.getElementById('tax-income').value);
  const rate = parseFloat(document.getElementById('tax-rate').value);
  if(isNaN(income) || isNaN(rate)){ alert('Enter valid values'); return; }
  const tax = income * (rate/100);
  document.getElementById('tax-result').innerHTML = `Tax = <strong>₹${tax.toFixed(2)}</strong> (${rate}% of ${income})`;
  addToHistory(`Tax: Income=${income} @ ${rate}% => ${tax.toFixed(2)}`);
}

/* Example helper to fill Indian-like slabs (very simplified demo) */
function fillIndianSlabs(){
  // This simply demonstrates a progressive example: not official tax rules
  const income = parseFloat(document.getElementById('tax-income').value) || 0;
  let tax = 0;
  // sample brackets
  const slabs = [
    {limit:250000, rate:0},
    {limit:500000, rate:5},
    {limit:750000, rate:10},
    {limit:1000000, rate:15},
    {limit:Infinity, rate:20}
  ];
  let remaining = income;
  let lower = 0;
  for(const s of slabs){
    const slabAmount = Math.max(0, Math.min(remaining, s.limit - lower));
    if(slabAmount>0) tax += slabAmount * (s.rate/100);
    lower = s.limit;
    remaining -= slabAmount;
    if(remaining<=0) break;
  }
  document.getElementById('tax-result').innerHTML = `Estimated slab tax (example): <strong>₹${tax.toFixed(2)}</strong>`;
  addToHistory(`Tax (slab estimate): Income=${income} => ${tax.toFixed(2)}`);
}

/* ---------------- Date & Age ---------------- */
function calculateAge(){
  const dob = document.getElementById('dob').value;
  if(!dob){ alert('Select date of birth'); return; }
  const now = new Date();
  const b = new Date(dob);
  if(b>now){ document.getElementById('age-result').textContent='DOB is in the future'; return; }
  let years = now.getFullYear() - b.getFullYear();
  let months = now.getMonth() - b.getMonth();
  let days = now.getDate() - b.getDate();
  if(days < 0){ months -= 1; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
  if(months < 0){ years -= 1; months += 12; }
  document.getElementById('age-result').innerHTML = `Age: <strong>${years} yrs</strong>, ${months} mos, ${days} days`;
  addToHistory(`Age calc: DOB ${dob} => ${years}y ${months}m ${days}d`);
}
function clearAge(){ document.getElementById('dob').value=''; document.getElementById('age-result').textContent='Age will appear here'; }

function dateDifference(){
  const s = document.getElementById('date-start').value;
  const e = document.getElementById('date-end').value;
  if(!s || !e){ alert('Select both dates'); return; }
  const a = new Date(s); const b = new Date(e);
  const diff = Math.abs(b - a);
  const days = Math.floor(diff / (1000*60*60*24));
  document.getElementById('date-diff-result').innerHTML = `Difference: <strong>${days}</strong> days`;
  addToHistory(`Date diff: ${s} ↔ ${e} = ${days} days`);
}
function clearDateDiff(){ document.getElementById('date-start').value=''; document.getElementById('date-end').value=''; document.getElementById('date-diff-result').textContent='Difference result here'; }

function addDaysToDate(){
  const base = document.getElementById('base-date').value;
  const days = parseInt(document.getElementById('days-add').value,10);
  if(!base || isNaN(days)){ alert('Select base date and number of days (can be negative)'); return; }
  const d = new Date(base);
  d.setDate(d.getDate() + days);
  document.getElementById('add-days-result').innerHTML = `Result: <strong>${d.toISOString().slice(0,10)}</strong>`;
  addToHistory(`AddDays: ${base} + ${days}d => ${d.toISOString().slice(0,10)}`);
}
function clearAddDays(){ document.getElementById('base-date').value=''; document.getElementById('days-add').value='0'; document.getElementById('add-days-result').textContent='Add / subtract result here'; }

/* ---------------- Misc helpers ---------------- */
function resetAll(){
  if(!confirm('Reset all stored data and history?')) return;
  clearHistory();
  mileageRecords = [];
  updateMileageTable();
  updateMileageResult();
  clearDisplay(); clearSciDisplay();
  document.getElementById('conversion-result').textContent='Enter values and press Convert';
  addToHistory('Reset all');
}

/* ---------------- Init: load symbols + seed sample data --------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  loadSymbols();
  // seed sample mileage & history
  mileageRecords = [
    {vehicle:'Honda City',odometer:15000,fuel:40,cost:3200,date:'2023-06-15',mileage:'15.00',costPerKm:'2.13'},
    {vehicle:'Honda City',odometer:15500,fuel:32.9,cost:2632,date:'2023-06-30',mileage:'15.2',costPerKm:'2.11'}
  ];
  updateMileageTable(); updateMileageResult();
  addToHistory('App loaded');
  addToHistory('Sample: Mileage & Currency (live)');
});

/* ----------------- End of script ----------------- */
</script>
</body>
</html>
