<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Document Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --invoice-primary: #4361ee;
            --invoice-secondary: #3a0ca3;
            --invoice-accent: #4cc9f0;
            --invoice-light: rgba(67, 97, 238, 0.1);
            
            --receipt-primary: #2a9d8f;
            --receipt-secondary: #264653;
            --receipt-accent: #e9c46a;
            --receipt-light: rgba(42, 157, 143, 0.1);
            
            --voucher-primary: #f72585;
            --voucher-secondary: #7209b7;
            --voucher-accent: #ffb4a2;
            --voucher-light: rgba(247, 37, 133, 0.1);
            
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #4bb543;
            --warning: #ffcc00;
            --danger: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #4361ee;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background-color: #4361ee;
        }
        
        .btn-primary:hover {
            background-color: #3a0ca3;
        }
        
        .btn-success {
            background-color: #2a9d8f;
        }
        
        .btn-success:hover {
            background-color: #21867a;
        }
        
        .btn-danger {
            background-color: #f72585;
        }
        
        .btn-danger:hover {
            background-color: #d41a70;
        }
        
        .document-type {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .doc-type-btn {
            flex: 1;
            text-align: center;
            padding: 1.5rem;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .doc-type-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .doc-type-btn.active {
            border-color: #4361ee;
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .doc-type-btn i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .invoice-active {
            color: var(--invoice-primary);
        }
        
        .receipt-active {
            color: var(--receipt-primary);
        }
        
        .voucher-active {
            color: var(--voucher-primary);
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .items-table th, .items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .items-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .tax-summary {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid #ddd;
        }
        
        .tax-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        
        .tax-row.total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .preview-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }
        
        .document-preview {
            border: 1px solid #ddd;
            padding: 2rem;
            min-height: 400px;
            background: white;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .company-info h2 {
            color: var(--invoice-primary);
            margin-bottom: 0.5rem;
        }
        
        .document-title {
            text-align: center;
            margin: 2rem 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 5px;
        }
        
        .invoice-title {
            background-color: var(--invoice-light);
            color: var(--invoice-primary);
        }
        
        .receipt-title {
            background-color: var(--receipt-light);
            color: var(--receipt-primary);
        }
        
        .voucher-title {
            background-color: var(--voucher-light);
            color: var(--voucher-primary);
        }
        
        .document-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .client-info {
            width: 48%;
        }
        
        .document-info {
            width: 48%;
            text-align: right;
        }
        
        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            background: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .add-item-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .document-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border-top: 4px solid #4361ee;
        }
        
        .document-card:hover {
            transform: translateY(-5px);
        }
        
        .document-card.invoice {
            border-top-color: var(--invoice-primary);
        }
        
        .document-card.receipt {
            border-top-color: var(--receipt-primary);
        }
        
        .document-card.voucher {
            border-top-color: var(--voucher-primary);
        }
        
        .document-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .document-card p {
            margin-bottom: 5px;
            color: #666;
        }
        
        .document-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .create-new-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px dashed #ddd;
        }
        
        .create-new-btn:hover {
            transform: translateY(-5px);
            border-color: #4361ee;
        }
        
        .create-new-btn i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #4361ee;
        }
        
        .create-new-btn h3 {
            color: #333;
        }
        
        .hidden {
            display: none;
        }
        
        /* New styles for bank details and QR code */
        .bank-details-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--invoice-primary);
        }
        
        .bank-details-section h3 {
            margin-bottom: 1rem;
            color: var(--invoice-primary);
        }
        
        .bank-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .qr-code-container {
            margin-top: 1.5rem;
            text-align: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .qr-code-placeholder {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border: 1px dashed #ddd;
            color: #999;
            font-size: 0.9rem;
            text-align: center;
        }
        
        #qrCodeCanvas {
            max-width: 150px;
            margin: 0 auto;
            display: block;
        }
        
        .internal-notes {
            background-color: #fff3cd;
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid #ffc107;
        }
        
        .internal-notes h3 {
            color: #856404;
            margin-bottom: 0.5rem;
        }
        
        .payment-options {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        .bank-details-preview {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .bank-details-preview h4 {
            margin-bottom: 0.5rem;
            color: var(--invoice-primary);
        }
        
        .my-details-section {
            background-color: #e8f5e9;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid #4caf50;
        }
        
        .my-details-section h3 {
            margin-bottom: 1rem;
            color: #2e7d32;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }
        
        .auth-tab.active {
            border-bottom: 2px solid #4361ee;
            color: #4361ee;
            font-weight: bold;
        }
        
        /* Document-specific styles */
        .invoice-preview {
            border-left: 5px solid var(--invoice-primary);
        }
        
        .receipt-preview {
            border-left: 5px solid var(--receipt-primary);
        }
        
        .voucher-preview {
            border-left: 5px solid var(--voucher-primary);
        }
        
        .receipt-stamp {
            position: absolute;
            right: 50px;
            top: 150px;
            transform: rotate(15deg);
            border: 3px solid var(--receipt-primary);
            padding: 10px 20px;
            color: var(--receipt-primary);
            font-weight: bold;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .voucher-code {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(45deg, var(--voucher-primary), var(--voucher-secondary));
            color: white;
            border-radius: 8px;
        }
        
        .terms-conditions {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .document-type {
                flex-direction: column;
            }
            
            .document-details {
                flex-direction: column;
            }
            
            .client-info, .document-info {
                width: 100%;
                text-align: left;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .bank-details-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-options {
                flex-direction: column;
                gap: 1rem;
            }
            
            .receipt-stamp {
                position: static;
                transform: none;
                margin: 20px auto;
                text-align: center;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Section -->
        <div id="authSection">
            <div class="auth-container">
                <h2>Authentication Required</h2>
                <p>You need to be logged in to access this page.</p>
                <button id="redirectToLogin" class="btn btn-primary">Go to Login Page</button>
            </div>
        </div>
        
        <!-- App Content (hidden until authenticated) -->
        <div id="appContent" class="hidden">
            <header>
                <h1>Professional Document Generator</h1>
                <p>Create invoices, receipts, and vouchers with ease</p>
                <button id="signOutBtn" class="btn" style="margin-top: 1rem;">Sign Out</button>
            </header>
            
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="card">
                    <h2>Your Documents</h2>
                    <div class="dashboard" id="documentsDashboard">
                        <div class="create-new-btn" id="createNewDocument">
                            <i class="fas fa-plus-circle"></i>
                            <h3>Create New Document</h3>
                        </div>
                        <!-- Documents will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Document Creation Section -->
            <div id="documentCreationSection" class="hidden">
                <div class="card">
                    <h2>Select Document Type</h2>
                    <div class="document-type">
                        <div class="doc-type-btn active" data-type="invoice">
                            <i class="fas fa-file-invoice-dollar invoice-active"></i>
                            <h3>Invoice</h3>
                            <p>Bill for products/services</p>
                        </div>
                        <div class="doc-type-btn" data-type="receipt">
                            <i class="fas fa-receipt receipt-active"></i>
                            <h3>Receipt</h3>
                            <p>Payment confirmation</p>
                        </div>
                        <div class="doc-type-btn" data-type="voucher">
                            <i class="fas fa-ticket-alt voucher-active"></i>
                            <h3>Voucher</h3>
                            <p>Discount or gift certificate</p>
                        </div>
                    </div>
                    
                    <!-- My Details Section -->
                    <div class="my-details-section">
                        <h3>My Details</h3>
                        <div class="bank-details-grid">
                            <div class="form-group">
                                <label for="myName">My Name</label>
                                <input type="text" id="myName" placeholder="Your full name">
                            </div>
                            <div class="form-group">
                                <label for="myCompany">My Company</label>
                                <input type="text" id="myCompany" placeholder="Your company name">
                            </div>
                            <div class="form-group">
                                <label for="myAddress">My Address</label>
                                <textarea id="myAddress" rows="2" placeholder="Your address"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="myPhone">My Phone</label>
                                <input type="tel" id="myPhone" placeholder="Your phone number">
                            </div>
                            <div class="form-group">
                                <label for="myEmail">My Email</label>
                                <input type="email" id="myEmail" placeholder="Your email address">
                            </div>
                            <div class="form-group">
                                <label for="myWebsite">My Website</label>
                                <input type="text" id="myWebsite" placeholder="Your website (optional)">
                            </div>
                        </div>
                        <button id="saveMyDetails" class="btn btn-success" style="margin-top: 1rem;">Save My Details</button>
                    </div>
                    
                    <h2>Client Details</h2>
                    <div class="form-group">
                        <label for="clientName">Client Name</label>
                        <input type="text" id="clientName" placeholder="Enter client name">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientAddress">Client Address</label>
                        <textarea id="clientAddress" rows="3" placeholder="Enter client address"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPhone">Client Phone</label>
                        <input type="tel" id="clientPhone" placeholder="Enter client phone number">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail">Client Email</label>
                        <input type="email" id="clientEmail" placeholder="Enter client email">
                    </div>
                    
                    <div class="form-group">
                        <label for="documentNumber">Document Number</label>
                        <input type="text" id="documentNumber" placeholder="e.g., INV-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="issueDate">Issue Date</label>
                        <input type="date" id="issueDate">
                    </div>
                    
                    <div id="dueDateField" class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="date" id="dueDate">
                    </div>
                    
                    <!-- Voucher-specific fields -->
                    <div id="voucherFields" class="hidden">
                        <div class="form-group">
                            <label for="voucherCode">Voucher Code</label>
                            <input type="text" id="voucherCode" placeholder="Enter voucher code">
                        </div>
                        <div class="form-group">
                            <label for="voucherAmount">Voucher Amount</label>
                            <input type="number" id="voucherAmount" placeholder="Enter voucher amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date</label>
                            <input type="date" id="expiryDate">
                        </div>
                        <div class="form-group">
                            <label for="voucherTerms">Terms & Conditions</label>
                            <textarea id="voucherTerms" rows="3" placeholder="Enter voucher terms and conditions"></textarea>
                        </div>
                    </div>
                    
                    <!-- Receipt-specific fields -->
                    <div id="receiptFields" class="hidden">
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select id="paymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="upi">UPI</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionId">Transaction ID</label>
                            <input type="text" id="transactionId" placeholder="Enter transaction ID">
                        </div>
                    </div>
                    
                    <!-- Bank Account Details Section -->
                    <div class="bank-details-section">
                        <h3>Bank Account Details</h3>
                        <div class="bank-details-grid">
                            <div class="form-group">
                                <label for="bankName">Bank Name</label>
                                <input type="text" id="bankName" placeholder="e.g., State Bank of India">
                            </div>
                            <div class="form-group">
                                <label for="accountNumber">Account Number</label>
                                <input type="text" id="accountNumber" placeholder="Enter account number">
                            </div>
                            <div class="form-group">
                                <label for="ifscCode">IFSC Code</label>
                                <input type="text" id="ifscCode" placeholder="Enter IFSC code">
                            </div>
                            <div class="form-group">
                                <label for="accountHolder">Account Holder Name</label>
                                <input type="text" id="accountHolder" placeholder="Account holder name">
                            </div>
                        </div>
                        
                        <!-- UPI QR Code Section -->
                        <div class="qr-code-container">
                            <h4>UPI Payment QR Code</h4>
                            <p class="small-muted">Enter phone number to generate UPI QR code</p>
                            <div class="form-group">
                                <label for="upiId">UPI ID/Phone Number</label>
                                <input type="text" id="upiId" placeholder="e.g., 9876543210@ybl">
                            </div>
                            <div id="qrCodeContainer">
                                <div class="qr-code-placeholder" id="qrPlaceholder">
                                    QR Code will appear here when UPI ID is entered
                                </div>
                                <canvas id="qrCodeCanvas" class="hidden"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Internal Notes Section -->
                    <div class="internal-notes">
                        <h3>Internal Notes (Not shown on document)</h3>
                        <textarea id="internalNotes" rows="3" placeholder="Add internal notes or references here. These will not be shown on the generated document."></textarea>
                    </div>
                    
                    <h2>Items</h2>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Tax</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsList">
                            <tr>
                                <td><input type="text" class="item-desc" placeholder="Item description"></td>
                                <td><input type="number" class="item-qty" value="1" min="1"></td>
                                <td><input type="number" class="item-price" placeholder="0.00" step="0.01" min="0"></td>
                                <td>
                                    <select class="item-tax">
                                        <option value="0">0%</option>
                                        <option value="5">5%</option>
                                        <option value="10">10%</option>
                                        <option value="18">18%</option>
                                        <option value="20">20%</option>
                                    </select>
                                </td>
                                <td class="item-total">0.00</td>
                                <td><button class="btn btn-danger remove-item">Remove</button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="add-item-btn">
                        <button id="addItem" class="btn"><i class="fas fa-plus"></i> Add Item</button>
                    </div>
                    
                    <div class="tax-summary">
                        <div class="tax-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">0.00</span>
                        </div>
                        <div id="tax5Row" class="tax-row hidden">
                            <span>Tax (5%):</span>
                            <span id="tax5">0.00</span>
                        </div>
                        <div id="tax10Row" class="tax-row hidden">
                            <span>Tax (10%):</span>
                            <span id="tax10">0.00</span>
                        </div>
                        <div id="tax18Row" class="tax-row hidden">
                            <span>Tax (18%):</span>
                            <span id="tax18">0.00</span>
                        </div>
                        <div id="tax20Row" class="tax-row hidden">
                            <span>Tax (20%):</span>
                            <span id="tax20">0.00</span>
                        </div>
                        <div class="tax-row total">
                            <span>Grand Total:</span>
                            <span id="grandTotal">0.00</span>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button id="generatePdf" class="btn btn-primary">Generate PDF</button>
                        <button id="saveToFirebase" class="btn btn-success">Save to Firebase</button>
                        <button id="resetForm" class="btn btn-danger">Reset Form</button>
                        <button id="backToDashboard" class="btn">Back to Dashboard</button>
                    </div>
                </div>
                
                <div class="preview-container">
                    <h2>Document Preview</h2>
                    <div class="document-preview" id="documentPreview">
                        <!-- Document content will be dynamically updated based on type -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        Document saved successfully!
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appContent = document.getElementById('appContent');
        const redirectToLogin = document.getElementById('redirectToLogin');
        const signOutBtn = document.getElementById('signOutBtn');
        
        const dashboardSection = document.getElementById('dashboardSection');
        const documentCreationSection = document.getElementById('documentCreationSection');
        const createNewDocument = document.getElementById('createNewDocument');
        const documentsDashboard = document.getElementById('documentsDashboard');
        const backToDashboard = document.getElementById('backToDashboard');
        
        const docTypeButtons = document.querySelectorAll('.doc-type-btn');
        const dueDateField = document.getElementById('dueDateField');
        const voucherFields = document.getElementById('voucherFields');
        const receiptFields = document.getElementById('receiptFields');
        const itemsList = document.getElementById('itemsList');
        const addItemBtn = document.getElementById('addItem');
        const generatePdfBtn = document.getElementById('generatePdf');
        const saveToFirebaseBtn = document.getElementById('saveToFirebase');
        const resetFormBtn = document.getElementById('resetForm');
        const saveMyDetailsBtn = document.getElementById('saveMyDetails');
        const notification = document.getElementById('notification');
        
        // New elements for enhanced features
        const upiIdInput = document.getElementById('upiId');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const qrCodeCanvas = document.getElementById('qrCodeCanvas');
        const previewBankDetails = document.getElementById('previewBankDetails');
        const previewQrCode = document.getElementById('previewQrCode');
        
        // Current user
        let currentUser = null;
        let currentDocType = 'invoice';
        
        // Set current date as default for issue date
        document.getElementById('issueDate').valueAsDate = new Date();
        
        // Set due date to 15 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 15);
        document.getElementById('dueDate').valueAsDate = dueDate;
        
        // Set expiry date to 30 days from now for vouchers
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30);
        document.getElementById('expiryDate').valueAsDate = expiryDate;
        
        // Redirect to login page
        redirectToLogin.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
        
        // Sign out
        signOutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    showAuth();
                    showNotification('Signed out successfully');
                })
                .catch((error) => {
                    showNotification('Sign out error: ' + error.message, 'error');
                });
        });
        
        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showApp();
                loadUserDetails();
                loadUserDocuments();
            } else {
                showAuth();
            }
        });
        
        // Show auth section
        function showAuth() {
            authSection.classList.remove('hidden');
            appContent.classList.add('hidden');
        }
        
        // Show app content
        function showApp() {
            authSection.classList.add('hidden');
            appContent.classList.remove('hidden');
            showDashboard();
        }
        
        // Create new document
        createNewDocument.addEventListener('click', () => {
            showDocumentCreation();
        });
        
        // Back to dashboard
        backToDashboard.addEventListener('click', () => {
            showDashboard();
        });
        
        // Save my details
        saveMyDetailsBtn.addEventListener('click', () => {
            saveMyDetails();
        });
        
        // Document type selection
        docTypeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const type = button.getAttribute('data-type');
                setDocumentType(type);
            });
        });
        
        function setDocumentType(type) {
            currentDocType = type;
            docTypeButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`.doc-type-btn[data-type="${type}"]`).classList.add('active');
            
            // Show/hide specific fields based on document type
            if (type === 'invoice') {
                dueDateField.style.display = 'block';
                voucherFields.classList.add('hidden');
                receiptFields.classList.add('hidden');
            } else if (type === 'receipt') {
                dueDateField.style.display = 'none';
                voucherFields.classList.add('hidden');
                receiptFields.classList.remove('hidden');
            } else if (type === 'voucher') {
                dueDateField.style.display = 'none';
                voucherFields.classList.remove('hidden');
                receiptFields.classList.add('hidden');
            }
            
            updatePreview();
        }
        
        // Add item row
        addItemBtn.addEventListener('click', () => {
            addItemRow();
        });
        
        function addItemRow(itemData = {}) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="item-desc" placeholder="Item description" value="${itemData.description || ''}"></td>
                <td><input type="number" class="item-qty" value="${itemData.quantity || 1}" min="1"></td>
                <td><input type="number" class="item-price" placeholder="0.00" step="0.01" min="0" value="${itemData.price || ''}"></td>
                <td>
                    <select class="item-tax">
                        <option value="0" ${itemData.tax === 0 ? 'selected' : ''}>0%</option>
                        <option value="5" ${itemData.tax === 5 ? 'selected' : ''}>5%</option>
                        <option value="10" ${itemData.tax === 10 ? 'selected' : ''}>10%</option>
                        <option value="18" ${itemData.tax === 18 ? 'selected' : ''}>18%</option>
                        <option value="20" ${itemData.tax === 20 ? 'selected' : ''}>20%</option>
                    </select>
                </td>
                <td class="item-total">0.00</td>
                <td><button class="btn btn-danger remove-item">Remove</button></td>
            `;
            itemsList.appendChild(row);
            
            // Add event listeners to the new row
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateItemTotal(row);
                    updateCalculations();
                    updatePreview();
                });
            });
            
            row.querySelector('.remove-item').addEventListener('click', () => {
                row.remove();
                updateCalculations();
                updatePreview();
            });
            
            if (itemData.description) {
                updateItemTotal(row);
            }
        }
        
        // Update item total
        function updateItemTotal(row) {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const tax = parseFloat(row.querySelector('.item-tax').value) || 0;
            
            const subtotal = qty * price;
            const taxAmount = subtotal * (tax / 100);
            const total = subtotal + taxAmount;
            
            row.querySelector('.item-total').textContent = total.toFixed(2);
        }
        
        // Update calculations
        function updateCalculations() {
            let subtotal = 0;
            const taxAmounts = { 5: 0, 10: 0, 18: 0, 20: 0 };
            
            document.querySelectorAll('#itemsList tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const tax = parseFloat(row.querySelector('.item-tax').value) || 0;
                
                const itemSubtotal = qty * price;
                subtotal += itemSubtotal;
                
                if (tax > 0) {
                    taxAmounts[tax] += itemSubtotal * (tax / 100);
                }
            });
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            
            // Show only tax rows that have values
            const tax5Row = document.getElementById('tax5Row');
            const tax10Row = document.getElementById('tax10Row');
            const tax18Row = document.getElementById('tax18Row');
            const tax20Row = document.getElementById('tax20Row');
            
            if (taxAmounts[5] > 0) {
                document.getElementById('tax5').textContent = taxAmounts[5].toFixed(2);
                tax5Row.classList.remove('hidden');
            } else {
                tax5Row.classList.add('hidden');
            }
            
            if (taxAmounts[10] > 0) {
                document.getElementById('tax10').textContent = taxAmounts[10].toFixed(2);
                tax10Row.classList.remove('hidden');
            } else {
                tax10Row.classList.add('hidden');
            }
            
            if (taxAmounts[18] > 0) {
                document.getElementById('tax18').textContent = taxAmounts[18].toFixed(2);
                tax18Row.classList.remove('hidden');
            } else {
                tax18Row.classList.add('hidden');
            }
            
            if (taxAmounts[20] > 0) {
                document.getElementById('tax20').textContent = taxAmounts[20].toFixed(2);
                tax20Row.classList.remove('hidden');
            } else {
                tax20Row.classList.add('hidden');
            }
            
            const grandTotal = subtotal + taxAmounts[5] + taxAmounts[10] + taxAmounts[18] + taxAmounts[20];
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }
        
        // Update preview
        function updatePreview() {
            const previewContainer = document.getElementById('documentPreview');
            
            // Clear previous content
            previewContainer.innerHTML = '';
            
            // Get form values
            const myName = document.getElementById('myName').value;
            const myCompany = document.getElementById('myCompany').value;
            const myAddress = document.getElementById('myAddress').value;
            const myPhone = document.getElementById('myPhone').value;
            const myEmail = document.getElementById('myEmail').value;
            const myWebsite = document.getElementById('myWebsite').value;
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const documentNumber = document.getElementById('documentNumber').value;
            const issueDate = document.getElementById('issueDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const ifscCode = document.getElementById('ifscCode').value;
            const accountHolder = document.getElementById('accountHolder').value;
            const upiId = document.getElementById('upiId').value;
            
            // Get voucher-specific values
            const voucherCode = document.getElementById('voucherCode').value;
            const voucherAmount = document.getElementById('voucherAmount').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const voucherTerms = document.getElementById('voucherTerms').value;
            
            // Get receipt-specific values
            const paymentMethod = document.getElementById('paymentMethod').value;
            const transactionId = document.getElementById('transactionId').value;
            
            // Collect items
            const items = [];
            document.querySelectorAll('#itemsList tr').forEach(row => {
                const description = row.querySelector('.item-desc').value;
                const quantity = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const tax = parseFloat(row.querySelector('.item-tax').value) || 0;
                
                if (description || quantity > 0 || price > 0) {
                    items.push({
                        description,
                        quantity,
                        price,
                        tax,
                        total: row.querySelector('.item-total').textContent
                    });
                }
            });
            
            // Calculate totals
            const subtotal = parseFloat(document.getElementById('subtotal').textContent) || 0;
            const tax5 = parseFloat(document.getElementById('tax5').textContent) || 0;
            const tax10 = parseFloat(document.getElementById('tax10').textContent) || 0;
            const tax18 = parseFloat(document.getElementById('tax18').textContent) || 0;
            const tax20 = parseFloat(document.getElementById('tax20').textContent) || 0;
            const grandTotal = parseFloat(document.getElementById('grandTotal').textContent) || 0;
            
            // Generate preview based on document type
            let previewHTML = '';
            
            if (currentDocType === 'invoice') {
                previewHTML = generateInvoicePreview(
                    myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
                    clientName, clientAddress, clientPhone, clientEmail,
                    documentNumber, issueDate, dueDate,
                    items, subtotal, tax5, tax10, tax18, tax20, grandTotal,
                    bankName, accountNumber, ifscCode, accountHolder, upiId
                );
                previewContainer.className = 'document-preview invoice-preview';
            } else if (currentDocType === 'receipt') {
                previewHTML = generateReceiptPreview(
                    myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
                    clientName, clientAddress, clientPhone, clientEmail,
                    documentNumber, issueDate,
                    items, subtotal, tax5, tax10, tax18, tax20, grandTotal,
                    paymentMethod, transactionId,
                    bankName, accountNumber, ifscCode, accountHolder, upiId
                );
                previewContainer.className = 'document-preview receipt-preview';
            } else if (currentDocType === 'voucher') {
                previewHTML = generateVoucherPreview(
                    myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
                    clientName, clientAddress, clientPhone, clientEmail,
                    documentNumber, issueDate, expiryDate,
                    voucherCode, voucherAmount, voucherTerms,
                    items, grandTotal
                );
                previewContainer.className = 'document-preview voucher-preview';
            }
            
            previewContainer.innerHTML = previewHTML;
            
            // Generate QR code if UPI ID exists
            if (upiId && currentDocType !== 'voucher') {
                generateQRCode(upiId);
            }
        }
        
        // Generate Invoice Preview
        function generateInvoicePreview(
            myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
            clientName, clientAddress, clientPhone, clientEmail,
            documentNumber, issueDate, dueDate,
            items, subtotal, tax5, tax10, tax18, tax20, grandTotal,
            bankName, accountNumber, ifscCode, accountHolder, upiId
        ) {
            let itemsHTML = '';
            if (items.length > 0) {
                items.forEach(item => {
                    itemsHTML += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity}</td>
                            <td>${parseFloat(item.price).toFixed(2)}</td>
                            <td>${item.tax}%</td>
                            <td>${item.total}</td>
                        </tr>
                    `;
                });
            } else {
                itemsHTML = '<tr><td colspan="5" style="text-align: center;">No items added</td></tr>';
            }
            
            let taxRowsHTML = '';
            if (tax5 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (5%):</span><span>${tax5.toFixed(2)}</span></div>`;
            if (tax10 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (10%):</span><span>${tax10.toFixed(2)}</span></div>`;
            if (tax18 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (18%):</span><span>${tax18.toFixed(2)}</span></div>`;
            if (tax20 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (20%):</span><span>${tax20.toFixed(2)}</span></div>`;
            
            let bankDetailsHTML = '';
            if (bankName || accountNumber || ifscCode || accountHolder) {
                bankDetailsHTML = `
                    <div class="bank-details-preview">
                        <h4>Bank Account Details</h4>
                        ${bankName ? `<p>Bank: ${bankName}</p>` : ''}
                        ${accountNumber ? `<p>Account Number: ${accountNumber}</p>` : ''}
                        ${ifscCode ? `<p>IFSC Code: ${ifscCode}</p>` : ''}
                        ${accountHolder ? `<p>Account Holder: ${accountHolder}</p>` : ''}
                    </div>
                `;
            }
            
            let qrCodeHTML = '';
            if (upiId) {
                qrCodeHTML = `
                    <div class="qr-code-container">
                        <h4>Pay via UPI</h4>
                        <p>Scan the QR code to pay instantly</p>
                        <div id="previewQrCode">
                            <canvas id="previewQrCanvas"></canvas>
                            <p>${upiId}</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="invoice-header">
                    <div class="company-info">
                        <h2>${myCompany || 'Your Company Name'}</h2>
                        <p>${myAddress || 'Company Address'}</p>
                        ${myPhone ? `<p>Phone: ${myPhone}</p>` : ''}
                        ${myEmail ? `<p>Email: ${myEmail}</p>` : ''}
                        ${myWebsite ? `<p>Website: ${myWebsite}</p>` : ''}
                    </div>
                    <div class="document-type-label">
                        <h1 class="document-title invoice-title">INVOICE</h1>
                    </div>
                </div>
                
                <div class="document-details">
                    <div class="client-info">
                        <h3>Bill To:</h3>
                        <p>${clientName || 'Client Name'}</p>
                        <p>${clientAddress || 'Client Address'}</p>
                        ${clientPhone ? `<p>Phone: ${clientPhone}</p>` : ''}
                        ${clientEmail ? `<p>Email: ${clientEmail}</p>` : ''}
                    </div>
                    
                    <div class="document-info">
                        <p><strong>Invoice Number:</strong> ${documentNumber || 'INV-001'}</p>
                        <p><strong>Issue Date:</strong> ${issueDate ? new Date(issueDate).toLocaleDateString() : new Date().toLocaleDateString()}</p>
                        <p><strong>Due Date:</strong> ${dueDate ? new Date(dueDate).toLocaleDateString() : 'N/A'}</p>
                    </div>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Tax</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
               
                <div class="tax-summary">
                    <div class="tax-row">
                        <span>Subtotal:</span>
                        <span>${subtotal.toFixed(2)}</span>
                    </div>
                    ${taxRowsHTML}
                    <div class="tax-row total">
                        <span>Grand Total:</span>
                        <span>${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
                
                ${bankDetailsHTML}
                ${qrCodeHTML}
                
                <div class="payment-options">
                    <div>
                        <h4>Payment Methods</h4>
                        <p>Bank Transfer, UPI, Cash</p>
                    </div>
                    <div>
                        <h4>Thank You!</h4>
                        <p>We appreciate your business</p>
                    </div>
                </div>
                
                <div class="terms-conditions">
                    <p><strong>Terms & Conditions:</strong></p>
                    <p>Payment is due within 15 days. Please make checks payable to ${myCompany || 'Your Company Name'}.</p>
                </div>
            `;
        }
        
        // Generate Receipt Preview
        function generateReceiptPreview(
            myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
            clientName, clientAddress, clientPhone, clientEmail,
            documentNumber, issueDate,
            items, subtotal, tax5, tax10, tax18, tax20, grandTotal,
            paymentMethod, transactionId,
            bankName, accountNumber, ifscCode, accountHolder, upiId
        ) {
            let itemsHTML = '';
            if (items.length > 0) {
                items.forEach(item => {
                    itemsHTML += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity}</td>
                            <td>${parseFloat(item.price).toFixed(2)}</td>
                            <td>${item.tax}%</td>
                            <td>${item.total}</td>
                        </tr>
                    `;
                });
            } else {
                itemsHTML = '<tr><td colspan="5" style="text-align: center;">No items added</td></tr>';
            }
            
            let taxRowsHTML = '';
            if (tax5 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (5%):</span><span>${tax5.toFixed(2)}</span></div>`;
            if (tax10 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (10%):</span><span>${tax10.toFixed(2)}</span></div>`;
            if (tax18 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (18%):</span><span>${tax18.toFixed(2)}</span></div>`;
            if (tax20 > 0) taxRowsHTML += `<div class="tax-row"><span>Tax (20%):</span><span>${tax20.toFixed(2)}</span></div>`;
            
            return `
                <div class="invoice-header">
                    <div class="company-info">
                        <h2>${myCompany || 'Your Company Name'}</h2>
                        <p>${myAddress || 'Company Address'}</p>
                        ${myPhone ? `<p>Phone: ${myPhone}</p>` : ''}
                        ${myEmail ? `<p>Email: ${myEmail}</p>` : ''}
                        ${myWebsite ? `<p>Website: ${myWebsite}</p>` : ''}
                    </div>
                    <div class="document-type-label">
                        <h1 class="document-title receipt-title">RECEIPT</h1>
                    </div>
                </div>
                
                <div class="receipt-stamp">
                    PAID
                </div>
                
                <div class="document-details">
                    <div class="client-info">
                        <h3>Received From:</h3>
                        <p>${clientName || 'Client Name'}</p>
                        <p>${clientAddress || 'Client Address'}</p>
                        ${clientPhone ? `<p>Phone: ${clientPhone}</p>` : ''}
                        ${clientEmail ? `<p>Email: ${clientEmail}</p>` : ''}
                    </div>
                    
                    <div class="document-info">
                        <p><strong>Receipt Number:</strong> ${documentNumber || 'RCP-001'}</p>
                        <p><strong>Date:</strong> ${issueDate ? new Date(issueDate).toLocaleDateString() : new Date().toLocaleDateString()}</p>
                        <p><strong>Payment Method:</strong> ${paymentMethod || 'N/A'}</p>
                        ${transactionId ? `<p><strong>Transaction ID:</strong> ${transactionId}</p>` : ''}
                    </div>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Tax</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
               
                <div class="tax-summary">
                    <div class="tax-row">
                        <span>Subtotal:</span>
                        <span>${subtotal.toFixed(2)}</span>
                    </div>
                    ${taxRowsHTML}
                    <div class="tax-row total">
                        <span>Amount Paid:</span>
                        <span>${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="payment-options">
                    <div>
                        <h4>Payment Confirmation</h4>
                        <p>This document serves as confirmation of payment received.</p>
                    </div>
                    <div>
                        <h4>Thank You!</h4>
                        <p>We appreciate your business</p>
                    </div>
                </div>
                
                <div class="terms-conditions">
                    <p><strong>Note:</strong> This is an official receipt for the transaction mentioned above.</p>
                </div>
            `;
        }
        
        // Generate Voucher Preview
        function generateVoucherPreview(
            myName, myCompany, myAddress, myPhone, myEmail, myWebsite,
            clientName, clientAddress, clientPhone, clientEmail,
            documentNumber, issueDate, expiryDate,
            voucherCode, voucherAmount, voucherTerms,
            items, grandTotal
        ) {
            let itemsHTML = '';
            if (items.length > 0) {
                items.forEach(item => {
                    itemsHTML += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity}</td>
                            <td>${parseFloat(item.price).toFixed(2)}</td>
                            <td>${item.tax}%</td>
                            <td>${item.total}</td>
                        </tr>
                    `;
                });
            }
            
            return `
                <div class="invoice-header">
                    <div class="company-info">
                        <h2>${myCompany || 'Your Company Name'}</h2>
                        <p>${myAddress || 'Company Address'}</p>
                        ${myPhone ? `<p>Phone: ${myPhone}</p>` : ''}
                        ${myEmail ? `<p>Email: ${myEmail}</p>` : ''}
                        ${myWebsite ? `<p>Website: ${myWebsite}</p>` : ''}
                    </div>
                    <div class="document-type-label">
                        <h1 class="document-title voucher-title">VOUCHER</h1>
                    </div>
                </div>
                
                <div class="voucher-code">
                    ${voucherCode || 'VOUCHER-CODE'}
                </div>
                
                <div class="document-details">
                    <div class="client-info">
                        <h3>Issued To:</h3>
                        <p>${clientName || 'Client Name'}</p>
                        <p>${clientAddress || 'Client Address'}</p>
                        ${clientPhone ? `<p>Phone: ${clientPhone}</p>` : ''}
                        ${clientEmail ? `<p>Email: ${clientEmail}</p>` : ''}
                    </div>
                    
                    <div class="document-info">
                        <p><strong>Voucher Number:</strong> ${documentNumber || 'VCH-001'}</p>
                        <p><strong>Issue Date:</strong> ${issueDate ? new Date(issueDate).toLocaleDateString() : new Date().toLocaleDateString()}</p>
                        <p><strong>Expiry Date:</strong> ${expiryDate ? new Date(expiryDate).toLocaleDateString() : 'N/A'}</p>
                        <p><strong>Voucher Value:</strong> ${voucherAmount ? '' + parseFloat(voucherAmount).toFixed(2) : 'N/A'}</p>
                    </div>
                </div>
                
                ${items.length > 0 ? `
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Tax</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
                
                <div class="tax-summary">
                    <div class="tax-row total">
                        <span>Total Value:</span>
                        <span>${grandTotal.toFixed(2)}</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="payment-options">
                    <div>
                        <h4>Redeem At</h4>
                        <p>${myCompany || 'Your Company Name'}</p>
                        <p>${myAddress || 'Company Address'}</p>
                    </div>
                    <div>
                        <h4>Valid Until</h4>
                        <p>${expiryDate ? new Date(expiryDate).toLocaleDateString() : 'N/A'}</p>
                    </div>
                </div>
                
                <div class="terms-conditions">
                    <p><strong>Terms & Conditions:</strong></p>
                    <p>${voucherTerms || 'This voucher is non-transferable and cannot be exchanged for cash. Valid for one-time use only.'}</p>
                </div>
            `;
        }
        
        // Generate QR code
        upiIdInput.addEventListener('input', function() {
            const upiId = this.value.trim();
            if (upiId) {
                generateQRCode(upiId);
            } else {
                qrPlaceholder.classList.remove('hidden');
                qrCodeCanvas.classList.add('hidden');
            }
        });
        
        function generateQRCode(upiId) {
            try {
                // Generate UPI payment string
                const upiString = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=Recipient Name&mc=0000&mode=02&purpose=00`;
                
                // Generate QR code
                const typeNumber = 0;
                const errorCorrectionLevel = 'L';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(upiString);
                qr.make();
                
                // Draw QR code on canvas
                const canvasSize = 150;
                const cellSize = canvasSize / qr.getModuleCount();
                const context = qrCodeCanvas.getContext('2d');
                
                qrCodeCanvas.width = canvasSize;
                qrCodeCanvas.height = canvasSize;
                context.clearRect(0, 0, canvasSize, canvasSize);
                
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        context.fillStyle = qr.isDark(row, col) ? '#000000' : '#ffffff';
                        context.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                    }
                }
                
                // Show QR code and hide placeholder
                qrPlaceholder.classList.add('hidden');
                qrCodeCanvas.classList.remove('hidden');
                
                // Update preview
                const previewQrCanvas = document.getElementById('previewQrCanvas');
                if (previewQrCanvas) {
                    const previewContext = previewQrCanvas.getContext('2d');
                    previewQrCanvas.width = canvasSize;
                    previewQrCanvas.height = canvasSize;
                    previewContext.drawImage(qrCodeCanvas, 0, 0);
                }
            } catch (error) {
                console.error('QR code generation error:', error);
                qrPlaceholder.textContent = 'Error generating QR code';
                qrPlaceholder.classList.remove('hidden');
                qrCodeCanvas.classList.add('hidden');
            }
        }
        
        // Input event listeners for real-time preview update
        const previewInputs = [
            'myName', 'myCompany', 'myAddress', 'myPhone', 'myEmail', 'myWebsite',
            'clientName', 'clientAddress', 'clientPhone', 'clientEmail',
            'documentNumber', 'issueDate', 'dueDate',
            'bankName', 'accountNumber', 'ifscCode', 'accountHolder',
            'voucherCode', 'voucherAmount', 'expiryDate', 'voucherTerms',
            'paymentMethod', 'transactionId'
        ];
        
        previewInputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', updatePreview);
            }
        });
        
        // Generate PDF with proper page layout
        generatePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get document type for file name
            const docType = document.querySelector('.doc-type-btn.active').getAttribute('data-type');
            const docNumber = document.getElementById('documentNumber').value || 'document';
            
            // Create a temporary div for PDF generation with proper page layout
            const pdfContainer = document.createElement('div');
            pdfContainer.style.width = '210mm';
            pdfContainer.style.padding = '15mm';
            pdfContainer.style.background = 'white';
            pdfContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Clone the preview content
            const previewContent = document.getElementById('documentPreview').cloneNode(true);
            
            // Remove hidden elements
            previewContent.querySelectorAll('.hidden').forEach(el => el.remove());
            
            // Add to PDF container
            pdfContainer.appendChild(previewContent);
            document.body.appendChild(pdfContainer);
            
            // Generate PDF
            html2canvas(pdfContainer, {scale: 2}).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth();
                let imgHeight = canvas.height * imgWidth / canvas.width;
                
                // Check if content fits on one page
                const pageHeight = doc.internal.pageSize.getHeight();
                
                if (imgHeight < pageHeight) {
                    // Content fits on one page
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight, undefined, 'FAST');
                } else {
                    // Content spans multiple pages
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    // Add first page
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pageHeight;
                    
                    // Add additional pages if needed
                    while (heightLeft > 0) {
                        position = -imgHeight + heightLeft;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                        heightLeft -= pageHeight;
                    }
                }
                
                // Remove temporary container
                document.body.removeChild(pdfContainer);
                
                // Save the PDF
                doc.save(`${docType}-${docNumber}.pdf`);
            });
        });
        
        // Save to Firebase
        saveToFirebaseBtn.addEventListener('click', () => {
            if (!currentUser) {
                showNotification('Please log in to save documents', 'error');
                return;
            }
            
            // Collect form data
            const docType = document.querySelector('.doc-type-btn.active').getAttribute('data-type');
            const myName = document.getElementById('myName').value;
            const myCompany = document.getElementById('myCompany').value;
            const myAddress = document.getElementById('myAddress').value;
            const myPhone = document.getElementById('myPhone').value;
            const myEmail = document.getElementById('myEmail').value;
            const myWebsite = document.getElementById('myWebsite').value;
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const documentNumber = document.getElementById('documentNumber').value;
            const issueDate = document.getElementById('issueDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const ifscCode = document.getElementById('ifscCode').value;
            const accountHolder = document.getElementById('accountHolder').value;
            const upiId = document.getElementById('upiId').value;
            const internalNotes = document.getElementById('internalNotes').value;
            
            // Voucher-specific data
            const voucherCode = document.getElementById('voucherCode').value;
            const voucherAmount = document.getElementById('voucherAmount').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const voucherTerms = document.getElementById('voucherTerms').value;
            
            // Receipt-specific data
            const paymentMethod = document.getElementById('paymentMethod').value;
            const transactionId = document.getElementById('transactionId').value;
            
            // Collect items
            const items = [];
            document.querySelectorAll('#itemsList tr').forEach(row => {
                const description = row.querySelector('.item-desc').value;
                const quantity = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const tax = parseFloat(row.querySelector('.item-tax').value) || 0;
                
                if (description || quantity > 0 || price > 0) {
                    items.push({
                        description,
                        quantity,
                        price,
                        tax
                    });
                }
            });
            
            // Calculate totals
            const subtotal = parseFloat(document.getElementById('subtotal').textContent) || 0;
            const tax5 = parseFloat(document.getElementById('tax5').textContent) || 0;
            const tax10 = parseFloat(document.getElementById('tax10').textContent) || 0;
            const tax18 = parseFloat(document.getElementById('tax18').textContent) || 0;
            const tax20 = parseFloat(document.getElementById('tax20').textContent) || 0;
            const grandTotal = parseFloat(document.getElementById('grandTotal').textContent) || 0;
            
            // Prepare document data
            const documentData = {
                docType,
                myName,
                myCompany,
                myAddress,
                myPhone,
                myEmail,
                myWebsite,
                clientName,
                clientAddress,
                clientPhone,
                clientEmail,
                documentNumber,
                issueDate,
                dueDate,
                bankName,
                accountNumber,
                ifscCode,
                accountHolder,
                upiId,
                internalNotes,
                items,
                subtotal,
                tax5,
                tax10,
                tax18,
                tax20,
                grandTotal,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add voucher-specific data if applicable
            if (docType === 'voucher') {
                documentData.voucherCode = voucherCode;
                documentData.voucherAmount = voucherAmount;
                documentData.expiryDate = expiryDate;
                documentData.voucherTerms = voucherTerms;
            }
            
            // Add receipt-specific data if applicable
            if (docType === 'receipt') {
                documentData.paymentMethod = paymentMethod;
                documentData.transactionId = transactionId;
            }
            
            // Save to Firestore
            db.collection('users').doc(currentUser.uid).collection('documents').add(documentData)
            .then((docRef) => {
                showNotification('Document saved successfully!');
                loadUserDocuments();
                showDashboard();
            })
            .catch((error) => {
                showNotification('Error saving document: ' + error.message, 'error');
            });
        });
        
        // Save my details
        function saveMyDetails() {
            if (!currentUser) {
                showNotification('Please log in to save your details', 'error');
                return;
            }
            
            const myDetails = {
                myName: document.getElementById('myName').value,
                myCompany: document.getElementById('myCompany').value,
                myAddress: document.getElementById('myAddress').value,
                myPhone: document.getElementById('myPhone').value,
                myEmail: document.getElementById('myEmail').value,
                myWebsite: document.getElementById('myWebsite').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('users').doc(currentUser.uid).set({
                myDetails: myDetails
            }, { merge: true })
            .then(() => {
                showNotification('Your details saved successfully!');
                updatePreview();
            })
            .catch((error) => {
                showNotification('Error saving your details: ' + error.message, 'error');
            });
        }
        
        // Load my details
        function loadUserDetails() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.myDetails) {
                        document.getElementById('myName').value = data.myDetails.myName || '';
                        document.getElementById('myCompany').value = data.myDetails.myCompany || '';
                        document.getElementById('myAddress').value = data.myDetails.myAddress || '';
                        document.getElementById('myPhone').value = data.myDetails.myPhone || '';
                        document.getElementById('myEmail').value = data.myDetails.myEmail || '';
                        document.getElementById('myWebsite').value = data.myDetails.myWebsite || '';
                        updatePreview();
                    }
                }
            })
            .catch((error) => {
                console.log("Error getting user details:", error);
            });
        }
        
        // Load user documents
        function loadUserDocuments() {
            if (!currentUser) return;
            
            documentsDashboard.innerHTML = `
                <div class="create-new-btn" id="createNewDocument">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Create New Document</h3>
                </div>
            `;
            
            // Reattach event listener
            document.getElementById('createNewDocument').addEventListener('click', showDocumentCreation);
            
            db.collection('users').doc(currentUser.uid).collection('documents')
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const docCard = document.createElement('div');
                        docCard.className = `document-card ${data.docType}`;
                        docCard.innerHTML = `
                            <h3>${data.docType.toUpperCase()}: ${data.documentNumber}</h3>
                            <p><strong>Client:</strong> ${data.clientName}</p>
                            <p><strong>Date:</strong> ${new Date(data.issueDate).toLocaleDateString()}</p>
                            <p><strong>Total:</strong> ${data.grandTotal.toFixed(2)}</p>
                            <div class="document-actions">
                                <button class="btn btn-primary view-doc" data-id="${doc.id}">View</button>
                                <button class="btn btn-danger delete-doc" data-id="${doc.id}">Delete</button>
                            </div>
                        `;
                        documentsDashboard.appendChild(docCard);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-doc').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const docId = e.target.getAttribute('data-id');
                            viewDocument(docId);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-doc').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const docId = e.target.getAttribute('data-id');
                            deleteDocument(docId);
                        });
                    });
                })
                .catch((error) => {
                    console.error("Error getting documents: ", error);
                });
        }
        
        // View document
        function viewDocument(docId) {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).collection('documents').doc(docId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Populate form with document data
                        setDocumentType(data.docType);
                        
                        // My Details
                        document.getElementById('myName').value = data.myName || '';
                        document.getElementById('myCompany').value = data.myCompany || '';
                        document.getElementById('myAddress').value = data.myAddress || '';
                        document.getElementById('myPhone').value = data.myPhone || '';
                        document.getElementById('myEmail').value = data.myEmail || '';
                        document.getElementById('myWebsite').value = data.myWebsite || '';
                        
                        // Client Details
                        document.getElementById('clientName').value = data.clientName || '';
                        document.getElementById('clientAddress').value = data.clientAddress || '';
                        document.getElementById('clientPhone').value = data.clientPhone || '';
                        document.getElementById('clientEmail').value = data.clientEmail || '';
                        
                        // Document Info
                        document.getElementById('documentNumber').value = data.documentNumber || '';
                        document.getElementById('issueDate').value = data.issueDate || '';
                        document.getElementById('dueDate').value = data.dueDate || '';
                        
                        // Bank Details
                        document.getElementById('bankName').value = data.bankName || '';
                        document.getElementById('accountNumber').value = data.accountNumber || '';
                        document.getElementById('ifscCode').value = data.ifscCode || '';
                        document.getElementById('accountHolder').value = data.accountHolder || '';
                        document.getElementById('upiId').value = data.upiId || '';
                        
                        // Voucher-specific data
                        if (data.docType === 'voucher') {
                            document.getElementById('voucherCode').value = data.voucherCode || '';
                            document.getElementById('voucherAmount').value = data.voucherAmount || '';
                            document.getElementById('expiryDate').value = data.expiryDate || '';
                            document.getElementById('voucherTerms').value = data.voucherTerms || '';
                        }
                        
                        // Receipt-specific data
                        if (data.docType === 'receipt') {
                            document.getElementById('paymentMethod').value = data.paymentMethod || '';
                            document.getElementById('transactionId').value = data.transactionId || '';
                        }
                        
                        // Internal Notes
                        document.getElementById('internalNotes').value = data.internalNotes || '';
                        
                        // Items
                        itemsList.innerHTML = '';
                        if (data.items && data.items.length > 0) {
                            data.items.forEach(item => {
                                addItemRow(item);
                            });
                        } else {
                            addItemRow();
                        }
                        
                        // Generate QR code if UPI ID exists
                        if (data.upiId) {
                            generateQRCode(data.upiId);
                        }
                        
                        updateCalculations();
                        updatePreview();
                        
                        showDocumentCreation();
                    } else {
                        showNotification('Document not found', 'error');
                    }
                })
                .catch((error) => {
                    showNotification('Error loading document: ' + error.message, 'error');
                });
        }
        
        // Delete document
        function deleteDocument(docId) {
            if (!currentUser) return;
            
            if (confirm('Are you sure you want to delete this document?')) {
                db.collection('users').doc(currentUser.uid).collection('documents').doc(docId).delete()
                    .then(() => {
                        showNotification('Document deleted successfully');
                        loadUserDocuments();
                    })
                    .catch((error) => {
                        showNotification('Error deleting document: ' + error.message, 'error');
                    });
            }
        }
        
        // Reset form
        resetFormBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the form? All unsaved data will be lost.')) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.id !== 'issueDate' && input.id !== 'dueDate' && input.id !== 'expiryDate') {
                        input.value = '';
                    }
                });
                
                // Set default dates
                document.getElementById('issueDate').valueAsDate = new Date();
                
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 15);
                document.getElementById('dueDate').valueAsDate = dueDate;
                
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30);
                document.getElementById('expiryDate').valueAsDate = expiryDate;
                
                // Set default payment method
                document.getElementById('paymentMethod').value = 'cash';
                
                // Clear items and add one empty row
                itemsList.innerHTML = '';
                addItemRow();
                
                // Clear QR code
                qrPlaceholder.classList.remove('hidden');
                qrCodeCanvas.classList.add('hidden');
                
                updateCalculations();
                updatePreview();
            }
        });
        
        // Show dashboard
        function showDashboard() {
            dashboardSection.classList.remove('hidden');
            documentCreationSection.classList.add('hidden');
        }
        
        // Show document creation
        function showDocumentCreation() {
            dashboardSection.classList.add('hidden');
            documentCreationSection.classList.remove('hidden');
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.classList.remove('error');
            
            if (type === 'error') {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize the app
        function init() {
            // Add event listeners to existing items
            document.querySelectorAll('#itemsList tr').forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        updateItemTotal(row);
                        updateCalculations();
                        updatePreview();
                    });
                });
                
                row.querySelector('.remove-item').addEventListener('click', () => {
                    row.remove();
                    updateCalculations();
                    updatePreview();
                });
            });
            
            // Initial calculations and preview
            updateCalculations();
            updatePreview();
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>