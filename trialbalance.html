<!DOCTYPE html>
<html>
<head>
  <title>Trial Balance</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; text-align:center; margin: 0; padding: 0;}
    .top-bar {
      display:flex; justify-content:space-between; padding:10px 20px; background:#fff; border-bottom:1px solid #ccc; align-items:center;
    }
    .top-bar a { text-decoration:none; font-weight:bold; color:#333; }
    .user-section { display:flex; align-items:center; gap:10px; }
    .logout-btn {
      background:#c00; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;
      font-weight: bold;
    }
    table { margin:20px auto; border-collapse:collapse; width:90%; background:#fff; }
    th, td { border:1px solid #ccc; padding:10px; }
    .filter { margin-top:20px; }
    #loadingStatus { font-style: italic; color: #555; }
    input[type="date"] { padding: 5px; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="home.html">üè† Home</a>
    <span id="loadingStatus">Loading...</span>
    <div class="user-section">
      <div id="userDisplay">User</div>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <h2>Trial Balance</h2>

  <div class="filter">
    Filter:
    <select id="dateFilter">
      <option value="month">This Month</option>
      <option value="year">This Year</option>
      <option value="week">This Week</option>
      <option value="custom">Custom</option>
    </select>
    <input type="date" id="fromDate" style="display:none;">
    <input type="date" id="toDate" style="display:none;">

    <select id="accountHeaderFilter">
      <option value="all">All Accounts</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Account</th>
        <th>Description</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="balanceTableBody"></tbody>
  </table>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.firebasestorage.app",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // DOM Elements
  const dateFilter = document.getElementById("dateFilter");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const accountHeaderFilter = document.getElementById("accountHeaderFilter");
  const balanceTableBody = document.getElementById("balanceTableBody");
  const loadingStatus = document.getElementById("loadingStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");

  // Logout button handler
  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  });

  // Handle user auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      const displayName = user.displayName || user.email || "User";
      userDisplay.textContent = displayName;
      toggleCustomDateInputs(); // Show/hide date inputs based on default selection on load
      populateAccountHeaders().then(() => loadTrialBalance());
    } else {
      window.location.href = "login.html";
    }
  });

  // Populate accounts dropdown
  async function populateAccountHeaders() {
    const user = auth.currentUser;
    if (!user) return;

    const accountsRef = db.collection("users").doc(user.uid).collection("chartOfAccounts");

    try {
      const snapshot = await accountsRef.get();
      accountHeaderFilter.innerHTML = '<option value="all">All Accounts</option>';

      if (snapshot.empty) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No Accounts Found";
        accountHeaderFilter.appendChild(option);
        accountHeaderFilter.disabled = true;
        return;
      }

      snapshot.forEach(doc => {
        const accountData = doc.data();
        const name = accountData.name || accountData.accountName || "Unnamed Account";
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        accountHeaderFilter.appendChild(option);
      });

      accountHeaderFilter.disabled = false;

    } catch (error) {
      console.error("Error loading accounts:", error);
      loadingStatus.textContent = "Error loading accounts";
    }
  }

  // Show/hide custom date inputs depending on filter selection
  function toggleCustomDateInputs() {
    if (dateFilter.value === "custom") {
      fromDate.style.display = "inline-block";
      toDate.style.display = "inline-block";
    } else {
      fromDate.style.display = "none";
      toDate.style.display = "none";
      // Clear custom date inputs when not using custom
      fromDate.value = "";
      toDate.value = "";
    }
  }

  // Get date range based on filter
  function getDateRange(filterType) {
    const now = new Date();
    let from = new Date(), to = new Date();

    switch(filterType) {
      case 'month':
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        break;
      case 'year':
        from = new Date(now.getFullYear(), 0, 1);
        to = new Date(now.getFullYear(), 11, 31);
        break;
      case 'week':
        const day = now.getDay(); // Sunday=0
        from = new Date(now);
        from.setDate(now.getDate() - day);
        to = new Date(now);
        to.setDate(now.getDate() + (6 - day));
        break;
      case 'custom':
        // If invalid or empty dates, default to today
        from = fromDate.value ? new Date(fromDate.value) : new Date();
        to = toDate.value ? new Date(toDate.value) : new Date();
        break;
    }
    from.setHours(0,0,0,0);
    to.setHours(23,59,59,999);
    return {from, to};
  }

  // Load trial balance from Firestore with filters applied
  async function loadTrialBalance() {
    const user = auth.currentUser;
    if (!user) return;

    // Validate custom dates if custom filter selected
    if (dateFilter.value === 'custom') {
      if (!fromDate.value || !toDate.value) {
        loadingStatus.textContent = "Please select both From and To dates.";
        balanceTableBody.innerHTML = "";
        return;
      }
      if (new Date(fromDate.value) > new Date(toDate.value)) {
        loadingStatus.textContent = "'From' date cannot be after 'To' date.";
        balanceTableBody.innerHTML = "";
        return;
      }
    }

    toggleCustomDateInputs();

    loadingStatus.textContent = "Loading...";

    const {from, to} = getDateRange(dateFilter.value);
    const selectedAccount = accountHeaderFilter.value;

    const txRef = db.collection("users").doc(user.uid).collection("transactions");

    try {
      // Firestore requires orderBy on a field used in range queries
      // So first orderBy 'date' ascending to match where range
      let queryRef = txRef
        .orderBy("date")
        .where("date", ">=", firebase.firestore.Timestamp.fromDate(from))
        .where("date", "<=", firebase.firestore.Timestamp.fromDate(to));

      if (selectedAccount !== "all") {
        queryRef = queryRef.where("ACCOUNT_HEADER", "==", selectedAccount);
      }

      const snapshot = await queryRef.get();

      balanceTableBody.innerHTML = "";
      let total = 0;

      if (snapshot.empty) {
        balanceTableBody.innerHTML = '<tr><td colspan="4">No transactions found.</td></tr>';
        loadingStatus.textContent = "No data found";
        return;
      }

      // Sort by date descending in JS (since Firestore returns ascending)
      const docs = snapshot.docs.slice().sort((a, b) => b.data().date.toDate() - a.data().date.toDate());

      docs.forEach(doc => {
        const d = doc.data();
        const income = d.income || 0;
        const expense = d.expense || 0;
        const amount = income - expense;
        if (amount === 0) return; // Skip zero amounts

        total += amount;

        const dateStr = d.date.toDate().toLocaleDateString();
        const desc = d.description || "";
        const accountHeader = d.ACCOUNT_HEADER || "";

        balanceTableBody.innerHTML += `
          <tr>
            <td>${dateStr}</td>
            <td>${accountHeader}</td>
            <td>${desc}</td>
            <td style="text-align:right;">${amount.toFixed(2)}</td>
          </tr>
        `;
      });

      balanceTableBody.innerHTML += `
        <tr style="font-weight:bold; background:#eee;">
          <td>Total</td><td></td><td></td><td style="text-align:right;">${total.toFixed(2)}</td>
        </tr>
      `;

      loadingStatus.textContent = "Loaded";
    } catch(e) {
      loadingStatus.textContent = "Error loading data";
      console.error(e);
    }
  }

  // Add event listeners to filters
  dateFilter.addEventListener("change", () => {
    toggleCustomDateInputs();
    loadTrialBalance();
  });
  fromDate.addEventListener("change", loadTrialBalance);
  toDate.addEventListener("change", loadTrialBalance);
  accountHeaderFilter.addEventListener("change", loadTrialBalance);

</script>
</body>
</html>
