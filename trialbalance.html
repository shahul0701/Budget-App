<!DOCTYPE html>
<html>
<head>
  <title>Trial Balance</title>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, orderBy, limit, startAfter, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Parse accountId from URL
  const urlParams = new URLSearchParams(window.location.search);
  const accountIdFromURL = urlParams.get("accountId");

  // DOM elements
  const dateFilter = document.getElementById("dateFilter");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const accountHeaderFilter = document.getElementById("accountHeaderFilter");
  const balanceTableBody = document.getElementById("balanceTableBody");
  const loadingStatus = document.getElementById("loadingStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");

  // Pagination variables
  const PAGE_SIZE = 10;
  let lastVisible = null;
  let firstVisible = null;
  let pageStack = []; // stack of cursors for "previous" pages

  // Create pagination controls
  const paginationControls = document.createElement('div');
  paginationControls.style.margin = "10px auto";
  paginationControls.style.width = "90%";
  paginationControls.style.textAlign = "center";

  const prevBtn = document.createElement('button');
  prevBtn.textContent = "Previous";
  prevBtn.disabled = true;
  prevBtn.style.marginRight = "10px";

  const nextBtn = document.createElement('button');
  nextBtn.textContent = "Next";

  paginationControls.appendChild(prevBtn);
  paginationControls.appendChild(nextBtn);

  document.querySelector('table').after(paginationControls);

  prevBtn.addEventListener('click', () => {
    if (pageStack.length > 1) {
      pageStack.pop(); // current page cursor removed
      const prevCursor = pageStack[pageStack.length - 1];
      loadTrialBalance({ cursor: prevCursor, direction: 'prev' });
    }
  });

  nextBtn.addEventListener('click', () => {
    loadTrialBalance({ cursor: lastVisible, direction: 'next' });
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const name = user.displayName || user.email || "User";
      userDisplay.textContent = name.charAt(0).toUpperCase() + name.slice(1);
      toggleCustomDateInputs();
      await populateAccountHeaders();
      pageStack = [null]; // reset pagination stack
      loadTrialBalance({ cursor: null, direction: 'next' });
    } else {
      window.location.href = "login.html";
    }
  });

  dateFilter.addEventListener("change", () => {
    toggleCustomDateInputs();
    pageStack = [null];
    loadTrialBalance({ cursor: null, direction: 'next' });
  });
  fromDate.addEventListener("change", () => {
    pageStack = [null];
    loadTrialBalance({ cursor: null, direction: 'next' });
  });
  toDate.addEventListener("change", () => {
    pageStack = [null];
    loadTrialBalance({ cursor: null, direction: 'next' });
  });
  accountHeaderFilter.addEventListener("change", () => {
    pageStack = [null];
    loadTrialBalance({ cursor: null, direction: 'next' });
  });

  function toggleCustomDateInputs() {
    if (dateFilter.value === "custom") {
      fromDate.style.display = "inline-block";
      toDate.style.display = "inline-block";
    } else {
      fromDate.style.display = "none";
      toDate.style.display = "none";
      fromDate.value = "";
      toDate.value = "";
    }
  }

  function getDateRange(filterType) {
    const now = new Date();
    let from = new Date(), to = new Date();

    switch (filterType) {
      case "month":
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        break;
      case "year":
        from = new Date(now.getFullYear(), 0, 1);
        to = new Date(now.getFullYear(), 11, 31);
        break;
      case "week":
        const day = now.getDay();
        from = new Date(now);
        from.setDate(now.getDate() - day);
        to = new Date(now);
        to.setDate(now.getDate() + (6 - day));
        break;
      case "custom":
        from = fromDate.value ? new Date(fromDate.value) : new Date();
        to = toDate.value ? new Date(toDate.value) : new Date();
        break;
    }
    from.setHours(0, 0, 0, 0);
    to.setHours(23, 59, 59, 999);
    return { from, to };
  }

  async function populateAccountHeaders() {
    const user = auth.currentUser;
    if (!user) return;

    const accountsRef = collection(db, "users", user.uid, "chartOfAccounts");
    const snapshot = await getDocs(accountsRef);

    accountHeaderFilter.innerHTML = '<option value="all">All Accounts</option>';

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const name = data.name || data.accountName || "Unnamed";
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = name;
      accountHeaderFilter.appendChild(option);
    });

    if (accountIdFromURL) {
      accountHeaderFilter.value = accountIdFromURL;
    }
  }

  async function loadTrialBalance({ cursor = null, direction = 'next' } = {}) {
    const user = auth.currentUser;
    if (!user) return;

    if (dateFilter.value === "custom" && (!fromDate.value || !toDate.value)) {
      loadingStatus.textContent = "Select both from & to dates.";
      balanceTableBody.innerHTML = "";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }

    loadingStatus.textContent = "Loading...";

    const { from, to } = getDateRange(dateFilter.value);
    const selectedAccountId = accountHeaderFilter.value;

    const txRef = collection(db, "users", user.uid, "transactions");

    // Base query: date range + orderBy date descending
    let baseQuery = query(
      txRef,
      where("date", ">=", Timestamp.fromDate(from)),
      where("date", "<=", Timestamp.fromDate(to)),
      orderBy("date", "desc"),
      limit(PAGE_SIZE)
    );

    if (cursor) {
      if (direction === 'next') {
        baseQuery = query(baseQuery, startAfter(cursor));
      } else if (direction === 'prev') {
        // For simplicity, we don't implement startBefore here because it needs a different approach.
        // Using pageStack to go back.
      }
    }

    // Load all documents with date range
    let snap = await getDocs(baseQuery);

    // Filter by account + children if needed
    if (selectedAccountId !== "all") {
      const accountsRef = collection(db, "users", user.uid, "chartOfAccounts");

      // Get children accounts of selected account
      const childrenSnap = await getDocs(query(accountsRef, where("parentId", "==", selectedAccountId)));
      const accountIds = [selectedAccountId];
      childrenSnap.forEach(doc => accountIds.push(doc.id));

      // Filter fetched docs by account IDs in JS
      snap = {
        docs: snap.docs.filter(doc => accountIds.includes(doc.data().ACCOUNT_HEADER))
      };
    }

    if (snap.docs.length > 0) {
      firstVisible = snap.docs[0];
      lastVisible = snap.docs[snap.docs.length - 1];

      if (direction === 'next') {
        pageStack.push(lastVisible);
      } else if (direction === 'prev') {
        // Handled by popping stack on previous button click
      }
    }

    renderRows(snap.docs);

    // Enable/disable pagination buttons
    prevBtn.disabled = pageStack.length <= 1;
    nextBtn.disabled = snap.docs.length < PAGE_SIZE;

    loadingStatus.textContent = "Loaded";
  }

function renderRows(docs) {
  balanceTableBody.innerHTML = "";
  let totalExpense = 0;

  if (docs.length === 0) {
    balanceTableBody.innerHTML = '<tr><td colspan="4">No transactions found.</td></tr>';
    loadingStatus.textContent = "No data found.";
    return;
  }

  // sort by date descending
  docs.sort((a, b) => b.data().date.toDate() - a.data().date.toDate());

  docs.forEach(docSnap => {
    const d = docSnap.data();
    const dt = d.date.toDate().toLocaleDateString();
    const desc = d.DESCRIPTION || d.description || "";
    const header = d.ACCOUNT_HEADER || d.accountHeader || "";
    const expense = Number(d.EXPENSE || d.expense || 0);

    totalExpense += expense;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dt}</td>
      <td>${header}</td>
      <td>${desc}</td>
      <td style="text-align:right;">${expense.toFixed(2)}</td>`;
    balanceTableBody.appendChild(tr);
  });

  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.style.background = "#eee";
  trTotal.innerHTML = `
    <td>Total</td><td></td><td></td>
    <td style="text-align:right;">${totalExpense.toFixed(2)}</td>`;
  balanceTableBody.appendChild(trTotal);

  loadingStatus.textContent = "Loaded";
}

  </script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin:0; padding:0; background:#f9f9f9; }
    .top-bar { display:flex; justify-content:space-between; padding:10px 20px; background:#fff; border-bottom:1px solid #ccc; align-items:center; }
    .top-bar a { text-decoration:none; color:#333; font-weight:bold; }
    .user-section { display:flex; align-items:center; gap:10px; }
    .logout-btn { background:#c00; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold; }
    table { margin:20px auto; width:90%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:10px; }
    .filter { margin:20px; }
    input[type="date"] { padding:5px; margin-left:10px; }
    button { padding: 5px 10px; font-size: 1rem; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="coa.html">← Back to Chart of Accounts</a>
    <span id="loadingStatus">Loading...</span>
    <div class="user-section">
      <div id="userDisplay">User</div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </div>

  <h2>Trial Balance</h2>
  <div class="filter">
    Filter:
    <select id="dateFilter">
      <option value="month">This Month</option>
      <option value="year">This Year</option>
      <option value="week">This Week</option>
      <option value="custom">Custom</option>
    </select>
    <input type="date" id="fromDate" style="display:none;">
    <input type="date" id="toDate" style="display:none;">
    <select id="accountHeaderFilter">
      <option value="all">All Accounts</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Account</th><th>Description</th><th style="text-align:right;">Amount</th>
      </tr>
    </thead>
    <tbody id="balanceTableBody"></tbody>
  </table>
</body>
</html>
