<!DOCTYPE html>
<html>
<head>
  <title>Trial Balance</title>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Parse accountId from URL
  const urlParams = new URLSearchParams(window.location.search);
  const accountIdFromURL = urlParams.get("accountId");

  // DOM elements
  const dateFilter = document.getElementById("dateFilter");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const accountHeaderFilter = document.getElementById("accountHeaderFilter");
  const balanceTableBody = document.getElementById("balanceTableBody");
  const loadingStatus = document.getElementById("loadingStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const name = user.displayName || user.email || "User";
      userDisplay.textContent = name.charAt(0).toUpperCase() + name.slice(1);
      toggleCustomDateInputs();
      await populateAccountHeaders();
      loadTrialBalance();
    } else {
      window.location.href = "login.html";
    }
  });

  dateFilter.addEventListener("change", () => {
    toggleCustomDateInputs();
    loadTrialBalance();
  });
  fromDate.addEventListener("change", loadTrialBalance);
  toDate.addEventListener("change", loadTrialBalance);
  accountHeaderFilter.addEventListener("change", loadTrialBalance);

  function toggleCustomDateInputs() {
    if (dateFilter.value === "custom") {
      fromDate.style.display = "inline-block";
      toDate.style.display = "inline-block";
    } else {
      fromDate.style.display = "none";
      toDate.style.display = "none";
      fromDate.value = "";
      toDate.value = "";
    }
  }

  function getDateRange(filterType) {
    const now = new Date();
    let from = new Date(), to = new Date();

    switch (filterType) {
      case "month":
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        break;
      case "year":
        from = new Date(now.getFullYear(), 0, 1);
        to = new Date(now.getFullYear(), 11, 31);
        break;
      case "week":
        const day = now.getDay();
        from = new Date(now);
        from.setDate(now.getDate() - day);
        to = new Date(now);
        to.setDate(now.getDate() + (6 - day));
        break;
      case "custom":
        from = fromDate.value ? new Date(fromDate.value) : new Date();
        to = toDate.value ? new Date(toDate.value) : new Date();
        break;
    }
    from.setHours(0, 0, 0, 0);
    to.setHours(23, 59, 59, 999);
    return { from, to };
  }

  async function populateAccountHeaders() {
    const user = auth.currentUser;
    if (!user) return;

    const accountsRef = collection(db, "users", user.uid, "chartOfAccounts");
    const snapshot = await getDocs(accountsRef);

    accountHeaderFilter.innerHTML = '<option value="all">All Accounts</option>';
    const accountMap = {};

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const name = data.name || data.accountName || "Unnamed";
      accountMap[docSnap.id] = name;
    });

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const option = document.createElement("option");
      option.value = data.name;
      option.textContent = data.name;
      accountHeaderFilter.appendChild(option);
    });

    if (accountIdFromURL && accountMap[accountIdFromURL]) {
      accountHeaderFilter.value = accountMap[accountIdFromURL];
    }
  }

  async function loadTrialBalance() {
    const user = auth.currentUser;
    if (!user) return;

    if (dateFilter.value === "custom" && (!fromDate.value || !toDate.value)) {
      loadingStatus.textContent = "Select both from & to dates.";
      balanceTableBody.innerHTML = "";
      return;
    }

    toggleCustomDateInputs();
    loadingStatus.textContent = "Loading...";

    const { from, to } = getDateRange(dateFilter.value);
    const selectedAccount = accountHeaderFilter.value;

    const txRef = collection(db, "users", user.uid, "transactions");
    let queryRef = query(txRef,
      where("date", ">=", Timestamp.fromDate(from)),
      where("date", "<=", Timestamp.fromDate(to))
    );

    if (selectedAccount !== "all") {
      const accRef = collection(db, "users", user.uid, "chartOfAccounts");
      const accSnap = await getDocs(query(accRef, where("name", "==", selectedAccount)));
      if (!accSnap.empty) {
        const accDoc = accSnap.docs[0];
        const accId = accDoc.id;

        // find children via parentId
        const childrenSnap = await getDocs(query(accRef, where("parentId", "==", accId)));
        const names = [selectedAccount];
        childrenSnap.forEach(d => names.push(d.data().name));

        queryRef = queryRef.withConverter(null);
        // Firestore client SDK doesn't support `in` with multiple where simultaneously,
        // so just fetch all and filter in JS:
        const allSnap = await getDocs(queryRef);
        const results = allSnap.docs.filter(d => names.includes(d.data().ACCOUNT_HEADER));
        renderRows(results);
        return;
      } else {
        loadingStatus.textContent = "Account not found.";
        balanceTableBody.innerHTML = "";
        return;
      }
    }

    const snap = await getDocs(queryRef);
    renderRows(snap.docs);
  }

  function renderRows(docs) {
    balanceTableBody.innerHTML = "";
    let total = 0;

    if (docs.length === 0) {
      balanceTableBody.innerHTML = '<tr><td colspan="4">No transactions found.</td></tr>';
      loadingStatus.textContent = "No data found.";
      return;
    }

    // sort by date descending
    docs.sort((a, b) => b.data().date.toDate() - a.data().date.toDate());

    docs.forEach(docSnap => {
      const d = docSnap.data();
      const dt = d.date.toDate().toLocaleDateString();
      const desc = d.DESCRIPTION || d.description || "";
      const header = d.ACCOUNT_HEADER || d.accountHeader || "";
      const income = Number(d.INCOME || d.income || 0);
      const expense = Number(d.EXPENSE || d.expense || 0);
      const amount = income - expense;
      total += amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dt}</td>
        <td>${header}</td>
        <td>${desc}</td>
        <td style="text-align:right;">${amount.toFixed(2)}</td>`;
      balanceTableBody.appendChild(tr);
    });

    const trTotal = document.createElement("tr");
    trTotal.style.fontWeight = "bold";
    trTotal.style.background = "#eee";
    trTotal.innerHTML = `
      <td>Total</td><td></td><td></td>
      <td style="text-align:right;">${total.toFixed(2)}</td>`;
    balanceTableBody.appendChild(trTotal);

    loadingStatus.textContent = "Loaded";
  }
  </script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin:0; padding:0; background:#f9f9f9; }
    .top-bar { display:flex; justify-content:space-between; padding:10px 20px; background:#fff; border-bottom:1px solid #ccc; align-items:center; }
    .top-bar a { text-decoration:none; color:#333; font-weight:bold; }
    .user-section { display:flex; align-items:center; gap:10px; }
    .logout-btn { background:#c00; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold; }
    table { margin:20px auto; width:90%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:10px; }
    .filter { margin:20px; }
    input[type="date"] { padding:5px; margin-left:10px; }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="coa.html">‚Üê Back to Chart of Accounts</a>
    <span id="loadingStatus">Loading...</span>
    <div class="user-section">
      <div id="userDisplay">User</div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </div>

  <h2>Trial Balance</h2>
  <div class="filter">
    Filter:
    <select id="dateFilter">
      <option value="month">This Month</option>
      <option value="year">This Year</option>
      <option value="week">This Week</option>
      <option value="custom">Custom</option>
    </select>
    <input type="date" id="fromDate" style="display:none;">
    <input type="date" id="toDate" style="display:none;">
    <select id="accountHeaderFilter">
      <option value="all">All Accounts</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Account</th><th>Description</th><th style="text-align:right;">Amount</th>
      </tr>
    </thead>
    <tbody id="balanceTableBody"></tbody>
  </table>
</body>
</html>
