<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trial Balance with Drilldown Popup</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM elements
    const logoutBtn = document.getElementById("logoutBtn");
    const userDisplay = document.getElementById("userDisplay");
    const loadingStatus = document.getElementById("loadingStatus");
    const summaryBody = document.getElementById("trialBalanceBody");

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Modal controls
    function openDetailModal(account) {
      const modal = document.getElementById("detailModal");
      const iframe = document.getElementById("detailIframe");
      const url = `exp.html?account=${encodeURIComponent(account)}`;
      iframe.src = url;
      modal.style.display = "flex";
    }

    document.getElementById("closeModalBtn").addEventListener("click", () => {
      const modal = document.getElementById("detailModal");
      const iframe = document.getElementById("detailIframe");
      iframe.src = "";
      modal.style.display = "none";
    });

    // Load and render Trial Balance summary
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      userDisplay.textContent = user.displayName || user.email || "User";
      loadingStatus.textContent = "Loading Trial Balance...";

      try {
        // Load all transactions for user
        const txSnap = await getDocs(collection(db, "users", user.uid, "transactions"));
        const transactions = txSnap.docs.map(doc => {
          return { id: doc.id, ...doc.data() };
        });

        // Group transactions by ACCOUNT_HEADER for summary
        const summary = {};
        for (const tx of transactions) {
          const account = tx.ACCOUNT_HEADER || "Uncategorized";
          if (!summary[account]) summary[account] = { debit: 0, credit: 0 };
          summary[account].debit += Number(tx.EXPENSE || 0);
          summary[account].credit += Number(tx.INCOME || 0);
        }

        if (Object.keys(summary).length === 0) {
          summaryBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No data found.</td></tr>`;
          loadingStatus.textContent = "No transactions to summarize.";
          return;
        }

        // Render summary rows with clickable account headers
        let rows = "";
        for (const [account, amounts] of Object.entries(summary)) {
          const balance = amounts.credit - amounts.debit;
          rows += `
            <tr>
              <td><a href="#" class="accountLink" data-account="${account}">${account}</a></td>
              <td style="text-align:right;">${amounts.debit.toFixed(2)}</td>
              <td style="text-align:right;">${amounts.credit.toFixed(2)}</td>
              <td style="text-align:right; color:${balance >= 0 ? 'green' : 'red'}">${balance.toFixed(2)}</td>
            </tr>
          `;
        }
        summaryBody.innerHTML = rows;
        loadingStatus.textContent = "Trial Balance loaded.";

        // Add click handlers for all account links to open modal popup
        document.querySelectorAll(".accountLink").forEach(link => {
          link.addEventListener("click", e => {
            e.preventDefault();
            const account = e.target.getAttribute("data-account");
            if (!account) return;
            openDetailModal(account);
          });
        });

      } catch (error) {
        loadingStatus.textContent = `Error loading data: ${error.message}`;
        summaryBody.innerHTML = "";
      }
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    .logout-btn {
      background: #c00;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    th {
      background: #eee;
    }
    a.accountLink {
      cursor: pointer;
      color: #0645AD;
      text-decoration: underline;
    }
    a.accountLink:hover {
      color: #0B0080;
    }

    /* Modal styles */
    #detailModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #detailModal > div {
      background: #fff;
      width: 80vw;
      height: 80vh;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    #closeModalBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 22px;
      cursor: pointer;
      background: transparent;
      border: none;
      color: #666;
      font-weight: bold;
      user-select: none;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    #closeModalBtn:hover {
      background-color: #ddd;
    }
    #detailIframe {
      flex-grow: 1;
      border: none;
      border-radius: 0 0 8px 8px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="coa.html">← Back to Chart of Accounts</a>
    <div id="loadingStatus">Loading...</div>
    <div>
      <span id="userDisplay">User</span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </div>

  <h2 style="text-align:center;">Trial Balance Summary</h2>
  <table>
    <thead>
      <tr>
        <th>Account Header</th>
        <th>Total Debit (Expense)</th>
        <th>Total Credit (Income)</th>
        <th>Balance (Credit - Debit)</th>
      </tr>
    </thead>
    <tbody id="trialBalanceBody">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Modal popup container -->
  <div id="detailModal">
    <div>
      <button id="closeModalBtn" title="Close details popup">✖</button>
      <iframe id="detailIframe" src=""></iframe>
    </div>
  </div>
</body>
</html>
