<!DOCTYPE html>
<html>
<head>
  <title>Trial Balance</title>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, orderBy, limit, startAfter, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Parse accountId from URL (if any)
  const urlParams = new URLSearchParams(window.location.search);
  const accountIdFromURL = urlParams.get("accountId");

  // DOM elements
  const dateFilter = document.getElementById("dateFilter");
  const fromDate = document.getElementById("fromDate");
  const toDate = document.getElementById("toDate");
  const accountHeaderFilter = document.getElementById("accountHeaderFilter");
  const balanceTableBody = document.getElementById("balanceTableBody");
  const loadingStatus = document.getElementById("loadingStatus");
  const logoutBtn = document.getElementById("logoutBtn");
  const userDisplay = document.getElementById("userDisplay");

  // Pagination variables
  const PAGE_SIZE = 10;
  let lastVisible = null;
  let pageStack = []; // stack to track pages for 'previous' button

  // Pagination controls setup
  const paginationControls = document.createElement('div');
  paginationControls.style.margin = "10px auto";
  paginationControls.style.width = "90%";
  paginationControls.style.textAlign = "center";

  const prevBtn = document.createElement('button');
  prevBtn.textContent = "Previous";
  prevBtn.disabled = true;
  prevBtn.style.marginRight = "10px";

  const nextBtn = document.createElement('button');
  nextBtn.textContent = "Next";

  paginationControls.appendChild(prevBtn);
  paginationControls.appendChild(nextBtn);

  document.querySelector('table').after(paginationControls);

  // Previous button click
  prevBtn.addEventListener('click', () => {
    if (pageStack.length > 1) {
      pageStack.pop(); // remove current page's cursor
      const prevCursor = pageStack[pageStack.length - 1];
      loadTrialBalance({ cursor: prevCursor, direction: 'prev' });
    }
  });

  // Next button click
  nextBtn.addEventListener('click', () => {
    loadTrialBalance({ cursor: lastVisible, direction: 'next' });
  });

  // Logout button
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });

  // On user auth state change
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const name = user.displayName || user.email || "User";
      userDisplay.textContent = name.charAt(0).toUpperCase() + name.slice(1);
      toggleCustomDateInputs();
      await populateAccountHeaders();
      pageStack = [null]; // reset pagination stack
      loadTrialBalance({ cursor: null, direction: 'next' });
    } else {
      window.location.href = "login.html";
    }
  });

  // Filters event listeners to reload data
  dateFilter.addEventListener("change", () => {
    toggleCustomDateInputs();
    resetAndLoad();
  });
  fromDate.addEventListener("change", resetAndLoad);
  toDate.addEventListener("change", resetAndLoad);
  accountHeaderFilter.addEventListener("change", resetAndLoad);

  function resetAndLoad() {
    pageStack = [null];
    loadTrialBalance({ cursor: null, direction: 'next' });
  }

  function toggleCustomDateInputs() {
    if (dateFilter.value === "custom") {
      fromDate.style.display = "inline-block";
      toDate.style.display = "inline-block";
    } else {
      fromDate.style.display = "none";
      toDate.style.display = "none";
      fromDate.value = "";
      toDate.value = "";
    }
  }

  // Returns Date range from filter type
  function getDateRange(filterType) {
    const now = new Date();
    let from = new Date(), to = new Date();

    switch (filterType) {
      case "month":
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        break;
      case "year":
        from = new Date(now.getFullYear(), 0, 1);
        to = new Date(now.getFullYear(), 11, 31);
        break;
      case "week":
        const day = now.getDay();
        from = new Date(now);
        from.setDate(now.getDate() - day);
        to = new Date(now);
        to.setDate(now.getDate() + (6 - day));
        break;
      case "custom":
        from = fromDate.value ? new Date(fromDate.value) : new Date();
        to = toDate.value ? new Date(toDate.value) : new Date();
        break;
    }
    from.setHours(0, 0, 0, 0);
    to.setHours(23, 59, 59, 999);
    return { from, to };
  }

  // Populate account header dropdown
  async function populateAccountHeaders() {
    const user = auth.currentUser;
    if (!user) return;

    const accountsRef = collection(db, "users", user.uid, "chartOfAccounts");
    const snapshot = await getDocs(accountsRef);

    accountHeaderFilter.innerHTML = '<option value="all">All Accounts</option>';

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const name = data.name || data.accountName || "Unnamed";
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = name;
      accountHeaderFilter.appendChild(option);
    });

    if (accountIdFromURL) {
      accountHeaderFilter.value = accountIdFromURL;
    }
  }

  // Load trial balance with pagination and filters
  async function loadTrialBalance({ cursor = null, direction = 'next' } = {}) {
    const user = auth.currentUser;
    if (!user) return;

    if (dateFilter.value === "custom" && (!fromDate.value || !toDate.value)) {
      loadingStatus.textContent = "Select both from & to dates.";
      balanceTableBody.innerHTML = "";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }

    loadingStatus.textContent = "Loading...";
    balanceTableBody.innerHTML = "";

    const { from, to } = getDateRange(dateFilter.value);
    const selectedAccountId = accountHeaderFilter.value;

    const txRef = collection(db, "users", user.uid, "transactions");

    // Build base query
    let baseQuery = query(
      txRef,
      where("date", ">=", Timestamp.fromDate(from)),
      where("date", "<=", Timestamp.fromDate(to)),
      orderBy("date", "desc"),
      limit(PAGE_SIZE)
    );

    if (cursor && direction === 'next') {
      baseQuery = query(baseQuery, startAfter(cursor));
    }

    let snap = await getDocs(baseQuery);

    // Filter by selected account and children accounts if necessary
    if (selectedAccountId !== "all") {
      const accountsRef = collection(db, "users", user.uid, "chartOfAccounts");

      // Fetch children accounts of selected account
      const childrenSnap = await getDocs(query(accountsRef, where("parentId", "==", selectedAccountId)));
      const accountIds = [selectedAccountId];
      childrenSnap.forEach(doc => accountIds.push(doc.id));

      // Filter transactions locally
      snap = {
        docs: snap.docs.filter(doc => accountIds.includes(doc.data().ACCOUNT_HEADER))
      };
    }

    if (snap.docs.length > 0) {
      // Update pagination cursors
      firstVisible = snap.docs[0];
      lastVisible = snap.docs[snap.docs.length - 1];

      if (direction === 'next') {
        pageStack.push(lastVisible);
      }
    }

    renderRows(snap.docs);

    // Enable/disable buttons
    prevBtn.disabled = pageStack.length <= 1;
    nextBtn.disabled = snap.docs.length < PAGE_SIZE;

    loadingStatus.textContent = "Loaded";
  }

  // Render transaction rows
  function renderRows(docs) {
  balanceTableBody.innerHTML = "";
  
  if (docs.length === 0) {
    balanceTableBody.innerHTML = '<tr><td colspan="10">No transactions found.</td></tr>';
    loadingStatus.textContent = "No data found.";
    return;
  }

  // Sort by date descending just in case
  docs.sort((a, b) => b.data().date.toDate() - a.data().date.toDate());

  let runningBalance = 0;

  docs.forEach((docSnap, index) => {
    const d = docSnap.data();
    const dateObj = d.date.toDate();

    const dateStr = dateObj.toLocaleDateString();
    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    const accountHeader = d.ACCOUNT_HEADER || d.accountHeader || "";
    const mode = d.MODE || d.mode || "";
    const bankName = d.BANK_NAME || d.bankName || "";
    const income = Number(d.INCOME || d.income || 0);
    const expense = Number(d.EXPENSE || d.expense || 0);
    const description = d.DESCRIPTION || d.description || "";

    // Update running balance
    runningBalance += (income - expense);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${dateStr}</td>
      <td>${timeStr}</td>
      <td>${accountHeader}</td>
      <td>${mode}</td>
      <td>${bankName}</td>
      <td style="text-align:right;">${income.toFixed(2)}</td>
      <td style="text-align:right;">${expense.toFixed(2)}</td>
      <td>${description}</td>
      <td style="text-align:right;">${runningBalance.toFixed(2)}</td>
    `;
    balanceTableBody.appendChild(tr);
  });

  // Optionally add a total row for income, expense, and balance
  const totalIncome = docs.reduce((sum, d) => sum + Number(d.data().INCOME || d.data().income || 0), 0);
  const totalExpense = docs.reduce((sum, d) => sum + Number(d.data().EXPENSE || d.data().expense || 0), 0);

  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.style.background = "#eee";
  trTotal.innerHTML = `
    <td colspan="6">Total</td>
    <td style="text-align:right;">${totalIncome.toFixed(2)}</td>
    <td style="text-align:right;">${totalExpense.toFixed(2)}</td>
    <td></td>
    <td style="text-align:right;">${(totalIncome - totalExpense).toFixed(2)}</td>
  `;
  balanceTableBody.appendChild(trTotal);

  loadingStatus.textContent = "Loaded";
}

  </script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin:0; padding:0; background:#f9f9f9; }
    .top-bar { display:flex; justify-content:space-between; padding:10px 20px; background:#fff; border-bottom:1px solid #ccc; align-items:center; }
    .top-bar a { text-decoration:none; color:#333; font-weight:bold; }
    .user-section { display:flex; align-items:center; gap:10px; }
    .logout-btn { background:#c00; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold; }
    table { margin:20px auto; width:90%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:10px; }
    .filter { margin:20px; }
    input[type="date"] { padding:5px; margin-left:10px; }
    button { padding: 5px 10px; font-size: 1rem; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="top-bar">
    <a href="coa.html">← Back to Chart of Accounts</a>
    <span id="loadingStatus">Loading...</span>
    <div class="user-section">
      <div id="userDisplay">User</div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </div>

  <h2>Trial Balance</h2>

  <div class="filter">
    Filter:
    <select id="dateFilter">
      <option value="month">This Month</option>
      <option value="year">This Year</option>
      <option value="week">This Week</option>
      <option value="custom">Custom</option>
    </select>
    <input type="date" id="fromDate" style="display:none;">
    <input type="date" id="toDate" style="display:none;">
    <select id="accountHeaderFilter">
      <option value="all">All Accounts</option>
    </select>
  </div>

<table>
  <thead>
    <tr>
      <th>SINO</th>
      <th>DATE</th>
      <th>TIME</th>
      <th>ACCOUNT HEADER</th>
      <th>MODE</th>
      <th>BANK NAME</th>
      <th style="text-align:right;">INCOME</th>
      <th style="text-align:right;">EXPENSE</th>
      <th>DESCRIPTION</th>
      <th style="text-align:right;">BALANCE</th>
    </tr>
  </thead>
  <tbody id="balanceTableBody"></tbody>
</table>

</body>
</html>
