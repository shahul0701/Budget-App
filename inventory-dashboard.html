<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¯ Inventory Pro - Complete Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* All previous CSS styles remain exactly the same */
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --success: #00b09b;
            --warning: #f46b45;
            --danger: #ff416c;
            --info: #3498db;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --purple: #9b59b6;
            --teal: #1abc9c;
            --orange: #e67e22;
            --pink: #e84393;
            --sidebar-width: 280px;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            --gradient-warning: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            --gradient-danger: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --gradient-info: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            color: var(--dark);
        }
        
        /* All previous CSS styles remain exactly the same - keep all the CSS from your original code */
        
        /* Balance Section Styles */
        .balance-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }
        
        .balance-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .balance-title i {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 12px;
        }
        
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .balance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .balance-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #666;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-card-value {
            font-size: 42px;
            font-weight: 800;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 15px;
        }
        
        .balance-card-positive {
            color: var(--success);
        }
        
        .balance-card-negative {
            color: var(--danger);
        }
        
        .balance-card-neutral {
            color: var(--info);
        }
        
        .balance-card-change {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .balance-card-change.positive {
            color: var(--success);
        }
        
        .balance-card-change.negative {
            color: var(--danger);
        }
        
        .balance-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .balance-history-table {
            margin-top: 30px;
        }
        
        .transaction-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .transaction-income {
            background: rgba(0, 176, 155, 0.1);
            color: var(--success);
        }
        
        .transaction-expense {
            background: rgba(255, 65, 108, 0.1);
            color: var(--danger);
        }
        
        .transaction-transfer {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }
        
        /* Notes Section Styles */
        .notes-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }
        
        .notes-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notes-title i {
            background: var(--gradient-primary);
            color: white;
            padding: 12px;
            border-radius: 12px;
        }
        
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .note-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .note-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .note-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .note-card-category {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .note-card-content {
            flex: 1;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-line;
        }
        
        .note-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .note-card-date {
            font-size: 12px;
            color: #999;
        }
        
        .note-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .empty-notes {
            text-align: center;
            padding: 60px 20px;
            grid-column: 1 / -1;
        }
        
        .empty-notes i {
            font-size: 72px;
            margin-bottom: 25px;
            opacity: 0.3;
            color: var(--primary);
        }
        
        .empty-notes h4 {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--dark);
            font-weight: 700;
        }
        
        .empty-notes p {
            font-size: 18px;
            margin-bottom: 30px;
            color: #666;
        }
        
        /* All previous CSS remains exactly the same - only adding new styles above */
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <h3>Loading Inventory Pro...</h3>
        <p>Please wait while we load your data</p>
    </div>
    
    <!-- Animated Background -->
    <div class="background-animation"></div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-warehouse floating"></i> <span>INVENTORY PRO</span></h3>
            <p>Complete Management System</p>
        </div>
        
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" onclick="showDashboard()">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showInventory()">
                <i class="fas fa-boxes"></i>
                <span>Inventory</span>
                <span class="menu-badge" id="inventoryBadge">0</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showSales()">
                <i class="fas fa-shopping-cart"></i>
                <span>Sales</span>
                <span class="menu-badge" id="salesBadge">0</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showCustomers()">
                <i class="fas fa-users"></i>
                <span>Customers</span>
                <span class="menu-badge" id="customersBadge">0</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showBalance()">
                <i class="fas fa-balance-scale"></i>
                <span>Balance & Cash</span>
                <span class="menu-badge" id="balanceBadge">0</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showNotes()">
                <i class="fas fa-sticky-note"></i>
                <span>Notes</span>
                <span class="menu-badge" id="notesBadge">0</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showReports()">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
                <span class="menu-badge" id="reportsBadge">3</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showAnalytics()">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            
            <a href="#" class="menu-item" onclick="showSettings()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            
            <div style="margin-top: 50px; padding: 20px; border-top: 1px solid #eee;">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h5 id="userName">Loading...</h5>
                        <small id="userEmail">Loading...</small>
                    </div>
                </div>
                <a href="home.html" class="menu-item" style="margin-top: 15px;">
                    <i class="fas fa-home"></i>
                    <span>Back to Home</span>
                </a>
                <a href="#" class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <p class="pageSubtitle" id="pageSubtitle">Welcome to your inventory management system</p>
            </div>
            
            <div class="top-actions">
                <button class="action-btn pulse" onclick="openNewSaleModal()">
                    <i class="fas fa-cash-register"></i> New Sale
                </button>
                <button class="action-btn success" onclick="openNewItemModal()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
                <button class="action-btn warning" onclick="openNewCustomerModal()">
                    <i class="fas fa-user-plus"></i> Add Customer
                </button>
                <button class="action-btn info" onclick="createTestSale()">
                    <i class="fas fa-vial"></i> Test Data
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Stats Cards - Same as before -->
            <div class="stats-grid">
                <!-- All stat cards from previous code remain exactly the same -->
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-value" id="totalItemsStat">0</div>
                    <div class="stat-label">Total Items in Stock</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span id="itemsChange">0%</span> from last month
                    </div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-value" id="todaySalesStat">â‚¹0</div>
                    <div class="stat-label">Today's Sales</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span id="salesChange">0%</span> from yesterday
                    </div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value" id="lowStockStat">0</div>
                    <div class="stat-label">Low Stock Items</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="lowStockProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-value" id="outOfStockStat">0</div>
                    <div class="stat-label">Out of Stock</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="outOfStockProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalCustomersStat">0</div>
                    <div class="stat-label">Total Customers</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span id="customersChange">0%</span> this month
                    </div>
                </div>
                
                <div class="stat-card purple">
                    <div class="stat-icon">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                    <div class="stat-value" id="totalValueStat">â‚¹0</div>
                    <div class="stat-label">Total Inventory Value</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span id="valueChange">0%</span> growth
                    </div>
                </div>
                
                <div class="stat-card" style="border-left: 5px solid #e67e22;">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="pendingPaymentsStat">â‚¹0</div>
                    <div class="stat-label">Pending Payments</div>
                    <div class="stat-change negative">
                        <i class="fas fa-exclamation-circle"></i> <span id="pendingChange">0</span> payments due
                    </div>
                </div>
                
                <div class="stat-card" style="border-left: 5px solid #9b59b6;">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value" id="monthlyGrowthStat">0%</div>
                    <div class="stat-label">Monthly Growth</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> Revenue increase
                    </div>
                </div>
            </div>

            <!-- Charts - Same as before -->
            <div class="charts-container">
                <!-- All chart cards from previous code remain exactly the same -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-chart-line"></i> Sales Overview</h3>
                        <div class="date-range">
                            <input type="date" class="form-control" id="salesDateFrom" style="width: 150px;">
                            <span>to</span>
                            <input type="date" class="form-control" id="salesDateTo" style="width: 150px;">
                            <button class="action-btn" onclick="updateSalesChart()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Top Selling Items</h3>
                        <select class="form-control" id="topItemsPeriod" onchange="updateTopItemsChart()" style="width: 150px;">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="topItemsChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Category Distribution</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-chart-area"></i> Monthly Performance</h3>
                        <select class="form-control" id="performanceYear" onchange="updatePerformanceChart()" style="width: 150px;">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions & Low Stock - Same as before -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <!-- Recent Sales -->
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-history"></i> Recent Sales</h3>
                        <div class="table-actions">
                            <button class="action-btn" onclick="showSales()">
                                View All
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recentSalesTable">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Low Stock Items -->
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-exclamation-circle"></i> Low Stock Items</h3>
                        <button class="action-btn warning" onclick="showInventory()">
                            <i class="fas fa-box"></i> View All
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Stock</th>
                                    <th>Min</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockTable">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Payments -->
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title"><i class="fas fa-clock"></i> Pending Payments</h3>
                    <button class="action-btn info" onclick="showSales()">
                        <i class="fas fa-eye"></i> View All
                    </button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Paid</th>
                                <th>Due</th>
                                <th>Due Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pendingPaymentsTable">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <h4>No pending payments</h4>
                                    <p>All payments are cleared</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Balance & Cash Content -->
        <div id="balanceContent" style="display: none;">
            <div class="balance-section">
                <div class="balance-header">
                    <h3 class="balance-title"><i class="fas fa-balance-scale"></i> Balance & Cash Flow</h3>
                    <div class="balance-actions">
                        <button class="action-btn success" onclick="openAddTransactionModal()">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                        <button class="action-btn info" onclick="openTransferModal()">
                            <i class="fas fa-exchange-alt"></i> Transfer Funds
                        </button>
                        <button class="action-btn" onclick="exportBalanceReport()">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                        <button class="action-btn warning" onclick="printBalanceStatement()">
                            <i class="fas fa-print"></i> Print Statement
                        </button>
                    </div>
                </div>
                
                <div class="balance-grid">
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-wallet"></i> Cash in Hand
                        </div>
                        <div class="balance-card-value balance-card-positive" id="cashInHand">â‚¹0.00</div>
                        <div class="balance-card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="cashChange">0%</span> from last month
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Available for daily operations
                        </div>
                    </div>
                    
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-university"></i> Bank Balance
                        </div>
                        <div class="balance-card-value balance-card-neutral" id="bankBalance">â‚¹0.00</div>
                        <div class="balance-card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="bankChange">0%</span> from last month
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Across all bank accounts
                        </div>
                    </div>
                    
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-credit-card"></i> Credit Available
                        </div>
                        <div class="balance-card-value balance-card-positive" id="creditAvailable">â‚¹0.00</div>
                        <div class="balance-card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="creditChange">0%</span> limit used
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Available credit from suppliers
                        </div>
                    </div>
                    
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-hand-holding-usd"></i> Total Receivables
                        </div>
                        <div class="balance-card-value balance-card-negative" id="totalReceivables">â‚¹0.00</div>
                        <div class="balance-card-change negative">
                            <i class="fas fa-exclamation-circle"></i> <span id="receivablesCount">0</span> pending
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Amount to be received from customers
                        </div>
                    </div>
                    
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-file-invoice-dollar"></i> Total Payables
                        </div>
                        <div class="balance-card-value balance-card-negative" id="totalPayables">â‚¹0.00</div>
                        <div class="balance-card-change negative">
                            <i class="fas fa-exclamation-circle"></i> <span id="payablesCount">0</span> pending
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Amount to be paid to suppliers
                        </div>
                    </div>
                    
                    <div class="balance-card">
                        <div class="balance-card-title">
                            <i class="fas fa-chart-line"></i> Net Profit
                        </div>
                        <div class="balance-card-value balance-card-positive" id="netProfit">â‚¹0.00</div>
                        <div class="balance-card-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="profitChange">0%</span> this month
                        </div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            After all expenses and taxes
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Cash Flow Chart -->
                <div class="chart-card" style="margin-top: 30px;">
                    <div class="chart-header">
                        <h3 class="chart-title"><i class="fas fa-chart-line"></i> Monthly Cash Flow</h3>
                        <select class="form-control" id="cashFlowYear" onchange="updateCashFlowChart()" style="width: 150px;">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="table-card balance-history-table">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-history"></i> Recent Transactions</h3>
                        <div class="table-actions">
                            <button class="action-btn" onclick="viewAllTransactions()">
                                View All Transactions
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactionsTable">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="fas fa-exchange-alt"></i>
                                        <h4>No transactions yet</h4>
                                        <p>Start adding transactions to see them here</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Content -->
        <div id="notesContent" style="display: none;">
            <div class="notes-section">
                <div class="notes-header">
                    <h3 class="notes-title"><i class="fas fa-sticky-note"></i> Notes & Memos</h3>
                    <div class="notes-actions">
                        <button class="action-btn success" onclick="openNewNoteModal()">
                            <i class="fas fa-plus"></i> Add Note
                        </button>
                        <button class="action-btn info" onclick="openNoteCategoriesModal()">
                            <i class="fas fa-tags"></i> Manage Categories
                        </button>
                        <button class="action-btn" onclick="exportNotes()">
                            <i class="fas fa-download"></i> Export Notes
                        </button>
                    </div>
                </div>
                
                <!-- Notes Filter -->
                <div class="filter-controls" style="margin-bottom: 25px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-search"></i> Search Notes</label>
                            <input type="text" class="form-control" id="searchNotes" placeholder="Search in notes..." oninput="filterNotes()">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-filter"></i> Category</label>
                            <select class="form-control" id="filterNoteCategory" onchange="filterNotes()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Date Range</label>
                            <select class="form-control" id="filterNoteDate" onchange="filterNotes()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="action-btn" onclick="clearNoteFilters()">
                                <i class="fas fa-redo"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Notes Grid -->
                <div class="notes-grid" id="notesGrid">
                    <div class="empty-notes">
                        <i class="fas fa-sticky-note"></i>
                        <h4>No notes yet</h4>
                        <p>Create your first note to start organizing your thoughts</p>
                        <button class="action-btn success" onclick="openNewNoteModal()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Create Your First Note
                        </button>
                    </div>
                </div>
                
                <!-- Notes Statistics -->
                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <div class="stat-value" id="totalNotesStat">0</div>
                        <div class="stat-label">Total Notes</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="notesChange">0%</span> this month
                        </div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="completedNotesStat">0</div>
                        <div class="stat-label">Completed Notes</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> <span id="completedChange">0%</span> completion rate
                        </div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" id="pendingNotesStat">0</div>
                        <div class="stat-label">Pending Notes</div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="pendingNotesProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="stat-value" id="noteCategoriesStat">0</div>
                        <div class="stat-label">Categories</div>
                        <div class="stat-change positive">
                            <i class="fas fa-plus"></i> <span id="categoriesChange">0</span> categories
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Content - Same as before -->
        <div id="inventoryContent" style="display: none;">
            <div class="table-card">
                <div class="table-header">
                    <h3 class="table-title"><i class="fas fa-boxes"></i> All Inventory Items</h3>
                    <div class="table-actions">
                        <div class="search-box">
                            <input type="text" placeholder="Search items..." id="searchInventory" oninput="updateInventoryTable(1)">
                            <i class="fas fa-search"></i>
                        </div>
                        <select class="form-control" id="filterCategory" style="width: 180px;" onchange="updateInventoryTable(1)">
                            <option value="">All Categories</option>
                        </select>
                        <select class="form-control" id="filterStatus" style="width: 150px;" onchange="updateInventoryTable(1)">
                            <option value="">All Status</option>
                            <option value="in_stock">In Stock</option>
                            <option value="low_stock">Low Stock</option>
                            <option value="out_of_stock">Out of Stock</option>
                        </select>
                        <button class="action-btn success" onclick="openNewItemModal()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="inventoryPagination"></div>
            </div>
        </div>

        <!-- Sales Content - Same as before -->
        <div id="salesContent" style="display: none;">
            <!-- Sales content from previous code remains exactly the same -->
        </div>

        <!-- Customers Content - Same as before -->
        <div id="customersContent" style="display: none;">
            <!-- Customers content from previous code remains exactly the same -->
        </div>

        <!-- Reports Content - Same as before -->
        <div id="reportsContent" style="display: none;">
            <!-- Reports content from previous code remains exactly the same -->
        </div>

        <!-- Analytics Content - Same as before -->
        <div id="analyticsContent" style="display: none;">
            <!-- Analytics content from previous code remains exactly the same -->
        </div>
    </div>

    <!-- ==================== NEW MODALS FOR BALANCE & NOTES ==================== -->

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="addTransactionModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Transaction</h3>
                <button class="close-modal" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-calendar"></i> Date *</label>
                            <input type="date" class="form-control" id="transactionDate" required value="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-rupee-sign"></i> Amount *</label>
                            <input type="number" class="form-control" id="transactionAmount" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-file-alt"></i> Description *</label>
                        <input type="text" class="form-control" id="transactionDescription" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-exchange-alt"></i> Transaction Type *</label>
                            <select class="form-control" id="transactionType" required onchange="toggleTransactionFields()">
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-tags"></i> Category *</label>
                            <select class="form-control" id="transactionCategory" required>
                                <option value="sales">Sales</option>
                                <option value="purchase">Purchase</option>
                                <option value="salary">Salary</option>
                                <option value="rent">Rent</option>
                                <option value="utilities">Utilities</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-wallet"></i> Payment Method *</label>
                            <select class="form-control" id="transactionPaymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="upi">UPI</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="form-group" id="transactionAccountGroup" style="display: none;">
                            <label class="form-label"><i class="fas fa-university"></i> Account</label>
                            <select class="form-control" id="transactionAccount">
                                <option value="main">Main Account</option>
                                <option value="savings">Savings Account</option>
                                <option value="current">Current Account</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" id="transferFields" style="display: none;">
                        <label class="form-label"><i class="fas fa-exchange-alt"></i> Transfer Details</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label>From Account</label>
                                <select class="form-control" id="transferFrom">
                                    <option value="cash">Cash</option>
                                    <option value="bank">Bank</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>To Account</label>
                                <select class="form-control" id="transferTo">
                                    <option value="bank">Bank</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-sticky-note"></i> Notes</label>
                        <textarea class="form-control" id="transactionNotes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group" id="attachmentSection">
                        <label class="form-label"><i class="fas fa-paperclip"></i> Attachment</label>
                        <input type="file" class="form-control" id="transactionAttachment" accept=".pdf,.jpg,.jpeg,.png">
                        <small class="text-muted">Upload receipt or document (PDF, JPG, PNG)</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <button type="button" class="action-btn" onclick="closeModal('addTransactionModal')" style="width: 100%;">
                                Cancel
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="action-btn success" onclick="saveTransaction()" style="width: 100%;">
                                <i class="fas fa-save"></i> Save Transaction
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transfer Funds Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Funds</h3>
                <button class="close-modal" onclick="closeModal('transferModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar"></i> Transfer Date *</label>
                        <input type="date" class="form-control" id="transferDate" required value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-sign-out-alt"></i> From Account *</label>
                            <select class="form-control" id="fromAccount" required>
                                <option value="cash">Cash</option>
                                <option value="bank_main">Main Bank Account</option>
                                <option value="bank_savings">Savings Account</option>
                            </select>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                Balance: <span id="fromAccountBalance">â‚¹0.00</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-sign-in-alt"></i> To Account *</label>
                            <select class="form-control" id="toAccount" required>
                                <option value="bank_main">Main Bank Account</option>
                                <option value="bank_savings">Savings Account</option>
                                <option value="cash">Cash</option>
                            </select>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                Balance: <span id="toAccountBalance">â‚¹0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-rupee-sign"></i> Amount *</label>
                        <input type="number" class="form-control" id="transferAmount" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-file-alt"></i> Purpose *</label>
                        <input type="text" class="form-control" id="transferPurpose" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-sticky-note"></i> Reference/Notes</label>
                        <textarea class="form-control" id="transferNotes" rows="2"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <button type="button" class="action-btn" onclick="closeModal('transferModal')" style="width: 100%;">
                                Cancel
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="action-btn success" onclick="processTransfer()" style="width: 100%;">
                                <i class="fas fa-exchange-alt"></i> Process Transfer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View All Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 class="modal-title">All Transactions</h3>
                <button class="close-modal" onclick="closeModal('transactionsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date From</label>
                            <input type="date" class="form-control" id="transactionsDateFrom">
                        </div>
                        <div class="form-group">
                            <label>Date To</label>
                            <input type="date" class="form-control" id="transactionsDateTo">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select class="form-control" id="transactionsType">
                                <option value="">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-control" id="transactionsCategory">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="action-btn" onclick="filterTransactions()">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-history"></i> Transaction History</h3>
                        <div class="table-actions">
                            <button class="action-btn info" onclick="exportTransactions()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="action-btn" onclick="printTransactionReport()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Payment Method</th>
                                    <th>Amount</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allTransactionsTable">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="transactionsPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Note Modal -->
    <div class="modal-overlay" id="newNoteModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Create New Note</h3>
                <button class="close-modal" onclick="closeModal('newNoteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newNoteForm">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-heading"></i> Title *</label>
                        <input type="text" class="form-control" id="noteTitle" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-tags"></i> Category *</label>
                            <select class="form-control" id="noteCategory" required>
                                <option value="general">General</option>
                                <option value="important">Important</option>
                                <option value="todo">To-Do</option>
                                <option value="idea">Idea</option>
                                <option value="reminder">Reminder</option>
                                <option value="meeting">Meeting Notes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-calendar"></i> Due Date</label>
                            <input type="date" class="form-control" id="noteDueDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-sticky-note"></i> Content *</label>
                        <textarea class="form-control" id="noteContent" rows="8" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-palette"></i> Color</label>
                            <div class="color-picker">
                                <div class="color-option" style="background: #ffffff;" onclick="selectNoteColor('#ffffff')"></div>
                                <div class="color-option" style="background: #f8f9fa;" onclick="selectNoteColor('#f8f9fa')"></div>
                                <div class="color-option" style="background: #e3f2fd;" onclick="selectNoteColor('#e3f2fd')"></div>
                                <div class="color-option" style="background: #f3e5f5;" onclick="selectNoteColor('#f3e5f5')"></div>
                                <div class="color-option" style="background: #e8f5e9;" onclick="selectNoteColor('#e8f5e9')"></div>
                                <div class="color-option" style="background: #fff3e0;" onclick="selectNoteColor('#fff3e0')"></div>
                                <div class="color-option" style="background: #fce4ec;" onclick="selectNoteColor('#fce4ec')"></div>
                            </div>
                            <input type="hidden" id="noteColor" value="#ffffff">
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-bell"></i> Reminder</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="datetime-local" class="form-control" id="noteReminder">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="noteReminderEnabled">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-paperclip"></i> Attachments</label>
                        <input type="file" class="form-control" id="noteAttachments" multiple>
                        <small class="text-muted">You can attach multiple files</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <button type="button" class="action-btn" onclick="closeModal('newNoteModal')" style="width: 100%;">
                                Cancel
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="action-btn success" onclick="saveNote()" style="width: 100%;">
                                <i class="fas fa-save"></i> Save Note
                            </button>
                        </div>
                        <div class="form-group">
                            <button type="button" class="action-btn info" onclick="saveNoteAsDraft()" style="width: 100%;">
                                <i class="fas fa-file-alt"></i> Save as Draft
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Note Modal -->
    <div class="modal-overlay" id="viewNoteModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="viewNoteTitle">Note Details</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" onclick="editCurrentNote()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="action-btn success" onclick="markNoteComplete()">
                        <i class="fas fa-check"></i> Complete
                    </button>
                    <button class="action-btn info" onclick="printNote()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="close-modal" onclick="closeModal('viewNoteModal')">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="noteDetails">
                    <!-- Note details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Note Categories Modal -->
    <div class="modal-overlay" id="noteCategoriesModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Note Categories</h3>
                <button class="close-modal" onclick="closeModal('noteCategoriesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-plus"></i> Add New Category</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" id="newCategoryName" placeholder="Category name">
                        <input type="color" class="form-control" id="newCategoryColor" value="#4e54c8" style="width: 60px;">
                        <button class="action-btn success" onclick="addNoteCategory()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <div class="table-card" style="margin-top: 20px;">
                    <div class="table-header">
                        <h3 class="table-title"><i class="fas fa-tags"></i> Existing Categories</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Color</th>
                                    <th>Notes Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="noteCategoriesTable">
                                <!-- Categories will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All previous modals (newItemModal, newSaleModal, invoiceModal, newCustomerModal, editCustomerModal, companyDetailsModal, settingsModal, paymentModal) remain exactly the same -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let inventoryItems = [];
        let customers = [];
        let sales = [];
        let transactions = [];
        let notes = [];
        let noteCategories = [];
        let categories = [];
        let saleCart = [];
        let charts = {};
        let currentReportType = 'salesReport';
        let currentSalesTab = 'allSales';
        let currentEditingCustomerId = null;
        let companyDetails = null;
        let appSettings = null;
        let splitPaymentMethods = [];
        let selectedPaymentMethod = 'cash';
        let currentInventoryPage = 1;
        let currentSalesPage = 1;
        let currentCustomersPage = 1;
        let currentBalance = {
            cashInHand: 0,
            bankBalance: 0,
            totalReceivables: 0,
            totalPayables: 0,
            creditAvailable: 100000,
            netProfit: 0
        };

        // Default note categories
        const defaultNoteCategories = [
            { id: 'general', name: 'General', color: '#ffffff', count: 0 },
            { id: 'important', name: 'Important', color: '#ffebee', count: 0 },
            { id: 'todo', name: 'To-Do', color: '#e3f2fd', count: 0 },
            { id: 'idea', name: 'Idea', color: '#f3e5f5', count: 0 },
            { id: 'reminder', name: 'Reminder', color: '#fff3e0', count: 0 },
            { id: 'meeting', name: 'Meeting Notes', color: '#e8f5e9', count: 0 }
        ];

        // Category structure
        const categoryStructure = {
            "Electronics": ["Mobile Phones", "Laptops", "Tablets", "Headphones", "Speakers", "Smart Watches", "Cameras", "Accessories"],
            "Clothing": ["Men's Wear", "Women's Wear", "Kids Wear", "Footwear", "Accessories", "Sports Wear"],
            "Food & Beverages": ["Snacks", "Beverages", "Dairy", "Frozen Foods", "Bakery", "Canned Goods"],
            "Home & Kitchen": ["Cookware", "Utensils", "Appliances", "Furniture", "Decor", "Cleaning Supplies"],
            "Furniture": ["Living Room", "Bedroom", "Office", "Outdoor", "Kitchen", "Storage"],
            "Stationery": ["Pens & Pencils", "Notebooks", "Office Supplies", "Art Supplies", "Educational"],
            "Beauty & Personal Care": ["Skincare", "Haircare", "Makeup", "Fragrances", "Personal Hygiene"],
            "Sports & Fitness": ["Equipment", "Apparel", "Accessories", "Nutrition", "Footwear"],
            "Books & Media": ["Books", "Magazines", "Movies", "Music", "Games"],
            "Other": ["Miscellaneous"]
        };

        // Default Company Details
        const defaultCompanyDetails = {
            companyName: "Your Company Name",
            companyAddress1: "123 Business Street",
            companyAddress2: "Commercial Area",
            companyCity: "Your City",
            companyState: "Your State",
            companyCountry: "India",
            companyPincode: "123456",
            companyPhone: "+91 9876543210",
            companyEmail: "info@yourcompany.com",
            companyWebsite: "www.yourcompany.com",
            companyGST: "22AAAAA0000A1Z5",
            companyPAN: "AAAAA1234A",
            companyTerms: "1. Goods once sold will not be taken back.\n2. All disputes subject to jurisdiction.\n3. Payment due within 30 days of invoice date.",
            companyFooter: "Thank you for your business! Please visit again.",
            companyLogo: "",
            companySignatory: "Manager"
        };

        // Default Settings
        const defaultSettings = {
            emailNotifications: true,
            lowStockAlerts: true,
            autoBackup: false,
            autoPrintInvoice: false,
            salesNotifications: true,
            paymentAlerts: true,
            invoicePrefix: "INV",
            nextInvoiceNumber: 1001,
            defaultTaxRate: 18,
            showTaxBreakdown: true,
            lowStockThreshold: 5,
            criticalStockThreshold: 2,
            dailySalesReport: false,
            weeklyInventoryReport: false,
            defaultCurrency: "â‚¹",
            fiscalYearStart: "2024-04-01"
        };

        // Authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                
                showLoading('Initializing application...');
                initializeApp();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Initialize Application
        async function initializeApp() {
            try {
                await Promise.all([
                    loadInventory(),
                    loadCustomers(),
                    loadSales(),
                    loadTransactions(),
                    loadNotes(),
                    loadCompanyDetails(),
                    loadSettings()
                ]);
                
                updateDashboardStats();
                initializeCharts();
                populateCategoryFilters();
                populateCustomerSelect();
                updateRecentSalesTable();
                updateLowStockTable();
                updatePendingPaymentsTable();
                updateBadges();
                updateBalanceStats();
                updateRecentTransactionsTable();
                updateNoteCategories();
                loadNotesGrid();
                
                const today = new Date().toISOString().split('T')[0];
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                document.getElementById('salesDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('salesDateTo').value = today;
                document.getElementById('salesFilterDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('salesFilterDateTo').value = today;
                
                setTimeout(() => {
                    hideLoading();
                    showToast('System loaded successfully!', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Failed to initialize application', 'error');
                hideLoading();
            }
        }

        // ==================== BALANCE FUNCTIONS ====================

        // Load Transactions
        async function loadTransactions() {
            try {
                const userId = currentUser.uid;
                const snapshot = await db.collection('users').doc(userId).collection('transactions')
                    .orderBy('date', 'desc')
                    .get();
                
                transactions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    let dateObj = new Date();
                    if (data.date) {
                        if (data.date.toDate && typeof data.date.toDate === 'function') {
                            dateObj = data.date.toDate();
                        } else if (typeof data.date === 'string') {
                            dateObj = new Date(data.date);
                        } else if (data.date.seconds) {
                            dateObj = new Date(data.date.seconds * 1000);
                        }
                    }
                    
                    transactions.push({
                        id: doc.id,
                        ...data,
                        date: dateObj,
                        amount: parseFloat(data.amount) || 0,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date()
                    });
                });
                
                console.log(`Loaded ${transactions.length} transactions`);
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Failed to load transactions', 'error');
            }
        }

        // Update Balance Stats
        function updateBalanceStats() {
            // Calculate cash in hand from transactions
            let cashInHand = 0;
            let bankBalance = 0;
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                    if (transaction.paymentMethod === 'cash') {
                        cashInHand += transaction.amount;
                    } else {
                        bankBalance += transaction.amount;
                    }
                } else if (transaction.type === 'expense') {
                    totalExpense += transaction.amount;
                    if (transaction.paymentMethod === 'cash') {
                        cashInHand -= transaction.amount;
                    } else {
                        bankBalance -= transaction.amount;
                    }
                } else if (transaction.type === 'transfer') {
                    // Handle transfers between cash and bank
                    if (transaction.transferFrom === 'cash' && transaction.transferTo === 'bank') {
                        cashInHand -= transaction.amount;
                        bankBalance += transaction.amount;
                    } else if (transaction.transferFrom === 'bank' && transaction.transferTo === 'cash') {
                        bankBalance -= transaction.amount;
                        cashInHand += transaction.amount;
                    }
                }
            });
            
            // Calculate receivables from sales
            const totalReceivables = sales
                .filter(sale => sale.dueAmount > 0)
                .reduce((sum, sale) => sum + sale.dueAmount, 0);
            
            // Calculate payables (simplified - you might want to add a separate payables system)
            const totalPayables = 0; // This should come from your purchase/expense system
            
            // Calculate net profit
            const netProfit = totalIncome - totalExpense;
            
            // Update UI
            document.getElementById('cashInHand').textContent = `â‚¹${cashInHand.toFixed(2)}`;
            document.getElementById('bankBalance').textContent = `â‚¹${bankBalance.toFixed(2)}`;
            document.getElementById('totalReceivables').textContent = `â‚¹${totalReceivables.toFixed(2)}`;
            document.getElementById('totalPayables').textContent = `â‚¹${totalPayables.toFixed(2)}`;
            document.getElementById('creditAvailable').textContent = `â‚¹${currentBalance.creditAvailable.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `â‚¹${netProfit.toFixed(2)}`;
            
            // Update counts
            const receivablesCount = sales.filter(sale => sale.dueAmount > 0).length;
            document.getElementById('receivablesCount').textContent = receivablesCount;
            
            // Update change percentages (simplified - you'd want to calculate actual changes)
            document.getElementById('cashChange').textContent = '0%';
            document.getElementById('bankChange').textContent = '0%';
            document.getElementById('profitChange').textContent = '0%';
            
            // Update balance object
            currentBalance = {
                cashInHand: cashInHand,
                bankBalance: bankBalance,
                totalReceivables: totalReceivables,
                totalPayables: totalPayables,
                creditAvailable: currentBalance.creditAvailable,
                netProfit: netProfit
            };
            
            // Update cash flow chart
            updateCashFlowChart();
        }

        // Update Recent Transactions Table
        function updateRecentTransactionsTable() {
            const table = document.getElementById('recentTransactionsTable');
            const recentTransactions = transactions.slice(0, 10);
            
            let html = '';
            if (recentTransactions.length === 0) {
                html = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>No transactions yet</h4>
                            <p>Start adding transactions to see them here</p>
                        </td>
                    </tr>
                `;
            } else {
                let runningBalance = 0;
                recentTransactions.forEach(transaction => {
                    const date = formatDate(transaction.date);
                    const typeClass = transaction.type === 'income' ? 'transaction-income' : 
                                    transaction.type === 'expense' ? 'transaction-expense' : 'transaction-transfer';
                    const typeText = transaction.type === 'income' ? 'Income' : 
                                   transaction.type === 'expense' ? 'Expense' : 'Transfer';
                    
                    if (transaction.type === 'income') {
                        runningBalance += transaction.amount;
                    } else if (transaction.type === 'expense') {
                        runningBalance -= transaction.amount;
                    }
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>
                                <strong>${transaction.description}</strong>
                                ${transaction.notes ? `<div style="font-size: 12px; color: #666;">${transaction.notes}</div>` : ''}
                            </td>
                            <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                            <td>${transaction.category || 'Uncategorized'}</td>
                            <td class="${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                                <strong>${transaction.type === 'income' ? '+' : '-'}â‚¹${transaction.amount.toFixed(2)}</strong>
                            </td>
                            <td>â‚¹${runningBalance.toFixed(2)}</td>
                            <td>
                                <button class="action-btn" style="padding: 5px 10px;" onclick="viewTransaction('${transaction.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn danger" style="padding: 5px 10px;" onclick="deleteTransaction('${transaction.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            table.innerHTML = html;
        }

        // Open Add Transaction Modal
        function openAddTransactionModal() {
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionDescription').value = '';
            document.getElementById('transactionType').value = 'income';
            document.getElementById('transactionCategory').value = 'sales';
            document.getElementById('transactionPaymentMethod').value = 'cash';
            document.getElementById('transactionNotes').value = '';
            document.getElementById('transactionAttachment').value = '';
            
            toggleTransactionFields();
            openModal('addTransactionModal');
        }

        // Toggle Transaction Fields
        function toggleTransactionFields() {
            const type = document.getElementById('transactionType').value;
            const transferFields = document.getElementById('transferFields');
            const accountGroup = document.getElementById('transactionAccountGroup');
            
            if (type === 'transfer') {
                transferFields.style.display = 'block';
                accountGroup.style.display = 'none';
                // Set different default accounts
                document.getElementById('transferFrom').value = 'cash';
                document.getElementById('transferTo').value = 'bank';
            } else {
                transferFields.style.display = 'none';
                accountGroup.style.display = 'block';
            }
            
            // Update category options based on type
            const categorySelect = document.getElementById('transactionCategory');
            categorySelect.innerHTML = '';
            
            if (type === 'income') {
                categorySelect.innerHTML = `
                    <option value="sales">Sales</option>
                    <option value="service">Service Income</option>
                    <option value="interest">Interest Income</option>
                    <option value="other_income">Other Income</option>
                `;
            } else if (type === 'expense') {
                categorySelect.innerHTML = `
                    <option value="purchase">Purchase</option>
                    <option value="salary">Salary</option>
                    <option value="rent">Rent</option>
                    <option value="utilities">Utilities</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="marketing">Marketing</option>
                    <option value="travel">Travel</option>
                    <option value="other_expense">Other Expense</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="cash_to_bank">Cash to Bank</option>
                    <option value="bank_to_cash">Bank to Cash</option>
                    <option value="bank_transfer">Bank Transfer</option>
                `;
            }
        }

        // Save Transaction
        async function saveTransaction() {
            const form = document.getElementById('addTransactionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                showLoading('Saving transaction...');
                
                const userId = currentUser.uid;
                const type = document.getElementById('transactionType').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                
                if (amount <= 0) {
                    showToast('Amount must be greater than 0', 'error');
                    hideLoading();
                    return;
                }
                
                const transactionData = {
                    date: document.getElementById('transactionDate').value,
                    amount: amount,
                    description: document.getElementById('transactionDescription').value,
                    type: type,
                    category: document.getElementById('transactionCategory').value,
                    paymentMethod: document.getElementById('transactionPaymentMethod').value,
                    notes: document.getElementById('transactionNotes').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: userId
                };
                
                // Add transfer details if it's a transfer
                if (type === 'transfer') {
                    transactionData.transferFrom = document.getElementById('transferFrom').value;
                    transactionData.transferTo = document.getElementById('transferTo').value;
                    transactionData.category = 'transfer';
                } else {
                    transactionData.account = document.getElementById('transactionAccount').value;
                }
                
                // Handle file attachment if present
                const fileInput = document.getElementById('transactionAttachment');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `transactions/${userId}/${Date.now()}_${file.name}`;
                    // In a real app, you would upload to Firebase Storage here
                    transactionData.attachment = fileName;
                    transactionData.attachmentName = file.name;
                }
                
                await db.collection('users').doc(userId).collection('transactions').add(transactionData);
                
                await loadTransactions();
                updateBalanceStats();
                updateRecentTransactionsTable();
                updateBadges();
                
                hideLoading();
                showToast('Transaction saved successfully!', 'success');
                closeModal('addTransactionModal');
                form.reset();
                
            } catch (error) {
                hideLoading();
                console.error('Error saving transaction:', error);
                showToast('Failed to save transaction: ' + error.message, 'error');
            }
        }

        // Open Transfer Modal
        function openTransferModal() {
            document.getElementById('transferDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('fromAccount').value = 'cash';
            document.getElementById('toAccount').value = 'bank_main';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferPurpose').value = '';
            document.getElementById('transferNotes').value = '';
            
            updateAccountBalances();
            openModal('transferModal');
        }

        // Update Account Balances
        function updateAccountBalances() {
            document.getElementById('fromAccountBalance').textContent = `â‚¹${currentBalance.cashInHand.toFixed(2)}`;
            document.getElementById('toAccountBalance').textContent = `â‚¹${currentBalance.bankBalance.toFixed(2)}`;
        }

        // Process Transfer
        async function processTransfer() {
            const form = document.getElementById('transferForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            
            if (amount <= 0) {
                showToast('Amount must be greater than 0', 'error');
                return;
            }
            
            // Check if from account has sufficient balance
            let fromBalance = 0;
            if (fromAccount === 'cash') {
                fromBalance = currentBalance.cashInHand;
            } else {
                fromBalance = currentBalance.bankBalance;
            }
            
            if (amount > fromBalance) {
                showToast(`Insufficient balance in ${fromAccount} account`, 'error');
                return;
            }
            
            if (fromAccount === toAccount) {
                showToast('Cannot transfer to the same account', 'error');
                return;
            }
            
            try {
                showLoading('Processing transfer...');
                
                const userId = currentUser.uid;
                const transferData = {
                    date: document.getElementById('transferDate').value,
                    amount: amount,
                    description: `Transfer: ${document.getElementById('transferPurpose').value}`,
                    type: 'transfer',
                    category: 'transfer',
                    paymentMethod: 'transfer',
                    transferFrom: fromAccount,
                    transferTo: toAccount,
                    notes: document.getElementById('transferNotes').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: userId
                };
                
                await db.collection('users').doc(userId).collection('transactions').add(transferData);
                
                await loadTransactions();
                updateBalanceStats();
                updateRecentTransactionsTable();
                
                hideLoading();
                showToast('Transfer completed successfully!', 'success');
                closeModal('transferModal');
                form.reset();
                
            } catch (error) {
                hideLoading();
                console.error('Error processing transfer:', error);
                showToast('Failed to process transfer: ' + error.message, 'error');
            }
        }

        // View All Transactions
        function viewAllTransactions() {
            loadAllTransactionsTable();
            openModal('transactionsModal');
        }

        // Load All Transactions Table
        function loadAllTransactionsTable(page = 1) {
            const table = document.getElementById('allTransactionsTable');
            const dateFrom = document.getElementById('transactionsDateFrom').value;
            const dateTo = document.getElementById('transactionsDateTo').value;
            const typeFilter = document.getElementById('transactionsType').value;
            const categoryFilter = document.getElementById('transactionsCategory').value;
            
            let filteredTransactions = transactions.filter(transaction => {
                let matchesDate = true;
                if (dateFrom) {
                    const transactionDate = new Date(transaction.date);
                    const fromDate = new Date(dateFrom);
                    matchesDate = transactionDate >= fromDate;
                }
                if (dateTo) {
                    const transactionDate = new Date(transaction.date);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    matchesDate = matchesDate && transactionDate <= toDate;
                }
                
                const matchesType = !typeFilter || transaction.type === typeFilter;
                const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
                
                return matchesDate && matchesType && matchesCategory;
            });
            
            const itemsPerPage = 15;
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const paginatedTransactions = filteredTransactions.slice(startIndex, startIndex + itemsPerPage);
            
            let html = '';
            if (paginatedTransactions.length === 0) {
                html = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <h4>No transactions found</h4>
                            <p>Try adjusting your filters</p>
                        </td>
                    </tr>
                `;
            } else {
                let runningBalance = 0;
                paginatedTransactions.forEach(transaction => {
                    const date = formatDate(transaction.date);
                    const typeClass = transaction.type === 'income' ? 'transaction-income' : 
                                    transaction.type === 'expense' ? 'transaction-expense' : 'transaction-transfer';
                    const typeText = transaction.type === 'income' ? 'Income' : 
                                   transaction.type === 'expense' ? 'Expense' : 'Transfer';
                    
                    if (transaction.type === 'income') {
                        runningBalance += transaction.amount;
                    } else if (transaction.type === 'expense') {
                        runningBalance -= transaction.amount;
                    }
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>
                                <strong>${transaction.description}</strong>
                                ${transaction.notes ? `<div style="font-size: 12px; color: #666;">${transaction.notes}</div>` : ''}
                            </td>
                            <td><span class="transaction-type ${typeClass}">${typeText}</span></td>
                            <td>${transaction.category || 'Uncategorized'}</td>
                            <td>${transaction.paymentMethod || 'N/A'}</td>
                            <td class="${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                                <strong>${transaction.type === 'income' ? '+' : '-'}â‚¹${transaction.amount.toFixed(2)}</strong>
                            </td>
                            <td>â‚¹${runningBalance.toFixed(2)}</td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button class="action-btn" style="padding: 5px 10px;" onclick="viewTransaction('${transaction.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn danger" style="padding: 5px 10px;" onclick="deleteTransaction('${transaction.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            table.innerHTML = html;
            updateTransactionsPagination(totalPages, page);
        }

        // View Transaction Details
        function viewTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                showToast('Transaction not found', 'error');
                return;
            }
            
            const modalContent = `
                <div class="transaction-details">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: var(--primary);">Transaction Details</h4>
                        <span class="transaction-type ${transaction.type === 'income' ? 'transaction-income' : 
                            transaction.type === 'expense' ? 'transaction-expense' : 'transaction-transfer'}">
                            ${transaction.type.toUpperCase()}
                        </span>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>Date:</strong><br>
                                ${formatDate(transaction.date)}
                            </div>
                            <div>
                                <strong>Amount:</strong><br>
                                <span style="font-size: 24px; font-weight: bold; 
                                    color: ${transaction.type === 'income' ? '#00b09b' : '#ff416c'}">
                                    ${transaction.type === 'income' ? '+' : '-'}â‚¹${transaction.amount.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Description:</strong><br>
                        <p style="font-size: 18px; margin-top: 5px;">${transaction.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>Category:</strong><br>
                            ${transaction.category || 'N/A'}
                        </div>
                        <div>
                            <strong>Payment Method:</strong><br>
                            ${transaction.paymentMethod || 'N/A'}
                        </div>
                        ${transaction.transferFrom ? `
                            <div>
                                <strong>From Account:</strong><br>
                                ${transaction.transferFrom}
                            </div>
                            <div>
                                <strong>To Account:</strong><br>
                                ${transaction.transferTo}
                            </div>
                        ` : ''}
                    </div>
                    
                    ${transaction.notes ? `
                        <div style="margin-bottom: 20px;">
                            <strong>Notes:</strong><br>
                            <p style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 5px;">
                                ${transaction.notes}
                            </p>
                        </div>
                    ` : ''}
                    
                    ${transaction.attachment ? `
                        <div>
                            <strong>Attachment:</strong><br>
                            <button class="action-btn" style="margin-top: 10px;" onclick="downloadAttachment('${transaction.attachment}')">
                                <i class="fas fa-download"></i> Download ${transaction.attachmentName}
                            </button>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="action-btn" onclick="printTransaction('${transaction.id}')">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="action-btn success" onclick="editTransaction('${transaction.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn danger" onclick="deleteTransaction('${transaction.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
            
            // Create a temporary modal to show transaction details
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal-overlay';
            modalDiv.style.display = 'flex';
            modalDiv.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Transaction #${transactionId.substring(0, 8)}</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${modalContent}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalDiv);
        }

        // Delete Transaction
        async function deleteTransaction(transactionId) {
            if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading('Deleting transaction...');
                
                const userId = currentUser.uid;
                await db.collection('users').doc(userId).collection('transactions').doc(transactionId).delete();
                
                await loadTransactions();
                updateBalanceStats();
                updateRecentTransactionsTable();
                
                hideLoading();
                showToast('Transaction deleted successfully!', 'success');
                
                // Close any open modal
                closeModal('transactionsModal');
                
            } catch (error) {
                hideLoading();
                console.error('Error deleting transaction:', error);
                showToast('Failed to delete transaction: ' + error.message, 'error');
            }
        }

        // Update Cash Flow Chart
        function updateCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            if (charts.cashFlowChart) {
                charts.cashFlowChart.destroy();
            }
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            const monthlyIncome = Array(12).fill(0);
            const monthlyExpense = Array(12).fill(0);
            const monthlyProfit = Array(12).fill(0);
            
            transactions.forEach(transaction => {
                if (!transaction.date) return;
                const month = transaction.date.getMonth();
                const year = transaction.date.getFullYear();
                
                if (year === currentYear) {
                    if (transaction.type === 'income') {
                        monthlyIncome[month] += transaction.amount || 0;
                    } else if (transaction.type === 'expense') {
                        monthlyExpense[month] += transaction.amount || 0;
                    }
                }
            });
            
            // Calculate profit for each month
            for (let i = 0; i < 12; i++) {
                monthlyProfit[i] = monthlyIncome[i] - monthlyExpense[i];
            }
            
            charts.cashFlowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Income',
                            data: monthlyIncome,
                            backgroundColor: '#00b09b',
                            borderColor: '#00b09b',
                            borderWidth: 1
                        },
                        {
                            label: 'Expense',
                            data: monthlyExpense,
                            backgroundColor: '#ff416c',
                            borderColor: '#ff416c',
                            borderWidth: 1
                        },
                        {
                            label: 'Profit',
                            data: monthlyProfit,
                            backgroundColor: '#4e54c8',
                            borderColor: '#4e54c8',
                            borderWidth: 1,
                            type: 'line',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚¹' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== NOTES FUNCTIONS ====================

        // Load Notes
        async function loadNotes() {
            try {
                const userId = currentUser.uid;
                const snapshot = await db.collection('users').doc(userId).collection('notes')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                notes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    let dateObj = new Date();
                    if (data.createdAt) {
                        if (data.createdAt.toDate && typeof data.createdAt.toDate === 'function') {
                            dateObj = data.createdAt.toDate();
                        } else if (data.createdAt.seconds) {
                            dateObj = new Date(data.createdAt.seconds * 1000);
                        }
                    }
                    
                    let dueDateObj = null;
                    if (data.dueDate) {
                        if (data.dueDate.toDate && typeof data.dueDate.toDate === 'function') {
                            dueDateObj = data.dueDate.toDate();
                        } else if (typeof data.dueDate === 'string') {
                            dueDateObj = new Date(data.dueDate);
                        }
                    }
                    
                    notes.push({
                        id: doc.id,
                        ...data,
                        createdAt: dateObj,
                        dueDate: dueDateObj,
                        color: data.color || '#ffffff',
                        category: data.category || 'general',
                        status: data.status || 'active'
                    });
                });
                
                console.log(`Loaded ${notes.length} notes`);
                
            } catch (error) {
                console.error('Error loading notes:', error);
                showToast('Failed to load notes', 'error');
            }
        }

        // Update Note Categories
        function updateNoteCategories() {
            // Update categories from notes
            const categoryCounts = {};
            notes.forEach(note => {
                const category = note.category || 'general';
                if (!categoryCounts[category]) {
                    categoryCounts[category] = 0;
                }
                categoryCounts[category]++;
            });
            
            // Update default categories with counts
            noteCategories = defaultNoteCategories.map(cat => ({
                ...cat,
                count: categoryCounts[cat.id] || 0
            }));
            
            // Add any custom categories from notes
            Object.keys(categoryCounts).forEach(catId => {
                if (!noteCategories.find(c => c.id === catId)) {
                    noteCategories.push({
                        id: catId,
                        name: catId.charAt(0).toUpperCase() + catId.slice(1),
                        color: '#ffffff',
                        count: categoryCounts[catId]
                    });
                }
            });
            
            // Update category filter dropdown
            const categorySelect = document.getElementById('filterNoteCategory');
            categorySelect.innerHTML = '<option value="">All Categories</option>';
            noteCategories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.id}">${category.name} (${category.count})</option>`;
            });
            
            // Update stats
            updateNoteStats();
        }

        // Update Note Stats
        function updateNoteStats() {
            const totalNotes = notes.length;
            const completedNotes = notes.filter(note => note.status === 'completed').length;
            const pendingNotes = totalNotes - completedNotes;
            const pendingPercent = totalNotes > 0 ? (pendingNotes / totalNotes * 100).toFixed(0) : 0;
            
            document.getElementById('totalNotesStat').textContent = totalNotes;
            document.getElementById('completedNotesStat').textContent = completedNotes;
            document.getElementById('pendingNotesStat').textContent = pendingNotes;
            document.getElementById('pendingNotesProgress').style.width = `${pendingPercent}%`;
            document.getElementById('noteCategoriesStat').textContent = noteCategories.length;
            
            // Update badges
            document.getElementById('notesBadge').textContent = pendingNotes > 0 ? pendingNotes : '0';
        }

        // Load Notes Grid
        function loadNotesGrid() {
            const grid = document.getElementById('notesGrid');
            const searchTerm = document.getElementById('searchNotes')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('filterNoteCategory')?.value || '';
            const dateFilter = document.getElementById('filterNoteDate')?.value || 'all';
            
            let filteredNotes = notes.filter(note => {
                const matchesSearch = !searchTerm || 
                    note.title.toLowerCase().includes(searchTerm) ||
                    note.content.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || note.category === categoryFilter;
                
                let matchesDate = true;
                if (dateFilter !== 'all' && note.createdAt) {
                    const now = new Date();
                    const noteDate = new Date(note.createdAt);
                    
                    if (dateFilter === 'today') {
                        matchesDate = noteDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        matchesDate = noteDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date();
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        matchesDate = noteDate >= monthAgo;
                    } else if (dateFilter === 'year') {
                        const yearAgo = new Date();
                        yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                        matchesDate = noteDate >= yearAgo;
                    }
                }
                
                return matchesSearch && matchesCategory && matchesDate;
            });
            
            let html = '';
            if (filteredNotes.length === 0) {
                html = `
                    <div class="empty-notes">
                        <i class="fas fa-sticky-note"></i>
                        <h4>No notes found</h4>
                        <p>Try adjusting your search or filters</p>
                        <button class="action-btn success" onclick="openNewNoteModal()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Create New Note
                        </button>
                    </div>
                `;
            } else {
                filteredNotes.forEach(note => {
                    const category = noteCategories.find(c => c.id === note.category) || noteCategories[0];
                    const date = formatDate(note.createdAt);
                    const dueDate = note.dueDate ? formatDate(note.dueDate) : 'No due date';
                    const isOverdue = note.dueDate && new Date(note.dueDate) < new Date() && note.status !== 'completed';
                    
                    // Truncate content for preview
                    const contentPreview = note.content.length > 150 ? 
                        note.content.substring(0, 150) + '...' : note.content;
                    
                    html += `
                        <div class="note-card" style="background-color: ${note.color};">
                            <div class="note-card-header">
                                <h4 class="note-card-title">${note.title}</h4>
                                <span class="note-card-category" style="background-color: ${category.color}20; color: ${category.color.replace('20', '')};">
                                    ${category.name}
                                </span>
                            </div>
                            <div class="note-card-content">
                                ${contentPreview.replace(/\n/g, '<br>')}
                            </div>
                            <div class="note-card-footer">
                                <div>
                                    <div class="note-card-date">Created: ${date}</div>
                                    ${note.dueDate ? `
                                        <div class="note-card-date ${isOverdue ? 'text-danger' : ''}">
                                            Due: ${dueDate}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="note-card-actions">
                                    ${note.status === 'completed' ? `
                                        <span class="badge badge-success" style="margin-right: 10px;">Completed</span>
                                    ` : ''}
                                    <button class="action-btn" style="padding: 5px 10px;" onclick="viewNote('${note.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn success" style="padding: 5px 10px;" onclick="editNote('${note.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn danger" style="padding: 5px 10px;" onclick="deleteNote('${note.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            grid.innerHTML = html;
        }

        // Filter Notes
        function filterNotes() {
            loadNotesGrid();
        }

        // Clear Note Filters
        function clearNoteFilters() {
            document.getElementById('searchNotes').value = '';
            document.getElementById('filterNoteCategory').value = '';
            document.getElementById('filterNoteDate').value = 'all';
            loadNotesGrid();
        }

        // Open New Note Modal
        function openNewNoteModal() {
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteCategory').value = 'general';
            document.getElementById('noteDueDate').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteColor').value = '#ffffff';
            document.getElementById('noteReminder').value = '';
            document.getElementById('noteReminderEnabled').checked = false;
            document.getElementById('noteAttachments').value = '';
            
            openModal('newNoteModal');
        }

        // Select Note Color
        function selectNoteColor(color) {
            document.getElementById('noteColor').value = color;
        }

        // Save Note
        async function saveNote() {
            const form = document.getElementById('newNoteForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                showLoading('Saving note...');
                
                const userId = currentUser.uid;
                const noteData = {
                    title: document.getElementById('noteTitle').value,
                    category: document.getElementById('noteCategory').value,
                    content: document.getElementById('noteContent').value,
                    color: document.getElementById('noteColor').value,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: userId
                };
                
                // Add due date if provided
                const dueDate = document.getElementById('noteDueDate').value;
                if (dueDate) {
                    noteData.dueDate = dueDate;
                }
                
                // Add reminder if enabled
                if (document.getElementById('noteReminderEnabled').checked) {
                    const reminder = document.getElementById('noteReminder').value;
                    if (reminder) {
                        noteData.reminder = reminder;
                    }
                }
                
                await db.collection('users').doc(userId).collection('notes').add(noteData);
                
                await loadNotes();
                updateNoteCategories();
                loadNotesGrid();
                updateBadges();
                
                hideLoading();
                showToast('Note saved successfully!', 'success');
                closeModal('newNoteModal');
                form.reset();
                
            } catch (error) {
                hideLoading();
                console.error('Error saving note:', error);
                showToast('Failed to save note: ' + error.message, 'error');
            }
        }

        // Save Note as Draft
        async function saveNoteAsDraft() {
            const form = document.getElementById('newNoteForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                showLoading('Saving draft...');
                
                const userId = currentUser.uid;
                const noteData = {
                    title: document.getElementById('noteTitle').value || 'Untitled Note',
                    category: document.getElementById('noteCategory').value,
                    content: document.getElementById('noteContent').value || '',
                    color: document.getElementById('noteColor').value,
                    status: 'draft',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: userId
                };
                
                await db.collection('users').doc(userId).collection('notes').add(noteData);
                
                await loadNotes();
                updateNoteCategories();
                loadNotesGrid();
                
                hideLoading();
                showToast('Note saved as draft!', 'success');
                closeModal('newNoteModal');
                form.reset();
                
            } catch (error) {
                hideLoading();
                console.error('Error saving draft:', error);
                showToast('Failed to save draft: ' + error.message, 'error');
            }
        }

        // View Note
        function viewNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                showToast('Note not found', 'error');
                return;
            }
            
            const category = noteCategories.find(c => c.id === note.category) || noteCategories[0];
            const createdAt = formatDate(note.createdAt);
            const dueDate = note.dueDate ? formatDate(note.dueDate) : 'No due date';
            const isOverdue = note.dueDate && new Date(note.dueDate) < new Date() && note.status !== 'completed';
            
            const noteDetails = `
                <div class="note-details" style="background-color: ${note.color}; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--dark); margin: 0;">${note.title}</h3>
                        <span class="note-card-category" style="background-color: ${category.color}20; color: ${category.color.replace('20', '')}; padding: 5px 15px; border-radius: 20px;">
                            ${category.name}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Created:</strong> ${createdAt}<br>
                        ${note.dueDate ? `
                            <strong>Due Date:</strong> 
                            <span class="${isOverdue ? 'text-danger' : ''}">${dueDate}</span>
                            ${isOverdue ? '<span class="badge badge-danger" style="margin-left: 10px;">OVERDUE</span>' : ''}
                        ` : ''}
                        ${note.status === 'completed' ? `
                            <span class="badge badge-success" style="margin-left: 10px;">COMPLETED</span>
                        ` : ''}
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Content:</strong>
                        <div style="margin-top: 10px; white-space: pre-line; line-height: 1.6;">
                            ${note.content}
                        </div>
                    </div>
                    
                    ${note.reminder ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <strong><i class="fas fa-bell"></i> Reminder:</strong><br>
                            ${formatDateTime(new Date(note.reminder))}
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('viewNoteTitle').textContent = note.title;
            document.getElementById('noteDetails').innerHTML = noteDetails;
            
            // Store current note ID for actions
            window.currentViewingNoteId = noteId;
            
            openModal('viewNoteModal');
        }

        // Edit Current Note
        function editCurrentNote() {
            const noteId = window.currentViewingNoteId;
            if (noteId) {
                editNote(noteId);
            }
        }

        // Mark Note as Complete
        async function markNoteComplete() {
            const noteId = window.currentViewingNoteId;
            if (!noteId) return;
            
            try {
                showLoading('Updating note...');
                
                const userId = currentUser.uid;
                await db.collection('users').doc(userId).collection('notes').doc(noteId).update({
                    status: 'completed',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await loadNotes();
                updateNoteCategories();
                loadNotesGrid();
                
                hideLoading();
                showToast('Note marked as complete!', 'success');
                closeModal('viewNoteModal');
                
            } catch (error) {
                hideLoading();
                console.error('Error marking note complete:', error);
                showToast('Failed to update note: ' + error.message, 'error');
            }
        }

        // Edit Note
        function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) {
                showToast('Note not found', 'error');
                return;
            }
            
            // Populate the new note modal with existing data
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteCategory').value = note.category;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteColor').value = note.color;
            
            if (note.dueDate) {
                document.getElementById('noteDueDate').value = new Date(note.dueDate).toISOString().split('T')[0];
            }
            
            // Store note ID for update
            window.editingNoteId = noteId;
            
            // Change modal title and button
            document.querySelector('#newNoteModal .modal-title').textContent = 'Edit Note';
            const saveButton = document.querySelector('#newNoteModal .action-btn.success');
            saveButton.innerHTML = '<i class="fas fa-save"></i> Update Note';
            saveButton.onclick = updateNote;
            
            openModal('newNoteModal');
        }

        // Update Note
        async function updateNote() {
            const noteId = window.editingNoteId;
            if (!noteId) return;
            
            const form = document.getElementById('newNoteForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                showLoading('Updating note...');
                
                const userId = currentUser.uid;
                const noteData = {
                    title: document.getElementById('noteTitle').value,
                    category: document.getElementById('noteCategory').value,
                    content: document.getElementById('noteContent').value,
                    color: document.getElementById('noteColor').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add due date if provided
                const dueDate = document.getElementById('noteDueDate').value;
                if (dueDate) {
                    noteData.dueDate = dueDate;
                }
                
                await db.collection('users').doc(userId).collection('notes').doc(noteId).update(noteData);
                
                await loadNotes();
                updateNoteCategories();
                loadNotesGrid();
                
                hideLoading();
                showToast('Note updated successfully!', 'success');
                closeModal('newNoteModal');
                form.reset();
                
                // Reset modal state
                document.querySelector('#newNoteModal .modal-title').textContent = 'Create New Note';
                const saveButton = document.querySelector('#newNoteModal .action-btn.success');
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Note';
                saveButton.onclick = saveNote;
                window.editingNoteId = null;
                
            } catch (error) {
                hideLoading();
                console.error('Error updating note:', error);
                showToast('Failed to update note: ' + error.message, 'error');
            }
        }

        // Delete Note
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading('Deleting note...');
                
                const userId = currentUser.uid;
                await db.collection('users').doc(userId).collection('notes').doc(noteId).delete();
                
                await loadNotes();
                updateNoteCategories();
                loadNotesGrid();
                updateBadges();
                
                hideLoading();
                showToast('Note deleted successfully!', 'success');
                
                // Close any open modal
                closeModal('viewNoteModal');
                
            } catch (error) {
                hideLoading();
                console.error('Error deleting note:', error);
                showToast('Failed to delete note: ' + error.message, 'error');
            }
        }

        // Open Note Categories Modal
        function openNoteCategoriesModal() {
            loadNoteCategoriesTable();
            openModal('noteCategoriesModal');
        }

        // Load Note Categories Table
        function loadNoteCategoriesTable() {
            const table = document.getElementById('noteCategoriesTable');
            
            let html = '';
            noteCategories.forEach(category => {
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; background-color: ${category.color}; border-radius: 4px;"></div>
                                <strong>${category.name}</strong>
                            </div>
                        </td>
                        <td style="color: ${category.color};">${category.color}</td>
                        <td>${category.count} notes</td>
                        <td>
                            <button class="action-btn" style="padding: 5px 10px;" onclick="editNoteCategory('${category.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${category.id.startsWith('custom_') ? `
                                <button class="action-btn danger" style="padding: 5px 10px;" onclick="deleteNoteCategory('${category.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }

        // Add Note Category
        async function addNoteCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value;
            
            if (!name) {
                showToast('Please enter a category name', 'error');
                return;
            }
            
            const categoryId = 'custom_' + Date.now();
            const newCategory = {
                id: categoryId,
                name: name,
                color: color,
                count: 0
            };
            
            noteCategories.push(newCategory);
            loadNoteCategoriesTable();
            
            // Update category filter
            updateNoteCategories();
            
            document.getElementById('newCategoryName').value = '';
            showToast('Category added successfully!', 'success');
        }

        // ==================== NAVIGATION FUNCTIONS ====================

        function showDashboard() {
            setActivePage('Dashboard', 'Welcome to your inventory management system', 'dashboardContent');
            updateDashboardStats();
            if (!charts.salesChart) {
                initializeCharts();
            }
        }

        function showInventory() {
            setActivePage('Inventory', 'Manage your inventory items', 'inventoryContent');
            updateInventoryTable();
        }

        function showSales() {
            setActivePage('Sales', 'View and manage sales transactions', 'salesContent');
            loadSalesTable();
        }

        function showCustomers() {
            setActivePage('Customers', 'Manage your customers', 'customersContent');
            updateCustomersTable();
        }

        function showBalance() {
            setActivePage('Balance & Cash', 'Manage cash flow and transactions', 'balanceContent');
            updateBalanceStats();
            updateRecentTransactionsTable();
            if (!charts.cashFlowChart) {
                updateCashFlowChart();
            }
        }

        function showNotes() {
            setActivePage('Notes & Memos', 'Organize your thoughts and reminders', 'notesContent');
            loadNotesGrid();
            updateNoteStats();
        }

        function showReports() {
            setActivePage('Reports', 'Generate detailed reports and analytics', 'reportsContent');
        }

        function showAnalytics() {
            setActivePage('Analytics', 'Advanced analytics and insights', 'analyticsContent');
            updateAnalyticsCharts();
        }

        function showSettings() {
            openModal('settingsModal');
            showSettingsTab('general');
        }

        function setActivePage(title, subtitle, contentId) {
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('[id$="Content"]').forEach(section => {
                section.style.display = 'none';
            });
            
            const activeSection = document.getElementById(contentId);
            if (activeSection) {
                activeSection.style.display = 'block';
            }
            
            let menuItem = null;
            if (contentId === 'dashboardContent') menuItem = document.querySelector('.menu-item:nth-child(1)');
            else if (contentId === 'inventoryContent') menuItem = document.querySelector('.menu-item:nth-child(2)');
            else if (contentId === 'salesContent') menuItem = document.querySelector('.menu-item:nth-child(3)');
            else if (contentId === 'customersContent') menuItem = document.querySelector('.menu-item:nth-child(4)');
            else if (contentId === 'balanceContent') menuItem = document.querySelector('.menu-item:nth-child(5)');
            else if (contentId === 'notesContent') menuItem = document.querySelector('.menu-item:nth-child(6)');
            else if (contentId === 'reportsContent') menuItem = document.querySelector('.menu-item:nth-child(7)');
            else if (contentId === 'analyticsContent') menuItem = document.querySelector('.menu-item:nth-child(8)');
            
            if (menuItem) {
                menuItem.classList.add('active');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================

        function showLoading(message = 'Loading...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                const messageElement = loadingOverlay.querySelector('p');
                if (messageElement) {
                    messageElement.textContent = message;
                }
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            const d = new Date(date);
            return d.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatDateTime(date) {
            if (!date) return 'N/A';
            const d = new Date(date);
            return d.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTime(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateBadges() {
            document.getElementById('inventoryBadge').textContent = inventoryItems.length;
            document.getElementById('salesBadge').textContent = sales.length;
            document.getElementById('customersBadge').textContent = customers.length;
            document.getElementById('balanceBadge').textContent = transactions.length;
            
            const pendingNotes = notes.filter(note => note.status !== 'completed').length;
            document.getElementById('notesBadge').textContent = pendingNotes > 0 ? pendingNotes : '0';
            
            const lowStockCount = inventoryItems.filter(item => 
                item.currentStock > 0 && item.currentStock <= (item.minStock || 5)
            ).length;
            document.getElementById('reportsBadge').textContent = lowStockCount > 0 ? lowStockCount : '0';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }

        // ==================== PAGE INITIALIZATION ====================

        window.addEventListener('load', function() {
            // Initialize all date fields
            const today = new Date().toISOString().split('T')[0];
            const oneWeekLater = new Date();
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value && input.id !== 'dueDate' && input.id !== 'noteDueDate') {
                    input.value = today;
                }
            });
            
            // Set due date to one week from now
            document.getElementById('dueDate').value = oneWeekLater.toISOString().split('T')[0];
            
            // Set note reminder to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('noteReminder').value = tomorrow.toISOString().slice(0, 16);
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Prevent form submission
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
            });
        });

        // Color picker styles
        const style = document.createElement('style');
        style.textContent = `
            .color-picker {
                display: flex;
                gap: 8px;
                margin-top: 8px;
            }
            .color-option {
                width: 30px;
                height: 30px;
                border-radius: 6px;
                cursor: pointer;
                border: 2px solid #ddd;
                transition: transform 0.2s;
            }
            .color-option:hover {
                transform: scale(1.1);
                border-color: #4e54c8;
            }
        `;
        document.head.appendChild(style);

        // Export placeholder functions
        window.exportBalanceReport = function() {
            showToast('Balance report export feature coming soon!', 'info');
        };

        window.printBalanceStatement = function() {
            showToast('Print balance statement feature coming soon!', 'info');
        };

        window.exportNotes = function() {
            showToast('Notes export feature coming soon!', 'info');
        };

        window.printNote = function() {
            showToast('Print note feature coming soon!', 'info');
        };

        window.exportTransactions = function() {
            showToast('Transactions export feature coming soon!', 'info');
        };

        window.printTransactionReport = function() {
            showToast('Print transaction report feature coming soon!', 'info');
        };

        window.filterTransactions = function() {
            loadAllTransactionsTable(1);
        };

        window.updateTransactionsPagination = function(totalPages, currentPage) {
            const pagination = document.getElementById('transactionsPagination');
            let html = '';
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<div class="page-item" onclick="loadAllTransactionsTable(1)">First</div>`;
                html += `<div class="page-item" onclick="loadAllTransactionsTable(${currentPage - 1})">Prev</div>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<div class="page-item ${i === currentPage ? 'active' : ''}" onclick="loadAllTransactionsTable(${i})">${i}</div>`;
            }
            
            if (endPage < totalPages) {
                html += `<div class="page-item" onclick="loadAllTransactionsTable(${currentPage + 1})">Next</div>`;
                html += `<div class="page-item" onclick="loadAllTransactionsTable(${totalPages})">Last</div>`;
            }
            
            pagination.innerHTML = html;
        };

        // All other functions from previous code (loadInventory, loadCustomers, loadSales, etc.) remain exactly the same
        // Include all the functions from the previous code that I provided earlier

    </script>
</body>
</html>