<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BudgetFlow - Financial Dashboard</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet"/>
  <style>
    /* Modern Color Scheme */
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3f37c9;
      --secondary: #7209b7;
      --accent: #f72585;
      --success: #4caf50;
      --warning: #f77f00;
      --danger: #e63946;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --sidebar-width: 280px;
      --header-height: 70px;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    /* Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f8fafc; color: var(--dark); overflow-x: hidden; }

    /* Header */
    .header { background-color: white; height: var(--header-height); box-shadow: var(--shadow); padding: 0 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .menu-toggle { font-size: 1.4rem; cursor: pointer; color: var(--primary); background: none; border: none; }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.4rem; color: var(--primary); }
    .logo i { color: var(--accent); }
    .greeting { font-weight: 500; font-size: 1.1rem; }
    .datetime { font-size: 0.85rem; color: var(--gray); }
    .header-right { position: relative; display: flex; align-items: center; gap: 16px; }

    /* Header Add Transaction button */
    .add-tx-btn { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, var(--accent), var(--secondary)); color: #fff; border: none; padding: 10px 16px; border-radius: 999px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(247, 37, 133, 0.3); transition: var(--transition); }
    .add-tx-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(247, 37, 133, 0.4); }

    .profile { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: var(--transition); }
    .profile:hover { transform: scale(1.05); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }
    .dropdown { position: absolute; top: 60px; right: 0; background: white; box-shadow: var(--shadow); border-radius: var(--border-radius); width: 180px; display: none; flex-direction: column; z-index: 101; overflow: hidden; }
    .dropdown.show-dropdown { display: flex; }
    .dropdown a { padding: 12px 20px; text-decoration: none; color: var(--dark); transition: var(--transition); display: flex; align-items: center; gap: 10px; }
    .dropdown a:hover { background: var(--primary-light); color: white; }
    .dropdown a i { width: 20px; }

    /* Sidebar */
    #sidebar { position: fixed; left: -var(--sidebar-width); top: 0; width: var(--sidebar-width); height: 100vh; background: linear-gradient(to bottom, var(--primary), var(--primary-dark)); transition: left 0.3s ease-in-out; z-index: 102; padding-top: 30px; overflow-y: auto; box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1); }
    #sidebar.active { left: 0; }
    #sidebar ul { list-style: none; }
    #sidebar li { padding: 15px 25px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 15px; color: white; font-weight: 500; border-left: 4px solid transparent; }
    #sidebar li:hover { background: rgba(255, 255, 255, 0.1); border-left: 4px solid var(--accent); }
    #sidebar li i { font-size: 1.2rem; width: 25px; }

    /* Overlay */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; z-index: 101; }
    #overlay.active { display: block; }

    /* Main */
    .main { padding: 25px; margin-left: 0; transition: margin-left 0.3s; }

    /* Dashboard Grid */
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-top: 20px; }
    @media (min-width: 1200px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }

    /* Summary Section */
    .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .summary-header h3 { font-size: 1.4rem; color: var(--dark); font-weight: 600; }
    #timeFilter { padding: 10px 15px; border: 1px solid var(--gray-light); border-radius: var(--border-radius); background: white; color: var(--dark); font-weight: 500; cursor: pointer; outline: none; transition: var(--transition); }
    #timeFilter:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }

    .summary-cards { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px; }
    @media (min-width: 768px) { .summary-cards { grid-template-columns: 1fr 1fr; } }
    .summary-card { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); transition: var(--transition); }
    .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
    .income-card { border-top: 4px solid var(--success); }
    .expense-card { border-top: 4px solid var(--danger); }
    .summary-card h4 { font-size: 1rem; color: var(--gray); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .summary-card h4 i { font-size: 1.2rem; }
    .summary-card p { font-size: 1.8rem; font-weight: 700; }
    .income-card p { color: var(--success); }
    .expense-card p { color: var(--danger); }

    /* Chart */
    .chart-section { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); margin-bottom: 25px; }
    .chart-section h3 { font-size: 1.4rem; margin-bottom: 20px; color: var(--dark); font-weight: 600; }

    /* Right panel / Calendar */
    .right-panel { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .calendar-header h3 { font-size: 1.4rem; color: var(--dark); font-weight: 600; }
    .add-reminder-btn { background: linear-gradient(135deg, var(--accent), var(--secondary)); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
    .add-reminder-btn:hover { transform: rotate(90deg); box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3); }

    #calendarContainer { margin-top: 15px; }
    .fc .fc-toolbar-title { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
    .fc .fc-button { background-color: var(--primary); border: none; border-radius: var(--border-radius); transition: var(--transition); }
    .fc .fc-button:hover { background-color: var(--primary-dark); }
    .fc .fc-daygrid-day-number { color: var(--dark); font-weight: 500; }
    .fc .fc-daygrid-event { border-radius: 6px; padding: 3px 6px; font-size: 0.85rem; }

    /* Modals (shared) */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 103; padding: 20px; }
    .modal-content { background: white; border-radius: var(--border-radius); padding: 30px; width: 100%; max-width: 500px; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); max-height: 90vh; overflow-y: auto; }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; color: var(--gray); transition: var(--transition); }
    .close-btn:hover { color: var(--danger); transform: rotate(90deg); }
    .modal-content h3 { margin-bottom: 25px; font-size: 1.5rem; color: var(--dark); font-weight: 600; }
    .modal-content label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 12px 15px; margin-bottom: 20px; border: 1px solid var(--gray-light); border-radius: var(--border-radius); font-size: 1rem; transition: var(--transition); }
    .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); }
    .modal-content button { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius); cursor: pointer; width: 100%; font-size: 1rem; font-weight: 600; transition: var(--transition); }
    .modal-content button:hover { background: linear-gradient(135deg, var(--primary-light), var(--primary)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
    .modal-buttons { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 25px; }
    @media (min-width: 480px) { .modal-buttons { grid-template-columns: 1fr 1fr; } }
    .modal-buttons .btn { display: block; padding: 15px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; text-align: center; text-decoration: none; border-radius: var(--border-radius); transition: var(--transition); font-weight: 500; }
    .modal-buttons .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }

    /* Popup Modal */
    .popup-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 104; padding: 20px; }
    .popup-content { background: white; border-radius: var(--border-radius); padding: 30px; width: 100%; max-width: 450px; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); }
    .close-popup { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; color: var(--gray); transition: var(--transition); }
    .close-popup:hover { color: var(--danger); }
    .popup-content h3 { margin-bottom: 20px; font-size: 1.4rem; color: var(--dark); padding-right: 30px; }
    .popup-content p { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .popup-content p strong { min-width: 70px; }
    .popup-content button { background: linear-gradient(135deg, var(--danger), #d90429); color: white; border: none; padding: 12px 25px; border-radius: var(--border-radius); cursor: pointer; margin-top: 20px; font-weight: 500; transition: var(--transition); }
    .popup-content button:hover { background: linear-gradient(135deg, #d90429, var(--danger)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230, 57, 70, 0.3); }

    /* Loading overlay */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px; }
    .spinner { width: 60px; height: 60px; border: 5px solid rgba(67, 97, 238, 0.2); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { font-size: 1.2rem; color: var(--primary); font-weight: 500; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #dashboardContent { display: none; }

    /* Quick Add modal: type selector */
    .transaction-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .type-selector { display: inline-flex; align-items: center; gap: 8px; justify-content: center; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--gray-light); background: #fff; cursor: pointer; font-weight: 600; transition: var(--transition); }
    .type-selector.active { background: rgba(67,97,238,0.07); border-color: var(--primary-light); }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 0 15px; }
      .main { padding: 15px; }
      .summary-card p { font-size: 1.5rem; }
      .dashboard-grid { gap: 15px; }
    }
  </style>
</head>
<body>
  <!-- Loading Indicator -->
  <div class="loading-overlay" id="loadingIndicator">
    <div class="spinner"></div>
    <div class="loading-text">Loading Dashboard...</div>
  </div>

  <!-- Sidebar (hidden by default; opens on toggle) -->
  <div id="sidebar">
    <ul>
      <li><i class="fas fa-home"></i> Dashboard</li>
      <li id="chartOfAccountsBtn"><i class="fas fa-chart-pie"></i> Chart of Accounts</li>
      <li id="ExpenseTrackerBtn"><i class="fas fa-wallet"></i> Expense Tracker</li>
      <li id="ReportsBtn"><i class="fas fa-chart-line"></i> Reports & Analytics</li>
      <li><i class="fas fa-chart-bar"></i> Budget Planning</li>
      <li><i class="fas fa-file-invoice"></i> Invoices</li>
      <li><i class="fas fa-user-shield"></i> User Management</li>
      <li><i class="fas fa-cog"></i> Settings</li>
    </ul>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <div class="main" id="mainContent">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <div class="logo"><i class="fas fa-coins"></i><span>BudgetFlow</span></div>
      </div>
      <div class="header-right">
        <button id="headerAddBtn" class="add-tx-btn"><i class="fas fa-plus-circle"></i> Add Transaction</button>
        <div class="greeting">Hello, <span id="username">User</span> ðŸ‘‹</div>
        <div class="datetime" id="datetime">Loading date and time...</div>
        <div class="profile" id="profileBtn"><span id="userInitials">US</span></div>
        <div class="dropdown" id="profileDropdown">
          <a href="#"><i class="fas fa-user"></i> My Profile</a>
          <a href="#"><i class="fas fa-cog"></i> Settings</a>
          <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent">
      <div class="dashboard-grid">
        <!-- Left Panel -->
        <div class="left-panel">
          <div class="summary-header">
            <h3>Financial Overview</h3>
            <select id="timeFilter">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>
          <div class="summary-cards">
            <div class="summary-card income-card">
              <h4><i class="fas fa-arrow-down"></i> Total Income</h4>
              <p id="totalIncome">â‚¹12,500.00</p>
            </div>
            <div class="summary-card expense-card">
              <h4><i class="fas fa-arrow-up"></i> Total Expenses</h4>
              <p id="totalExpenses">â‚¹8,740.00</p>
            </div>
          </div>
          <div class="chart-section">
            <h3>Spending Distribution</h3>
            <div id="chartContainer"><canvas id="spendingChart"></canvas></div>
          </div>
        </div>
        <!-- Right Panel: Calendar -->
        <div class="right-panel">
          <div class="calendar-header">
            <h3>Financial Calendar</h3>
            <button class="add-reminder-btn" id="addReminderBtn"><i class="fas fa-plus"></i></button>
          </div>
          <div id="calendarContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Modal -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h3>Create New Reminder</h3>
      <label for="reminderType">Reminder Type</label>
      <select id="reminderType">
        <option value="reminder">General Reminder</option>
        <option value="bill">Bill Payment</option>
        <option value="income">Expected Income</option>
        <option value="investment">Investment</option>
      </select>
      <div id="formFields">
        <label for="reminderTitle">Title</label>
        <input type="text" id="reminderTitle" placeholder="Enter reminder title" required>
        <label for="reminderDate">Date</label>
        <input type="date" id="reminderDate" required>
        <label for="reminderTime">Time (Optional)</label>
        <input type="time" id="reminderTime">
        <label for="reminderAmount">Amount (Optional)</label>
        <input type="number" id="reminderAmount" placeholder="0.00">
        <label for="reminderNotes">Notes</label>
        <textarea id="reminderNotes" rows="3" placeholder="Add any additional details"></textarea>
      </div>
      <button id="saveReminder">Save Reminder</button>
    </div>
  </div>

  <!-- Quick Add Transaction Modal -->
  <div id="quickAddModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeQuickAddModal">&times;</span>
      <h3>Quick Add Transaction</h3>
      <div class="transaction-type-selector">
        <button class="type-selector active" data-type="income"><i class="fas fa-arrow-down"></i> Income</button>
        <button class="type-selector" data-type="expense"><i class="fas fa-arrow-up"></i> Expense</button>
      </div>
      <label for="transactionTitle">Title</label>
      <input type="text" id="transactionTitle" placeholder="Salary, Groceries, etc." required>
      <label for="transactionAmount">Amount (â‚¹)</label>
      <input type="number" id="transactionAmount" placeholder="0.00" min="0" step="0.01" required>
      <label for="transactionCategory">Category</label>
      <select id="transactionCategory" required>
        <option value="">Select Category</option>
        <option value="salary">Salary</option>
        <option value="freelance">Freelance</option>
        <option value="investment">Investment</option>
        <option value="food">Food & Dining</option>
        <option value="transport">Transportation</option>
        <option value="utilities">Utilities</option>
        <option value="entertainment">Entertainment</option>
        <option value="shopping">Shopping</option>
      </select>
      <label for="transactionDate">Date</label>
      <input type="date" id="transactionDate" required>
      <button id="saveTransaction">Save Transaction</button>
    </div>
  </div>

  <!-- Expense Tracker Choice Modal -->
  <div id="expenseModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeExpenseModal">&times;</span>
      <h3>Expense Management</h3>
      <p>Choose how you want to manage your expenses:</p>
      <div class="modal-buttons">
        <a href="exp.html" class="btn"><i class="fas fa-list"></i> Detailed View</a>
        <a href="expensemanager.html" class="btn"><i class="fas fa-table"></i> Compact View</a>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // === Firebase Configuration ===
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.firebasestorage.app",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // === Element References ===
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuToggle = document.getElementById('menuToggle');
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const datetimeElem = document.getElementById('datetime');
    const usernameElem = document.getElementById('username');
    const profileCircle = document.getElementById('userInitials');
    const logoutBtn = document.getElementById('logoutBtn');
    const timeFilter = document.getElementById('timeFilter');
    const totalIncomeElem = document.getElementById('totalIncome');
    const totalExpensesElem = document.getElementById('totalExpenses');
    const dashboardContent = document.getElementById('dashboardContent');
    const addReminderBtn = document.getElementById('addReminderBtn');
    const reminderModal = document.getElementById('reminderModal');
    const closeModalBtn = document.getElementById('closeModal');
    const saveReminderBtn = document.getElementById('saveReminder');
    const reminderTypeSelect = document.getElementById('reminderType');
    const chartOfAccountsBtn = document.getElementById('chartOfAccountsBtn');
    const expenseTrackerBtn = document.getElementById('ExpenseTrackerBtn');
    const expenseModal = document.getElementById('expenseModal');
    const closeExpenseModal = document.getElementById('closeExpenseModal');
    const ReportsBtn = document.getElementById('ReportsBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const quickAddModal = document.getElementById('quickAddModal');
    const closeQuickAddModal = document.getElementById('closeQuickAddModal');
    const saveTransactionBtn = document.getElementById('saveTransaction');
    const typeSelectors = document.querySelectorAll('.type-selector');
    const headerAddBtn = document.getElementById('headerAddBtn');

    // === Global Variables ===
    let spendingChart; let calendar; let currentUser = null; let currentUserId = null; let db; let transactionType = 'income';

    // === Initialize Firebase ===
    function initializeFirebase() {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        checkAuthState();
      } catch (error) {
        console.error("Firebase initialization error:", error);
        hideLoadingIndicator();
        setupDemoData();
      }
    }

    // === Authentication and Session Management ===
    function checkAuthState() {
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user; currentUserId = user.uid;
          usernameElem.textContent = user.displayName || user.email;
          const name = user.displayName || user.email; profileCircle.textContent = (name.split(" ").map(p=>p[0]).join("") || 'U').toUpperCase();
          dashboardContent.style.display = 'block';
          hideLoadingIndicator();
          await loadUserData();
        } else {
          // No user signed in -> demo mode
          dashboardContent.style.display = 'block';
          hideLoadingIndicator();
          setupDemoData();
        }
      }, (error) => {
        console.error("Auth state error:", error); hideLoadingIndicator(); setupDemoData();
      });
    }

    function hideLoadingIndicator() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }

    // === Load User Data ===
    async function loadUserData() {
      await fetchSummaryData(timeFilter.value || 'month');
      await loadCalendarEvents();
    }

    // === Demo Data (when not authed) ===
    function setupDemoData() {
      usernameElem.textContent = 'Alex Johnson'; profileCircle.textContent = 'AJ';
      renderSpendingChart(['Food','Transport','Utilities','Entertainment','Shopping'], [2150,1850,2200,1350,1190]);
      initializeCalendar([
        { id: 'demo1', title: 'Electricity Bill', start: new Date(new Date().setDate(new Date().getDate()+2)), color:'#e63946', extendedProps:{ type:'bill', amount:'â‚¹1,200', notes:'Last day for payment' } },
        { id: 'demo2', title: 'Salary Credit', start: new Date(new Date().setDate(new Date().getDate()+5)), color:'#4caf50', extendedProps:{ type:'income', amount:'â‚¹45,000', notes:'Monthly salary' } },
        { id: 'demo3', title: 'Team Lunch', start: new Date(new Date().setDate(new Date().getDate()+7)), color:'#f77f00', extendedProps:{ type:'expense', amount:'â‚¹1,500', notes:'At Italian Cafe' } }
      ]);
    }

    // === Sidebar Toggle ===
    menuToggle.addEventListener('click', () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); });
    overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); profileDropdown.classList.remove('show-dropdown'); });

    // === Profile Dropdown ===
    profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('show-dropdown'); });
    window.addEventListener('click', (e) => { if (!e.target.closest('.profile') && !e.target.closest('.dropdown')) profileDropdown.classList.remove('show-dropdown'); });

    // === Live Clock ===
    function updateTime() {
      const now = new Date();
      datetimeElem.textContent = now.toLocaleString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateTime, 1000); updateTime();

    // === Logout ===
    logoutBtn.addEventListener('click', () => { firebase.auth().signOut().then(()=>location.href='index.html').catch(console.error); });

    // === Chart.js ===
    function renderSpendingChart(labels, values) {
      const chartCanvas = document.getElementById('spendingChart'); if (!chartCanvas) return;
      if (spendingChart) spendingChart.destroy();
      const colors = ['#4361ee','#4cc9f0','#f72585','#7209b7','#f77f00','#4caf50','#00b894','#fdcb6e'];
      spendingChart = new Chart(chartCanvas, { type:'doughnut', data:{ labels, datasets:[{ label:'Amount (â‚¹)', data: values, backgroundColor: colors, borderWidth:0, hoverOffset:12 }] }, options:{ responsive:true, cutout:'65%', plugins:{ legend:{ position:'bottom', labels:{ padding:20, usePointStyle:true, pointStyle:'circle' }}}}});
    }

    // === Summary (Income/Expenses) ===
    async function fetchSummaryData(filter) {
      if (!currentUserId) {
        const demo = { today:{income:1250,expenses:870}, week:{income:6850,expenses:4320}, month:{income:12500,expenses:8740}, year:{income:148500,expenses:102300} };
        const s = demo[filter] || demo.month; totalIncomeElem.textContent = `â‚¹${s.income.toLocaleString()}`; totalExpensesElem.textContent = `â‚¹${s.expenses.toLocaleString()}`; return;
      }
      try {
        const now = new Date(); let startDate, endDate;
        switch(filter){
          case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1); break;
          case 'week': const d = now.getDay(); startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()-d); endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()+(6-d)+1); break;
          case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth()+1, 1); break;
          case 'year': startDate = new Date(now.getFullYear(), 0, 1); endDate = new Date(now.getFullYear()+1, 0, 1); break;
          default: startDate = new Date(now.getFullYear(), now.getMonth(), 1); endDate = new Date(now.getFullYear(), now.getMonth()+1, 1);
        }
        const transactionsRef = db.collection('users').doc(currentUserId).collection('transactions');
        const snapshot = await transactionsRef.where('date','>=',startDate).where('date','<',endDate).get();
        let totalIncome = 0, totalExpenses = 0; const categoryExpenses = {};
        snapshot.forEach(doc => { const t = doc.data(); if (t.type === 'income') { totalIncome += t.amount; } else { totalExpenses += t.amount; categoryExpenses[t.category] = (categoryExpenses[t.category]||0) + t.amount; } });
        totalIncomeElem.textContent = `â‚¹${totalIncome.toLocaleString()}`; totalExpensesElem.textContent = `â‚¹${totalExpenses.toLocaleString()}`;
        renderSpendingChart(Object.keys(categoryExpenses), Object.values(categoryExpenses));
      } catch (e) { console.error('Error fetching summary:', e); }
    }
    timeFilter.addEventListener('change', (e)=>fetchSummaryData(e.target.value));

    // === Calendar ===
    function initializeCalendar(events = []) {
      const el = document.getElementById('calendarContainer'); if (!el) return;
      if (calendar) { calendar.destroy(); }
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth', height: 'auto', headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,dayGridWeek,dayGridDay' },
        events: events,
        eventClick: handleEventClick,
        eventDisplay: 'block', eventTimeFormat: { hour:'2-digit', minute:'2-digit', meridiem:'short' }
      });
      calendar.render();
    }

    async function loadCalendarEvents() {
      if (!currentUserId) return; // demo handled elsewhere
      try {
        const qs = await db.collection('users').doc(currentUserId).collection('reminders').orderBy('createdAt','desc').get();
        const events = qs.docs.map(d => ({ id: d.id, ...d.data(), start: d.data().start?.toDate ? d.data().start.toDate() : d.data().start }));
        initializeCalendar(events);
      } catch (e) { console.error('Error loading reminders:', e); initializeCalendar([]); }
    }

    // === Reminder Modal ===
    function openReminderModal(){ reminderModal.style.display = 'flex'; }
    function closeReminderModal(){ reminderModal.style.display = 'none'; }
    addReminderBtn.addEventListener('click', openReminderModal);
    closeModalBtn.addEventListener('click', closeReminderModal);

    // Save reminder
    saveReminderBtn.addEventListener('click', async () => {
      const title = document.getElementById('reminderTitle').value.trim();
      const date = document.getElementById('reminderDate').value; if (!title || !date) { alert('Please fill in required fields.'); return; }
      const time = document.getElementById('reminderTime').value; const amount = document.getElementById('reminderAmount').value; const notes = document.getElementById('reminderNotes').value; const type = reminderTypeSelect.value;
      const color = type === 'bill' ? '#e63946' : (type === 'income' ? '#4caf50' : '#4361ee');
      const startDate = time ? new Date(`${date}T${time}`) : new Date(date);
      const newEvent = { title, start: startDate, color, extendedProps: { type, time, amount: amount ? `â‚¹${amount}` : '', notes } };
      try {
        if (currentUserId) {
          const docRef = await db.collection('users').doc(currentUserId).collection('reminders').add({ ...newEvent, createdAt: new Date() });
          newEvent.id = docRef.id;
        }
        if (calendar) calendar.addEvent(newEvent);
        alert('Reminder added successfully!');
        closeReminderModal();
        document.getElementById('reminderTitle').value = '';
        document.getElementById('reminderDate').value = '';
        document.getElementById('reminderTime').value = '';
        document.getElementById('reminderAmount').value = '';
        document.getElementById('reminderNotes').value = '';
      } catch (error) { console.error('Error saving reminder:', error); alert('Error saving reminder. Please try again.'); }
    });

    // === Quick Add Transaction ===
    // Header button opens the same Quick Add modal
    headerAddBtn.addEventListener('click', () => {
      quickAddModal.style.display = 'flex';
      document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    });
    closeQuickAddModal.addEventListener('click', () => { quickAddModal.style.display = 'none'; });

    // Type selector
    typeSelectors.forEach(btn => btn.addEventListener('click', () => { typeSelectors.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); transactionType = btn.dataset.type; }));

    // Save transaction
    saveTransactionBtn.addEventListener('click', async () => {
      const title = document.getElementById('transactionTitle').value.trim();
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const category = document.getElementById('transactionCategory').value;
      const date = document.getElementById('transactionDate').value;
      if (!title || !amount || !category || !date) { alert('Please fill in all required fields.'); return; }
      try {
        if (currentUserId) {
          await db.collection('users').doc(currentUserId).collection('transactions').add({ title, amount, type: transactionType, category, date: new Date(date), createdAt: new Date() });
        }
        fetchSummaryData(timeFilter.value);
        quickAddModal.style.display = 'none';
        alert('Transaction added successfully!');
        document.getElementById('transactionTitle').value = '';
        document.getElementById('transactionAmount').value = '';
        document.getElementById('transactionCategory').value = '';
      } catch (error) { console.error('Error saving transaction:', error); alert('Error saving transaction. Please try again.'); }
    });

    // === Event Click Handler ===
    function handleEventClick(info) {
      const event = info.event; const props = event.extendedProps || {};
      const popup = document.createElement('div'); popup.className = 'popup-modal';
      popup.innerHTML = `
        <div class="popup-content">
          <span class="close-popup" id="closePopupBtn">&times;</span>
          <h3>${event.title}</h3>
          <p><strong>Date:</strong> ${event.start ? new Date(event.start).toLocaleDateString() : ''}</p>
          ${props.time ? `<p><strong>Time:</strong> ${props.time}</p>` : ''}
          ${props.amount ? `<p><strong>Amount:</strong> ${props.amount}</p>` : ''}
          ${props.notes ? `<p><strong>Notes:</strong> ${props.notes}</p>` : ''}
          <button id="deleteEventBtn">Delete Reminder</button>
        </div>`;
      document.body.appendChild(popup);
      document.getElementById('closePopupBtn').addEventListener('click', () => popup.remove());
      document.getElementById('deleteEventBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this reminder?')) return;
        try {
          if (currentUserId && event.id) {
            await db.collection('users').doc(currentUserId).collection('reminders').doc(event.id).delete();
          }
          event.remove(); popup.remove();
        } catch (e) { console.error('Error deleting reminder:', e); alert('Error deleting reminder. Please try again.'); }
      });
    }

    // === Navigation Handlers ===
    chartOfAccountsBtn.addEventListener('click', () => { window.location.href = 'coa.html'; });
    expenseTrackerBtn.addEventListener('click', () => { expenseModal.style.display = 'flex'; });
    closeExpenseModal.addEventListener('click', () => { expenseModal.style.display = 'none'; });
    ReportsBtn.addEventListener('click', () => { alert('Reports section would open here.'); });

    // Close modals clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === reminderModal) closeReminderModal();
      if (e.target === expenseModal) expenseModal.style.display = 'none';
      if (e.target === quickAddModal) quickAddModal.style.display = 'none';
    });

    // === Initialize App ===
    document.addEventListener('DOMContentLoaded', () => { initializeFirebase(); });
  </script>
</body>
</html>
