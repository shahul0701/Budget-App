<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BudgetFlow - Dashboard</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- FontAwesome + SweetAlert -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --accent:#6f42c1;
      --accent-2:#6a3dd6;
      --sidebar-w:250px;
      --sidebar-collapsed:70px;
      --header-h:64px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:#f4f6fb;
      font-family:Inter, system-ui, Arial;
      color:#222;
    }

    /* Sidebar */
    #sidebar{
      position:fixed;
      left:0; top:0; bottom:0;
      width:var(--sidebar-w);
      background:#fff;
      box-shadow: 0 0 20px rgba(10,10,10,0.06);
      transition:width .25s;
      z-index:1000;
      overflow:auto;
    }
    #sidebar.collapsed{width:var(--sidebar-collapsed)}
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:18px 20px; border-bottom:1px solid #f0f0f0;
    }
    .brand h1{font-size:18px;margin:0;color:var(--accent)}
    .sidebar-nav{list-style:none;padding:14px 0;margin:0}
    .sidebar-nav li{padding:12px 20px; display:flex; align-items:center; gap:12px; cursor:pointer}
    .sidebar-nav li a{display:flex;align-items:center; gap:12px; color:#333; text-decoration:none; width:100%}
    .sidebar-nav li:hover{background:#fbf8ff}
    .sidebar-nav i{width:20px;text-align:center}

    /* Main content */
    .main{
      margin-left:var(--sidebar-w);
      transition:margin-left .25s;
      min-height:100vh;
    }
    .main.expanded{margin-left:var(--sidebar-collapsed)}

    /* Header */
    .header{
      height:var(--header-h);
      background:#fff;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; box-shadow: 0 2px 12px rgba(10,10,10,0.04);
      position:sticky; top:0; z-index:500;
    }
    .left-head{display:flex;align-items:center;gap:14px}
    #menuToggle{font-size:18px; cursor:pointer;}
    #liveClock{font-weight:600;color:#444}

    .profile{
      display:flex; align-items:center; gap:10px; position:relative;
      cursor:pointer;
    }
    .profile-initials{
      width:40px;height:40px;border-radius:50%;background:var(--accent);color:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:700;
    }
    .profile-name{font-weight:600}
    .profile-dropdown{
      position:absolute; right:0; top:58px; background:#fff; box-shadow:0 8px 30px rgba(10,10,10,0.08);
      border-radius:8px; overflow:hidden; display:none; min-width:160px;
    }
    .profile-dropdown a, .profile-dropdown button{
      display:block; padding:10px 12px; text-decoration:none; color:#333; border:0; background:none; width:100%; text-align:left;
    }
    .profile-dropdown a:hover, .profile-dropdown button:hover{background:#f5f5f7}

    /* Dashboard layout */
    .dashboard{
      padding:20px; display:grid;
      grid-template-columns: 1fr 420px; gap:20px;
    }
    @media (max-width:1100px){
      .dashboard{ grid-template-columns:1fr; }
      #sidebar{left:-9999px; position:fixed}
      .main{ margin-left:0 }
    }

    .cards{display:flex; gap:16px; margin-bottom:16px}
    .card{
      background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(10,10,10,0.04);
      flex:1;
    }
    .card h4{margin:0 0 8px 0; font-size:13px; color:#666}
    .card p{font-size:20px; margin:0; font-weight:700}

    .chart-box{
      background:#fff;padding:18px;border-radius:10px; box-shadow:0 6px 18px rgba(10,10,10,0.04);
    }

    /* Calendar panel */
    .calendar-panel{ background:#fff;padding:12px;border-radius:10px; box-shadow:0 6px 18px rgba(10,10,10,0.04); }
    .calendar-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .add-btn{width:38px;height:38px;border-radius:50%; background:var(--accent); color:#fff;border:0; cursor:pointer; font-size:18px}

    /* Modal */
    .modal{
      position:fixed; left:0; right:0; top:0; bottom:0; display:none;
      background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:2000;
    }
    .modal.show{display:flex}
    .modal-card{ width:100%; max-width:520px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 8px 30px rgba(10,10,10,0.12); position:relative;}
    .modal-card h3{margin:0 0 12px 0}
    .modal-close{ position:absolute; right:12px; top:12px; font-size:20px; cursor:pointer }

    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .form-row-1{display:block}
    label{font-size:13px;margin-bottom:6px;display:block;color:#444;font-weight:600}
    input[type="text"], input[type="date"], input[type="time"], textarea, select{
      width:100%; padding:10px; border-radius:8px; border:1px solid #e6e6e9;
    }
    textarea{min-height:90px; resize:vertical}
    .btn-row{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}

    /* details modal */
    .details-list p{ margin:6px 0; color:#333 }
    .danger{ background:#dc3545; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer }

    /* small helpers */
    .muted{ color:#6c757d; font-size:13px }

  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <div class="brand">
      <h1>BudgetFlow</h1>
      <button id="menuToggle" aria-label="Toggle menu"><i class="fas fa-bars"></i></button>
    </div>
    <ul class="sidebar-nav">
      <li><a href="home.html"><i class="fas fa-home"></i><span>Home</span></a></li>
      <li><a href="coa.html"><i class="fas fa-book"></i><span>COA</span></a></li>
      <li><a href="Section.html"><i class="fas fa-file-invoice"></i><span>Reports</span></a></li>
      <li><a href="chart.html"><i class="fas fa-chart-pie"></i><span>Chart</span></a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main" id="mainContent">
    <!-- Header -->
    <div class="header">
      <div class="left-head">
        <div id="liveClock">--:--:--</div>
      </div>
      <div class="profile" id="profileBtn">
        <div class="profile-initials" id="profileInitials">U</div>
        <div class="profile-name" id="profileName">User</div>

        <div class="profile-dropdown" id="profileDropdown">
          <a href="coa.html"><i class="fas fa-cog"></i> Settings</a>
          <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" style="padding:20px;">
      <!-- left column -->
      <div>
        <div class="cards">
          <div class="card">
            <h4>Total Income</h4>
            <p id="totalIncome">₹0.00</p>
            <div class="muted">This Month</div>
          </div>
          <div class="card">
            <h4>Total Expenses</h4>
            <p id="totalExpenses">₹0.00</p>
            <div class="muted">This Month</div>
          </div>
          <div class="card">
            <h4>Balance</h4>
            <p id="balance">₹0.00</p>
            <div class="muted">Income - Expenses</div>
          </div>
        </div>

        <div class="chart-box" style="margin-bottom:18px">
          <h3 style="margin-top:0">Spending Chart</h3>
          <canvas id="spendingChart" style="height:240px"></canvas>
        </div>

        <!-- placeholder: other dashboard widgets could go here -->
      </div>

      <!-- right column - calendar -->
      <div>
        <div class="calendar-panel">
          <div class="calendar-header">
            <h3 style="margin:0">Reminders & Events</h3>
            <button class="add-btn" id="openAddModal" title="Add event"><i class="fas fa-plus"></i></button>
          </div>
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Event Modal -->
  <div class="modal" id="eventModal">
    <div class="modal-card">
      <div class="modal-close" id="closeModal">&times;</div>
      <h3>Add Reminder / Event</h3>

      <form id="eventForm">
        <div style="margin-bottom:10px">
          <label for="eventType">Type</label>
          <select id="eventType" required>
            <option value="reminder">Reminder</option>
            <option value="birthday">Birthday</option>
            <option value="meeting">Meeting</option>
          </select>
        </div>

        <div style="margin-bottom:10px">
          <label for="eventTitle">Title</label>
          <input id="eventTitle" type="text" placeholder="e.g., John's Birthday / Pay Rent" required />
        </div>

        <div class="form-row" style="margin-bottom:10px">
          <div>
            <label for="eventDate">Date</label>
            <input id="eventDate" type="date" required />
          </div>
          <div>
            <label for="eventTime">Time (optional)</label>
            <input id="eventTime" type="time" />
          </div>
        </div>

        <div style="margin-bottom:10px">
          <label for="eventNotes">Notes</label>
          <textarea id="eventNotes" placeholder="Add notes..."></textarea>
        </div>

        <div class="btn-row">
          <button type="button" id="cancelEvent" style="background:#f0f0f0;border:0;padding:8px 12px;border-radius:8px">Cancel</button>
          <button type="submit" style="background:var(--accent); color:#fff; border:0; padding:8px 12px;border-radius:8px">Save Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Details Modal -->
  <div class="modal" id="detailsModal">
    <div class="modal-card">
      <div class="modal-close" id="closeDetails">&times;</div>
      <h3 id="detailTitle">Event</h3>
      <div class="details-list">
        <p><strong>Date:</strong> <span id="detailDate"></span></p>
        <p><strong>Time:</strong> <span id="detailTime"></span></p>
        <p><strong>Type:</strong> <span id="detailType"></span></p>
        <p><strong>Notes:</strong> <span id="detailNotes"></span></p>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
        <button id="closeDetailsBtn" style="padding:8px 12px;border-radius:8px;background:#f0f0f0;border:0">Close</button>
        <button id="deleteEvent" class="danger">Delete Event</button>
      </div>
    </div>
  </div>

  <script>
    /*******************************
     * Firebase config (your project)
     * Replace these if you want another project
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.firebasestorage.app",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM refs
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    const main = document.querySelector('.main');
    const liveClock = document.getElementById('liveClock');
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const profileInitials = document.getElementById('profileInitials');
    const profileName = document.getElementById('profileName');
    const logoutBtn = document.getElementById('logoutBtn');

    const openAddModal = document.getElementById('openAddModal');
    const eventModal = document.getElementById('eventModal');
    const closeModal = document.getElementById('closeModal');
    const eventForm = document.getElementById('eventForm');
    const cancelEvent = document.getElementById('cancelEvent');

    const detailsModal = document.getElementById('detailsModal');
    const closeDetails = document.getElementById('closeDetails');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const deleteEventBtn = document.getElementById('deleteEvent');

    const eventType = document.getElementById('eventType');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventTime = document.getElementById('eventTime');
    const eventNotes = document.getElementById('eventNotes');

    const detailTitle = document.getElementById('detailTitle');
    const detailDate = document.getElementById('detailDate');
    const detailTime = document.getElementById('detailTime');
    const detailType = document.getElementById('detailType');
    const detailNotes = document.getElementById('detailNotes');

    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpensesEl = document.getElementById('totalExpenses');
    const balanceEl = document.getElementById('balance');

    let calendar;                       // FullCalendar instance
    let currentUser = null;             // firebase user
    let currentSelectedEvent = null;    // for details/delete
    let transactions = [];              // cached transactions (for chart)
    let spendingChart = null;

    // Live clock
    function updateClock(){
      const now = new Date();
      const opt = { weekday:'short', year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' };
      liveClock.textContent = now.toLocaleString('en-GB', opt);
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Sidebar toggle
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('expanded');
    });

    // Profile dropdown toggle
    document.getElementById('profileBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
    });
    // Hide dropdown if click outside
    document.addEventListener('click', (e) => {
      if (!profileBtn.contains(e.target)) profileDropdown.style.display = 'none';
    });

    // Logout behaviour -> sign out and redirect to index.html
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await auth.signOut();
        // redirect
        window.location.href = 'index.html';
      } catch (err) {
        console.error('Logout error', err);
        Swal.fire('Error', 'Could not log out', 'error');
      }
    });

    // Initialize app: auth -> then load ui
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "Guest User";
        profileName.textContent = name;
        profileInitials.textContent = getInitials(name);
        // load everything
        initCalendar();
        loadReminders();       // load events from Firestore
        loadTransactions();    // load transactions for chart + totals
      } else {
        // sign in anonymously (if you prefer users must sign in, remove this)
        try {
          const cred = await auth.signInAnonymously();
          currentUser = cred.user;
          profileName.textContent = 'Guest';
          profileInitials.textContent = 'G';
          initCalendar();
          loadReminders();
          loadTransactions();
        } catch (err) {
          console.error('Auth failed', err);
          Swal.fire('Auth Error', 'Failed to sign in', 'error');
        }
      }
    });

    function getInitials(name){
      if (!name) return 'U';
      const parts = name.split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
    }

    /*************************
     * Calendar setup
     *************************/
    function initCalendar(){
      const calendarEl = document.getElementById('calendar');

      // create calendar
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 600,
        // click on day (optional): open modal prefilled with date
        dateClick: function(info) {
          openEventModalWithDate(info.dateStr);
        },
        eventClick: function(info) {
          // show details modal
          const ev = info.event.extendedProps.__raw || {};
          // raw object saved when we created events to include firestore id and meta
          currentSelectedEvent = ev;
          showDetailsModalFromEvent(ev);
        },
        events: [] // we'll populate later
      });

      calendar.render();
    }

    // open modal and set date
    function openEventModalWithDate(dateStr){
      eventDate.value = dateStr;
      eventTime.value = '';
      eventTitle.value = '';
      eventNotes.value = '';
      eventType.value = 'reminder';
      eventModal.classList.add('show');
    }

    // event modal open/close binds
    openAddModal.addEventListener('click', () => {
      eventDate.value = new Date().toISOString().split('T')[0];
      eventTime.value = '';
      eventTitle.value = '';
      eventNotes.value = '';
      eventType.value = 'reminder';
      eventModal.classList.add('show');
    });
    closeModal.addEventListener('click', () => eventModal.classList.remove('show'));
    cancelEvent.addEventListener('click', () => eventModal.classList.remove('show'));

    // details modal close
    closeDetails.addEventListener('click', () => detailsModal.classList.remove('show'));
    closeDetailsBtn.addEventListener('click', () => detailsModal.classList.remove('show'));

    // show details modal filled from firestore raw doc
    function showDetailsModalFromEvent(raw){
      if (!raw) return;
      detailTitle.textContent = raw.title || 'Event';
      detailDate.textContent = raw.date || '';
      detailTime.textContent = raw.time || '--';
      detailType.textContent = (raw.type || '--').toUpperCase();
      detailNotes.textContent = raw.notes || '';
      // keep firestore doc id on currentSelectedEvent
      detailsModal.classList.add('show');
    }

    // delete event (from details modal)
    deleteEventBtn.addEventListener('click', async () => {
      if (!currentSelectedEvent || !currentSelectedEvent.id) {
        Swal.fire('Error', 'Event id not found', 'error');
        return;
      }
      const id = currentSelectedEvent.id;
      const result = await Swal.fire({
        title: 'Delete event?',
        text: 'This will remove the event permanently.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Delete',
      });
      if (result.isConfirmed) {
        try {
          await db.collection('reminders').doc(id).delete();
          Swal.fire('Deleted', 'Event deleted', 'success');
          detailsModal.classList.remove('show');
        } catch (err) {
          console.error('Delete failed', err);
          Swal.fire('Error', 'Failed to delete', 'error');
        }
      }
    });

    /*************************
     * Save new reminder -> Firestore
     *************************/
    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        Swal.fire('Not signed in', 'You must be signed in to save reminders', 'warning');
        return;
      }

      const data = {
        title: eventTitle.value.trim(),
        type: eventType.value,
        date: eventDate.value,            // YYYY-MM-DD
        time: eventTime.value || '',
        notes: eventNotes.value || '',
        userId: currentUser.uid,
        createdAt: new Date().toISOString()
      };

      if (!data.title || !data.date) {
        Swal.fire('Validation', 'Title and Date are required', 'warning');
        return;
      }

      try {
        // Save to Firestore
        const ref = await db.collection('reminders').add(data);
        // close modal
        eventModal.classList.remove('show');
        Swal.fire('Saved', 'Reminder saved', 'success');
      } catch (err) {
        console.error('Save reminder err', err);
        Swal.fire('Error', 'Failed to save reminder', 'error');
      }
    });

    /*************************
     * Load reminders from Firestore
     *************************/
    let remindersUnsub = null;
    function loadReminders(){
      if (!currentUser) return;
      // detach existing listener
      if (remindersUnsub) remindersUnsub();

      // Listen realtime for current user's reminders
      remindersUnsub = db.collection('reminders')
        .where('userId', '==', currentUser.uid)
        .orderBy('date', 'asc')
        .onSnapshot(snapshot => {
          const events = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;

            // Keep raw object to allow deletion/etc
            const raw = {
              id: doc.id,
              title: d.title,
              type: d.type,
              date: d.date,
              time: d.time,
              notes: d.notes,
              userId: d.userId
            };

            if (d.type === 'birthday') {
              // For birthdays: generate events for several years so they "repeat yearly"
              // We'll create events for current year -1 .. current year + 5
              const base = new Date(d.date); // note: d.date stored as yyyy-mm-dd
              // extract month & day
              const md = d.date.split('-');
              const month = parseInt(md[1], 10);
              const day = parseInt(md[2], 10);
              const now = new Date();
              const thisYear = now.getFullYear();
              for (let y = thisYear - 1; y <= thisYear + 5; y++) {
                const iso = `${y}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                events.push({
                  title: d.title + ' (Birthday)',
                  start: iso,
                  allDay: true,
                  color: '#ffb703',
                  extendedProps: { __raw: raw }
                });
              }
            } else {
              // One-time event (meeting or reminder)
              const start = d.time ? `${d.date}T${d.time}` : d.date;
              events.push({
                title: d.title,
                start: start,
                allDay: d.time ? false : true,
                color: d.type === 'meeting' ? '#4caf50' : '#6f42c1',
                extendedProps: { __raw: raw }
              });
            }
          });

          // Remove all events and add new ones
          calendar.removeAllEvents();
          events.forEach(ev => calendar.addEvent(ev));
        }, err => {
          console.error('Reminders loading error', err);
          Swal.fire('Error', 'Failed to load reminders', 'error');
        });
    }

    /*************************
     * Transactions loader + Chart
     * (loads from a 'transactions' collection where userId == currentUser.uid)
     *************************/
    let txUnsub = null;
    function loadTransactions(){
      if (!currentUser) return;
      // detach
      if (txUnsub) txUnsub();

      // Example: load transactions for current month
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const startStr = monthStart.toISOString().split('T')[0];

      txUnsub = db.collection('transactions')
        .where('userId', '==', currentUser.uid)
        .where('DATE', '>=', startStr)
        .orderBy('DATE', 'desc')
        .onSnapshot(snapshot => {
          transactions = [];
          let totalIn = 0;
          let totalEx = 0;
          snapshot.forEach(doc => {
            const d = doc.data();
            transactions.push({ id: doc.id, ...d });
            totalIn += parseFloat(d.INCOME || 0);
            totalEx += parseFloat(d.EXPENSE || 0);
          });

          totalIncomeEl.textContent = `₹${totalIn.toFixed(2)}`;
          totalExpensesEl.textContent = `₹${totalEx.toFixed(2)}`;
          balanceEl.textContent = `₹${(totalIn - totalEx).toFixed(2)}`;

          renderSpendingChart();
        }, err => {
          console.error('Transactions load error', err);
        });
    }

    function renderSpendingChart(){
      // prepare categories from transactions: sum EXPENSE per ACCOUNT_HEADER
      const categories = {};
      transactions.forEach(tx => {
        const exp = parseFloat(tx.EXPENSE || 0);
        if (exp > 0) {
          const cat = tx.ACCOUNT_HEADER || 'Uncategorized';
          categories[cat] = (categories[cat] || 0) + exp;
        }
      });
      const labels = Object.keys(categories);
      const data = Object.values(categories);

      const ctx = document.getElementById('spendingChart').getContext('2d');
      if (spendingChart) spendingChart.destroy();

      if (!data.length) {
        // show placeholder donut with single slice and label
        spendingChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels: ['No data'], datasets: [{ data: [1], backgroundColor: ['#e9ecef'] }] },
          options: { plugins:{legend:{display:false}}, maintainAspectRatio:false }
        });
        return;
      }

      spendingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#6f42c1','#36a2eb','#ffcd56','#4bc0c0','#9966ff','#ff9f40','#dc3545','#28a745'
            ]
          }]
        },
        options: { maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    /*************************
     * Clean up before leaving page
     *************************/
    window.addEventListener('beforeunload', () => {
      if (remindersUnsub) remindersUnsub();
      if (txUnsub) txUnsub();
    });
  </script>
</body>
</html>
