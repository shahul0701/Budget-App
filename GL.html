<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General Ledger</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
/* General Styles */
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f5f7fa;
    color: #333;
    line-height: 1.6;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

header {
    background: white;
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-radius: 8px;
}

.header-left a {
    text-decoration: none;
    color: #3498db;
    font-weight: bold;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

#userInitials {
    background: #3498db;
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

#logoutBtn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 15px;
    cursor: pointer;
}

#logoutBtn:hover {
    background: #c0392b;
}

h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
}

/* Controls */
.controls {
    background: white;
    padding: 20px;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.controls label {
    font-weight: 600;
    color: #2c3e50;
}

.controls select, .controls input {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 14px;
}

#generateGLBtn {
    background: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

#generateGLBtn:hover {
    background: #2980b9;
}

.export-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.export-buttons button {
    background: #27ae60;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.export-buttons button:hover {
    background: #219a52;
}

/* GL Summary */
.gl-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.summary-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.summary-card.total-transactions {
    border-top: 4px solid #3498db;
}

.summary-card.total-debit {
    border-top: 4px solid #e74c3c;
}

.summary-card.total-credit {
    border-top: 4px solid #2ecc71;
}

.summary-card.balance {
    border-top: 4px solid #f39c12;
}

.card-title {
    font-size: 14px;
    color: #95a5a6;
    margin-bottom: 8px;
}

.card-value {
    font-size: 20px;
    font-weight: 700;
}

.total-transactions .card-value { color: #3498db; }
.total-debit .card-value { color: #e74c3c; }
.total-credit .card-value { color: #2ecc71; }
.balance .card-value { color: #f39c12; }

/* GL Table */
.gl-table-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    overflow-x: auto;
}

.gl-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.gl-table th {
    background: #34495e;
    color: white;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
}

.gl-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #ecf0f1;
}

.gl-table tr:hover {
    background: #f8f9fa;
}

.gl-table .debit {
    color: #e74c3c;
    font-weight: 600;
}

.gl-table .credit {
    color: #2ecc71;
    font-weight: 600;
}

.gl-table .transaction-id {
    font-family: monospace;
    font-size: 12px;
    color: #7f8c8d;
}

/* Account Breakdown */
.account-breakdown {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .account-breakdown {
        grid-template-columns: 1fr;
    }
}

.income-accounts, .expense-accounts {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.section-title {
    font-size: 18px;
    color: #2c3e50;
    margin-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 8px;
}

.account-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f1f1f1;
}

.account-item:last-child {
    border-bottom: none;
}

.account-name {
    font-weight: 600;
    color: #2c3e50;
}

.account-balance {
    font-weight: 600;
}

.income-accounts .account-balance {
    color: #2ecc71;
}

.expense-accounts .account-balance {
    color: #e74c3c;
}

/* Loading Modal */
.loading-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.loading-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #bdc3c7;
}

.report-period {
    text-align: center;
    margin-bottom: 20px;
    font-style: italic;
    color: #95a5a6;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
</style>
</head>
<body>

<header>
    <div class="header-left">
        <a href="home.html"><i class="fa fa-home"></i> Home</a>
    </div>
    <div class="header-right">
        <div id="userInitials">U</div>
        <div id="username">User</div>
        <button id="logoutBtn">Logout</button>
    </div>
</header>

<div class="container">
    <h1><i class="fas fa-book"></i> General Ledger</h1>

    <div class="controls">
        <label>Period:
            <select id="reportPeriod">
                <option value="month">This Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="custom">Custom</option>
            </select>
        </label>

        <div id="customDateRange" style="display:none;flex-wrap:wrap;gap:10px;">
            <label>From: <input type="date" id="startDate"></label>
            <label>To: <input type="date" id="endDate"></label>
        </div>

        <label>Group By:
            <select id="groupBy">
                <option value="date">Date</option>
                <option value="category">Category</option>
                <option value="none">No Grouping</option>
            </select>
        </label>

        <button id="generateGLBtn">Generate GL Report</button>
    </div>

    <div class="export-buttons">
        <button id="exportGLPDF"><i class="fa fa-file-pdf"></i> Export GL as PDF</button>
        <button id="exportGLCSV"><i class="fa fa-file-csv"></i> Export GL as CSV</button>
    </div>

    <div id="reportPeriodDisplay" class="report-period"></div>

    <div class="gl-summary">
        <div class="summary-card total-transactions">
            <div class="card-title">Total Transactions</div>
            <div class="card-value" id="totalTransactions">0</div>
        </div>
        <div class="summary-card total-debit">
            <div class="card-title">Total Debit</div>
            <div class="card-value" id="totalDebit">₹0.00</div>
        </div>
        <div class="summary-card total-credit">
            <div class="card-title">Total Credit</div>
            <div class="card-value" id="totalCredit">₹0.00</div>
        </div>
        <div class="summary-card balance">
            <div class="card-title">Net Balance</div>
            <div class="card-value" id="netBalance">₹0.00</div>
        </div>
    </div>

    <div class="gl-table-container">
        <h3 class="section-title">General Ledger Entries</h3>
        <div id="glTableContent">
            <div class="empty-state">
                <i class="fas fa-book-open"></i>
                <p>No ledger data available. Generate a report to view transactions.</p>
            </div>
        </div>
    </div>

    <div class="account-breakdown">
        <div class="income-accounts">
            <h3 class="section-title">Income Accounts Summary</h3>
            <div id="incomeAccounts"></div>
        </div>
        <div class="expense-accounts">
            <h3 class="section-title">Expense Accounts Summary</h3>
            <div id="expenseAccounts"></div>
        </div>
    </div>
</div>

<div id="loadingModal" class="loading-modal">
    <div class="loading-content">
        <i class="fa fa-spinner fa-spin" style="font-size:40px;margin-bottom:15px;"></i>
        <p>Generating General Ledger...</p>
    </div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    query, 
    getDocs, 
    orderBy 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
});

const db = getFirestore(app);
const auth = getAuth(app);

// DOM Elements
const usernameElem = document.getElementById("username");
const initialsElem = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const reportPeriod = document.getElementById("reportPeriod");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const customDateRange = document.getElementById("customDateRange");
const groupBySelect = document.getElementById("groupBy");
const generateGLBtn = document.getElementById("generateGLBtn");
const reportPeriodDisplay = document.getElementById("reportPeriodDisplay");
const totalTransactionsElem = document.getElementById("totalTransactions");
const totalDebitElem = document.getElementById("totalDebit");
const totalCreditElem = document.getElementById("totalCredit");
const netBalanceElem = document.getElementById("netBalance");
const glTableContent = document.getElementById("glTableContent");
const incomeAccountsElem = document.getElementById("incomeAccounts");
const expenseAccountsElem = document.getElementById("expenseAccounts");
const exportGLPDFBtn = document.getElementById("exportGLPDF");
const exportGLCSVBtn = document.getElementById("exportGLCSV");
const loadingModal = document.getElementById("loadingModal");

let currentUser = null;
let currentGLData = null;

// ===== Auth Listener =====
onAuthStateChanged(auth, async user => {
    if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = name.charAt(0).toUpperCase();
        
        setDefaultDates();
        generateGLReport();
    } else {
        alert("Please login first.");
        window.location.href = "index.html";
    }
});

// ===== Logout =====
logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
});

// ===== Event Listeners =====
reportPeriod.addEventListener("change", () => {
    customDateRange.style.display = reportPeriod.value === "custom" ? "flex" : "none";
});
generateGLBtn.addEventListener("click", generateGLReport);
exportGLPDFBtn.addEventListener("click", exportGLPDF);
exportGLCSVBtn.addEventListener("click", exportGLCSV);

// ===== Helper Functions =====
function setDefaultDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    startDateInput.value = formatDate(firstDay);
    endDateInput.value = formatDate(lastDay);
}

function formatDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
}

function formatDisplay(date) {
    return date.toLocaleDateString("en-IN", { year: "numeric", month: "long", day: "numeric" });
}

function getDateRange() {
    const today = new Date();
    let startDate, endDate;
    
    switch (reportPeriod.value) {
        case "month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case "lastMonth":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case "quarter":
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
            break;
        case "year":
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
            break;
        case "custom":
            startDate = new Date(startDateInput.value);
            endDate = new Date(endDateInput.value);
            break;
        default:
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    }
    
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);
    
    return { startDate, endDate };
}

// ===== Load Transactions =====
async function loadTransactions(startDate, endDate) {
    loadingModal.style.display = "flex";
    try {
        const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
        const q = query(transactionsRef, orderBy("DATE", "asc"));
        
        const snap = await getDocs(q);
        
        const transactions = snap.docs
            .map(d => ({ id: d.id, ...d.data() }))
            .filter(tx => {
                if (!tx.DATE) return false;
                
                let transactionDate;
                if (typeof tx.DATE === 'string') {
                    transactionDate = new Date(tx.DATE);
                } else if (tx.DATE && typeof tx.DATE.toDate === 'function') {
                    transactionDate = tx.DATE.toDate();
                } else if (tx.DATE && typeof tx.DATE === 'object') {
                    transactionDate = new Date(tx.DATE);
                } else {
                    return false;
                }
                
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        
        return transactions;
    } catch (err) {
        console.error("Error loading transactions:", err);
        Swal.fire("Error", "Failed to load transactions: " + err.message, "error");
        return [];
    } finally {
        loadingModal.style.display = "none";
    }
}

// ===== Generate GL Report =====
async function generateGLReport() {
    const { startDate, endDate } = getDateRange();
    reportPeriodDisplay.textContent = `General Ledger: ${formatDisplay(startDate)} to ${formatDisplay(endDate)}`;
    
    const transactions = await loadTransactions(startDate, endDate);
    
    if (transactions.length === 0) {
        resetGLReport();
        Swal.fire("Info", "No transactions found in the selected date range.", "info");
        return;
    }

    currentGLData = transactions;

    // Calculate totals
    const totalDebit = transactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    const totalCredit = transactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    const netBalance = totalCredit - totalDebit;

    totalTransactionsElem.textContent = transactions.length;
    totalDebitElem.textContent = `₹${totalDebit.toFixed(2)}`;
    totalCreditElem.textContent = `₹${totalCredit.toFixed(2)}`;
    netBalanceElem.textContent = `₹${netBalance.toFixed(2)}`;
    netBalanceElem.style.color = netBalance >= 0 ? "#2ecc71" : "#e74c3c";

    // Generate GL Table
    generateGLTable(transactions);
    
    // Generate Account Breakdown
    generateAccountBreakdown(transactions);
}

function resetGLReport() {
    totalTransactionsElem.textContent = "0";
    totalDebitElem.textContent = "₹0.00";
    totalCreditElem.textContent = "₹0.00";
    netBalanceElem.textContent = "₹0.00";
    glTableContent.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><p>No ledger data available. Generate a report to view transactions.</p></div>';
    incomeAccountsElem.innerHTML = "";
    expenseAccountsElem.innerHTML = "";
}

function generateGLTable(transactions) {
    if (transactions.length === 0) {
        glTableContent.innerHTML = '<div class="empty-state"><i class="fas fa-book-open"></i><p>No transactions found.</p></div>';
        return;
    }

    let tableHTML = `
        <table class="gl-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Transaction ID</th>
                    <th>Account</th>
                    <th>Description</th>
                    <th>Debit</th>
                    <th>Credit</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody>
    `;

    let runningBalance = 0;

    transactions.forEach((tx, index) => {
        const debit = parseFloat(tx.EXPENSE) || 0;
        const credit = parseFloat(tx.INCOME) || 0;
        runningBalance += credit - debit;

        const formattedDate = typeof tx.DATE === 'string' ? tx.DATE : 
                             (tx.DATE && tx.DATE.toDate ? tx.DATE.toDate().toLocaleDateString('en-IN') : 'N/A');

        tableHTML += `
            <tr>
                <td>${formattedDate}</td>
                <td class="transaction-id">${tx.id.substring(0, 8)}...</td>
                <td>${tx.ACCOUNT_HEADER || "Uncategorized"}</td>
                <td>${tx.NOTES || "No description"}</td>
                <td class="debit">${debit > 0 ? `₹${debit.toFixed(2)}` : '-'}</td>
                <td class="credit">${credit > 0 ? `₹${credit.toFixed(2)}` : '-'}</td>
                <td style="font-weight:600; color: ${runningBalance >= 0 ? '#2ecc71' : '#e74c3c'}">
                    ₹${runningBalance.toFixed(2)}
                </td>
            </tr>
        `;
    });

    tableHTML += `
            </tbody>
        </table>
    `;

    glTableContent.innerHTML = tableHTML;
}

function generateAccountBreakdown(transactions) {
    const incomeAccounts = {};
    const expenseAccounts = {};

    transactions.forEach(tx => {
        const account = tx.ACCOUNT_HEADER || "Uncategorized";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;

        if (income > 0) {
            incomeAccounts[account] = (incomeAccounts[account] || 0) + income;
        }
        if (expense > 0) {
            expenseAccounts[account] = (expenseAccounts[account] || 0) + expense;
        }
    });

    // Generate Income Accounts HTML
    incomeAccountsElem.innerHTML = Object.keys(incomeAccounts).length === 0 
        ? '<p class="empty-state" style="padding:20px;">No income transactions</p>'
        : Object.entries(incomeAccounts)
            .sort((a, b) => b[1] - a[1])
            .map(([account, amount]) => `
                <div class="account-item">
                    <div class="account-name">${account}</div>
                    <div class="account-balance">₹${amount.toFixed(2)}</div>
                </div>
            `).join("");

    // Generate Expense Accounts HTML
    expenseAccountsElem.innerHTML = Object.keys(expenseAccounts).length === 0 
        ? '<p class="empty-state" style="padding:20px;">No expense transactions</p>'
        : Object.entries(expenseAccounts)
            .sort((a, b) => b[1] - a[1])
            .map(([account, amount]) => `
                <div class="account-item">
                    <div class="account-name">${account}</div>
                    <div class="account-balance">₹${amount.toFixed(2)}</div>
                </div>
            `).join("");
}

// ===== Export Functions =====
function exportGLPDF() {
    if (!currentGLData || currentGLData.length === 0) {
        Swal.fire("Info", "No GL data to export.", "info");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.text("General Ledger Report", 105, 15, null, null, "center");
    doc.setFontSize(12);
    doc.text(`Generated for ${currentUser.email || "User"}`, 105, 23, null, null, "center");
    doc.text(reportPeriodDisplay.textContent, 105, 30, null, null, "center");

    // Summary
    doc.setFontSize(14);
    doc.text("Summary", 14, 45);
    doc.setFontSize(12);
    doc.text(`Total Transactions: ${totalTransactionsElem.textContent}`, 14, 53);
    doc.text(`Total Debit: ${totalDebitElem.textContent}`, 14, 60);
    doc.text(`Total Credit: ${totalCreditElem.textContent}`, 14, 67);
    doc.text(`Net Balance: ${netBalanceElem.textContent}`, 14, 74);

    // GL Table
    doc.autoTable({
        startY: 80,
        head: [["Date", "Account", "Description", "Debit", "Credit"]],
        body: currentGLData.map(tx => [
            typeof tx.DATE === 'string' ? tx.DATE : 
            (tx.DATE && tx.DATE.toDate ? tx.DATE.toDate().toLocaleDateString('en-IN') : 'N/A'),
            tx.ACCOUNT_HEADER || "",
            (tx.NOTES || "").substring(0, 40),
            parseFloat(tx.EXPENSE) || 0,
            parseFloat(tx.INCOME) || 0
        ]),
        theme: "grid",
        styles: { fontSize: 8 },
        headStyles: { fontSize: 8 }
    });

    doc.save("General_Ledger_Report.pdf");
}

function exportGLCSV() {
    if (!currentGLData || currentGLData.length === 0) {
        Swal.fire("Info", "No GL data to export.", "info");
        return;
    }

    let csv = "Date,Transaction ID,Account,Description,Debit,Credit\n";
    
    currentGLData.forEach(tx => {
        const formattedDate = typeof tx.DATE === 'string' ? tx.DATE : 
                            (tx.DATE && tx.DATE.toDate ? tx.DATE.toDate().toLocaleDateString('en-IN') : 'N/A');
        
        csv += `"${formattedDate}","${tx.id}","${tx.ACCOUNT_HEADER || ""}","${tx.NOTES || ""}",${parseFloat(tx.EXPENSE) || 0},${parseFloat(tx.INCOME) || 0}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "General_Ledger.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>