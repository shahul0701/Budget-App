<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BudgetFlow - Chat System</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;
      --secondary: #6a5acd;
      --success: #16a34a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #06b6d4;
      --dark: #1f2937;
      --light: #f4f6f9;
      --text: #333;
      --text-light: #6b7280;
      --card-bg: #fff;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      --card-border: 1px solid #e5e7eb;
    }

    [data-theme="dark"] {
      --primary: #6366f1;
      --secondary: #818cf8;
      --success: #22c55e;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #22d3ee;
      --dark: #1e293b;
      --light: #0f172a;
      --text: #e2e8f0;
      --card-bg: #1e293b;
      --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      --card-border: 1px solid #334155;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--card-border);
      margin-bottom: 20px;
    }

    .header h1 {
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-role {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .admin-badge {
      background: var(--success);
      color: white;
    }

    .user-badge {
      background: var(--info);
      color: white;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: var(--card-border);
    }

    /* Chat Container */
    .chat-container {
      display: flex;
      flex: 1;
      gap: 20px;
      height: 70vh;
    }

    /* Users Panel */
    .users-panel {
      width: 300px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      border: var(--card-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .users-header {
      padding: 15px;
      background: var(--primary);
      color: white;
      font-weight: bold;
    }

    .users-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .user-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-item:hover {
      background: var(--light);
    }

    [data-theme="dark"] .user-item:hover {
      background: var(--dark);
    }

    .user-item.active {
      background: var(--primary-light);
      color: white;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .user-email {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    [data-theme="dark"] .user-email {
      color: #94a3b8;
    }

    .user-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
    }

    /* Messages Panel */
    .messages-panel {
      flex: 1;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      border: var(--card-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages-header {
      padding: 15px;
      border-bottom: var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selected-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .selected-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .admin-controls {
      display: flex;
      gap: 10px;
    }

    .admin-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .broadcast-btn {
      background: var(--warning);
      color: white;
    }

    .clear-btn {
      background: var(--danger);
      color: white;
    }

    .messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 70%;
      padding: 12px 15px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
    }

    .message.sent {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      align-self: flex-start;
      background: var(--light);
      color: var(--text);
      border-bottom-left-radius: 5px;
    }

    [data-theme="dark"] .message.received {
      background: #334155;
      color: var(--text);
    }

    .message.admin {
      border-left: 3px solid var(--warning);
    }

    .message-time {
      font-size: 0.7rem;
      margin-top: 5px;
      opacity: 0.8;
      text-align: right;
    }

    .message-sender {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.8rem;
    }

    .no-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      color: var(--text-light);
    }

    .no-chat i {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    /* Message Input */
    .message-input-container {
      padding: 15px;
      border-top: var(--card-border);
      display: flex;
      gap: 10px;
    }

    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: var(--card-border);
      border-radius: 25px;
      outline: none;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      transition: all 0.2s;
    }

    .message-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }

    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .send-btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card-bg);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      border: var(--card-border);
    }
    
    .toast.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-left: 4px solid var(--success);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .chat-container {
        flex-direction: column;
        height: auto;
      }
      
      .users-panel {
        width: 100%;
        height: 200px;
      }
      
      .admin-controls {
        flex-direction: column;
        gap: 5px;
      }
      
      .admin-btn {
        padding: 6px 10px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-comments"></i> BudgetFlow Chat</h1>
      <div class="user-info">
        <div id="userRole" class="user-role user-badge">User</div>
        <button class="theme-toggle" id="themeToggle">
          <i class="fa fa-moon"></i>
        </button>
        <button id="logoutBtn" class="admin-btn clear-btn">Logout</button>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Users Panel (Visible to Admin) -->
      <div class="users-panel" id="usersPanel">
        <div class="users-header">
          <i class="fa fa-users"></i> Users
        </div>
        <div class="users-list" id="usersList">
          <!-- Users will be populated here -->
        </div>
      </div>
      
      <!-- Messages Panel -->
      <div class="messages-panel">
        <div class="messages-header">
          <div class="selected-user" id="selectedUserInfo">
            <!-- Selected user info will be shown here -->
          </div>
          <div class="admin-controls" id="adminControls">
            <!-- Admin controls will be shown here -->
          </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
          <!-- Messages will be populated here -->
          <div class="no-chat" id="noChatSelected">
            <i class="fa fa-comment-slash"></i>
            <h3>No Chat Selected</h3>
            <p>Select a user from the list to start chatting</p>
          </div>
        </div>
        
        <div class="message-input-container" id="messageInputContainer">
          <input type="text" class="message-input" id="messageInput" placeholder="Type your message..." disabled>
          <button class="send-btn" id="sendBtn" disabled>
            <i class="fa fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.firebasestorage.app",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM Elements
    const userRole = document.getElementById("userRole");
    const themeToggle = document.getElementById("themeToggle");
    const logoutBtn = document.getElementById("logoutBtn");
    const usersPanel = document.getElementById("usersPanel");
    const usersList = document.getElementById("usersList");
    const selectedUserInfo = document.getElementById("selectedUserInfo");
    const adminControls = document.getElementById("adminControls");
    const messagesContainer = document.getElementById("messagesContainer");
    const noChatSelected = document.getElementById("noChatSelected");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const toast = document.getElementById("toast");

    // Chat state variables
    let currentUser = null;
    let isAdmin = false;
    let selectedUserId = null;
    let users = [];
    let messages = [];
    let messagesListener = null;

    // Show toast notification
    function showToast(message, type = '') {
      toast.textContent = message;
      toast.className = 'toast';
      if (type) toast.classList.add(type);
      toast.classList.add('active');
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      themeToggle.innerHTML = newTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', newTheme);
    }

    // Check if user is admin
    function checkIfAdmin(email) {
      return email === 'shahulsha254@gmail.com';
    }

    // Load all users (admin only)
    async function loadUsers() {
      if (!isAdmin) return;
      
      try {
        // Get all users from Firestore
        const usersRef = db.collection('users');
        const snapshot = await usersRef.get();
        
        users = [];
        snapshot.forEach(doc => {
          if (doc.id !== currentUser.uid) { // Exclude current user
            const userData = doc.data();
            users.push({
              id: doc.id,
              name: userData.displayName || 'User',
              email: userData.email,
              createdAt: userData.createdAt
            });
          }
        });
        
        renderUsersList();
      } catch (error) {
        console.error('Error loading users:', error);
        showToast('Error loading users', 'error');
      }
    }

    // Render users list
    function renderUsersList() {
      if (!isAdmin) {
        usersPanel.style.display = 'none';
        return;
      }
      
      usersList.innerHTML = '';
      
      if (users.length === 0) {
        usersList.innerHTML = '<div class="user-item">No other users found</div>';
        return;
      }
      
      users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.dataset.userId = user.id;
        
        userItem.innerHTML = `
          <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
          <div class="user-details">
            <div class="user-name">${user.name}</div>
            <div class="user-email">${user.email}</div>
          </div>
          <div class="user-status"></div>
        `;
        
        userItem.addEventListener('click', () => selectUser(user.id));
        usersList.appendChild(userItem);
      });
    }

    // Select a user to chat with
    function selectUser(userId) {
      // Update UI
      const userItems = document.querySelectorAll('.user-item');
      userItems.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.userId === userId) {
          item.classList.add('active');
        }
      });
      
      selectedUserId = userId;
      const selectedUser = users.find(u => u.id === userId);
      
      // Update selected user info
      selectedUserInfo.innerHTML = `
        <div class="selected-avatar">${selectedUser.name.charAt(0).toUpperCase()}</div>
        <div>
          <div class="user-name">${selectedUser.name}</div>
          <div class="user-email">${selectedUser.email}</div>
        </div>
      `;
      
      // Hide no chat selected message
      noChatSelected.style.display = 'none';
      
      // Enable message input
      messageInput.disabled = false;
      sendBtn.disabled = false;
      
      // Load messages for this user
      loadMessages(userId);
    }

    // Load messages for a specific user
    function loadMessages(userId) {
      // Clear existing messages
      messagesContainer.innerHTML = '';
      messages = [];
      
      // Remove previous listener if exists
      if (messagesListener) {
        messagesListener();
      }
      
      // Determine the chat ID (for admin-user chats)
      const chatId = isAdmin ? 
        `admin_${userId}` : 
        `admin_${currentUser.uid}`;
      
      // Listen for real-time messages
      messagesListener = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const message = {
                id: change.doc.id,
                ...change.doc.data()
              };
              
              // Only add if not already in messages
              if (!messages.find(m => m.id === message.id)) {
                messages.push(message);
                renderMessage(message);
              }
            }
          });
          
          // Scroll to bottom
          scrollToBottom();
        }, error => {
          console.error('Error loading messages:', error);
          showToast('Error loading messages', 'error');
        });
    }

    // Render a message
    function renderMessage(message) {
      const messageDiv = document.createElement('div');
      const isSentByMe = message.senderId === currentUser.uid;
      
      messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'} ${message.isAdmin ? 'admin' : ''}`;
      
      // Format timestamp
      const timestamp = message.timestamp ? 
        message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
        new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        ${!isSentByMe ? `<div class="message-sender">${message.senderName || 'Unknown'}</div>` : ''}
        <div class="message-text">${message.text}</div>
        <div class="message-time">${timestamp}</div>
      `;
      
      messagesContainer.appendChild(messageDiv);
    }

    // Scroll to bottom of messages
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Send a message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !selectedUserId) return;
      
      try {
        // Determine the chat ID
        const chatId = isAdmin ? 
          `admin_${selectedUserId}` : 
          `admin_${currentUser.uid}`;
        
        // Create message object
        const message = {
          text: text,
          senderId: currentUser.uid,
          senderName: currentUser.displayName || currentUser.email.split('@')[0],
          isAdmin: isAdmin,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add message to Firestore
        await db.collection('chats')
          .doc(chatId)
          .collection('messages')
          .add(message);
        
        // Clear input
        messageInput.value = '';
        
        // Scroll to bottom
        scrollToBottom();
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error sending message', 'error');
      }
    }

    // Broadcast message to all users (admin only)
    async function broadcastMessage() {
      if (!isAdmin) return;
      
      const text = prompt('Enter broadcast message:');
      if (!text) return;
      
      try {
        showToast('Sending broadcast...', 'warning');
        
        // Send to each user
        for (const user of users) {
          const chatId = `admin_${user.id}`;
          
          const message = {
            text: `[BROADCAST] ${text}`,
            senderId: currentUser.uid,
            senderName: 'Admin',
            isAdmin: true,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('chats')
            .doc(chatId)
            .collection('messages')
            .add(message);
        }
        
        showToast('Broadcast sent successfully', 'success');
      } catch (error) {
        console.error('Error broadcasting message:', error);
        showToast('Error sending broadcast', 'error');
      }
    }

    // Clear chat with selected user
    async function clearChat() {
      if (!isAdmin || !selectedUserId) return;
      
      if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
        return;
      }
      
      try {
        const chatId = `admin_${selectedUserId}`;
        const messagesRef = db.collection('chats').doc(chatId).collection('messages');
        const snapshot = await messagesRef.get();
        
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        showToast('Chat cleared successfully', 'success');
      } catch (error) {
        console.error('Error clearing chat:', error);
        showToast('Error clearing chat', 'error');
      }
    }

    // Setup admin controls
    function setupAdminControls() {
      if (!isAdmin) {
        adminControls.style.display = 'none';
        return;
      }
      
      adminControls.innerHTML = `
        <button class="admin-btn broadcast-btn" onclick="broadcastMessage()">
          <i class="fa fa-bullhorn"></i> Broadcast
        </button>
        <button class="admin-btn clear-btn" onclick="clearChat()">
          <i class="fa fa-trash"></i> Clear Chat
        </button>
      `;
    }

    // Setup for regular users
    function setupUserChat() {
      if (isAdmin) return;
      
      // For regular users, automatically select admin chat
      selectedUserInfo.innerHTML = `
        <div class="selected-avatar">A</div>
        <div>
          <div class="user-name">Admin</div>
          <div class="user-email">shahulsha254@gmail.com</div>
        </div>
      `;
      
      // Hide no chat selected message
      noChatSelected.style.display = 'none';
      
      // Enable message input
      messageInput.disabled = false;
      sendBtn.disabled = false;
      
      // Load messages with admin
      loadMessages('admin');
    }

    // Initialize chat
    function initializeChat() {
      if (isAdmin) {
        userRole.textContent = 'Admin';
        userRole.className = 'user-role admin-badge';
        loadUsers();
        setupAdminControls();
      } else {
        userRole.textContent = 'User';
        userRole.className = 'user-role user-badge';
        setupUserChat();
      }
    }

    // Check if user is logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is signed in
        currentUser = user;
        isAdmin = checkIfAdmin(user.email);
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.documentElement.setAttribute('data-theme', savedTheme);
          themeToggle.innerHTML = savedTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
        }
        
        // Initialize chat
        initializeChat();
        
        // Ensure user exists in users collection
        db.collection('users').doc(user.uid).set({
          displayName: user.displayName || '',
          email: user.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } else {
        // User is signed out - redirect to login
        window.location.href = "index.html";
      }
    });

    // Logout function
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      }).catch((error) => {
        showToast("Logout error: " + error.message, 'error');
      });
    }

    // Event listeners
    themeToggle.addEventListener("click", toggleTheme);
    logoutBtn.addEventListener("click", logout);
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>