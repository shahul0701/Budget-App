<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart of Accounts Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Anonymous Navigation */
    .anonymous-nav {
      background: linear-gradient(90deg, #2c3e50, #4a6491);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .anonymous-nav .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .anonymous-nav .brand i {
      font-size: 24px;
      color: #4CAF50;
    }

    .anonymous-nav .nav-links {
      display: flex;
      gap: 15px;
    }

    .anonymous-nav .nav-links a {
      color: white;
      text-decoration: none;
      padding: 8px 20px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .anonymous-nav .nav-links a:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .home-btn {
      text-decoration: none;
      color: #2c3e50;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 6px;
      background: #f8f9fa;
      transition: all 0.3s;
    }

    .home-btn:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .datetime {
      font-size: 14px;
      color: #6c757d;
      background: #f8f9fa;
      padding: 5px 12px;
      border-radius: 15px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 15px;
      background: #f8f9fa;
      border-radius: 20px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 65, 108, 0.3);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      position: relative;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 700;
    }

    .page-subtitle {
      text-align: center;
      color: #6c757d;
      margin-bottom: 30px;
      font-size: 16px;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .starter-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
    }

    .starter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .export-btn {
      background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
      color: white;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .report-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%);
      color: white;
    }

    .report-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
    }

    /* COA Stats */
    .coa-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: center;
      border-left: 4px solid;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-3px);
    }

    .stat-card.asset { border-left-color: #4CAF50; }
    .stat-card.liability { border-left-color: #F44336; }
    .stat-card.equity { border-left-color: #2196F3; }
    .stat-card.income { border-left-color: #9C27B0; }
    .stat-card.expense { border-left-color: #FF9800; }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 10px 0;
    }

    .stat-label {
      color: #6c757d;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Form */
    .form-container {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
    }

    .form-title {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 250px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      background: white;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .form-hint {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .submit-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .cancel-btn:hover {
      background: #5a6268;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .accounts-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .accounts-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .accounts-table td {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .accounts-table tr:hover {
      background-color: #f8f9fa;
    }

    .account-type {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-asset { background: #d4edda; color: #155724; }
    .type-liability { background: #f8d7da; color: #721c24; }
    .type-equity { background: #cce5ff; color: #004085; }
    .type-income { background: #d1ecf1; color: #0c5460; }
    .type-expense { background: #fff3cd; color: #856404; }
    .type-cogs { background: #d6d8db; color: #383d41; }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .btn-edit {
      background: #e3f2fd;
      color: #1976d2;
    }

    .btn-edit:hover {
      background: #bbdefb;
      transform: translateY(-2px);
    }

    .btn-delete {
      background: #ffebee;
      color: #d32f2f;
    }

    .btn-delete:hover {
      background: #ffcdd2;
      transform: translateY(-2px);
    }

    .btn-view {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .btn-view:hover {
      background: #e1bee7;
      transform: translateY(-2px);
    }

    /* Setup Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 24px;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 30px;
    }

    .setup-step {
      display: none;
    }

    .setup-step.active {
      display: block;
    }

    .step-title {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .step-description {
      color: #6c757d;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .bank-input-group {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
    }

    .expense-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .expense-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .expense-item:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .expense-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-radius: 0 0 15px 15px;
      display: flex;
      justify-content: space-between;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    /* Loading & Toast */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      border-radius: 15px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      color: #333;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-success {
      border-left: 4px solid #4CAF50;
    }

    .toast-error {
      border-left: 4px solid #f44336;
    }

    .toast-warning {
      border-left: 4px solid #ff9800;
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast-success .toast-icon { color: #4CAF50; }
    .toast-error .toast-icon { color: #f44336; }
    .toast-warning .toast-icon { color: #ff9800; }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 60px;
      color: #dee2e6;
      margin-bottom: 20px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .container {
        margin: 15px;
        padding: 20px;
      }

      .form-row {
        flex-direction: column;
      }

      .form-group {
        min-width: 100%;
      }

      .quick-actions {
        flex-direction: column;
      }

      .coa-stats {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-icon {
        width: 100%;
        justify-content: center;
      }

      .anonymous-nav {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .header-left, .header-right {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

<!-- Anonymous Navigation -->
<div id="anonymousNav" class="anonymous-nav" style="display: none;">
  <div class="brand">
    <i class="fas fa-chart-line"></i>
    <div>
      <h2 style="margin: 0; font-size: 20px;">Financial Accounts Manager</h2>
      <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Track, manage, and optimize your finances</p>
    </div>
  </div>
  <div class="nav-links">
    <a href="index.html"><i class="fas fa-sign-in-alt"></i> Login</a>
    <a href="register.html"><i class="fas fa-user-plus"></i> Register</a>
    <a href="demo.html"><i class="fas fa-play-circle"></i> Demo</a>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast" style="display: none;">
  <i class="toast-icon"></i>
  <span class="toast-message"></span>
</div>

<!-- Setup Modal -->
<div id="setupModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Welcome to Financial Manager! ðŸ‘‹</h3>
      <button class="modal-close" onclick="closeSetupModal()">Ã—</button>
    </div>
    
    <!-- Step 1: Bank Accounts -->
    <div id="step1" class="setup-step active">
      <div class="modal-body">
        <h4 class="step-title">Step 1: Bank Accounts Setup</h4>
        <p class="step-description">Let's start by setting up your bank accounts. This will help you track your assets effectively.</p>
        
        <div class="form-group">
          <label>How many bank accounts do you have?</label>
          <input type="number" id="bankCount" min="0" max="10" value="1" class="form-control" style="max-width: 150px;">
          <small class="form-hint">Enter 0 if you don't have any bank accounts</small>
        </div>
        
        <div id="bankAccountsContainer" style="margin-top: 20px;">
          <!-- Bank accounts will be dynamically added here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="skipSetup()">Skip Setup</button>
        <button class="btn-primary" onclick="showStep(2)">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>
    
    <!-- Step 2: Income Sources -->
    <div id="step2" class="setup-step">
      <div class="modal-body">
        <h4 class="step-title">Step 2: Income Sources</h4>
        <p class="step-description">Where does your primary income come from? This helps us set up appropriate income accounts.</p>
        
        <div style="margin: 20px 0;">
          <div style="margin-bottom: 15px;">
            <input type="radio" id="incomeSalary" name="incomeSource" value="salary" checked>
            <label for="incomeSalary" style="margin-left: 10px; font-weight: 500;">Salary/Employment Income</label>
          </div>
          <div style="margin-bottom: 15px;">
            <input type="radio" id="incomeBusiness" name="incomeSource" value="business">
            <label for="incomeBusiness" style="margin-left: 10px; font-weight: 500;">Business/Self-Employed Income</label>
          </div>
          <div style="margin-bottom: 15px;">
            <input type="radio" id="incomeBoth" name="incomeSource" value="both">
            <label for="incomeBoth" style="margin-left: 10px; font-weight: 500;">Both Salary and Business</label>
          </div>
          <div style="margin-bottom: 15px;">
            <input type="radio" id="incomeOther" name="incomeSource" value="other">
            <label for="incomeOther" style="margin-left: 10px; font-weight: 500;">Other Income Source</label>
          </div>
          <div id="otherIncomeContainer" style="margin-top: 15px; display: none;">
            <input type="text" id="otherIncomeSource" placeholder="Please specify your income source" class="form-control">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="showStep(1)"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn-primary" onclick="showStep(3)">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>
    
    <!-- Step 3: Expenses -->
    <div id="step3" class="setup-step">
      <div class="modal-body">
        <h4 class="step-title">Step 3: Expense Categories</h4>
        <p class="step-description">Select all expense categories that apply to you. We'll create accounts for each selected category.</p>
        
        <div class="expense-grid" id="expenseChecklist">
          <!-- Expenses will be populated dynamically -->
        </div>
        
        <div style="margin-top: 20px;">
          <label>
            <input type="checkbox" id="selectAllExpenses">
            <span style="margin-left: 10px; font-weight: 500;">Select All Expenses</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="showStep(2)"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn-primary" onclick="completeSetup()">Complete Setup <i class="fas fa-check"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- Main Header -->
<div class="header" style="display: none;">
  <div class="header-left">
    <a href="home.html" class="home-btn">
      <i class="fas fa-home"></i> Home
    </a>
    <div class="datetime" id="datetime">Loading...</div>
  </div>
  <div class="header-right">
    <div class="user-info">
      <div class="user-avatar" id="userInitials">U</div>
      <span id="username">User</span>
    </div>
    <button class="logout-btn" id="logoutBtn">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- Main Content -->
<div class="container" style="display: none;">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <h1 class="page-title">Chart of Accounts Manager</h1>
  <p class="page-subtitle">Manage your financial accounts and track your business transactions</p>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="action-btn starter-btn" id="starterAccountsBtn">
      <i class="fas fa-magic"></i> Guided Setup
    </button>
    <button class="action-btn export-btn" id="exportBtn">
      <i class="fas fa-file-export"></i> Export COA
    </button>
    <button class="action-btn report-btn" id="reportBtn">
      <i class="fas fa-chart-pie"></i> View Reports
    </button>
  </div>

  <!-- COA Statistics -->
  <div class="coa-stats" id="coaStats">
    <!-- Statistics will be populated dynamically -->
  </div>

  <!-- Add/Edit Account Form -->
  <div class="form-container">
    <h3 class="form-title">
      <i class="fas fa-plus-circle"></i>
      <span id="formTitle">Add New Account</span>
    </h3>
    <form id="accountForm">
      <input type="hidden" id="accountId" />
      
      <div class="form-row">
        <div class="form-group">
          <label for="accountType">Account Type *</label>
          <select id="accountType" required>
            <option value="">Select Type</option>
            <option value="Asset">Asset (Resources owned)</option>
            <option value="Liability">Liability (Obligations owed)</option>
            <option value="Equity">Equity (Owner's interest)</option>
            <option value="Income">Income (Revenue earned)</option>
            <option value="Expense">Expense (Costs incurred)</option>
            <option value="COGS">Cost of Goods Sold</option>
          </select>
          <div id="typeError" class="form-hint" style="color: #dc3545; display: none;"></div>
        </div>
        
        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required>
            <option value="">Select Category</option>
            <option value="add-new">âž• Create New Category</option>
          </select>
          <div id="categoryError" class="form-hint" style="color: #dc3545; display: none;"></div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="accountName">Account Name *</label>
          <input type="text" id="accountName" placeholder="e.g., Chase Checking Account" required />
          <div id="nameError" class="form-hint" style="color: #dc3545; display: none;"></div>
          <small class="form-hint">Use descriptive names for easy identification</small>
        </div>
        
        <div class="form-group">
          <label for="accountCode">Account Code (Optional)</label>
          <input type="text" id="accountCode" placeholder="e.g., 1001" />
          <small class="form-hint">Numeric code for accounting systems</small>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="submit-btn" id="submitBtn">
          <i class="fas fa-save"></i> Add Account
        </button>
        <button type="button" class="cancel-btn" id="cancelEditBtn" style="display: none;">
          <i class="fas fa-times"></i> Cancel Edit
        </button>
      </div>
    </form>
  </div>

  <!-- Account Table -->
  <div class="table-container">
    <table class="accounts-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Category</th>
          <th>Account Name</th>
          <th>Code</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="accountsTable">
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <p>Loading accounts...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
    orderBy,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM Elements
  const accountTypeSelect = document.getElementById("accountType");
  const categorySelect = document.getElementById("category");
  const accountForm = document.getElementById("accountForm");
  const accountsTable = document.getElementById("accountsTable");
  const accountNameInput = document.getElementById("accountName");
  const accountCodeInput = document.getElementById("accountCode");
  const accountIdInput = document.getElementById("accountId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");
  const starterAccountsBtn = document.getElementById("starterAccountsBtn");
  const exportBtn = document.getElementById("exportBtn");
  const reportBtn = document.getElementById("reportBtn");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const anonymousNav = document.getElementById("anonymousNav");
  const mainHeader = document.querySelector('.header');
  const mainContainer = document.querySelector('.container');
  const coaStats = document.getElementById('coaStats');
  const formTitle = document.getElementById('formTitle');

  // Setup Modal Elements
  const setupModal = document.getElementById("setupModal");
  const bankCountInput = document.getElementById("bankCount");
  const bankAccountsContainer = document.getElementById("bankAccountsContainer");
  const expenseChecklist = document.getElementById("expenseChecklist");
  const selectAllExpenses = document.getElementById("selectAllExpenses");

  // Toast Elements
  const toast = document.getElementById("toast");
  const toastIcon = toast.querySelector('.toast-icon');
  const toastMessage = toast.querySelector('.toast-message');

  let currentUser = null;
  let categories = {};
  let existingAccounts = new Map(); // Store account id by type_name for duplicate checking
  let accountBalances = new Map();
  let isFirstTimeUser = false;

  // Toast notification function
  function showToast(message, type = "success") {
    toastMessage.textContent = message;
    toast.className = `toast toast-${type}`;
    toastIcon.className = `fas ${
      type === 'success' ? 'fa-check-circle' :
      type === 'error' ? 'fa-exclamation-circle' :
      'fa-exclamation-triangle'
    } toast-icon`;
    toast.style.display = 'flex';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, 4000);
  }

  // Show/hide loading overlay
  function showLoading() {
    loadingOverlay.style.display = "flex";
  }

  function hideLoading() {
    loadingOverlay.style.display = "none";
  }

  // Real-time clock
  function updateTime() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    };
    datetimeElem.textContent = now.toLocaleDateString('en-US', options);
  }
  setInterval(updateTime, 1000);
  updateTime();

  // Setup Wizard Functions
  function generateBankAccountFields(count) {
    bankAccountsContainer.innerHTML = '';
    
    for (let i = 1; i <= count; i++) {
      const div = document.createElement('div');
      div.className = 'bank-input-group';
      div.innerHTML = `
        <h4 style="margin-bottom: 10px; color: #2c3e50;">Bank Account ${i}</h4>
        <div class="form-group" style="margin-bottom: 10px;">
          <label>Bank Name *</label>
          <input type="text" class="bank-name form-control" placeholder="e.g., Chase, Bank of America" required>
        </div>
        <div class="form-group">
          <label>Account Type *</label>
          <select class="bank-type form-control">
            <option value="Checking">Checking Account</option>
            <option value="Savings">Savings Account</option>
            <option value="Business">Business Account</option>
            <option value="Credit Union">Credit Union</option>
            <option value="Other">Other</option>
          </select>
        </div>
      `;
      bankAccountsContainer.appendChild(div);
    }
    
    if (count === 0) {
      bankAccountsContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No bank accounts to add.</p>';
    }
  }

  function showStep(stepNumber) {
    if (stepNumber === 1) {
      const count = parseInt(bankCountInput.value) || 1;
      generateBankAccountFields(count);
    }
    
    if (stepNumber === 2) {
      const incomeOtherRadio = document.getElementById('incomeOther');
      const otherIncomeContainer = document.getElementById('otherIncomeContainer');
      otherIncomeContainer.style.display = incomeOtherRadio.checked ? 'block' : 'none';
    }
    
    if (stepNumber === 3) {
      loadExpenseChecklist();
    }
    
    document.querySelectorAll('.setup-step').forEach(step => {
      step.classList.remove('active');
    });
    document.getElementById(`step${stepNumber}`).classList.add('active');
  }

  function closeSetupModal() {
    setupModal.style.display = 'none';
  }

  function skipSetup() {
    closeSetupModal();
    if (isFirstTimeUser) {
      loadCategories();
      loadAccounts();
    }
    isFirstTimeUser = false;
  }

  function loadExpenseChecklist() {
    const commonExpenses = [
      'Rent/Mortgage', 'Utilities (Electricity)', 'Utilities (Water)', 'Utilities (Gas)',
      'Internet/Cable', 'Mobile Phone', 'Groceries', 'Dining Out',
      'Transportation (Fuel)', 'Transportation (Public)', 'Car Maintenance',
      'Insurance (Health)', 'Insurance (Auto)', 'Insurance (Home)', 'Healthcare',
      'Entertainment', 'Subscriptions (Streaming)', 'Subscriptions (Software)',
      'Shopping', 'Clothing', 'Education', 'Gym/Fitness', 'Childcare',
      'Pet Care', 'Gifts', 'Donations', 'Travel', 'Taxes', 'Loan Payments',
      'Credit Card Payments', 'Savings/Investments', 'Home Maintenance'
    ];
    
    expenseChecklist.innerHTML = '';
    commonExpenses.forEach(expense => {
      const div = document.createElement('div');
      div.className = 'expense-item';
      div.innerHTML = `
        <input type="checkbox" id="exp_${expense.replace(/\s+/g, '_')}" value="${expense}" checked>
        <label for="exp_${expense.replace(/\s+/g, '_')}">${expense}</label>
      `;
      expenseChecklist.appendChild(div);
    });
    
    // Select All functionality
    selectAllExpenses.addEventListener('change', function() {
      const checkboxes = expenseChecklist.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = this.checked);
    });
  }

  async function completeSetup() {
    showLoading();
    try {
      const bankCount = parseInt(bankCountInput.value) || 0;
      const addedAccounts = [];
      
      // 1. Add bank accounts (Assets)
      if (bankCount > 0) {
        const bankNames = document.querySelectorAll('.bank-name');
        const bankTypes = document.querySelectorAll('.bank-type');
        
        for (let i = 0; i < bankNames.length; i++) {
          const bankName = bankNames[i].value.trim();
          const bankType = bankTypes[i].value;
          
          if (bankName) {
            const accountName = `${bankName} ${bankType} Account`;
            const duplicateKey = `asset_${accountName.toLowerCase()}`;
            
            if (!existingAccounts.has(duplicateKey)) {
              const docRef = await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
                userId: currentUser.uid,
                type: "Asset",
                category: "Bank",
                name: accountName,
                code: `100${i + 1}`,
                createdAt: serverTimestamp(),
              });
              addedAccounts.push(accountName);
              existingAccounts.set(duplicateKey, docRef.id);
            }
          }
        }
      }
      
      // 2. Add Cash account
      const cashDuplicateKey = 'asset_cash on hand';
      if (!existingAccounts.has(cashDuplicateKey)) {
        await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: "Asset",
          category: "Cash",
          name: "Cash on Hand",
          code: "1000",
          createdAt: serverTimestamp(),
        });
        addedAccounts.push("Cash on Hand");
      }
      
      // 3. Add income account
      const incomeSource = document.querySelector('input[name="incomeSource"]:checked').value;
      let incomeAccountName = "Salary Income";
      let incomeCategory = "Salary";
      
      if (incomeSource === 'business') {
        incomeAccountName = "Business Income";
        incomeCategory = "Business";
      } else if (incomeSource === 'both') {
        incomeAccountName = "Salary & Business Income";
        incomeCategory = "Mixed";
      } else if (incomeSource === 'other') {
        const otherIncome = document.getElementById('otherIncomeSource').value.trim();
        incomeAccountName = otherIncome || "Other Income";
        incomeCategory = "Other";
      }
      
      const incomeDuplicateKey = `income_${incomeAccountName.toLowerCase()}`;
      if (!existingAccounts.has(incomeDuplicateKey)) {
        await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: "Income",
          category: incomeCategory,
          name: incomeAccountName,
          code: "4000",
          createdAt: serverTimestamp(),
        });
        addedAccounts.push(incomeAccountName);
      }
      
      // 4. Add expense accounts
      const expenseCheckboxes = expenseChecklist.querySelectorAll('input[type="checkbox"]:checked');
      let expenseCount = 0;
      
      for (const checkbox of expenseCheckboxes) {
        const expenseName = checkbox.value;
        const expenseDuplicateKey = `expense_${expenseName.toLowerCase()}`;
        
        if (!existingAccounts.has(expenseDuplicateKey)) {
          await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
            userId: currentUser.uid,
            type: "Expense",
            category: "Living Expenses",
            name: expenseName,
            code: `500${String(expenseCount + 1).padStart(2, '0')}`,
            createdAt: serverTimestamp(),
          });
          addedAccounts.push(expenseName);
          expenseCount++;
        }
      }
      
      // 5. Add equity account
      const equityDuplicateKey = 'equity_owner\'s capital';
      if (!existingAccounts.has(equityDuplicateKey)) {
        await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: "Equity",
          category: "Owner's Equity",
          name: "Owner's Capital",
          code: "3000",
          createdAt: serverTimestamp(),
        });
        addedAccounts.push("Owner's Capital");
      }
      
      closeSetupModal();
      showToast(`Setup completed! Added ${addedAccounts.length} new accounts.`, 'success');
      await loadAccounts();
      updateCOAStats();
      
    } catch (error) {
      showToast('Error during setup: ' + error.message, 'error');
      console.error(error);
    } finally {
      hideLoading();
    }
  }

  // Event Listeners for Income Source
  document.querySelectorAll('input[name="incomeSource"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const otherIncomeContainer = document.getElementById('otherIncomeContainer');
      otherIncomeContainer.style.display = this.value === 'other' ? 'block' : 'none';
    });
  });

  // Bank count change listener
  bankCountInput.addEventListener('input', function() {
    const count = parseInt(this.value) || 0;
    if (count >= 0 && count <= 10) {
      generateBankAccountFields(count);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      anonymousNav.style.display = 'none';
      mainHeader.style.display = 'flex';
      mainContainer.style.display = 'block';

      const nameToStore = user.displayName || user.email || 'User';
      localStorage.setItem("username", nameToStore);

      const storedUsername = localStorage.getItem("username");
      usernameElem.textContent = storedUsername;
      profileCircle.textContent = storedUsername.charAt(0).toUpperCase();

      // Check if this is first time user
      const accountsSnapshot = await getDocs(
        query(
          collection(db, "users", user.uid, "chartOfAccounts"),
          where("userId", "==", user.uid)
        )
      );
      
      if (accountsSnapshot.empty) {
        isFirstTimeUser = true;
        setTimeout(() => {
          setupModal.style.display = 'flex';
          showStep(1);
        }, 1000);
      } else {
        await init();
      }
    } else {
      currentUser = null;
      anonymousNav.style.display = 'flex';
      mainHeader.style.display = 'none';
      mainContainer.style.display = 'none';
    }
  });

  logoutBtn.addEventListener("click", async () => {
    if (confirm("Are you sure you want to logout?")) {
      localStorage.removeItem("username");
      await signOut(auth);
      showToast("Logged out successfully", "success");
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1000);
    }
  });

  async function loadCategories() {
    categories = {};
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">âž• Create New Category</option>';

    try {
      const catSnapshot = await getDocs(
        query(
          collection(db, "users", currentUser.uid, "categories"), 
          where("userId", "==", currentUser.uid),
          orderBy("categoryName")
        )
      );
      
      catSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!categories[data.accountType]) categories[data.accountType] = [];
        if (!categories[data.accountType].includes(data.categoryName)) {
          categories[data.accountType].push(data.categoryName);
        }
      });
    } catch (error) {
      console.error("Error loading categories:", error);
    }
  }

  starterAccountsBtn.addEventListener("click", () => {
    setupModal.style.display = 'flex';
    showStep(1);
  });

  exportBtn.addEventListener("click", async () => {
    if (!currentUser) {
      showToast("Please login to export data", "error");
      return;
    }
    
    showLoading();
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid),
        orderBy("type")
      );
      const snapshot = await getDocs(q);
      
      let csvContent = "Type,Category,Account Name,Code,Balance\n";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const balance = accountBalances.get(docSnap.id) || 0;
        csvContent += `${data.type},${data.category},${data.name},${data.code || ''},${balance}\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chart-of-accounts-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showToast("COA exported successfully!", "success");
    } catch (error) {
      showToast("Export failed: " + error.message, "error");
    } finally {
      hideLoading();
    }
  });

  reportBtn.addEventListener("click", () => {
    window.location.href = "reports.html";
  });

  function updateCategoryOptions(type) {
    const defaultCategories = {
      Asset: ["Cash", "Bank", "Accounts Receivable", "Inventory", "Fixed Assets", "Investments"],
      Liability: ["Accounts Payable", "Loans Payable", "Credit Card", "Tax Payable", "Accrued Expenses"],
      Equity: ["Owner's Equity", "Retained Earnings", "Common Stock", "Dividends"],
      Income: ["Sales", "Service Revenue", "Interest Income", "Commission", "Royalty"],
      Expense: ["Rent", "Utilities", "Supplies", "Salaries", "Travel", "Marketing", "Insurance"],
      COGS: ["Raw Materials", "Direct Labor", "Manufacturing Overhead", "Packaging"],
    };

    const typeDescriptions = {
      Asset: "Resources owned by the business that provide future economic benefits.",
      Liability: "Obligations the business owes to others.",
      Equity: "Owner's claim on the business assets after liabilities are paid.",
      Income: "Revenue earned from business operations.",
      Expense: "Costs incurred to generate revenue.",
      COGS: "Direct costs attributable to the production of goods sold."
    };

    categorySelect.innerHTML = '<option value="">Select Category</option>';
    const userCats = categories[type] || [];
    const combined = [...new Set([...defaultCategories[type] || [], ...userCats])];

    combined.sort().forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });

    const addNewOption = document.createElement("option");
    addNewOption.value = "add-new";
    addNewOption.textContent = "âž• Create New Category";
    categorySelect.appendChild(addNewOption);

    if (typeDescriptions[type]) {
      const hint = document.createElement('small');
      hint.className = 'form-hint';
      hint.textContent = typeDescriptions[type];
      hint.style.display = 'block';
      hint.style.marginTop = '5px';
      hint.style.color = '#6c757d';
      
      const existingHint = accountTypeSelect.parentNode.querySelector('.type-description');
      if (existingHint) existingHint.remove();
      
      accountTypeSelect.parentNode.appendChild(hint);
    }
  }

  accountTypeSelect.addEventListener("change", () => {
    const type = accountTypeSelect.value;
    if (type) {
      updateCategoryOptions(type);
      categorySelect.value = "";
      clearErrors();
    }
  });

  categorySelect.addEventListener("change", async () => {
    clearErrors();
    if (categorySelect.value === "add-new") {
      if (!accountTypeSelect.value) {
        showToast("Please select Account Type first.", "warning");
        categorySelect.value = "";
        return;
      }
      const newCat = prompt(`Enter new category name for "${accountTypeSelect.value}":`);
      if (newCat && newCat.trim()) {
        const trimmedCat = newCat.trim();
        
        // Check for duplicate category in this type
        if (categories[accountTypeSelect.value]?.some(c => 
          c.toLowerCase() === trimmedCat.toLowerCase())) {
          showToast("Category already exists.", "warning");
          categorySelect.value = "";
          return;
        }
        
        showLoading();
        try {
          await addDoc(collection(db, "users", currentUser.uid, "categories"), {
            userId: currentUser.uid,
            accountType: accountTypeSelect.value,
            categoryName: trimmedCat,
            createdAt: serverTimestamp(),
          });
          await loadCategories();
          updateCategoryOptions(accountTypeSelect.value);
          categorySelect.value = trimmedCat;
          showToast("Category added successfully!");
        } catch (error) {
          showToast("Failed to add category: " + error.message, "error");
          categorySelect.value = "";
        } finally {
          hideLoading();
        }
      } else {
        categorySelect.value = "";
      }
    }
  });

  function clearErrors() {
    document.getElementById("typeError").style.display = 'none';
    document.getElementById("categoryError").style.display = 'none';
    document.getElementById("nameError").style.display = 'none';
    
    accountTypeSelect.style.borderColor = '';
    categorySelect.style.borderColor = '';
    accountNameInput.style.borderColor = '';
  }

  function showError(element, message) {
    const errorDiv = document.getElementById(`${element.id}Error`);
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    element.style.borderColor = '#dc3545';
  }

  async function loadAccounts() {
    showLoading();
    accountsTable.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto;"></div>
          <p>Loading accounts...</p>
        </td>
      </tr>
    `;

    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"), 
        where("userId", "==", currentUser.uid),
        orderBy("type")
      );
      const snapshot = await getDocs(q);
      
      // Clear existing data
      existingAccounts.clear();
      accountBalances.clear();
      accountsTable.innerHTML = '';
      
      if (snapshot.empty) {
        accountsTable.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <i class="fas fa-wallet"></i>
              <h3 style="color: #6c757d; margin: 20px 0 10px 0;">No Accounts Found</h3>
              <p style="color: #adb5bd;">Click "Guided Setup" to create your first accounts!</p>
            </td>
          </tr>
        `;
        updateCOAStats();
        return;
      }
      
      // Load balances for each account
      const balancePromises = [];
      snapshot.forEach(docSnap => {
        const balancePromise = getAccountBalance(docSnap.id).then(balance => {
          accountBalances.set(docSnap.id, balance);
        });
        balancePromises.push(balancePromise);
      });
      
      await Promise.all(balancePromises);
      
      // Render accounts
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const key = `${data.type.toLowerCase()}_${data.name.toLowerCase()}`;
        existingAccounts.set(key, docSnap.id);
        addAccountRow(docSnap.id, data.type, data.category, data.name, data.code || '');
      });
      
      updateCOAStats();
      
    } catch (error) {
      console.error("Error loading accounts:", error);
      accountsTable.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">
            <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>Error loading accounts: ${error.message}</p>
          </td>
        </tr>
      `;
    } finally {
      hideLoading();
    }
  }

  async function getAccountBalance(accountId) {
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "transactions"), 
        where("accountId", "==", accountId)
      );
      const snap = await getDocs(q);
      let balance = 0;
      snap.forEach(docSnap => {
        const t = docSnap.data();
        balance += Number(t.amount || 0);
      });
      return balance;
    } catch (error) {
      console.error("Error getting balance:", error);
      return 0;
    }
  }

  function updateCOAStats() {
    const stats = {
      Asset: { count: 0, total: 0 },
      Liability: { count: 0, total: 0 },
      Equity: { count: 0, total: 0 },
      Income: { count: 0, total: 0 },
      Expense: { count: 0, total: 0 },
      COGS: { count: 0, total: 0 }
    };
    
    accountBalances.forEach((balance, accountId) => {
      const accountRow = accountsTable.querySelector(`tr[data-id="${accountId}"]`);
      if (accountRow) {
        const type = accountRow.querySelector('.account-type').textContent;
        if (stats[type]) {
          stats[type].count++;
          stats[type].total += balance;
        }
      }
    });
    
    const statCards = {
      Asset: { icon: 'fa-piggy-bank', color: '#4CAF50', label: 'Assets' },
      Liability: { icon: 'fa-credit-card', color: '#F44336', label: 'Liabilities' },
      Equity: { icon: 'fa-chart-line', color: '#2196F3', label: 'Equity' },
      Income: { icon: 'fa-money-bill-wave', color: '#9C27B0', label: 'Income' },
      Expense: { icon: 'fa-receipt', color: '#FF9800', label: 'Expenses' }
    };
    
    coaStats.innerHTML = '';
    
    Object.entries(statCards).forEach(([type, config]) => {
      const stat = stats[type];
      const card = document.createElement('div');
      card.className = `stat-card ${type.toLowerCase()}`;
      card.innerHTML = `
        <i class="fas ${config.icon}" style="font-size: 24px; color: ${config.color}; margin-bottom: 10px;"></i>
        <div class="stat-value" style="color: ${config.color};">${stat.count}</div>
        <div class="stat-label">${config.label}</div>
        <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">
          Total: $${stat.total.toFixed(2)}
        </div>
      `;
      coaStats.appendChild(card);
    });
  }

  function addAccountRow(id, type, category, name, code) {
    const balance = accountBalances.get(id) || 0;
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", id);
    tr.innerHTML = `
      <td><span class="account-type type-${type.toLowerCase()}">${type}</span></td>
      <td>${category}</td>
      <td><strong>${name}</strong></td>
      <td><code>${code || '-'}</code></td>
      <td><span class="${balance >= 0 ? 'text-success' : 'text-danger'}" style="font-weight: 600;">
        $${balance.toFixed(2)}
      </span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon btn-edit" title="Edit Account">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-view" title="View Transactions" onclick="window.location.href='transactions.html?account=${id}'">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon btn-delete" title="Delete Account">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;

    // Edit button
    tr.querySelector('.btn-edit').addEventListener('click', () => {
      startEditAccount(id, type, category, name, code);
    });

    // Delete button
    tr.querySelector('.btn-delete').addEventListener('click', async () => {
      if (confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
        showLoading();
        try {
          // Check if account has transactions
          const transactionQuery = query(
            collection(db, "users", currentUser.uid, "transactions"),
            where("accountId", "==", id)
          );
          const transactionSnapshot = await getDocs(transactionQuery);
          
          if (!transactionSnapshot.empty) {
            const shouldDelete = confirm(`This account has ${transactionSnapshot.size} transaction(s). Deleting it will remove all associated transactions. Continue?`);
            if (!shouldDelete) {
              hideLoading();
              return;
            }
          }
          
          // Delete the account
          await deleteDoc(doc(db, "users", currentUser.uid, "chartOfAccounts", id));
          
          // Also delete any associated transactions
          transactionSnapshot.forEach(async (docSnap) => {
            await deleteDoc(doc(db, "users", currentUser.uid, "transactions", docSnap.id));
          });
          
          tr.remove();
          resetForm();
          
          // Remove from existing accounts map
          const key = `${type.toLowerCase()}_${name.toLowerCase()}`;
          existingAccounts.delete(key);
          
          showToast(`Account "${name}" deleted successfully!`, "success");
          updateCOAStats();
          
        } catch (err) {
          showToast("Delete failed: " + err.message, "error");
        } finally {
          hideLoading();
        }
      }
    });

    accountsTable.appendChild(tr);
  }

  function startEditAccount(id, type, category, name, code) {
    accountIdInput.value = id;
    accountTypeSelect.value = type;
    updateCategoryOptions(type);
    categorySelect.value = category;
    accountNameInput.value = name;
    accountCodeInput.value = code || '';
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Account';
    cancelEditBtn.style.display = 'inline-block';
    formTitle.textContent = 'Edit Account';
    clearErrors();
    
    // Scroll to form
    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
  }

  function resetForm() {
    accountForm.reset();
    accountIdInput.value = '';
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Account';
    cancelEditBtn.style.display = 'none';
    formTitle.textContent = 'Add New Account';
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">âž• Create New Category</option>';
    clearErrors();
  }

  cancelEditBtn.addEventListener("click", resetForm);

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const id = accountIdInput.value.trim();
    const type = accountTypeSelect.value.trim();
    const category = categorySelect.value.trim();
    const name = accountNameInput.value.trim();
    const code = accountCodeInput.value.trim();

    // Clear previous errors
    clearErrors();

    // Validation
    let isValid = true;

    if (!type) {
      showError(accountTypeSelect, "Account type is required");
      isValid = false;
    }

    if (!category) {
      showError(categorySelect, "Category is required");
      isValid = false;
    }

    if (!name) {
      showError(accountNameInput, "Account name is required");
      isValid = false;
    }

    if (!isValid) return;

    // Check for duplicates (only for new accounts, not when editing)
    if (!id) {
      const duplicateKey = `${type.toLowerCase()}_${name.toLowerCase()}`;
      if (existingAccounts.has(duplicateKey)) {
        showToast("An account with this name already exists in this type!", "warning");
        showError(accountNameInput, "Duplicate account name");
        return;
      }
    }

    // Check for duplicate code if provided
    if (code) {
      const isDuplicateCode = Array.from(existingAccounts.entries()).some(([key, accId]) => {
        if (id && accId === id) return false; // Skip current account when editing
        const accountRow = accountsTable.querySelector(`tr[data-id="${accId}"]`);
        if (accountRow) {
          const accountCode = accountRow.querySelector('td:nth-child(4) code').textContent;
          return accountCode === code;
        }
        return false;
      });
      
      if (isDuplicateCode) {
        showToast("Account code already exists! Please use a unique code.", "warning");
        accountCodeInput.style.borderColor = '#dc3545';
        return;
      }
    }

    // Disable submit button and show loading
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    submitBtn.disabled = true;
    showLoading();

    try {
      const accountData = {
        userId: currentUser.uid,
        type,
        category,
        name,
        code: code || null,
        updatedAt: serverTimestamp(),
      };

      if (id) {
        // Update existing account
        const docRef = doc(db, "users", currentUser.uid, "chartOfAccounts", id);
        await updateDoc(docRef, accountData);
        
        // Update in table
        const tr = accountsTable.querySelector(`tr[data-id="${id}"]`);
        if (tr) {
          tr.children[0].innerHTML = `<span class="account-type type-${type.toLowerCase()}">${type}</span>`;
          tr.children[1].textContent = category;
          tr.children[2].innerHTML = `<strong>${name}</strong>`;
          tr.children[3].innerHTML = `<code>${code || '-'}</code>`;
          
          // Update existing accounts map
          const oldKey = Array.from(existingAccounts.entries()).find(([key, val]) => val === id)?.[0];
          if (oldKey) {
            existingAccounts.delete(oldKey);
          }
          const newKey = `${type.toLowerCase()}_${name.toLowerCase()}`;
          existingAccounts.set(newKey, id);
        }
        showToast("Account updated successfully!", "success");
      } else {
        // Add new account
        accountData.createdAt = serverTimestamp();
        const docRef = await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), accountData);
        
        // Add to existing accounts map
        const key = `${type.toLowerCase()}_${name.toLowerCase()}`;
        existingAccounts.set(key, docRef.id);
        
        // Add to table with initial balance of 0
        accountBalances.set(docRef.id, 0);
        addAccountRow(docRef.id, type, category, name, code);
        showToast("Account added successfully!", "success");
      }
      
      resetForm();
      updateCOAStats();
      
      // Scroll to show the new/updated account
      setTimeout(() => {
        const tableContainer = document.querySelector('.table-container');
        tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
    } catch (err) {
      console.error("Error saving account:", err);
      showToast("Operation failed: " + err.message, "error");
    } finally {
      // Restore button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      hideLoading();
    }
  });

  async function init() {
    showLoading();
    try {
      await loadCategories();
      await loadAccounts();
    } catch (error) {
      showToast("Error initializing: " + error.message, "error");
      console.error(error);
    } finally {
      hideLoading();
    }
  }

  // Real-time validation
  accountNameInput.addEventListener("input", function() {
    if (this.value.trim()) {
      document.getElementById("nameError").style.display = 'none';
      this.style.borderColor = '';
    }
  });

  accountCodeInput.addEventListener("input", function() {
    this.style.borderColor = '';
  });

  // Prevent form submission on Enter key in input fields
  accountForm.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && e.target.tagName === "INPUT") {
      e.preventDefault();
    }
  });

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    if (!auth.currentUser) {
      anonymousNav.style.display = 'flex';
    }
  });

</script>
</body>
</html>