<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ’° Complete Budget Analytics & Forecasting</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date Range Picker -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --danger-gradient: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
      --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      
      --card-bg: rgba(255, 255, 255, 0.95);
      --sidebar-bg: linear-gradient(180deg, #2c3e50 0%, #1a1a2e 100%);
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --bg-primary: #f7fafc;
      --border-color: rgba(0, 0, 0, 0.08);
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.12);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      --primary-gradient: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%);
      --secondary-gradient: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
      --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      --warning-gradient: linear-gradient(135deg, #ff5e62 0%, #ff9966 100%);
      --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      --info-gradient: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
      
      --card-bg: rgba(30, 33, 57, 0.95);
      --sidebar-bg: linear-gradient(180deg, #0f0c29 0%, #302b63 100%);
      --text-primary: #f7fafc;
      --text-secondary: #a0aec0;
      --bg-primary: #1a202c;
      --border-color: rgba(255, 255, 255, 0.08);
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      background: var(--bg-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      transition: var(--transition);
    }

    .glass-effect {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
    }

    /* Page Layout */
    .page-wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      padding: 25px 20px;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      color: white;
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(45deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-item {
      margin-bottom: 8px;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(5px);
    }

    .nav-link.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 25px;
      transition: var(--transition);
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      border-radius: var(--radius);
      background: var(--primary-gradient);
      box-shadow: var(--shadow);
      color: white;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .stat-card.income::before { background: var(--success-gradient); }
    .stat-card.expense::before { background: var(--danger-gradient); }
    .stat-card.savings::before { background: var(--info-gradient); }
    .stat-card.avg-spend::before { background: var(--warning-gradient); }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      margin-bottom: 15px;
    }

    .stat-card.income .stat-icon { background: var(--success-gradient); }
    .stat-card.expense .stat-icon { background: var(--danger-gradient); }
    .stat-card.savings .stat-icon { background: var(--info-gradient); }
    .stat-card.avg-spend .stat-icon { background: var(--warning-gradient); }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 5px;
      background: linear-gradient(45deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-trend {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .trend-up { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .trend-down { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .trend-neutral { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

    /* Controls */
    .controls-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .form-select, .form-control {
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
      border-radius: 10px;
      padding: 8px 15px;
      min-width: 180px;
    }

    .form-select:focus, .form-control:focus {
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Analysis Grid */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .analysis-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .analysis-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Expense Items */
    .expense-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .expense-item:last-child {
      border-bottom: none;
    }

    .expense-item:hover {
      background: rgba(0, 0, 0, 0.02);
      padding-left: 10px;
      padding-right: 10px;
      border-radius: 8px;
    }

    [data-theme="dark"] .expense-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .expense-category {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
    }

    /* Chart Containers */
    .chart-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      height: 400px;
      position: relative;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    /* Budget Limits */
    .limit-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #6366f1;
      transition: var(--transition);
    }

    .limit-card.over-limit {
      border-left-color: #ef4444;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
      70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .limit-progress {
      height: 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin: 10px 0;
    }

    [data-theme="dark"] .limit-progress {
      background: rgba(255, 255, 255, 0.1);
    }

    .limit-progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
      background: linear-gradient(90deg, #10b981, #34d399);
    }

    .limit-progress-bar.warning {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .limit-progress-bar.danger {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }

    /* Forecast Card */
    .forecast-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: var(--radius);
      padding: 25px;
      color: white;
      position: relative;
      overflow: hidden;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Modal */
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: none;
      box-shadow: var(--shadow-hover);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .control-group {
        flex-wrap: wrap;
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 3px;
    }

    /* Utilities */
    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .text-success { color: #10b981 !important; }
    .text-danger { color: #ef4444 !important; }
    .text-warning { color: #f59e0b !important; }
    .text-info { color: #3b82f6 !important; }

    .bg-success { background-color: #10b981 !important; }
    .bg-danger { background-color: #ef4444 !important; }
    .bg-warning { background-color: #f59e0b !important; }
    .bg-info { background-color: #3b82f6 !important; }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Sidebar -->
    <div class="sidebar glass-effect">
      <div class="sidebar-header">
        <h2><i class="fas fa-chart-pie"></i> BudgetMaster</h2>
        <p class="mt-2" style="color: rgba(255,255,255,0.6); font-size: 13px;">Complete Analytics Suite</p>
      </div>
      
      <nav class="nav flex-column">
        <div class="nav-item">
          <a href="#" class="nav-link active" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="limits">
            <i class="fas fa-tachometer-alt"></i>
            <span>Budget Limits</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="forecast">
            <i class="fas fa-crystal-ball"></i>
            <span>Forecasting</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="savings">
            <i class="fas fa-lightbulb"></i>
            <span>Savings Tips</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" id="exportBtn">
            <i class="fas fa-file-export"></i>
            <span>Export Reports</span>
          </a>
        </div>
      </nav>
      
      <div class="mt-auto pt-4">
        <button class="btn btn-sm btn-light w-100 mb-2" id="themeToggle">
          <i class="fas fa-moon me-2"></i>Toggle Theme
        </button>
        <button class="btn btn-sm btn-outline-light w-100" id="logoutBtn">
          <i class="fas fa-sign-out-alt me-2"></i>Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="main-header">
        <div>
          <h1 class="h3 mb-1">Budget Analytics Dashboard</h1>
          <p class="mb-0 opacity-75" id="dateRangeDisplay">Loading date range...</p>
        </div>
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-light btn-sm" id="refreshDataBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
          </button>
          <div class="user-avatar bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 40px; height: 40px; font-weight: 600;" id="userAvatar">
            D
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-bar">
        <div class="control-group">
          <label class="form-label mb-0">Date Range:</label>
          <select id="dateRangeSelect" class="form-select">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">This Week</option>
            <option value="last_week">Last Week</option>
            <option value="month" selected>This Month</option>
            <option value="last_month">Last Month</option>
            <option value="quarter">This Quarter</option>
            <option value="last_quarter">Last Quarter</option>
            <option value="year">This Year</option>
            <option value="last_year">Last Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="control-group" id="customRangeControls" style="display: none;">
          <input type="date" id="customStartDate" class="form-control">
          <span>to</span>
          <input type="date" id="customEndDate" class="form-control">
          <button class="btn btn-primary btn-sm" id="applyCustomRange">
            <i class="fas fa-check"></i>
          </button>
        </div>

        <div class="control-group">
          <label class="form-label mb-0">Account:</label>
          <select id="accountFilter" class="form-select">
            <option value="all">All Accounts</option>
            <option value="Checking">Checking</option>
            <option value="Savings">Savings</option>
            <option value="Credit Card">Credit Card</option>
            <option value="Investment">Investment</option>
          </select>
        </div>

        <div class="control-group">
          <label class="form-label mb-0">Type:</label>
          <select id="typeFilter" class="form-select">
            <option value="all">All Types</option>
            <option value="income">Income Only</option>
            <option value="expense">Expense Only</option>
          </select>
        </div>

        <button class="btn btn-primary" id="applyFiltersBtn">
          <i class="fas fa-filter me-1"></i> Apply Filters
        </button>
        <button class="btn btn-outline-secondary" id="resetFiltersBtn">
          <i class="fas fa-redo me-1"></i> Reset
        </button>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card income">
          <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-value" id="totalIncome">$4,850.00</div>
          <div class="stat-label">Total Income</div>
          <div class="stat-trend trend-up" id="incomeTrend">
            <i class="fas fa-arrow-up"></i> 12%
          </div>
        </div>
        
        <div class="stat-card expense">
          <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="stat-value" id="totalExpenses">$3,210.50</div>
          <div class="stat-label">Total Expenses</div>
          <div class="stat-trend trend-down" id="expenseTrend">
            <i class="fas fa-arrow-down"></i> 8%
          </div>
        </div>
        
        <div class="stat-card savings">
          <div class="stat-icon">
            <i class="fas fa-piggy-bank"></i>
          </div>
          <div class="stat-value" id="netSavings">$1,639.50</div>
          <div class="stat-label">Net Savings</div>
          <div class="stat-trend trend-neutral" id="savingsRate">
            <i class="fas fa-percentage"></i> 33.8%
          </div>
        </div>
        
        <div class="stat-card avg-spend">
          <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <div class="stat-value" id="avgDailySpend">$107.02</div>
          <div class="stat-label">Avg Daily Spend</div>
          <div class="stat-trend trend-neutral" id="spendTrend">
            <i class="fas fa-minus"></i> Stable
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row mb-4">
        <div class="col-lg-8">
          <div class="chart-container">
            <div class="chart-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>Income vs Expenses Trend
              </h5>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary active" data-period="month">Month</button>
                <button class="btn btn-outline-secondary" data-period="quarter">Quarter</button>
                <button class="btn btn-outline-secondary" data-period="year">Year</button>
              </div>
            </div>
            <canvas id="trendChart"></canvas>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="chart-container">
            <div class="chart-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-pie text-warning me-2"></i>Spending Distribution
              </h5>
              <button class="btn btn-sm btn-outline-primary" id="refreshDistribution">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Analysis Grid -->
      <div class="analysis-grid">
        <!-- Top Expenses -->
        <div class="analysis-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-fire text-danger me-2"></i>Top 5 Expenses
            </h5>
            <span class="badge bg-primary" id="expenseCount">8</span>
          </div>
          <div id="topExpensesList">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Budget Limits -->
        <div class="analysis-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-tachometer-alt text-info me-2"></i>Budget Limits
            </h5>
            <button class="btn btn-sm btn-primary" id="addLimitBtn">
              <i class="fas fa-plus"></i> Add
            </button>
          </div>
          <div id="budgetLimits">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Savings Suggestions -->
        <div class="analysis-card">
          <div class="card-header">
            <h5 class="card-title">
              <i class="fas fa-lightbulb text-warning me-2"></i>Savings Suggestions
            </h5>
            <button class="btn btn-sm btn-outline-warning" id="refreshSuggestions">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div id="savingsSuggestions">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Forecast -->
        <div class="forecast-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <div class="text-white-50 small">Next Month Forecast</div>
              <div class="h3 mb-0 text-white" id="forecastSavings">$1,742.30</div>
            </div>
            <div class="stat-trend trend-up bg-white bg-opacity-10 text-white">
              <i class="fas fa-arrow-up"></i> Projected
            </div>
          </div>
          <div class="progress mb-3" style="height: 6px; background: rgba(255,255,255,0.2);">
            <div id="forecastProgress" class="progress-bar bg-success" style="width: 85%"></div>
          </div>
          <div class="row text-white">
            <div class="col-6">
              <div class="small opacity-75">Projected Income</div>
              <div class="h6" id="forecastIncome">$4,950.00</div>
            </div>
            <div class="col-6 text-end">
              <div class="small opacity-75">Projected Expenses</div>
              <div class="h6" id="forecastExpenses">$3,207.70</div>
            </div>
          </div>
          <button class="btn btn-sm btn-light w-100 mt-3" id="runForecastBtn">
            <i class="fas fa-chart-line me-1"></i> Run Advanced Forecast
          </button>
        </div>
      </div>

      <!-- Additional Features -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="analysis-card">
            <div class="card-header">
              <h5 class="card-title">
                <i class="fas fa-bell text-danger me-2"></i>Alerts & Notifications
              </h5>
            </div>
            <div id="alertsList">
              <!-- Will be populated by JS -->
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="analysis-card">
            <div class="card-header">
              <h5 class="card-title">
                <i class="fas fa-tags text-success me-2"></i>Spending Categories
              </h5>
            </div>
            <div id="categoryBreakdown">
              <!-- Will be populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Set Limit Modal -->
  <div class="modal fade" id="limitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-tachometer-alt me-2"></i>Set Budget Limit
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Account Header</label>
              <select id="limitAccount" class="form-select" required>
                <option value="">Select Account Header</option>
                <option value="Checking">Checking</option>
                <option value="Savings">Savings</option>
                <option value="Credit Card">Credit Card</option>
                <option value="all">All Expenses</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Period</label>
              <select id="limitPeriod" class="form-select" required>
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Limit Amount ($)</label>
              <input type="number" id="limitAmount" class="form-control" placeholder="e.g., 500" min="1" step="0.01" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Alert Threshold</label>
              <div class="d-flex align-items-center gap-2">
                <input type="range" id="alertThreshold" class="form-range" min="50" max="100" step="5" value="80">
                <span class="badge bg-primary" style="min-width: 50px;" id="thresholdValue">80%</span>
              </div>
              <small class="text-muted">Get notified when usage reaches this percentage</small>
            </div>
          </div>
          
          <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            Limits will be tracked based on transactions under the selected account header.
          </div>
          
          <div class="mt-4">
            <h6>Active Limits</h6>
            <div id="activeLimitsList" class="mt-2">
              <!-- Active limits will be listed here -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveLimitBtn">
            <i class="fas fa-save me-1"></i> Save Limit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Advanced Forecast Modal -->
  <div class="modal fade" id="forecastModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-crystal-ball me-2"></i>Advanced Forecasting
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label">Forecast Period</label>
              <select id="forecastPeriod" class="form-select">
                <option value="30">Next 30 days</option>
                <option value="90">Next 90 days</option>
                <option value="180">Next 6 months</option>
                <option value="365">Next 1 year</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Method</label>
              <select id="forecastMethod" class="form-select">
                <option value="average">Historical Average</option>
                <option value="trend">Trend Analysis</option>
                <option value="weighted">Weighted Average</option>
              </select>
            </div>
          </div>
          
          <div class="forecast-results" id="forecastResults">
            <!-- Forecast results will be shown here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="saveForecastBtn">
            <i class="fas fa-download me-1"></i> Export Forecast
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

  <!-- Local Data Demo -->
  <script>
    // Global Variables
    let transactions = [];
    let filteredTransactions = [];
    let analysisData = {};
    let budgetLimits = [
      {
        id: '1',
        accountHeader: 'Credit Card',
        period: 'monthly',
        amount: 1500,
        alertThreshold: 80,
        createdAt: new Date()
      },
      {
        id: '2',
        accountHeader: 'Groceries',
        period: 'monthly',
        amount: 600,
        alertThreshold: 75,
        createdAt: new Date()
      }
    ];
    let accountHeaders = new Set(['Checking', 'Savings', 'Credit Card', 'Investment']);
    let trendChart, distributionChart;
    let currentDateRange = 'month';
    let currentFilters = {
      account: 'all',
      type: 'all',
      dateRange: 'month',
      startDate: null,
      endDate: null
    };

    // Demo Transaction Data
    const demoTransactions = [
      { id: '1', DATE: new Date(2024, 2, 15), DESCRIPTION: 'Salary Deposit', ACCOUNT_HEADER: 'Checking', INCOME: '3000.00', EXPENSE: '0', TYPE: 'income' },
      { id: '2', DATE: new Date(2024, 2, 16), DESCRIPTION: 'Rent Payment', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '1200.00', TYPE: 'expense' },
      { id: '3', DATE: new Date(2024, 2, 17), DESCRIPTION: 'Groceries - Whole Foods', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '145.50', TYPE: 'expense' },
      { id: '4', DATE: new Date(2024, 2, 18), DESCRIPTION: 'Freelance Payment', ACCOUNT_HEADER: 'Checking', INCOME: '1850.00', EXPENSE: '0', TYPE: 'income' },
      { id: '5', DATE: new Date(2024, 2, 19), DESCRIPTION: 'Amazon Purchase', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '89.99', TYPE: 'expense' },
      { id: '6', DATE: new Date(2024, 2, 20), DESCRIPTION: 'Gas Station', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '45.75', TYPE: 'expense' },
      { id: '7', DATE: new Date(2024, 2, 21), DESCRIPTION: 'Restaurant Dinner', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '78.25', TYPE: 'expense' },
      { id: '8', DATE: new Date(2024, 2, 22), DESCRIPTION: 'Netflix Subscription', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '15.99', TYPE: 'expense' },
      { id: '9', DATE: new Date(2024, 2, 23), DESCRIPTION: 'Gym Membership', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '45.00', TYPE: 'expense' },
      { id: '10', DATE: new Date(2024, 2, 24), DESCRIPTION: 'Investment Deposit', ACCOUNT_HEADER: 'Investment', INCOME: '0', EXPENSE: '500.00', TYPE: 'expense' },
      { id: '11', DATE: new Date(2024, 2, 25), DESCRIPTION: 'Phone Bill', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '85.00', TYPE: 'expense' },
      { id: '12', DATE: new Date(2024, 2, 26), DESCRIPTION: 'Shopping - Zara', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '125.50', TYPE: 'expense' },
      { id: '13', DATE: new Date(2024, 2, 27), DESCRIPTION: 'Coffee Shop', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '12.50', TYPE: 'expense' },
      { id: '14', DATE: new Date(2024, 2, 28), DESCRIPTION: 'Bonus Payment', ACCOUNT_HEADER: 'Savings', INCOME: '500.00', EXPENSE: '0', TYPE: 'income' },
      { id: '15', DATE: new Date(2024, 2, 29), DESCRIPTION: 'Utilities Payment', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '180.25', TYPE: 'expense' },
      { id: '16', DATE: new Date(2024, 3, 1), DESCRIPTION: 'Car Insurance', ACCOUNT_HEADER: 'Checking', INCOME: '0', EXPENSE: '120.00', TYPE: 'expense' },
      { id: '17', DATE: new Date(2024, 3, 2), DESCRIPTION: 'Concert Tickets', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '250.00', TYPE: 'expense' },
      { id: '18', DATE: new Date(2024, 3, 3), DESCRIPTION: 'Grocery Store', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '95.30', TYPE: 'expense' },
      { id: '19', DATE: new Date(2024, 3, 4), DESCRIPTION: 'Side Project Payment', ACCOUNT_HEADER: 'Checking', INCOME: '1200.00', EXPENSE: '0', TYPE: 'income' },
      { id: '20', DATE: new Date(2024, 3, 5), DESCRIPTION: 'Furniture Purchase', ACCOUNT_HEADER: 'Credit Card', INCOME: '0', EXPENSE: '450.00', TYPE: 'expense' }
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeData();
      initializeEventListeners();
      loadThemePreference();
    });

    // Initialize Event Listeners
    function initializeEventListeners() {
      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        window.location.href = "index.html";
      });

      // Refresh data
      document.getElementById('refreshDataBtn').addEventListener('click', refreshData);

      // Date range selector
      document.getElementById('dateRangeSelect').addEventListener('change', function() {
        if (this.value === 'custom') {
          document.getElementById('customRangeControls').style.display = 'flex';
        } else {
          document.getElementById('customRangeControls').style.display = 'none';
          currentFilters.dateRange = this.value;
          applyFilters();
        }
      });

      // Custom range apply
      document.getElementById('applyCustomRange').addEventListener('click', () => {
        const start = document.getElementById('customStartDate').value;
        const end = document.getElementById('customEndDate').value;
        if (start && end) {
          currentFilters.startDate = new Date(start);
          currentFilters.endDate = new Date(end);
          currentFilters.dateRange = 'custom';
          applyFilters();
        }
      });

      // Apply filters
      document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
      document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

      // Chart period buttons
      document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentDateRange = this.dataset.period;
          updateTrendChart();
        });
      });

      // Refresh buttons
      document.getElementById('refreshDistribution').addEventListener('click', updateDistributionChart);
      document.getElementById('refreshSuggestions').addEventListener('click', updateSavingsSuggestions);

      // Budget limits
      document.getElementById('addLimitBtn').addEventListener('click', showLimitModal);
      document.getElementById('saveLimitBtn').addEventListener('click', saveBudgetLimit);
      document.getElementById('alertThreshold').addEventListener('input', function() {
        document.getElementById('thresholdValue').textContent = `${this.value}%`;
      });

      // Forecasting
      document.getElementById('runForecastBtn').addEventListener('click', showForecastModal);
      document.getElementById('saveForecastBtn').addEventListener('click', exportForecast);

      // Export
      document.getElementById('exportBtn').addEventListener('click', exportReport);

      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.dataset.section;
          showSection(section);
        });
      });
    }

    // Initialize data
    function initializeData() {
      // Load demo transactions
      transactions = demoTransactions;
      
      // Initialize date range
      initializeDateRange();
      
      // Apply filters to show initial data
      applyFilters();
      
      // Show success
      setTimeout(() => {
        Swal.fire({
          icon: 'success',
          title: 'Demo Data Loaded!',
          text: 'Using sample data for demonstration',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });
      }, 500);
    }

    // Show section
    function showSection(section) {
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
      
      // Scroll to relevant section
      if (section === 'limits') {
        document.getElementById('budgetLimits').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Initialize date range
    function initializeDateRange() {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      currentFilters.startDate = startOfMonth;
      currentFilters.endDate = endOfMonth;
      
      // Set custom date inputs
      document.getElementById('customStartDate').value = startOfMonth.toISOString().split('T')[0];
      document.getElementById('customEndDate').value = endOfMonth.toISOString().split('T')[0];
      
      updateDateRangeDisplay();
    }

    // Update date range display
    function updateDateRangeDisplay() {
      const formatDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const display = `${formatDate(currentFilters.startDate)} - ${formatDate(currentFilters.endDate)}`;
      document.getElementById('dateRangeDisplay').textContent = display;
    }

    // Apply filters
    function applyFilters() {
      // Get filter values
      currentFilters.account = document.getElementById('accountFilter').value;
      currentFilters.type = document.getElementById('typeFilter').value;
      
      // If not custom, calculate date range
      if (currentFilters.dateRange !== 'custom') {
        calculateDateRange(currentFilters.dateRange);
      }
      
      updateDateRangeDisplay();
      filterTransactions();
    }

    // Calculate date range based on selection
    function calculateDateRange(range) {
      const now = new Date();
      let start, end;
      
      switch(range) {
        case 'today':
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
          break;
        case 'yesterday':
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
          end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'week':
          const day = now.getDay();
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
          end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
          break;
        case 'last_week':
          const lastWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
          const day2 = lastWeek.getDay();
          start = new Date(lastWeek.getFullYear(), lastWeek.getMonth(), lastWeek.getDate() - day2);
          end = new Date(lastWeek.getFullYear(), lastWeek.getMonth(), lastWeek.getDate() + (6 - day2) + 1);
          break;
        case 'month':
          start = new Date(now.getFullYear(), now.getMonth(), 1);
          end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'last_month':
          start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          end = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          start = new Date(now.getFullYear(), quarter * 3, 1);
          end = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
          break;
        case 'last_quarter':
          const lastQuarter = Math.floor(now.getMonth() / 3) - 1;
          const year = lastQuarter < 0 ? now.getFullYear() - 1 : now.getFullYear();
          const month = lastQuarter < 0 ? 9 : lastQuarter * 3;
          start = new Date(year, month, 1);
          end = new Date(year, month + 3, 0);
          break;
        case 'year':
          start = new Date(now.getFullYear(), 0, 1);
          end = new Date(now.getFullYear() + 1, 0, 0);
          break;
        case 'last_year':
          start = new Date(now.getFullYear() - 1, 0, 1);
          end = new Date(now.getFullYear(), 0, 0);
          break;
        default:
          start = new Date(now.getFullYear(), now.getMonth(), 1);
          end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      }
      
      currentFilters.startDate = start;
      currentFilters.endDate = end;
    }

    // Filter transactions
    function filterTransactions() {
      filteredTransactions = transactions.filter(transaction => {
        // Date filter
        const transDate = transaction.DATE;
        if (transDate < currentFilters.startDate || transDate > currentFilters.endDate) {
          return false;
        }
        
        // Account filter
        if (currentFilters.account !== 'all' && transaction.ACCOUNT_HEADER !== currentFilters.account) {
          return false;
        }
        
        // Type filter
        if (currentFilters.type !== 'all') {
          const income = parseFloat(transaction.INCOME) || 0;
          const expense = parseFloat(transaction.EXPENSE) || 0;
          
          if (currentFilters.type === 'income' && income <= 0) return false;
          if (currentFilters.type === 'expense' && expense <= 0) return false;
        }
        
        return true;
      });
      
      // Analyze filtered transactions
      analyzeTransactions();
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('dateRangeSelect').value = 'month';
      document.getElementById('accountFilter').value = 'all';
      document.getElementById('typeFilter').value = 'all';
      document.getElementById('customRangeControls').style.display = 'none';
      
      currentFilters = {
        account: 'all',
        type: 'all',
        dateRange: 'month',
        startDate: null,
        endDate: null
      };
      
      calculateDateRange('month');
      applyFilters();
    }

    // Analyze transactions
    function analyzeTransactions() {
      if (filteredTransactions.length === 0) {
        showNoDataState();
        return;
      }
      
      const analysis = {
        income: 0,
        expenses: 0,
        categories: {},
        dailyData: {},
        topExpenses: [],
        essentialExpenses: 0,
        discretionaryExpenses: 0,
        transactionCount: filteredTransactions.length,
        startDate: currentFilters.startDate,
        endDate: currentFilters.endDate
      };
      
      // Define categories
      const essentialCategories = ['food', 'groceries', 'rent', 'mortgage', 'utilities', 'transport', 'gas', 'health', 'medical', 'insurance'];
      const discretionaryCategories = ['entertainment', 'dining', 'restaurant', 'shopping', 'clothes', 'hobby', 'travel', 'luxury', 'gift'];
      
      // Process transactions
      filteredTransactions.forEach(transaction => {
        const income = parseFloat(transaction.INCOME) || 0;
        const expense = parseFloat(transaction.EXPENSE) || 0;
        const description = (transaction.DESCRIPTION || '').toLowerCase();
        const accountHeader = (transaction.ACCOUNT_HEADER || '').toLowerCase();
        const date = transaction.DATE;
        
        // Add to totals
        analysis.income += income;
        analysis.expenses += expense;
        
        // Process expenses
        if (expense > 0) {
          // Determine category
          let category = 'other';
          const searchText = description + ' ' + accountHeader;
          
          if (searchText.includes('food') || searchText.includes('grocer') || searchText.includes('restaurant')) {
            category = 'food';
          } else if (searchText.includes('rent') || searchText.includes('mortgage') || searchText.includes('housing')) {
            category = 'housing';
          } else if (searchText.includes('utility') || searchText.includes('electric') || searchText.includes('water')) {
            category = 'utilities';
          } else if (searchText.includes('transport') || searchText.includes('gas') || searchText.includes('car')) {
            category = 'transportation';
          } else if (searchText.includes('medical') || searchText.includes('health') || searchText.includes('doctor')) {
            category = 'health';
          } else if (searchText.includes('entertain') || searchText.includes('movie') || searchText.includes('game')) {
            category = 'entertainment';
          } else if (searchText.includes('shop') || searchText.includes('clothes') || searchText.includes('store')) {
            category = 'shopping';
          } else if (searchText.includes('travel') || searchText.includes('hotel') || searchText.includes('flight')) {
            category = 'travel';
          } else if (searchText.includes('insurance')) {
            category = 'insurance';
          } else if (searchText.includes('subscription') || searchText.includes('netflix')) {
            category = 'subscriptions';
          } else if (searchText.includes('gym')) {
            category = 'health';
          } else if (searchText.includes('investment')) {
            category = 'investment';
          }
          
          // Add to category totals
          analysis.categories[category] = (analysis.categories[category] || 0) + expense;
          
          // Categorize as essential or discretionary
          const isEssential = essentialCategories.some(cat => 
            description.includes(cat) || accountHeader.includes(cat)
          );
          const isDiscretionary = discretionaryCategories.some(cat => 
            description.includes(cat) || accountHeader.includes(cat)
          );
          
          if (isEssential) {
            analysis.essentialExpenses += expense;
          } else if (isDiscretionary) {
            analysis.discretionaryExpenses += expense;
          } else {
            if (['food', 'housing', 'utilities', 'transportation', 'health', 'insurance', 'subscriptions'].includes(category)) {
              analysis.essentialExpenses += expense;
            } else {
              analysis.discretionaryExpenses += expense;
            }
          }
          
          // Add to top expenses
          analysis.topExpenses.push({
            description: transaction.DESCRIPTION || 'Unknown expense',
            amount: expense,
            category: category,
            date: date,
            accountHeader: transaction.ACCOUNT_HEADER || 'Unknown'
          });
          
          // Daily data
          const dateKey = date.toISOString().split('T')[0];
          analysis.dailyData[dateKey] = (analysis.dailyData[dateKey] || 0) + expense;
        }
      });
      
      // Sort top expenses
      analysis.topExpenses.sort((a, b) => b.amount - a.amount);
      
      // Calculate derived metrics
      analysis.netSavings = analysis.income - analysis.expenses;
      analysis.savingsRate = analysis.income > 0 ? (analysis.netSavings / analysis.income) * 100 : 0;
      
      const daysDiff = Math.max(Math.ceil((analysis.endDate - analysis.startDate) / (1000 * 60 * 60 * 24)), 1);
      analysis.avgDailySpend = analysis.expenses / daysDiff;
      
      analysis.essentialRatio = analysis.expenses > 0 ? (analysis.essentialExpenses / analysis.expenses) * 100 : 0;
      
      analysisData = analysis;
      
      // Update UI
      updateMetrics();
      updateTrendChart();
      updateDistributionChart();
      updateTopExpenses();
      updateSavingsSuggestions();
      updateForecast();
      updateCategoryBreakdown();
      updateAlerts();
      updateBudgetLimitsDisplay();
    }

    // Update metrics
    function updateMetrics() {
      // Update main metrics
      document.getElementById('totalIncome').textContent = `$${analysisData.income.toFixed(2)}`;
      document.getElementById('totalExpenses').textContent = `$${analysisData.expenses.toFixed(2)}`;
      document.getElementById('netSavings').textContent = `$${analysisData.netSavings.toFixed(2)}`;
      document.getElementById('avgDailySpend').textContent = `$${analysisData.avgDailySpend.toFixed(2)}`;
      
      // Update expense count
      document.getElementById('expenseCount').textContent = analysisData.topExpenses.length;
      
      // Calculate trends
      const incomeTrend = analysisData.income > 0 ? 'up' : 'neutral';
      const expenseTrend = analysisData.expenses > 0 ? 'down' : 'neutral';
      const savingsTrend = analysisData.savingsRate > 20 ? 'up' : analysisData.savingsRate < 0 ? 'down' : 'neutral';
      const spendTrend = analysisData.avgDailySpend > 100 ? 'up' : analysisData.avgDailySpend < 50 ? 'down' : 'neutral';
      
      updateTrendIndicator('incomeTrend', incomeTrend, `${analysisData.income > 0 ? '12' : '0'}%`);
      updateTrendIndicator('expenseTrend', expenseTrend, `${analysisData.expenses > 0 ? '8' : '0'}%`);
      updateTrendIndicator('savingsRate', savingsTrend, `${analysisData.savingsRate.toFixed(1)}%`);
      updateTrendIndicator('spendTrend', spendTrend, 'Stable');
    }

    // Update trend indicator
    function updateTrendIndicator(elementId, trend, text) {
      const element = document.getElementById(elementId);
      const icon = trend === 'up' ? 'fa-arrow-up' : trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
      const trendClass = trend === 'up' ? 'trend-up' : trend === 'down' ? 'trend-down' : 'trend-neutral';
      
      element.className = `stat-trend ${trendClass}`;
      element.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }

    // Update trend chart
    function updateTrendChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      // Destroy existing chart
      if (trendChart) {
        trendChart.destroy();
      }
      
      // Demo data for different periods
      let labels, incomeData, expenseData;
      
      switch(currentDateRange) {
        case 'month':
          labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
          incomeData = [1500, 3000, 1200, 1850];
          expenseData = [800, 950, 1100, 850];
          break;
        case 'quarter':
          labels = ['Jan', 'Feb', 'Mar'];
          incomeData = [4500, 4800, 4850];
          expenseData = [3200, 3100, 3210];
          break;
        case 'year':
          labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          incomeData = [4500, 4800, 4850, 4900, 4950, 5000, 5100, 5200, 5300, 5400, 5500, 5600];
          expenseData = [3200, 3100, 3210, 3150, 3300, 3250, 3400, 3350, 3450, 3500, 3550, 3600];
          break;
      }
      
      // Create gradient
      const incomeGradient = ctx.createLinearGradient(0, 0, 0, 400);
      incomeGradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
      incomeGradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');
      
      const expenseGradient = ctx.createLinearGradient(0, 0, 0, 400);
      expenseGradient.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
      expenseGradient.addColorStop(1, 'rgba(239, 68, 68, 0.1)');
      
      // Create chart
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              borderColor: '#10b981',
              backgroundColor: incomeGradient,
              tension: 0.4,
              fill: true,
              borderWidth: 2
            },
            {
              label: 'Expenses',
              data: expenseData,
              borderColor: '#ef4444',
              backgroundColor: expenseGradient,
              tension: 0.4,
              fill: true,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
              }
            }
          },
          scales: {
            x: {
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') }
            },
            y: {
              beginAtZero: true,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                callback: function(value) { return '$' + value; }
              }
            }
          }
        }
      });
    }

    // Update distribution chart
    function updateDistributionChart() {
      const ctx = document.getElementById('distributionChart').getContext('2d');
      
      // Destroy existing chart
      if (distributionChart) {
        distributionChart.destroy();
      }
      
      // Prepare demo data
      const categories = {
        'Housing': 1200,
        'Food': 385.30,
        'Transportation': 45.75,
        'Entertainment': 328.25,
        'Shopping': 215.50,
        'Subscriptions': 60.99,
        'Insurance': 120.00,
        'Other': 300.00
      };
      
      const labels = Object.keys(categories);
      const data = Object.values(categories);
      
      // Colors
      const colors = [
        '#ef4444', // Red
        '#f59e0b', // Yellow
        '#10b981', // Green
        '#3b82f6', // Blue
        '#8b5cf6', // Purple
        '#ec4899', // Pink
        '#14b8a6', // Teal
        '#6b7280'  // Gray
      ];
      
      // Create chart
      distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    // Update top expenses
    function updateTopExpenses() {
      const container = document.getElementById('topExpensesList');
      const topExpenses = analysisData.topExpenses.slice(0, 5);
      
      if (topExpenses.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            No expenses found in selected period
          </div>
        `;
        return;
      }
      
      let html = '';
      topExpenses.forEach((expense, index) => {
        const date = new Date(expense.date).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric' 
        });
        
        const categoryColors = {
          'food': 'warning',
          'housing': 'info',
          'utilities': 'success',
          'transportation': 'primary',
          'health': 'danger',
          'entertainment': 'purple',
          'shopping': 'pink',
          'travel': 'teal',
          'other': 'secondary',
          'insurance': 'danger',
          'subscriptions': 'info'
        };
        
        const categoryColor = categoryColors[expense.category] || 'secondary';
        
        html += `
          <div class="expense-item">
            <div>
              <div class="fw-bold mb-1">${escapeHtml(expense.description)}</div>
              <div class="small text-muted">${date} â€¢ ${expense.accountHeader}</div>
            </div>
            <div class="text-end">
              <div class="fw-bold text-danger mb-1">$${expense.amount.toFixed(2)}</div>
              <span class="badge bg-${categoryColor} bg-opacity-10 text-${categoryColor}">
                ${expense.category}
              </span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Update budget limits display
    function updateBudgetLimitsDisplay() {
      const container = document.getElementById('budgetLimits');
      
      if (budgetLimits.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="fas fa-tachometer-alt fa-2x mb-2 opacity-50"></i>
            <p class="mb-0">No limits set</p>
            <small class="d-block mt-1">Click "Add" to create budget limits</small>
          </div>
        `;
        return;
      }
      
      let html = '';
      budgetLimits.forEach(limit => {
        const progress = calculateLimitProgress(limit);
        const percentage = (progress.current / limit.amount) * 100;
        const isOverLimit = progress.current > limit.amount;
        const isNearLimit = percentage >= limit.alertThreshold && !isOverLimit;
        
        // Progress bar class
        let progressClass = '';
        if (isOverLimit) {
          progressClass = 'danger';
        } else if (isNearLimit) {
          progressClass = 'warning';
        } else {
          progressClass = 'success';
        }
        
        // Period badge
        const periodBadges = {
          'weekly': 'primary',
          'monthly': 'success',
          'quarterly': 'info',
          'yearly': 'warning'
        };
        
        const periodBadge = periodBadges[limit.period] || 'secondary';
        const limitName = limit.accountHeader === 'all' ? 'All Expenses' : limit.accountHeader;
        
        html += `
          <div class="limit-card ${isOverLimit ? 'over-limit' : ''}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h6 class="mb-0">${limitName}</h6>
                <small class="text-muted">${limit.period.charAt(0).toUpperCase() + limit.period.slice(1)} Limit</small>
              </div>
              <span class="badge bg-${periodBadge}">${limit.period}</span>
            </div>
            <div class="limit-progress">
              <div class="limit-progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <small>$${progress.current.toFixed(2)} / $${limit.amount.toFixed(2)}</small>
              <small class="${isOverLimit ? 'text-danger' : isNearLimit ? 'text-warning' : 'text-success'}">
                ${percentage.toFixed(1)}% used
              </small>
            </div>
            ${isOverLimit ? `
              <div class="alert alert-danger py-1 mt-2 mb-0">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Over limit by $${(progress.current - limit.amount).toFixed(2)}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Also update active limits in modal
      updateActiveLimitsList();
    }

    // Calculate limit progress
    function calculateLimitProgress(limit) {
      // Simulated progress calculation
      let currentSpending = 0;
      
      // Calculate based on demo data
      filteredTransactions.forEach(transaction => {
        const expense = parseFloat(transaction.EXPENSE) || 0;
        if (expense > 0) {
          const accountHeader = transaction.ACCOUNT_HEADER || '';
          if (limit.accountHeader === 'all' || accountHeader === limit.accountHeader) {
            currentSpending += expense;
          }
        }
      });
      
      // Adjust based on limit type
      if (limit.accountHeader === 'Credit Card') {
        currentSpending = 1250.75; // Simulated value
      } else if (limit.accountHeader === 'Groceries') {
        currentSpending = 385.30; // Simulated value
      }
      
      return {
        current: currentSpending,
        limit: limit.amount,
        percentage: (currentSpending / limit.amount) * 100
      };
    }

    // Update active limits list
    function updateActiveLimitsList() {
      const container = document.getElementById('activeLimitsList');
      
      if (budgetLimits.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">No active limits</div>';
        return;
      }
      
      let html = '<div class="list-group">';
      budgetLimits.forEach(limit => {
        const progress = calculateLimitProgress(limit);
        const percentage = progress.percentage;
        const limitName = limit.accountHeader === 'all' ? 'All Expenses' : limit.accountHeader;
        
        html += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${limitName}</div>
              <small class="text-muted">${limit.period} â€¢ Alert at ${limit.alertThreshold}%</small>
            </div>
            <div>
              <span class="badge bg-${percentage > 100 ? 'danger' : percentage > 80 ? 'warning' : 'primary'} me-2">
                ${percentage.toFixed(1)}%
              </span>
              <button class="btn btn-sm btn-outline-danger delete-limit" data-id="${limit.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
      
      // Add delete event listeners
      document.querySelectorAll('.delete-limit').forEach(button => {
        button.addEventListener('click', async (e) => {
          const limitId = e.target.closest('button').dataset.id;
          deleteBudgetLimit(limitId);
        });
      });
    }

    // Show limit modal
    function showLimitModal() {
      // Reset form
      document.getElementById('limitAmount').value = '';
      document.getElementById('alertThreshold').value = 80;
      document.getElementById('thresholdValue').textContent = '80%';
      
      const limitModal = new bootstrap.Modal(document.getElementById('limitModal'));
      limitModal.show();
    }

    // Save budget limit
    function saveBudgetLimit() {
      const accountHeader = document.getElementById('limitAccount').value;
      const period = document.getElementById('limitPeriod').value;
      const amount = parseFloat(document.getElementById('limitAmount').value);
      const alertThreshold = parseInt(document.getElementById('alertThreshold').value);
      
      // Validation
      if (!accountHeader) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Header',
          text: 'Please select an account header for this limit'
        });
        return;
      }
      
      if (!amount || amount <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Amount',
          text: 'Please enter a valid limit amount greater than 0'
        });
        return;
      }
      
      const newLimit = {
        id: Date.now().toString(),
        accountHeader: accountHeader,
        period: period,
        amount: amount,
        alertThreshold: alertThreshold,
        createdAt: new Date()
      };
      
      budgetLimits.push(newLimit);
      
      const limitModal = bootstrap.Modal.getInstance(document.getElementById('limitModal'));
      limitModal.hide();
      
      updateBudgetLimitsDisplay();
      
      Swal.fire({
        icon: 'success',
        title: 'Limit Saved!',
        text: `Budget limit set for ${accountHeader === 'all' ? 'All Expenses' : accountHeader}`,
        timer: 2000,
        showConfirmButton: false
      });
    }

    // Delete budget limit
    function deleteBudgetLimit(limitId) {
      Swal.fire({
        title: 'Delete Limit?',
        text: 'Are you sure you want to delete this budget limit?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          budgetLimits = budgetLimits.filter(limit => limit.id !== limitId);
          updateBudgetLimitsDisplay();
          
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Budget limit has been deleted',
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
    }

    // Update savings suggestions
    function updateSavingsSuggestions() {
      const container = document.getElementById('savingsSuggestions');
      
      if (analysisData.topExpenses.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Add transactions to get personalized savings suggestions
          </div>
        `;
        return;
      }
      
      const suggestions = generateSavingsSuggestions();
      
      let html = '';
      suggestions.forEach(suggestion => {
        html += `
          <div class="alert alert-${suggestion.type} mb-2">
            <div class="d-flex align-items-start">
              <i class="fas fa-${suggestion.icon} mt-1 me-2"></i>
              <div>
                <strong>${suggestion.title}</strong><br>
                <small>${suggestion.message}</small>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Generate savings suggestions
    function generateSavingsSuggestions() {
      const suggestions = [];
      
      // Check for high discretionary spending
      if (analysisData.discretionaryExpenses > analysisData.essentialExpenses * 0.5) {
        suggestions.push({
          title: 'Reduce Discretionary Spending',
          message: `You're spending $${analysisData.discretionaryExpenses.toFixed(2)} on non-essentials. Consider cutting back on entertainment and shopping.`,
          type: 'warning',
          icon: 'utensils'
        });
      }
      
      // Check for high food spending
      const foodSpending = analysisData.categories.food || 0;
      if (foodSpending > 400) {
        suggestions.push({
          title: 'Food Spending Alert',
          message: `You spent $${foodSpending.toFixed(2)} on food this month. Try meal planning to save money.`,
          type: 'danger',
          icon: 'shopping-basket'
        });
      }
      
      // Check for subscription creep
      const subscriptions = analysisData.categories.subscriptions || 0;
      if (subscriptions > 50) {
        suggestions.push({
          title: 'Review Subscriptions',
          message: `You have $${subscriptions.toFixed(2)} in subscriptions. Cancel unused services.`,
          type: 'info',
          icon: 'credit-card'
        });
      }
      
      // Positive reinforcement
      if (analysisData.savingsRate >= 30) {
        suggestions.push({
          title: 'Great Savings Rate!',
          message: `Your savings rate of ${analysisData.savingsRate.toFixed(1)}% is excellent! Keep it up.`,
          type: 'success',
          icon: 'trophy'
        });
      }
      
      // Check for impulse purchases
      const impulsePurchases = analysisData.topExpenses.filter(e => 
        e.description.includes('Amazon') || 
        e.description.includes('Shopping') || 
        e.category === 'shopping'
      );
      if (impulsePurchases.length > 2) {
        suggestions.push({
          title: 'Impulse Purchases Detected',
          message: `You have ${impulsePurchases.length} impulse purchases. Try a 24-hour rule before buying.`,
          type: 'warning',
          icon: 'bolt'
        });
      }
      
      // Default suggestion if none
      if (suggestions.length === 0) {
        suggestions.push({
          title: 'Track Your Spending',
          message: 'Continue tracking expenses to identify savings opportunities.',
          type: 'info',
          icon: 'chart-bar'
        });
      }
      
      return suggestions.slice(0, 3);
    }

    // Update forecast
    function updateForecast() {
      // Calculate simple forecast based on current data
      const forecastIncome = analysisData.income * 1.02;
      const forecastExpenses = analysisData.expenses * 0.99;
      const forecastSavings = forecastIncome - forecastExpenses;
      const forecastSavingsRate = forecastIncome > 0 ? (forecastSavings / forecastIncome) * 100 : 0;
      
      // Update display
      document.getElementById('forecastIncome').textContent = `$${forecastIncome.toFixed(2)}`;
      document.getElementById('forecastExpenses').textContent = `$${forecastExpenses.toFixed(2)}`;
      document.getElementById('forecastSavings').textContent = `$${forecastSavings.toFixed(2)}`;
      
      // Update progress bar
      const progress = Math.min(Math.max(forecastSavingsRate, 0), 100);
      document.getElementById('forecastProgress').style.width = `${progress}%`;
    }

    // Update category breakdown
    function updateCategoryBreakdown() {
      const container = document.getElementById('categoryBreakdown');
      
      if (Object.keys(analysisData.categories).length === 0) {
        container.innerHTML = `
          <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            No category data available
          </div>
        `;
        return;
      }
      
      const categories = Object.entries(analysisData.categories)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 6);
      
      let html = '';
      categories.forEach(([category, amount]) => {
        const percentage = analysisData.expenses > 0 ? (amount / analysisData.expenses) * 100 : 0;
        
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <span class="badge bg-primary bg-opacity-10 text-primary me-2">
                ${category.charAt(0).toUpperCase()}
              </span>
              <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
            </div>
            <div class="text-end">
              <div class="fw-bold">$${amount.toFixed(2)}</div>
              <small class="text-muted">${percentage.toFixed(1)}%</small>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Update alerts
    function updateAlerts() {
      const container = document.getElementById('alertsList');
      const alerts = [];
      
      // Check budget limits
      budgetLimits.forEach(limit => {
        const progress = calculateLimitProgress(limit);
        const percentage = (progress.current / limit.amount) * 100;
        
        if (percentage >= 100) {
          alerts.push({
            type: 'danger',
            message: `${limit.accountHeader} limit exceeded by $${(progress.current - limit.amount).toFixed(2)}`
          });
        } else if (percentage >= limit.alertThreshold) {
          alerts.push({
            type: 'warning',
            message: `${limit.accountHeader} limit at ${percentage.toFixed(1)}%`
          });
        }
      });
      
      // Check for high spending
      if (analysisData.avgDailySpend > 150) {
        alerts.push({
          type: 'warning',
          message: `High daily spending: $${analysisData.avgDailySpend.toFixed(2)}/day`
        });
      }
      
      if (alerts.length === 0) {
        container.innerHTML = `
          <div class="alert alert-success mb-0">
            <i class="fas fa-check-circle me-2"></i>
            All good! No alerts at the moment.
          </div>
        `;
        return;
      }
      
      let html = '';
      alerts.forEach(alert => {
        html += `
          <div class="alert alert-${alert.type} mb-2">
            <i class="fas fa-${alert.type === 'danger' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${alert.message}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Show forecast modal
    function showForecastModal() {
      // Generate forecast
      const forecast = generateAdvancedForecast();
      
      const container = document.getElementById('forecastResults');
      container.innerHTML = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          Forecast based on historical patterns and trends
        </div>
        
        <div class="row text-center">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Projected Income</div>
              <div class="stat-value text-success">$${forecast.income.toFixed(2)}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Projected Expenses</div>
              <div class="stat-value text-danger">$${forecast.expenses.toFixed(2)}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Projected Savings</div>
              <div class="stat-value text-info">$${forecast.savings.toFixed(2)}</div>
            </div>
          </div>
        </div>
        
        <div class="mt-4">
          <h6>Forecast Details:</h6>
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between">
              <span>Period</span>
              <span>${document.getElementById('forecastPeriod').value} days</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Method</span>
              <span>${document.getElementById('forecastMethod').value}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Savings Rate</span>
              <span class="text-success">${forecast.savingsRate.toFixed(1)}%</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Confidence Level</span>
              <span class="text-warning">85%</span>
            </li>
          </ul>
        </div>
        
        <div class="alert alert-warning mt-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          This forecast is for demonstration purposes only. Actual results may vary.
        </div>
      `;
      
      const forecastModal = new bootstrap.Modal(document.getElementById('forecastModal'));
      forecastModal.show();
    }

    // Generate advanced forecast
    function generateAdvancedForecast() {
      const period = parseInt(document.getElementById('forecastPeriod').value);
      const method = document.getElementById('forecastMethod').value;
      
      let forecastIncome, forecastExpenses;
      
      if (method === 'average') {
        forecastIncome = analysisData.income * (period / 30) * 1.02;
        forecastExpenses = analysisData.expenses * (period / 30) * 0.99;
      } else if (method === 'trend') {
        forecastIncome = analysisData.income * (period / 30) * 1.05;
        forecastExpenses = analysisData.expenses * (period / 30) * 1.01;
      } else {
        forecastIncome = analysisData.income * (period / 30) * 1.03;
        forecastExpenses = analysisData.expenses * (period / 30) * 1.00;
      }
      
      const forecastSavings = forecastIncome - forecastExpenses;
      const forecastSavingsRate = forecastIncome > 0 ? (forecastSavings / forecastIncome) * 100 : 0;
      
      return {
        income: forecastIncome,
        expenses: forecastExpenses,
        savings: forecastSavings,
        savingsRate: forecastSavingsRate
      };
    }

    // Export forecast
    function exportForecast() {
      const forecast = generateAdvancedForecast();
      
      const data = {
        title: 'Budget Forecast Report',
        generated: new Date().toISOString(),
        period: document.getElementById('forecastPeriod').value + ' days',
        method: document.getElementById('forecastMethod').value,
        forecast: forecast
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', `forecast_${new Date().toISOString().split('T')[0]}.json`);
      link.click();
      
      Swal.fire({
        icon: 'success',
        title: 'Forecast Exported!',
        text: 'Forecast data has been downloaded',
        timer: 2000,
        showConfirmButton: false
      });
    }

    // Export report
    function exportReport() {
      const report = {
        title: 'Budget Analytics Report',
        generated: new Date().toISOString(),
        dateRange: {
          from: currentFilters.startDate.toISOString(),
          to: currentFilters.endDate.toISOString()
        },
        summary: {
          totalIncome: analysisData.income,
          totalExpenses: analysisData.expenses,
          netSavings: analysisData.netSavings,
          savingsRate: analysisData.savingsRate,
          avgDailySpend: analysisData.avgDailySpend,
          transactionCount: analysisData.transactionCount
        },
        topExpenses: analysisData.topExpenses.slice(0, 10),
        categories: analysisData.categories,
        budgetLimits: budgetLimits.map(limit => ({
          accountHeader: limit.accountHeader,
          period: limit.period,
          limit: limit.amount,
          alertThreshold: limit.alertThreshold
        }))
      };
      
      const dataStr = JSON.stringify(report, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', `budget_report_${new Date().toISOString().split('T')[0]}.json`);
      link.click();
      
      Swal.fire({
        icon: 'success',
        title: 'Report Exported!',
        text: 'Budget report has been downloaded',
        timer: 2000,
        showConfirmButton: false
      });
    }

    // Show no data state
    function showNoDataState() {
      document.getElementById('topExpensesList').innerHTML = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          No transactions found for selected filters
        </div>
      `;
      
      // Reset metrics
      document.getElementById('totalIncome').textContent = '$0.00';
      document.getElementById('totalExpenses').textContent = '$0.00';
      document.getElementById('netSavings').textContent = '$0.00';
      document.getElementById('avgDailySpend').textContent = '$0.00';
    }

    // Refresh data
    function refreshData() {
      Swal.fire({
        icon: 'success',
        title: 'Data Refreshed!',
        text: 'All analytics have been updated',
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
      });
    }

    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update charts
      if (trendChart) {
        trendChart.destroy();
        updateTrendChart();
      }
      if (distributionChart) {
        distributionChart.destroy();
        updateDistributionChart();
      }
    }

    // Load theme preference
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>