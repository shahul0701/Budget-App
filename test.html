<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BudgetFlow - Modern Dashboard</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <style>
    /* AI Chat Interface Styles - Keep existing */
    .ai-chat-container {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 400px;
      height: 600px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: var(--card-border);
      z-index: 9999;
      display: none;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .ai-chat-container.active {
      display: flex;
    }
    
    .ai-chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: var(--card-border);
    }
    
    .ai-chat-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
    }
    
    .ai-chat-title i {
      font-size: 24px;
    }
    
    .close-chat {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .close-chat:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }
    
    .ai-chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: var(--card-bg);
    }
    
    .message {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.ai {
      flex-direction: row;
    }
    
    .message.user {
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }
    
    .message.ai .message-avatar {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    
    .message.user .message-avatar {
      background: var(--success);
      color: white;
    }
    
    .message-content {
      max-width: 280px;
      padding: 15px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
    }
    
    .message.ai .message-content {
      background: var(--light-dark);
      color: var(--text);
      border-top-left-radius: 4px;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-top-right-radius: 4px;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--text-light);
      margin-top: 5px;
      text-align: right;
    }
    
    .message.ai .message-time {
      text-align: left;
    }
    
    .ai-chat-input-container {
      padding: 20px;
      border-top: var(--card-border);
      background: var(--card-bg);
    }
    
    .ai-chat-input-wrapper {
      display: flex;
      gap: 10px;
    }
    
    .ai-chat-input {
      flex: 1;
      padding: 15px 20px;
      border-radius: 25px;
      border: var(--card-border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .ai-chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .ai-send-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .ai-send-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4);
    }
    
    .ai-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 10px 20px;
      background: var(--light-dark);
      border-radius: 20px;
      width: fit-content;
      margin-left: 52px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .quick-action-btn {
      padding: 10px 15px;
      background: var(--light-dark);
      border: none;
      border-radius: 12px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .quick-action-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }
    
    .ai-thinking {
      font-style: italic;
      color: var(--text-light);
      padding: 10px 0;
      text-align: center;
      font-size: 13px;
    }
    
    .web-results {
      margin-top: 15px;
      padding: 15px;
      background: rgba(var(--primary-rgb), 0.05);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
    }
    
    .web-result-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .web-result-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .web-result-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }
    
    .web-result-snippet {
      font-size: 13px;
      color: var(--text-light);
      line-height: 1.4;
    }
    
    .web-result-url {
      font-size: 11px;
      color: var(--success);
      margin-top: 3px;
      display: block;
    }
    
    .ai-suggestion {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      font-size: 13px;
    }
    
    .ai-suggestion-title {
      font-weight: 600;
      color: var(--success);
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .transaction-preview {
      background: var(--light-dark);
      border-radius: 12px;
      padding: 15px;
      margin-top: 10px;
      border: 1px dashed var(--border-dark);
    }
    
    .transaction-preview-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .transaction-preview-item:last-child {
      margin-bottom: 0;
    }
    
    .transaction-preview-label {
      color: var(--text-light);
    }
    
    .transaction-preview-value {
      font-weight: 600;
      color: var(--text);
    }
    
    .confirm-transaction-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .confirm-transaction-btn:hover {
      background: var(--success-dark);
    }
    
    .ai-fab {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .ai-fab:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
    }
    
    .ai-fab-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: inherit;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    /* ========== BUDGET FEATURE STYLES ========== */
    .budget-section {
      margin-top: 30px;
    }
    
    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .budget-actions {
      display: flex;
      gap: 10px;
    }
    
    .budget-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .budget-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--card-3d-shadow);
      border: var(--card-border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .budget-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .budget-card.warning {
      border-left: 4px solid var(--warning);
    }
    
    .budget-card.danger {
      border-left: 4px solid var(--danger);
    }
    
    .budget-card.exceeded {
      border-left: 4px solid var(--danger);
      animation: pulseWarning 2s infinite;
    }
    
    .budget-card-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .budget-card-category {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 15px;
    }
    
    .budget-progress-container {
      margin: 15px 0;
    }
    
    .budget-progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .budget-progress-bar {
      height: 8px;
      background: var(--light-dark);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .budget-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .budget-progress-fill.safe {
      background: var(--success);
    }
    
    .budget-progress-fill.warning {
      background: var(--warning);
    }
    
    .budget-progress-fill.danger {
      background: var(--danger);
    }
    
    .budget-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .budget-stat {
      text-align: center;
      padding: 10px;
      background: var(--light-dark);
      border-radius: 8px;
    }
    
    .budget-stat-label {
      font-size: 11px;
      color: var(--text-light);
      margin-bottom: 5px;
    }
    
    .budget-stat-value {
      font-weight: 700;
      font-size: 14px;
    }
    
    .budget-period-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }
    
    .budget-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .budget-edit-btn, .budget-delete-btn {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.2s;
    }
    
    .budget-edit-btn {
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }
    
    .budget-edit-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    .budget-delete-btn {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .budget-delete-btn:hover {
      background: var(--danger);
      color: white;
    }
    
    .budget-alert {
      position: fixed;
      top: 100px;
      right: 30px;
      background: var(--danger);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
      z-index: 1001;
      display: none;
      align-items: center;
      gap: 12px;
      max-width: 400px;
      animation: slideInRight 0.3s ease;
    }
    
    .budget-alert.active {
      display: flex;
    }
    
    .budget-alert.warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .budget-alert-content {
      flex: 1;
    }
    
    .budget-alert-title {
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .budget-alert-message {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .budget-alert-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: inherit;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .budget-alert-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .budget-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }
    
    .budget-empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      color: var(--primary-light);
      opacity: 0.5;
    }
    
    .budget-empty-state h3 {
      margin-bottom: 10px;
      color: var(--text);
    }
    
    .budget-empty-state p {
      margin-bottom: 20px;
    }
    
    /* Budget Modal Styles */
    .budget-modal {
      max-width: 500px;
      text-align: left;
    }
    
    .budget-period-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      background: var(--light-dark);
      padding: 5px;
      border-radius: 12px;
    }
    
    .budget-period-tab {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-light);
      transition: all 0.2s;
    }
    
    .budget-period-tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .budget-category-select {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .budget-category-option {
      padding: 10px;
      border: 2px solid var(--light-dark);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      font-size: 13px;
    }
    
    .budget-category-option:hover {
      border-color: var(--primary-light);
    }
    
    .budget-category-option.active {
      border-color: var(--primary);
      background: rgba(79, 70, 229, 0.1);
    }
    
    .budget-summary {
      background: var(--light-dark);
      padding: 15px;
      border-radius: 12px;
      margin-top: 20px;
    }
    
    .budget-summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .budget-summary-item:last-child {
      margin-bottom: 0;
    }
    
    .budget-summary-label {
      color: var(--text-light);
    }
    
    .budget-summary-value {
      font-weight: 600;
    }
    
    /* Auto Logout Modal Styles - Keep existing */
    .auto-logout-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(5px);
    }
    
    .auto-logout-modal.active {
      display: flex;
    }
    
    .auto-logout-content {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      border: var(--card-border);
      animation: pulseWarning 1.5s infinite alternate;
    }
    
    @keyframes pulseWarning {
      from {
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      }
      to {
        box-shadow: 0 25px 50px rgba(239, 68, 68, 0.4);
      }
    }
    
    .auto-logout-icon {
      font-size: 64px;
      color: var(--danger);
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    .auto-logout-content h2 {
      color: var(--danger);
      margin-bottom: 15px;
      font-size: 28px;
    }
    
    .auto-logout-content p {
      color: var(--text);
      margin-bottom: 25px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .countdown-timer {
      font-size: 48px;
      font-weight: 800;
      color: var(--danger);
      margin: 20px 0;
      font-family: monospace;
      text-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
    }
    
    .auto-logout-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .auto-logout-buttons button {
      flex: 1;
      padding: 15px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .stay-logged-in-btn {
      background: var(--success);
      color: white;
    }
    
    .stay-logged-in-btn:hover {
      background: var(--success-dark);
      transform: translateY(-2px);
    }
    
    .logout-now-btn {
      background: var(--danger);
      color: white;
    }
    
    .logout-now-btn:hover {
      background: var(--danger-dark);
      transform: translateY(-2px);
    }
    
    .session-warning {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--warning);
      color: var(--dark);
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 9998;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .session-warning.active {
      display: flex;
    }

    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;
      --secondary: #8b5cf6;
      --secondary-light: #a78bfa;
      --secondary-dark: #7c3aed;
      --success: #10b981;
      --success-light: #34d399;
      --success-dark: #059669;
      --danger: #ef4444;
      --danger-light: #f87171;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --warning-light: #fbbf24;
      --warning-dark: #d97706;
      --info: #06b6d4;
      --info-light: #22d3ee;
      --info-dark: #0891b2;
      --dark: #1e293b;
      --dark-light: #334155;
      --dark-lighter: #475569;
      --light: #f8fafc;
      --light-dark: #f1f5f9;
      --text: #1e293b;
      --text-light: #64748b;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      --card-border: 1px solid #f1f5f9;
      
      /* 3D effect variables */
      --card-depth: 10px;
      --card-3d-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 5px 10px rgba(0, 0, 0, 0.05);
      
      /* Dark mode variables */
      --bg-dark: #0f172a;
      --card-bg-dark: #1e293b;
      --text-dark: #f1f5f9;
      --text-muted-dark: #94a3b8;
      --border-dark: #334155;
    }

    /* Dark mode */
    [data-theme="dark"] {
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #22d3ee;
      --dark: #1e293b;
      --light: #0f172a;
      --text: #f1f5f9;
      --card-bg: #1e293b;
      --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      --card-border: 1px solid #334155;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Dashboard */
    .dashboard {
      display: none;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--dark);
      color: #fff;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding-top: 20px;
      z-index: 999;
      transform: translateX(-260px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar.visible {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
    }

    .sidebar-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
    }

    .sidebar-title i {
      color: var(--primary-light);
      font-size: 24px;
    }

    .sidebar-nav {
      padding: 10px 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar ul li {
      padding: 12px 20px;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 8px;
      margin: 4px 15px;
    }

    .sidebar ul li i {
      width: 20px;
      text-align: center;
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      transition: color 0.2s;
    }

    .sidebar ul li span {
      font-weight: 500;
      font-size: 14px;
    }

    .sidebar ul li:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar ul li:hover i {
      color: white;
    }

    .sidebar ul li.active {
      background: var(--primary);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .sidebar ul li.active i {
      color: white;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 20px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
    }

    .user-email {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 25px;
      box-shadow: var(--card-shadow);
      z-index: 900;
      transition: left 0.3s, background-color 0.3s;
      border-bottom: var(--card-border);
    }

    header.sidebar-visible {
      left: 260px;
    }

    #menuToggle {
      font-size: 20px;
      cursor: pointer;
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #menuToggle:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] #menuToggle:hover {
      background: var(--dark-light);
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Date and time display */
    .datetime-display {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 14px;
    }

    .current-date {
      font-weight: 600;
    }

    .current-time {
      color: var(--text-light);
      font-size: 12px;
    }

    [data-theme="dark"] .current-time {
      color: var(--text-muted-dark);
    }

    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] .theme-toggle:hover {
      background: var(--dark-light);
    }

    /* Profile */
    .profile {
      display: flex;
      align-items: center;
      position: relative;
      cursor: pointer;
    }

    .profile-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      background: var(--card-bg);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      display: none;
      min-width: 180px;
      overflow: hidden;
      z-index: 1000;
      border: var(--card-border);
    }

    .dropdown a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--text);
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .dropdown a:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] .dropdown a:hover {
      background: var(--dark-light);
    }

    .profile.active .dropdown {
      display: block;
    }

    /* Notification Bell */
    .notification-bell {
      position: relative;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .notification-bell:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] .notification-bell:hover {
      background: var(--dark-light);
    }

    .notification-bell i {
      font-size: 1.2rem;
      color: var(--text);
    }

    .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    /* Notification Panel */
    .notification-panel {
      position: absolute;
      top: 50px;
      right: 0;
      background: var(--card-bg);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      display: none;
      width: 350px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      border: var(--card-border);
    }

    .notification-panel.active {
      display: block;
    }

    .notification-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--light-dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    [data-theme="dark"] .notification-header {
      border-bottom: 1px solid var(--dark-light);
    }

    .notification-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .clear-notifications {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .clear-notifications:hover {
      text-decoration: underline;
    }

    .notification-list {
      padding: 10px 0;
    }

    .notification-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--light-dark);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    [data-theme="dark"] .notification-item {
      border-bottom: 1px solid var(--dark-light);
    }

    .notification-item:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] .notification-item:hover {
      background: var(--dark-light);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-message {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    [data-theme="dark"] .notification-message {
      color: var(--text-muted-dark);
    }

    .notification-time {
      font-size: 11px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    [data-theme="dark"] .notification-time {
      color: var(--text-muted-dark);
    }

    .notification-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .notification-icon.bill {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .notification-icon.reminder {
      background: rgba(6, 182, 212, 0.2);
      color: var(--info);
    }

    .notification-icon.birthday {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .notification-icon.meeting {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .no-notifications {
      padding: 30px 20px;
      text-align: center;
      color: var(--text-light);
      font-size: 14px;
    }

    [data-theme="dark"] .no-notifications {
      color: var(--text-muted-dark);
    }

    /* Main */
    .main {
      margin-left: 0;
      margin-top: 80px;
      padding: 25px;
      transition: margin-left 0.3s;
    }

    .main.sidebar-visible {
      margin-left: 260px;
    }

    /* Dashboard grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--card-3d-shadow);
      border: var(--card-border);
      transition: all 0.3s ease;
      transform-style: preserve-3d;
      perspective: 1000px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .card:hover {
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .card h3 {
      margin: 0 0 15px;
      font-size: 16px;
      color: var(--text-light);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h3 i {
      font-size: 18px;
    }

    [data-theme="dark"] .card h3 {
      color: var(--text-muted-dark);
    }

    .card .value {
      font-size: 32px;
      font-weight: 800;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card .balance-hidden {
      filter: blur(8px);
      user-select: none;
    }

    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      font-size: 16px;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .balance-toggle:hover {
      background: var(--light-dark);
    }

    [data-theme="dark"] .balance-toggle {
      color: var(--text-muted-dark);
    }

    [data-theme="dark"] .balance-toggle:hover {
      background: var(--dark-light);
    }

    .card.green {
      background: linear-gradient(135deg, var(--success), var(--success-dark));
      color: white;
    }

    .card.purple {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .card.dark {
      background: linear-gradient(135deg, var(--dark), var(--dark-light));
      color: white;
    }

    .card.orange {
      background: linear-gradient(135deg, var(--warning), var(--warning-dark));
      color: white;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      border: var(--card-border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .filter-btn:hover {
      background: var(--light-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .filter-btn:hover {
      background: var(--dark-light);
    }

    /* Calendar */
    #calendar {
      margin-top: 20px;
      background: var(--card-bg);
      padding: 25px;
      border-radius: 16px;
      box-shadow: var(--card-3d-shadow);
      min-height: 450px;
      border: var(--card-border);
      transition: all 0.3s ease;
    }

    #calendar:hover {
      transform: translateY(-5px);
    }

    /* Additional dashboard sections */
    .dashboard-sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      margin-top: 25px;
    }

    .dashboard-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--card-3d-shadow);
      border: var(--card-border);
      transition: all 0.3s ease;
    }

    .dashboard-section:hover {
      transform: translateY(-5px);
    }

    .dashboard-section h3 {
      margin: 0 0 20px;
      font-size: 18px;
      color: var(--text);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dashboard-section h3 i {
      color: var(--primary);
      font-size: 20px;
    }

    .section-content {
      color: var(--text-light);
      line-height: 1.6;
    }

    [data-theme="dark"] .section-content {
      color: var(--text-muted-dark);
    }

    /* Quick stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .quick-stat {
      background: var(--light-dark);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.2s;
    }

    [data-theme="dark"] .quick-stat {
      background: var(--dark-light);
    }

    .quick-stat:hover {
      transform: scale(1.05);
    }

    .quick-stat .value {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .quick-stat .label {
      font-size: 12px;
      color: var(--text-light);
      font-weight: 500;
    }

    [data-theme="dark"] .quick-stat .label {
      color: var(--text-muted-dark);
    }

    /* Floating Action Buttons */
    .fab-container {
      position: fixed;
      right: 30px;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 800;
    }

    .fab {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      background: var(--primary-dark);
      box-shadow: 0 12px 30px rgba(79, 70, 229, 0.4);
    }

    .fab-secondary {
      background: var(--info);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
    }

    .fab-secondary:hover {
      background: var(--info-dark);
      box-shadow: 0 12px 30px rgba(6, 182, 212, 0.4);
    }

    /* Popup/Modal */
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .popup.active {
      display: flex;
    }

    .popup-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
      border: var(--card-border);
      transform-style: preserve-3d;
      perspective: 1000px;
      animation: modalAppear 0.3s ease-out;
    }

    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(30px) rotateX(-15deg);
      }
      to {
        opacity: 1;
        transform: translateY(0) rotateX(0);
      }
    }

    .popup-content h2 {
      margin-bottom: 25px;
      color: var(--text);
      font-weight: 700;
      font-size: 24px;
    }

    .popup-content button {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .popup-content button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .classic-btn {
      background: var(--primary);
    }

    .compact-btn {
      background: var(--secondary);
    }

    .report-btn {
      background: var(--info);
    }

    .trial-balance-btn {
      background: var(--warning);
    }

    .close-btn {
      background: var(--danger);
    }

    /* Form elements in modals */
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      border: var(--card-border);
      transition: all 0.2s;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    /* Reminder Detail Modal */
    .reminder-detail-modal {
      max-width: 600px;
      text-align: left;
    }
    
    .reminder-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .reminder-detail-content {
      margin-bottom: 25px;
    }
    
    .reminder-detail-item {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-start;
    }
    
    .reminder-detail-label {
      font-weight: 600;
      width: 120px;
      flex-shrink: 0;
    }
    
    .reminder-detail-value {
      flex: 1;
    }
    
    .reminder-type-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    
    .reminder-type-badge.reminder {
      background: rgba(6, 182, 212, 0.2);
      color: var(--info);
    }
    
    .reminder-type-badge.bill {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }
    
    .reminder-type-badge.birthday {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }
    
    .reminder-type-badge.meeting {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .reminder-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    .reminder-actions button {
      flex: 1;
    }

    /* New Features Section */
    .new-features {
      margin-top: 25px;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .feature-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-3d-shadow);
      border: var(--card-border);
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .feature-icon {
      font-size: 32px;
      margin-bottom: 15px;
      color: var(--primary);
    }
    
    .feature-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .feature-description {
      font-size: 14px;
      color: var(--text-light);
    }

    /* Bill Reminder Specific Styles */
    .recurrence-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .recurrence-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border: 1px solid var(--light-dark);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    [data-theme="dark"] .recurrence-option {
      border: 1px solid var(--dark-light);
    }
    
    .recurrence-option:hover {
      background: var(--light-dark);
    }
    
    [data-theme="dark"] .recurrence-option:hover {
      background: var(--dark-light);
    }
    
    .recurrence-option.active {
      border-color: var(--primary);
      background: rgba(79, 70, 229, 0.1);
    }
    
    .recurrence-option input {
      margin: 0;
    }

    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      background: var(--card-bg);
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .loading-content p {
      margin-top: 20px;
      color: var(--text);
      font-weight: 600;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card-bg);
      color: var(--text);
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      border: var(--card-border);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }
    
    .toast.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-left: 4px solid var(--success);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .sidebar {
        width: 240px;
        transform: translateX(-240px);
      }
      
      header.sidebar-visible {
        left: 240px;
      }
      
      .main.sidebar-visible {
        margin-left: 240px;
      }
      
      .budget-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .sidebar.visible {
        transform: translateX(0);
        z-index: 1000;
      }

      header.sidebar-visible {
        left: 0;
      }

      .main.sidebar-visible {
        margin-left: 0;
      }
      
      .fab-container {
        right: 20px;
        bottom: 90px;
      }
      
      .fab {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
      
      .popup-content {
        max-width: 90%;
        padding: 25px;
      }
      
      .popup {
        padding: 15px;
      }

      .filters {
        flex-direction: column;
        align-items: flex-start;
      }

      .dashboard-sections {
        grid-template-columns: 1fr;
      }

      .datetime-display {
        display: none;
      }
      
      .header-title {
        font-size: 18px;
      }
      
      .reminder-actions {
        flex-direction: column;
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
      }
      
      .notification-panel {
        width: 300px;
        right: -50px;
      }
      
      .recurrence-options {
        grid-template-columns: 1fr;
      }
      
      .auto-logout-buttons {
        flex-direction: column;
      }
      
      .session-warning {
        top: 70px;
        right: 10px;
        left: 10px;
        justify-content: center;
      }
      
      .budget-grid {
        grid-template-columns: 1fr;
      }
      
      .budget-category-select {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .budget-alert {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .grid {
        gap: 20px;
      }
      
      .card {
        padding: 20px;
      }
      
      .main {
        padding: 20px;
        margin-top: 70px;
      }
      
      .fab-container {
        right: 15px;
        bottom: 85px;
      }
      
      .fab {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }

      header {
        padding: 0 20px;
        height: 65px;
      }

      .quick-stats {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        width: 280px;
        transform: translateX(-280px);
      }
      
      .notification-panel {
        width: 280px;
        right: -80px;
      }
      
      .auto-logout-content {
        padding: 30px 20px;
      }
      
      .countdown-timer {
        font-size: 36px;
      }
      
      .budget-category-select {
        grid-template-columns: 1fr;
      }
      
      .budget-period-tabs {
        flex-wrap: wrap;
      }
      
      .budget-period-tab {
        min-width: 70px;
      }
    }
  </style>
</head>
<body>
  <!-- AI Chat Interface -->
  <div class="ai-chat-container" id="aiChatContainer">
    <div class="ai-chat-header">
      <div class="ai-chat-title">
        <i class="fas fa-robot"></i>
        <span>BudgetFlow AI Assistant</span>
      </div>
      <button class="close-chat" id="closeChatBtn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="ai-chat-messages" id="aiChatMessages">
      <div class="message ai">
        <div class="message-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
          Hello! I'm your BudgetFlow AI Assistant. I can help you with:
          <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" onclick="askAI('How can I save more money?')">
               Saving Tips
            </button>
            <button class="quick-action-btn" onclick="askAI('Show me recent transactions')">
               Transactions
            </button>
            <button class="quick-action-btn" onclick="askAI('Create a budget plan')">
               Budget Planning
            </button>
            <button class="quick-action-btn" onclick="askAI('Financial advice for beginners')">
               Financial Advice
            </button>
          </div>
          <div class="message-time">Just now</div>
        </div>
      </div>
    </div>
    
    <div class="ai-chat-input-container">
      <div class="ai-chat-input-wrapper">
        <input type="text" class="ai-chat-input" id="aiChatInput" 
               placeholder="Ask me anything about your finances..." 
               onkeypress="handleChatInputKeypress(event)">
        <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div class="ai-thinking" id="aiThinking" style="display: none;">
        <div class="typing-indicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
        AI is thinking...
      </div>
    </div>
  </div>

  <!-- Budget Alert -->
  <div class="budget-alert" id="budgetAlert">
    <div class="budget-alert-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="budget-alert-content">
      <div class="budget-alert-title" id="budgetAlertTitle">Budget Limit Exceeded!</div>
      <div class="budget-alert-message" id="budgetAlertMessage"></div>
    </div>
    <button class="budget-alert-close" id="budgetAlertClose">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Auto Logout Modal -->
  <div class="auto-logout-modal" id="autoLogoutModal">
    <div class="auto-logout-content">
      <div class="auto-logout-icon">
        <i class="fas fa-clock"></i>
      </div>
      <h2>Session About to Expire</h2>
      <p>Your session will expire due to inactivity. Please click below to stay logged in.</p>
      <div class="countdown-timer" id="countdownTimer">05:00</div>
      <p>You will be automatically logged out in <span id="countdownText">5 minutes</span></p>
      <div class="auto-logout-buttons">
        <button class="stay-logged-in-btn" id="stayLoggedInBtn">
          <i class="fas fa-user-clock"></i>
          Stay Logged In
        </button>
        <button class="logout-now-btn" id="logoutNowBtn">
          <i class="fas fa-sign-out-alt"></i>
          Logout Now
        </button>
      </div>
    </div>
  </div>

  <!-- Session Warning -->
  <div class="session-warning" id="sessionWarning">
    <i class="fas fa-exclamation-triangle"></i>
    <span>You will be logged out in <span id="warningTimer">5:00</span> due to inactivity</span>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <i class="fas fa-chart-pie"></i>
          <span>BudgetFlow</span>
        </div>
      </div>
      
      <div class="sidebar-nav">
        <ul>
          <li class="active" onclick="location.href='home.html'">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </li>
          <li onclick="openExpensePopup()">
            <i class="fas fa-wallet"></i>
            <span>Transactions Tracker</span>
          </li>
          <li onclick="location.href='coa.html'">
            <i class="fas fa-book"></i>
            <span>Chart of Accounts</span>
          </li>
          <li onclick="location.href='calculate.html'">
            <i class="fas fa-calculator"></i>
            <span>Financial Calculator</span>
          </li>
          <li onclick="location.href='Debt & Credit Card Tracker.html'">
            <i class="fas fa-credit-card"></i>
            <span>Debt & Credit Card Tracker</span>
          </li>
          <li onclick="location.href='Assets Tracker.html'">
            <i class="fas fa-chart-line"></i>
            <span>Asset Tracker</span>
          </li>
          <li onclick="location.href='Section.html'">
            <i class="fas fa-file-alt"></i>
            <span>Financial Reports</span>
          </li>
          <li onclick="location.href='Genrate Invoice.html'">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Invoice Generator</span>
          </li>
          <li onclick="location.href='chart.html'">
            <i class="fas fa-chart-pie"></i>
            <span>Analytics & Charts</span>
          </li>
          <li onclick="location.href='Garage.html'">
            <i class="fas fa-car"></i>
            <span>Vehicle Management</span>
          </li>
          <li onclick="location.href='inventory-dashboard.html'">
            <i class="fas fa-table"></i>
            <span>Inventory</span>
          </li>   
          <li onclick="location.href='Appsheet.html'">
            <i class="fas fa-table"></i>
            <span>AppSheet Integration</span>
          </li>   
          <li onclick="location.href='investment.html'">
            <i class="fas fa-chart-bar"></i>
            <span>Investment Portfolio</span>
          </li>
        </ul>
      </div>
      
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userInitials">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">User Name</div>
            <div class="user-email" id="userEmail">user@example.com</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header id="header">
      <i id="menuToggle" class="fa fa-bars"></i>
      <div class="header-title">Dashboard Overview</div>
      <div class="header-controls">
        <div class="datetime-display">
          <div class="current-date" id="currentDate">Monday, January 1, 2023</div>
          <div class="current-time" id="currentTime">12:00:00 PM</div>
        </div>
        
        <!-- Notification Bell -->
        <div class="notification-bell" id="notificationBell">
          <i class="fa fa-bell"></i>
          <div class="notification-badge" id="notificationBadge">0</div>
          <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="clear-notifications" id="clearNotifications">Clear All</button>
            </div>
            <div class="notification-list" id="notificationList">
              <!-- Notifications will be populated here -->
            </div>
          </div>
        </div>
        
        <button class="theme-toggle" id="themeToggle">
          <i class="fa fa-moon"></i>
        </button>
        <div class="profile" id="profileMenu">
          <div class="profile-circle" id="headerUserInitials">U</div>
          <div class="dropdown">
            <a href="#" onclick="openProfile()">
              <i class="fa fa-user"></i> 
              Profile
            </a>
            <a href="#" onclick="logout()">
              <i class="fa fa-sign-out-alt"></i> 
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <div class="main" id="main">
      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active" data-filter="today">
          <i class="fas fa-calendar-day"></i>
          Today
        </button>
        <button class="filter-btn" data-filter="week">
          <i class="fas fa-calendar-week"></i>
          This Week
        </button>
        <button class="filter-btn" data-filter="month">
          <i class="fas fa-calendar-alt"></i>
          This Month
        </button>
        <button class="filter-btn" data-filter="year">
          <i class="fas fa-calendar"></i>
          This Year
        </button>
        <button class="filter-btn" data-filter="all">
          <i class="fas fa-infinity"></i>
          All Time
        </button>
      </div>

      <div class="grid">
        <div class="card dark">
          <h3><i class="fas fa-exchange-alt"></i> Total Transactions</h3>
          <div class="value" id="totalTransactions">0</div>
        </div>
        <div class="card green">
          <h3><i class="fas fa-piggy-bank"></i> Current Balance</h3>
          <div class="value">
            <span id="currentBalance" class="balance-hidden">$0.00</span>
            <button class="balance-toggle" id="balanceToggle">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <div class="card purple">
          <h3><i class="fas fa-arrow-down"></i> Total Income</h3>
          <div class="value" id="totalIncome">$0.00</div>
        </div>
        <div class="card orange">
          <h3><i class="fas fa-arrow-up"></i> Total Expenses</h3>
          <div class="value" id="totalExpenses">$0.00</div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="card">
        <h3><i class="fas fa-calendar-check"></i> Reminders & Events</h3>
        <div id="calendar"></div>
      </div>

      <!-- ========== BUDGET SECTION ========== -->
      <div class="dashboard-section budget-section">
        <div class="budget-header">
          <h3><i class="fas fa-chart-pie"></i> Budget Management</h3>
          <div class="budget-actions">
            <button class="filter-btn" onclick="openBudgetModal()">
              <i class="fas fa-plus"></i>
              Add Budget
            </button>
            <button class="filter-btn" onclick="refreshBudgets()">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
        </div>
        
        <div class="section-content">
          <p>Set budget limits for different categories and track your spending. You'll receive alerts when you exceed your budget.</p>
          
          <div class="budget-grid" id="budgetGrid">
            <!-- Budget cards will be loaded here -->
          </div>
          
          <div class="budget-empty-state" id="budgetEmptyState" style="display: none;">
            <i class="fas fa-chart-pie"></i>
            <h3>No Budgets Set</h3>
            <p>Create your first budget to start tracking your expenses</p>
            <button class="filter-btn" onclick="openBudgetModal()">
              <i class="fas fa-plus"></i>
              Create Budget
            </button>
          </div>
        </div>
      </div>
      <!-- ========== END BUDGET SECTION ========== -->

      <!-- Additional Dashboard Sections -->
      <div class="dashboard-sections">
        <div class="dashboard-section">
          <h3><i class="fas fa-chart-line"></i> Financial Overview</h3>
          <div class="section-content">
            <p>Track your income and expenses with detailed charts and analytics to better understand your financial health.</p>
            <div class="quick-stats">
              <div class="quick-stat">
                <div class="value">$2,540</div>
                <div class="label">Monthly Income</div>
              </div>
              <div class="quick-stat">
                <div class="value">$1,890</div>
                <div class="label">Monthly Expenses</div>
              </div>
              <div class="quick-stat">
                <div class="value">$650</div>
                <div class="label">Monthly Savings</div>
              </div>
              <div class="quick-stat">
                <div class="value">25.6%</div>
                <div class="label">Savings Rate</div>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard-section">
          <h3><i class="fas fa-bell"></i> Recent Activity</h3>
          <div class="section-content">
            <p>Your most recent transactions and activities at a glance.</p>
            <div class="quick-stats">
              <div class="quick-stat">
                <div class="value">12</div>
                <div class="label">This Week</div>
              </div>
              <div class="quick-stat">
                <div class="value">42</div>
                <div class="label">This Month</div>
              </div>
              <div class="quick-stat">
                <div class="value">5</div>
                <div class="label">Pending</div>
              </div>
              <div class="quick-stat">
                <div class="value">3</div>
                <div class="label">Upcoming</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- New Features Section -->
      <div class="dashboard-section new-features">
        <h3><i class="fas fa-rocket"></i> New Features</h3>
        <div class="section-content">
          <p>Explore these new features to enhance your financial management experience.</p>
          <div class="feature-grid">
            <div class="feature-card" onclick="openBudgetPlanner()">
              <div class="feature-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div class="feature-title">Budget Planner</div>
              <div class="feature-description">Plan and track your monthly budget with visual insights</div>
            </div>
            <div class="feature-card" onclick="openGoalTracker()">
              <div class="feature-icon">
                <i class="fas fa-bullseye"></i>
              </div>
              <div class="feature-title">Goal Tracker</div>
              <div class="feature-description">Set and monitor financial goals with progress tracking</div>
            </div>
            <div class="feature-card" onclick="openBillReminders()">
              <div class="feature-icon">
                <i class="fas fa-file-invoice-dollar"></i>
              </div>
              <div class="feature-title">Bill Reminders</div>
              <div class="feature-description">Never miss a payment with automated bill reminders</div>
            </div>
            <div class="feature-card" onclick="openFinancialInsights()">
              <div class="feature-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div class="feature-title">Financial Insights</div>
              <div class="feature-description">Get personalized insights to improve your finances</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
      <button class="fab fab-secondary" id="addReminderBtn">
        <i class="fa fa-plus"></i>
      </button>
    </div>

    <!-- AI FAB Button -->
    <button class="ai-fab" id="aiFabBtn">
      <div class="ai-fab-pulse"></div>
      <i class="fas fa-robot"></i>
    </button>

    <!-- Transaction Type Popup -->
    <div class="popup" id="transactionTypePopup">
      <div class="popup-content">
        <h2>Select Transaction View</h2>
        <button class="classic-btn" onclick="location.href='transaction-classic.html'">
          <i class="fas fa-list"></i>
          Classic View
        </button>
        <button class="compact-btn" onclick="location.href='transaction-compact.html'">
          <i class="fas fa-th"></i>
          Compact View
        </button>
        <button class="close-btn" onclick="closeTransactionTypePopup()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>

    <!-- Expense Tracker Popup -->
    <div class="popup" id="expensePopup">
      <div class="popup-content">
        <h2>Select Expense Tracker</h2>
        <button class="classic-btn" onclick="location.href='exp.html'">
          <i class="fas fa-list"></i>
          Classic View
        </button>
        <button class="compact-btn" onclick="location.href='expensemanager.html'">
          <i class="fas fa-th"></i>
          Compact View
        </button>
        <button class="close-btn" onclick="closeExpensePopup()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>

    <!-- Income/Expense Report Popup -->
    <div class="popup" id="reportPopup">
      <div class="popup-content">
        <h2>Select Report Type</h2>
        <button class="trial-balance-btn" onclick="location.href='trialbalance.html'">
          <i class="fas fa-balance-scale"></i>
          Trial Balance
        </button>
        <button class="report-btn" onclick="location.href='Section.html'">
          <i class="fas fa-file-alt"></i>
          Financial Reports
        </button>
        <button class="close-btn" onclick="closeReportPopup()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>

    <!-- Reminder Modal -->
    <div class="popup" id="reminderModal">
      <div class="popup-content">
        <h2>Add Reminder</h2>
        <div class="form-group">
          <label for="reminderType">Type</label>
          <select id="reminderType">
            <option value="reminder">Reminder</option>
            <option value="bill">Bill Payment</option>
            <option value="birthday">Birthday</option>
            <option value="meeting">Meeting</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reminderTitle">Title</label>
          <input type="text" id="reminderTitle" placeholder="Enter title">
        </div>
        <div class="form-group">
          <label for="reminderDate">Date</label>
          <input type="date" id="reminderDate">
        </div>
        <div class="form-group">
          <label for="reminderTime">Time (optional)</label>
          <input type="time" id="reminderTime">
        </div>
        
        <!-- Bill-specific fields -->
        <div class="form-group" id="billAmountGroup" style="display: none;">
          <label for="billAmount">Bill Amount</label>
          <input type="number" id="billAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group" id="recurrenceGroup" style="display: none;">
          <label>Recurrence</label>
          <div class="recurrence-options">
            <label class="recurrence-option">
              <input type="radio" name="recurrence" value="none" checked> None
            </label>
            <label class="recurrence-option">
              <input type="radio" name="recurrence" value="daily"> Daily
            </label>
            <label class="recurrence-option">
              <input type="radio" name="recurrence" value="weekly"> Weekly
            </label>
            <label class="recurrence-option">
              <input type="radio" name="recurrence" value="monthly"> Monthly
            </label>
            <label class="recurrence-option">
              <input type="radio" name="recurrence" value="yearly"> Yearly
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="reminderNotes">Notes (optional)</label>
          <textarea id="reminderNotes" rows="3" placeholder="Add notes"></textarea>
        </div>
        <button class="classic-btn" id="saveReminderBtn">
          <i class="fas fa-save"></i>
          Save Reminder
        </button>
        <button class="close-btn" onclick="closeReminderModal()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>

    <!-- Reminder Detail Modal -->
    <div class="popup" id="reminderDetailModal">
      <div class="popup-content reminder-detail-modal">
        <div class="reminder-detail-header">
          <h2>Reminder Details</h2>
        </div>
        <div class="reminder-detail-content">
          <div class="reminder-detail-item">
            <div class="reminder-detail-label">Type:</div>
            <div class="reminder-detail-value">
              <span class="reminder-type-badge" id="detailType">Reminder</span>
            </div>
          </div>
          <div class="reminder-detail-item">
            <div class="reminder-detail-label">Title:</div>
            <div class="reminder-detail-value" id="detailTitle">Title</div>
          </div>
          <div class="reminder-detail-item">
            <div class="reminder-detail-label">Date:</div>
            <div class="reminder-detail-value" id="detailDate">Date</div>
          </div>
          <div class="reminder-detail-item">
            <div class="reminder-detail-label">Time:</div>
            <div class="reminder-detail-value" id="detailTime">Time</div>
          </div>
          <div class="reminder-detail-item" id="detailBillAmountItem" style="display: none;">
            <div class="reminder-detail-label">Amount:</div>
            <div class="reminder-detail-value" id="detailBillAmount">$0.00</div>
          </div>
          <div class="reminder-detail-item" id="detailRecurrenceItem" style="display: none;">
            <div class="reminder-detail-label">Recurrence:</div>
            <div class="reminder-detail-value" id="detailRecurrence">None</div>
          </div>
          <div class="reminder-detail-item">
            <div class="reminder-detail-label">Notes:</div>
            <div class="reminder-detail-value" id="detailNotes">Notes</div>
          </div>
        </div>
        <div class="reminder-actions">
          <button class="classic-btn" id="editReminderBtn">
            <i class="fas fa-edit"></i> Edit
          </button>
          <button class="close-btn" id="deleteReminderBtn">
            <i class="fas fa-trash"></i> Delete
          </button>
          <button class="close-btn" onclick="closeReminderDetailModal()">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>

    <!-- ========== BUDGET MODAL ========== -->
    <div class="popup" id="budgetModal">
      <div class="popup-content budget-modal">
        <h2 id="budgetModalTitle">Add New Budget</h2>
        
        <div class="form-group">
          <label for="budgetCategory">Category</label>
          <input type="text" id="budgetCategory" placeholder="e.g., Groceries, Entertainment, etc.">
        </div>
        
        <div class="form-group">
          <label>Budget Period</label>
          <div class="budget-period-tabs">
            <button class="budget-period-tab active" data-period="weekly">Weekly</button>
            <button class="budget-period-tab" data-period="monthly">Monthly</button>
            <button class="budget-period-tab" data-period="quarterly">Quarterly</button>
            <button class="budget-period-tab" data-period="yearly">Yearly</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="budgetAmount">Budget Limit ($)</label>
          <input type="number" id="budgetAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-group">
          <label for="budgetStartDate">Start Date</label>
          <input type="date" id="budgetStartDate">
        </div>
        
        <div class="form-group">
          <label for="budgetNotes">Notes (optional)</label>
          <textarea id="budgetNotes" rows="3" placeholder="Add any notes about this budget"></textarea>
        </div>
        
        <div class="budget-summary">
          <div class="budget-summary-item">
            <span class="budget-summary-label">Period:</span>
            <span class="budget-summary-value" id="budgetSummaryPeriod">Weekly</span>
          </div>
          <div class="budget-summary-item">
            <span class="budget-summary-label">Limit:</span>
            <span class="budget-summary-value" id="budgetSummaryAmount">$0.00</span>
          </div>
          <div class="budget-summary-item">
            <span class="budget-summary-label">Starts:</span>
            <span class="budget-summary-value" id="budgetSummaryDate">-</span>
          </div>
        </div>
        
        <button class="classic-btn" id="saveBudgetBtn">
          <i class="fas fa-save"></i>
          Save Budget
        </button>
        <button class="close-btn" onclick="closeBudgetModal()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingText">Processing...</p>
      </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

  </div>

  <script>
    // ========== AI CHAT FEATURE ==========
    // (Keep existing AI Chat code exactly as is - no changes needed)
    
    // AI Chat Elements
    const aiChatContainer = document.getElementById('aiChatContainer');
    const aiChatMessages = document.getElementById('aiChatMessages');
    const aiChatInput = document.getElementById('aiChatInput');
    const aiSendBtn = document.getElementById('aiSendBtn');
    const aiThinking = document.getElementById('aiThinking');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const aiFabBtn = document.getElementById('aiFabBtn');
    
    // AI Chat State
    let chatHistory = [];
    let isAIThinking = false;
    
    // Initialize AI Chat
    function initAIChat() {
      const savedHistory = localStorage.getItem('budgetflow_chat_history');
      if (savedHistory) {
        chatHistory = JSON.parse(savedHistory);
        loadChatHistory();
      }
      
      if (chatHistory.length === 0) {
        addAIMessage("Hello! I'm your BudgetFlow AI Assistant. I can help you with:\n Transaction analysis\n Budget planning\n Financial advice\n Expense tracking\n Financial calculations\n\nTry asking me something like 'How can I save more money?' or 'Show me my recent transactions'.");
      }
    }
    
    // Load chat history
    function loadChatHistory() {
      aiChatMessages.innerHTML = '';
      chatHistory.forEach(msg => {
        addMessageToUI(msg.sender, msg.text, msg.timestamp, msg.html);
      });
      scrollToBottom();
    }
    
    // Add message to UI
    function addMessageToUI(sender, text, timestamp, customHtml = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      
      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = formatTime(timestamp);
      
      if (sender === 'ai') {
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        content.innerHTML = customHtml || escapeHtml(text);
      } else {
        avatar.innerHTML = '<i class="fas fa-user"></i>';
        content.textContent = text;
      }
      
      content.appendChild(time);
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      aiChatMessages.appendChild(messageDiv);
      
      scrollToBottom();
    }
    
    // Add AI message
    function addAIMessage(text, customHtml = null) {
      const timestamp = new Date().toISOString();
      addMessageToUI('ai', text, timestamp, customHtml);
      
      chatHistory.push({
        sender: 'ai',
        text: text,
        timestamp: timestamp,
        html: customHtml
      });
      
      saveChatHistory();
    }
    
    // Add user message
    function addUserMessage(text) {
      const timestamp = new Date().toISOString();
      addMessageToUI('user', text, timestamp);
      
      chatHistory.push({
        sender: 'user',
        text: text,
        timestamp: timestamp
      });
      
      saveChatHistory();
    }
    
    // Save chat history to localStorage
    function saveChatHistory() {
      if (chatHistory.length > 50) {
        chatHistory = chatHistory.slice(-50);
      }
      localStorage.setItem('budgetflow_chat_history', JSON.stringify(chatHistory));
    }
    
    // Format time for display
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      return date.toLocaleDateString();
    }
    
    // Scroll to bottom of chat
    function scrollToBottom() {
      setTimeout(() => {
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
      }, 100);
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Handle chat input
    function sendAIMessage() {
      const message = aiChatInput.value.trim();
      if (!message || isAIThinking) return;
      
      addUserMessage(message);
      aiChatInput.value = '';
      
      isAIThinking = true;
      aiThinking.style.display = 'block';
      aiSendBtn.disabled = true;
      
      setTimeout(() => {
        processAIQuery(message);
        isAIThinking = false;
        aiThinking.style.display = 'none';
        aiSendBtn.disabled = false;
      }, 1000);
    }
    
    // Handle Enter key in chat input
    function handleChatInputKeypress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendAIMessage();
      }
    }
    
    // Process AI query
    async function processAIQuery(query) {
      const lowerQuery = query.toLowerCase();
      
      // Budget-related queries
      if (lowerQuery.includes('budget') || lowerQuery.includes('limit') || lowerQuery.includes('spending limit')) {
        await handleBudgetQuery(lowerQuery);
      }
      // Transaction-related queries
      else if (lowerQuery.includes('transaction') || lowerQuery.includes('spending') || lowerQuery.includes('expense')) {
        await handleTransactionQuery(lowerQuery);
      }
      // Financial advice
      else if (lowerQuery.includes('advice') || lowerQuery.includes('tip') || lowerQuery.includes('help')) {
        await handleAdviceQuery(lowerQuery);
      }
      // Calculations
      else if (lowerQuery.includes('calculate') || lowerQuery.includes('how much') || lowerQuery.includes('cost')) {
        await handleCalculationQuery(lowerQuery);
      }
      // General financial queries
      else {
        await handleGeneralQuery(lowerQuery);
      }
    }
    
    // Handle transaction queries
    async function handleTransactionQuery(query) {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        if (query.includes('recent') || query.includes('latest') || query.includes('show me')) {
          const snapshot = await db.collection("users").doc(user.uid).collection("transactions")
            .orderBy("createdAt", "desc")
            .limit(10)
            .get();
          
          if (snapshot.empty) {
            addAIMessage("I don't see any recent transactions in your account.");
            return;
          }
          
          let html = '<strong>Recent Transactions:</strong><br><br>';
          let totalIncome = 0;
          let totalExpense = 0;
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const amount = parseFloat(data.INCOME) || parseFloat(data.EXPENSE) || 0;
            const type = data.TYPE || (data.INCOME ? "Income" : "Expense");
            
            html += ` ${data.DESCRIPTION || "No description"}: <strong>$${amount.toFixed(2)}</strong> (${type})<br>`;
            
            if (type === "Income") totalIncome += amount;
            else totalExpense += amount;
          });
          
          html += `<br><strong>Summary:</strong><br>`;
          html += `Total Income: <span style="color: var(--success)">$${totalIncome.toFixed(2)}</span><br>`;
          html += `Total Expense: <span style="color: var(--danger)">$${totalExpense.toFixed(2)}</span><br>`;
          html += `Net: <span style="color: ${totalIncome - totalExpense >= 0 ? 'var(--success)' : 'var(--danger)'}">$${(totalIncome - totalExpense).toFixed(2)}</span>`;
          
          addAIMessage("Here are your recent transactions:", html);
          
        } else if (query.includes('add') || query.includes('create') || query.includes('record')) {
          const html = `
            <strong>To add a transaction:</strong><br><br>
            1. Click the <strong>Transactions Tracker</strong> in the sidebar<br>
            2. Select either Classic or Compact view<br>
            3. Click the "+" button to add a new transaction<br>
            4. Fill in the details and save<br><br>
            <em>Need help with a specific transaction? Ask me!</em>
          `;
          addAIMessage("I can help you add transactions!", html);
        } else {
          addAIMessage(
            "For transactions, I can help you:<br>" +
            "1. View recent transactions<br>" +
            "2. Analyze spending patterns<br>" +
            "3. Categorize expenses<br>" +
            "4. Set transaction reminders<br><br>" +
            "Try asking: 'Show me recent transactions' or 'How much did I spend this month?'"
          );
        }
      } catch (error) {
        console.error("Error handling transaction query:", error);
        addAIMessage("I encountered an error while processing your transaction request. Please try again.");
      }
    }
    
    // Handle budget queries - Updated to include budget tracking
    async function handleBudgetQuery(query) {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        // Check if user wants to see budgets
        if (query.includes('show') || query.includes('view') || query.includes('list') || query.includes('my budget')) {
          await loadBudgets(user.uid);
          
          const budgets = await getBudgets(user.uid);
          
          if (budgets.length === 0) {
            addAIMessage("You don't have any budgets set up yet. Would you like me to help you create one?");
            return;
          }
          
          let html = '<strong>Your Current Budgets:</strong><br><br>';
          
          budgets.forEach(budget => {
            const percentage = budget.spent > 0 ? (budget.spent / budget.amount * 100).toFixed(1) : 0;
            const status = budget.spent > budget.amount ? ' Exceeded' : 
                          percentage > 80 ? ' Warning' : ' On Track';
            
            html += `
              <div style="margin-bottom: 10px; padding: 10px; background: var(--light-dark); border-radius: 8px;">
                <strong>${budget.category}</strong> (${budget.period})<br>
                Limit: $${budget.amount.toFixed(2)} | Spent: $${budget.spent.toFixed(2)}<br>
                Progress: ${percentage}% | ${status}
              </div>
            `;
          });
          
          html += `<br><em>You can add or edit budgets from the Budget Management section on the dashboard.</em>`;
          
          addAIMessage("Here are your current budgets:", html);
        } else if (query.includes('create') || query.includes('add') || query.includes('set up')) {
          // Help user create a budget
          const html = `
            <strong>To create a budget:</strong><br><br>
            1. Go to the <strong>Budget Management</strong> section on the dashboard<br>
            2. Click the "Add Budget" button<br>
            3. Enter the category, period (weekly/monthly/quarterly/yearly), and limit<br>
            4. Click Save<br><br>
            <em>Need help deciding on budget amounts? Ask me for recommendations!</em>
          `;
          addAIMessage("I can help you create a budget!", html);
        } else {
          // General budget advice
          addAIMessage(
            "For budget management, I can help you:<br>" +
            "1. View your current budgets<br>" +
            "2. Create new budgets for different categories<br>" +
            "3. Get alerts when you exceed budget limits<br>" +
            "4. Analyze your spending against your budgets<br><br>" +
            "Try asking: 'Show me my budgets' or 'Help me create a budget for groceries'"
          );
        }
      } catch (error) {
        console.error("Error handling budget query:", error);
        addAIMessage("I encountered an error while processing your budget request. Please try again.");
      }
    }
    
    // Handle advice queries
    async function handleAdviceQuery(query) {
      const tips = [
        {
          title: "Emergency Fund",
          content: "Build an emergency fund covering 3-6 months of expenses. Start with $1,000 and work up from there."
        },
        {
          title: "Debt Snowball",
          content: "Pay off debts from smallest to largest balance to build momentum and stay motivated."
        },
        {
          title: "Automate Savings",
          content: "Set up automatic transfers to savings accounts right after payday. Pay yourself first!"
        },
        {
          title: "Track Net Worth",
          content: "Calculate your net worth monthly (assets minus liabilities) to measure financial progress."
        },
        {
          title: "Avoid Lifestyle Inflation",
          content: "When you get a raise, save the extra money instead of increasing your spending."
        },
        {
          title: "Use Cash for Discretionary Spending",
          content: "Withdraw a set amount of cash each week for fun money to avoid overspending."
        }
      ];
      
      const selectedTip = tips[Math.floor(Math.random() * tips.length)];
      const html = `
        <div class="ai-suggestion">
          <div class="ai-suggestion-title"><i class="fas fa-lightbulb"></i> ${selectedTip.title}</div>
          ${selectedTip.content}
        </div>
        <br>
        <strong>More Quick Tips:</strong><br>
         Review subscriptions monthly and cancel unused ones<br>
         Cook at home 1-2 more times per week<br>
         Use cashback apps for regular purchases<br>
         Negotiate bills (internet, insurance, etc.) annually
      `;
      
      addAIMessage("Here's some financial advice that might help:", html);
    }
    
    // Handle calculation queries
    async function handleCalculationQuery(query) {
      const numbers = query.match(/\d+(\.\d+)?/g);
      
      if (query.includes('interest') || query.includes('loan') || query.includes('debt')) {
        const principal = numbers ? parseFloat(numbers[0]) : 10000;
        const rate = numbers && numbers[1] ? parseFloat(numbers[1]) : 5;
        const years = numbers && numbers[2] ? parseFloat(numbers[2]) : 5;
        
        const monthlyRate = rate / 100 / 12;
        const months = years * 12;
        const monthlyPayment = principal * monthlyRate / (1 - Math.pow(1 + monthlyRate, -months));
        const totalPaid = monthlyPayment * months;
        const totalInterest = totalPaid - principal;
        
        const html = `
          <div class="transaction-preview">
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Loan Amount:</span>
              <span class="transaction-preview-value">$${principal.toFixed(2)}</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Interest Rate:</span>
              <span class="transaction-preview-value">${rate.toFixed(2)}%</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Term:</span>
              <span class="transaction-preview-value">${years} years</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Monthly Payment:</span>
              <span class="transaction-preview-value" style="color: var(--primary)">$${monthlyPayment.toFixed(2)}</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Total Interest:</span>
              <span class="transaction-preview-value" style="color: var(--danger)">$${totalInterest.toFixed(2)}</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Total Paid:</span>
              <span class="transaction-preview-value" style="color: var(--success)">$${totalPaid.toFixed(2)}</span>
            </div>
          </div>
          <br>
          <em>Note: This is a simplified calculation. For exact numbers, use the Financial Calculator in the sidebar.</em>
        `;
        
        addAIMessage("Here's your loan calculation:", html);
        
      } else if (query.includes('save') && query.includes('goal')) {
        const goal = numbers ? parseFloat(numbers[0]) : 10000;
        const monthlySave = numbers && numbers[1] ? parseFloat(numbers[1]) : 500;
        const months = Math.ceil(goal / monthlySave);
        const years = (months / 12).toFixed(1);
        
        const html = `
          <div class="transaction-preview">
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Savings Goal:</span>
              <span class="transaction-preview-value">$${goal.toFixed(2)}</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Monthly Savings:</span>
              <span class="transaction-preview-value">$${monthlySave.toFixed(2)}</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Time Required:</span>
              <span class="transaction-preview-value" style="color: var(--primary)">${months} months (${years} years)</span>
            </div>
            <div class="transaction-preview-item">
              <span class="transaction-preview-label">Total Saved:</span>
              <span class="transaction-preview-value" style="color: var(--success)">$${goal.toFixed(2)}</span>
            </div>
          </div>
          <br>
          <div class="ai-suggestion">
            <div class="ai-suggestion-title"><i class="fas fa-lightbulb"></i> Tip</div>
            Consider setting up automatic transfers of $${monthlySave.toFixed(2)} to a separate savings account each month to reach your goal faster!
          </div>
        `;
        
        addAIMessage("Here's your savings goal timeline:", html);
        
      } else {
        addAIMessage(
          "I can help with calculations like:<br><br>" +
          " <strong>Loan payments</strong> - 'Calculate a $10,000 loan at 5% for 5 years'<br>" +
          " <strong>Savings goals</strong> - 'How long to save $5,000 at $200/month'<br>" +
          " <strong>Investment growth</strong> - 'What will $1,000 be worth in 10 years at 7%'<br>" +
          " <strong>Budget allocation</strong> - 'How to split $3,000 monthly income'<br><br>" +
          "Try asking a specific calculation question!"
        );
      }
    }
    
    // Handle general queries
    async function handleGeneralQuery(query) {
      const webResults = simulateWebSearch(query);
      
      let html = "Here's what I found based on your question:<br><br>";
      
      if (webResults.length > 0) {
        html += `<div class="web-results">`;
        webResults.forEach(result => {
          html += `
            <div class="web-result-item">
              <a href="#" class="web-result-title" onclick="event.preventDefault(); askAI('${result.title}')">
                ${result.title}
              </a>
              <div class="web-result-snippet">${result.snippet}</div>
            </div>
          `;
        });
        html += `</div><br>`;
      }
      
      html += `
        <strong>For more specific help with your finances, try:</strong><br>
         "How much did I spend on groceries last month?"<br>
         "Create a budget for $3,000 monthly income"<br>
         "Should I pay off debt or save first?"<br>
         "Help me analyze my spending patterns"
      `;
      
      addAIMessage("I found some information that might help:", html);
    }
    
    // Simulate web search
    function simulateWebSearch(query) {
      const financeTopics = [
        {
          title: "50/30/20 Budget Rule Explained",
          snippet: "The 50/30/20 rule is a simple budgeting method that allocates 50% of income to needs, 30% to wants, and 20% to savings and debt repayment.",
          url: "#"
        },
        {
          title: "Emergency Fund: How Much is Enough?",
          snippet: "Most financial experts recommend saving 3-6 months of living expenses in an emergency fund for unexpected financial setbacks.",
          url: "#"
        },
        {
          title: "Debt Snowball vs Debt Avalanche Method",
          snippet: "Two popular debt repayment strategies: snowball focuses on smallest debts first for motivation, avalanche targets highest interest rates first to save money.",
          url: "#"
        }
      ];
      
      return financeTopics.filter(topic => 
        query.includes('budget') || 
        query.includes('save') || 
        query.includes('debt') ||
        query.includes('emergency') ||
        Math.random() > 0.5
      ).slice(0, 2);
    }
    
    // Quick ask function
    function askAI(question) {
      if (!aiChatContainer.classList.contains('active')) {
        toggleAIChat();
      }
      
      setTimeout(() => {
        aiChatInput.value = question;
        sendAIMessage();
      }, 300);
    }
    
    // Toggle AI chat
    function toggleAIChat() {
      aiChatContainer.classList.toggle('active');
      if (aiChatContainer.classList.contains('active')) {
        scrollToBottom();
      }
    }
    
    // Initialize AI chat when page loads
    window.addEventListener('load', () => {
      setTimeout(initAIChat, 1000);
    });
    
    // ========== END OF AI CHAT FEATURE ==========

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.firebasestorage.app",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ========== BUDGET FEATURE ==========
    const budgetGrid = document.getElementById('budgetGrid');
    const budgetEmptyState = document.getElementById('budgetEmptyState');
    const budgetModal = document.getElementById('budgetModal');
    const budgetModalTitle = document.getElementById('budgetModalTitle');
    const budgetCategory = document.getElementById('budgetCategory');
    const budgetAmount = document.getElementById('budgetAmount');
    const budgetStartDate = document.getElementById('budgetStartDate');
    const budgetNotes = document.getElementById('budgetNotes');
    const budgetSummaryPeriod = document.getElementById('budgetSummaryPeriod');
    const budgetSummaryAmount = document.getElementById('budgetSummaryAmount');
    const budgetSummaryDate = document.getElementById('budgetSummaryDate');
    const saveBudgetBtn = document.getElementById('saveBudgetBtn');
    const budgetAlert = document.getElementById('budgetAlert');
    const budgetAlertTitle = document.getElementById('budgetAlertTitle');
    const budgetAlertMessage = document.getElementById('budgetAlertMessage');
    const budgetAlertClose = document.getElementById('budgetAlertClose');
    
    let budgets = [];
    let currentBudgetId = null;
    let currentBudgetPeriod = 'weekly';
    
    // Initialize budget feature
    function initBudgetFeature() {
      // Set default start date to today
      const today = new Date().toISOString().split('T')[0];
      budgetStartDate.value = today;
      
      // Add event listeners for budget modal
      document.querySelectorAll('.budget-period-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.budget-period-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          currentBudgetPeriod = this.dataset.period;
          updateBudgetSummary();
        });
      });
      
      budgetAmount.addEventListener('input', updateBudgetSummary);
      budgetStartDate.addEventListener('change', updateBudgetSummary);
      
      saveBudgetBtn.addEventListener('click', saveBudget);
      budgetAlertClose.addEventListener('click', () => {
        budgetAlert.classList.remove('active');
      });
    }
    
    // Load budgets from Firestore
    async function loadBudgets(userId) {
      try {
        showLoading('Loading budgets...');
        
        const snapshot = await db.collection("users").doc(userId).collection("budgets").get();
        budgets = [];
        
        snapshot.forEach(doc => {
          budgets.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Calculate spent amounts for each budget
        await calculateBudgetSpending(userId);
        
        // Update UI
        updateBudgetUI();
        
        // Check for budget alerts
        checkBudgetAlerts();
        
        hideLoading();
      } catch (error) {
        console.error("Error loading budgets:", error);
        hideLoading();
        showToast('Error loading budgets', 'error');
      }
    }
    
    // Get budgets (for AI chat integration)
    async function getBudgets(userId) {
      if (budgets.length === 0) {
        await loadBudgets(userId);
      }
      return budgets;
    }
    
    // Calculate spending for each budget
    async function calculateBudgetSpending(userId) {
      try {
        // Get transactions for the current period
        const now = new Date();
        let startDate;
        
        for (let budget of budgets) {
          // Calculate start date based on budget period
          switch (budget.period) {
            case 'weekly':
              startDate = new Date(now);
              startDate.setDate(now.getDate() - 7);
              break;
            case 'monthly':
              startDate = new Date(now);
              startDate.setMonth(now.getMonth() - 1);
              break;
            case 'quarterly':
              startDate = new Date(now);
              startDate.setMonth(now.getMonth() - 3);
              break;
            case 'yearly':
              startDate = new Date(now);
              startDate.setFullYear(now.getFullYear() - 1);
              break;
            default:
              startDate = new Date(now);
              startDate.setMonth(now.getMonth() - 1);
          }
          
          // Get transactions for this category and period
          const snapshot = await db.collection("users").doc(userId).collection("transactions")
            .where("ACCOUNT_HEADER", "==", budget.category)
            .where("DATE", ">=", startDate.toISOString())
            .get();
          
          let spent = 0;
          snapshot.forEach(doc => {
            const data = doc.data();
            spent += parseFloat(data.EXPENSE || 0);
          });
          
          budget.spent = spent;
          budget.percentage = (spent / budget.amount * 100);
        }
      } catch (error) {
        console.error("Error calculating budget spending:", error);
      }
    }
    
    // Update budget UI
    function updateBudgetUI() {
      budgetGrid.innerHTML = '';
      
      if (budgets.length === 0) {
        budgetEmptyState.style.display = 'block';
        return;
      }
      
      budgetEmptyState.style.display = 'none';
      
      budgets.forEach(budget => {
        const budgetCard = document.createElement('div');
        budgetCard.className = 'budget-card';
        
        // Determine card style based on spending
        if (budget.spent > budget.amount) {
          budgetCard.classList.add('exceeded');
        } else if (budget.percentage > 80) {
          budgetCard.classList.add('warning');
        } else if (budget.percentage > 90) {
          budgetCard.classList.add('danger');
        }
        
        const percentage = budget.percentage || 0;
        const progressClass = percentage > 90 ? 'danger' : percentage > 80 ? 'warning' : 'safe';
        
        budgetCard.innerHTML = `
          <div class="budget-card-title">
            <span>${budget.category}</span>
            <span class="budget-period-badge">${budget.period}</span>
          </div>
          <div class="budget-card-category">
            ${budget.notes || 'No notes'}
          </div>
          
          <div class="budget-progress-container">
            <div class="budget-progress-label">
              <span>$${budget.spent ? budget.spent.toFixed(2) : '0.00'} of $${budget.amount.toFixed(2)}</span>
              <span>${percentage.toFixed(1)}%</span>
            </div>
            <div class="budget-progress-bar">
              <div class="budget-progress-fill ${progressClass}" 
                   style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
          </div>
          
          <div class="budget-stats">
            <div class="budget-stat">
              <div class="budget-stat-label">Limit</div>
              <div class="budget-stat-value">$${budget.amount.toFixed(2)}</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-label">Spent</div>
              <div class="budget-stat-value">$${budget.spent ? budget.spent.toFixed(2) : '0.00'}</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-label">Remaining</div>
              <div class="budget-stat-value">$${Math.max(0, budget.amount - (budget.spent || 0)).toFixed(2)}</div>
            </div>
            <div class="budget-stat">
              <div class="budget-stat-label">Status</div>
              <div class="budget-stat-value">
                ${budget.spent > budget.amount ? ' Exceeded' : 
                  percentage > 80 ? ' Warning' : ' On Track'}
              </div>
            </div>
          </div>
          
          <div class="budget-card-actions">
            <button class="budget-edit-btn" onclick="editBudget('${budget.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="budget-delete-btn" onclick="deleteBudget('${budget.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        `;
        
        budgetGrid.appendChild(budgetCard);
      });
    }
    
    // Update budget summary in modal
    function updateBudgetSummary() {
      const amount = parseFloat(budgetAmount.value) || 0;
      const startDate = budgetStartDate.value;
      
      budgetSummaryPeriod.textContent = currentBudgetPeriod.charAt(0).toUpperCase() + currentBudgetPeriod.slice(1);
      budgetSummaryAmount.textContent = `$${amount.toFixed(2)}`;
      budgetSummaryDate.textContent = startDate ? formatDate(startDate) : '-';
    }
    
    // Open budget modal
    function openBudgetModal() {
      // Reset form
      budgetCategory.value = '';
      budgetAmount.value = '';
      budgetNotes.value = '';
      budgetStartDate.value = new Date().toISOString().split('T')[0];
      
      // Reset period tabs
      document.querySelectorAll('.budget-period-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.period === 'weekly') {
          tab.classList.add('active');
        }
      });
      currentBudgetPeriod = 'weekly';
      
      // Update modal title
      budgetModalTitle.textContent = 'Add New Budget';
      
      // Reset save button
      saveBudgetBtn.innerHTML = '<i class="fas fa-save"></i> Save Budget';
      saveBudgetBtn.onclick = saveBudget;
      
      // Update summary
      updateBudgetSummary();
      
      // Show modal
      budgetModal.classList.add('active');
    }
    
    // Close budget modal
    function closeBudgetModal() {
      budgetModal.classList.remove('active');
      currentBudgetId = null;
    }
    
    // Save budget
    async function saveBudget() {
      const category = budgetCategory.value.trim();
      const amount = parseFloat(budgetAmount.value);
      const startDate = budgetStartDate.value;
      const notes = budgetNotes.value.trim();
      
      if (!category || !amount || amount <= 0 || !startDate) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        setButtonLoading(saveBudgetBtn, true);
        
        const budgetData = {
          category,
          amount,
          period: currentBudgetPeriod,
          startDate,
          notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (currentBudgetId) {
          // Update existing budget
          await db.collection("users").doc(user.uid).collection("budgets").doc(currentBudgetId).update(budgetData);
          showToast('Budget updated successfully!', 'success');
        } else {
          // Create new budget
          await db.collection("users").doc(user.uid).collection("budgets").add(budgetData);
          showToast('Budget created successfully!', 'success');
        }
        
        closeBudgetModal();
        loadBudgets(user.uid);
        
      } catch (error) {
        console.error("Error saving budget:", error);
        showToast('Error saving budget. Please try again.', 'error');
      } finally {
        setButtonLoading(saveBudgetBtn, false);
      }
    }
    
    // Edit budget
    async function editBudget(budgetId) {
      const budget = budgets.find(b => b.id === budgetId);
      if (!budget) return;
      
      try {
        showLoading('Loading budget details...');
        
        budgetCategory.value = budget.category;
        budgetAmount.value = budget.amount;
        budgetStartDate.value = budget.startDate;
        budgetNotes.value = budget.notes || '';
        
        // Set period tab
        document.querySelectorAll('.budget-period-tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.dataset.period === budget.period) {
            tab.classList.add('active');
          }
        });
        currentBudgetPeriod = budget.period;
        
        // Update modal title
        budgetModalTitle.textContent = 'Edit Budget';
        
        // Set current budget ID
        currentBudgetId = budgetId;
        
        // Update save button
        saveBudgetBtn.innerHTML = '<i class="fas fa-save"></i> Update Budget';
        saveBudgetBtn.onclick = saveBudget;
        
        // Update summary
        updateBudgetSummary();
        
        // Show modal
        budgetModal.classList.add('active');
        
        hideLoading();
      } catch (error) {
        console.error("Error loading budget for editing:", error);
        hideLoading();
        showToast('Error loading budget for editing', 'error');
      }
    }
    
    // Delete budget
    async function deleteBudget(budgetId) {
      const confirmDelete = confirm('Are you sure you want to delete this budget?');
      if (!confirmDelete) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        await db.collection("users").doc(user.uid).collection("budgets").doc(budgetId).delete();
        showToast('Budget deleted successfully!', 'success');
        loadBudgets(user.uid);
      } catch (error) {
        console.error("Error deleting budget:", error);
        showToast('Error deleting budget. Please try again.', 'error');
      }
    }
    
    // Check for budget alerts
    function checkBudgetAlerts() {
      const exceededBudgets = budgets.filter(budget => budget.spent > budget.amount);
      const warningBudgets = budgets.filter(budget => budget.percentage > 80 && budget.spent <= budget.amount);
      
      // Show most urgent alert
      if (exceededBudgets.length > 0) {
        const budget = exceededBudgets[0];
        showBudgetAlert(
          'Budget Limit Exceeded!',
          `You have exceeded your ${budget.period} budget for ${budget.category} by $${(budget.spent - budget.amount).toFixed(2)}.`,
          'danger'
        );
      } else if (warningBudgets.length > 0) {
        const budget = warningBudgets[0];
        showBudgetAlert(
          'Budget Warning',
          `You have used ${budget.percentage.toFixed(1)}% of your ${budget.period} budget for ${budget.category}. Only $${Math.max(0, budget.amount - budget.spent).toFixed(2)} remaining.`,
          'warning'
        );
      }
    }
    
    // Show budget alert
    function showBudgetAlert(title, message, type = 'danger') {
      budgetAlertTitle.textContent = title;
      budgetAlertMessage.textContent = message;
      budgetAlert.className = `budget-alert ${type}`;
      budgetAlert.classList.add('active');
      
      // Auto-hide after 10 seconds
      setTimeout(() => {
        budgetAlert.classList.remove('active');
      }, 10000);
    }
    
    // Refresh budgets
    function refreshBudgets() {
      const user = auth.currentUser;
      if (user) {
        loadBudgets(user.uid);
        showToast('Budgets refreshed!', 'success');
      }
    }
    
    // ========== END BUDGET FEATURE ==========

    // ========== AUTO LOGOUT FEATURE ==========
    let logoutTimer;
    let warningTimer;
    let timeLeft = 5 * 60;
    let isAutoLogoutActive = true;
    const autoLogoutModal = document.getElementById('autoLogoutModal');
    const sessionWarning = document.getElementById('sessionWarning');
    const countdownTimer = document.getElementById('countdownTimer');
    const warningTimerEl = document.getElementById('warningTimer');
    const countdownText = document.getElementById('countdownText');
    const stayLoggedInBtn = document.getElementById('stayLoggedInBtn');
    const logoutNowBtn = document.getElementById('logoutNowBtn');

    function resetAutoLogoutTimer() {
      if (!isAutoLogoutActive) return;
      
      clearTimeout(logoutTimer);
      clearInterval(warningTimer);
      timeLeft = 5 * 60;
      
      sessionWarning.classList.remove('active');
      autoLogoutModal.classList.remove('active');
      
      logoutTimer = setTimeout(() => {
        showAutoLogoutWarning();
      }, 4 * 60 * 1000);
    }

    function showAutoLogoutWarning() {
      timeLeft = 60;
      sessionWarning.classList.add('active');
      updateWarningTimer();
      
      warningTimer = setInterval(() => {
        timeLeft--;
        updateWarningTimer();
        
        if (timeLeft <= 0) {
          clearInterval(warningTimer);
          showAutoLogoutModal();
        }
      }, 1000);
    }

    function updateWarningTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      warningTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function showAutoLogoutModal() {
      timeLeft = 5 * 60;
      autoLogoutModal.classList.add('active');
      updateCountdownTimer();
      
      const modalCountdown = setInterval(() => {
        timeLeft--;
        updateCountdownTimer();
        
        if (timeLeft <= 0) {
          clearInterval(modalCountdown);
          performAutoLogout();
        }
      }, 1000);
    }

    function updateCountdownTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      countdownTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      if (timeLeft > 60) {
        countdownText.textContent = `${minutes} minute${minutes > 1 ? 's' : ''}`;
      } else {
        countdownText.textContent = `${seconds} second${seconds !== 1 ? 's' : ''}`;
      }
    }

    function performAutoLogout() {
      if (!auth.currentUser) return;
      
      showToast('Session expired due to inactivity. Please login again.', 'warning');
      
      auth.signOut().then(() => {
        window.location.href = "index.html";
      }).catch((error) => {
        console.error("Auto logout error:", error);
        window.location.href = "index.html";
      });
    }

    function stayLoggedIn() {
      resetAutoLogoutTimer();
      showToast('Session extended. You will be logged out after 5 minutes of inactivity.', 'success');
    }

    function logoutNow() {
      performAutoLogout();
    }

    function setupActivityListeners() {
      const activityEvents = [
        'mousemove', 'keydown', 'click', 'scroll', 'touchstart'
      ];
      
      activityEvents.forEach(eventName => {
        document.addEventListener(eventName, resetAutoLogoutTimer);
      });
      
      const modals = document.querySelectorAll('.modal, .popup');
      modals.forEach(modal => {
        modal.addEventListener('click', resetAutoLogoutTimer);
      });
    }

    function initAutoLogout() {
      resetAutoLogoutTimer();
      setupActivityListeners();
      
      stayLoggedInBtn.addEventListener('click', stayLoggedIn);
      logoutNowBtn.addEventListener('click', logoutNow);
      
      window.addEventListener('focus', resetAutoLogoutTimer);
    }

    function toggleAutoLogout(enable) {
      isAutoLogoutActive = enable;
      if (enable) {
        resetAutoLogoutTimer();
      } else {
        clearTimeout(logoutTimer);
        clearInterval(warningTimer);
        sessionWarning.classList.remove('active');
        autoLogoutModal.classList.remove('active');
      }
    }
    // ========== END OF AUTO LOGOUT FEATURE ==========

    // DOM Elements
    const dashboard = document.getElementById("dashboard");
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.getElementById("menuToggle");
    const header = document.getElementById("header");
    const main = document.getElementById("main");
    const profileMenu = document.getElementById("profileMenu");
    const userInitials = document.getElementById("userInitials");
    const headerUserInitials = document.getElementById("headerUserInitials");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const addReminderBtn = document.getElementById("addReminderBtn");
    const expensePopup = document.getElementById("expensePopup");
    const reportPopup = document.getElementById("reportPopup");
    const transactionTypePopup = document.getElementById("transactionTypePopup");
    const reminderModal = document.getElementById("reminderModal");
    const reminderDetailModal = document.getElementById("reminderDetailModal");
    const saveReminderBtn = document.getElementById("saveReminderBtn");
    const editReminderBtn = document.getElementById("editReminderBtn");
    const deleteReminderBtn = document.getElementById("deleteReminderBtn");
    const themeToggle = document.getElementById("themeToggle");
    const balanceToggle = document.getElementById("balanceToggle");
    const currentBalanceEl = document.getElementById("currentBalance");
    const filterButtons = document.querySelectorAll('.filter-btn');
    const currentDateEl = document.getElementById("currentDate");
    const currentTimeEl = document.getElementById("currentTime");
    
    // Notification elements
    const notificationBell = document.getElementById("notificationBell");
    const notificationBadge = document.getElementById("notificationBadge");
    const notificationPanel = document.getElementById("notificationPanel");
    const notificationList = document.getElementById("notificationList");
    const clearNotifications = document.getElementById("clearNotifications");
    
    // Reminder detail modal elements
    const detailType = document.getElementById("detailType");
    const detailTitle = document.getElementById("detailTitle");
    const detailDate = document.getElementById("detailDate");
    const detailTime = document.getElementById("detailTime");
    const detailNotes = document.getElementById("detailNotes");
    const detailBillAmount = document.getElementById("detailBillAmount");
    const detailBillAmountItem = document.getElementById("detailBillAmountItem");
    const detailRecurrence = document.getElementById("detailRecurrence");
    const detailRecurrenceItem = document.getElementById("detailRecurrenceItem");
    
    // Bill reminder specific elements
    const reminderType = document.getElementById("reminderType");
    const billAmountGroup = document.getElementById("billAmountGroup");
    const recurrenceGroup = document.getElementById("recurrenceGroup");
    const billAmount = document.getElementById("billAmount");
    
    // New elements
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingText = document.getElementById("loadingText");
    const toast = document.getElementById("toast");
    
    // Stats elements
    const totalTransactionsEl = document.getElementById("totalTransactions");
    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpensesEl = document.getElementById("totalExpenses");

    // Store the currently selected reminder
    let currentReminderId = null;
    let balanceVisible = false;
    let currentFilter = 'today';
    let allTransactions = [];
    let filteredTransactions = [];
    let accountHeaders = [];
    let bankNames = [];
    let notifications = [];

    // COA data
    let coaAccounts = [];
    let coaBanks = [];

    // Update date and time
    function updateDateTime() {
      const now = new Date();
      
      // Format date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      currentDateEl.textContent = now.toLocaleDateString('en-US', options);
      
      // Format time
      currentTimeEl.textContent = now.toLocaleTimeString('en-US');
    }

    // Update date and time immediately and then every second
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Calendar initialization
    let calendar;
    let selectedDate = null;
    
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: [],
        height: 'auto',
        dateClick: function(info) {
          selectedDate = info.dateStr;
          openReminderModalWithDate(selectedDate);
        },
        eventClick: function(info) {
          showReminderDetails(info.event);
        },
        eventDidMount: function(info) {
          info.el.title = info.event.title;
        }
      });
      calendar.render();
    });

    // Open reminder modal with selected date
    function openReminderModalWithDate(date) {
      document.getElementById("reminderDate").value = date;
      document.getElementById("reminderType").value = "reminder";
      document.getElementById("reminderTitle").value = "";
      document.getElementById("reminderTime").value = "";
      document.getElementById("reminderNotes").value = "";
      document.getElementById("billAmount").value = "";
      document.querySelector('input[name="recurrence"][value="none"]').checked = true;
      toggleBillFields("reminder");
      
      saveReminderBtn.innerHTML = '<i class="fas fa-save"></i> Save Reminder';
      saveReminderBtn.onclick = saveReminder;
      
      reminderModal.classList.add("active");
    }

    // Show toast notification
    function showToast(message, type = '') {
      toast.textContent = message;
      toast.className = 'toast';
      if (type) toast.classList.add(type);
      toast.classList.add('active');
      
      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // Show loading overlay
    function showLoading(text = 'Processing...') {
      loadingText.textContent = text;
      loadingOverlay.classList.add('active');
    }

    // Hide loading overlay
    function hideLoading() {
      loadingOverlay.classList.remove('active');
    }

    // Set button loading state
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('loading');
        button.disabled = true;
      } else {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }

    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      themeToggle.innerHTML = newTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', newTheme);
    }

    // Toggle balance visibility
    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      
      if (balanceVisible) {
        currentBalanceEl.classList.remove('balance-hidden');
        balanceToggle.innerHTML = '<i class="fa fa-eye"></i>';
      } else {
        currentBalanceEl.classList.add('balance-hidden');
        balanceToggle.innerHTML = '<i class="fa fa-eye-slash"></i>';
      }
      
      localStorage.setItem('balanceVisible', balanceVisible);
    }

    // Open transaction type popup
    function openTransactionTypePopup() {
      transactionTypePopup.classList.add('active');
    }

    // Close transaction type popup
    function closeTransactionTypePopup() {
      transactionTypePopup.classList.remove('active');
    }

    // Check if user is logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        dashboard.style.display = "block";
        const displayName = user.displayName || "User Name";
        const email = user.email || "user@example.com";
        
        userInitials.textContent = displayName.charAt(0).toUpperCase();
        headerUserInitials.textContent = displayName.charAt(0).toUpperCase();
        userName.textContent = displayName;
        userEmail.textContent = email;
        
        // Load saved preferences
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.documentElement.setAttribute('data-theme', savedTheme);
          themeToggle.innerHTML = savedTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
        }
        
        const savedBalanceVisibility = localStorage.getItem('balanceVisible');
        if (savedBalanceVisibility === 'true') {
          balanceVisible = true;
          currentBalanceEl.classList.remove('balance-hidden');
          balanceToggle.innerHTML = '<i class="fa fa-eye"></i>';
        }
        
        loadFinancialData(user.uid);
        loadCalendarEvents(user.uid);
        loadAccountHeaders(user.uid);
        loadNotifications(user.uid);
        loadBudgets(user.uid); // Load budgets
        
        // Initialize budget feature
        initBudgetFeature();
        
        // Initialize auto logout feature
        initAutoLogout();
      } else {
        window.location.href = "index.html";
      }
    });

    // Load financial data from transactions
    async function loadFinancialData(userId) {
      try {
        showLoading('Loading financial data...');
        
        const transactionsQuery = db.collection("users").doc(userId).collection("transactions");
        const snapshot = await transactionsQuery.get();
        
        allTransactions = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          allTransactions.push({ id: doc.id, ...data });
        });
        
        applyFilter(currentFilter);
        
        hideLoading();
      } catch (error) {
        console.error("Error loading financial data:", error);
        hideLoading();
        showToast('Error loading financial data', 'error');
      }
    }

    // Apply date filter to transactions
    function applyFilter(filterType) {
      currentFilter = filterType;
      
      filterButtons.forEach(btn => {
        if (btn.dataset.filter === filterType) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      const now = new Date();
      filteredTransactions = allTransactions.filter(transaction => {
        const transactionDate = new Date(transaction.DATE);
        
        switch(filterType) {
          case 'today':
            return isSameDay(transactionDate, now);
          case 'week':
            return isSameWeek(transactionDate, now);
          case 'month':
            return isSameMonth(transactionDate, now);
          case 'year':
            return isSameYear(transactionDate, now);
          case 'all':
          default:
            return true;
        }
      });
      
      calculateStats(filteredTransactions);
      
      showToast(`Showing ${filteredTransactions.length} transactions for ${filterType}`, 'success');
    }

    // Helper functions for date filtering
    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    function isSameWeek(date1, date2) {
      const startOfWeek = new Date(date2);
      startOfWeek.setDate(date2.getDate() - date2.getDay());
      startOfWeek.setHours(0, 0, 0, 0);
      
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      endOfWeek.setHours(23, 59, 59, 999);
      
      return date1 >= startOfWeek && date1 <= endOfWeek;
    }

    function isSameMonth(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth();
    }

    function isSameYear(date1, date2) {
      return date1.getFullYear() === date2.getFullYear();
    }

    // Calculate statistics from filtered transactions
    function calculateStats(transactions) {
      let totalIncome = 0;
      let totalExpenses = 0;
      let totalTransactions = transactions.length;
      let latestBalance = 0;
      
      transactions.forEach(transaction => {
        totalIncome += parseFloat(transaction.INCOME || 0);
        totalExpenses += parseFloat(transaction.EXPENSE || 0);
        
        if (latestBalance === 0 && transaction.BALANCE) {
          latestBalance = parseFloat(transaction.BALANCE);
        }
      });
      
      const currentBalance = latestBalance || (totalIncome - totalExpenses);
      
      totalTransactionsEl.textContent = totalTransactions;
      currentBalanceEl.textContent = `$${currentBalance.toFixed(2)}`;
      totalIncomeEl.textContent = `$${totalIncome.toFixed(2)}`;
      totalExpensesEl.textContent = `$${totalExpenses.toFixed(2)}`;
    }

    // Load account headers from Chart of Accounts
    async function loadAccountHeaders(userId) {
      try {
        showLoading('Loading account headers...');
        
        const coaSnapshot = await db.collection("users").doc(userId).collection("chartOfAccounts").get();
        
        accountHeaders = [];
        
        coaSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            accountHeaders.push(data.name);
          }
        });
        
        hideLoading();
      } catch (error) {
        console.error("Error loading account headers:", error);
        hideLoading();
        showToast('Error loading account headers', 'error');
      }
    }

    // Load calendar events
    async function loadCalendarEvents(userId) {
      try {
        showLoading('Loading calendar events...');
        
        const snapshot = await db.collection("users").doc(userId).collection("reminders").get();
        
        const events = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          const eventData = {
            id: doc.id,
            title: data.title,
            start: data.date + (data.time ? "T" + data.time : ""),
            allDay: !data.time,
            extendedProps: {
              reminderId: doc.id,
              type: data.type,
              notes: data.notes || "",
              billAmount: data.billAmount || 0,
              recurrence: data.recurrence || "none"
            }
          };
          
          if (data.type === "bill") {
            eventData.color = "#FF6B6B";
            eventData.title = " " + data.title;
            
            if (data.recurrence && data.recurrence !== "none") {
              createRecurringEvents(eventData, data.recurrence, events);
            } else {
              events.push(eventData);
            }
          } else if (data.type === "birthday") {
            eventData.color = "#FFD700";
            eventData.title = " " + data.title;
            
            const year = new Date().getFullYear();
            const maxYear = year + 50;
            for (let y = year; y <= maxYear; y++) {
              const birthdayEvent = {...eventData};
              birthdayEvent.id = `${doc.id}-${y}`;
              birthdayEvent.start = y + "-" + data.date.substring(5);
              events.push(birthdayEvent);
            }
          } else if (data.type === "meeting") {
            eventData.color = "#4ECDC4";
            events.push(eventData);
          } else {
            eventData.color = "#45B7D1";
            events.push(eventData);
          }
        });
        
        calendar.removeAllEvents();
        if (events.length > 0) {
          calendar.addEventSource(events);
        }
        calendar.refetchEvents();
        
        hideLoading();
      } catch (error) {
        console.error("Error loading reminders: ", error);
        hideLoading();
        showToast('Error loading calendar events', 'error');
      }
    }

    // Create recurring events for bills
    function createRecurringEvents(eventData, recurrence, events) {
      const startDate = new Date(eventData.start);
      const today = new Date();
      const maxDate = new Date();
      maxDate.setFullYear(today.getFullYear() + 2);
      
      let currentDate = new Date(startDate);
      let eventCount = 0;
      const maxEvents = 50;
      
      while (currentDate <= maxDate && eventCount < maxEvents) {
        const recurringEvent = {...eventData};
        recurringEvent.id = `${eventData.id}-${eventCount}`;
        recurringEvent.start = currentDate.toISOString().split('T')[0];
        events.push(recurringEvent);
        
        if (recurrence === "daily") {
          currentDate.setDate(currentDate.getDate() + 1);
        } else if (recurrence === "weekly") {
          currentDate.setDate(currentDate.getDate() + 7);
        } else if (recurrence === "monthly") {
          currentDate.setMonth(currentDate.getMonth() + 1);
        } else if (recurrence === "yearly") {
          currentDate.setFullYear(currentDate.getFullYear() + 1);
        }
        
        eventCount++;
      }
    }

    // Show reminder details in modal
    async function showReminderDetails(event) {
      try {
        showLoading('Loading reminder details...');
        
        const reminderId = event.extendedProps.reminderId;
        currentReminderId = reminderId;
        
        const user = auth.currentUser;
        const reminderDoc = await db.collection("users").doc(user.uid).collection("reminders").doc(reminderId).get();
        
        if (reminderDoc.exists) {
          const data = reminderDoc.data();
          
          detailType.textContent = data.type;
          detailType.className = `reminder-type-badge ${data.type}`;
          detailTitle.textContent = data.title;
          detailDate.textContent = formatDate(data.date);
          detailTime.textContent = data.time || "Not specified";
          detailNotes.textContent = data.notes || "No notes";
          
          if (data.type === "bill") {
            detailBillAmount.textContent = `$${parseFloat(data.billAmount || 0).toFixed(2)}`;
            detailBillAmountItem.style.display = "flex";
            detailRecurrence.textContent = data.recurrence || "None";
            detailRecurrenceItem.style.display = "flex";
          } else {
            detailBillAmountItem.style.display = "none";
            detailRecurrenceItem.style.display = "none";
          }
          
          reminderDetailModal.classList.add('active');
        } else {
          showToast("Reminder not found", "error");
        }
        
        hideLoading();
      } catch (error) {
        console.error("Error loading reminder details: ", error);
        hideLoading();
        showToast("Error loading reminder details", "error");
      }
    }

    // Format date for display
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // Close reminder detail modal
    function closeReminderDetailModal() {
      reminderDetailModal.classList.remove('active');
      currentReminderId = null;
    }

    // Edit reminder
    async function editReminder() {
      if (!currentReminderId) return;
      
      try {
        showLoading('Loading reminder for editing...');
        
        const user = auth.currentUser;
        const reminderDoc = await db.collection("users").doc(user.uid).collection("reminders").doc(currentReminderId).get();
        
        if (reminderDoc.exists) {
          const data = reminderDoc.data();
          
          document.getElementById("reminderType").value = data.type;
          document.getElementById("reminderTitle").value = data.title;
          document.getElementById("reminderDate").value = data.date;
          document.getElementById("reminderTime").value = data.time || "";
          document.getElementById("reminderNotes").value = data.notes || "";
          
          if (data.type === "bill") {
            document.getElementById("billAmount").value = data.billAmount || "";
            document.querySelector(`input[name="recurrence"][value="${data.recurrence || 'none'}"]`).checked = true;
          }
          
          toggleBillFields(data.type);
          
          closeReminderDetailModal();
          reminderModal.classList.add('active');
          
          saveReminderBtn.innerHTML = '<i class="fas fa-save"></i> Update Reminder';
          saveReminderBtn.onclick = updateReminder;
        }
        
        hideLoading();
      } catch (error) {
        console.error("Error loading reminder for editing: ", error);
        hideLoading();
        showToast("Error loading reminder for editing", "error");
      }
    }

    // Update reminder
    async function updateReminder() {
      const type = document.getElementById("reminderType").value;
      const title = document.getElementById("reminderTitle").value;
      const date = document.getElementById("reminderDate").value;
      const time = document.getElementById("reminderTime").value;
      const notes = document.getElementById("reminderNotes").value;
      const user = auth.currentUser;

      if (!title || !date) {
        showToast("Please fill in all required fields", "error");
        return;
      }

      try {
        setButtonLoading(saveReminderBtn, true);
        
        const updateData = {
          type,
          title,
          date,
          time,
          notes,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (type === "bill") {
          updateData.billAmount = parseFloat(document.getElementById("billAmount").value) || 0;
          updateData.recurrence = document.querySelector('input[name="recurrence"]:checked').value;
        }
        
        await db.collection("users").doc(user.uid).collection("reminders").doc(currentReminderId).update(updateData);
        
        closeReminderModal();
        showToast("Reminder updated successfully!", "success");
        loadCalendarEvents(user.uid);
        loadNotifications(user.uid);
        
        saveReminderBtn.innerHTML = '<i class="fas fa-save"></i> Save Reminder';
        saveReminderBtn.onclick = saveReminder;
      } catch (error) {
        console.error("Error updating reminder: ", error);
        showToast("Error updating reminder. Please try again.", "error");
      } finally {
        setButtonLoading(saveReminderBtn, false);
      }
    }

    // Delete reminder
    async function deleteReminder() {
      if (!currentReminderId) return;
      
      const confirmDelete = confirm("Are you sure you want to delete this reminder?");
      if (!confirmDelete) return;
      
      try {
        setButtonLoading(deleteReminderBtn, true);
        
        const user = auth.currentUser;
        await db.collection("users").doc(user.uid).collection("reminders").doc(currentReminderId).delete();
        
        closeReminderDetailModal();
        showToast("Reminder deleted successfully!", "success");
        loadCalendarEvents(user.uid);
        loadNotifications(user.uid);
      } catch (error) {
        console.error("Error deleting reminder: ", error);
        showToast("Error deleting reminder. Please try again.", "error");
      } finally {
        setButtonLoading(deleteReminderBtn, false);
      }
    }

    // Save reminder
    async function saveReminder() {
      const type = document.getElementById("reminderType").value;
      const title = document.getElementById("reminderTitle").value;
      const date = document.getElementById("reminderDate").value;
      const time = document.getElementById("reminderTime").value;
      const notes = document.getElementById("reminderNotes").value;
      const user = auth.currentUser;

      if (!title || !date) {
        showToast("Please fill in all required fields", "error");
        return;
      }

      try {
        setButtonLoading(saveReminderBtn, true);
        
        const reminderData = {
          type,
          title,
          date,
          time,
          notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (type === "bill") {
          reminderData.billAmount = parseFloat(document.getElementById("billAmount").value) || 0;
          reminderData.recurrence = document.querySelector('input[name="recurrence"]:checked').value;
        }
        
        await db.collection("users").doc(user.uid).collection("reminders").add(reminderData);
        
        closeReminderModal();
        showToast("Reminder added successfully!", "success");
        loadCalendarEvents(user.uid);
        loadNotifications(user.uid);
      } catch (error) {
        console.error("Error adding reminder: ", error);
        showToast("Error adding reminder. Please try again.", "error");
      } finally {
        setButtonLoading(saveReminderBtn, false);
      }
    }

    // Toggle bill-specific fields based on reminder type
    function toggleBillFields(type) {
      if (type === "bill") {
        billAmountGroup.style.display = "block";
        recurrenceGroup.style.display = "block";
      } else {
        billAmountGroup.style.display = "none";
        recurrenceGroup.style.display = "none";
      }
    }

    // Load notifications
    async function loadNotifications(userId) {
      try {
        const snapshot = await db.collection("users").doc(userId).collection("reminders").get();
        
        notifications = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const reminderDate = new Date(data.date);
          reminderDate.setHours(0, 0, 0, 0);
          
          const timeDiff = reminderDate.getTime() - today.getTime();
          const daysUntil = Math.ceil(timeDiff / (1000 * 3600 * 24));
          
          if (daysUntil >= 0 && daysUntil <= 7) {
            let message = "";
            let daysText = "";
            
            if (daysUntil === 0) {
              daysText = "Today";
            } else if (daysUntil === 1) {
              daysText = "Tomorrow";
            } else {
              daysText = `In ${daysUntil} days`;
            }
            
            if (data.type === "bill") {
              message = `Bill payment of $${parseFloat(data.billAmount || 0).toFixed(2)} due ${daysText}`;
            } else {
              message = `${data.type.charAt(0).toUpperCase() + data.type.slice(1)} ${daysText}`;
            }
            
            notifications.push({
              id: doc.id,
              title: data.title,
              message: message,
              type: data.type,
              date: data.date,
              daysUntil: daysUntil
            });
          }
        });
        
        notifications.sort((a, b) => {
          return new Date(a.date) - new Date(b.date);
        });
        
        updateNotificationUI();
      } catch (error) {
        console.error("Error loading notifications:", error);
      }
    }

    // Update notification UI
    function updateNotificationUI() {
      notificationBadge.textContent = notifications.length;
      
      notificationList.innerHTML = "";
      
      if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="no-notifications">No upcoming reminders</div>';
        return;
      }
      
      notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = 'notification-item';
        notificationItem.onclick = () => {
          const event = calendar.getEvents().find(e => e.id === notification.id || e.id.startsWith(notification.id));
          if (event) {
            showReminderDetails(event);
            closeNotificationPanel();
          }
        };
        
        let iconClass = "";
        if (notification.type === "bill") {
          iconClass = "bill";
        } else if (notification.type === "birthday") {
          iconClass = "birthday";
        } else if (notification.type === "meeting") {
          iconClass = "meeting";
        } else {
          iconClass = "reminder";
        }
        
        notificationItem.innerHTML = `
          <div class="notification-title">
            <div class="notification-icon ${iconClass}">
              <i class="fa ${notification.type === 'bill' ? 'fa-file-invoice-dollar' : 
                              notification.type === 'birthday' ? 'fa-birthday-cake' : 
                              notification.type === 'meeting' ? 'fa-users' : 'fa-bell'}"></i>
            </div>
            ${notification.title}
          </div>
          <div class="notification-message">${notification.message}</div>
          <div class="notification-time">
            <i class="fa fa-calendar"></i>
            ${formatDate(notification.date)}
          </div>
        `;
        
        notificationList.appendChild(notificationItem);
      });
    }

    // Clear all notifications
    function clearAllNotifications() {
      notifications = [];
      updateNotificationUI();
      showToast("Notifications cleared", "success");
    }

    // Toggle notification panel
    function toggleNotificationPanel() {
      notificationPanel.classList.toggle('active');
    }

    // Close notification panel
    function closeNotificationPanel() {
      notificationPanel.classList.remove('active');
    }

    // New Feature Functions
    function openBudgetPlanner() {
      askAI("How do I create a budget plan?");
    }

    function openGoalTracker() {
      askAI("Help me set up financial goals");
    }

    function openBillReminders() {
      askAI("How can I manage my bill payments better?");
    }

    function openFinancialInsights() {
      askAI("Give me insights about my financial health");
    }

    function logout() {
      auth.signOut().then(() => {
        console.log("User signed out");
        window.location.href = "index.html";
      }).catch((error) => {
        showToast("Logout error: " + error.message, 'error');
      });
    }

    function openProfile() {
      window.location.href = "profile.html";
    }

    // Sidebar toggle
    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("visible");
      header.classList.toggle("sidebar-visible");
      main.classList.toggle("sidebar-visible");
    });

    // Profile dropdown
    profileMenu.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle("active");
    });

    // Close dropdown when clicking elsewhere
    document.addEventListener("click", () => {
      profileMenu.classList.remove("active");
    });

    // Theme toggle
    themeToggle.addEventListener("click", toggleTheme);

    // Balance visibility toggle
    balanceToggle.addEventListener("click", toggleBalanceVisibility);

    // Filter buttons
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        applyFilter(btn.dataset.filter);
      });
    });

    // Transaction button click handler
    totalTransactionsEl.addEventListener('click', () => {
      openTransactionTypePopup();
    });

    // Income/Expense click handlers
    totalIncomeEl.addEventListener('click', () => {
      reportPopup.classList.add('active');
    });

    totalExpensesEl.addEventListener('click', () => {
      reportPopup.classList.add('active');
    });

    // Expense Popup
    function openExpensePopup() {
      expensePopup.classList.add("active");
    }
    
    function closeExpensePopup() {
      expensePopup.classList.remove("active");
    }

    // Report Popup
    function closeReportPopup() {
      reportPopup.classList.remove("active");
    }

    // Reminder Modal
    addReminderBtn.addEventListener("click", () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("reminderDate").value = today;
      document.getElementById("reminderType").value = "reminder";
      document.getElementById("reminderTitle").value = "";
      document.getElementById("reminderTime").value = "";
      document.getElementById("reminderNotes").value = "";
      document.getElementById("billAmount").value = "";
      document.querySelector('input[name="recurrence"][value="none"]').checked = true;
      toggleBillFields("reminder");
      
      saveReminderBtn.innerHTML = '<i class="fas fa-save"></i> Save Reminder';
      saveReminderBtn.onclick = saveReminder;
      
      reminderModal.classList.add("active");
    });
    
    function closeReminderModal() {
      reminderModal.classList.remove("active");
      saveReminderBtn.innerHTML = '<i class="fas fa-save"></i> Save Reminder';
      saveReminderBtn.onclick = saveReminder;
    }

    // Edit reminder button
    editReminderBtn.addEventListener("click", editReminder);

    // Delete reminder button
    deleteReminderBtn.addEventListener("click", deleteReminder);

    // Notification bell click
    notificationBell.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleNotificationPanel();
    });

    // Clear notifications button
    clearNotifications.addEventListener("click", clearAllNotifications);

    // Close notification panel when clicking elsewhere
    document.addEventListener("click", closeNotificationPanel);

    // Toggle bill fields when reminder type changes
    reminderType.addEventListener("change", function() {
      toggleBillFields(this.value);
    });

    // AI Chat Event Listeners
    aiFabBtn.addEventListener('click', toggleAIChat);
    closeChatBtn.addEventListener('click', toggleAIChat);
    aiSendBtn.addEventListener('click', sendAIMessage);

    // Close AI chat when clicking outside
    document.addEventListener('click', (e) => {
      if (aiChatContainer.classList.contains('active') && 
          !aiChatContainer.contains(e.target) && 
          !aiFabBtn.contains(e.target)) {
        aiChatContainer.classList.remove('active');
      }
    });

    // Add some default account headers if none loaded
    if (accountHeaders.length === 0) {
      accountHeaders = [
        "Rent", "Utilities", "Groceries", "Transportation", 
        "Entertainment", "Healthcare", "Education", "Shopping"
      ];
    }

    // Initialize the dashboard with some sample data for demonstration
    function initializeSampleData() {
      document.getElementById("reminderDate").value = new Date().toISOString().split('T')[0];
      
      const user = auth.currentUser;
      if (user) {
        db.collection("users").doc(user.uid).collection("reminders").get()
          .then(snapshot => {
            if (snapshot.empty) {
              const today = new Date();
              const nextWeek = new Date(today);
              nextWeek.setDate(today.getDate() + 7);
              
              const sampleEvents = [
                {
                  title: "Team Meeting",
                  start: today.toISOString().split('T')[0],
                  color: "#4ECDC4"
                },
                {
                  title: "Project Deadline",
                  start: nextWeek.toISOString().split('T')[0],
                  color: "#FF6B6B"
                }
              ];
              
              calendar.addEventSource(sampleEvents);
            }
          });
      }
    }

    // Initialize sample data when page loads
    window.addEventListener('load', initializeSampleData);

    // Make functions available globally for HTML onclick handlers
    window.openExpensePopup = openExpensePopup;
    window.closeExpensePopup = closeExpensePopup;
    window.closeReportPopup = closeReportPopup;
    window.closeTransactionTypePopup = closeTransactionTypePopup;
    window.closeReminderModal = closeReminderModal;
    window.closeReminderDetailModal = closeReminderDetailModal;
    window.openBudgetPlanner = openBudgetPlanner;
    window.openGoalTracker = openGoalTracker;
    window.openBillReminders = openBillReminders;
    window.openFinancialInsights = openFinancialInsights;
    window.askAI = askAI;
    window.stayLoggedIn = stayLoggedIn;
    window.logoutNow = logoutNow;
    window.toggleAIChat = toggleAIChat;
    window.openBudgetModal = openBudgetModal;
    window.closeBudgetModal = closeBudgetModal;
    window.refreshBudgets = refreshBudgets;
  </script>
</body>
</html>