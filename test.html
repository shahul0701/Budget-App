<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* Color Variables */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #7209b7;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 8px;
            
            /* Transaction Type Colors */
            --income-color: #2ecc71;
            --expense-color: #e74c3c;
            --asset-color: #3498db;
            --liability-color: #f39c12;
            --equity-color: #9b59b6;
            --transfer-color: #1abc9c;
        }

        [data-theme="dark"] {
            --primary-color: #5a67d8;
            --secondary-color: #4c51bf;
            --success-color: #68d391;
            --danger-color: #fc8181;
            --warning-color: #f6ad55;
            --info-color: #b794f4;
            --dark-color: #2d3748;
            --light-color: #1a202c;
            --gray-color: #a0aec0;
            --border-color: #4a5568;
            --income-color: #48bb78;
            --expense-color: #f56565;
            --asset-color: #4299e1;
            --liability-color: #ed8936;
            --equity-color: #9f7aea;
            --transfer-color: #38b2ac;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left a {
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #userInitials {
            width: 40px;
            height: 40px;
            background: white;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        #username {
            font-weight: 500;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 50px;
            height: 26px;
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5px;
        }

        .theme-toggle i {
            font-size: 12px;
            z-index: 2;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        [data-theme="dark"] .theme-toggle::before {
            transform: translateX(24px);
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .primary-btn {
            background: var(--primary-color);
            color: white;
        }

        .primary-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .secondary-btn {
            background: var(--gray-color);
            color: white;
        }

        .secondary-btn:hover {
            background: #5a6268;
        }

        .success-btn {
            background: var(--success-color);
            color: white;
        }

        .danger-btn {
            background: var(--danger-color);
            color: white;
        }

        .warning-btn {
            background: var(--warning-color);
            color: white;
        }

        .info-btn {
            background: var(--info-color);
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-title h1 {
            color: var(--primary-color);
            font-size: 2rem;
        }

        .dashboard-title p {
            color: var(--gray-color);
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Quick Stats Cards */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s;
        }

        [data-theme="dark"] .stat-card {
            background: var(--dark-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.income {
            border-left-color: var(--income-color);
        }

        .stat-card.expense {
            border-left-color: var(--expense-color);
        }

        .stat-card.balance {
            border-left-color: var(--success-color);
        }

        .stat-card.transactions {
            border-left-color: var(--info-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Bank Balances Section */
        .bank-balances-section {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .bank-balances-section {
            background: var(--dark-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bank-balances-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .bank-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--radius);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .bank-card {
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }

        .bank-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-color);
        }

        .bank-card .bank-name {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .bank-card .bank-name h4 {
            color: var(--dark-color);
            font-size: 1.1rem;
        }

        [data-theme="dark"] .bank-card .bank-name h4 {
            color: white;
        }

        .bank-balance {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .positive {
            color: var(--income-color);
        }

        .negative {
            color: var(--expense-color);
        }

        .bank-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 10px;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .filter-section {
            background: var(--dark-color);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        [data-theme="dark"] .filter-group label {
            color: white;
        }

        select, input, textarea {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--light-color);
            color: var(--dark-color);
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        [data-theme="dark"] select,
        [data-theme="dark"] input,
        [data-theme="dark"] textarea {
            background: #2d3748;
            color: white;
            border-color: #4a5568;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Table Section */
        .table-section {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        [data-theme="dark"] .table-section {
            background: var(--dark-color);
        }

        .table-responsive {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        [data-theme="dark"] tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .type-income { background: rgba(46, 204, 113, 0.1); color: var(--income-color); }
        .type-expense { background: rgba(231, 76, 60, 0.1); color: var(--expense-color); }
        .type-asset { background: rgba(52, 152, 219, 0.1); color: var(--asset-color); }
        .type-liability { background: rgba(243, 156, 18, 0.1); color: var(--liability-color); }
        .type-equity { background: rgba(155, 89, 182, 0.1); color: var(--equity-color); }
        .type-transfer { background: rgba(26, 188, 156, 0.1); color: var(--transfer-color); }

        .amount {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .amount-income { color: var(--income-color); }
        .amount-expense { color: var(--expense-color); }

        .attachment-cell {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-icon.view {
            background: var(--primary-color);
        }

        .btn-icon.download {
            background: var(--success-color);
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .action-cell {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination-btn {
            padding: 8px 16px;
            background: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-main:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(67, 97, 238, 0.4);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
        }

        .fab-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .fab-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            color: var(--dark-color);
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fab-item:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .modal-content {
            background: var(--dark-color);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        [data-theme="dark"] .form-group label {
            color: white;
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .auto-fill-btn {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 0.8rem;
            background: var(--info-color);
        }

        .auto-fill-btn:hover {
            background: #5a189a;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 25px;
            border-top: 1px solid var(--border-color);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auto-fill Suggestions */
        .suggestions-dropdown {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
            display: none;
        }

        [data-theme="dark"] .suggestions-dropdown {
            background: var(--dark-color);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .suggestion-item:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        [data-theme="dark"] .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Transaction Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .bank-balances-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        [data-theme="dark"] .dropdown-menu {
            background: var(--dark-color);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--dark-color);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .dropdown-item {
            color: white;
        }

        .dropdown-item:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        [data-theme="dark"] .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <a href="home.html">
                <i class="fas fa-home"></i> Expense Tracker Pro
            </a>
        </div>
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
            </button>
            <div class="user-info">
                <div id="userInitials">U</div>
                <div id="username">User</div>
            </div>
            <button id="logoutBtn" class="danger-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1><i class="fas fa-chart-line"></i> Financial Dashboard</h1>
                <p>Track your income, expenses, and bank balances in real-time</p>
            </div>
            <div class="action-buttons">
                <button id="exportBtn" class="success-btn">
                    <i class="fas fa-file-export"></i> Export CSV
                </button>
                <button id="importBtn" class="warning-btn">
                    <i class="fas fa-file-import"></i> Import CSV
                </button>
                <button id="reconcileBtn" class="info-btn">
                    <i class="fas fa-balance-scale"></i> Reconcile
                </button>
                <button id="coaBtn" class="secondary-btn">
                    <i class="fas fa-book"></i> COA
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats" id="quickStats">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- Bank Balances -->
        <div class="bank-balances-section">
            <div class="section-header">
                <h3><i class="fas fa-university"></i> Bank Balances</h3>
                <div>
                    <button id="hideBalancesBtn" class="secondary-btn">
                        <i class="fas fa-eye-slash"></i> Hide
                    </button>
                    <button id="addBankBtn" class="primary-btn">
                        <i class="fas fa-plus"></i> Add Bank
                    </button>
                </div>
            </div>
            <div class="bank-balances-grid" id="bankBalances">
                <!-- Bank balances will be populated by JavaScript -->
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label><i class="fas fa-calendar"></i> Date Range</label>
                    <select id="dateRange">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Transaction Type</label>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                        <option value="transfer">Transfer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-bank"></i> Bank Account</label>
                    <select id="bankFilter">
                        <option value="all">All Banks</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-tag"></i> Category</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-search"></i> Search</label>
                    <input type="text" id="searchInput" placeholder="Search description or notes...">
                </div>
            </div>
            <div class="filter-actions">
                <button id="clearFiltersBtn" class="secondary-btn">
                    <i class="fas fa-times"></i> Clear
                </button>
                <button id="applyFiltersBtn" class="primary-btn">
                    <i class="fas fa-check"></i> Apply Filters
                </button>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="table-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Transactions</h3>
                <div id="summaryStats">
                    <!-- Summary stats will be populated here -->
                </div>
            </div>
            <div class="table-responsive">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Voucher #</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Account Header</th>
                            <th>Bank/Mode</th>
                            <th>Type</th>
                            <th>Income</th>
                            <th>Expense</th>
                            <th>Description</th>
                            <th>Notes</th>
                            <th>Balance</th>
                            <th>Attachment</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Transactions will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination">
                <!-- Pagination will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <button class="fab-item" id="fabQuickAdd" title="Quick Add">
                <i class="fas fa-bolt"></i>
            </button>
            <button class="fab-item" id="fabImport" title="Import">
                <i class="fas fa-upload"></i>
            </button>
            <button class="fab-item" id="fabExport" title="Export">
                <i class="fas fa-download"></i>
            </button>
            <button class="fab-item" id="fabReport" title="Reports">
                <i class="fas fa-chart-bar"></i>
            </button>
        </div>
        <button class="fab-main" id="fabMain">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-money-bill-wave"></i> Add Transaction</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label><i class="fas fa-hashtag"></i> Voucher Number <span class="required">*</span></label>
                            <input type="text" id="voucherNumber" required>
                            <button type="button" class="auto-fill-btn" onclick="generateVoucherNumber()">
                                <i class="fas fa-magic"></i> Auto-generate
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Date <span class="required">*</span></label>
                            <input type="date" id="transactionDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Time</label>
                            <input type="time" id="transactionTime">
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Account Header <span class="required">*</span></label>
                            <select id="accountHeader" required>
                                <option value="">Select Account</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-exchange-alt"></i> Mode <span class="required">*</span></label>
                            <select id="transactionMode" required>
                                <option value="">Select Mode</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank">Bank</option>
                                <option value="Transfer">Transfer</option>
                                <option value="Card">Card</option>
                                <option value="Digital">Digital</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="bankGroup" style="display: none;">
                            <label><i class="fas fa-university"></i> Bank Name</label>
                            <select id="bankName">
                                <option value="">Select Bank</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="transferGroup" style="display: none;">
                            <label><i class="fas fa-arrow-right"></i> To Bank</label>
                            <select id="toBank">
                                <option value="">Select Destination Bank</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-receipt"></i> Voucher Type</label>
                            <select id="voucherType">
                                <option value="">Select Type</option>
                                <option value="Payment">Payment</option>
                                <option value="Receipt">Receipt</option>
                                <option value="Journal">Journal</option>
                                <option value="Contra">Contra</option>
                                <option value="Sales">Sales</option>
                                <option value="Purchase">Purchase</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-chart-pie"></i> Transaction Type <span class="required">*</span></label>
                            <select id="transactionType" required>
                                <option value="">Select Type</option>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                                <option value="Asset">Asset</option>
                                <option value="Liability">Liability</option>
                                <option value="Equity">Equity</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-money-bill-wave"></i> Amount <span class="required">*</span></label>
                            <input type="number" id="amount" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-dollar-sign"></i> Currency</label>
                            <select id="currency">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="INR">INR</option>
                                <option value="AUD">AUD</option>
                                <option value="CAD">CAD</option>
                                <option value="JPY">JPY</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-file-alt"></i> Description</label>
                            <textarea id="description" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-sticky-note"></i> Notes</label>
                            <textarea id="notes" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-paperclip"></i> Attachment</label>
                            <input type="file" id="attachment" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt">
                            <div id="attachmentPreview" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-check-circle"></i> Status</label>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="reconciled">
                                    <span>Reconciled</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="verified">
                                    <span>Verified</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="cancelBtn" class="secondary-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" id="saveBtn" class="primary-btn">
                            <i class="fas fa-save"></i> Save Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-import"></i> Import Transactions</h2>
                <button class="close-btn" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 40px 20px;">
                    <i class="fas fa-file-csv" style="font-size: 64px; color: var(--success-color); margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 15px;">Import CSV File</h3>
                    <p style="color: var(--gray-color); margin-bottom: 25px;">
                        Upload a CSV file containing your transactions. The file should include headers matching your transaction structure.
                    </p>
                    
                    <div style="border: 2px dashed var(--border-color); border-radius: var(--radius); padding: 40px; margin: 20px 0;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--primary-color); margin-bottom: 15px;"></i>
                        <p style="margin-bottom: 20px;">Drag & drop your CSV file here</p>
                        <label class="primary-btn" style="cursor: pointer;">
                            <i class="fas fa-upload"></i> Browse Files
                            <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        </label>
                        <p id="fileName" style="margin-top: 15px; color: var(--gray-color);"></p>
                    </div>
                    
                    <div id="importPreview" style="display: none; margin: 20px 0;"></div>
                    
                    <div style="margin-top: 30px;">
                        <a href="#" id="downloadTemplate" style="color: var(--primary-color); text-decoration: none;">
                            <i class="fas fa-download"></i> Download CSV Template
                        </a>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancelImportBtn" class="secondary-btn">
                        Cancel
                    </button>
                    <button type="button" id="processImportBtn" class="primary-btn" disabled>
                        <i class="fas fa-cogs"></i> Process Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color: white; margin-top: 20px; font-size: 1.1rem;" id="loadingText">Loading...</div>
    </div>

<script type="module">
        // Firebase Configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp,
            Timestamp,
            getDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.appspot.com",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Variables
        let currentUser = null;
        let transactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 15;
        let bankBalances = {};
        let autoFillSuggestions = {};
        let isBalanceHidden = false;

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInitials = document.getElementById('userInitials');
        const username = document.getElementById('username');
        const fabMain = document.getElementById('fabMain');
        const fabMenu = document.getElementById('fabMenu');
        const transactionModal = document.getElementById('transactionModal');
        const modalTitle = document.getElementById('modalTitle');
        const transactionForm = document.getElementById('transactionForm');
        const transactionId = document.getElementById('transactionId');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const quickStats = document.getElementById('quickStats');
        const bankBalancesGrid = document.getElementById('bankBalances');
        const transactionsBody = document.getElementById('transactionsBody');
        const pagination = document.getElementById('pagination');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importModal = document.getElementById('importModal');
        const csvFile = document.getElementById('csvFile');
        const processImportBtn = document.getElementById('processImportBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const closeImportModal = document.getElementById('closeImportModal');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // Form Elements
        const voucherNumber = document.getElementById('voucherNumber');
        const transactionDate = document.getElementById('transactionDate');
        const transactionTime = document.getElementById('transactionTime');
        const accountHeader = document.getElementById('accountHeader');
        const transactionMode = document.getElementById('transactionMode');
        const bankGroup = document.getElementById('bankGroup');
        const bankName = document.getElementById('bankName');
        const transferGroup = document.getElementById('transferGroup');
        const toBank = document.getElementById('toBank');
        const voucherType = document.getElementById('voucherType');
        const transactionType = document.getElementById('transactionType');
        const amount = document.getElementById('amount');
        const currency = document.getElementById('currency');
        const description = document.getElementById('description');
        const notes = document.getElementById('notes');
        const attachment = document.getElementById('attachment');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const reconciled = document.getElementById('reconciled');
        const verified = document.getElementById('verified');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeEventListeners();
            checkAuthState();
        });

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }

        // Event Listeners
        function initializeEventListeners() {
            // Logout
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    window.location.href = 'index.html';
                });
            });

            // FAB Menu
            fabMain.addEventListener('click', () => {
                fabMenu.classList.toggle('active');
            });

            // Close FAB menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!fabMain.contains(e.target) && !fabMenu.contains(e.target)) {
                    fabMenu.classList.remove('active');
                }
            });

            // Transaction Modal
            document.getElementById('fabQuickAdd').addEventListener('click', openAddModal);
            closeModal.addEventListener('click', () => transactionModal.style.display = 'none');
            cancelBtn.addEventListener('click', () => transactionModal.style.display = 'none');

            // Transaction Form
            transactionForm.addEventListener('submit', saveTransaction);

            // Mode change
            transactionMode.addEventListener('change', handleModeChange);

            // Import/Export
            exportBtn.addEventListener('click', exportToCSV);
            importBtn.addEventListener('click', () => importModal.style.display = 'flex');
            document.getElementById('fabImport').addEventListener('click', () => importModal.style.display = 'flex');
            document.getElementById('fabExport').addEventListener('click', exportToCSV);

            // Import Modal
            closeImportModal.addEventListener('click', () => importModal.style.display = 'none');
            cancelImportBtn.addEventListener('click', () => importModal.style.display = 'none');
            csvFile.addEventListener('change', handleFileSelect);
            processImportBtn.addEventListener('click', processCSVImport);

            // Download template
            document.getElementById('downloadTemplate').addEventListener('click', (e) => {
                e.preventDefault();
                downloadCSVTemplate();
            });

            // Auto-fill buttons
            document.querySelectorAll('.auto-fill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.target.closest('button').onclick) {
                        e.target.closest('button').onclick();
                    }
                });
            });

            // Hide balances
            document.getElementById('hideBalancesBtn').addEventListener('click', toggleBalanceVisibility);
        }

        // Authentication
        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    updateUserInfo(user);
                    await loadInitialData();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        function updateUserInfo(user) {
            const displayName = user.displayName || user.email || 'User';
            username.textContent = displayName;
            userInitials.textContent = displayName.charAt(0).toUpperCase();
        }

        // Load Initial Data
        async function loadInitialData() {
            showLoading('Loading your financial data...');
            
            try {
                // Load accounts
                await loadAccounts();
                
                // Load categories
                await loadCategories();
                
                // Load transactions
                await loadTransactions();
                
                // Load bank balances
                await calculateBankBalances();
                
                // Update UI
                updateQuickStats();
                updateBankBalancesDisplay();
                updateFilters();
                renderTransactions();
                
            } catch (error) {
                console.error('Error loading data:', error);
                Swal.fire('Error', 'Failed to load data. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load Accounts
        async function loadAccounts() {
            try {
                const accountsRef = collection(db, 'users', currentUser.uid, 'chartOfAccounts');
                const snapshot = await getDocs(accountsRef);
                
                // Clear existing options
                accountHeader.innerHTML = '<option value="">Select Account</option>';
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="all">All Categories</option>';
                
                const categories = new Set();
                
                snapshot.forEach(doc => {
                    const account = doc.data();
                    
                    // Add to account header dropdown
                    const option = document.createElement('option');
                    option.value = account.name;
                    option.textContent = `${account.name} (${account.type})`;
                    accountHeader.appendChild(option);
                    
                    // Collect categories
                    if (account.category) {
                        categories.add(account.category);
                    }
                });
                
                // Add categories to filter
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                
                // Load banks
                await loadBanks();
                
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        // Load Banks
        async function loadBanks() {
            try {
                const banksRef = collection(db, 'users', currentUser.uid, 'banks');
                const snapshot = await getDocs(banksRef);
                
                // Clear existing options
                bankName.innerHTML = '<option value="">Select Bank</option>';
                toBank.innerHTML = '<option value="">Select Destination Bank</option>';
                const bankFilter = document.getElementById('bankFilter');
                bankFilter.innerHTML = '<option value="all">All Banks</option>';
                
                snapshot.forEach(doc => {
                    const bank = doc.data();
                    
                    // Add to bank name dropdown
                    const option1 = document.createElement('option');
                    option1.value = bank.name;
                    option1.textContent = `${bank.name} (${bank.accountNumber || ''})`;
                    bankName.appendChild(option1);
                    
                    // Add to transfer dropdown
                    const option2 = document.createElement('option');
                    option2.value = bank.name;
                    option2.textContent = `${bank.name} (${bank.accountNumber || ''})`;
                    toBank.appendChild(option2);
                    
                    // Add to filter
                    const option3 = document.createElement('option');
                    option3.value = bank.name;
                    option3.textContent = bank.name;
                    bankFilter.appendChild(option3);
                });
                
            } catch (error) {
                console.error('Error loading banks:', error);
            }
        }

        // Load Categories
        async function loadCategories() {
            try {
                const categoriesRef = collection(db, 'users', currentUser.uid, 'categories');
                const snapshot = await getDocs(categoriesRef);
                
                autoFillSuggestions = {};
                
                snapshot.forEach(doc => {
                    const category = doc.data();
                    if (!autoFillSuggestions[category.type]) {
                        autoFillSuggestions[category.type] = [];
                    }
                    autoFillSuggestions[category.type].push(category.name);
                });
                
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load Transactions
        async function loadTransactions() {
            try {
                const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
                const q = query(transactionsRef, orderBy('DATE', 'desc'), orderBy('TIME', 'desc'));
                const snapshot = await getDocs(q);
                
                transactions = [];
                snapshot.forEach(doc => {
                    const transaction = doc.data();
                    transaction.id = doc.id;
                    transaction.DATE = transaction.DATE || '';
                    transaction.TIME = transaction.TIME || '';
                    transaction.INCOME = parseFloat(transaction.INCOME) || 0;
                    transaction.EXPENSE = parseFloat(transaction.EXPENSE) || 0;
                    transaction.BALANCE = parseFloat(transaction.BALANCE) || 0;
                    transactions.push(transaction);
                });
                
                filteredTransactions = [...transactions];
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                throw error;
            }
        }

        // Calculate Bank Balances
        async function calculateBankBalances() {
            try {
                bankBalances = {};
                const banksRef = collection(db, 'users', currentUser.uid, 'banks');
                const banksSnapshot = await getDocs(banksRef);
                
                // Initialize all banks with zero balance
                banksSnapshot.forEach(doc => {
                    const bank = doc.data();
                    bankBalances[bank.name] = {
                        balance: 0,
                        income: 0,
                        expense: 0,
                        lastUpdated: new Date().toISOString()
                    };
                });
                
                // Add cash as a "bank"
                bankBalances['Cash'] = {
                    balance: 0,
                    income: 0,
                    expense: 0,
                    lastUpdated: new Date().toISOString()
                };
                
                // Calculate balances from transactions
                transactions.forEach(transaction => {
                    const bankKey = transaction.BANK_NAME || 'Cash';
                    const income = transaction.INCOME || 0;
                    const expense = transaction.EXPENSE || 0;
                    
                    if (!bankBalances[bankKey]) {
                        bankBalances[bankKey] = {
                            balance: 0,
                            income: 0,
                            expense: 0,
                            lastUpdated: new Date().toISOString()
                        };
                    }
                    
                    bankBalances[bankKey].balance += income - expense;
                    bankBalances[bankKey].income += income;
                    bankBalances[bankKey].expense += expense;
                });
                
            } catch (error) {
                console.error('Error calculating bank balances:', error);
            }
        }

        // Update Quick Stats
        function updateQuickStats() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalBalance = 0;
            
            transactions.forEach(transaction => {
                totalIncome += transaction.INCOME;
                totalExpense += transaction.EXPENSE;
            });
            
            totalBalance = totalIncome - totalExpense;
            
            quickStats.innerHTML = `
                <div class="stat-card income fade-in">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" style="color: var(--income-color);">$${totalIncome.toFixed(2)}</div>
                    <div class="stat-meta">${transactions.filter(t => t.INCOME > 0).length} transactions</div>
                </div>
                <div class="stat-card expense fade-in">
                    <div class="stat-label">Total Expense</div>
                    <div class="stat-value" style="color: var(--expense-color);">$${totalExpense.toFixed(2)}</div>
                    <div class="stat-meta">${transactions.filter(t => t.EXPENSE > 0).length} transactions</div>
                </div>
                <div class="stat-card balance fade-in">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" style="color: ${totalBalance >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">$${totalBalance.toFixed(2)}</div>
                    <div class="stat-meta">${transactions.length} total transactions</div>
                </div>
                <div class="stat-card transactions fade-in">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value" style="color: var(--info-color);">$${(totalIncome - totalExpense).toFixed(2)}</div>
                    <div class="stat-meta">${new Date().toLocaleString('default', { month: 'long' })} performance</div>
                </div>
            `;
        }

        // Update Bank Balances Display
        function updateBankBalancesDisplay() {
            bankBalancesGrid.innerHTML = '';
            
            Object.entries(bankBalances).forEach(([bankName, data]) => {
                const bankCard = document.createElement('div');
                bankCard.className = 'bank-card fade-in';
                
                const balanceDisplay = isBalanceHidden ? '' : `$${data.balance.toFixed(2)}`;
                const incomeDisplay = isBalanceHidden ? '' : `$${data.income.toFixed(2)}`;
                const expenseDisplay = isBalanceHidden ? '' : `$${data.expense.toFixed(2)}`;
                
                bankCard.innerHTML = `
                    <div class="bank-name">
                        <h4><i class="fas fa-university"></i> ${escapeHtml(bankName)}</h4>
                        <span class="type-badge ${data.balance >= 0 ? 'type-income' : 'type-expense'}">
                            ${data.balance >= 0 ? 'Positive' : 'Negative'}
                        </span>
                    </div>
                    <div class="bank-balance ${data.balance >= 0 ? 'positive' : 'negative'}">
                        ${balanceDisplay}
                    </div>
                    <div class="bank-meta">
                        <span><i class="fas fa-arrow-up" style="color: var(--income-color);"></i> ${incomeDisplay}</span>
                        <span><i class="fas fa-arrow-down" style="color: var(--expense-color);"></i> ${expenseDisplay}</span>
                    </div>
                `;
                
                bankBalancesGrid.appendChild(bankCard);
            });
        }

        // Toggle Balance Visibility
        function toggleBalanceVisibility() {
            isBalanceHidden = !isBalanceHidden;
            const btn = document.getElementById('hideBalancesBtn');
            btn.innerHTML = isBalanceHidden ? 
                '<i class="fas fa-eye"></i> Show' : 
                '<i class="fas fa-eye-slash"></i> Hide';
            updateBankBalancesDisplay();
        }

        // Update Filters
        function updateFilters() {
            // Already populated in loadAccounts and loadBanks
        }

        // Render Transactions
        function renderTransactions() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(start, end);
            
            transactionsBody.innerHTML = '';
            
            if (pageTransactions.length === 0) {
                transactionsBody.innerHTML = `
                    <tr>
                        <td colspan="14" style="text-align: center; padding: 40px; color: var(--gray-color);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <h3>No transactions found</h3>
                            <p>Try adjusting your filters or add a new transaction</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'slide-in';
                
                // Format date
                const date = transaction.DATE ? new Date(transaction.DATE).toLocaleDateString() : '';
                
                // Type badge
                const typeClass = `type-${transaction.TYPE?.toLowerCase() || 'expense'}`;
                const typeBadge = `<span class="type-badge ${typeClass}">${transaction.TYPE || 'Expense'}</span>`;
                
                // Amount display
                const amountClass = transaction.INCOME > 0 ? 'amount-income' : 'amount-expense';
                const amountValue = transaction.INCOME > 0 ? transaction.INCOME : transaction.EXPENSE;
                const amountDisplay = `<span class="amount ${amountClass}">$${amountValue.toFixed(2)}</span>`;
                
                // Attachment
                let attachmentHtml = '<span style="color: var(--gray-color);">None</span>';
                if (transaction.ATTACHMENT) {
                    const fileName = transaction.ATTACHMENT.split('/').pop();
                    const shortName = fileName.length > 20 ? fileName.substring(0, 17) + '...' : fileName;
                    attachmentHtml = `
                        <div class="attachment-cell">
                            <a href="${escapeHtml(transaction.ATTACHMENT)}" target="_blank" class="btn-icon view" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="${escapeHtml(transaction.ATTACHMENT)}" download class="btn-icon download" title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                            <small>${escapeHtml(shortName)}</small>
                        </div>
                    `;
                }
                
                // Status
                const statusHtml = transaction.RECONCILED ? 
                    '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Reconciled</span>' :
                    '<span style="color: var(--warning-color);"><i class="fas fa-clock"></i> Pending</span>';
                
                row.innerHTML = `
                    <td>${escapeHtml(transaction.SINO || '')}</td>
                    <td>${date}</td>
                    <td>${escapeHtml(transaction.TIME || '')}</td>
                    <td>${escapeHtml(transaction.ACCOUNT_HEADER || '')}</td>
                    <td>${escapeHtml(transaction.BANK_NAME || transaction.MODE || '')}</td>
                    <td>${typeBadge}</td>
                    <td>${transaction.INCOME > 0 ? `$${transaction.INCOME.toFixed(2)}` : ''}</td>
                    <td>${transaction.EXPENSE > 0 ? `$${transaction.EXPENSE.toFixed(2)}` : ''}</td>
                    <td>${escapeHtml(transaction.DESCRIPTION || '')}</td>
                    <td>${escapeHtml(transaction.NOTES || '')}</td>
                    <td><strong>$${transaction.BALANCE.toFixed(2)}</strong></td>
                    <td>${attachmentHtml}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <div class="action-cell">
                            <button class="action-btn primary-btn edit-btn" data-id="${transaction.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn danger-btn delete-btn" data-id="${transaction.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                transactionsBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    openEditModal(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('button').dataset.id;
                    deleteTransaction(id);
                });
            });
            
            updatePaginationControls();
        }

        // Update Pagination Controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `pagination-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTransactions();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderTransactions();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `pagination-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTransactions();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // Open Add Modal
        function openAddModal() {
            modalTitle.innerHTML = '<i class="fas fa-plus"></i> Add New Transaction';
            transactionForm.reset();
            transactionId.value = '';
            
            // Set default values
            transactionDate.value = new Date().toISOString().split('T')[0];
            transactionTime.value = new Date().toTimeString().slice(0, 5);
            generateVoucherNumber();
            
            // Clear attachment preview
            attachmentPreview.innerHTML = '';
            
            transactionModal.style.display = 'flex';
        }

        // Open Edit Modal
        async function openEditModal(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Transaction';
            transactionForm.reset();
            transactionId.value = id;
            
            // Fill form with transaction data
            voucherNumber.value = transaction.SINO || '';
            transactionDate.value = transaction.DATE || '';
            transactionTime.value = transaction.TIME || '';
            accountHeader.value = transaction.ACCOUNT_HEADER || '';
            transactionMode.value = transaction.MODE || '';
            bankName.value = transaction.BANK_NAME || '';
            voucherType.value = transaction.VOUCHER_TYPE || '';
            transactionType.value = transaction.TYPE || '';
            amount.value = transaction.INCOME > 0 ? transaction.INCOME : transaction.EXPENSE;
            currency.value = transaction.CURRENCY || 'USD';
            description.value = transaction.DESCRIPTION || '';
            notes.value = transaction.NOTES || '';
            reconciled.checked = transaction.RECONCILED || false;
            verified.checked = transaction.VERIFIED || false;
            
            // Handle mode change
            handleModeChange();
            
            // Show attachment preview if exists
            if (transaction.ATTACHMENT) {
                const fileName = transaction.ATTACHMENT.split('/').pop();
                attachmentPreview.innerHTML = `
                    <div style="background: var(--light-color); padding: 10px; border-radius: var(--radius);">
                        <i class="fas fa-paperclip"></i> 
                        <a href="${escapeHtml(transaction.ATTACHMENT)}" target="_blank">${escapeHtml(fileName)}</a>
                        <button type="button" onclick="removeAttachment()" style="margin-left: 10px; color: var(--danger-color); background: none; border: none; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            
            transactionModal.style.display = 'flex';
        }

        // Handle Mode Change
        function handleModeChange() {
            const mode = transactionMode.value;
            
            if (mode === 'Bank') {
                bankGroup.style.display = 'flex';
                transferGroup.style.display = 'none';
            } else if (mode === 'Transfer') {
                bankGroup.style.display = 'flex';
                transferGroup.style.display = 'flex';
            } else {
                bankGroup.style.display = 'none';
                transferGroup.style.display = 'none';
            }
        }

        // Generate Voucher Number
        function generateVoucherNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            voucherNumber.value = `VOUCHER-${year}${month}${day}-${random}`;
        }

        // Save Transaction
        async function saveTransaction(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            showLoading('Saving transaction...');
            
            try {
                const transactionData = {
                    DATE: transactionDate.value,
                    TIME: transactionTime.value,
                    SINO: voucherNumber.value,
                    ACCOUNT_HEADER: accountHeader.value,
                    MODE: transactionMode.value,
                    BANK_NAME: transactionMode.value === 'Cash' ? '' : bankName.value,
                    VOUCHER_TYPE: voucherType.value,
                    TYPE: transactionType.value,
                    INCOME: transactionType.value === 'Income' ? parseFloat(amount.value) : 0,
                    EXPENSE: transactionType.value !== 'Income' ? parseFloat(amount.value) : 0,
                    DESCRIPTION: description.value,
                    NOTES: notes.value,
                    CURRENCY: currency.value,
                    ATTACHMENT: attachmentPreview.querySelector('a')?.href || '',
                    RECONCILED: reconciled.checked,
                    VERIFIED: verified.checked,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                // Handle transfer
                if (transactionMode.value === 'Transfer') {
                    transactionData.TRANSFER_TO_BANK = toBank.value;
                    transactionData.DESCRIPTION = `Transfer to ${toBank.value} - ${description.value || 'No description'}`;
                }
                
                // Calculate balance
                const bankKey = transactionData.BANK_NAME || 'Cash';
                const currentBalance = bankBalances[bankKey]?.balance || 0;
                const amountChange = transactionData.INCOME - transactionData.EXPENSE;
                
                // If editing, subtract old amount first
                if (transactionId.value) {
                    const oldTransaction = transactions.find(t => t.id === transactionId.value);
                    if (oldTransaction) {
                        const oldBankKey = oldTransaction.BANK_NAME || 'Cash';
                        const oldAmountChange = oldTransaction.INCOME - oldTransaction.EXPENSE;
                        transactionData.BALANCE = (bankBalances[oldBankKey]?.balance || 0) - oldAmountChange + amountChange;
                    }
                } else {
                    transactionData.BALANCE = currentBalance + amountChange;
                }
                
                // Save to Firestore
                if (transactionId.value) {
                    // Update existing
                    const transactionRef = doc(db, 'users', currentUser.uid, 'transactions', transactionId.value);
                    await updateDoc(transactionRef, transactionData);
                    Swal.fire('Success', 'Transaction updated successfully!', 'success');
                } else {
                    // Add new
                    await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), transactionData);
                    Swal.fire('Success', 'Transaction added successfully!', 'success');
                }
                
                // Reload data
                await loadTransactions();
                await calculateBankBalances();
                updateQuickStats();
                updateBankBalancesDisplay();
                renderTransactions();
                
                // Close modal
                transactionModal.style.display = 'none';
                
            } catch (error) {
                console.error('Error saving transaction:', error);
                Swal.fire('Error', 'Failed to save transaction. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Validate Form
        function validateForm() {
            if (!voucherNumber.value.trim()) {
                Swal.fire('Error', 'Please enter a voucher number', 'error');
                return false;
            }
            
            if (!transactionDate.value) {
                Swal.fire('Error', 'Please select a date', 'error');
                return false;
            }
            
            if (!accountHeader.value) {
                Swal.fire('Error', 'Please select an account header', 'error');
                return false;
            }
            
            if (!transactionMode.value) {
                Swal.fire('Error', 'Please select a mode', 'error');
                return false;
            }
            
            if ((transactionMode.value === 'Bank' || transactionMode.value === 'Transfer') && !bankName.value) {
                Swal.fire('Error', 'Please select a bank', 'error');
                return false;
            }
            
            if (transactionMode.value === 'Transfer' && !toBank.value) {
                Swal.fire('Error', 'Please select destination bank', 'error');
                return false;
            }
            
            if (!transactionType.value) {
                Swal.fire('Error', 'Please select transaction type', 'error');
                return false;
            }
            
            if (!amount.value || parseFloat(amount.value) <= 0) {
                Swal.fire('Error', 'Please enter a valid amount', 'error');
                return false;
            }
            
            return true;
        }

        // Delete Transaction
        async function deleteTransaction(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (result.isConfirmed) {
                showLoading('Deleting transaction...');
                
                try {
                    await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
                    
                    await loadTransactions();
                    await calculateBankBalances();
                    updateQuickStats();
                    updateBankBalancesDisplay();
                    renderTransactions();
                    
                    Swal.fire('Deleted!', 'Transaction has been deleted.', 'success');
                } catch (error) {
                    console.error('Error deleting transaction:', error);
                    Swal.fire('Error', 'Failed to delete transaction', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        // Export to CSV
        function exportToCSV() {
            showLoading('Preparing CSV export...');
            
            try {
                // Prepare CSV headers
                const headers = [
                    'DATE', 'SINO', 'ACCOUNT_HEADER', 'BANK_NAME', 'VOUCHER_TYPE', 'TYPE',
                    'INCOME', 'EXPENSE', 'BALANCE', 'DESCRIPTION', 'NOTES', 'ATTACHMENT',
                    'CURRENCY', 'TIME', 'RECONCILED', 'VERIFIED'
                ];
                
                // Prepare CSV rows
                const rows = filteredTransactions.map(transaction => [
                    transaction.DATE || '',
                    transaction.SINO || '',
                    transaction.ACCOUNT_HEADER || '',
                    transaction.BANK_NAME || '',
                    transaction.VOUCHER_TYPE || '',
                    transaction.TYPE || '',
                    transaction.INCOME || 0,
                    transaction.EXPENSE || 0,
                    transaction.BALANCE || 0,
                    transaction.DESCRIPTION || '',
                    transaction.NOTES || '',
                    transaction.ATTACHMENT || '', // This will show the link in CSV
                    transaction.CURRENCY || 'USD',
                    transaction.TIME || '',
                    transaction.RECONCILED ? 'TRUE' : 'FALSE',
                    transaction.VERIFIED ? 'TRUE' : 'FALSE'
                ]);
                
                // Create CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        // Escape commas and quotes
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Swal.fire('Success', 'CSV exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                Swal.fire('Error', 'Failed to export CSV', 'error');
            } finally {
                hideLoading();
            }
        }

        // Handle File Select for Import
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileName = document.getElementById('fileName');
            fileName.textContent = `Selected: ${file.name}`;
            processImportBtn.disabled = false;
            
            // Preview first few rows
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').slice(0, 6); // First 6 lines
                
                const preview = document.getElementById('importPreview');
                preview.innerHTML = `
                    <h4>Preview:</h4>
                    <pre style="background: var(--light-color); padding: 15px; border-radius: var(--radius); overflow: auto; max-height: 200px;">${escapeHtml(lines.join('\n'))}</pre>
                `;
                preview.style.display = 'block';
            };
            reader.readAsText(file);
        }

        // Process CSV Import
        async function processCSVImport() {
            const file = csvFile.files[0];
            if (!file) return;
            
            showLoading('Processing CSV import...');
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has only headers');
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                const transactionsToImport = [];
                
                // Parse CSV rows
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const transaction = {};
                    
                    headers.forEach((header, index) => {
                        transaction[header] = values[index] || '';
                    });
                    
                    // Convert numeric fields
                    transaction.INCOME = parseFloat(transaction.INCOME) || 0;
                    transaction.EXPENSE = parseFloat(transaction.EXPENSE) || 0;
                    transaction.BALANCE = parseFloat(transaction.BALANCE) || 0;
                    
                    // Add metadata
                    transaction.userId = currentUser.uid;
                    transaction.createdAt = serverTimestamp();
                    transaction.updatedAt = serverTimestamp();
                    
                    transactionsToImport.push(transaction);
                }
                
                // Import to Firestore
                const batch = writeBatch(db);
                const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
                
                for (const transaction of transactionsToImport) {
                    const docRef = doc(transactionsRef);
                    batch.set(docRef, transaction);
                }
                
                await batch.commit();
                
                // Reload data
                await loadTransactions();
                await calculateBankBalances();
                updateQuickStats();
                updateBankBalancesDisplay();
                renderTransactions();
                
                // Close modal and reset
                importModal.style.display = 'none';
                csvFile.value = '';
                document.getElementById('fileName').textContent = '';
                document.getElementById('importPreview').style.display = 'none';
                processImportBtn.disabled = true;
                
                Swal.fire('Success', `Successfully imported ${transactionsToImport.length} transactions!`, 'success');
                
            } catch (error) {
                console.error('Error importing CSV:', error);
                Swal.fire('Error', `Failed to import CSV: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Parse CSV line with quoted values
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }

        // Download CSV Template
        function downloadCSVTemplate() {
            const template = `DATE,SINO,ACCOUNT_HEADER,BANK_NAME,VOUCHER_TYPE,TYPE,INCOME,EXPENSE,BALANCE,DESCRIPTION,NOTES,ATTACHMENT,CURRENCY,TIME,RECONCILED,VERIFIED
2024-12-25,001,Rent,AXIS,Payment,Expense,0,500,1500,Monthly rent payment,Additional notes,https://example.com/rent_receipt.pdf,USD,14:30,TRUE,FALSE
2024-12-26,002,Salary,Chase,Receipt,Income,3000,0,4500,Monthly salary,Bonus included,https://example.com/salary_slip.pdf,USD,09:00,TRUE,TRUE
2024-12-27,003,Groceries,Cash,Payment,Expense,0,150,4350,Weekly groceries,Discount applied,,USD,18:45,FALSE,FALSE`;
            
            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'transaction_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Loading Overlay
        function showLoading(message = 'Loading...') {
            loadingText.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Utility Functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Global functions for inline event handlers
        window.removeAttachment = function() {
            attachmentPreview.innerHTML = '';
        };

        window.generateVoucherNumber = generateVoucherNumber;
    </script>
</body>
</html>