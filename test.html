<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Budget & Forecasting Dashboard</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary-color: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a0ca3;
      --secondary-color: #7209b7;
      --accent-color: #f72585;
      --success-color: #4cc9f0;
      --warning-color: #f8961e;
      --danger-color: #f94144;
      --info-color: #43aa8b;
      
      --bg-primary: #0a0e17;
      --bg-secondary: #131827;
      --bg-card: #1a1f2e;
      --bg-hover: #222738;
      
      --text-primary: #ffffff;
      --text-secondary: #b0b7c3;
      --text-muted: #8a94a6;
      --text-light: #e2e8f0;
      
      --border-color: #2a3142;
      --border-light: #3a4255;
      --shadow-color: rgba(0, 0, 0, 0.3);
      
      --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      --gradient-success: linear-gradient(135deg, var(--success-color), #2a9d8f);
      --gradient-warning: linear-gradient(135deg, var(--warning-color), #e76f51);
      --gradient-danger: linear-gradient(135deg, var(--danger-color), #9d0208);
      --gradient-info: linear-gradient(135deg, var(--info-color), #2a9d8f);
    }

    /* Light mode variables */
    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #334155;
      
      --border-color: #e2e8f0;
      --border-light: #cbd5e1;
      --shadow-color: rgba(0, 0, 0, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      transition: all 0.3s ease;
      line-height: 1.6;
    }

    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }

    /* App container */
    .app-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    /* Top navigation */
    .top-nav {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 24px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px var(--shadow-color);
      transition: all 0.3s ease;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 22px;
      color: var(--text-primary);
    }

    .nav-brand i {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 24px;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Main layout */
    .dashboard-main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      min-height: calc(100vh - 120px);
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      padding: 24px;
      height: fit-content;
      position: sticky;
      top: 24px;
      box-shadow: 0 4px 20px var(--shadow-color);
      transition: all 0.3s ease;
    }

    .user-profile {
      text-align: center;
      padding: 24px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--gradient-primary);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      font-weight: 600;
      border: 4px solid var(--bg-card);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .user-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .user-email {
      font-size: 14px;
      color: var(--text-muted);
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .nav-item i {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Content area */
    .content-area {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Dashboard stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px var(--shadow-color);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      border-radius: 16px 16px 0 0;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px var(--shadow-color);
      border-color: var(--primary-light);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 20px;
      color: white;
    }

    .stat-title {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-change {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .stat-change.positive {
      color: var(--success-color);
    }

    .stat-change.negative {
      color: var(--danger-color);
    }

    /* Charts section */
    .charts-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .chart-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 20px var(--shadow-color);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-title i {
      color: var(--primary-color);
    }

    /* Progress tracking */
    .progress-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .progress-item {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .progress-item:hover {
      border-color: var(--primary-light);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .progress-category {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .progress-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .progress-bar {
      height: 12px;
      background: var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 12px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: 6px;
      position: relative;
      transition: width 1s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 50%, 
        transparent 100%);
      animation: shimmer 2s infinite;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Forecast cards */
    .forecast-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 24px;
    }

    .forecast-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .forecast-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(67, 97, 238, 0.1), 
        rgba(114, 9, 183, 0.1));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .forecast-card:hover::before {
      opacity: 1;
    }

    .forecast-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(67, 97, 238, 0.2);
    }

    .forecast-period {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .forecast-amount {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Insights grid */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-top: 24px;
    }

    .insight-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .insight-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px var(--shadow-color);
      border-color: var(--primary-light);
    }

    .insight-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 24px;
      color: white;
    }

    .insight-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .insight-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .insight-desc {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Alerts section */
    .alerts-section {
      margin-top: 24px;
    }

    .alert-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border-left: 6px solid;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      border-color: var(--primary-color);
    }

    .alert-card.critical {
      border-color: var(--danger-color);
      background: linear-gradient(45deg, 
        rgba(249, 65, 68, 0.1), 
        transparent);
    }

    .alert-card.warning {
      border-color: var(--warning-color);
      background: linear-gradient(45deg, 
        rgba(248, 150, 30, 0.1), 
        transparent);
    }

    .alert-card.info {
      border-color: var(--info-color);
      background: linear-gradient(45deg, 
        rgba(67, 170, 139, 0.1), 
        transparent);
    }

    .alert-card:hover {
      transform: translateX(4px);
    }

    /* Floating buttons */
    .floating-actions {
      position: fixed;
      right: 30px;
      bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }

    .floating-btn {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      border: none;
    }

    .floating-btn:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .floating-btn.primary {
      background: var(--gradient-primary);
    }

    .floating-btn.success {
      background: var(--gradient-success);
    }

    .floating-btn.warning {
      background: var(--gradient-warning);
    }

    .floating-btn.danger {
      background: var(--gradient-danger);
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-outline:hover {
      border-color: var(--primary-color);
      background: rgba(67, 97, 238, 0.1);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* Theme toggle */
    .theme-toggle {
      width: 50px;
      height: 26px;
      background: var(--border-color);
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: var(--gradient-primary);
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    [data-theme="light"] .theme-toggle::after {
      transform: translateX(24px);
    }

    /* Animations */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .fade-in {
      animation: fadeIn 0.6s ease forwards;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 14, 23, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-light);
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .insights-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .forecast-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .dashboard-main {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: static;
        height: auto;
      }
      
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .insights-grid {
        grid-template-columns: 1fr;
      }
      
      .forecast-cards {
        grid-template-columns: 1fr;
      }
      
      .app-container {
        padding: 12px;
      }
      
      .top-nav {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
    }

    /* Modal styles */
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      color: var(--text-primary);
    }

    .modal-header {
      border-bottom-color: var(--border-color);
      background: var(--gradient-primary);
      color: white;
      border-radius: 16px 16px 0 0;
      padding: 20px;
    }

    .modal-title {
      font-weight: 600;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      border-top-color: var(--border-color);
      padding: 20px;
    }

    /* Form controls */
    .form-control, .form-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 12px;
      padding: 12px 16px;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    /* Card hover effects */
    .hover-lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px var(--shadow-color);
    }

    /* Gradient text */
    .gradient-text {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Badges */
    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-primary {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary-color);
      border: 1px solid rgba(67, 97, 238, 0.3);
    }

    .badge-success {
      background: rgba(76, 201, 240, 0.2);
      color: var(--success-color);
      border: 1px solid rgba(76, 201, 240, 0.3);
    }

    .badge-warning {
      background: rgba(248, 150, 30, 0.2);
      color: var(--warning-color);
      border: 1px solid rgba(248, 150, 30, 0.3);
    }

    .badge-danger {
      background: rgba(249, 65, 68, 0.2);
      color: var(--danger-color);
      border: 1px solid rgba(249, 65, 68, 0.3);
    }

    /* Tooltips */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 8px;
    }

    /* Grid animations */
    .grid-item {
      animation: fadeIn 0.6s ease forwards;
      opacity: 0;
    }

    .grid-item:nth-child(1) { animation-delay: 0.1s; }
    .grid-item:nth-child(2) { animation-delay: 0.2s; }
    .grid-item:nth-child(3) { animation-delay: 0.3s; }
    .grid-item:nth-child(4) { animation-delay: 0.4s; }
    .grid-item:nth-child(5) { animation-delay: 0.5s; }
    .grid-item:nth-child(6) { animation-delay: 0.6s; }
  </style>
</head>
<body>
  <!-- Loading Backdrop -->
  <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
    <div class="text-center">
      <div class="loading-spinner mb-4"></div>
      <h4 id="backdropMessage" class="gradient-text">Loading Dashboard...</h4>
    </div>
  </div>

  <div class="app-container">
    <!-- Top Navigation -->
    <div class="top-nav fade-in">
      <div class="nav-brand">
        <i class="fas fa-chart-network"></i>
        <span>BudgetFlow Pro</span>
      </div>
      
      <div class="nav-actions">
        <button id="quickActionsBtn" class="btn btn-outline btn-sm" data-tooltip="Quick Actions">
          <i class="fas fa-bolt"></i>
        </button>
        <button id="notificationsBtn" class="btn btn-outline btn-sm" data-tooltip="Notifications">
          <i class="fas fa-bell"></i>
          <span class="badge badge-danger">3</span>
        </button>
        <div class="theme-toggle" id="themeToggle"></div>
        <button id="userMenuBtn" class="btn btn-primary btn-sm">
          <i class="fas fa-user-circle"></i>
          <span id="username">User</span>
        </button>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-main">
      <!-- Sidebar -->
      <div class="sidebar fade-in">
        <div class="user-profile">
          <div class="user-avatar" id="userInitials">U</div>
          <div class="user-name" id="userFullName">Welcome Back</div>
          <div class="user-email" id="userEmail">user@example.com</div>
        </div>

        <div class="nav-menu">
          <a href="#" class="nav-item active">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a href="#" class="nav-item" id="transactionsNav">
            <i class="fas fa-exchange-alt"></i>
            <span>Transactions</span>
          </a>
          <a href="#" class="nav-item" id="budgetsNav">
            <i class="fas fa-wallet"></i>
            <span>Budgets</span>
          </a>
          <a href="#" class="nav-item" id="reportsNav">
            <i class="fas fa-chart-bar"></i>
            <span>Reports</span>
          </a>
          <a href="#" class="nav-item" id="forecastNav">
            <i class="fas fa-crystal-ball"></i>
            <span>Forecast</span>
          </a>
          <a href="#" class="nav-item" id="accountsNav">
            <i class="fas fa-university"></i>
            <span>Accounts</span>
          </a>
          <a href="#" class="nav-item" id="settingsNav">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
        </div>

        <div class="mt-4 pt-4 border-top border-color">
          <button id="quickBudgetBtn" class="btn btn-primary w-100 mb-2">
            <i class="fas fa-magic"></i>
            Quick Budget
          </button>
          <button id="exportBtn" class="btn btn-outline w-100">
            <i class="fas fa-download"></i>
            Export Data
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card grid-item">
            <div class="stat-icon" style="background: var(--gradient-primary)">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-title">Total Balance</div>
            <div class="stat-value" id="totalBalance">$12,450.80</div>
            <div class="stat-change positive">
              <i class="fas fa-arrow-up"></i>
              <span>+12.5% this month</span>
            </div>
          </div>

          <div class="stat-card grid-item">
            <div class="stat-icon" style="background: var(--gradient-success)">
              <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-title">Monthly Income</div>
            <div class="stat-value" id="monthlyIncome">$4,850.00</div>
            <div class="stat-change positive">
              <i class="fas fa-arrow-up"></i>
              <span>+8.2% from last month</span>
            </div>
          </div>

          <div class="stat-card grid-item">
            <div class="stat-icon" style="background: var(--gradient-danger)">
              <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-title">Monthly Expenses</div>
            <div class="stat-value" id="monthlyExpenses">$3,250.75</div>
            <div class="stat-change negative">
              <i class="fas fa-arrow-down"></i>
              <span>-5.3% from last month</span>
            </div>
          </div>

          <div class="stat-card grid-item">
            <div class="stat-icon" style="background: var(--gradient-info)">
              <i class="fas fa-piggy-bank"></i>
            </div>
            <div class="stat-title">Monthly Savings</div>
            <div class="stat-value" id="monthlySavings">$1,599.25</div>
            <div class="stat-change positive">
              <i class="fas fa-arrow-up"></i>
              <span>+24.8% from last month</span>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
          <div class="chart-container fade-in">
            <div class="chart-header">
              <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                <span>Income vs Expenses Trend</span>
              </div>
              <select id="trendPeriod" class="form-select form-select-sm" style="width: auto;">
                <option value="6">Last 6 Months</option>
                <option value="12">Last 12 Months</option>
                <option value="24">Last 2 Years</option>
              </select>
            </div>
            <canvas id="incomeExpenseChart" height="300"></canvas>
          </div>

          <div class="chart-container fade-in">
            <div class="chart-header">
              <div class="chart-title">
                <i class="fas fa-chart-pie"></i>
                <span>Spending Distribution</span>
              </div>
              <select id="spendingPeriod" class="form-select form-select-sm" style="width: auto;">
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <canvas id="spendingChart" height="300"></canvas>
          </div>
        </div>

        <!-- Progress Tracking -->
        <div class="chart-container fade-in">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fas fa-tasks"></i>
              <span>Budget Progress</span>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline btn-sm active">This Month</button>
              <button class="btn btn-outline btn-sm">This Quarter</button>
              <button class="btn btn-outline btn-sm">This Year</button>
            </div>
          </div>
          <div class="progress-grid" id="progressContainer">
            <!-- Progress items will be populated here -->
          </div>
        </div>

        <!-- Insights Grid -->
        <div class="chart-container fade-in">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fas fa-lightbulb"></i>
              <span>Financial Insights</span>
            </div>
            <button id="refreshInsights" class="btn btn-outline btn-sm">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
          </div>
          <div class="insights-grid" id="insightsGrid">
            <!-- Insights will be populated here -->
          </div>
        </div>

        <!-- Forecast Section -->
        <div class="chart-container fade-in">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fas fa-crystal-ball"></i>
              <span>Financial Forecast</span>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline btn-sm active">3 Months</button>
              <button class="btn btn-outline btn-sm">6 Months</button>
              <button class="btn btn-outline btn-sm">12 Months</button>
            </div>
          </div>
          <div class="forecast-cards" id="forecastCards">
            <!-- Forecast cards will be populated here -->
          </div>
          <div class="mt-4">
            <canvas id="forecastChart" height="200"></canvas>
          </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section fade-in">
          <div class="chart-header mb-3">
            <div class="chart-title">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Recent Alerts</span>
            </div>
            <button id="viewAllAlerts" class="btn btn-outline btn-sm">
              View All
            </button>
          </div>
          <div id="alertsGrid">
            <!-- Alerts will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Actions -->
  <div class="floating-actions">
    <button class="floating-btn primary" id="addTransactionBtn" data-tooltip="Add Transaction">
      <i class="fas fa-plus"></i>
    </button>
    <button class="floating-btn success" id="aiAssistantBtn" data-tooltip="AI Assistant">
      <i class="fas fa-robot"></i>
    </button>
    <button class="floating-btn warning" id="quickReportBtn" data-tooltip="Quick Report">
      <i class="fas fa-chart-bar"></i>
    </button>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // State
    let currentUser = null;
    let allTransactions = [];
    let allBudgets = [];
    let allCategories = [];
    let allBanks = [];
    let allAlerts = [];
    let currentTheme = 'dark';
    
    // Chart instances
    let forecastChart = null;
    let spendingChart = null;
    let incomeExpenseChart = null;
    
    // DOM refs
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const userFullName = document.getElementById("userFullName");
    const userEmail = document.getElementById("userEmail");
    const initialsElem = document.getElementById("userInitials");
    const themeToggle = document.getElementById("themeToggle");
    const userMenuBtn = document.getElementById("userMenuBtn");
    
    // Navigation refs
    const transactionsNav = document.getElementById("transactionsNav");
    const budgetsNav = document.getElementById("budgetsNav");
    const reportsNav = document.getElementById("reportsNav");
    const forecastNav = document.getElementById("forecastNav");
    const accountsNav = document.getElementById("accountsNav");
    const settingsNav = document.getElementById("settingsNav");
    const quickBudgetBtn = document.getElementById("quickBudgetBtn");
    const exportBtn = document.getElementById("exportBtn");
    
    // Button refs
    const quickActionsBtn = document.getElementById("quickActionsBtn");
    const notificationsBtn = document.getElementById("notificationsBtn");
    const refreshInsights = document.getElementById("refreshInsights");
    const viewAllAlerts = document.getElementById("viewAllAlerts");
    const addTransactionBtn = document.getElementById("addTransactionBtn");
    const aiAssistantBtn = document.getElementById("aiAssistantBtn");
    const quickReportBtn = document.getElementById("quickReportBtn");

    // Initialize
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || "User";
        const email = user.email || "user@example.com";
        
        usernameElem.textContent = name.split(' ')[0];
        userFullName.textContent = `Welcome Back, ${name.split(' ')[0]}`;
        userEmail.textContent = email;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your financial dashboard...");
        
        try {
          loadThemePreference();
          await loadAllData();
          initializeCharts();
          updateDashboard();
          setupEventListeners();
          
          hideLoading();
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          Swal.fire({ 
            icon: 'error', 
            title: 'Loading Error', 
            text: 'Failed to load data. Please refresh the page.' 
          });
        }
      } else {
        Swal.fire({ 
          icon: 'info', 
          title: 'Please login', 
          text: 'You will be redirected to login.' 
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Helper functions
    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    // Load all data
    async function loadAllData() {
      await Promise.all([
        loadTransactions(),
        loadBudgets(),
        loadCategories(),
        loadBanks(),
        loadAlerts()
      ]);
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allTransactions = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
          BANK_NAME: d.data().BANK_NAME || d.data().MODE || ""
        }));
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        return false;
      }
    }

    // Load budgets
    async function loadBudgets() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "budgets"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allBudgets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadBudgets error:", err);
        return false;
      }
    }

    // Load categories
    async function loadCategories() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"),
          where("type", "in", ["Expense", "Income", "Asset"])
        );
        
        const snap = await getDocs(q);
        allCategories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadCategories error:", err);
        allCategories = [];
        return false;
      }
    }

    // Load banks
    async function loadBanks() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"),
          where("category", "==", "Bank")
        );
        
        const snap = await getDocs(q);
        allBanks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadBanks error:", err);
        allBanks = [];
        return false;
      }
    }

    // Load alerts
    async function loadAlerts() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "alerts"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allAlerts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadAlerts error:", err);
        return false;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Theme toggle
      themeToggle.addEventListener("click", toggleTheme);
      
      // Navigation
      userMenuBtn.addEventListener("click", () => {
        Swal.fire({
          title: 'Account',
          html: `
            <div class="text-center">
              <div class="user-avatar mb-3" style="margin: 0 auto;">${initialsElem.textContent}</div>
              <h5>${userFullName.textContent}</h5>
              <p class="text-muted">${userEmail.textContent}</p>
              <div class="d-grid gap-2 mt-4">
                <button class="btn btn-outline" id="profileBtn">Profile Settings</button>
                <button class="btn btn-outline" id="logoutBtn">Logout</button>
              </div>
            </div>
          `,
          showConfirmButton: false,
          showCloseButton: true,
          didOpen: () => {
            document.getElementById('logoutBtn').addEventListener('click', async () => {
              await signOut(auth);
              window.location.href = "index.html";
            });
          }
        });
      });

      // Navigation items
      transactionsNav.addEventListener("click", (e) => {
        e.preventDefault();
        window.location.href = "transaction.html";
      });

      budgetsNav.addEventListener("click", (e) => {
        e.preventDefault();
        openBudgetManager();
      });

      reportsNav.addEventListener("click", (e) => {
        e.preventDefault();
        window.location.href = "reports.html";
      });

      forecastNav.addEventListener("click", (e) => {
        e.preventDefault();
        openForecastModal();
      });

      // Quick actions
      quickBudgetBtn.addEventListener("click", quickBudget);
      exportBtn.addEventListener("click", exportData);
      addTransactionBtn.addEventListener("click", () => window.location.href = "transaction.html");
      aiAssistantBtn.addEventListener("click", openAIAssistant);
      quickReportBtn.addEventListener("click", generateQuickReport);
      refreshInsights.addEventListener("click", refreshInsightsData);
      viewAllAlerts.addEventListener("click", viewAllAlertsHandler);

      // Period selectors
      document.getElementById('spendingPeriod').addEventListener('change', updateSpendingChart);
      document.getElementById('trendPeriod').addEventListener('change', updateIncomeExpenseChart);
    }

    // Update dashboard
    function updateDashboard() {
      updateStats();
      updateProgressTracking();
      updateInsights();
      updateForecast();
      updateAlerts();
      updateCharts();
    }

    // Update stats
    function updateStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Calculate stats
      let totalBalance = 0;
      let monthlyIncome = 0;
      let monthlyExpenses = 0;
      
      // Total balance from banks
      allBanks.forEach(bank => {
        totalBalance += parseFloat(bank.balance) || 0;
      });
      
      // Monthly income and expenses
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
          if (tx.TYPE === 'Income') {
            monthlyIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const monthlySavings = monthlyIncome - monthlyExpenses;
      
      // Update DOM
      document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
      document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toFixed(2)}`;
      document.getElementById('monthlyExpenses').textContent = `$${monthlyExpenses.toFixed(2)}`;
      document.getElementById('monthlySavings').textContent = `$${monthlySavings.toFixed(2)}`;
    }

    // Update progress tracking
    function updateProgressTracking() {
      const progressContainer = document.getElementById('progressContainer');
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Get monthly budgets
      const monthlyBudgets = allBudgets.filter(budget => 
        budget.period === 'monthly' || !budget.period
      );
      
      if (monthlyBudgets.length === 0) {
        progressContainer.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="fas fa-piggy-bank fa-3x mb-3"></i>
            <h5>No budgets set for this month</h5>
            <p>Click "Quick Budget" to create your first budget</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      monthlyBudgets.slice(0, 5).forEach(budget => {
        // Calculate spending for this category
        let categorySpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
              categorySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        const budgetAmount = parseFloat(budget.amount) || 0;
        const spendingPercentage = budgetAmount > 0 ? (categorySpending / budgetAmount * 100) : 0;
        
        // Determine color based on percentage
        let barColor;
        if (spendingPercentage <= 60) {
          barColor = 'var(--success-color)';
        } else if (spendingPercentage <= 80) {
          barColor = 'var(--warning-color)';
        } else if (spendingPercentage <= 100) {
          barColor = 'var(--danger-color)';
        } else {
          barColor = 'var(--danger-color)';
        }
        
        html += `
          <div class="progress-item">
            <div class="progress-header">
              <div class="progress-category">
                <div class="progress-icon" style="background: ${barColor}">
                  <i class="fas ${getCategoryIcon(budget.category)}"></i>
                </div>
                ${budget.category}
              </div>
              <div class="text-muted">${spendingPercentage.toFixed(1)}%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(spendingPercentage, 100)}%; background: ${barColor}"></div>
            </div>
            <div class="progress-info">
              <span>$${categorySpending.toFixed(2)} spent</span>
              <span>$${budgetAmount.toFixed(2)} budget</span>
            </div>
          </div>
        `;
      });
      
      progressContainer.innerHTML = html;
    }

    // Update insights
    function updateInsights() {
      const insightsGrid = document.getElementById('insightsGrid');
      
      // Calculate insights
      const now = new Date();
      const currentMonth = now.getMonth();
      
      // Insight 1: Top spending category
      const spendingByCategory = {};
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === currentMonth) {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            const amount = parseFloat(tx.EXPENSE) || 0;
            spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
          }
        }
      });
      
      let topCategory = 'None';
      let topCategoryAmount = 0;
      if (Object.keys(spendingByCategory).length > 0) {
        [topCategory, topCategoryAmount] = Object.entries(spendingByCategory)
          .sort((a, b) => b[1] - a[1])[0];
      }
      
      // Insight 2: Savings rate
      let totalIncome = 0;
      let totalExpenses = 0;
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (txDate.getMonth() === currentMonth) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalExpenses += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const savings = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? (savings / totalIncome * 100) : 0;
      
      // Insight 3: Transaction count
      const transactionCount = allTransactions.filter(tx => {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === currentMonth;
      }).length;
      
      // Insight 4: Average transaction
      const avgTransaction = totalExpenses / transactionCount || 0;
      
      const insights = [
        {
          icon: 'fa-chart-pie',
          color: 'var(--danger-color)',
          title: 'Top Category',
          value: topCategory,
          desc: `Spent $${topCategoryAmount.toFixed(2)} this month`
        },
        {
          icon: 'fa-piggy-bank',
          color: 'var(--success-color)',
          title: 'Savings Rate',
          value: `${savingsRate.toFixed(1)}%`,
          desc: savings >= 0 ? `Saved $${savings.toFixed(2)}` : `Overspent $${Math.abs(savings).toFixed(2)}`
        },
        {
          icon: 'fa-exchange-alt',
          color: 'var(--primary-color)',
          title: 'Transactions',
          value: transactionCount,
          desc: `${Math.round(transactionCount / 30)} per day average`
        },
        {
          icon: 'fa-calculator',
          color: 'var(--info-color)',
          title: 'Avg Transaction',
          value: `$${avgTransaction.toFixed(2)}`,
          desc: 'Average expense amount'
        }
      ];
      
      let html = '';
      insights.forEach((insight, index) => {
        html += `
          <div class="insight-card grid-item" onclick="showInsightDetail(${index})">
            <div class="insight-icon" style="background: ${insight.color}">
              <i class="fas ${insight.icon}"></i>
            </div>
            <div class="insight-title">${insight.title}</div>
            <div class="insight-value" style="color: ${insight.color}">${insight.value}</div>
            <div class="insight-desc">${insight.desc}</div>
          </div>
        `;
      });
      
      insightsGrid.innerHTML = html;
    }

    // Update forecast
    function updateForecast() {
      const forecastCards = document.getElementById('forecastCards');
      
      // Calculate forecasts
      const monthlyData = getMonthlyData(6);
      const avgMonthlyIncome = monthlyData.reduce((sum, m) => sum + m.income, 0) / monthlyData.length || 0;
      const avgMonthlyExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0) / monthlyData.length || 0;
      
      const forecasts = [
        {
          period: 'Next Month',
          amount: `$${(avgMonthlyIncome * 1.02).toFixed(2)}`,
          change: '+2%',
          type: 'income'
        },
        {
          period: '3 Months',
          amount: `$${(avgMonthlyIncome * 3 * 1.05).toFixed(2)}`,
          change: '+5%',
          type: 'income'
        },
        {
          period: '6 Months',
          amount: `$${(avgMonthlyIncome * 6 * 1.1).toFixed(2)}`,
          change: '+10%',
          type: 'income'
        }
      ];
      
      let html = '';
      forecasts.forEach(forecast => {
        html += `
          <div class="forecast-card">
            <div class="forecast-period">${forecast.period}</div>
            <div class="forecast-amount">${forecast.amount}</div>
            <div class="stat-change positive">
              <i class="fas fa-arrow-up"></i>
              <span>${forecast.change} projected growth</span>
            </div>
            <div class="text-muted mt-2">Projected ${forecast.type}</div>
          </div>
        `;
      });
      
      forecastCards.innerHTML = html;
      
      updateForecastChart();
    }

    // Update alerts
    function updateAlerts() {
      const alertsGrid = document.getElementById('alertsGrid');
      
      const alerts = [];
      
      // Check budgets for alerts
      const now = new Date();
      const currentMonth = now.getMonth();
      
      allBudgets.forEach(budget => {
        let spent = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === currentMonth) {
              spent += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        const limit = parseFloat(budget.amount) || 0;
        const percentage = limit > 0 ? (spent / limit * 100) : 0;
        
        if (percentage >= 100) {
          alerts.push({
            category: budget.category,
            type: 'critical',
            message: `Budget exceeded by $${(spent - limit).toFixed(2)}`,
            time: 'Just now'
          });
        } else if (percentage >= 80) {
          alerts.push({
            category: budget.category,
            type: 'warning',
            message: `Approaching budget limit (${percentage.toFixed(1)}%)`,
            time: 'Today'
          });
        }
      });
      
      if (alerts.length === 0) {
        alertsGrid.innerHTML = `
          <div class="alert-card info">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <i class="fas fa-check-circle text-info me-2"></i>
                <strong>All Good!</strong>
                <p class="mb-0 text-muted">No alerts to show</p>
              </div>
              <i class="fas fa-smile text-info"></i>
            </div>
          </div>
        `;
        return;
      }
      
      let html = '';
      alerts.slice(0, 3).forEach(alert => {
        html += `
          <div class="alert-card ${alert.type}">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>${alert.category}</strong>
                <p class="mb-0">${alert.message}</p>
                <small class="text-muted">${alert.time}</small>
              </div>
              <button class="btn btn-outline btn-sm">View</button>
            </div>
          </div>
        `;
      });
      
      alertsGrid.innerHTML = html;
    }

    // Initialize charts
    function initializeCharts() {
      // Income vs Expense chart
      const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
      incomeExpenseChart = new Chart(incomeExpenseCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Income',
              data: [],
              borderColor: '#4cc9f0',
              backgroundColor: 'rgba(76, 201, 240, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 2
            },
            {
              label: 'Expenses',
              data: [],
              borderColor: '#f94144',
              backgroundColor: 'rgba(249, 65, 68, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: 'var(--text-primary)',
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              backgroundColor: 'var(--bg-card)',
              titleColor: 'var(--text-primary)',
              bodyColor: 'var(--text-primary)',
              borderColor: 'var(--border-color)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-secondary)',
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-secondary)'
              }
            }
          }
        }
      });

      // Spending chart
      const spendingCtx = document.getElementById('spendingChart').getContext('2d');
      spendingChart = new Chart(spendingCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#4361ee',
              '#7209b7',
              '#f72585',
              '#4cc9f0',
              '#f8961e',
              '#43aa8b',
              '#9d4edd'
            ],
            borderColor: 'var(--bg-card)',
            borderWidth: 2,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'var(--text-primary)',
                boxWidth: 12,
                padding: 15,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              backgroundColor: 'var(--bg-card)',
              titleColor: 'var(--text-primary)',
              bodyColor: 'var(--text-primary)',
              borderColor: 'var(--border-color)',
              borderWidth: 1
            }
          }
        }
      });

      // Forecast chart
      const forecastCtx = document.getElementById('forecastChart').getContext('2d');
      forecastChart = new Chart(forecastCtx, {
        type: 'bar',
        data: {
          labels: ['Current', 'Month 1', 'Month 2', 'Month 3'],
          datasets: [
            {
              label: 'Income',
              data: [0, 0, 0, 0],
              backgroundColor: 'rgba(76, 201, 240, 0.7)',
              borderRadius: 6
            },
            {
              label: 'Expenses',
              data: [0, 0, 0, 0],
              backgroundColor: 'rgba(249, 65, 68, 0.7)',
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: 'var(--text-primary)',
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              backgroundColor: 'var(--bg-card)',
              titleColor: 'var(--text-primary)',
              bodyColor: 'var(--text-primary)',
              borderColor: 'var(--border-color)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-secondary)',
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-secondary)'
              }
            }
          }
        }
      });
    }

    // Update charts
    function updateCharts() {
      updateSpendingChart();
      updateIncomeExpenseChart();
      updateForecastChart();
    }

    function updateSpendingChart() {
      const period = document.getElementById('spendingPeriod').value;
      const now = new Date();
      
      const spendingByCategory = {};
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          let include = false;
          
          switch (period) {
            case 'month':
              include = txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
              break;
            case 'quarter':
              const quarter = Math.floor(now.getMonth() / 3);
              const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
              const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
              include = txDate >= quarterStart && txDate < quarterEnd;
              break;
            case 'year':
              include = txDate.getFullYear() === now.getFullYear();
              break;
          }
          
          if (include) {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            const amount = parseFloat(tx.EXPENSE) || 0;
            spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
          }
        }
      });
      
      const sortedCategories = Object.entries(spendingByCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7);
      
      spendingChart.data.labels = sortedCategories.map(([category]) => category);
      spendingChart.data.datasets[0].data = sortedCategories.map(([_, amount]) => amount);
      spendingChart.update();
    }

    function updateIncomeExpenseChart() {
      const months = parseInt(document.getElementById('trendPeriod').value) || 6;
      const now = new Date();
      
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        incomeData.push(monthlyIncome);
        expenseData.push(monthlyExpenses);
      }
      
      incomeExpenseChart.data.labels = labels;
      incomeExpenseChart.data.datasets[0].data = incomeData;
      incomeExpenseChart.data.datasets[1].data = expenseData;
      incomeExpenseChart.update();
    }

    function updateForecastChart() {
      const monthlyData = getMonthlyData(3);
      const avgIncome = monthlyData.reduce((sum, m) => sum + m.income, 0) / monthlyData.length || 0;
      const avgExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0) / monthlyData.length || 0;
      
      const forecastData = [
        { income: avgIncome, expenses: avgExpenses },
        { income: avgIncome * 1.02, expenses: avgExpenses * 1.01 },
        { income: avgIncome * 1.05, expenses: avgExpenses * 1.02 },
        { income: avgIncome * 1.08, expenses: avgExpenses * 1.03 }
      ];
      
      forecastChart.data.datasets[0].data = forecastData.map(d => d.income);
      forecastChart.data.datasets[1].data = forecastData.map(d => d.expenses);
      forecastChart.update();
    }

    // Helper functions
    function getCategoryIcon(category) {
      const icons = {
        'Food': 'fa-utensils',
        'Transport': 'fa-car',
        'Shopping': 'fa-shopping-bag',
        'Entertainment': 'fa-film',
        'Utilities': 'fa-bolt',
        'Rent': 'fa-home',
        'Healthcare': 'fa-heartbeat',
        'Education': 'fa-graduation-cap',
        'Travel': 'fa-plane',
        'Insurance': 'fa-shield-alt',
        'Taxes': 'fa-file-invoice-dollar',
        'Savings': 'fa-piggy-bank',
        'Investment': 'fa-chart-line',
        'Debt': 'fa-credit-card',
        'Gifts': 'fa-gift',
        'Personal': 'fa-user',
        'Business': 'fa-briefcase',
        'Other': 'fa-ellipsis-h'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (category.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      
      return 'fa-tag';
    }

    function getMonthlyData(months = 6) {
      const now = new Date();
      const data = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        data.push({
          month: date.toLocaleDateString('default', { month: 'short' }),
          income: monthlyIncome,
          expenses: monthlyExpenses,
          savings: monthlyIncome - monthlyExpenses
        });
      }
      
      return data;
    }

    // Modal functions
    function openBudgetManager() {
      Swal.fire({
        title: 'Budget Manager',
        html: `
          <div class="text-start">
            <div class="mb-4">
              <h6>Current Budgets</h6>
              <div id="budgetsList" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                <!-- Budgets will be listed here -->
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select id="budgetCategory" class="form-select">
                <option value="">Select Category</option>
                ${Array.from(new Set(allTransactions.map(t => t.ACCOUNT_HEADER).filter(Boolean))).map(cat => 
                  `<option value="${cat}">${cat}</option>`
                ).join('')}
              </select>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Amount</label>
                <input type="number" id="budgetAmount" class="form-control" placeholder="0.00">
              </div>
              <div class="col-6">
                <label class="form-label">Period</label>
                <select id="budgetPeriod" class="form-select">
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                </select>
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Save Budget',
        preConfirm: async () => {
          const category = document.getElementById('budgetCategory').value;
          const amount = document.getElementById('budgetAmount').value;
          const period = document.getElementById('budgetPeriod').value;
          
          if (!category || !amount || amount <= 0) {
            Swal.showValidationMessage('Please fill in all fields with valid values');
            return false;
          }
          
          try {
            showLoading("Saving budget...");
            await addDoc(collection(db, "users", currentUser.uid, "budgets"), {
              category,
              amount: parseFloat(amount),
              period,
              createdAt: new Date()
            });
            await loadBudgets();
            updateDashboard();
            hideLoading();
            return true;
          } catch (err) {
            hideLoading();
            Swal.showValidationMessage('Failed to save budget');
            return false;
          }
        }
      });
    }

    function openForecastModal() {
      Swal.fire({
        title: 'Financial Forecast',
        html: `
          <div class="text-start">
            <div class="mb-4">
              <canvas id="detailedForecastChart" height="200"></canvas>
            </div>
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label">Forecast Period</label>
                <select id="forecastPeriod" class="form-select">
                  <option value="3">3 Months</option>
                  <option value="6" selected>6 Months</option>
                  <option value="12">12 Months</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Growth Rate (%)</label>
                <input type="number" id="growthRate" class="form-control" value="2.5" step="0.1">
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Generate Forecast',
        width: 600,
        didOpen: () => {
          // Initialize detailed forecast chart
          const ctx = document.getElementById('detailedForecastChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
              datasets: [{
                label: 'Income Forecast',
                data: [4500, 4800, 5100, 5400, 5700, 6000],
                borderColor: '#4cc9f0',
                backgroundColor: 'rgba(76, 201, 240, 0.1)',
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + value;
                    }
                  }
                }
              }
            }
          });
        }
      });
    }

    function openAIAssistant() {
      Swal.fire({
        title: 'AI Assistant',
        html: `
          <div class="text-start">
            <div class="ai-chat mb-3" style="height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
              <div class="ai-message mb-2">
                <div class="badge badge-primary mb-1">AI Assistant</div>
                <p class="mb-0">Hello! I can help you with budget analysis, savings tips, and financial planning. What would you like to know?</p>
              </div>
            </div>
            <div class="input-group">
              <input type="text" id="aiQuestion" class="form-control" placeholder="Ask about your budget...">
              <button class="btn btn-primary" id="askAI">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">Try asking: "How can I save more?" or "Analyze my spending"</small>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: 500
      });
    }

    // Utility functions
    function quickBudget() {
      const monthlyData = getMonthlyData(3);
      const avgExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0) / monthlyData.length || 0;
      
      Swal.fire({
        title: 'Quick Budget Setup',
        html: `
          <div class="text-start">
            <p>Based on your average monthly spending of <strong>$${avgExpenses.toFixed(2)}</strong>, here's a suggested budget:</p>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Suggested</th>
                    <th>Current</th>
                  </tr>
                </thead>
                <tbody id="quickBudgetTable">
                  <!-- Budget suggestions will appear here -->
                </tbody>
              </table>
            </div>
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="autoApply" checked>
              <label class="form-check-label" for="autoApply">
                Apply these budgets automatically
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Apply Budgets',
        preConfirm: () => {
          return document.getElementById('autoApply').checked;
        }
      });
    }

    function exportData() {
      const data = {
        transactions: allTransactions.slice(0, 100),
        budgets: allBudgets,
        summary: getDashboardSummary(),
        exportedAt: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `budget-export-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function generateQuickReport() {
      const monthlyData = getMonthlyData(6);
      const latestMonth = monthlyData[monthlyData.length - 1];
      
      Swal.fire({
        title: 'Quick Report',
        html: `
          <div class="text-start">
            <div class="row mb-4">
              <div class="col-6">
                <div class="card bg-primary text-white">
                  <div class="card-body">
                    <h6>Income</h6>
                    <h3>$${latestMonth.income.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-danger text-white">
                  <div class="card-body">
                    <h6>Expenses</h6>
                    <h3>$${latestMonth.expenses.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Report Summary:</strong>
              <p class="mb-0 mt-2">Your savings rate is ${((latestMonth.income - latestMonth.expenses) / latestMonth.income * 100).toFixed(1)}%. 
              ${latestMonth.savings > 0 ? 'Great job!' : 'Consider reducing expenses.'}</p>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: 600
      });
    }

    function refreshInsightsData() {
      showLoading("Refreshing insights...");
      setTimeout(() => {
        updateInsights();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: 'Refreshed!',
          text: 'Insights updated successfully',
          timer: 1500,
          showConfirmButton: false
        });
      }, 1000);
    }

    function viewAllAlertsHandler() {
      Swal.fire({
        title: 'All Alerts',
        html: `
          <div class="text-start">
            <div class="alerts-list" style="max-height: 300px; overflow-y: auto;">
              <!-- All alerts will appear here -->
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: 600
      });
    }

    function getDashboardSummary() {
      const now = new Date();
      const currentMonth = now.getMonth();
      
      let totalIncome = 0;
      let totalExpenses = 0;
      let totalSavings = 0;
      
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (txDate.getMonth() === currentMonth) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalExpenses += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      totalSavings = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? (totalSavings / totalIncome * 100) : 0;
      
      return {
        totalIncome,
        totalExpenses,
        totalSavings,
        savingsRate,
        transactionCount: allTransactions.length,
        budgetCount: allBudgets.length,
        month: now.toLocaleDateString('default', { month: 'long', year: 'numeric' })
      };
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      localStorage.setItem('theme', currentTheme);
      
      // Update charts
      if (forecastChart) forecastChart.update();
      if (spendingChart) spendingChart.update();
      if (incomeExpenseChart) incomeExpenseChart.update();
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
      }
    }

    // Global functions for onclick handlers
    window.showInsightDetail = function(index) {
      const insights = [
        {
          title: 'Top Spending Category',
          description: 'This shows your highest spending category for the current month.',
          action: 'Consider setting a budget for this category to control spending.',
          icon: 'fa-chart-pie'
        },
        {
          title: 'Savings Rate',
          description: 'Your savings rate indicates what percentage of your income you\'re saving.',
          action: 'Aim for a 20% savings rate for healthy financial growth.',
          icon: 'fa-piggy-bank'
        },
        {
          title: 'Transaction Count',
          description: 'Total number of transactions this month.',
          action: 'Fewer transactions often mean better spending control.',
          icon: 'fa-exchange-alt'
        },
        {
          title: 'Average Transaction',
          description: 'Average amount spent per transaction.',
          action: 'Try to reduce this amount by being more mindful of purchases.',
          icon: 'fa-calculator'
        }
      ];
      
      const insight = insights[index];
      
      Swal.fire({
        title: insight.title,
        html: `
          <div class="text-start">
            <div class="text-center mb-4">
              <div class="insight-icon" style="width: 60px; height: 60px; margin: 0 auto; background: var(--primary-color);">
                <i class="fas ${insight.icon} fa-2x"></i>
              </div>
            </div>
            <p>${insight.description}</p>
            <div class="alert alert-info">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Tip:</strong> ${insight.action}
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCloseButton: true,
        width: 500
      });
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      // Add animation to all grid items
      const gridItems = document.querySelectorAll('.grid-item');
      gridItems.forEach((item, index) => {
        item.style.animationDelay = `${index * 0.1}s`;
      });
      
      console.log('BudgetFlow Dashboard Initialized');
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>