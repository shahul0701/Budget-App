<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget & Forecasting Manager</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }

    .page {
      max-width:1400px;
      margin:36px auto;
      padding:22px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
      margin-bottom: 20px;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(4,1fr); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-change { font-size:12px; margin-top:4px; }
    .positive-change { color: var(--success); }
    .negative-change { color: var(--danger); }

    /* content body */
    .content-body { padding:20px 22px 32px; }
    
    /* tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
      color: var(--muted);
      border: none;
      padding: 10px 20px;
      font-weight: 600;
    }
    .nav-tabs .nav-link:hover {
      color: var(--purple-1);
      border: none;
    }
    .nav-tabs .nav-link.active {
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
      background: transparent;
    }
    
    /* section headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .section-header h4 {
      margin: 0;
      font-weight: 600;
    }
    
    /* insights cards */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .insight-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .insight-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .insight-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }
    .insight-icon.income { background: linear-gradient(135deg, var(--success), #0d6e3d); }
    .insight-icon.expense { background: linear-gradient(135deg, var(--danger), #a71d2a); }
    .insight-icon.saving { background: linear-gradient(135deg, var(--info), #0a8fa3); }
    .insight-icon.tips { background: linear-gradient(135deg, var(--warning), #d39e00); }
    .insight-card h5 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .insight-card p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* budget cards */
    .budget-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .budget-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    .budget-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .budget-category {
      font-weight: 600;
      font-size: 16px;
    }
    .budget-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }
    .budget-status.under { background: rgba(25, 135, 84, 0.15); color: var(--success); }
    .budget-status.over { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
    .budget-status.warning { background: rgba(255, 193, 7, 0.15); color: var(--warning); }
    .budget-progress {
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      margin: 15px 0;
      overflow: hidden;
    }
    .budget-progress-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .budget-amounts {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    .budget-spent {
      font-weight: 600;
    }
    .budget-limit {
      color: var(--muted);
    }
    
    /* charts */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }
    
    /* forecast cards */
    .forecast-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .forecast-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }
    .forecast-period {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .forecast-amount {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .forecast-details {
      font-size: 14px;
      color: var(--muted);
    }
    .forecast-details div {
      margin-bottom: 5px;
    }
    
    /* tables */
    .data-table {
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .data-table table { margin:0; min-width: 1000px; }
    .data-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .data-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .data-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    
    /* filters */
    .filters { 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin-bottom:20px; 
      padding:15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    /* action buttons */
    .action-btn { 
      width:38px; 
      height:38px; 
      border-radius:8px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      color:white; 
      border:none; 
      cursor: pointer;
    }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-add { background:var(--success); }
    
    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    
    /* responsive */
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .insights-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .tm-header { flex-direction:column; align-items:flex-start; gap:12px; border-radius:14px 14px 0 0; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { min-width: 100%; }
    }
    
    /* loading */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    /* time period selector */
    .period-selector {
      display: flex;
      gap: 5px;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 5px;
      border: 1px solid var(--border-color);
    }
    .period-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .period-btn:hover {
      background: var(--bg-primary);
    }
    .period-btn.active {
      background: var(--purple-1);
      color: white;
    }
    
    /* badge styles */
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-income { 
      background-color: rgba(25, 135, 84, 0.15);
      color: var(--success);
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
    }
    .badge-savings { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
    }
    
    /* tips section */
    .tips-section {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    .tip-card {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid var(--purple-1);
    }
    .tip-card h6 {
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    .tip-card p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }
    
    /* limit indicator */
    .limit-indicator {
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      height: 40px;
      background: var(--danger);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom-left-radius: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Loading Backdrop -->
    <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p id="backdropMessage">Loading...</p>
      </div>
    </div>
    
    <!-- Navigation buttons -->
    <div class="nav-buttons">
      <button id="backBtn" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left me-1"></i> Back
      </button>
      <button id="homeBtn" class="btn btn-outline-secondary">
        <i class="fa fa-home me-1"></i> Home
      </button>
      <button id="transactionsBtn" class="btn btn-outline-info">
        <i class="fa fa-money-bill-wave me-1"></i> Transactions
      </button>
      <button id="coaBtn" class="btn btn-outline-success">
        <i class="fa fa-chart-pie me-1"></i> COA
      </button>
    </div>
    
    <!-- Main App Card -->
    <div class="app-card">
      <!-- Header -->
      <div class="tm-header">
        <h2><i class="fa fa-chart-line"></i> Budget & Forecasting Manager</h2>
        <div class="header-actions">
          <button id="newBudgetBtn" class="btn btn-light btn-sm text-primary">
            <i class="fa fa-plus me-1"></i> Set Budget
          </button>
          <button id="newForecastBtn" class="btn btn-light btn-sm text-primary ms-2">
            <i class="fa fa-calculator me-1"></i> Create Forecast
          </button>
          <button id="themeToggle" class="theme-toggle">
            <i class="fa fa-moon"></i>
          </button>
          <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
          <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
            <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
            <div style="color:white; font-weight:600;" id="username">User</div>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
          </div>
        </div>
      </div>
      
      <!-- Time Period Selector -->
      <div class="filters">
        <div class="period-selector">
          <button class="period-btn active" data-period="week">Weekly</button>
          <button class="period-btn" data-period="month">Monthly</button>
          <button class="period-btn" data-period="quarter">Quarterly</button>
          <button class="period-btn" data-period="year">Yearly</button>
        </div>
        <select id="categoryFilter" class="form-select form-select-sm">
          <option value="all">All Categories</option>
          <!-- Will be populated -->
        </select>
        <select id="bankFilter" class="form-select form-select-sm">
          <option value="all">All Banks</option>
          <!-- Will be populated -->
        </select>
        <button id="applyFiltersBtn" class="btn btn-sm btn-primary">
          <i class="fa fa-filter me-1"></i> Apply
        </button>
        <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">
          Reset
        </button>
      </div>
      
      <!-- Top Stats Cards -->
      <div class="top-cards" id="topCards">
        <div class="stat-card" id="totalBudgetCard">
          <div class="stat-label">Total Budget</div>
          <div id="statBudget" class="stat-value">$0.00</div>
          <div class="stat-change positive-change" id="budgetChange">
            <i class="fa fa-arrow-up"></i> 0.0%
          </div>
        </div>
        <div class="stat-card" id="totalSpentCard">
          <div class="stat-label">Total Spent</div>
          <div id="statSpent" class="stat-value expense-color">$0.00</div>
          <div class="stat-change negative-change" id="spentChange">
            <i class="fa fa-arrow-up"></i> 0.0%
          </div>
        </div>
        <div class="stat-card" id="remainingBudgetCard">
          <div class="stat-label">Remaining Budget</div>
          <div id="statRemaining" class="stat-value success-color">$0.00</div>
          <div class="stat-change" id="remainingChange">
            0.0% of budget
          </div>
        </div>
        <div class="stat-card" id="savingsCard">
          <div class="stat-label">Projected Savings</div>
          <div id="statSavings" class="stat-value info-color">$0.00</div>
          <div class="stat-change" id="savingsChange">
            0.0% of income
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="content-body">
        <ul class="nav nav-tabs" id="mainTabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#budgetTab">
              <i class="fa fa-piggy-bank me-1"></i> Budget Overview
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#forecastTab">
              <i class="fa fa-chart-line me-1"></i> Forecasting
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analysisTab">
              <i class="fa fa-chart-bar me-1"></i> Spending Analysis
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tipsTab">
              <i class="fa fa-lightbulb me-1"></i> Savings Tips
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#limitsTab">
              <i class="fa fa-exclamation-triangle me-1"></i> Limit Alerts
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="tabContent">
          <!-- Budget Overview Tab -->
          <div class="tab-pane fade show active" id="budgetTab">
            <div class="section-header">
              <h4>Budget Categories</h4>
              <button id="addBudgetCategoryBtn" class="btn btn-sm btn-primary">
                <i class="fa fa-plus me-1"></i> Add Category
              </button>
            </div>
            
            <div class="budget-cards" id="budgetCards">
              <!-- Budget cards will be populated here -->
            </div>
            
            <div class="chart-container">
              <canvas id="budgetChart"></canvas>
            </div>
            
            <div class="section-header mt-4">
              <h4>Top Spending Categories</h4>
              <select id="topSpendingPeriod" class="form-select form-select-sm" style="width: auto;">
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
              </select>
            </div>
            
            <div class="chart-container">
              <canvas id="topSpendingChart"></canvas>
            </div>
          </div>
          
          <!-- Forecasting Tab -->
          <div class="tab-pane fade" id="forecastTab">
            <div class="section-header">
              <h4>Financial Forecast</h4>
              <button id="runForecastBtn" class="btn btn-sm btn-primary">
                <i class="fa fa-play me-1"></i> Run Forecast
              </button>
            </div>
            
            <div class="forecast-cards" id="forecastCards">
              <!-- Forecast cards will be populated here -->
            </div>
            
            <div class="chart-container">
              <canvas id="forecastChart"></canvas>
            </div>
            
            <div class="section-header mt-4">
              <h4>Income vs Expense Projection</h4>
              <div>
                <button class="btn btn-sm btn-outline-primary" id="forecast3Months">3 Months</button>
                <button class="btn btn-sm btn-outline-primary active" id="forecast6Months">6 Months</button>
                <button class="btn btn-sm btn-outline-primary" id="forecast12Months">12 Months</button>
              </div>
            </div>
            
            <div class="chart-container">
              <canvas id="incomeExpenseForecastChart"></canvas>
            </div>
            
            <div class="tips-section mt-4">
              <h5><i class="fa fa-lightbulb me-2 text-warning"></i>Forecast Insights</h5>
              <div id="forecastInsights">
                <!-- Forecast insights will be populated here -->
              </div>
            </div>
          </div>
          
          <!-- Spending Analysis Tab -->
          <div class="tab-pane fade" id="analysisTab">
            <div class="insights-grid">
              <div class="insight-card">
                <div class="insight-card-header">
                  <div class="insight-icon income">
                    <i class="fa fa-arrow-up"></i>
                  </div>
                  <h5>Top Income Sources</h5>
                </div>
                <div id="topIncomeSources">
                  <p class="text-muted">Loading data...</p>
                </div>
              </div>
              
              <div class="insight-card">
                <div class="insight-card-header">
                  <div class="insight-icon expense">
                    <i class="fa fa-arrow-down"></i>
                  </div>
                  <h5>Top Spending Categories</h5>
                </div>
                <div id="topSpendingCategories">
                  <p class="text-muted">Loading data...</p>
                </div>
              </div>
              
              <div class="insight-card">
                <div class="insight-card-header">
                  <div class="insight-icon saving">
                    <i class="fa fa-piggy-bank"></i>
                  </div>
                  <h5>Savings Opportunities</h5>
                </div>
                <div id="savingsOpportunities">
                  <p class="text-muted">Loading data...</p>
                </div>
              </div>
              
              <div class="insight-card">
                <div class="insight-card-header">
                  <div class="insight-icon tips">
                    <i class="fa fa-chart-pie"></i>
                  </div>
                  <h5>Spending Distribution</h5>
                </div>
                <div id="spendingDistribution">
                  <p class="text-muted">Loading data...</p>
                </div>
              </div>
            </div>
            
            <div class="section-header">
              <h4>Monthly Spending Trends</h4>
              <select id="trendPeriod" class="form-select form-select-sm" style="width: auto;">
                <option value="6">Last 6 Months</option>
                <option value="12">Last 12 Months</option>
                <option value="24">Last 2 Years</option>
              </select>
            </div>
            
            <div class="chart-container">
              <canvas id="spendingTrendChart"></canvas>
            </div>
            
            <div class="section-header mt-4">
              <h4>Category-wise Analysis</h4>
              <select id="analysisCategory" class="form-select form-select-sm" style="width: auto;">
                <option value="">Select Category</option>
                <!-- Will be populated -->
              </select>
            </div>
            
            <div class="chart-container">
              <canvas id="categoryAnalysisChart"></canvas>
            </div>
          </div>
          
          <!-- Savings Tips Tab -->
          <div class="tab-pane fade" id="tipsTab">
            <div class="section-header">
              <h4>Personalized Savings Tips</h4>
              <button id="refreshTipsBtn" class="btn btn-sm btn-primary">
                <i class="fa fa-redo me-1"></i> Refresh Tips
              </button>
            </div>
            
            <div class="tips-section">
              <h5><i class="fa fa-lightbulb me-2 text-warning"></i>Based on Your Spending Patterns</h5>
              <div id="personalizedTips">
                <!-- Tips will be populated here -->
              </div>
            </div>
            
            <div class="section-header mt-4">
              <h4>Weekly Savings Challenge</h4>
            </div>
            
            <div class="tips-section">
              <div id="weeklyChallenge">
                <!-- Weekly challenge will be populated here -->
              </div>
            </div>
            
            <div class="section-header mt-4">
              <h4>Budgeting Strategies</h4>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="tip-card">
                  <h6>50/30/20 Rule</h6>
                  <p>Allocate 50% of income to needs, 30% to wants, and 20% to savings and debt repayment.</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="tip-card">
                  <h6>Zero-Based Budgeting</h6>
                  <p>Assign every dollar of income to a specific expense or savings goal each month.</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="tip-card">
                  <h6>Envelope System</h6>
                  <p>Use cash envelopes for different spending categories to control discretionary spending.</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="tip-card">
                  <h6>Pay Yourself First</h6>
                  <p>Automatically transfer savings/investments as soon as you receive income.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Limit Alerts Tab -->
          <div class="tab-pane fade" id="limitsTab">
            <div class="section-header">
              <h4>Budget Limit Alerts</h4>
              <button id="setLimitAlertBtn" class="btn btn-sm btn-primary">
                <i class="fa fa-bell me-1"></i> Set Alert
              </button>
            </div>
            
            <div class="data-table">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Limit Type</th>
                    <th>Limit Amount</th>
                    <th>Current Spending</th>
                    <th>Status</th>
                    <th>Alert Frequency</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="limitAlertsTable">
                  <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                      No limit alerts set. Click "Set Alert" to create one.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="section-header mt-4">
              <h4>Upcoming Limit Exceedances</h4>
            </div>
            
            <div id="upcomingExceedances">
              <!-- Will be populated -->
            </div>
            
            <div class="section-header mt-4">
              <h4>Alert History</h4>
            </div>
            
            <div class="data-table">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Alert Type</th>
                    <th>Message</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="alertHistoryTable">
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                      No alert history available.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <!-- Set Budget Modal -->
  <div class="modal fade" id="setBudgetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Set Budget Limit</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="budgetForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select id="budgetCategory" class="form-select" required>
                  <option value="">Select Category</option>
                  <!-- Will be populated -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Period</label>
                <select id="budgetPeriod" class="form-select" required>
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Budget Amount</label>
                <input type="number" id="budgetAmount" class="form-control" step="0.01" min="0" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Alert Threshold (%)</label>
                <input type="number" id="alertThreshold" class="form-control" value="80" min="0" max="100">
                <small class="text-muted">Get notified when spending reaches this percentage of budget</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Notes</label>
                <textarea id="budgetNotes" class="form-control" rows="2" placeholder="Optional notes about this budget"></textarea>
              </div>
              <div class="col-md-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rolloverBudget" checked>
                  <label class="form-check-label" for="rolloverBudget">
                    Allow unspent amount to roll over to next period
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveBudgetBtn" class="btn btn-primary">Save Budget</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Forecast Modal -->
  <div class="modal fade" id="createForecastModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Financial Forecast</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="forecastForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Forecast Type</label>
                <select id="forecastType" class="form-select" required>
                  <option value="income">Income Forecast</option>
                  <option value="expense">Expense Forecast</option>
                  <option value="savings">Savings Forecast</option>
                  <option value="complete">Complete Financial Forecast</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Forecast Period</label>
                <select id="forecastDuration" class="form-select" required>
                  <option value="3">3 Months</option>
                  <option value="6" selected>6 Months</option>
                  <option value="12">12 Months</option>
                  <option value="24">24 Months</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Based on Historical Data (Months)</label>
                <input type="number" id="historicalMonths" class="form-control" value="6" min="1" max="24">
              </div>
              <div class="col-md-12">
                <label class="form-label">Growth/Change Rate (%)</label>
                <div class="input-group">
                  <input type="number" id="growthRate" class="form-control" value="0" step="0.1">
                  <span class="input-group-text">% per month</span>
                </div>
                <small class="text-muted">Positive for growth, negative for reduction</small>
              </div>
              <div class="col-md-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="includeSeasonality" checked>
                  <label class="form-check-label" for="includeSeasonality">
                    Include seasonal patterns in forecast
                  </label>
                </div>
              </div>
              <div class="col-md-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="adjustForInflation" checked>
                  <label class="form-check-label" for="adjustForInflation">
                    Adjust for inflation (assume 2% annual)
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="runForecastBtnModal" class="btn btn-primary">Run Forecast</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Set Limit Alert Modal -->
  <div class="modal fade" id="setLimitAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Set Spending Limit Alert</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="limitAlertForm">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Category/Bank/Account</label>
                <select id="alertTarget" class="form-select" required>
                  <option value="">Select Target</option>
                  <!-- Will be populated -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Limit Type</label>
                <select id="limitType" class="form-select" required>
                  <option value="spending">Spending Limit</option>
                  <option value="balance">Minimum Balance</option>
                  <option value="transaction">Transaction Count</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Limit Amount/Count</label>
                <input type="number" id="limitValue" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Period</label>
                <select id="limitPeriod" class="form-select" required>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Alert Frequency</label>
                <select id="alertFrequency" class="form-select" required>
                  <option value="once">Once when exceeded</option>
                  <option value="daily" selected>Daily when exceeded</option>
                  <option value="weekly">Weekly summary</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Alert Message</label>
                <textarea id="alertMessage" class="form-control" rows="2" placeholder="Custom alert message (optional)"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveLimitAlertBtn" class="btn btn-primary">Save Alert</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // State
    let currentUser = null;
    let allTransactions = [];
    let allBudgets = [];
    let allForecasts = [];
    let allAlerts = [];
    let currentPeriod = 'month';
    let currentTheme = 'light';
    
    // Chart instances
    let budgetChart = null;
    let topSpendingChart = null;
    let forecastChart = null;
    let incomeExpenseForecastChart = null;
    let spendingTrendChart = null;
    let categoryAnalysisChart = null;
    
    // DOM refs
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const transactionsBtn = document.getElementById("transactionsBtn");
    const coaBtn = document.getElementById("coaBtn");
    const themeToggle = document.getElementById("themeToggle");
    
    // Top stats
    const statBudget = document.getElementById("statBudget");
    const statSpent = document.getElementById("statSpent");
    const statRemaining = document.getElementById("statRemaining");
    const statSavings = document.getElementById("statSavings");
    const budgetChange = document.getElementById("budgetChange");
    const spentChange = document.getElementById("spentChange");
    const remainingChange = document.getElementById("remainingChange");
    const savingsChange = document.getElementById("savingsChange");
    
    // Buttons
    const newBudgetBtn = document.getElementById("newBudgetBtn");
    const newForecastBtn = document.getElementById("newForecastBtn");
    const addBudgetCategoryBtn = document.getElementById("addBudgetCategoryBtn");
    const runForecastBtn = document.getElementById("runForecastBtn");
    const setLimitAlertBtn = document.getElementById("setLimitAlertBtn");
    const refreshTipsBtn = document.getElementById("refreshTipsBtn");
    
    // Filters
    const categoryFilter = document.getElementById("categoryFilter");
    const bankFilter = document.getElementById("bankFilter");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const periodButtons = document.querySelectorAll(".period-btn");
    
    // Containers
    const budgetCards = document.getElementById("budgetCards");
    const forecastCards = document.getElementById("forecastCards");
    const limitAlertsTable = document.getElementById("limitAlertsTable");
    const alertHistoryTable = document.getElementById("alertHistoryTable");
    const upcomingExceedances = document.getElementById("upcomingExceedances");
    
    // Analysis sections
    const topIncomeSources = document.getElementById("topIncomeSources");
    const topSpendingCategories = document.getElementById("topSpendingCategories");
    const savingsOpportunities = document.getElementById("savingsOpportunities");
    const spendingDistribution = document.getElementById("spendingDistribution");
    const personalizedTips = document.getElementById("personalizedTips");
    const weeklyChallenge = document.getElementById("weeklyChallenge");
    const forecastInsights = document.getElementById("forecastInsights");
    
    // Modals
    const setBudgetModal = new bootstrap.Modal(document.getElementById("setBudgetModal"));
    const createForecastModal = new bootstrap.Modal(document.getElementById("createForecastModal"));
    const setLimitAlertModal = new bootstrap.Modal(document.getElementById("setLimitAlertModal"));
    
    // Modal buttons
    const saveBudgetBtn = document.getElementById("saveBudgetBtn");
    const runForecastBtnModal = document.getElementById("runForecastBtnModal");
    const saveLimitAlertBtn = document.getElementById("saveLimitAlertBtn");
    
    // Initialize
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your budget data...");
        
        try {
          loadThemePreference();
          await loadAllData();
          initializeCharts();
          updateDashboard();
          
          hideLoading();
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          Swal.fire({ 
            icon: 'error', 
            title: 'Loading Error', 
            text: 'Failed to load data. Please refresh the page.' 
          });
        }
      } else {
        Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(()=> {
          window.location.href = "index.html";
        });
      }
    });

    // Helper functions
    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Load all data
    async function loadAllData() {
      await Promise.all([
        loadTransactions(),
        loadBudgets(),
        loadForecasts(),
        loadAlerts()
      ]);
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allTransactions = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
          BANK_NAME: d.data().BANK_NAME || d.data().MODE || ""
        }));
        
        populateCategoryFilter();
        populateBankFilter();
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        return false;
      }
    }

    // Load budgets
    async function loadBudgets() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "budgets"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allBudgets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadBudgets error:", err);
        return false;
      }
    }

    // Load forecasts
    async function loadForecasts() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "forecasts"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allForecasts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadForecasts error:", err);
        return false;
      }
    }

    // Load alerts
    async function loadAlerts() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "alerts"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allAlerts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadAlerts error:", err);
        return false;
      }
    }

    // Populate category filter
    function populateCategoryFilter() {
      const categories = new Set();
      allTransactions.forEach(tx => {
        if (tx.ACCOUNT_HEADER) {
          categories.add(tx.ACCOUNT_HEADER);
        }
      });
      allBudgets.forEach(budget => {
        categories.add(budget.category);
      });
      
      categoryFilter.innerHTML = '<option value="all">All Categories</option>';
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }

    // Populate bank filter
    function populateBankFilter() {
      const banks = new Set();
      allTransactions.forEach(tx => {
        if (tx.BANK_NAME || tx.MODE) {
          banks.add(tx.BANK_NAME || tx.MODE);
        }
      });
      
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      banks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        bankFilter.appendChild(option);
      });
    }

    // Update dashboard
    function updateDashboard() {
      updateTopStats();
      updateBudgetCards();
      updateForecastCards();
      updateAnalysis();
      updateTips();
      updateAlerts();
    }

    // Update top stats
    function updateTopStats() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Calculate total budget for current period
      let totalBudget = 0;
      let totalSpent = 0;
      
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
        }
      });
      
      // Calculate spending for current period
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            totalSpent += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      // Calculate savings
      let totalIncome = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Income') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            totalIncome += parseFloat(tx.INCOME) || 0;
          }
        }
      });
      
      const remainingBudget = totalBudget - totalSpent;
      const projectedSavings = totalIncome - totalSpent;
      
      // Update stats
      statBudget.textContent = `$${totalBudget.toFixed(2)}`;
      statSpent.textContent = `$${totalSpent.toFixed(2)}`;
      statRemaining.textContent = `$${remainingBudget.toFixed(2)}`;
      statSavings.textContent = `$${projectedSavings.toFixed(2)}`;
      
      // Add color classes
      statSpent.classList.add('expense-color');
      statRemaining.classList.add('success-color');
      statSavings.classList.add('info-color');
      
      // Calculate changes (simulated)
      const budgetChangePercent = 5.2;
      const spentChangePercent = 3.8;
      const remainingPercent = totalBudget > 0 ? (remainingBudget / totalBudget * 100).toFixed(1) : 0;
      const savingsRate = totalIncome > 0 ? (projectedSavings / totalIncome * 100).toFixed(1) : 0;
      
      budgetChange.innerHTML = `<i class="fa fa-arrow-up"></i> ${budgetChangePercent}%`;
      spentChange.innerHTML = `<i class="fa fa-arrow-up"></i> ${spentChangePercent}%`;
      remainingChange.textContent = `${remainingPercent}% of budget`;
      savingsChange.textContent = `${savingsRate}% of income`;
      
      // Add color to changes
      budgetChange.classList.add('positive-change');
      spentChange.classList.add('negative-change');
      
      // Add click handlers to stat cards
      document.getElementById('totalBudgetCard').onclick = () => showBudgetDetails();
      document.getElementById('totalSpentCard').onclick = () => showSpendingDetails();
      document.getElementById('remainingBudgetCard').onclick = () => showRemainingDetails();
      document.getElementById('savingsCard').onclick = () => showSavingsDetails();
    }

    // Check if date is in current period
    function isInCurrentPeriod(date) {
      const now = new Date();
      
      switch (currentPeriod) {
        case 'week':
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 7);
          return date >= weekStart && date < weekEnd;
          
        case 'month':
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
          
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
          return date >= quarterStart && date < quarterEnd;
          
        case 'year':
          return date.getFullYear() === now.getFullYear();
          
        default:
          return true;
      }
    }

    // Update budget cards
    function updateBudgetCards() {
      budgetCards.innerHTML = '';
      
      // Filter budgets for current period
      const periodBudgets = allBudgets.filter(budget => budget.period === currentPeriod);
      
      if (periodBudgets.length === 0) {
        budgetCards.innerHTML = `
          <div class="col-12 text-center text-muted py-4">
            <i class="fa fa-piggy-bank fa-3x mb-3"></i>
            <h5>No budgets set for ${currentPeriod} period</h5>
            <p>Click "Set Budget" to create your first budget</p>
          </div>
        `;
        return;
      }
      
      periodBudgets.forEach(budget => {
        // Calculate spending for this category
        let categorySpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
            const txDate = new Date(tx.DATE);
            if (isInCurrentPeriod(txDate)) {
              categorySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        const budgetAmount = parseFloat(budget.amount) || 0;
        const spendingPercent = budgetAmount > 0 ? (categorySpending / budgetAmount * 100) : 0;
        
        let status = 'under';
        let statusText = 'Under Budget';
        if (spendingPercent >= 100) {
          status = 'over';
          statusText = 'Over Budget';
        } else if (spendingPercent >= 80) {
          status = 'warning';
          statusText = 'Approaching Limit';
        }
        
        const card = document.createElement('div');
        card.className = 'budget-card';
        card.innerHTML = `
          ${spendingPercent >= 100 ? '<div class="limit-indicator"><i class="fa fa-exclamation"></i></div>' : ''}
          <div class="budget-card-header">
            <div class="budget-category">${escapeHtml(budget.category)}</div>
            <div class="budget-status ${status}">${statusText}</div>
          </div>
          <div class="budget-progress">
            <div class="budget-progress-bar" style="width: ${Math.min(spendingPercent, 100)}%; background: ${getProgressColor(spendingPercent)}"></div>
          </div>
          <div class="budget-amounts">
            <div class="budget-spent">$${categorySpending.toFixed(2)}</div>
            <div class="budget-limit">of $${budgetAmount.toFixed(2)}</div>
          </div>
          <div class="mt-2 small text-muted">${spendingPercent.toFixed(1)}% spent</div>
        `;
        
        budgetCards.appendChild(card);
      });
      
      updateBudgetChart();
    }

    // Get progress bar color based on percentage
    function getProgressColor(percent) {
      if (percent >= 100) return 'var(--danger)';
      if (percent >= 80) return 'var(--warning)';
      return 'var(--success)';
    }

    // Update forecast cards
    function updateForecastCards() {
      forecastCards.innerHTML = '';
      
      if (allForecasts.length === 0) {
        forecastCards.innerHTML = `
          <div class="col-12 text-center text-muted py-4">
            <i class="fa fa-chart-line fa-3x mb-3"></i>
            <h5>No forecasts created yet</h5>
            <p>Click "Create Forecast" to generate financial projections</p>
          </div>
        `;
        return;
      }
      
      // Show latest forecast
      const latestForecast = allForecasts[0];
      
      forecastCards.innerHTML = `
        <div class="forecast-card">
          <div class="forecast-period">${latestForecast.type} Forecast - Next ${latestForecast.duration} months</div>
          <div class="forecast-amount">$${latestForecast.projectedAmount?.toFixed(2) || '0.00'}</div>
          <div class="forecast-details">
            <div><strong>Based on:</strong> ${latestForecast.historicalMonths || 6} months of data</div>
            <div><strong>Growth rate:</strong> ${latestForecast.growthRate || 0}% per month</div>
            <div><strong>Created:</strong> ${new Date(latestForecast.createdAt?.toDate()).toLocaleDateString()}</div>
          </div>
        </div>
      `;
      
      updateForecastChart();
    }

    // Update analysis sections
    function updateAnalysis() {
      updateTopIncomeSources();
      updateTopSpendingCategories();
      updateSavingsOpportunities();
      updateSpendingDistribution();
      updateSpendingTrendChart();
    }

    // Update top income sources
    function updateTopIncomeSources() {
      const incomeBySource = {};
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Income') {
          const source = tx.ACCOUNT_HEADER || 'Unknown';
          const amount = parseFloat(tx.INCOME) || 0;
          incomeBySource[source] = (incomeBySource[source] || 0) + amount;
        }
      });
      
      const sortedSources = Object.entries(incomeBySource)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      if (sortedSources.length === 0) {
        topIncomeSources.innerHTML = '<p class="text-muted">No income data available</p>';
        return;
      }
      
      let html = '';
      sortedSources.forEach(([source, amount], index) => {
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <span class="badge bg-primary me-2">${index + 1}</span>
              ${escapeHtml(source)}
            </div>
            <div class="fw-bold">$${amount.toFixed(2)}</div>
          </div>
        `;
      });
      
      topIncomeSources.innerHTML = html;
    }

    // Update top spending categories
    function updateTopSpendingCategories() {
      const spendingByCategory = {};
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          const amount = parseFloat(tx.EXPENSE) || 0;
          spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
        }
      });
      
      const sortedCategories = Object.entries(spendingByCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      if (sortedCategories.length === 0) {
        topSpendingCategories.innerHTML = '<p class="text-muted">No spending data available</p>';
        return;
      }
      
      let html = '';
      sortedCategories.forEach(([category, amount], index) => {
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <span class="badge bg-danger me-2">${index + 1}</span>
              ${escapeHtml(category)}
            </div>
            <div class="fw-bold">$${amount.toFixed(2)}</div>
          </div>
        `;
      });
      
      topSpendingCategories.innerHTML = html;
    }

    // Update savings opportunities
    function updateSavingsOpportunities() {
      // Analyze spending patterns to find savings opportunities
      const opportunities = [];
      
      // Find recurring subscriptions
      const subscriptions = {};
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const desc = (tx.DESCRIPTION || '').toLowerCase();
          if (desc.includes('netflix') || desc.includes('spotify') || desc.includes('prime') || 
              desc.includes('subscription') || desc.includes('membership')) {
            const category = tx.ACCOUNT_HEADER || 'Entertainment';
            subscriptions[category] = (subscriptions[category] || 0) + (parseFloat(tx.EXPENSE) || 0);
          }
        }
      });
      
      if (Object.keys(subscriptions).length > 0) {
        const totalSubscriptions = Object.values(subscriptions).reduce((a, b) => a + b, 0);
        opportunities.push({
          title: 'Review Subscriptions',
          description: `You're spending $${totalSubscriptions.toFixed(2)} monthly on subscriptions. Consider canceling unused ones.`,
          potentialSavings: totalSubscriptions * 0.3 // Assume 30% savings
        });
      }
      
      // Find high spending categories
      const spendingByCategory = {};
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          const amount = parseFloat(tx.EXPENSE) || 0;
          spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
        }
      });
      
      const highSpendingCategories = Object.entries(spendingByCategory)
        .filter(([_, amount]) => amount > 500) // Categories with more than $500 spending
        .sort((a, b) => b[1] - a[1]);
      
      if (highSpendingCategories.length > 0) {
        const [category, amount] = highSpendingCategories[0];
        opportunities.push({
          title: `Reduce ${category} Spending`,
          description: `Your ${category} spending is high ($${amount.toFixed(2)}). Look for ways to reduce it.`,
          potentialSavings: amount * 0.15 // Assume 15% savings
        });
      }
      
      // Find eating out expenses
      let eatingOut = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const desc = (tx.DESCRIPTION || '').toLowerCase();
          const category = (tx.ACCOUNT_HEADER || '').toLowerCase();
          if (desc.includes('restaurant') || desc.includes('cafe') || desc.includes('food') || 
              category.includes('food') || category.includes('dining')) {
            eatingOut += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      if (eatingOut > 200) {
        opportunities.push({
          title: 'Reduce Eating Out',
          description: `You're spending $${eatingOut.toFixed(2)} on eating out. Cooking at home could save you money.`,
          potentialSavings: eatingOut * 0.4 // Assume 40% savings
        });
      }
      
      if (opportunities.length === 0) {
        savingsOpportunities.innerHTML = '<p class="text-muted">No specific savings opportunities identified</p>';
        return;
      }
      
      let html = '';
      opportunities.forEach((opp, index) => {
        html += `
          <div class="mb-3">
            <h6 class="mb-1">${opp.title}</h6>
            <p class="small mb-1">${opp.description}</p>
            <div class="small text-success">
              <i class="fa fa-coins me-1"></i>
              Potential savings: $${opp.potentialSavings.toFixed(2)}/month
            </div>
          </div>
        `;
      });
      
      savingsOpportunities.innerHTML = html;
    }

    // Update spending distribution
    function updateSpendingDistribution() {
      const spendingByCategory = {};
      let totalSpending = 0;
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          const amount = parseFloat(tx.EXPENSE) || 0;
          spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
          totalSpending += amount;
        }
      });
      
      const sortedCategories = Object.entries(spendingByCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6); // Top 6 categories
      
      if (sortedCategories.length === 0) {
        spendingDistribution.innerHTML = '<p class="text-muted">No spending data available</p>';
        return;
      }
      
      let html = '';
      sortedCategories.forEach(([category, amount]) => {
        const percentage = totalSpending > 0 ? (amount / totalSpending * 100).toFixed(1) : 0;
        html += `
          <div class="mb-2">
            <div class="d-flex justify-content-between mb-1">
              <span>${escapeHtml(category)}</span>
              <span>${percentage}%</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar" role="progressbar" style="width: ${percentage}%"></div>
            </div>
            <div class="small text-muted text-end">$${amount.toFixed(2)}</div>
          </div>
        `;
      });
      
      // Add "Other" category if there are more
      if (Object.keys(spendingByCategory).length > 6) {
        const otherAmount = totalSpending - sortedCategories.reduce((sum, [_, amount]) => sum + amount, 0);
        const otherPercentage = totalSpending > 0 ? (otherAmount / totalSpending * 100).toFixed(1) : 0;
        html += `
          <div class="mb-2">
            <div class="d-flex justify-content-between mb-1">
              <span>Other Categories</span>
              <span>${otherPercentage}%</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-secondary" role="progressbar" style="width: ${otherPercentage}%"></div>
            </div>
            <div class="small text-muted text-end">$${otherAmount.toFixed(2)}</div>
          </div>
        `;
      }
      
      spendingDistribution.innerHTML = html;
    }

    // Update tips
    function updateTips() {
      updatePersonalizedTips();
      updateWeeklyChallenge();
      updateForecastInsights();
    }

    // Update personalized tips
    function updatePersonalizedTips() {
      const tips = [];
      
      // Analyze spending patterns for tips
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Calculate monthly spending
      let monthlySpending = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
            monthlySpending += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      // Calculate monthly income
      let monthlyIncome = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Income') {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
            monthlyIncome += parseFloat(tx.INCOME) || 0;
          }
        }
      });
      
      // Tip based on savings rate
      if (monthlyIncome > 0) {
        const savingsRate = ((monthlyIncome - monthlySpending) / monthlyIncome * 100);
        if (savingsRate < 10) {
          tips.push({
            title: 'Increase Your Savings Rate',
            message: `Your current savings rate is ${savingsRate.toFixed(1)}%. Aim for at least 20% for better financial health.`
          });
        } else if (savingsRate > 30) {
          tips.push({
            title: 'Great Savings Rate!',
            message: `Your savings rate of ${savingsRate.toFixed(1)}% is excellent! Consider investing some of your savings.`
          });
        }
      }
      
      // Tip for high spending months
      const monthlySpendingHistory = getMonthlySpendingHistory(6);
      if (monthlySpendingHistory.length >= 3) {
        const avgSpending = monthlySpendingHistory.reduce((a, b) => a + b, 0) / monthlySpendingHistory.length;
        if (monthlySpending > avgSpending * 1.2) {
          tips.push({
            title: 'Higher Than Usual Spending',
            message: `Your spending this month is ${((monthlySpending/avgSpending - 1)*100).toFixed(0)}% higher than average. Review your expenses.`
          });
        }
      }
      
      // Tip for unused budgets
      const activeBudgets = allBudgets.filter(b => b.period === 'monthly');
      activeBudgets.forEach(budget => {
        let budgetSpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
              budgetSpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        const budgetAmount = parseFloat(budget.amount) || 0;
        if (budgetSpending < budgetAmount * 0.3 && budgetAmount > 100) {
          tips.push({
            title: `Underutilized ${budget.category} Budget`,
            message: `You've only used ${((budgetSpending/budgetAmount)*100).toFixed(0)}% of your ${budget.category} budget. Consider reallocating funds.`
          });
        }
      });
      
      // Default tips if none generated
      if (tips.length === 0) {
        tips.push(
          {
            title: 'Track Every Expense',
            message: 'Consistently tracking all expenses helps identify spending patterns and opportunities to save.'
          },
          {
            title: 'Set SMART Goals',
            message: 'Specific, Measurable, Achievable, Relevant, Time-bound goals are more likely to be achieved.'
          },
          {
            title: 'Review Budget Weekly',
            message: 'Weekly budget reviews help catch overspending early and make adjustments.'
          }
        );
      }
      
      let html = '';
      tips.forEach(tip => {
        html += `
          <div class="tip-card">
            <h6>${tip.title}</h6>
            <p>${tip.message}</p>
          </div>
        `;
      });
      
      personalizedTips.innerHTML = html;
    }

    // Update weekly challenge
    function updateWeeklyChallenge() {
      const challenges = [
        {
          title: 'No Eating Out Week',
          description: 'Commit to cooking all meals at home for one week.',
          potentialSavings: 75,
          difficulty: 'Medium'
        },
        {
          title: 'Subscription Audit',
          description: 'Review and cancel at least one unused subscription.',
          potentialSavings: 15,
          difficulty: 'Easy'
        },
        {
          title: 'Energy Saving Week',
          description: 'Reduce electricity and water usage for a week.',
          potentialSavings: 25,
          difficulty: 'Easy'
        },
        {
          title: 'Cash Only Week',
          description: 'Use only cash for discretionary spending.',
          potentialSavings: 50,
          difficulty: 'Hard'
        }
      ];
      
      const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
      
      weeklyChallenge.innerHTML = `
        <div class="tip-card">
          <h6>${randomChallenge.title}</h6>
          <p>${randomChallenge.description}</p>
          <div class="d-flex justify-content-between mt-2">
            <span class="badge bg-info">Potential Savings: $${randomChallenge.potentialSavings}</span>
            <span class="badge bg-warning">${randomChallenge.difficulty}</span>
          </div>
        </div>
      `;
    }

    // Update forecast insights
    function updateForecastInsights() {
      if (allForecasts.length === 0) {
        forecastInsights.innerHTML = `
          <div class="tip-card">
            <h6>Create Your First Forecast</h6>
            <p>Run a financial forecast to get personalized insights about your future finances.</p>
          </div>
        `;
        return;
      }
      
      const latestForecast = allForecasts[0];
      const insights = [];
      
      if (latestForecast.type === 'savings' || latestForecast.type === 'complete') {
        const projectedSavings = latestForecast.projectedAmount || 0;
        if (projectedSavings > 0) {
          insights.push({
            title: 'Positive Savings Trend',
            message: `Your forecast shows positive savings of $${projectedSavings.toFixed(2)} over the next ${latestForecast.duration} months.`
          });
        } else {
          insights.push({
            title: 'Savings Attention Needed',
            message: `Your forecast shows negative savings. Consider increasing income or reducing expenses.`
          });
        }
      }
      
      if (latestForecast.growthRate > 5) {
        insights.push({
          title: 'High Growth Projection',
          message: `Your forecast assumes ${latestForecast.growthRate}% monthly growth. Ensure this is realistic based on historical trends.`
        });
      }
      
      if (latestForecast.includeSeasonality) {
        insights.push({
          title: 'Seasonal Patterns Included',
          message: 'Your forecast accounts for seasonal spending patterns for more accurate projections.'
        });
      }
      
      // Default insight
      if (insights.length === 0) {
        insights.push({
          title: 'Forecast Ready',
          message: `Your ${latestForecast.type} forecast is based on ${latestForecast.historicalMonths} months of historical data.`
        });
      }
      
      let html = '';
      insights.forEach(insight => {
        html += `
          <div class="tip-card">
            <h6>${insight.title}</h6>
            <p>${insight.message}</p>
          </div>
        `;
      });
      
      forecastInsights.innerHTML = html;
    }

    // Update alerts
    function updateAlerts() {
      updateLimitAlertsTable();
      updateAlertHistoryTable();
      updateUpcomingExceedances();
    }

    // Update limit alerts table
    function updateLimitAlertsTable() {
      const activeAlerts = allAlerts.filter(alert => alert.status === 'active');
      
      if (activeAlerts.length === 0) {
        limitAlertsTable.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No limit alerts set. Click "Set Alert" to create one.
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      activeAlerts.forEach(alert => {
        // Calculate current status
        let currentValue = 0;
        let limitValue = parseFloat(alert.limitValue) || 0;
        
        // Calculate based on alert type
        switch (alert.limitType) {
          case 'spending':
            allTransactions.forEach(tx => {
              if (tx.TYPE === 'Expense') {
                const txDate = new Date(tx.DATE);
                if (isInAlertPeriod(txDate, alert.limitPeriod)) {
                  if (alert.target === 'all' || tx.ACCOUNT_HEADER === alert.target || tx.BANK_NAME === alert.target) {
                    currentValue += parseFloat(tx.EXPENSE) || 0;
                  }
                }
              }
            });
            break;
            
          case 'balance':
            // This would require bank balance tracking
            currentValue = 1000; // Placeholder
            break;
            
          case 'transaction':
            allTransactions.forEach(tx => {
              const txDate = new Date(tx.DATE);
              if (isInAlertPeriod(txDate, alert.limitPeriod)) {
                if (alert.target === 'all' || tx.ACCOUNT_HEADER === alert.target || tx.BANK_NAME === alert.target) {
                  currentValue++;
                }
              }
            });
            break;
        }
        
        const percentage = limitValue > 0 ? (currentValue / limitValue * 100) : 0;
        let status = 'Within Limit';
        let statusClass = 'success';
        
        if (percentage >= 100) {
          status = 'Exceeded';
          statusClass = 'danger';
        } else if (percentage >= 80) {
          status = 'Near Limit';
          statusClass = 'warning';
        }
        
        html += `
          <tr>
            <td>${escapeHtml(alert.target)}</td>
            <td>${alert.limitType}</td>
            <td>$${limitValue.toFixed(2)}</td>
            <td>$${currentValue.toFixed(2)}</td>
            <td><span class="badge bg-${statusClass}">${status}</span></td>
            <td>${alert.alertFrequency}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger delete-alert" data-id="${alert.id}">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      limitAlertsTable.innerHTML = html;
      
      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-alert').forEach(button => {
        button.addEventListener('click', function() {
          const alertId = this.getAttribute('data-id');
          deleteAlert(alertId);
        });
      });
    }

    // Update alert history table
    function updateAlertHistoryTable() {
      const triggeredAlerts = allAlerts.filter(alert => alert.triggeredAt);
      
      if (triggeredAlerts.length === 0) {
        alertHistoryTable.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No alert history available.
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      triggeredAlerts.slice(0, 10).forEach(alert => {
        html += `
          <tr>
            <td>${new Date(alert.triggeredAt?.toDate()).toLocaleDateString()}</td>
            <td>${escapeHtml(alert.target)}</td>
            <td>${alert.limitType}</td>
            <td>${alert.message || 'Limit exceeded'}</td>
            <td><span class="badge bg-danger">Triggered</span></td>
          </tr>
        `;
      });
      
      alertHistoryTable.innerHTML = html;
    }

    // Update upcoming exceedances
    function updateUpcomingExceedances() {
      const upcoming = [];
      
      // Check budgets for potential exceedances
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          let spent = 0;
          allTransactions.forEach(tx => {
            if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
              const txDate = new Date(tx.DATE);
              if (isInCurrentPeriod(txDate)) {
                spent += parseFloat(tx.EXPENSE) || 0;
              }
            }
          });
          
          const limit = parseFloat(budget.amount) || 0;
          const percentage = limit > 0 ? (spent / limit * 100) : 0;
          
          if (percentage >= 80 && percentage < 100) {
            const daysRemaining = getDaysRemainingInPeriod();
            const projectedSpending = (spent / (getDaysInPeriod() - daysRemaining)) * getDaysInPeriod();
            
            if (projectedSpending > limit) {
              upcoming.push({
                type: 'budget',
                category: budget.category,
                current: spent,
                limit: limit,
                percentage: percentage,
                projected: projectedSpending
              });
            }
          }
        }
      });
      
      if (upcoming.length === 0) {
        upcomingExceedances.innerHTML = `
          <div class="alert alert-success">
            <i class="fa fa-check-circle me-2"></i>
            No budget exceedances projected for the current period.
          </div>
        `;
        return;
      }
      
      let html = '';
      upcoming.forEach(item => {
        html += `
          <div class="alert alert-warning">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <i class="fa fa-exclamation-triangle me-2"></i>
                <strong>${escapeHtml(item.category)}</strong> budget may be exceeded
              </div>
              <span class="badge bg-warning">${item.percentage.toFixed(1)}% spent</span>
            </div>
            <div class="mt-2 small">
              Current: $${item.current.toFixed(2)} | Limit: $${item.limit.toFixed(2)}<br>
              Projected: $${item.projected.toFixed(2)} (exceeds by $${(item.projected - item.limit).toFixed(2)})
            </div>
          </div>
        `;
      });
      
      upcomingExceedances.innerHTML = html;
    }

    // Helper: Check if date is in alert period
    function isInAlertPeriod(date, period) {
      const now = new Date();
      
      switch (period) {
        case 'daily':
          return date.toDateString() === now.toDateString();
        case 'weekly':
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 7);
          return date >= weekStart && date < weekEnd;
        case 'monthly':
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        case 'quarterly':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
          return date >= quarterStart && date < quarterEnd;
        case 'yearly':
          return date.getFullYear() === now.getFullYear();
        default:
          return true;
      }
    }

    // Helper: Get days remaining in current period
    function getDaysRemainingInPeriod() {
      const now = new Date();
      
      switch (currentPeriod) {
        case 'week':
          return 7 - now.getDay();
        case 'month':
          const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
          return lastDay - now.getDate();
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 0);
          return Math.ceil((quarterEnd - now) / (1000 * 60 * 60 * 24));
        case 'year':
          const yearEnd = new Date(now.getFullYear(), 11, 31);
          return Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24));
        default:
          return 0;
      }
    }

    // Helper: Get total days in current period
    function getDaysInPeriod() {
      const now = new Date();
      
      switch (currentPeriod) {
        case 'week':
          return 7;
        case 'month':
          return new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 0);
          return Math.ceil((quarterEnd - quarterStart) / (1000 * 60 * 60 * 24)) + 1;
        case 'year':
          return new Date(now.getFullYear(), 11, 31).getDate();
        default:
          return 30;
      }
    }

    // Helper: Get monthly spending history
    function getMonthlySpendingHistory(months) {
      const history = [];
      const now = new Date();
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let monthlySpending = 0;
        
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense') {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              monthlySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        history.push(monthlySpending);
      }
      
      return history;
    }

    // Initialize charts
    function initializeCharts() {
      // Budget chart
      const budgetCtx = document.getElementById('budgetChart').getContext('2d');
      budgetChart = new Chart(budgetCtx, {
        type: 'bar',
        data: {
          labels: ['Budget', 'Spent', 'Remaining'],
          datasets: [{
            label: 'Amount ($)',
            data: [0, 0, 0],
            backgroundColor: [
              'rgba(111, 66, 193, 0.7)',
              'rgba(220, 53, 69, 0.7)',
              'rgba(25, 135, 84, 0.7)'
            ],
            borderColor: [
              'rgba(111, 66, 193, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(25, 135, 84, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Budget Overview',
              color: 'var(--text-primary)'
            }
          }
        }
      });
      
      // Top spending chart
      const topSpendingCtx = document.getElementById('topSpendingChart').getContext('2d');
      topSpendingChart = new Chart(topSpendingCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              'rgba(220, 53, 69, 0.7)',
              'rgba(220, 53, 69, 0.6)',
              'rgba(220, 53, 69, 0.5)',
              'rgba(220, 53, 69, 0.4)',
              'rgba(220, 53, 69, 0.3)'
            ],
            borderColor: [
              'rgba(220, 53, 69, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'var(--text-primary)'
              }
            },
            title: {
              display: true,
              text: 'Top Spending Categories',
              color: 'var(--text-primary)'
            }
          }
        }
      });
      
      // Forecast chart
      const forecastCtx = document.getElementById('forecastChart').getContext('2d');
      forecastChart = new Chart(forecastCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Forecast',
            data: [],
            borderColor: 'rgba(111, 66, 193, 1)',
            backgroundColor: 'rgba(111, 66, 193, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Financial Forecast',
              color: 'var(--text-primary)'
            }
          }
        }
      });
      
      // Income vs Expense forecast chart
      const incomeExpenseForecastCtx = document.getElementById('incomeExpenseForecastChart').getContext('2d');
      incomeExpenseForecastChart = new Chart(incomeExpenseForecastCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Income',
              data: [],
              borderColor: 'rgba(25, 135, 84, 1)',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Expenses',
              data: [],
              borderColor: 'rgba(220, 53, 69, 1)',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Income vs Expense Projection',
              color: 'var(--text-primary)'
            }
          }
        }
      });
      
      // Spending trend chart
      const spendingTrendCtx = document.getElementById('spendingTrendChart').getContext('2d');
      spendingTrendChart = new Chart(spendingTrendCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Monthly Spending',
            data: [],
            borderColor: 'rgba(220, 53, 69, 1)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Monthly Spending Trends',
              color: 'var(--text-primary)'
            }
          }
        }
      });
      
      // Category analysis chart
      const categoryAnalysisCtx = document.getElementById('categoryAnalysisChart').getContext('2d');
      categoryAnalysisChart = new Chart(categoryAnalysisCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Spending',
            data: [],
            backgroundColor: 'rgba(111, 66, 193, 0.7)',
            borderColor: 'rgba(111, 66, 193, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Category-wise Spending',
              color: 'var(--text-primary)'
            }
          }
        }
      });
    }

    // Update budget chart
    function updateBudgetChart() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let totalBudget = 0;
      let totalSpent = 0;
      
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
        }
      });
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            totalSpent += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const remaining = totalBudget - totalSpent;
      
      budgetChart.data.datasets[0].data = [totalBudget, totalSpent, remaining];
      budgetChart.update();
    }

    // Update top spending chart
    function updateTopSpendingChart() {
      const period = document.getElementById('topSpendingPeriod').value;
      const now = new Date();
      
      const spendingByCategory = {};
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          let include = false;
          
          switch (period) {
            case 'month':
              include = txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
              break;
            case 'quarter':
              const quarter = Math.floor(now.getMonth() / 3);
              const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
              const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
              include = txDate >= quarterStart && txDate < quarterEnd;
              break;
            case 'year':
              include = txDate.getFullYear() === now.getFullYear();
              break;
          }
          
          if (include) {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            const amount = parseFloat(tx.EXPENSE) || 0;
            spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
          }
        }
      });
      
      const sortedCategories = Object.entries(spendingByCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      topSpendingChart.data.labels = sortedCategories.map(([category]) => category);
      topSpendingChart.data.datasets[0].data = sortedCategories.map(([_, amount]) => amount);
      topSpendingChart.update();
    }

    // Update forecast chart
    function updateForecastChart() {
      if (allForecasts.length === 0) return;
      
      const forecast = allForecasts[0];
      const months = forecast.duration || 6;
      const baseAmount = forecast.baseAmount || 1000;
      const growthRate = forecast.growthRate || 0;
      
      const labels = [];
      const data = [];
      
      for (let i = 1; i <= months; i++) {
        labels.push(`Month ${i}`);
        const amount = baseAmount * Math.pow(1 + growthRate / 100, i - 1);
        data.push(amount);
      }
      
      forecastChart.data.labels = labels;
      forecastChart.data.datasets[0].data = data;
      forecastChart.update();
    }

    // Update income vs expense forecast chart
    function updateIncomeExpenseForecastChart() {
      const months = 6; // Default to 6 months
      const now = new Date();
      
      // Calculate average monthly income and expenses
      let totalIncome = 0;
      let totalExpenses = 0;
      let monthCount = 0;
      
      const monthlyData = {};
      
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        const monthYear = `${txDate.getFullYear()}-${txDate.getMonth()}`;
        
        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = { income: 0, expenses: 0 };
        }
        
        if (tx.TYPE === 'Income') {
          monthlyData[monthYear].income += parseFloat(tx.INCOME) || 0;
          totalIncome += parseFloat(tx.INCOME) || 0;
        } else if (tx.TYPE === 'Expense') {
          monthlyData[monthYear].expenses += parseFloat(tx.EXPENSE) || 0;
          totalExpenses += parseFloat(tx.EXPENSE) || 0;
        }
      });
      
      monthCount = Object.keys(monthlyData).length;
      const avgMonthlyIncome = monthCount > 0 ? totalIncome / monthCount : 0;
      const avgMonthlyExpenses = monthCount > 0 ? totalExpenses / monthCount : 0;
      
      // Generate forecast
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      
      for (let i = 1; i <= months; i++) {
        const forecastDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
        labels.push(forecastDate.toLocaleDateString('default', { month: 'short', year: 'numeric' }));
        
        // Simple forecast with 2% monthly growth for income, 1% for expenses
        const income = avgMonthlyIncome * Math.pow(1.02, i - 1);
        const expenses = avgMonthlyExpenses * Math.pow(1.01, i - 1);
        
        incomeData.push(income);
        expenseData.push(expenses);
      }
      
      incomeExpenseForecastChart.data.labels = labels;
      incomeExpenseForecastChart.data.datasets[0].data = incomeData;
      incomeExpenseForecastChart.data.datasets[1].data = expenseData;
      incomeExpenseForecastChart.update();
    }

    // Update spending trend chart
    function updateSpendingTrendChart() {
      const months = parseInt(document.getElementById('trendPeriod').value) || 6;
      const now = new Date();
      
      const labels = [];
      const data = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short', year: 'numeric' }));
        
        let monthlySpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense') {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              monthlySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        data.push(monthlySpending);
      }
      
      spendingTrendChart.data.labels = labels;
      spendingTrendChart.data.datasets[0].data = data;
      spendingTrendChart.update();
    }

    // Update category analysis chart
    function updateCategoryAnalysisChart(category) {
      if (!category) return;
      
      const now = new Date();
      const months = 6;
      
      const labels = [];
      const data = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        let monthlySpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === category) {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              monthlySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        data.push(monthlySpending);
      }
      
      categoryAnalysisChart.data.labels = labels;
      categoryAnalysisChart.data.datasets[0].data = data;
      categoryAnalysisChart.options.plugins.title.text = `${category} Spending Trend`;
      categoryAnalysisChart.update();
    }

    // Event Listeners
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    backBtn.addEventListener("click", () => window.history.back());
    homeBtn.addEventListener("click", () => window.location.href = "home.html");
    transactionsBtn.addEventListener("click", () => window.location.href = "transaction.html");
    coaBtn.addEventListener("click", () => window.location.href = "coa.html");

    // Theme toggle
    themeToggle.addEventListener("click", () => toggleTheme());

    // Period selector
    periodButtons.forEach(btn => {
      btn.addEventListener("click", function() {
        periodButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.getAttribute('data-period');
        updateDashboard();
      });
    });

    // Filter buttons
    applyFiltersBtn.addEventListener("click", () => {
      updateDashboard();
    });

    resetFiltersBtn.addEventListener("click", () => {
      categoryFilter.value = 'all';
      bankFilter.value = 'all';
      updateDashboard();
    });

    // Top spending period change
    document.getElementById('topSpendingPeriod').addEventListener('change', updateTopSpendingChart);
    
    // Forecast period buttons
    document.getElementById('forecast3Months').addEventListener('click', function() {
      document.querySelectorAll('#forecastTab .btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      updateIncomeExpenseForecastChart();
    });
    
    document.getElementById('forecast6Months').addEventListener('click', function() {
      document.querySelectorAll('#forecastTab .btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      updateIncomeExpenseForecastChart();
    });
    
    document.getElementById('forecast12Months').addEventListener('click', function() {
      document.querySelectorAll('#forecastTab .btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      updateIncomeExpenseForecastChart();
    });

    // Trend period change
    document.getElementById('trendPeriod').addEventListener('change', updateSpendingTrendChart);

    // Category analysis change
    document.getElementById('analysisCategory').addEventListener('change', function() {
      updateCategoryAnalysisChart(this.value);
    });

    // Modal buttons
    newBudgetBtn.addEventListener("click", () => openSetBudgetModal());
    newForecastBtn.addEventListener("click", () => openCreateForecastModal());
    addBudgetCategoryBtn.addEventListener("click", () => openSetBudgetModal());
    runForecastBtn.addEventListener("click", () => openCreateForecastModal());
    setLimitAlertBtn.addEventListener("click", () => openSetLimitAlertModal());
    refreshTipsBtn.addEventListener("click", () => updateTips());

    // Save budget
    saveBudgetBtn.addEventListener("click", async () => {
      const category = document.getElementById('budgetCategory').value;
      const period = document.getElementById('budgetPeriod').value;
      const amount = document.getElementById('budgetAmount').value;
      const threshold = document.getElementById('alertThreshold').value;
      const notes = document.getElementById('budgetNotes').value;
      const rollover = document.getElementById('rolloverBudget').checked;
      
      if (!category || !amount) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please fill in all required fields' });
        return;
      }
      
      try {
        showLoading("Saving budget...");
        
        const budgetData = {
          category: category,
          period: period,
          amount: parseFloat(amount),
          alertThreshold: parseFloat(threshold) || 80,
          notes: notes,
          rollover: rollover,
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "budgets"), budgetData);
        
        hideLoading();
        Swal.fire({ icon: 'success', title: 'Success', text: 'Budget saved successfully' });
        setBudgetModal.hide();
        
        await loadBudgets();
        updateDashboard();
      } catch (err) {
        hideLoading();
        console.error("saveBudget error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save budget' });
      }
    });

    // Run forecast
    runForecastBtnModal.addEventListener("click", async () => {
      const type = document.getElementById('forecastType').value;
      const duration = parseInt(document.getElementById('forecastDuration').value);
      const historicalMonths = parseInt(document.getElementById('historicalMonths').value);
      const growthRate = parseFloat(document.getElementById('growthRate').value);
      const includeSeasonality = document.getElementById('includeSeasonality').checked;
      const adjustForInflation = document.getElementById('adjustForInflation').checked;
      
      try {
        showLoading("Running forecast...");
        
        // Calculate base amount from historical data
        let baseAmount = 0;
        const now = new Date();
        const historicalData = [];
        
        for (let i = 0; i < historicalMonths; i++) {
          const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
          let monthlyAmount = 0;
          
          allTransactions.forEach(tx => {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              if (type === 'income' && tx.TYPE === 'Income') {
                monthlyAmount += parseFloat(tx.INCOME) || 0;
              } else if (type === 'expense' && tx.TYPE === 'Expense') {
                monthlyAmount += parseFloat(tx.EXPENSE) || 0;
              } else if (type === 'savings') {
                if (tx.TYPE === 'Income') {
                  monthlyAmount += parseFloat(tx.INCOME) || 0;
                } else if (tx.TYPE === 'Expense') {
                  monthlyAmount -= parseFloat(tx.EXPENSE) || 0;
                }
              }
            }
          });
          
          historicalData.push(monthlyAmount);
        }
        
        if (historicalData.length > 0) {
          baseAmount = historicalData.reduce((a, b) => a + b, 0) / historicalData.length;
        }
        
        // Generate forecast data
        const forecastData = [];
        for (let i = 0; i < duration; i++) {
          let amount = baseAmount * Math.pow(1 + growthRate / 100, i);
          
          // Apply seasonality (simplified)
          if (includeSeasonality) {
            const month = (now.getMonth() + i) % 12;
            // Simple seasonality pattern
            if (month === 11) amount *= 1.2; // December (holidays)
            else if (month >= 5 && month <= 7) amount *= 0.9; // Summer
          }
          
          // Apply inflation
          if (adjustForInflation) {
            const annualInflation = 0.02; // 2% annual inflation
            const monthlyInflation = Math.pow(1 + annualInflation, 1/12) - 1;
            amount *= Math.pow(1 + monthlyInflation, i);
          }
          
          forecastData.push(amount);
        }
        
        const projectedAmount = forecastData.reduce((a, b) => a + b, 0);
        
        const forecastDoc = {
          type: type,
          duration: duration,
          historicalMonths: historicalMonths,
          growthRate: growthRate,
          baseAmount: baseAmount,
          projectedAmount: projectedAmount,
          forecastData: forecastData,
          includeSeasonality: includeSeasonality,
          adjustForInflation: adjustForInflation,
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "forecasts"), forecastDoc);
        
        hideLoading();
        Swal.fire({ icon: 'success', title: 'Success', text: 'Forecast created successfully' });
        createForecastModal.hide();
        
        await loadForecasts();
        updateDashboard();
      } catch (err) {
        hideLoading();
        console.error("createForecast error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to create forecast' });
      }
    });

    // Save limit alert
    saveLimitAlertBtn.addEventListener("click", async () => {
      const target = document.getElementById('alertTarget').value;
      const limitType = document.getElementById('limitType').value;
      const limitValue = document.getElementById('limitValue').value;
      const limitPeriod = document.getElementById('limitPeriod').value;
      const alertFrequency = document.getElementById('alertFrequency').value;
      const alertMessage = document.getElementById('alertMessage').value;
      
      if (!target || !limitValue) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please fill in all required fields' });
        return;
      }
      
      try {
        showLoading("Saving alert...");
        
        const alertData = {
          target: target,
          limitType: limitType,
          limitValue: parseFloat(limitValue),
          limitPeriod: limitPeriod,
          alertFrequency: alertFrequency,
          message: alertMessage || `${limitType} limit exceeded for ${target}`,
          status: 'active',
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "alerts"), alertData);
        
        hideLoading();
        Swal.fire({ icon: 'success', title: 'Success', text: 'Alert saved successfully' });
        setLimitAlertModal.hide();
        
        await loadAlerts();
        updateDashboard();
      } catch (err) {
        hideLoading();
        console.error("saveAlert error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save alert' });
      }
    });

    // Delete alert
    async function deleteAlert(alertId) {
      const result = await Swal.fire({
        title: 'Delete Alert?',
        text: 'Are you sure you want to delete this alert?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        try {
          showLoading("Deleting alert...");
          await deleteDoc(doc(db, "users", currentUser.uid, "alerts", alertId));
          hideLoading();
          Swal.fire({ icon: 'success', title: 'Deleted', text: 'Alert deleted successfully' });
          await loadAlerts();
          updateDashboard();
        } catch (err) {
          hideLoading();
          console.error("deleteAlert error:", err);
          Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete alert' });
        }
      }
    }

    // Open set budget modal
    function openSetBudgetModal() {
      // Populate category dropdown
      const categorySelect = document.getElementById('budgetCategory');
      categorySelect.innerHTML = '<option value="">Select Category</option>';
      
      const categories = new Set();
      allTransactions.forEach(tx => {
        if (tx.ACCOUNT_HEADER) {
          categories.add(tx.ACCOUNT_HEADER);
        }
      });
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
      
      // Set default period
      document.getElementById('budgetPeriod').value = currentPeriod;
      
      setBudgetModal.show();
    }

    // Open create forecast modal
    function openCreateForecastModal() {
      createForecastModal.show();
    }

    // Open set limit alert modal
    function openSetLimitAlertModal() {
      // Populate target dropdown
      const targetSelect = document.getElementById('alertTarget');
      targetSelect.innerHTML = '<option value="">Select Target</option>';
      
      // Add categories
      const categories = new Set();
      allTransactions.forEach(tx => {
        if (tx.ACCOUNT_HEADER) {
          categories.add(tx.ACCOUNT_HEADER);
        }
      });
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = `Category: ${category}`;
        targetSelect.appendChild(option);
      });
      
      // Add banks
      const banks = new Set();
      allTransactions.forEach(tx => {
        if (tx.BANK_NAME || tx.MODE) {
          banks.add(tx.BANK_NAME || tx.MODE);
        }
      });
      
      banks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = `Bank: ${bank}`;
        targetSelect.appendChild(option);
      });
      
      // Add "all" option
      const allOption = document.createElement('option');
      allOption.value = 'all';
      allOption.textContent = 'All Categories/Banks';
      targetSelect.appendChild(allOption);
      
      setLimitAlertModal.show();
    }

    // Show budget details
    function showBudgetDetails() {
      Swal.fire({
        title: 'Total Budget Details',
        html: `
          <div class="text-start">
            <p>Your total budget for the ${currentPeriod} period is <strong>${statBudget.textContent}</strong>.</p>
            <p>This includes budgets for all categories set for this period.</p>
            <p>To view or edit individual category budgets, check the "Budget Overview" tab.</p>
          </div>
        `,
        icon: 'info'
      });
    }

    // Show spending details
    function showSpendingDetails() {
      const now = new Date();
      let totalSpent = 0;
      let categoryBreakdown = {};
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            const amount = parseFloat(tx.EXPENSE) || 0;
            totalSpent += amount;
            
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            categoryBreakdown[category] = (categoryBreakdown[category] || 0) + amount;
          }
        }
      });
      
      let breakdownHtml = '';
      Object.entries(categoryBreakdown)
        .sort((a, b) => b[1] - a[1])
        .forEach(([category, amount]) => {
          const percentage = totalSpent > 0 ? (amount / totalSpent * 100).toFixed(1) : 0;
          breakdownHtml += `<div class="d-flex justify-content-between mb-1">
            <span>${escapeHtml(category)}</span>
            <span>$${amount.toFixed(2)} (${percentage}%)</span>
          </div>`;
        });
      
      Swal.fire({
        title: 'Spending Details',
        html: `
          <div class="text-start">
            <p>You've spent <strong>${statSpent.textContent}</strong> in the ${currentPeriod} period.</p>
            <div class="mt-3">
              <h6>Category Breakdown:</h6>
              ${breakdownHtml || '<p class="text-muted">No spending data</p>'}
            </div>
          </div>
        `,
        icon: 'info',
        width: 600
      });
    }

    // Show remaining details
    function showRemainingDetails() {
      Swal.fire({
        title: 'Remaining Budget',
        html: `
          <div class="text-start">
            <p>You have <strong>${statRemaining.textContent}</strong> remaining in your ${currentPeriod} budget.</p>
            <p>This is calculated as: Total Budget - Total Spent</p>
            <p class="text-success"><i class="fa fa-lightbulb me-2"></i>Tip: Try to stay within your remaining budget to achieve your financial goals.</p>
          </div>
        `,
        icon: 'success'
      });
    }

    // Show savings details
    function showSavingsDetails() {
      const now = new Date();
      let totalIncome = 0;
      let totalSpent = 0;
      
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (isInCurrentPeriod(txDate)) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalSpent += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const savings = totalIncome - totalSpent;
      const savingsRate = totalIncome > 0 ? (savings / totalIncome * 100).toFixed(1) : 0;
      
      Swal.fire({
        title: 'Projected Savings',
        html: `
          <div class="text-start">
            <p>Your projected savings for the ${currentPeriod} period is <strong>${statSavings.textContent}</strong>.</p>
            <div class="mt-3">
              <div class="d-flex justify-content-between mb-2">
                <span>Total Income:</span>
                <span class="text-success">$${totalIncome.toFixed(2)}</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Total Expenses:</span>
                <span class="text-danger">$${totalSpent.toFixed(2)}</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between mb-2">
                <span>Projected Savings:</span>
                <span class="text-info">$${savings.toFixed(2)}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Savings Rate:</span>
                <span class="fw-bold">${savingsRate}%</span>
              </div>
            </div>
            <p class="mt-3 ${parseFloat(savingsRate) >= 20 ? 'text-success' : 'text-warning'}">
              <i class="fa fa-lightbulb me-2"></i>
              ${parseFloat(savingsRate) >= 20 ? 'Excellent! You\'re saving more than 20% of your income.' : 
                parseFloat(savingsRate) >= 10 ? 'Good! Consider aiming for 20% savings rate.' :
                'Consider increasing your savings rate to at least 10%.'}
            </p>
          </div>
        `,
        icon: 'info',
        width: 600
      });
    }

    // Theme functions
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', currentTheme);
      
      // Update charts with new theme
      updateChartColors();
    }
    
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      }
    }
    
    function updateChartColors() {
      // Update all charts with new theme colors
      if (budgetChart) budgetChart.update();
      if (topSpendingChart) topSpendingChart.update();
      if (forecastChart) forecastChart.update();
      if (incomeExpenseForecastChart) incomeExpenseForecastChart.update();
      if (spendingTrendChart) spendingTrendChart.update();
      if (categoryAnalysisChart) categoryAnalysisChart.update();
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      // Initial chart updates
      setTimeout(() => {
        updateBudgetChart();
        updateTopSpendingChart();
        updateForecastChart();
        updateIncomeExpenseForecastChart();
        updateSpendingTrendChart();
        
        // Populate analysis category dropdown
        const analysisCategory = document.getElementById('analysisCategory');
        analysisCategory.innerHTML = '<option value="">Select Category</option>';
        
        const categories = new Set();
        allTransactions.forEach(tx => {
          if (tx.ACCOUNT_HEADER) {
            categories.add(tx.ACCOUNT_HEADER);
          }
        });
        
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          analysisCategory.appendChild(option);
        });
      }, 1000);
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>