<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>✨ Advanced Budget Analytics & Forecasting</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --danger-gradient: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
      --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      
      --card-bg: rgba(255, 255, 255, 0.95);
      --sidebar-bg: linear-gradient(180deg, #2c3e50 0%, #1a1a2e 100%);
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --bg-primary: #f7fafc;
      --border-color: rgba(0, 0, 0, 0.08);
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.12);
      --radius: 20px;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      --primary-gradient: linear-gradient(135deg, #8a2be2 0%, #4a00e0 100%);
      --secondary-gradient: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
      --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      --warning-gradient: linear-gradient(135deg, #ff5e62 0%, #ff9966 100%);
      --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      --info-gradient: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
      
      --card-bg: rgba(30, 33, 57, 0.95);
      --sidebar-bg: linear-gradient(180deg, #0f0c29 0%, #302b63 100%);
      --text-primary: #f7fafc;
      --text-secondary: #a0aec0;
      --bg-primary: #1a202c;
      --border-color: rgba(255, 255, 255, 0.08);
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      background: var(--bg-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: var(--text-primary);
      transition: var(--transition);
      overflow-x: hidden;
    }

    .glass-effect {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
    }

    .page-wrapper {
      display: flex;
      min-height: 100vh;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      padding: 30px 20px;
      position: fixed;
      height: 100vh;
      z-index: 1000;
      box-shadow: var(--shadow);
      transition: var(--transition);
      overflow-y: auto;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(45deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
      to { text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
    }

    .nav-item {
      margin-bottom: 10px;
      transition: var(--transition);
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 12px 20px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(5px);
    }

    .nav-link.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .nav-link i {
      width: 20px;
      text-align: center;
    }

    .theme-switch {
      position: absolute;
      bottom: 30px;
      left: 20px;
      right: 20px;
    }

    .theme-toggle-btn {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 15px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: var(--transition);
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      border-radius: var(--radius);
      background: var(--primary-gradient);
      box-shadow: var(--shadow);
      color: white;
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .main-header h1 {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 20px;
      backdrop-filter: blur(10px);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stat-card:hover {
      transform: translateY(-10px);
      box-shadow: var(--shadow-hover);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--primary-gradient);
    }

    .stat-card.income::before { background: var(--success-gradient); }
    .stat-card.expense::before { background: var(--danger-gradient); }
    .stat-card.savings::before { background: var(--info-gradient); }
    .stat-card.avg-spend::before { background: var(--warning-gradient); }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      margin-bottom: 20px;
      background: var(--primary-gradient);
    }

    .stat-card.income .stat-icon { background: var(--success-gradient); }
    .stat-card.expense .stat-icon { background: var(--danger-gradient); }
    .stat-card.savings .stat-icon { background: var(--info-gradient); }
    .stat-card.avg-spend .stat-icon { background: var(--warning-gradient); }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 5px;
      background: linear-gradient(45deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-trend {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(75, 192, 192, 0.1);
    }

    .trend-up { color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .trend-down { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    .trend-neutral { color: #6b7280; background: rgba(107, 114, 128, 0.1); }

    /* Charts Section */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Analysis Grid */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .analysis-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      animation: slideInLeft 0.6s ease-out;
    }

    @keyframes slideInLeft {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .analysis-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    /* Expense Items */
    .expense-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 12px;
      transition: var(--transition);
      animation: fadeInRight 0.5s ease-out;
    }

    [data-theme="dark"] .expense-item {
      background: rgba(255, 255, 255, 0.05);
    }

    @keyframes fadeInRight {
      from { transform: translateX(20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .expense-item:hover {
      background: rgba(0, 0, 0, 0.05);
      transform: translateX(5px);
    }

    [data-theme="dark"] .expense-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .expense-category {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
    }

    /* Limit Cards */
    .limit-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #6366f1;
      transition: var(--transition);
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .limit-card.over-limit {
      border-left-color: #ef4444;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .limit-progress {
      height: 10px;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin: 10px 0;
    }

    .limit-progress-bar {
      height: 100%;
      border-radius: 5px;
      transition: width 1s ease-in-out;
      background: linear-gradient(90deg, #10b981, #34d399);
    }

    .limit-progress-bar.warning {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .limit-progress-bar.danger {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }

    /* Forecast Card */
    .forecast-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: var(--radius);
      padding: 30px;
      color: white;
      position: relative;
      overflow: hidden;
      animation: slideInRight 0.6s ease-out;
    }

    .forecast-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .btn-success {
      background: var(--success-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .btn-warning {
      background: var(--warning-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
    }

    /* Modal */
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: none;
      box-shadow: var(--shadow-hover);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, #764ba2, #667eea);
    }

    /* Floating Elements */
    .floating-element {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0) 70%);
      z-index: -1;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    /* Loading Animation */
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(102, 126, 234, 0.1);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Tooltips */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      font-size: 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    [data-tooltip]:hover:before {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Sidebar -->
    <div class="sidebar glass-effect">
      <div class="sidebar-header">
        <h2><i class="fas fa-chart-pie"></i> BudgetMaster</h2>
        <p class="text-muted mt-2" style="color: rgba(255,255,255,0.6); font-size: 14px;">Advanced Analytics Dashboard</p>
      </div>
      
      <nav class="nav flex-column">
        <div class="nav-item">
          <a href="#" class="nav-link active" data-section="overview">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="analytics">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="forecasting">
            <i class="fas fa-crystal-ball"></i>
            <span>Forecasting</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="limits">
            <i class="fas fa-tachometer-alt"></i>
            <span>Budget Limits</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="savings">
            <i class="fas fa-piggy-bank"></i>
            <span>Savings Tips</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="reports">
            <i class="fas fa-file-alt"></i>
            <span>Reports</span>
          </a>
        </div>
      </nav>
      
      <div class="theme-switch">
        <button class="theme-toggle-btn glass-effect">
          <i class="fas fa-moon"></i>
          <span>Switch Theme</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="main-header">
        <div>
          <h1 id="pageTitle">Budget Analytics Dashboard</h1>
          <p class="mb-0" style="opacity: 0.9;" id="lastUpdated">Loading data...</p>
        </div>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div>
            <h6 class="mb-0" id="userName">User</h6>
            <small style="opacity: 0.8;">Premium Member</small>
          </div>
          <button class="btn btn-light btn-sm ms-3" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card income animate__animated animate__fadeInUp">
          <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-value" id="totalIncome">$0.00</div>
          <div class="stat-label">Total Income</div>
          <div class="stat-trend trend-up" id="incomeTrend">
            <i class="fas fa-arrow-up"></i> 12% increase
          </div>
        </div>
        
        <div class="stat-card expense animate__animated animate__fadeInUp">
          <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="stat-value" id="totalExpenses">$0.00</div>
          <div class="stat-label">Total Expenses</div>
          <div class="stat-trend trend-down" id="expenseTrend">
            <i class="fas fa-arrow-down"></i> 8% decrease
          </div>
        </div>
        
        <div class="stat-card savings animate__animated animate__fadeInUp">
          <div class="stat-icon">
            <i class="fas fa-piggy-bank"></i>
          </div>
          <div class="stat-value" id="netSavings">$0.00</div>
          <div class="stat-label">Net Savings</div>
          <div class="stat-trend trend-up" id="savingsRate">
            <i class="fas fa-chart-line"></i> 24% rate
          </div>
        </div>
        
        <div class="stat-card avg-spend animate__animated animate__fadeInUp">
          <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
          </div>
          <div class="stat-value" id="avgDailySpend">$0.00</div>
          <div class="stat-label">Avg Daily Spend</div>
          <div class="stat-trend trend-neutral" id="spendTrend">
            <i class="fas fa-minus"></i> Stable
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Income vs Expenses Trend</h3>
            <select class="form-select form-select-sm" style="width: 150px;" id="trendPeriod">
              <option value="month">Last Month</option>
              <option value="quarter">Last Quarter</option>
              <option value="year" selected>Last Year</option>
            </select>
          </div>
          <div class="chart-wrapper">
            <canvas id="trendChart" height="300"></canvas>
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Expense Categories</h3>
            <button class="btn btn-sm btn-outline-primary" id="refreshCategories">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="chart-wrapper">
            <canvas id="categoryChart" height="300"></canvas>
          </div>
        </div>
      </div>

      <!-- Analysis Grid -->
      <div class="analysis-grid">
        <!-- Top Expenses -->
        <div class="analysis-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-fire text-danger me-2"></i>Top 5 Expenses
            </h3>
            <span class="badge bg-primary" id="expenseCount">0</span>
          </div>
          <div id="topExpensesList">
            <div class="expense-item">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-utensils text-warning"></i>
                </div>
                <div>
                  <div class="fw-bold">Loading expenses...</div>
                  <small class="text-muted">Just a moment</small>
                </div>
              </div>
              <div class="expense-category">Loading</div>
            </div>
          </div>
        </div>

        <!-- Budget Limits -->
        <div class="analysis-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-tachometer-alt text-info me-2"></i>Active Limits
            </h3>
            <button class="btn btn-sm btn-primary" id="addLimitBtn">
              <i class="fas fa-plus"></i> Add Limit
            </button>
          </div>
          <div id="budgetLimits">
            <div class="limit-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h6 class="mb-0">Food & Dining</h6>
                  <small class="text-muted">Weekly Limit</small>
                </div>
                <span class="badge bg-success">Active</span>
              </div>
              <div class="limit-progress">
                <div class="limit-progress-bar" style="width: 65%"></div>
              </div>
              <div class="d-flex justify-content-between">
                <small>$195 / $300</small>
                <small>65% used</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Savings Suggestions -->
        <div class="analysis-card">
          <div class="chart-header">
            <h3 class="chart-title">
              <i class="fas fa-lightbulb text-warning me-2"></i>Savings Suggestions
            </h3>
            <button class="btn btn-sm btn-outline-warning" id="refreshSuggestions">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div id="savingsSuggestions">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Analyzing your spending patterns...
            </div>
          </div>
        </div>

        <!-- Forecast -->
        <div class="forecast-card">
          <div class="chart-header">
            <h3 class="chart-title text-white">
              <i class="fas fa-crystal-ball me-2"></i>Next Month Forecast
            </h3>
            <button class="btn btn-sm btn-light" id="runForecastBtn">
              <i class="fas fa-play"></i> Run
            </button>
          </div>
          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <div style="font-size: 12px; opacity: 0.9;">Projected Savings</div>
                <div id="forecastSavings" style="font-size: 28px; font-weight: 700;">$0.00</div>
              </div>
              <div class="stat-trend trend-up bg-white bg-opacity-10">
                <i class="fas fa-arrow-up"></i> Optimistic
              </div>
            </div>
            <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
              <div id="forecastProgress" class="progress-bar bg-success" style="width: 0%"></div>
            </div>
            <div class="row mt-3" style="font-size: 13px;">
              <div class="col-6">
                <div>Projected Income</div>
                <div id="forecastIncome" class="fw-bold">$0.00</div>
              </div>
              <div class="col-6 text-end">
                <div>Projected Expenses</div>
                <div id="forecastExpenses" class="fw-bold">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-4 text-center text-muted">
        <small>© 2024 BudgetMaster Analytics | Real-time data powered by Firebase</small>
      </div>
    </div>
  </div>

  <!-- Set Limit Modal -->
  <div class="modal fade" id="limitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-tachometer-alt me-2"></i>Set Budget Limit
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Select Account Header</label>
              <select id="limitAccount" class="form-select">
                <option value="">Loading accounts...</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Period</label>
              <select id="limitPeriod" class="form-select">
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Limit Amount ($)</label>
              <input type="number" id="limitAmount" class="form-control" placeholder="e.g., 500" min="1" step="0.01">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Alert Threshold (%)</label>
              <div class="d-flex align-items-center gap-3">
                <input type="range" id="alertThreshold" class="form-range" min="50" max="100" step="5" value="80">
                <span class="badge bg-primary" id="thresholdValue">80%</span>
              </div>
              <small class="text-muted">Get notified when you reach this percentage</small>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            This limit will be applied to all transactions under the selected account header for the chosen period.
          </div>
          
          <div class="mt-4">
            <h6>Current Active Limits</h6>
            <div id="activeLimitsList" class="mt-2">
              <!-- Active limits will be listed here -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveLimitBtn">
            <i class="fas fa-save me-1"></i> Save Limit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="loading-spinner mb-3"></div>
          <p id="loadingMessage" class="mb-0">Loading data from Firebase...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, where, orderBy, 
      addDoc, doc, setDoc, getDoc, onSnapshot, deleteDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global Variables
    let currentUser = null;
    let transactions = [];
    let analysisData = {};
    let budgetLimits = [];
    let accountHeaders = new Set();
    let trendChart, categoryChart;
    let transactionsUnsubscribe = null;
    let limitsUnsubscribe = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeEventListeners();
      loadThemePreference();
      
      // Add floating elements
      createFloatingElements();
      
      // Check authentication
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          updateUserInfo(user);
          await initializeData();
        } else {
          window.location.href = "index.html";
        }
      });
    });

    // Create floating background elements
    function createFloatingElements() {
      const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#43e97b', '#38f9d7'];
      const mainContent = document.querySelector('.main-content');
      
      for (let i = 0; i < 5; i++) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        element.style.width = `${Math.random() * 100 + 100}px`;
        element.style.height = element.style.width;
        element.style.left = `${Math.random() * 100}%`;
        element.style.top = `${Math.random() * 100}%`;
        element.style.background = `radial-gradient(circle, ${colors[i % colors.length]}20 0%, transparent 70%)`;
        element.style.animationDelay = `${i * 2}s`;
        element.style.opacity = '0.3';
        mainContent.appendChild(element);
      }
    }

    // Initialize Event Listeners
    function initializeEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          const section = link.dataset.section;
          showSection(section);
        });
      });

      // Theme toggle
      document.querySelector('.theme-toggle-btn').addEventListener('click', toggleTheme);

      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', refreshData);

      // Add limit button
      document.getElementById('addLimitBtn').addEventListener('click', showLimitModal);

      // Save limit button
      document.getElementById('saveLimitBtn').addEventListener('click', saveBudgetLimit);

      // Alert threshold slider
      document.getElementById('alertThreshold').addEventListener('input', function() {
        document.getElementById('thresholdValue').textContent = `${this.value}%`;
      });

      // Forecast button
      document.getElementById('runForecastBtn').addEventListener('click', runForecast);

      // Refresh categories
      document.getElementById('refreshCategories').addEventListener('click', updateCategoryChart);

      // Refresh suggestions
      document.getElementById('refreshSuggestions').addEventListener('click', updateSavingsSuggestions);
    }

    // Update user info
    function updateUserInfo(user) {
      const name = user.displayName || user.email || 'User';
      document.getElementById('userName').textContent = name;
      document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
    }

    // Show section
    function showSection(section) {
      document.getElementById('pageTitle').textContent = 
        section.charAt(0).toUpperCase() + section.slice(1) + ' Dashboard';
      
      // Add animation to current content
      const mainContent = document.querySelector('.main-content');
      mainContent.classList.add('animate__animated', 'animate__fadeIn');
      setTimeout(() => {
        mainContent.classList.remove('animate__animated', 'animate__fadeIn');
      }, 500);
    }

    // Initialize data
    async function initializeData() {
      showLoading('Connecting to Firebase...');
      
      try {
        // Load account headers
        await loadAccountHeaders();
        
        // Set up real-time listeners
        await setupTransactionsListener();
        await setupBudgetLimitsListener();
        
        // Initial analysis
        performComprehensiveAnalysis();
        
        hideLoading();
        
        // Show success message
        setTimeout(() => {
          Swal.fire({
            title: 'Connected!',
            text: 'Live data streaming active',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
        }, 500);
        
      } catch (error) {
        hideLoading();
        console.error('Error initializing:', error);
        Swal.fire({
          icon: 'error',
          title: 'Connection Error',
          text: 'Failed to connect to Firebase',
          footer: error.message
        });
      }
    }

    // Load account headers
    async function loadAccountHeaders() {
      if (!currentUser) return;
      
      try {
        const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
        const snapshot = await getDocs(transactionsRef);
        
        accountHeaders.clear();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.ACCOUNT_HEADER) {
            accountHeaders.add(data.ACCOUNT_HEADER);
          }
        });
        
        // Update account header dropdown
        const select = document.getElementById('limitAccount');
        select.innerHTML = '<option value="all">All Expenses</option>';
        accountHeaders.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          select.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading account headers:', error);
      }
    }

    // Set up transactions listener
    async function setupTransactionsListener() {
      if (!currentUser) return;
      
      if (transactionsUnsubscribe) {
        transactionsUnsubscribe();
      }
      
      const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
      const q = query(transactionsRef, orderBy("DATE", "desc"));
      
      transactionsUnsubscribe = onSnapshot(q, (snapshot) => {
        transactions = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          transactions.push({
            id: doc.id,
            ...data,
            DATE: data.DATE ? (data.DATE.toDate ? data.DATE.toDate() : new Date(data.DATE)) : new Date()
          });
          
          // Add to account headers
          if (data.ACCOUNT_HEADER) {
            accountHeaders.add(data.ACCOUNT_HEADER);
          }
        });
        
        // Update UI
        document.getElementById('lastUpdated').textContent = 
          `Updated: ${new Date().toLocaleTimeString()}`;
        
        // Perform analysis
        performComprehensiveAnalysis();
        
        // Update account headers dropdown
        updateAccountHeadersDropdown();
        
      }, (error) => {
        console.error("Error listening to transactions:", error);
      });
    }

    // Update account headers dropdown
    function updateAccountHeadersDropdown() {
      const select = document.getElementById('limitAccount');
      const currentValue = select.value;
      
      select.innerHTML = '<option value="all">All Expenses</option>';
      Array.from(accountHeaders).sort().forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      
      // Restore previous selection
      if (currentValue && Array.from(accountHeaders).includes(currentValue)) {
        select.value = currentValue;
      }
    }

    // Set up budget limits listener
    async function setupBudgetLimitsListener() {
      if (!currentUser) return;
      
      if (limitsUnsubscribe) {
        limitsUnsubscribe();
      }
      
      const limitsRef = collection(db, "users", currentUser.uid, "budgetLimits");
      
      limitsUnsubscribe = onSnapshot(limitsRef, (snapshot) => {
        budgetLimits = [];
        snapshot.forEach((doc) => {
          budgetLimits.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Update budget limits display
        updateBudgetLimitsDisplay();
        
      }, (error) => {
        console.error("Error listening to budget limits:", error);
      });
    }

    // Perform comprehensive analysis
    function performComprehensiveAnalysis() {
      if (transactions.length === 0) {
        showNoDataState();
        return;
      }
      
      // Analyze data
      analysisData = analyzeTransactions(transactions);
      
      // Update all UI components
      updateMetrics();
      updateCharts();
      updateTopExpenses();
      updateSavingsSuggestions();
      updateForecast();
      
      // Add animation effects
      animateStatsUpdate();
    }

    // Analyze transactions
    function analyzeTransactions(transactions) {
      const analysis = {
        income: 0,
        expenses: 0,
        categories: {},
        monthlyData: {},
        topExpenses: [],
        essentialExpenses: 0,
        discretionaryExpenses: 0,
        startDate: new Date(),
        endDate: new Date(0)
      };
      
      // Define categories
      const essentialCategories = ['food', 'groceries', 'rent', 'mortgage', 'utilities', 'transport', 'gas', 'health', 'medical', 'insurance'];
      const discretionaryCategories = ['entertainment', 'dining', 'restaurant', 'shopping', 'clothes', 'hobby', 'travel', 'luxury', 'gift'];
      
      // Process transactions
      transactions.forEach(transaction => {
        const income = parseFloat(transaction.INCOME) || 0;
        const expense = parseFloat(transaction.EXPENSE) || 0;
        const description = (transaction.DESCRIPTION || '').toLowerCase();
        const accountHeader = (transaction.ACCOUNT_HEADER || '').toLowerCase();
        const date = transaction.DATE;
        
        // Update dates
        if (date < analysis.startDate) analysis.startDate = date;
        if (date > analysis.endDate) analysis.endDate = date;
        
        // Add to totals
        analysis.income += income;
        analysis.expenses += expense;
        
        // Process expenses
        if (expense > 0) {
          // Determine category
          let category = 'other';
          const searchText = description + ' ' + accountHeader;
          
          if (searchText.includes('food') || searchText.includes('grocer') || searchText.includes('restaurant')) {
            category = 'food';
          } else if (searchText.includes('rent') || searchText.includes('mortgage') || searchText.includes('housing')) {
            category = 'housing';
          } else if (searchText.includes('utility') || searchText.includes('electric') || searchText.includes('water')) {
            category = 'utilities';
          } else if (searchText.includes('transport') || searchText.includes('gas') || searchText.includes('car')) {
            category = 'transportation';
          } else if (searchText.includes('medical') || searchText.includes('health') || searchText.includes('doctor')) {
            category = 'health';
          } else if (searchText.includes('entertain') || searchText.includes('movie') || searchText.includes('game')) {
            category = 'entertainment';
          } else if (searchText.includes('shop') || searchText.includes('clothes') || searchText.includes('store')) {
            category = 'shopping';
          }
          
          // Add to category totals
          analysis.categories[category] = (analysis.categories[category] || 0) + expense;
          
          // Categorize as essential or discretionary
          const isEssential = essentialCategories.some(cat => 
            description.includes(cat) || accountHeader.includes(cat)
          );
          const isDiscretionary = discretionaryCategories.some(cat => 
            description.includes(cat) || accountHeader.includes(cat)
          );
          
          if (isEssential) {
            analysis.essentialExpenses += expense;
          } else if (isDiscretionary) {
            analysis.discretionaryExpenses += expense;
          }
          
          // Add to top expenses
          analysis.topExpenses.push({
            description: transaction.DESCRIPTION || 'Unknown Expense',
            amount: expense,
            category: category,
            date: date,
            accountHeader: transaction.ACCOUNT_HEADER || 'Unknown'
          });
          
          // Monthly data
          const monthKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
          if (!analysis.monthlyData[monthKey]) {
            analysis.monthlyData[monthKey] = { income: 0, expenses: 0 };
          }
          analysis.monthlyData[monthKey].expenses += expense;
        }
        
        // Process income
        if (income > 0) {
          const monthKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
          if (!analysis.monthlyData[monthKey]) {
            analysis.monthlyData[monthKey] = { income: 0, expenses: 0 };
          }
          analysis.monthlyData[monthKey].income += income;
        }
      });
      
      // Sort top expenses
      analysis.topExpenses.sort((a, b) => b.amount - a.amount);
      
      // Calculate derived metrics
      analysis.netSavings = analysis.income - analysis.expenses;
      analysis.savingsRate = analysis.income > 0 ? (analysis.netSavings / analysis.income) * 100 : 0;
      
      const daysDiff = Math.max(Math.ceil((analysis.endDate - analysis.startDate) / (1000 * 60 * 60 * 24)), 1);
      analysis.avgDailySpend = analysis.expenses / daysDiff;
      
      analysis.essentialRatio = analysis.expenses > 0 ? (analysis.essentialExpenses / analysis.expenses) * 100 : 0;
      
      return analysis;
    }

    // Update metrics with animations
    function updateMetrics() {
      // Animate value changes
      animateValueChange('totalIncome', analysisData.income);
      animateValueChange('totalExpenses', analysisData.expenses);
      animateValueChange('netSavings', analysisData.netSavings);
      animateValueChange('avgDailySpend', analysisData.avgDailySpend);
      
      // Update trends
      updateTrendIndicators();
      
      // Update expense count
      document.getElementById('expenseCount').textContent = 
        analysisData.topExpenses.length > 5 ? '5+' : analysisData.topExpenses.length;
    }

    // Animate value changes
    function animateValueChange(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const currentValue = parseFloat(element.textContent.replace(/[^0-9.-]+/g, '')) || 0;
      const duration = 1000;
      const steps = 60;
      const stepValue = (targetValue - currentValue) / steps;
      let currentStep = 0;
      
      const interval = setInterval(() => {
        if (currentStep >= steps) {
          element.textContent = `$${targetValue.toFixed(2)}`;
          clearInterval(interval);
          return;
        }
        
        const newValue = currentValue + (stepValue * currentStep);
        element.textContent = `$${newValue.toFixed(2)}`;
        currentStep++;
      }, duration / steps);
    }

    // Animate stats update
    function animateStatsUpdate() {
      document.querySelectorAll('.stat-card').forEach((card, index) => {
        card.classList.add('animate__animated', 'animate__pulse');
        setTimeout(() => {
          card.classList.remove('animate__animated', 'animate__pulse');
        }, 500 + (index * 100));
      });
    }

    // Update trend indicators
    function updateTrendIndicators() {
      // Calculate trends (simplified for demo)
      const incomeTrend = analysisData.income > 0 ? 'up' : 'neutral';
      const expenseTrend = analysisData.expenses > 0 ? 'down' : 'neutral';
      const savingsTrend = analysisData.savingsRate > 20 ? 'up' : 'neutral';
      const spendTrend = analysisData.avgDailySpend > 50 ? 'down' : 'neutral';
      
      updateTrendElement('incomeTrend', incomeTrend, '12% increase');
      updateTrendElement('expenseTrend', expenseTrend, '8% decrease');
      updateTrendElement('savingsRate', savingsTrend, `${analysisData.savingsRate.toFixed(1)}% rate`);
      updateTrendElement('spendTrend', spendTrend, 'Stable');
    }

    // Update trend element
    function updateTrendElement(elementId, trend, text) {
      const element = document.getElementById(elementId);
      const icon = trend === 'up' ? 'fa-arrow-up' : trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
      const trendClass = trend === 'up' ? 'trend-up' : trend === 'down' ? 'trend-down' : 'trend-neutral';
      
      element.className = `stat-trend ${trendClass}`;
      element.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    }

    // Update charts
    function updateCharts() {
      updateTrendChart();
      updateCategoryChart();
    }

    // Update trend chart
    function updateTrendChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      // Destroy existing chart
      if (trendChart) {
        trendChart.destroy();
      }
      
      // Prepare data
      const monthlyKeys = Object.keys(analysisData.monthlyData).sort();
      const labels = monthlyKeys.map(key => {
        const [year, month] = key.split('-');
        return new Date(year, month-1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      });
      
      const incomeData = monthlyKeys.map(key => analysisData.monthlyData[key].income || 0);
      const expenseData = monthlyKeys.map(key => analysisData.monthlyData[key].expenses || 0);
      
      // Create gradient
      const incomeGradient = ctx.createLinearGradient(0, 0, 0, 400);
      incomeGradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
      incomeGradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');
      
      const expenseGradient = ctx.createLinearGradient(0, 0, 0, 400);
      expenseGradient.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
      expenseGradient.addColorStop(1, 'rgba(239, 68, 68, 0.1)');
      
      // Create chart
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              borderColor: '#10b981',
              backgroundColor: incomeGradient,
              tension: 0.4,
              fill: true,
              borderWidth: 3,
              pointBackgroundColor: '#10b981',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            },
            {
              label: 'Expenses',
              data: expenseData,
              borderColor: '#ef4444',
              backgroundColor: expenseGradient,
              tension: 0.4,
              fill: true,
              borderWidth: 3,
              pointBackgroundColor: '#ef4444',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                font: {
                  size: 13,
                  family: 'Inter'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#667eea',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                drawBorder: false
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                font: {
                  size: 11
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                drawBorder: false
              },
              ticks: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                font: {
                  size: 11
                },
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          animation: {
            duration: 2000,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    // Update category chart
    function updateCategoryChart() {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      
      // Destroy existing chart
      if (categoryChart) {
        categoryChart.destroy();
      }
      
      // Prepare data
      const categoryEntries = Object.entries(analysisData.categories)
        .filter(([, value]) => value > 0)
        .sort(([,a], [,b]) => b - a);
      
      const labels = categoryEntries.map(([name]) => 
        name.charAt(0).toUpperCase() + name.slice(1)
      );
      const data = categoryEntries.map(([,value]) => value);
      
      // Colors
      const colors = [
        '#ef4444', // Red - Food
        '#f59e0b', // Yellow - Housing
        '#10b981', // Green - Utilities
        '#3b82f6', // Blue - Transportation
        '#8b5cf6', // Purple - Health
        '#ec4899', // Pink - Entertainment
        '#14b8a6'  // Teal - Shopping
      ];
      
      // Create chart
      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: getComputedStyle(document.documentElement).getAttribute('data-theme') === 'dark' ? 
              'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 1)',
            borderWidth: 2,
            hoverOffset: 20
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                font: {
                  size: 11,
                  family: 'Inter'
                },
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateScale: true,
            animateRotate: true,
            duration: 2000
          }
        }
      });
    }

    // Update top expenses
    function updateTopExpenses() {
      const container = document.getElementById('topExpensesList');
      const topExpenses = analysisData.topExpenses.slice(0, 5);
      
      if (topExpenses.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No expenses recorded yet. Add transactions to see your top expenses.
          </div>
        `;
        return;
      }
      
      let html = '';
      topExpenses.forEach((expense, index) => {
        const date = new Date(expense.date).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric' 
        });
        
        const categoryColors = {
          'food': 'warning',
          'housing': 'info',
          'utilities': 'success',
          'transportation': 'primary',
          'health': 'danger',
          'entertainment': 'purple',
          'shopping': 'pink',
          'other': 'secondary'
        };
        
        const categoryColor = categoryColors[expense.category] || 'secondary';
        
        // Add animation delay
        const animationDelay = index * 0.1;
        
        html += `
          <div class="expense-item animate__animated animate__fadeInRight" 
               style="animation-delay: ${animationDelay}s">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <div class="rounded-circle bg-${categoryColor} bg-opacity-10 p-2">
                  <i class="fas fa-${getCategoryIcon(expense.category)} text-${categoryColor}"></i>
                </div>
              </div>
              <div>
                <div class="fw-bold">${escapeHtml(expense.description)}</div>
                <small class="text-muted">${date} • ${expense.accountHeader}</small>
              </div>
            </div>
            <div>
              <div class="fw-bold text-danger">$${expense.amount.toFixed(2)}</div>
              <span class="badge bg-${categoryColor} bg-opacity-10 text-${categoryColor}">
                ${expense.category}
              </span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Get category icon
    function getCategoryIcon(category) {
      const icons = {
        'food': 'utensils',
        'housing': 'home',
        'utilities': 'bolt',
        'transportation': 'car',
        'health': 'heartbeat',
        'entertainment': 'film',
        'shopping': 'shopping-bag',
        'other': 'tag'
      };
      return icons[category] || 'tag';
    }

    // Update budget limits display
    function updateBudgetLimitsDisplay() {
      const container = document.getElementById('budgetLimits');
      
      if (budgetLimits.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No budget limits set. Click "Add Limit" to create your first limit.
          </div>
        `;
        return;
      }
      
      let html = '';
      budgetLimits.forEach((limit, index) => {
        const progress = calculateLimitProgress(limit);
        const percentage = (progress.current / limit.amount) * 100;
        const isOverLimit = progress.current > limit.amount;
        const isNearLimit = percentage >= limit.alertThreshold && !isOverLimit;
        
        // Progress bar color
        let progressClass = '';
        if (isOverLimit) {
          progressClass = 'danger';
        } else if (isNearLimit) {
          progressClass = 'warning';
        } else {
          progressClass = 'success';
        }
        
        // Period badge
        const periodBadges = {
          'weekly': 'primary',
          'monthly': 'success',
          'quarterly': 'info',
          'yearly': 'warning'
        };
        
        const periodBadge = periodBadges[limit.period] || 'secondary';
        
        // Add animation
        const animationDelay = index * 0.1;
        
        html += `
          <div class="limit-card animate__animated animate__fadeInUp ${isOverLimit ? 'over-limit' : ''}"
               style="animation-delay: ${animationDelay}s">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h6 class="mb-0">${limit.accountHeader || 'All Expenses'}</h6>
                <small class="text-muted">${limit.period.charAt(0).toUpperCase() + limit.period.slice(1)} Limit</small>
              </div>
              <span class="badge bg-${periodBadge}">${limit.period}</span>
            </div>
            <div class="limit-progress">
              <div class="limit-progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>$${progress.current.toFixed(2)} / $${limit.amount.toFixed(2)}</small>
              <small class="${isOverLimit ? 'text-danger' : isNearLimit ? 'text-warning' : 'text-success'}">
                ${percentage.toFixed(1)}% used
              </small>
            </div>
            ${isOverLimit ? `
              <div class="mt-2 alert alert-danger py-1">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Over limit by $${(progress.current - limit.amount).toFixed(2)}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Also update active limits in modal
      updateActiveLimitsList();
    }

    // Calculate limit progress
    function calculateLimitProgress(limit) {
      let currentSpending = 0;
      const now = new Date();
      let periodStart = new Date();
      
      // Calculate period based on limit type
      switch(limit.period) {
        case 'weekly':
          periodStart.setDate(now.getDate() - 7);
          break;
        case 'monthly':
          periodStart.setMonth(now.getMonth() - 1);
          break;
        case 'quarterly':
          periodStart.setMonth(now.getMonth() - 3);
          break;
        case 'yearly':
          periodStart.setFullYear(now.getFullYear() - 1);
          break;
      }
      
      // Filter transactions for this period and account header
      transactions.forEach(transaction => {
        const transDate = transaction.DATE;
        if (transDate >= periodStart && transDate <= now) {
          const expense = parseFloat(transaction.EXPENSE) || 0;
          if (expense > 0) {
            // Check if transaction matches account header
            const accountHeader = transaction.ACCOUNT_HEADER || '';
            if (limit.accountHeader === 'all' || accountHeader === limit.accountHeader) {
              currentSpending += expense;
            }
          }
        }
      });
      
      return {
        current: currentSpending,
        limit: limit.amount,
        percentage: (currentSpending / limit.amount) * 100
      };
    }

    // Update active limits list
    function updateActiveLimitsList() {
      const container = document.getElementById('activeLimitsList');
      
      if (budgetLimits.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">No active limits</div>';
        return;
      }
      
      let html = '<div class="list-group">';
      budgetLimits.forEach(limit => {
        const progress = calculateLimitProgress(limit);
        const percentage = progress.percentage;
        
        html += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${limit.accountHeader || 'All Expenses'}</div>
              <small class="text-muted">${limit.period} • Alert at ${limit.alertThreshold}%</small>
            </div>
            <div>
              <span class="badge bg-${percentage > 100 ? 'danger' : percentage > 80 ? 'warning' : 'primary'}">
                ${percentage.toFixed(1)}%
              </span>
              <button class="btn btn-sm btn-outline-danger ms-2 delete-limit" data-id="${limit.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
      
      // Add delete event listeners
      document.querySelectorAll('.delete-limit').forEach(button => {
        button.addEventListener('click', async (e) => {
          const limitId = e.target.closest('button').dataset.id;
          await deleteBudgetLimit(limitId);
        });
      });
    }

    // Show limit modal
    function showLimitModal() {
      const modal = new bootstrap.Modal(document.getElementById('limitModal'));
      modal.show();
    }

    // Save budget limit
    async function saveBudgetLimit() {
      const accountHeader = document.getElementById('limitAccount').value;
      const period = document.getElementById('limitPeriod').value;
      const amount = parseFloat(document.getElementById('limitAmount').value);
      const alertThreshold = parseInt(document.getElementById('alertThreshold').value);
      
      // Validation
      if (!accountHeader) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Account Header',
          text: 'Please select an account header for this limit'
        });
        return;
      }
      
      if (!amount || amount <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Amount',
          text: 'Please enter a valid limit amount greater than 0'
        });
        return;
      }
      
      if (!currentUser) return;
      
      showLoading('Saving budget limit...');
      
      try {
        const limitData = {
          accountHeader: accountHeader,
          period: period,
          amount: amount,
          alertThreshold: alertThreshold,
          createdAt: Timestamp.now(),
          updatedAt: Timestamp.now(),
          userId: currentUser.uid
        };
        
        const limitsRef = collection(db, "users", currentUser.uid, "budgetLimits");
        await addDoc(limitsRef, limitData);
        
        // Reset form
        document.getElementById('limitAmount').value = '';
        
        hideLoading();
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('limitModal')).hide();
        
        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Limit Saved!',
          text: `Budget limit set for ${accountHeader} (${period})`,
          showConfirmButton: false,
          timer: 2000,
          position: 'top-end',
          toast: true
        });
        
      } catch (error) {
        hideLoading();
        Swal.fire({
          icon: 'error',
          title: 'Save Failed',
          text: error.message
        });
      }
    }

    // Delete budget limit
    async function deleteBudgetLimit(limitId) {
      const result = await Swal.fire({
        title: 'Delete Limit?',
        text: 'Are you sure you want to delete this budget limit?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel',
        reverseButtons: true
      });
      
      if (result.isConfirmed) {
        try {
          await deleteDoc(doc(db, "users", currentUser.uid, "budgetLimits", limitId));
          
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Budget limit has been deleted',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
          });
          
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Delete Failed',
            text: error.message
          });
        }
      }
    }

    // Update savings suggestions
    function updateSavingsSuggestions() {
      const container = document.getElementById('savingsSuggestions');
      
      if (analysisData.topExpenses.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Add more transactions to get personalized savings suggestions.
          </div>
        `;
        return;
      }
      
      const suggestions = generateSavingsSuggestions();
      
      let html = '';
      suggestions.forEach((suggestion, index) => {
        const animationDelay = index * 0.2;
        
        html += `
          <div class="savings-suggestion ${suggestion.type} animate__animated animate__fadeInLeft"
               style="animation-delay: ${animationDelay}s">
            <div class="d-flex align-items-start">
              <div class="me-3">
                <i class="fas fa-${suggestion.icon} fa-lg"></i>
              </div>
              <div>
                <h6 class="mb-1">${suggestion.title}</h6>
                <p class="mb-0" style="font-size: 13px;">${suggestion.message}</p>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Generate savings suggestions
    function generateSavingsSuggestions() {
      const suggestions = [];
      
      // Check for high discretionary spending
      if (analysisData.discretionaryExpenses > analysisData.essentialExpenses * 0.6) {
        suggestions.push({
          title: 'Reduce Discretionary Spending',
          message: `You're spending $${analysisData.discretionaryExpenses.toFixed(2)} on non-essentials. Consider cutting back on entertainment and dining out.`,
          type: 'warning',
          icon: 'utensils'
        });
      }
      
      // Check for high daily spending
      if (analysisData.avgDailySpend > 75) {
        suggestions.push({
          title: 'High Daily Spending',
          message: `Your average daily spend is $${analysisData.avgDailySpend.toFixed(2)}. Try setting a daily budget of $50.`,
          type: 'danger',
          icon: 'calendar-day'
        });
      }
      
      // Check for low savings rate
      if (analysisData.savingsRate < 20) {
        suggestions.push({
          title: 'Increase Savings Rate',
          message: `Your savings rate is ${analysisData.savingsRate.toFixed(1)}%. Aim for at least 20% for better financial security.`,
          type: 'warning',
          icon: 'chart-line'
        });
      }
      
      // Check for large single expenses
      const largeExpenses = analysisData.topExpenses.filter(e => e.amount > 500);
      if (largeExpenses.length > 0) {
        suggestions.push({
          title: 'Large Expense Detected',
          message: `You have ${largeExpenses.length} expense(s) over $500. Review these for potential savings.`,
          type: 'info',
          icon: 'search-dollar'
        });
      }
      
      // Positive reinforcement
      if (analysisData.savingsRate >= 30) {
        suggestions.push({
          title: 'Great Savings Rate!',
          message: `Your savings rate of ${analysisData.savingsRate.toFixed(1)}% is excellent! Consider investing your savings.`,
          type: 'success',
          icon: 'trophy'
        });
      }
      
      // If no specific suggestions, provide general advice
      if (suggestions.length === 0) {
        suggestions.push({
          title: 'Track Your Spending',
          message: 'Continue tracking all expenses to identify more savings opportunities.',
          type: 'info',
          icon: 'chart-bar'
        });
      }
      
      return suggestions.slice(0, 3);
    }

    // Update forecast
    function updateForecast() {
      // Calculate forecast based on last 30 days
      const last30Days = getLastNDays(30);
      const forecastIncome = last30Days.income;
      const forecastExpenses = last30Days.expenses;
      const forecastSavings = forecastIncome - forecastExpenses;
      const forecastSavingsRate = forecastIncome > 0 ? (forecastSavings / forecastIncome) * 100 : 0;
      
      // Update forecast display
      document.getElementById('forecastIncome').textContent = `$${forecastIncome.toFixed(2)}`;
      document.getElementById('forecastExpenses').textContent = `$${forecastExpenses.toFixed(2)}`;
      document.getElementById('forecastSavings').textContent = `$${forecastSavings.toFixed(2)}`;
      
      // Update progress bar
      const progress = Math.min(Math.max(forecastSavingsRate, 0), 100);
      document.getElementById('forecastProgress').style.width = `${progress}%`;
    }

    // Get last N days data
    function getLastNDays(days) {
      const now = new Date();
      const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days);
      
      let income = 0;
      let expenses = 0;
      
      transactions.forEach(transaction => {
        const transDate = transaction.DATE;
        if (transDate >= startDate && transDate <= now) {
          income += parseFloat(transaction.INCOME) || 0;
          expenses += parseFloat(transaction.EXPENSE) || 0;
        }
      });
      
      return { income, expenses };
    }

    // Run forecast
    function runForecast() {
      Swal.fire({
        title: 'Running Advanced Forecast',
        html: `
          <div class="text-center py-3">
            <div class="loading-spinner mb-3"></div>
            <p>Analyzing patterns and trends...</p>
          </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false
      });
      
      setTimeout(() => {
        const forecast = generateAdvancedForecast();
        
        Swal.fire({
          title: 'Forecast Complete!',
          html: `
            <div class="text-center">
              <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
              <h4>Next Month Projection</h4>
              <div class="row mt-3">
                <div class="col-6">
                  <div class="text-success">Income</div>
                  <div class="h4">$${forecast.income.toFixed(2)}</div>
                </div>
                <div class="col-6">
                  <div class="text-danger">Expenses</div>
                  <div class="h4">$${forecast.expenses.toFixed(2)}</div>
                </div>
              </div>
              <div class="mt-3 p-3 bg-primary bg-opacity-10 rounded">
                <div>Projected Savings</div>
                <div class="h3 text-success">$${forecast.savings.toFixed(2)}</div>
              </div>
            </div>
          `,
          confirmButtonText: 'Apply Forecast',
          showCancelButton: true
        }).then((result) => {
          if (result.isConfirmed) {
            updateForecastWithAdvancedData(forecast);
          }
        });
      }, 2000);
    }

    // Generate advanced forecast
    function generateAdvancedForecast() {
      const last90Days = getLastNDays(90);
      const last30Days = getLastNDays(30);
      
      // Calculate trend
      const dailyIncome90 = last90Days.income / 90;
      const dailyIncome30 = last30Days.income / 30;
      const dailyExpense90 = last90Days.expenses / 90;
      const dailyExpense30 = last30Days.expenses / 30;
      
      // Project next 30 days with trend
      const incomeTrend = dailyIncome30 / dailyIncome90;
      const expenseTrend = dailyExpense30 / dailyExpense90;
      
      const projectedIncome = last30Days.income * incomeTrend;
      const projectedExpenses = last30Days.expenses * expenseTrend;
      const projectedSavings = projectedIncome - projectedExpenses;
      
      return {
        income: projectedIncome,
        expenses: projectedExpenses,
        savings: projectedSavings,
        incomeTrend: incomeTrend,
        expenseTrend: expenseTrend
      };
    }

    // Update forecast with advanced data
    function updateForecastWithAdvancedData(forecast) {
      document.getElementById('forecastIncome').textContent = `$${forecast.income.toFixed(2)}`;
      document.getElementById('forecastExpenses').textContent = `$${forecast.expenses.toFixed(2)}`;
      document.getElementById('forecastSavings').textContent = `$${forecast.savings.toFixed(2)}`;
      
      const savingsRate = forecast.income > 0 ? (forecast.savings / forecast.income) * 100 : 0;
      const progress = Math.min(Math.max(savingsRate, 0), 100);
      document.getElementById('forecastProgress').style.width = `${progress}%`;
      
      // Update trend indicator
      const trendElement = document.querySelector('.forecast-card .stat-trend');
      if (forecast.incomeTrend > 1.1) {
        trendElement.className = 'stat-trend trend-up bg-white bg-opacity-10';
        trendElement.innerHTML = '<i class="fas fa-arrow-up"></i> Strong Growth';
      } else if (forecast.expenseTrend > 1.1) {
        trendElement.className = 'stat-trend trend-down bg-white bg-opacity-10';
        trendElement.innerHTML = '<i class="fas fa-arrow-down"></i> Rising Costs';
      } else {
        trendElement.className = 'stat-trend trend-neutral bg-white bg-opacity-10';
        trendElement.innerHTML = '<i class="fas fa-minus"></i> Stable';
      }
      
      // Animate update
      const forecastCard = document.querySelector('.forecast-card');
      forecastCard.classList.add('animate__animated', 'animate__pulse');
      setTimeout(() => {
        forecastCard.classList.remove('animate__animated', 'animate__pulse');
      }, 1000);
    }

    // Show no data state
    function showNoDataState() {
      document.getElementById('topExpensesList').innerHTML = `
        <div class="alert alert-info animate__animated animate__fadeIn">
          <i class="fas fa-info-circle me-2"></i>
          No transactions found. Add transactions to start analyzing your budget.
        </div>
      `;
    }

    // Refresh data
    function refreshData() {
      // Animate refresh button
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.classList.add('animate__animated', 'animate__rotateIn');
      setTimeout(() => {
        refreshBtn.classList.remove('animate__animated', 'animate__rotateIn');
      }, 500);
      
      // Show loading
      Swal.fire({
        title: 'Refreshing Data',
        html: '<div class="loading-spinner"></div>',
        showConfirmButton: false,
        allowOutsideClick: false,
        timer: 1500
      });
      
      // Force re-analysis
      setTimeout(() => {
        performComprehensiveAnalysis();
        
        // Show success
        Swal.fire({
          icon: 'success',
          title: 'Data Updated!',
          text: 'All analytics have been refreshed',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });
      }, 1500);
    }

    // Toggle theme
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update theme toggle button
      const themeBtn = document.querySelector('.theme-toggle-btn');
      const icon = newTheme === 'light' ? 'fa-moon' : 'fa-sun';
      themeBtn.innerHTML = `<i class="fas ${icon}"></i> Switch Theme`;
      
      // Animate theme change
      document.body.classList.add('animate__animated', 'animate__fadeIn');
      setTimeout(() => {
        document.body.classList.remove('animate__animated', 'animate__fadeIn');
      }, 500);
      
      // Update charts with new theme
      if (trendChart) {
        trendChart.destroy();
        updateTrendChart();
      }
      if (categoryChart) {
        categoryChart.destroy();
        updateCategoryChart();
      }
    }

    // Load theme preference
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeBtn = document.querySelector('.theme-toggle-btn');
        const icon = savedTheme === 'light' ? 'fa-moon' : 'fa-sun';
        themeBtn.innerHTML = `<i class="fas ${icon}"></i> Switch Theme`;
      }
    }

    // Show loading
    function showLoading(message) {
      document.getElementById('loadingMessage').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
      modal.show();
    }

    // Hide loading
    function hideLoading() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
      if (modal) modal.hide();
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>