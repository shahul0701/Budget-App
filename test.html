<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart of Accounts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ... (keep all existing styles) ... */

    /* New styles for navigation and setup */
    .anonymous-navigation {
      background-color: #007bff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    
    .anonymous-navigation a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      padding: 8px 15px;
      border-radius: 4px;
      background-color: rgba(255,255,255,0.2);
    }
    
    .anonymous-navigation a:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .setup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    
    .setup-modal {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .setup-step {
      display: none;
    }
    
    .setup-step.active {
      display: block;
    }
    
    .bank-input-group, .expense-item {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .expense-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }
    
    .expense-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setup-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<!-- Anonymous Navigation (shown when not logged in) -->
<div id="anonymousNav" class="anonymous-navigation" style="display: none;">
  <div>
    <strong>Welcome to Financial Manager</strong>
    <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
      Please login or register to manage your accounts
    </p>
  </div>
  <div>
    <a href="index.html">Login</a>
    <a href="register.html">Register</a>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Setup Overlay -->
<div id="setupOverlay" class="setup-overlay">
  <div class="setup-modal">
    <div id="step1" class="setup-step active">
      <h3>Welcome to Financial Manager!</h3>
      <p>Let's set up your basic accounts. This will help you get started quickly.</p>
      <div class="form-group">
        <label>How many bank accounts do you have?</label>
        <input type="number" id="bankCount" min="0" max="10" value="1" class="form-control" style="width: 100px;">
      </div>
      <div class="setup-buttons">
        <button onclick="startSetup()" style="background-color: #28a745;">Start Setup</button>
        <button onclick="skipSetup()" style="background-color: #6c757d;">Skip Setup</button>
      </div>
    </div>
    
    <div id="step2" class="setup-step">
      <h3>Add Your Bank Accounts</h3>
      <p>Enter details for each bank account:</p>
      <div id="bankAccountsContainer"></div>
      <div class="setup-buttons">
        <button onclick="prevStep(2)" style="background-color: #6c757d;">Back</button>
        <button onclick="nextStep(2)" style="background-color: #007bff;">Next</button>
      </div>
    </div>
    
    <div id="step3" class="setup-step">
      <h3>Income Sources</h3>
      <p>Where does your primary income come from?</p>
      <div class="form-group">
        <label>
          <input type="radio" name="incomeSource" value="salary" checked> Salary/Employment
        </label><br>
        <label>
          <input type="radio" name="incomeSource" value="business"> Business/Self-Employed
        </label><br>
        <label>
          <input type="radio" name="incomeSource" value="both"> Both
        </label><br>
        <label>
          <input type="radio" name="incomeSource" value="other"> Other
        </label>
      </div>
      <div id="incomeDetails" style="margin-top: 15px; display: none;">
        <input type="text" id="otherIncome" placeholder="Please specify" class="form-control">
      </div>
      <div class="setup-buttons">
        <button onclick="prevStep(3)" style="background-color: #6c757d;">Back</button>
        <button onclick="nextStep(3)" style="background-color: #007bff;">Next</button>
      </div>
    </div>
    
    <div id="step4" class="setup-step">
      <h3>Common Expenses</h3>
      <p>Select all expense categories that apply to you:</p>
      <div class="expense-grid" id="expenseChecklist">
        <!-- Will be populated by JavaScript -->
      </div>
      <div class="setup-buttons">
        <button onclick="prevStep(4)" style="background-color: #6c757d;">Back</button>
        <button onclick="completeSetup()" style="background-color: #28a745;">Complete Setup</button>
      </div>
    </div>
  </div>
</div>

<!-- Top Header -->
<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left: 20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <h2>Chart of Accounts</h2>
  <button type="button" id="starterAccountsBtn" style="margin-bottom:20px;">
    üí° Add Common Starter Accounts
  </button>

  <!-- Add/Edit Account Form -->
  <form id="accountForm">
    <input type="hidden" id="accountId" />
    <div class="form-group">
      <label for="accountType">Account Type</label>
      <select id="accountType" required> 
        <option value="">Select Type</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Equity">Equity</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="COGS">Cost of Goods Sold</option>
        <option value="OtherIncome">Other Income</option>
        <option value="OtherExpense">Other Expense</option>
      </select>
      <div id="typeError" class="error-message"></div>
      <small id="typeHint" style="color: gray; display: block; margin-top: 4px;"></small>
    </div>

    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="add-new">‚ûï Add new category...</option>
      </select>
      <div id="categoryError" class="error-message"></div>
      <small id="categoryHint" style="color: gray; display: block; margin-top: 4px;"></small>
    </div>

    <div class="form-group">
      <label for="accountName">Account Name</label>
      <input type="text" id="accountName" placeholder="e.g. Bank Account" required />
      <div id="nameError" class="error-message"></div>
    </div>

    <div class="form-group">
      <label></label>
      <div class="form-buttons">
        <button type="submit" id="submitBtn">Add Account</button>
        <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
      </div>
    </div>
  </form>

  <!-- Account Table -->
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Category</th>
        <th>Account Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="accountsTable">
      <tr id="loadingRow">
        <td colspan="4" style="text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto;"></div>
          <p>Loading accounts...</p>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM Elements
  const accountTypeSelect = document.getElementById("accountType");
  const categorySelect = document.getElementById("category");
  const accountForm = document.getElementById("accountForm");
  const accountsTable = document.getElementById("accountsTable");
  const accountNameInput = document.getElementById("accountName");
  const accountIdInput = document.getElementById("accountId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");
  const starterAccountsBtn = document.getElementById("starterAccountsBtn");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const toast = document.getElementById("toast");
  const loadingRow = document.getElementById("loadingRow");
  const anonymousNav = document.getElementById("anonymousNav");
  const setupOverlay = document.getElementById("setupOverlay");

  // Error message elements
  const typeError = document.getElementById("typeError");
  const categoryError = document.getElementById("categoryError");
  const nameError = document.getElementById("nameError");

  let currentUser = null;
  let categories = {};
  let existingAccounts = new Set();
  let isFirstTimeUser = false;

  // Toast notification function
  function showToast(message, type = "success") {
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = "block";
    
    setTimeout(() => {
      toast.style.display = "none";
    }, 3000);
  }

  // Show/hide loading overlay
  function showLoading() {
    loadingOverlay.style.display = "flex";
  }

  function hideLoading() {
    loadingOverlay.style.display = "none";
  }

  // Real-time clock
  function updateTime() {
    const now = new Date();
    if (datetimeElem) {
      datetimeElem.textContent = now.toLocaleString();
    }
  }
  setInterval(updateTime, 1000);
  updateTime();

  // Setup Wizard Functions
  function startSetup() {
    const bankCount = parseInt(document.getElementById('bankCount').value) || 0;
    const container = document.getElementById('bankAccountsContainer');
    container.innerHTML = '';
    
    for (let i = 1; i <= bankCount; i++) {
      const div = document.createElement('div');
      div.className = 'bank-input-group';
      div.innerHTML = `
        <h4>Bank Account ${i}</h4>
        <div class="form-group">
          <label>Bank Name:</label>
          <input type="text" class="bank-name form-control" placeholder="e.g., Chase, Bank of America">
        </div>
        <div class="form-group">
          <label>Account Type:</label>
          <select class="bank-type form-control">
            <option value="Checking">Checking</option>
            <option value="Savings">Savings</option>
            <option value="Business">Business</option>
            <option value="Other">Other</option>
          </select>
        </div>
      `;
      container.appendChild(div);
    }
    
    if (bankCount === 0) {
      container.innerHTML = '<p>No bank accounts to add.</p>';
    }
    
    showStep(2);
  }

  function showStep(stepNumber) {
    document.querySelectorAll('.setup-step').forEach(step => {
      step.classList.remove('active');
    });
    document.getElementById(`step${stepNumber}`).classList.add('active');
  }

  function nextStep(currentStep) {
    if (currentStep === 2) {
      // Validate bank accounts
      const bankCount = parseInt(document.getElementById('bankCount').value) || 0;
      if (bankCount > 0) {
        const bankNames = document.querySelectorAll('.bank-name');
        let allValid = true;
        bankNames.forEach(input => {
          if (!input.value.trim()) {
            input.style.borderColor = 'red';
            allValid = false;
          } else {
            input.style.borderColor = '';
          }
        });
        if (!allValid) {
          showToast('Please enter all bank names', 'warning');
          return;
        }
      }
    }
    
    if (currentStep === 3) {
      // Handle income source selection
      const incomeSource = document.querySelector('input[name="incomeSource"]:checked').value;
      if (incomeSource === 'other') {
        const otherInput = document.getElementById('otherIncome');
        if (!otherInput.value.trim()) {
          showToast('Please specify your income source', 'warning');
          return;
        }
      }
      
      // Load expense checklist
      loadExpenseChecklist();
    }
    
    showStep(currentStep + 1);
  }

  function prevStep(currentStep) {
    showStep(currentStep - 1);
  }

  function skipSetup() {
    setupOverlay.style.display = 'none';
    isFirstTimeUser = false;
    loadCategories();
    loadAccounts();
  }

  function loadExpenseChecklist() {
    const expenseChecklist = document.getElementById('expenseChecklist');
    const commonExpenses = [
      'Rent/Mortgage', 'Utilities', 'Groceries', 'Transportation', 
      'Insurance', 'Healthcare', 'Entertainment', 'Dining Out',
      'Shopping', 'Education', 'Travel', 'Subscriptions',
      'Gym/Fitness', 'Childcare', 'Pet Care', 'Gifts/Donations',
      'Taxes', 'Loan Payments', 'Credit Card Payments', 'Savings'
    ];
    
    expenseChecklist.innerHTML = '';
    commonExpenses.forEach(expense => {
      const div = document.createElement('div');
      div.className = 'expense-checkbox';
      div.innerHTML = `
        <input type="checkbox" id="exp_${expense.replace(/\s+/g, '_')}" value="${expense}" checked>
        <label for="exp_${expense.replace(/\s+/g, '_')}">${expense}</label>
      `;
      expenseChecklist.appendChild(div);
    });
  }

  async function completeSetup() {
    showLoading();
    try {
      // 1. Add bank accounts
      const bankCount = parseInt(document.getElementById('bankCount').value) || 0;
      if (bankCount > 0) {
        const bankNames = document.querySelectorAll('.bank-name');
        const bankTypes = document.querySelectorAll('.bank-type');
        
        for (let i = 0; i < bankNames.length; i++) {
          const bankName = bankNames[i].value.trim();
          const bankType = bankTypes[i].value;
          
          await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
            userId: currentUser.uid,
            type: "Asset",
            category: "Bank",
            name: `${bankName} ${bankType} Account`,
            createdAt: serverTimestamp(),
          });
        }
      }
      
      // 2. Add income account
      const incomeSource = document.querySelector('input[name="incomeSource"]:checked').value;
      let incomeAccountName = "Salary Income";
      
      if (incomeSource === 'business') {
        incomeAccountName = "Business Income";
      } else if (incomeSource === 'both') {
        incomeAccountName = "Salary & Business Income";
      } else if (incomeSource === 'other') {
        incomeAccountName = document.getElementById('otherIncome').value.trim() || "Other Income";
      }
      
      await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
        userId: currentUser.uid,
        type: "Income",
        category: "Revenue",
        name: incomeAccountName,
        createdAt: serverTimestamp(),
      });
      
      // 3. Add selected expense accounts
      const expenseCheckboxes = document.querySelectorAll('#expenseChecklist input[type="checkbox"]:checked');
      for (const checkbox of expenseCheckboxes) {
        await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: "Expense",
          category: "Living Expenses",
          name: checkbox.value,
          createdAt: serverTimestamp(),
        });
      }
      
      // 4. Add some default accounts
      const defaultAccounts = [
        { type: "Asset", category: "Cash", name: "Cash on Hand" },
        { type: "Liability", category: "Credit Card", name: "Credit Card Payable" },
        { type: "Equity", category: "Owner's Equity", name: "Owner's Capital" }
      ];
      
      for (const acc of defaultAccounts) {
        await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: acc.type,
          category: acc.category,
          name: acc.name,
          createdAt: serverTimestamp(),
        });
      }
      
      setupOverlay.style.display = 'none';
      showToast('Setup completed successfully!');
      await loadCategories();
      await loadAccounts();
      
    } catch (error) {
      showToast('Error during setup: ' + error.message, 'error');
    } finally {
      hideLoading();
    }
  }

  // Setup income source radio button event listener
  document.addEventListener('DOMContentLoaded', function() {
    const incomeRadios = document.querySelectorAll('input[name="incomeSource"]');
    const incomeDetails = document.getElementById('incomeDetails');
    
    incomeRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        incomeDetails.style.display = this.value === 'other' ? 'block' : 'none';
      });
    });
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      anonymousNav.style.display = 'none';

      const nameToStore = user.displayName || user.email;
      localStorage.setItem("username", nameToStore);

      const storedUsername = localStorage.getItem("username");
      if (storedUsername) {
        usernameElem.textContent = storedUsername;
        profileCircle.textContent = storedUsername.charAt(0).toUpperCase();
      } else {
        usernameElem.textContent = nameToStore;
        profileCircle.textContent = nameToStore.charAt(0).toUpperCase();
      }

      // Check if this is first time user
      const accountsSnapshot = await getDocs(
        query(
          collection(db, "users", user.uid, "chartOfAccounts"),
          where("userId", "==", user.uid)
        )
      );
      
      if (accountsSnapshot.empty) {
        isFirstTimeUser = true;
        setTimeout(() => {
          setupOverlay.style.display = 'flex';
          showStep(1);
        }, 1000);
      } else {
        await init();
      }
    } else {
      currentUser = null;
      anonymousNav.style.display = 'block';
      document.querySelector('.container').style.display = 'none';
      document.querySelector('.header').style.display = 'none';
      
      setTimeout(() => {
        if (!auth.currentUser) {
          // Don't redirect automatically, show navigation instead
          console.log("User not logged in, showing anonymous navigation");
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    localStorage.removeItem("username");
    await signOut(auth);
    window.location.href = "index.html";
  });

  async function loadCategories() {
    categories = {};
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">‚ûï Add new category...</option>';

    const catSnapshot = await getDocs(
      query(
        collection(db, "users", currentUser.uid, "categories"), 
        where("userId", "==", currentUser.uid)
      )
    );
    
    catSnapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!categories[data.accountType]) categories[data.accountType] = [];
      if (!categories[data.accountType].includes(data.categoryName)) {
        categories[data.accountType].push(data.categoryName);
      }
    });
  }

  const starterAccounts = [
    { type: "Asset", category: "Bank", name: "Bank Account" },
    { type: "Asset", category: "Cash", name: "Petty Cash" },
    { type: "Liability", category: "Credit Card", name: "Credit Card Payable" },
    { type: "Income", category: "Sales", name: "Product Sales" },
    { type: "Expense", category: "Rent", name: "Office Rent" },
    { type: "Expense", category: "Utilities", name: "Electric Bill" },
    { type: "Expense", category: "Supplies", name: "Office Supplies" },
    { type: "COGS", category: "Raw Materials", name: "Materials Purchased" },
    { type: "Equity", category: "Owner's Equity", name: "Owner's Contribution" },
  ];

  starterAccountsBtn.addEventListener("click", async () => {
    if (!currentUser) {
      showToast("You must be logged in!", "error");
      return;
    }

    // Check if user wants to do the detailed setup
    if (confirm("Would you like to set up your accounts with a guided setup (bank accounts, income, expenses)?\n\nClick OK for guided setup or Cancel for quick starter accounts.")) {
      setupOverlay.style.display = 'flex';
      showStep(1);
      return;
    }

    // Original quick starter accounts
    if (!confirm("Do you want to add common starter accounts?")) return;

    showLoading();
    try {
      for (const acc of starterAccounts) {
        const duplicateCheck = await getDocs(
          query(
            collection(db, "users", currentUser.uid, "chartOfAccounts"),
            where("userId", "==", currentUser.uid),
            where("type", "==", acc.type),
            where("name", "==", acc.name)
          )
        );

        if (duplicateCheck.empty) {
          await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
            userId: currentUser.uid,
            type: acc.type,
            category: acc.category,
            name: acc.name,
            createdAt: serverTimestamp(),
          });
        }
      }
      await loadAccounts();
      showToast("Starter accounts added successfully!");
    } catch (error) {
      showToast("Error adding starter accounts: " + error.message, "error");
    } finally {
      hideLoading();
    }
  });

  function updateCategoryOptions(type) {
    const defaultCategories = {
      Asset: ["Cash", "Bank", "Accounts Receivable", "Inventory"],
      Liability: ["Accounts Payable", "Loans Payable", "Credit Card"],
      Equity: ["Owner's Equity", "Retained Earnings"],
      Income: ["Sales", "Service Revenue", "Interest Income"],
      Expense: ["Rent", "Utilities", "Supplies", "Salaries", "Travel"],
      COGS: ["Raw Materials", "Direct Labor", "Manufacturing Overhead"],
      OtherIncome: ["Gain on Sale", "Dividend Income"],
      OtherExpense: ["Loss on Sale", "Fines", "Miscellaneous"],
    };

    const typeHints = {
      Asset: "Assets are things you own. e.g., Bank, Inventory, Cash.",
      Liability: "Liabilities are things you owe. e.g., Loans, Credit Cards.",
      Equity: "Owner's stake in the business. e.g., Retained Earnings.",
      Income: "Money you earn. e.g., Sales, Services.",
      Expense: "Costs you pay. e.g., Rent, Utilities, Supplies.",
      COGS: "Costs directly tied to producing goods. e.g., Raw Materials.",
      OtherIncome: "Other money you earn. e.g., Interest, Dividends.",
      OtherExpense: "Other costs. e.g., Fines, Loss on Sale."
    };

    categorySelect.innerHTML = '<option value="">Select Category</option>';
    const userCats = categories[type] || [];
    const combined = [...new Set([...defaultCategories[type] || [], ...userCats])];

    combined.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });

    const addNewOption = document.createElement("option");
    addNewOption.value = "add-new";
    addNewOption.textContent = "‚ûï Add new category...";
    categorySelect.appendChild(addNewOption);

    if(document.getElementById("typeHint")){
      document.getElementById("typeHint").textContent = typeHints[type] || "";
    }
    if(document.getElementById("categoryHint")){
      const firstCategory = combined[0] || "";
      document.getElementById("categoryHint").textContent = firstCategory ? `e.g., ${firstCategory}` : "";
    }
  }

  accountTypeSelect.addEventListener("change", () => {
    const type = accountTypeSelect.value;
    updateCategoryOptions(type);
    categorySelect.value = "";
    clearErrors();
  });

  categorySelect.addEventListener("change", async () => {
    clearErrors();
    if (categorySelect.value === "add-new") {
      if (!accountTypeSelect.value) {
        showToast("Please select Account Type first.", "warning");
        categorySelect.value = "";
        return;
      }
      const newCat = prompt(`Enter new category name for "${accountTypeSelect.value}":`);
      if (newCat && newCat.trim()) {
        const trimmedCat = newCat.trim();
        if (categories[accountTypeSelect.value]?.some(c => c.toLowerCase() === trimmedCat.toLowerCase())) {
          showToast("Category already exists.", "warning");
          categorySelect.value = "";
          return;
        }
        showLoading();
        try {
          await addDoc(collection(db, "users", currentUser.uid, "categories"), {
            userId: currentUser.uid,
            accountType: accountTypeSelect.value,
            categoryName: trimmedCat,
            createdAt: serverTimestamp(),
          });
          await loadCategories();
          updateCategoryOptions(accountTypeSelect.value);
          categorySelect.value = trimmedCat;
          showToast("Category added successfully!");
        } catch (error) {
          showToast("Failed to add category: " + error.message, "error");
          categorySelect.value = "";
        } finally {
          hideLoading();
        }
      } else {
        categorySelect.value = "";
      }
    }
  });

  function clearErrors() {
    typeError.style.display = "none";
    categoryError.style.display = "none";
    nameError.style.display = "none";
    
    accountTypeSelect.classList.remove("has-error");
    categorySelect.classList.remove("has-error");
    accountNameInput.classList.remove("has-error");
  }

  async function checkDuplicateAccount(type, name) {
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid),
        where("type", "==", type),
        where("name", "==", name)
      );
      const snapshot = await getDocs(q);
      return !snapshot.empty;
    } catch (error) {
      console.error("Error checking duplicate:", error);
      return false;
    }
  }

  async function loadAccounts() {
    showLoading();
    accountsTable.innerHTML = "";
    
    const loadingRow = document.createElement("tr");
    loadingRow.id = "loadingRow";
    loadingRow.innerHTML = `
      <td colspan="4" style="text-align: center; padding: 40px;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p>Loading accounts...</p>
      </td>
    `;
    accountsTable.appendChild(loadingRow);

    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"), 
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);
      
      existingAccounts.clear();
      loadingRow.remove();
      
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const key = `${data.type.toLowerCase()}_${data.name.toLowerCase()}`;
        existingAccounts.add(key);
        addAccountRow(docSnap.id, data.type, data.category, data.name);
      });
      
      if (snapshot.empty) {
        accountsTable.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
              No accounts found. Click "Add Common Starter Accounts" to get started.
            </td>
          </tr>
        `;
      }
    } catch (error) {
      loadingRow.remove();
      accountsTable.innerHTML = `
        <tr>
          <td colspan="4" style="text-align: center; padding: 40px; color: #dc3545;">
            Error loading accounts: ${error.message}
          </td>
        </tr>
      `;
    } finally {
      hideLoading();
    }
  }

  function addAccountRow(id, type, category, name) {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", id);
    tr.innerHTML = `
      <td class="${type}">${type}</td>
      <td>${category}</td>
      <td>${name}</td>
      <td>
        <button class="action-btn edit-btn">Edit</button>
        <button class="action-btn delete-btn">Delete</button>
        <button class="action-btn settings-btn">‚öôÔ∏è</button>
        <div class="popup-menu">
          <div><a href="#" class="view-link" target="_blank">üëÅÔ∏è View</a></div>
          <div class="balance-line">üí∞ Balance: <span class="balance-amount">Loading...</span></div>
        </div>
      </td>
    `;

    tr.querySelector(".edit-btn").addEventListener("click", () => {
      startEditAccount(id, type, category, name);
    });

    tr.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this account?")) {
        showLoading();
        try {
          await deleteDoc(doc(db, "users", currentUser.uid, "chartOfAccounts", id));
          tr.remove();
          resetForm();
          
          const key = `${type.toLowerCase()}_${name.toLowerCase()}`;
          existingAccounts.delete(key);
          
          showToast("Account deleted successfully!");
        } catch (err) {
          showToast("Delete failed: " + err.message, "error");
        } finally {
          hideLoading();
        }
      }
    });

    const settingsBtn = tr.querySelector(".settings-btn");
    const popupMenu = tr.querySelector(".popup-menu");
    const viewLink = tr.querySelector(".view-link");
    const balanceAmountSpan = tr.querySelector(".balance-amount");

    settingsBtn.addEventListener("click", async (e) => {
      const isVisible = popupMenu.style.display === "block";
      document.querySelectorAll('.popup-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      
      if (!isVisible) {
        popupMenu.style.display = "block";
        const rect = settingsBtn.getBoundingClientRect();
        popupMenu.style.top = `${rect.bottom + window.scrollY}px`;
        popupMenu.style.left = `${rect.left + window.scrollX - 100}px`;

        try {
          const q = query(
            collection(db, "users", currentUser.uid, "transactions"), 
            where("accountId", "==", id)
          );
          const snap = await getDocs(q);
          let balance = 0;
          snap.forEach(docSnap => {
            const t = docSnap.data();
            balance += Number(t.amount || 0);
          });
          balanceAmountSpan.textContent = balance.toFixed(2);
        } catch (error) {
          balanceAmountSpan.textContent = "Error";
        }

        viewLink.href = `trialbalance.html?accountId=${id}&accountName=${encodeURIComponent(name)}`;
      }
    });

    document.addEventListener("click", (e) => {
      if (!tr.contains(e.target)) {
        popupMenu.style.display = "none";
      }
    });

    accountsTable.appendChild(tr);
  }

  function startEditAccount(id, type, category, name) {
    accountIdInput.value = id;
    accountTypeSelect.value = type;
    updateCategoryOptions(type);
    categorySelect.value = category;
    accountNameInput.value = name;
    submitBtn.textContent = "Update Account";
    cancelEditBtn.style.display = "inline-block";
    clearErrors();
  }

  function resetForm() {
    accountForm.reset();
    accountIdInput.value = "";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">‚ûï Add new category...</option>';
    clearErrors();
  }

  cancelEditBtn.addEventListener("click", resetForm);

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const id = accountIdInput.value.trim();
    const type = accountTypeSelect.value.trim();
    const category = categorySelect.value.trim();
    const name = accountNameInput.value.trim();

    clearErrors();

    let isValid = true;

    if (!type) {
      typeError.textContent = "Account type is required";
      typeError.style.display = "block";
      accountTypeSelect.classList.add("has-error");
      isValid = false;
    }

    if (!category) {
      categoryError.textContent = "Category is required";
      categoryError.style.display = "block";
      categorySelect.classList.add("has-error");
      isValid = false;
    }

    if (!name) {
      nameError.textContent = "Account name is required";
      nameError.style.display = "block";
      accountNameInput.classList.add("has-error");
      isValid = false;
    }

    if (!isValid) return;

    if (!id) {
      const isDuplicate = existingAccounts.has(`${type.toLowerCase()}_${name.toLowerCase()}`);
      if (isDuplicate) {
        nameError.textContent = "An account with this name already exists in this type";
        nameError.style.display = "block";
        accountNameInput.classList.add("has-error");
        showToast("Account name already exists!", "warning");
        return;
      }
    }

    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Saving...";
    submitBtn.disabled = true;
    showLoading();

    try {
      if (id) {
        const docRef = doc(db, "users", currentUser.uid, "chartOfAccounts", id);
        await updateDoc(docRef, { type, category, name });
        
        const tr = accountsTable.querySelector(`tr[data-id="${id}"]`);
        if (tr) {
          tr.children[0].textContent = type;
          tr.children[0].className = type;
          tr.children[1].textContent = category;
          tr.children[2].textContent = name;
        }
        showToast("Account updated successfully!");
      } else {
        const docRef = await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type,
          category,
          name,
          createdAt: serverTimestamp(),
        });
        
        existingAccounts.add(`${type.toLowerCase()}_${name.toLowerCase()}`);
        addAccountRow(docRef.id, type, category, name);
        showToast("Account added successfully!");
      }
      
      resetForm();
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      
    } catch (err) {
      showToast("Operation failed: " + err.message, "error");
      console.error(err);
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      hideLoading();
    }
  });

  async function init() {
    showLoading();
    try {
      await loadCategories();
      await loadAccounts();
    } catch (error) {
      showToast("Error initializing: " + error.message, "error");
    } finally {
      hideLoading();
    }
  }

  accountNameInput.addEventListener("input", function() {
    if (this.value.trim()) {
      nameError.style.display = "none";
      this.classList.remove("has-error");
    }
  });

  accountForm.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && e.target.tagName === "INPUT") {
      e.preventDefault();
    }
  });
</script>
</body>
</html>