<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Limits & Forecasting</title>
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #6f42c1;
            --secondary-color: #6a3dd6;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-bg: #f4f6fb;
            --dark-bg: #1a1d28;
            --card-bg: #ffffff;
            --text-primary: #222;
            --border-color: #eaeef2;
        }

        [data-theme="dark"] {
            --primary-color: #8b66cc;
            --secondary-color: #7d5ddb;
            --light-bg: #1a1d28;
            --card-bg: #2a2d3a;
            --text-primary: #f0f2f5;
            --border-color: #3a3f50;
        }

        body {
            background: var(--light-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 0;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: rgba(111, 66, 193, 0.1);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 15px 20px;
            color: var(--primary-color);
        }

        .card-body {
            padding: 20px;
        }

        .stats-card {
            text-align: center;
            padding: 25px 15px;
        }

        .stats-value {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stats-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress {
            height: 10px;
            margin: 15px 0;
        }

        .budget-progress .progress-bar {
            transition: width 0.5s ease;
        }

        .alert-card {
            border-left: 4px solid var(--danger-color);
        }

        .warning-card {
            border-left: 4px solid var(--warning-color);
        }

        .success-card {
            border-left: 4px solid var(--success-color);
        }

        .action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.2);
        }

        .form-control, .form-select {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
        }

        .table {
            color: var(--text-primary);
        }

        .table th {
            background: rgba(111, 66, 193, 0.05);
            border-bottom: 2px solid var(--border-color);
        }

        .badge {
            padding: 6px 12px;
            font-weight: 600;
        }

        .forecast-chart {
            height: 300px;
            margin: 20px 0;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
            z-index: 1000;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
        }

        .budget-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-safe {
            background-color: var(--success-color);
        }

        .status-warning {
            background-color: var(--warning-color);
        }

        .status-danger {
            background-color: var(--danger-color);
        }

        .email-settings {
            background: rgba(13, 202, 240, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .stats-value {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-chart-line me-2"></i>Budget Limits & Forecasting</h1>
                    <p class="mb-0">Monitor your spending and forecast future expenses</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <button id="notificationBtn" class="btn btn-light position-relative">
                        <i class="fas fa-bell"></i>
                        <span id="notificationCount" class="notification-badge">0</span>
                    </button>
                    <button id="themeToggle" class="toggle-btn">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Top Stats -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-label">Monthly Budget</div>
                    <div id="monthlyBudget" class="stats-value">$0.00</div>
                    <div class="stats-label">Set Limit</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-label">Current Spending</div>
                    <div id="currentSpending" class="stats-value">$0.00</div>
                    <div class="stats-label">This Month</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-label">Remaining Budget</div>
                    <div id="remainingBudget" class="stats-value">$0.00</div>
                    <div id="budgetStatus" class="budget-status">
                        <div class="status-dot status-safe"></div>
                        <span>On Track</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-label">Forecasted Monthly</div>
                    <div id="forecastedAmount" class="stats-value">$0.00</div>
                    <div class="stats-label">Based on History</div>
                </div>
            </div>
        </div>

        <!-- Budget Progress -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i>Budget Usage Progress
            </div>
            <div class="card-body">
                <div class="budget-progress">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Monthly Budget Usage</span>
                        <span id="budgetPercentage">0%</span>
                    </div>
                    <div class="progress">
                        <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <small class="text-muted">Safe: &lt; 70%</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <small class="text-muted">Warning: 70-90%</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">Danger: &gt; 90%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Limits Configuration -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-cog me-2"></i>Configure Budget Limits
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Monthly Budget Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="monthlyLimit" class="form-control" step="0.01" min="0" placeholder="Enter monthly limit">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Warning Threshold (%)</label>
                            <div class="input-group">
                                <input type="number" id="warningThreshold" class="form-control" value="80" min="1" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Get notified when spending reaches this percentage</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Category Limits (Optional)</label>
                            <div id="categoryLimitsContainer">
                                <!-- Category limits will be added here -->
                            </div>
                            <button id="addCategoryLimit" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-plus me-1"></i> Add Category Limit
                            </button>
                        </div>
                    </div>
                </div>
                <div class="email-settings">
                    <h6><i class="fas fa-envelope me-2"></i>Email Notifications</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="enableEmailNotifications" checked>
                        <label class="form-check-label" for="enableEmailNotifications">
                            Send email notifications when budget is exceeded
                        </label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Notification Email</label>
                        <input type="email" id="notificationEmail" class="form-control" placeholder="your@email.com">
                    </div>
                    <small class="text-muted">You'll receive alerts when your spending exceeds limits</small>
                </div>
                <div class="mt-3">
                    <button id="saveBudgetSettings" class="btn btn-primary action-btn">
                        <i class="fas fa-save me-1"></i> Save Budget Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Forecast Analysis -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Expense Forecasting
            </div>
            <div class="card-body">
                <div class="forecast-chart">
                    <canvas id="forecastChart"></canvas>
                </div>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Next Month Forecast</h6>
                                <div id="nextMonthForecast" class="stats-value">$0.00</div>
                                <small class="text-muted">Based on 3-month average</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Yearly Projection</h6>
                                <div id="yearlyProjection" class="stats-value">$0.00</div>
                                <small class="text-muted">Annual spending estimate</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Savings Potential</h6>
                                <div id="savingsPotential" class="stats-value">$0.00</div>
                                <small class="text-muted">If you reduce by 10%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts & Notifications -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-exclamation-triangle me-2"></i>Budget Alerts
            </div>
            <div class="card-body">
                <div id="alertsContainer">
                    <!-- Alerts will be populated here -->
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>No active alerts. Your budget is on track!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-history me-2"></i>Recent Transactions
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Theme Toggle Float Button -->
        <button id="themeToggleFloat" class="theme-toggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Modals -->
    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Budget Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="notificationsList">
                        <!-- Notifications will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="clearNotifications" type="button" class="btn btn-primary">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Exceeded Modal (Auto-shows when limit exceeded) -->
    <div class="modal fade" id="budgetExceededModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Budget Limit Exceeded!</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-fire me-2"></i>Warning!</h6>
                        <p id="exceededMessage">Your monthly spending has exceeded the budget limit.</p>
                    </div>
                    <div class="mt-3">
                        <p><strong>Details:</strong></p>
                        <ul>
                            <li>Budget Limit: <span id="modalBudgetLimit">$0.00</span></li>
                            <li>Current Spending: <span id="modalCurrentSpending">$0.00</span></li>
                            <li>Exceeded By: <span id="modalExceededAmount">$0.00</span></li>
                        </ul>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="dontShowAgain">
                        <label class="form-check-label" for="dontShowAgain">
                            Don't show this warning again this month
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Acknowledge</button>
                    <button type="button" class="btn btn-primary" id="adjustBudgetBtn">Adjust Budget</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, 
            query, orderBy, setDoc, getDoc, where, limit, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Firebase Configuration (use same as your transaction app)
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.appspot.com",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Variables
        let currentUser = null;
        let budgetSettings = {};
        let transactions = [];
        let notifications = [];
        let forecastChart = null;
        let currentTheme = 'light';
        let hasShownExceededModal = false;

        // DOM Elements
        const monthlyBudgetEl = document.getElementById('monthlyBudget');
        const currentSpendingEl = document.getElementById('currentSpending');
        const remainingBudgetEl = document.getElementById('remainingBudget');
        const budgetStatusEl = document.getElementById('budgetStatus');
        const forecastedAmountEl = document.getElementById('forecastedAmount');
        const budgetPercentageEl = document.getElementById('budgetPercentage');
        const budgetProgressBar = document.getElementById('budgetProgressBar');
        const monthlyLimitInput = document.getElementById('monthlyLimit');
        const warningThresholdInput = document.getElementById('warningThreshold');
        const categoryLimitsContainer = document.getElementById('categoryLimitsContainer');
        const enableEmailNotifications = document.getElementById('enableEmailNotifications');
        const notificationEmail = document.getElementById('notificationEmail');
        const saveBudgetSettingsBtn = document.getElementById('saveBudgetSettings');
        const addCategoryLimitBtn = document.getElementById('addCategoryLimit');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationCount = document.getElementById('notificationCount');
        const themeToggle = document.getElementById('themeToggle');
        const themeToggleFloat = document.getElementById('themeToggleFloat');
        const notificationModal = new bootstrap.Modal('#notificationModal');
        const budgetExceededModal = new bootstrap.Modal('#budgetExceededModal');
        const alertsContainer = document.getElementById('alertsContainer');
        const recentTransactionsEl = document.getElementById('recentTransactions');
        const nextMonthForecastEl = document.getElementById('nextMonthForecast');
        const yearlyProjectionEl = document.getElementById('yearlyProjection');
        const savingsPotentialEl = document.getElementById('savingsPotential');
        const clearNotificationsBtn = document.getElementById('clearNotifications');
        const adjustBudgetBtn = document.getElementById('adjustBudgetBtn');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        // Initialize Application
        async function initApp() {
            // Check authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.email);
                    
                    // Load theme preference
                    loadThemePreference();
                    
                    // Load data
                    await loadBudgetSettings();
                    await loadTransactions();
                    await loadNotifications();
                    
                    // Set up real-time listeners
                    setupRealtimeListeners();
                    
                    // Calculate and update display
                    updateBudgetDisplay();
                    updateForecast();
                    checkBudgetLimits();
                    
                    // Set up event listeners
                    setupEventListeners();
                } else {
                    // Redirect to login or show login prompt
                    Swal.fire({
                        title: 'Authentication Required',
                        text: 'Please login to use Budget Limits',
                        icon: 'warning',
                        confirmButtonText: 'Login',
                        showCancelButton: true,
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'index.html'; // Adjust based on your login page
                        }
                    });
                }
            });
        }

        // Load Budget Settings
        async function loadBudgetSettings() {
            if (!currentUser) return;
            
            try {
                const settingsDoc = await getDoc(doc(db, 'users', currentUser.uid, 'budget', 'settings'));
                
                if (settingsDoc.exists()) {
                    budgetSettings = settingsDoc.data();
                    console.log('Loaded budget settings:', budgetSettings);
                    
                    // Update form inputs
                    monthlyLimitInput.value = budgetSettings.monthlyLimit || '';
                    warningThresholdInput.value = budgetSettings.warningThreshold || 80;
                    notificationEmail.value = budgetSettings.notificationEmail || currentUser.email || '';
                    enableEmailNotifications.checked = budgetSettings.emailNotifications !== false;
                    
                    // Load category limits
                    if (budgetSettings.categoryLimits) {
                        categoryLimitsContainer.innerHTML = '';
                        budgetSettings.categoryLimits.forEach((limit, index) => {
                            addCategoryLimitRow(limit.category, limit.limit, index);
                        });
                    }
                } else {
                    // Initialize default settings
                    budgetSettings = {
                        monthlyLimit: 1000,
                        warningThreshold: 80,
                        emailNotifications: true,
                        notificationEmail: currentUser.email || '',
                        categoryLimits: [],
                        createdAt: new Date()
                    };
                    console.log('Created default budget settings');
                }
            } catch (error) {
                console.error('Error loading budget settings:', error);
                showError('Failed to load budget settings');
            }
        }

        // Load Transactions
        async function loadTransactions() {
            if (!currentUser) return;
            
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Get transactions from current month
                const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
                const q = query(
                    transactionsRef,
                    where('TYPE', '==', 'Expense'),
                    orderBy('DATE', 'desc')
                );
                
                const snapshot = await getDocs(q);
                transactions = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const txDate = new Date(data.DATE);
                    
                    // Only include expenses from current month
                    if (txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear) {
                        transactions.push({
                            id: doc.id,
                            ...data,
                            amount: parseFloat(data.EXPENSE) || 0
                        });
                    }
                });
                
                console.log(`Loaded ${transactions.length} transactions for current month`);
                
                // Update recent transactions table
                updateRecentTransactions();
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('Failed to load transactions');
            }
        }

        // Load Notifications
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const notificationsRef = collection(db, 'users', currentUser.uid, 'budgetNotifications');
                const q = query(notificationsRef, orderBy('createdAt', 'desc'), limit(50));
                
                const snapshot = await getDocs(q);
                notifications = [];
                
                snapshot.forEach(doc => {
                    notifications.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateNotificationBadge();
                updateNotificationsList();
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Set up real-time listeners
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Listen for new transactions
            const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
            const transactionsQuery = query(transactionsRef, where('TYPE', '==', 'Expense'));
            
            onSnapshot(transactionsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        // Reload transactions and check limits
                        loadTransactions().then(() => {
                            updateBudgetDisplay();
                            checkBudgetLimits();
                        });
                    }
                });
            });
            
            // Listen for budget setting changes
            const budgetSettingsRef = doc(db, 'users', currentUser.uid, 'budget', 'settings');
            onSnapshot(budgetSettingsRef, (doc) => {
                if (doc.exists()) {
                    budgetSettings = doc.data();
                    updateBudgetDisplay();
                    checkBudgetLimits();
                }
            });
        }

        // Update Budget Display
        function updateBudgetDisplay() {
            if (!budgetSettings.monthlyLimit) {
                // No budget set
                monthlyBudgetEl.textContent = '$0.00';
                currentSpendingEl.textContent = '$0.00';
                remainingBudgetEl.textContent = '$0.00';
                forecastedAmountEl.textContent = '$0.00';
                budgetPercentageEl.textContent = '0%';
                budgetProgressBar.style.width = '0%';
                return;
            }
            
            const monthlyLimit = parseFloat(budgetSettings.monthlyLimit);
            const currentSpending = calculateCurrentSpending();
            const remaining = monthlyLimit - currentSpending;
            const percentage = (currentSpending / monthlyLimit) * 100;
            
            // Update display
            monthlyBudgetEl.textContent = formatCurrency(monthlyLimit);
            currentSpendingEl.textContent = formatCurrency(currentSpending);
            remainingBudgetEl.textContent = formatCurrency(remaining);
            budgetPercentageEl.textContent = `${percentage.toFixed(1)}%`;
            budgetProgressBar.style.width = `${Math.min(percentage, 100)}%`;
            
            // Update status
            updateBudgetStatus(percentage);
            
            // Update progress bar color
            updateProgressBarColor(percentage);
        }

        // Calculate Current Spending
        function calculateCurrentSpending() {
            return transactions.reduce((total, tx) => {
                return total + (parseFloat(tx.amount) || 0);
            }, 0);
        }

        // Update Budget Status
        function updateBudgetStatus(percentage) {
            const statusDot = budgetStatusEl.querySelector('.status-dot');
            const statusText = budgetStatusEl.querySelector('span');
            
            if (percentage >= 100) {
                statusDot.className = 'status-dot status-danger';
                statusText.textContent = 'Exceeded';
                budgetStatusEl.style.color = 'var(--danger-color)';
            } else if (percentage >= (budgetSettings.warningThreshold || 80)) {
                statusDot.className = 'status-dot status-warning';
                statusText.textContent = 'Warning';
                budgetStatusEl.style.color = 'var(--warning-color)';
            } else {
                statusDot.className = 'status-dot status-safe';
                statusText.textContent = 'On Track';
                budgetStatusEl.style.color = 'var(--success-color)';
            }
        }

        // Update Progress Bar Color
        function updateProgressBarColor(percentage) {
            if (percentage >= 100) {
                budgetProgressBar.className = 'progress-bar bg-danger';
            } else if (percentage >= (budgetSettings.warningThreshold || 80)) {
                budgetProgressBar.className = 'progress-bar bg-warning';
            } else if (percentage >= 70) {
                budgetProgressBar.className = 'progress-bar bg-info';
            } else {
                budgetProgressBar.className = 'progress-bar bg-success';
            }
        }

        // Update Forecast
        function updateForecast() {
            if (transactions.length === 0) {
                forecastedAmountEl.textContent = '$0.00';
                nextMonthForecastEl.textContent = '$0.00';
                yearlyProjectionEl.textContent = '$0.00';
                savingsPotentialEl.textContent = '$0.00';
                return;
            }
            
            // Calculate average monthly spending (last 3 months)
            const monthlyAverages = calculateMonthlyAverages();
            const avgMonthlySpending = monthlyAverages.length > 0 
                ? monthlyAverages.reduce((a, b) => a + b, 0) / monthlyAverages.length
                : calculateCurrentSpending();
            
            // Update forecast displays
            forecastedAmountEl.textContent = formatCurrency(avgMonthlySpending);
            nextMonthForecastEl.textContent = formatCurrency(avgMonthlySpending);
            yearlyProjectionEl.textContent = formatCurrency(avgMonthlySpending * 12);
            savingsPotentialEl.textContent = formatCurrency(avgMonthlySpending * 0.1);
            
            // Update chart
            updateForecastChart(monthlyAverages);
        }

        // Calculate Monthly Averages
        function calculateMonthlyAverages() {
            const monthlyTotals = {};
            const now = new Date();
            const currentYear = now.getFullYear();
            
            // Group transactions by month
            transactions.forEach(tx => {
                const txDate = new Date(tx.DATE);
                const monthYear = `${txDate.getFullYear()}-${txDate.getMonth() + 1}`;
                
                if (!monthlyTotals[monthYear]) {
                    monthlyTotals[monthYear] = 0;
                }
                monthlyTotals[monthYear] += parseFloat(tx.amount) || 0;
            });
            
            // Get last 3 months
            const monthlyAverages = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(currentYear, now.getMonth() - i, 1);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                if (monthlyTotals[monthYear]) {
                    monthlyAverages.push(monthlyTotals[monthYear]);
                }
            }
            
            return monthlyAverages;
        }

        // Update Forecast Chart
        function updateForecastChart(monthlyAverages) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            
            // Destroy existing chart
            if (forecastChart) {
                forecastChart.destroy();
            }
            
            // Prepare data
            const labels = ['3 Months Ago', '2 Months Ago', 'Last Month', 'This Month', 'Next Month (Forecast)'];
            const data = [...monthlyAverages, calculateCurrentSpending()];
            
            // Add forecast for next month
            const nextMonthForecast = data.length > 0 
                ? data.reduce((a, b) => a + b, 0) / data.length
                : 0;
            data.push(nextMonthForecast);
            
            // Create chart
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.slice(-data.length),
                    datasets: [{
                        label: 'Monthly Spending',
                        data: data,
                        borderColor: 'rgba(111, 66, 193, 1)',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: (value) => `$${value}`
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Check Budget Limits
        async function checkBudgetLimits() {
            if (!budgetSettings.monthlyLimit || transactions.length === 0) return;
            
            const monthlyLimit = parseFloat(budgetSettings.monthlyLimit);
            const currentSpending = calculateCurrentSpending();
            const percentage = (currentSpending / monthlyLimit) * 100;
            const warningThreshold = budgetSettings.warningThreshold || 80;
            
            // Check if budget is exceeded
            if (currentSpending > monthlyLimit) {
                const exceededBy = currentSpending - monthlyLimit;
                
                // Create notification
                await createNotification(
                    'Budget Exceeded!',
                    `Your monthly spending has exceeded the budget by ${formatCurrency(exceededBy)}`,
                    'danger'
                );
                
                // Send email notification if enabled
                if (budgetSettings.emailNotifications && budgetSettings.notificationEmail) {
                    sendEmailNotification(
                        budgetSettings.notificationEmail,
                        'Budget Limit Exceeded',
                        `Your monthly budget of ${formatCurrency(monthlyLimit)} has been exceeded by ${formatCurrency(exceededBy)}. Current spending: ${formatCurrency(currentSpending)}`
                    );
                }
                
                // Show modal (only once per session)
                if (!hasShownExceededModal) {
                    showBudgetExceededModal(monthlyLimit, currentSpending, exceededBy);
                    hasShownExceededModal = true;
                }
            }
            // Check warning threshold
            else if (percentage >= warningThreshold) {
                await createNotification(
                    'Budget Warning',
                    `You've used ${percentage.toFixed(1)}% of your monthly budget. Only ${formatCurrency(monthlyLimit - currentSpending)} remaining.`,
                    'warning'
                );
            }
            
            // Check category limits
            if (budgetSettings.categoryLimits) {
                checkCategoryLimits();
            }
            
            // Update alerts display
            updateAlertsDisplay();
        }

        // Check Category Limits
        function checkCategoryLimits() {
            if (!budgetSettings.categoryLimits || budgetSettings.categoryLimits.length === 0) return;
            
            // Group transactions by category
            const categorySpending = {};
            transactions.forEach(tx => {
                const category = tx.ACCOUNT_HEADER || 'Uncategorized';
                const amount = parseFloat(tx.amount) || 0;
                
                if (!categorySpending[category]) {
                    categorySpending[category] = 0;
                }
                categorySpending[category] += amount;
            });
            
            // Check each category limit
            budgetSettings.categoryLimits.forEach(limit => {
                const spent = categorySpending[limit.category] || 0;
                const limitAmount = parseFloat(limit.limit);
                
                if (spent > limitAmount) {
                    createNotification(
                        'Category Limit Exceeded',
                        `${limit.category} spending (${formatCurrency(spent)}) exceeds limit (${formatCurrency(limitAmount)})`,
                        'danger'
                    );
                } else if (spent > limitAmount * 0.8) {
                    createNotification(
                        'Category Limit Warning',
                        `${limit.category} spending (${formatCurrency(spent)}) is approaching limit (${formatCurrency(limitAmount)})`,
                        'warning'
                    );
                }
            });
        }

        // Create Notification
        async function createNotification(title, message, type = 'info') {
            if (!currentUser) return;
            
            try {
                const notification = {
                    title,
                    message,
                    type,
                    read: false,
                    createdAt: new Date(),
                    userId: currentUser.uid
                };
                
                // Add to Firestore
                await addDoc(collection(db, 'users', currentUser.uid, 'budgetNotifications'), notification);
                
                // Add to local array
                notifications.unshift({
                    id: 'temp',
                    ...notification
                });
                
                // Update UI
                updateNotificationBadge();
                updateNotificationsList();
                updateAlertsDisplay();
                
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        // Send Email Notification (Simulated - in real app, use email service)
        async function sendEmailNotification(to, subject, body) {
            console.log('Email Notification:');
            console.log(`To: ${to}`);
            console.log(`Subject: ${subject}`);
            console.log(`Body: ${body}`);
            
            // In a real application, you would integrate with an email service like:
            // - SendGrid
            // - AWS SES
            // - Nodemailer (for Node.js backend)
            
            // For demo purposes, we'll just show a success message
            Swal.fire({
                title: 'Email Sent!',
                text: 'Budget alert email has been sent successfully.',
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
        }

        // Show Budget Exceeded Modal
        function showBudgetExceededModal(limit, spending, exceededBy) {
            document.getElementById('modalBudgetLimit').textContent = formatCurrency(limit);
            document.getElementById('modalCurrentSpending').textContent = formatCurrency(spending);
            document.getElementById('modalExceededAmount').textContent = formatCurrency(exceededBy);
            document.getElementById('exceededMessage').textContent = 
                `Your monthly budget of ${formatCurrency(limit)} has been exceeded by ${formatCurrency(exceededBy)}.`;
            
            budgetExceededModal.show();
        }

        // Update Recent Transactions
        function updateRecentTransactions() {
            recentTransactionsEl.innerHTML = '';
            
            if (transactions.length === 0) {
                recentTransactionsEl.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-receipt fa-2x mb-3"></i>
                            <p>No transactions this month</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show last 10 transactions
            const recentTx = transactions.slice(0, 10);
            
            recentTx.forEach(tx => {
                const row = document.createElement('tr');
                const date = new Date(tx.DATE).toLocaleDateString();
                const category = tx.ACCOUNT_HEADER || 'Uncategorized';
                const amount = parseFloat(tx.amount) || 0;
                
                // Determine status based on category limits
                let status = 'Normal';
                let statusClass = 'success';
                
                if (budgetSettings.categoryLimits) {
                    const categoryLimit = budgetSettings.categoryLimits.find(
                        limit => limit.category === category
                    );
                    
                    if (categoryLimit) {
                        const limitAmount = parseFloat(categoryLimit.limit);
                        if (amount > limitAmount) {
                            status = 'Exceeded';
                            statusClass = 'danger';
                        } else if (amount > limitAmount * 0.8) {
                            status = 'Warning';
                            statusClass = 'warning';
                        }
                    }
                }
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${tx.DESCRIPTION || 'No description'}</td>
                    <td>${category}</td>
                    <td class="fw-bold">${formatCurrency(amount)}</td>
                    <td><span class="badge bg-${statusClass}">${status}</span></td>
                `;
                
                recentTransactionsEl.appendChild(row);
            });
        }

        // Update Alerts Display
        function updateAlertsDisplay() {
            alertsContainer.innerHTML = '';
            
            // Get unread notifications
            const unreadNotifications = notifications.filter(n => !n.read);
            
            if (unreadNotifications.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>No active alerts. Your budget is on track!</p>
                    </div>
                `;
                return;
            }
            
            // Show alerts (last 5)
            const alertsToShow = unreadNotifications.slice(0, 5);
            
            alertsToShow.forEach(notification => {
                const alertCard = document.createElement('div');
                alertCard.className = `card mb-3 ${notification.type === 'danger' ? 'alert-card' : 
                                       notification.type === 'warning' ? 'warning-card' : ''}`;
                
                const timeAgo = getTimeAgo(notification.createdAt?.toDate() || new Date());
                
                alertCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fas fa-${notification.type === 'danger' ? 'exclamation-triangle' : 
                                                     notification.type === 'warning' ? 'exclamation-circle' : 
                                                     'info-circle'} 
                                        me-2 text-${notification.type}"></i>
                                    ${notification.title}
                                </h6>
                                <p class="mb-0">${notification.message}</p>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mark-read-btn" 
                                    data-id="${notification.id}">
                                Mark Read
                            </button>
                        </div>
                    </div>
                `;
                
                alertsContainer.appendChild(alertCard);
            });
            
            // Add event listeners to mark as read buttons
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const notificationId = e.target.dataset.id;
                    await markNotificationAsRead(notificationId);
                });
            });
        }

        // Update Notification Badge
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationCount.textContent = unreadCount;
            notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        // Update Notifications List
        function updateNotificationsList() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-2x mb-3"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `card mb-3 ${!notification.read ? 'border-primary' : ''}`;
                
                const timeAgo = getTimeAgo(notification.createdAt?.toDate() || new Date());
                
                item.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 ${!notification.read ? 'text-primary' : ''}">
                                    ${notification.title}
                                </h6>
                                <p class="mb-1">${notification.message}</p>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            ${!notification.read ? 
                                `<button class="btn btn-sm btn-outline-primary mark-read-list-btn" 
                                        data-id="${notification.id}">
                                    Mark Read
                                </button>` : 
                                `<span class="badge bg-secondary">Read</span>`
                            }
                        </div>
                    </div>
                `;
                
                notificationsList.appendChild(item);
            });
            
            // Add event listeners
            document.querySelectorAll('.mark-read-list-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const notificationId = e.target.dataset.id;
                    await markNotificationAsRead(notificationId);
                });
            });
        }

        // Mark Notification as Read
        async function markNotificationAsRead(notificationId) {
            if (!currentUser) return;
            
            try {
                // Update in Firestore
                await updateDoc(doc(db, 'users', currentUser.uid, 'budgetNotifications', notificationId), {
                    read: true
                });
                
                // Update local array
                const index = notifications.findIndex(n => n.id === notificationId);
                if (index !== -1) {
                    notifications[index].read = true;
                }
                
                // Update UI
                updateNotificationBadge();
                updateNotificationsList();
                updateAlertsDisplay();
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Add Category Limit Row
        function addCategoryLimitRow(category = '', limit = '', index = null) {
            const row = document.createElement('div');
            row.className = 'row mb-2 align-items-end';
            row.dataset.index = index !== null ? index : categoryLimitsContainer.children.length;
            
            row.innerHTML = `
                <div class="col-md-6">
                    <label class="form-label">Category</label>
                    <select class="form-select category-select">
                        <option value="">Select Category</option>
                        ${getUniqueCategories().map(cat => 
                            `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`
                        ).join('')}
                        <option value="custom" ${!getUniqueCategories().includes(category) && category ? 'selected' : ''}>
                            Custom...
                        </option>
                    </select>
                    <input type="text" class="form-control mt-2 custom-category-input" 
                           placeholder="Enter custom category" 
                           style="display: ${!getUniqueCategories().includes(category) && category ? 'block' : 'none'}"
                           value="${!getUniqueCategories().includes(category) && category ? category : ''}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Limit</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control limit-input" step="0.01" min="0" 
                               placeholder="Limit amount" value="${limit}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger remove-category-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            categoryLimitsContainer.appendChild(row);
            
            // Add event listeners
            const categorySelect = row.querySelector('.category-select');
            const customInput = row.querySelector('.custom-category-input');
            const removeBtn = row.querySelector('.remove-category-btn');
            
            categorySelect.addEventListener('change', (e) => {
                customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });
            
            removeBtn.addEventListener('click', () => {
                row.remove();
            });
        }

        // Get Unique Categories from Transactions
        function getUniqueCategories() {
            const categories = new Set();
            transactions.forEach(tx => {
                if (tx.ACCOUNT_HEADER) {
                    categories.add(tx.ACCOUNT_HEADER);
                }
            });
            return Array.from(categories).sort();
        }

        // Save Budget Settings
        async function saveBudgetSettings() {
            if (!currentUser) return;
            
            try {
                // Validate inputs
                const monthlyLimit = parseFloat(monthlyLimitInput.value);
                if (!monthlyLimit || monthlyLimit <= 0) {
                    showError('Please enter a valid monthly budget limit');
                    return;
                }
                
                const warningThreshold = parseInt(warningThresholdInput.value);
                if (warningThreshold < 1 || warningThreshold > 100) {
                    showError('Warning threshold must be between 1 and 100');
                    return;
                }
                
                // Collect category limits
                const categoryLimits = [];
                const categoryRows = categoryLimitsContainer.querySelectorAll('.row');
                
                categoryRows.forEach(row => {
                    const categorySelect = row.querySelector('.category-select');
                    const customInput = row.querySelector('.custom-category-input');
                    const limitInput = row.querySelector('.limit-input');
                    
                    let category = categorySelect.value;
                    if (category === 'custom') {
                        category = customInput.value.trim();
                    }
                    
                    const limit = parseFloat(limitInput.value);
                    
                    if (category && limit && limit > 0) {
                        categoryLimits.push({
                            category,
                            limit
                        });
                    }
                });
                
                // Prepare settings object
                const settings = {
                    monthlyLimit,
                    warningThreshold,
                    emailNotifications: enableEmailNotifications.checked,
                    notificationEmail: notificationEmail.value.trim(),
                    categoryLimits,
                    updatedAt: new Date()
                };
                
                // Save to Firestore
                await setDoc(doc(db, 'users', currentUser.uid, 'budget', 'settings'), settings, { merge: true });
                
                // Update local settings
                budgetSettings = { ...budgetSettings, ...settings };
                
                // Show success message
                Swal.fire({
                    title: 'Success!',
                    text: 'Budget settings saved successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Update display
                updateBudgetDisplay();
                checkBudgetLimits();
                
            } catch (error) {
                console.error('Error saving budget settings:', error);
                showError('Failed to save budget settings');
            }
        }

        // Clear All Notifications
        async function clearAllNotifications() {
            if (!currentUser || notifications.length === 0) return;
            
            try {
                // Show confirmation
                const result = await Swal.fire({
                    title: 'Clear all notifications?',
                    text: 'This action cannot be undone',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, clear all',
                    cancelButtonText: 'Cancel'
                });
                
                if (result.isConfirmed) {
                    // Delete all notifications from Firestore
                    const batch = [];
                    notifications.forEach(notification => {
                        if (notification.id !== 'temp') {
                            batch.push(
                                deleteDoc(doc(db, 'users', currentUser.uid, 'budgetNotifications', notification.id))
                            );
                        }
                    });
                    
                    await Promise.all(batch);
                    
                    // Clear local array
                    notifications = [];
                    
                    // Update UI
                    updateNotificationBadge();
                    updateNotificationsList();
                    updateAlertsDisplay();
                    
                    // Close modal
                    notificationModal.hide();
                    
                    Swal.fire({
                        title: 'Cleared!',
                        text: 'All notifications have been cleared',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Error clearing notifications:', error);
                showError('Failed to clear notifications');
            }
        }

        // Theme Management
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('budgetTheme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', currentTheme);
                updateThemeIcon();
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('budgetTheme', currentTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = currentTheme === 'light' ? 'fa-moon' : 'fa-sun';
            themeToggle.innerHTML = `<i class="fas ${icon}"></i>`;
            themeToggleFloat.innerHTML = `<i class="fas ${icon}"></i>`;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Save budget settings
            saveBudgetSettingsBtn.addEventListener('click', saveBudgetSettings);
            
            // Add category limit
            addCategoryLimitBtn.addEventListener('click', () => addCategoryLimitRow());
            
            // Notifications
            notificationBtn.addEventListener('click', () => notificationModal.show());
            
            // Clear notifications
            clearNotificationsBtn.addEventListener('click', clearAllNotifications);
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            themeToggleFloat.addEventListener('click', toggleTheme);
            
            // Budget exceeded modal
            adjustBudgetBtn.addEventListener('click', () => {
                budgetExceededModal.hide();
                monthlyLimitInput.focus();
            });
            
            // Close budget exceeded modal
            document.getElementById('budgetExceededModal').addEventListener('hidden.bs.modal', () => {
                hasShownExceededModal = true;
            });
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        function showError(message) {
            Swal.fire({
                title: 'Error',
                text: message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }

        // Initialize with a sample category limit row
        setTimeout(() => {
            if (categoryLimitsContainer.children.length === 0) {
                addCategoryLimitRow();
            }
        }, 1000);
    </script>
</body>
</html>