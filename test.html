<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Advanced Sales Management Pro - Enterprise Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --info: #4895ef;
            --dark: #1e1e2f;
            --light: #f8f9fa;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-danger: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);
            --gradient-info: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .sales-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .sales-header {
            background: white;
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-title p {
            color: #666;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
            font-size: 14px;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(67, 97, 238, 0.4);
        }

        .action-btn.success {
            background: var(--gradient-success);
        }

        .action-btn.warning {
            background: var(--gradient-warning);
        }

        .action-btn.info {
            background: var(--gradient-info);
        }

        .action-btn.danger {
            background: var(--gradient-danger);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }

        .stat-card.primary::before { background: var(--gradient-primary); }
        .stat-card.success::before { background: var(--gradient-success); }
        .stat-card.warning::before { background: var(--gradient-warning); }
        .stat-card.info::before { background: var(--gradient-info); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-header i {
            font-size: 28px;
            color: var(--primary);
            opacity: 0.5;
        }

        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark);
            margin: 10px 0;
            line-height: 1.2;
        }

        .stat-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .quick-actions h3 {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .quick-action-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .quick-action-item i {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .quick-action-item span {
            display: block;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .tab.active {
            background: var(--gradient-primary);
            color: white;
        }

        .tab-badge {
            margin-left: 8px;
            padding: 3px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 11px;
        }

        /* Table Card */
        .table-card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .table-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            position: relative;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 15px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .table tbody tr:hover {
            background: rgba(67, 97, 238, 0.03);
        }

        /* Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            display: inline-block;
            letter-spacing: 0.3px;
        }

        .badge-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .badge-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .badge-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .badge-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .badge-primary { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

        /* Action Buttons */
        .action-icons {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--primary);
            font-size: 14px;
        }

        .icon-btn:hover {
            background: rgba(67, 97, 238, 0.1);
            transform: scale(1.1);
        }

        .icon-btn.danger:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .icon-btn.success:hover { color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .icon-btn.warning:hover { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .icon-btn.info:hover { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.4s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 25px 30px;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 30px 30px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234b5563' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .item-card {
            background: white;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .item-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.1);
        }

        .item-card h5 {
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .item-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .item-stock {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            display: inline-block;
        }

        .stock-low {
            background: #fee2e2;
            color: #dc2626;
        }

        .stock-good {
            background: #d1fae5;
            color: #059669;
        }

        /* Cart Items */
        .cart-items {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 15px;
        }

        .cart-item {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }

        .cart-item-info h6 {
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .cart-item-info small {
            color: #666;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-quantity {
            width: 60px;
            padding: 5px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
        }

        /* Summary Card */
        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #cbd5e1;
        }

        .summary-row.total {
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            padding-top: 15px;
        }

        /* Discount Buttons */
        .discount-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .discount-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .discount-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            min-width: 45px;
        }

        .page-btn:hover:not(.disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
        }

        .toast {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            min-width: 350px;
            border-left: 5px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast.info { border-left-color: #3b82f6; }

        .toast i { font-size: 24px; }
        .toast.success i { color: #10b981; }
        .toast.error i { color: #ef4444; }
        .toast.warning i { color: #f59e0b; }
        .toast.info i { color: #3b82f6; }

        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; margin-bottom: 5px; }
        .toast-message { color: #666; font-size: 13px; }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(67, 97, 238, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #cbd5e1;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #666;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sales-header {
                flex-direction: column;
                text-align: center;
            }

            .header-actions {
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="sales-container">
        <!-- Header -->
        <div class="sales-header">
            <div class="header-title">
                <h1>ðŸ“Š Advanced Sales Management Pro</h1>
                <p>Enterprise-grade sales analytics, forecasting & management system</p>
            </div>
            <div class="header-actions">
                <button class="action-btn success" onclick="openNewSaleModal()">
                    <i class="fas fa-plus-circle"></i> New Sale
                </button>
                <button class="action-btn" onclick="openReturnModal()">
                    <i class="fas fa-undo-alt"></i> Process Return
                </button>
                <button class="action-btn info" onclick="exportSalesReport()">
                    <i class="fas fa-file-pdf"></i> Export Report
                </button>
                <button class="action-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-header">
                    <h4>Today's Revenue</h4>
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-value" id="todayRevenue">â‚¹0</div>
                <div class="stat-trend" id="todayTrend">
                    <span class="trend-up"><i class="fas fa-arrow-up"></i> 0%</span>
                    <span>vs yesterday</span>
                </div>
            </div>
            <div class="stat-card success">
                <div class="stat-header">
                    <h4>Monthly Revenue</h4>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-value" id="monthlyRevenue">â‚¹0</div>
                <div class="stat-trend">
                    <span id="monthlyTarget">Target: â‚¹0</span>
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-header">
                    <h4>Total Transactions</h4>
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-value" id="totalTransactions">0</div>
                <div class="stat-trend">
                    <span id="avgOrderValue">Avg: â‚¹0</span>
                </div>
            </div>
            <div class="stat-card info">
                <div class="stat-header">
                    <h4>Sales Forecast</h4>
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value" id="forecastValue">â‚¹0</div>
                <div class="stat-trend">
                    <span>Next month projection</span>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> Sales Trend (Last 7 Days)</h3>
                    <select id="trendPeriod" onchange="updateSalesChart()" style="padding: 8px 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Payment Methods</h3>
                </div>
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            <div class="action-grid">
                <div class="quick-action-item" onclick="openCouponModal()">
                    <i class="fas fa-tags"></i>
                    <span>Create Coupon</span>
                </div>
                <div class="quick-action-item" onclick="openTargetModal()">
                    <i class="fas fa-bullseye"></i>
                    <span>Set Sales Target</span>
                </div>
                <div class="quick-action-item" onclick="openSalesPersonModal()">
                    <i class="fas fa-user-tie"></i>
                    <span>Add Sales Person</span>
                </div>
                <div class="quick-action-item" onclick="openStoreModal()">
                    <i class="fas fa-store"></i>
                    <span>Manage Stores</span>
                </div>
                <div class="quick-action-item" onclick="openLoyaltyModal()">
                    <i class="fas fa-gem"></i>
                    <span>Loyalty Settings</span>
                </div>
                <div class="quick-action-item" onclick="generateQRInvoice()">
                    <i class="fas fa-qrcode"></i>
                    <span>QR Invoice</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="loadSalesTab('all', this)">All Sales</button>
                <button class="tab" onclick="loadSalesTab('today', this)">
                    Today
                    <span class="tab-badge" id="todayBadge">0</span>
                </button>
                <button class="tab" onclick="loadSalesTab('pending', this)">
                    Pending
                    <span class="tab-badge" id="pendingBadge">0</span>
                </button>
                <button class="tab" onclick="loadSalesTab('partial', this)">
                    Partial
                    <span class="tab-badge" id="partialBadge">0</span>
                </button>
                <button class="tab" onclick="loadSalesTab('completed', this)">Completed</button>
                <button class="tab" onclick="loadSalesTab('returns', this)">
                    Returns
                    <span class="tab-badge" id="returnsBadge">0</span>
                </button>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="table-card">
            <div class="table-header">
                <h3>
                    <i class="fas fa-list"></i>
                    Sales Transactions
                </h3>
                <div class="search-box">
                    <input type="text" id="searchSales" placeholder="Search by invoice, sales person, store..." onkeyup="searchSales()">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Date & Time</th>
                            <th>Store</th>
                            <th>Sales Person</th>
                            <th>Items</th>
                            <th>Subtotal</th>
                            <th>Discount</th>
                            <th>Coupon</th>
                            <th>Tax</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Due</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Loyalty Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <tr>
                            <td colspan="16" class="loading">
                                <div class="spinner"></div>
                                <div>Loading sales data...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
            
            <!-- Table Info -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px;">
                <div>
                    Showing <span id="startCount">0</span> to <span id="endCount">0</span> of <span id="totalCount">0</span> entries
                </div>
                <div>
                    <select id="itemsPerPage" onchange="changeItemsPerPage()" style="padding: 8px 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- New Sale Modal -->
    <div class="modal-overlay" id="newSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Create New Sale</h3>
                <button class="close-modal" onclick="closeModal('newSaleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Left: Store & Sales Person -->
                    <div>
                        <div class="form-group">
                            <label><i class="fas fa-store"></i> Select Store *</label>
                            <select id="saleStore" class="form-control" onchange="updateStoreInventory()">
                                <option value="">Select Store</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-user-tie"></i> Sales Person *</label>
                            <select id="saleSalesPerson" class="form-control">
                                <option value="">Select Sales Person</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Customer (Optional)</label>
                            <input type="text" id="saleCustomer" class="form-control" placeholder="Enter customer name/phone">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> Customer Phone</label>
                            <input type="tel" id="saleCustomerPhone" class="form-control" placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <!-- Right: Coupon & Loyalty -->
                    <div>
                        <div class="form-group">
                            <label><i class="fas fa-tags"></i> Apply Coupon</label>
                            <select id="saleCoupon" class="form-control" onchange="applyCoupon()">
                                <option value="">No Coupon</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-gem"></i> Loyalty Points</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="loyaltyPoints" class="form-control" placeholder="Points to redeem" min="0" value="0" oninput="calculateLoyaltyDiscount()">
                                <span style="padding: 12px; background: #f8fafc; border-radius: 12px;" id="availablePoints">0</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> Delivery Address</label>
                            <textarea id="deliveryAddress" class="form-control" rows="2" placeholder="Enter delivery address if applicable"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Items Selection -->
                <h4 style="margin: 30px 0 20px;"><i class="fas fa-box"></i> Select Items</h4>
                <div class="form-group">
                    <input type="text" id="searchItems" class="form-control" placeholder="Search items by name..." onkeyup="filterItems()">
                </div>
                <div class="items-grid" id="itemsGrid"></div>

                <!-- Cart -->
                <h4 style="margin: 30px 0 20px;"><i class="fas fa-shopping-cart"></i> Shopping Cart</h4>
                <div class="cart-items" id="cartItems"></div>

                <!-- Summary -->
                <div class="summary-card">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">â‚¹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Discount:</span>
                        <span id="cartDiscount">-â‚¹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Coupon Discount:</span>
                        <span id="couponDiscount">-â‚¹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Loyalty Discount:</span>
                        <span id="loyaltyDiscount">-â‚¹0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (GST):</span>
                        <span id="cartTax">â‚¹0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">â‚¹0.00</span>
                    </div>
                </div>

                <!-- Payment -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="paymentMethod" class="form-control" onchange="togglePartialPayment()">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="upi">UPI</option>
                            <option value="partial">Partial Payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Paid</label>
                        <input type="number" id="amountPaid" class="form-control" value="0" min="0" step="0.01" oninput="updatePaymentBalance()">
                    </div>
                </div>

                <div id="partialPaymentInfo" style="display: none; background: #fef3c7; padding: 15px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Balance Due:</span>
                        <span id="balanceDue">â‚¹0.00</span>
                    </div>
                </div>

                <!-- Complete Sale Button -->
                <button class="action-btn success" onclick="processSale()" style="width: 100%; justify-content: center; padding: 18px; font-size: 16px;">
                    <i class="fas fa-check-circle"></i> Complete Sale
                </button>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div class="modal-overlay" id="returnModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: var(--gradient-warning);">
                <h3><i class="fas fa-undo-alt"></i> Process Return</h3>
                <button class="close-modal" onclick="closeModal('returnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Enter Invoice Number</label>
                    <input type="text" id="returnInvoice" class="form-control" placeholder="Enter invoice number..." onkeyup="searchReturnInvoice()">
                </div>
                <div id="returnItems" style="margin-top: 20px;"></div>
                <button class="action-btn warning" onclick="processReturn()" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-undo-alt"></i> Process Return
                </button>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div class="modal-overlay" id="couponModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-success);">
                <h3><i class="fas fa-tags"></i> Create Coupon</h3>
                <button class="close-modal" onclick="closeModal('couponModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Coupon Code</label>
                    <input type="text" id="couponCode" class="form-control" placeholder="e.g., SAVE20">
                </div>
                <div class="form-group">
                    <label>Discount Type</label>
                    <select id="couponType" class="form-control">
                        <option value="percentage">Percentage</option>
                        <option value="fixed">Fixed Amount</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Discount Value</label>
                    <input type="number" id="couponValue" class="form-control" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Minimum Purchase</label>
                    <input type="number" id="couponMinPurchase" class="form-control" min="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>Valid Until</label>
                    <input type="date" id="couponValidUntil" class="form-control">
                </div>
                <button class="action-btn success" onclick="saveCoupon()" style="width: 100%;">
                    <i class="fas fa-save"></i> Create Coupon
                </button>
            </div>
        </div>
    </div>

    <!-- Sales Target Modal -->
    <div class="modal-overlay" id="targetModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-warning);">
                <h3><i class="fas fa-bullseye"></i> Set Sales Target</h3>
                <button class="close-modal" onclick="closeModal('targetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Monthly Target (â‚¹)</label>
                    <input type="number" id="monthlyTarget" class="form-control" min="0" step="1000">
                </div>
                <div class="form-group">
                    <label>Daily Target (â‚¹)</label>
                    <input type="number" id="dailyTarget" class="form-control" min="0" step="1000">
                </div>
                <div class="form-group">
                    <label>Commission Rate (%)</label>
                    <input type="number" id="commissionRate" class="form-control" min="0" step="0.1" value="0">
                </div>
                <button class="action-btn warning" onclick="saveTargets()" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Targets
                </button>
            </div>
        </div>
    </div>

    <!-- Sales Person Modal -->
    <div class="modal-overlay" id="salesPersonModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-info);">
                <h3><i class="fas fa-user-tie"></i> Add Sales Person</h3>
                <button class="close-modal" onclick="closeModal('salesPersonModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="salesPersonName" class="form-control">
                </div>
                <div class="form-group">
                    <label>Employee ID</label>
                    <input type="text" id="salesPersonId" class="form-control">
                </div>
                <div class="form-group">
                    <label>Store</label>
                    <select id="salesPersonStore" class="form-control">
                        <option value="">Select Store</option>
                    </select>
                </div>
                <button class="action-btn info" onclick="saveSalesPerson()" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Sales Person
                </button>
            </div>
        </div>
    </div>

    <!-- Store Modal -->
    <div class="modal-overlay" id="storeModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-primary);">
                <h3><i class="fas fa-store"></i> Manage Store</h3>
                <button class="close-modal" onclick="closeModal('storeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Store Name</label>
                    <input type="text" id="storeName" class="form-control">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="storeLocation" class="form-control">
                </div>
                <div class="form-group">
                    <label>GST Number</label>
                    <input type="text" id="storeGST" class="form-control">
                </div>
                <button class="action-btn primary" onclick="saveStore()" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Store
                </button>
                <hr style="margin: 20px 0;">
                <h5>Existing Stores</h5>
                <div id="storesList" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- Loyalty Settings Modal -->
    <div class="modal-overlay" id="loyaltyModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: var(--gradient-success);">
                <h3><i class="fas fa-gem"></i> Loyalty Settings</h3>
                <button class="close-modal" onclick="closeModal('loyaltyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Points per â‚¹100 spent</label>
                    <input type="number" id="pointsPerHundred" class="form-control" min="0" step="0.1" value="1">
                </div>
                <div class="form-group">
                    <label>Redeem rate (â‚¹ per 100 points)</label>
                    <input type="number" id="redeemRate" class="form-control" min="0" step="0.1" value="50">
                </div>
                <div class="form-group">
                    <label>Minimum points to redeem</label>
                    <input type="number" id="minRedeemPoints" class="form-control" min="0" value="100">
                </div>
                <button class="action-btn success" onclick="saveLoyaltySettings()" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> GST Invoice</h3>
                <div>
                    <button class="action-btn" onclick="printInvoice()" style="margin-right: 10px; display: inline-flex;">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="close-modal" onclick="closeModal('invoiceModal')">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="invoiceContent"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let sales = [];
        let inventoryItems = [];
        let stores = [];
        let salesPersons = [];
        let coupons = [];
        let returns = [];
        let loyaltySettings = {
            pointsPerHundred: 1,
            redeemRate: 50,
            minRedeemPoints: 100
        };
        let salesTargets = {
            monthly: 100000,
            daily: 5000,
            commission: 5
        };
        let cart = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentTab = 'all';
        let salesChart, paymentChart;

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log('User logged in:', user.email);
                loadInitialData();
            } else {
                showToast('Please login first', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        });

        // Load initial data
        async function loadInitialData() {
            try {
                showToast('Loading sales management system...', 'info');
                
                await Promise.all([
                    loadSales(),
                    loadInventory(),
                    loadStores(),
                    loadSalesPersons(),
                    loadCoupons(),
                    loadReturns(),
                    loadLoyaltySettings(),
                    loadSalesTargets()
                ]);
                
                initializeCharts();
                updateStats();
                renderSalesTable();
                updateDropdowns();
                updateCouponDropdown();
                
                showToast('System loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Failed to load data: ' + error.message, 'error');
            }
        }

        // Load sales from Firebase
        async function loadSales() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('sales')
                    .orderBy('date', 'desc')
                    .get();
                
                sales = snapshot.docs.map(doc => {
                    const data = doc.data();
                    let saleDate = new Date();
                    if (data.date) {
                        if (data.date.toDate) saleDate = data.date.toDate();
                        else if (data.date.seconds) saleDate = new Date(data.date.seconds * 1000);
                        else saleDate = new Date(data.date);
                    }

                    return {
                        id: doc.id,
                        invoiceNumber: data.invoiceNumber || `INV-${doc.id.slice(-8)}`,
                        date: saleDate,
                        storeId: data.storeId || '',
                        storeName: data.storeName || 'Main Store',
                        salesPersonId: data.salesPersonId || '',
                        salesPersonName: data.salesPersonName || 'Unknown',
                        customerName: data.customerName || 'Walk-in Customer',
                        customerPhone: data.customerPhone || '',
                        items: data.items || [],
                        subtotal: data.subtotal || 0,
                        discount: data.discount || 0,
                        couponCode: data.couponCode || '',
                        couponDiscount: data.couponDiscount || 0,
                        loyaltyPoints: data.loyaltyPoints || 0,
                        loyaltyDiscount: data.loyaltyDiscount || 0,
                        tax: data.tax || 0,
                        total: data.total || 0,
                        amountPaid: data.amountPaid || 0,
                        balanceDue: data.balanceDue || 0,
                        paymentMethod: data.paymentMethod || 'cash',
                        paymentStatus: data.paymentStatus || 'paid',
                        status: data.status || 'completed',
                        deliveryAddress: data.deliveryAddress || '',
                        notes: data.notes || ''
                    };
                });

                console.log(`Loaded ${sales.length} sales`);
            } catch (error) {
                console.error('Error loading sales:', error);
                throw error;
            }
        }

        // Load inventory
        async function loadInventory() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('inventory').get();
                inventoryItems = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    storeStock: doc.data().storeStock || {}
                }));
                console.log(`Loaded ${inventoryItems.length} inventory items`);
            } catch (error) {
                console.error('Error loading inventory:', error);
                throw error;
            }
        }

        // Load stores
        async function loadStores() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('stores').get();
                stores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                if (stores.length === 0) {
                    // Create default store
                    const defaultStore = {
                        name: 'Main Store',
                        location: 'Headquarters',
                        gst: 'GST12345678'
                    };
                    const docRef = await db.collection('users').doc(currentUser.uid).collection('stores').add(defaultStore);
                    stores.push({ id: docRef.id, ...defaultStore });
                }
            } catch (error) {
                console.error('Error loading stores:', error);
                throw error;
            }
        }

        // Load sales persons
        async function loadSalesPersons() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('salesPersons').get();
                salesPersons = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading sales persons:', error);
                throw error;
            }
        }

        // Load coupons
        async function loadCoupons() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('coupons').get();
                coupons = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading coupons:', error);
                throw error;
            }
        }

        // Load returns
        async function loadReturns() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('returns').get();
                returns = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading returns:', error);
                throw error;
            }
        }

        // Load loyalty settings
        async function loadLoyaltySettings() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('loyalty').get();
                if (doc.exists) {
                    loyaltySettings = doc.data();
                }
            } catch (error) {
                console.error('Error loading loyalty settings:', error);
            }
        }

        // Load sales targets
        async function loadSalesTargets() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('targets').get();
                if (doc.exists) {
                    salesTargets = doc.data();
                }
            } catch (error) {
                console.error('Error loading sales targets:', error);
            }
        }

        // Update dropdowns
        function updateDropdowns() {
            // Store dropdown
            const storeSelect = document.getElementById('saleStore');
            if (storeSelect) {
                let options = '<option value="">Select Store</option>';
                stores.forEach(store => {
                    options += `<option value="${store.id}">${store.name} - ${store.location}</option>`;
                });
                storeSelect.innerHTML = options;
            }

            // Sales person dropdown
            const personSelect = document.getElementById('saleSalesPerson');
            if (personSelect) {
                let options = '<option value="">Select Sales Person</option>';
                salesPersons.forEach(person => {
                    options += `<option value="${person.id}">${person.name} (${person.employeeId})</option>`;
                });
                personSelect.innerHTML = options;
            }

            // Sales person store dropdown in modal
            const personStoreSelect = document.getElementById('salesPersonStore');
            if (personStoreSelect) {
                let options = '<option value="">Select Store</option>';
                stores.forEach(store => {
                    options += `<option value="${store.id}">${store.name}</option>`;
                });
                personStoreSelect.innerHTML = options;
            }
        }

        // Update coupon dropdown
        function updateCouponDropdown() {
            const couponSelect = document.getElementById('saleCoupon');
            if (!couponSelect) return;

            const now = new Date();
            const validCoupons = coupons.filter(coupon => 
                new Date(coupon.validUntil) > now
            );

            let options = '<option value="">No Coupon</option>';
            validCoupons.forEach(coupon => {
                options += `<option value="${coupon.code}" data-type="${coupon.type}" data-value="${coupon.value}" data-min="${coupon.minPurchase}">
                    ${coupon.code} - ${coupon.type === 'percentage' ? coupon.value + '%' : 'â‚¹' + coupon.value} off
                </option>`;
            });
            couponSelect.innerHTML = options;
        }

        // Initialize charts
        function initializeCharts() {
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sales',
                        data: [],
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const paymentCtx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'Card', 'UPI', 'Other'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            updateSalesChart();
            updatePaymentChart();
        }

        // Update sales chart
        function updateSalesChart() {
            const days = parseInt(document.getElementById('trendPeriod').value);
            const data = getSalesTrend(days);
            
            salesChart.data.labels = data.labels;
            salesChart.data.datasets[0].data = data.values;
            salesChart.update();
        }

        // Get sales trend data
        function getSalesTrend(days) {
            const labels = [];
            const values = [];
            const now = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));

                const daySales = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.toDateString() === date.toDateString() &&
                           sale.status === 'completed';
                });

                const total = daySales.reduce((sum, sale) => sum + sale.total, 0);
                values.push(total);
            }

            return { labels, values };
        }

        // Update payment chart
        function updatePaymentChart() {
            const paymentMethods = {
                cash: 0,
                card: 0,
                upi: 0,
                other: 0
            };

            sales.forEach(sale => {
                if (sale.status === 'completed') {
                    const method = sale.paymentMethod.toLowerCase();
                    if (paymentMethods.hasOwnProperty(method)) {
                        paymentMethods[method] += sale.total;
                    } else {
                        paymentMethods.other += sale.total;
                    }
                }
            });

            paymentChart.data.datasets[0].data = [
                paymentMethods.cash,
                paymentMethods.card,
                paymentMethods.upi,
                paymentMethods.other
            ];
            paymentChart.update();
        }

        // Update statistics
        function updateStats() {
            const now = new Date();
            const today = now.toDateString();

            // Today's sales
            const todaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === today && sale.status === 'completed'
            );
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('todayRevenue').textContent = `â‚¹${todayRevenue.toFixed(2)}`;

            // Yesterday's sales for trend
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === yesterday.toDateString() && sale.status === 'completed'
            );
            const yesterdayRevenue = yesterdaySales.reduce((sum, sale) => sum + sale.total, 0);
            
            const trend = yesterdayRevenue > 0 ? ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(1) : 100;
            const trendElement = document.getElementById('todayTrend').querySelector('span:first-child');
            trendElement.innerHTML = `<i class="fas fa-arrow-${trend >= 0 ? 'up' : 'down'}"></i> ${Math.abs(trend)}%`;
            trendElement.className = trend >= 0 ? 'trend-up' : 'trend-down';

            // Monthly revenue
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthlySales = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && 
                       saleDate.getFullYear() === currentYear &&
                       sale.status === 'completed';
            });
            const monthlyRevenue = monthlySales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('monthlyRevenue').textContent = `â‚¹${monthlyRevenue.toFixed(2)}`;
            document.getElementById('monthlyTarget').textContent = `Target: â‚¹${salesTargets.monthly.toFixed(2)}`;

            // Total transactions
            document.getElementById('totalTransactions').textContent = sales.length;
            const avgOrder = sales.length > 0 ? 
                sales.reduce((sum, sale) => sum + sale.total, 0) / sales.length : 0;
            document.getElementById('avgOrderValue').textContent = `Avg: â‚¹${avgOrder.toFixed(2)}`;

            // Forecast (simple moving average)
            const last30Days = getSalesTrend(30).values;
            const avgLast30 = last30Days.reduce((a, b) => a + b, 0) / 30;
            const forecast = avgLast30 * 30;
            document.getElementById('forecastValue').textContent = `â‚¹${forecast.toFixed(2)}`;

            // Update badges
            document.getElementById('todayBadge').textContent = todaySales.length;
            document.getElementById('pendingBadge').textContent = sales.filter(s => s.status === 'pending').length;
            document.getElementById('partialBadge').textContent = sales.filter(s => s.paymentStatus === 'partial').length;
            document.getElementById('returnsBadge').textContent = returns.length;
        }

        // Render sales table
        function renderSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            const searchTerm = document.getElementById('searchSales')?.value.toLowerCase() || '';

            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="16" class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <h4>No sales found</h4>
                            <p>Click "New Sale" to create your first sale</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Filter sales
            let filteredSales = filterSalesByTab(sales, currentTab);

            // Search filter
            if (searchTerm) {
                filteredSales = filteredSales.filter(sale => 
                    (sale.invoiceNumber || '').toLowerCase().includes(searchTerm) ||
                    (sale.salesPersonName || '').toLowerCase().includes(searchTerm) ||
                    (sale.storeName || '').toLowerCase().includes(searchTerm) ||
                    (sale.customerName || '').toLowerCase().includes(searchTerm)
                );
            }

            // Pagination
            const totalPages = Math.ceil(filteredSales.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageSales = filteredSales.slice(startIndex, startIndex + itemsPerPage);

            // Update table info
            document.getElementById('totalCount').textContent = filteredSales.length;
            document.getElementById('startCount').textContent = filteredSales.length > 0 ? startIndex + 1 : 0;
            document.getElementById('endCount').textContent = Math.min(startIndex + itemsPerPage, filteredSales.length);

            if (filteredSales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="16" class="empty-state">
                            <i class="fas fa-filter"></i>
                            <h4>No sales match your filter</h4>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageSales.map(sale => {
                    const statusClass = sale.status === 'completed' ? 'badge-success' :
                                      sale.status === 'pending' ? 'badge-warning' :
                                      'badge-danger';
                    
                    const paymentStatusClass = sale.paymentStatus === 'paid' ? 'badge-success' :
                                             sale.paymentStatus === 'partial' ? 'badge-warning' :
                                             'badge-danger';
                    
                    return `
                        <tr>
                            <td><strong>${sale.invoiceNumber}</strong></td>
                            <td>
                                <div>${formatDate(sale.date)}</div>
                                <small style="color: #666;">${formatTime(sale.date)}</small>
                            </td>
                            <td>${sale.storeName}</td>
                            <td>${sale.salesPersonName}</td>
                            <td>${sale.items ? sale.items.length : 0}</td>
                            <td>â‚¹${(sale.subtotal || 0).toFixed(2)}</td>
                            <td>â‚¹${(sale.discount || 0).toFixed(2)}</td>
                            <td>
                                ${sale.couponCode ? 
                                    `<span class="badge badge-info">${sale.couponCode}</span>` : 
                                    '-'}
                            </td>
                            <td>â‚¹${(sale.tax || 0).toFixed(2)}</td>
                            <td><strong>â‚¹${(sale.total || 0).toFixed(2)}</strong></td>
                            <td>â‚¹${(sale.amountPaid || 0).toFixed(2)}</td>
                            <td>
                                ${sale.balanceDue > 0 ? 
                                    `<span style="color: var(--danger);">â‚¹${sale.balanceDue.toFixed(2)}</span>` : 
                                    '-'}
                            </td>
                            <td><span class="badge ${paymentStatusClass}">${sale.paymentStatus}</span></td>
                            <td><span class="badge ${statusClass}">${sale.status}</span></td>
                            <td>${sale.loyaltyPoints || 0}</td>
                            <td>
                                <div class="action-icons">
                                    <button class="icon-btn" onclick="viewInvoice('${sale.id}')" title="View Invoice">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                    ${sale.balanceDue > 0 ? `
                                        <button class="icon-btn success" onclick="recordPayment('${sale.id}')" title="Record Payment">
                                            <i class="fas fa-money-bill"></i>
                                        </button>
                                    ` : ''}
                                    <button class="icon-btn warning" onclick="generateQRInvoice('${sale.id}')" title="QR Invoice">
                                        <i class="fas fa-qrcode"></i>
                                    </button>
                                    ${sale.status !== 'cancelled' ? `
                                        <button class="icon-btn danger" onclick="cancelSale('${sale.id}')" title="Cancel Sale">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updatePagination(totalPages);
        }

        // Filter sales by tab
        function filterSalesByTab(salesList, tab) {
            const now = new Date();
            const today = now.toDateString();

            switch(tab) {
                case 'today':
                    return salesList.filter(s => new Date(s.date).toDateString() === today);
                case 'pending':
                    return salesList.filter(s => s.status === 'pending');
                case 'partial':
                    return salesList.filter(s => s.paymentStatus === 'partial');
                case 'completed':
                    return salesList.filter(s => s.status === 'completed');
                case 'returns':
                    return salesList.filter(s => s.status === 'returned');
                default:
                    return salesList;
            }
        }

        // Update pagination
        function updatePagination(totalPages) {
            const container = document.getElementById('pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            html += `<button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                    onclick="${currentPage > 1 ? `goToPage(${currentPage - 1})` : ''}">
                    <i class="fas fa-chevron-left"></i>
                </button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || 
                    i === totalPages || 
                    (i >= currentPage - 2 && i <= currentPage + 2)
                ) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<button class="page-btn disabled">...</button>`;
                }
            }
            
            html += `<button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                    onclick="${currentPage < totalPages ? `goToPage(${currentPage + 1})` : ''}">
                    <i class="fas fa-chevron-right"></i>
                </button>`;
            
            container.innerHTML = html;
        }

        // Go to page
        function goToPage(page) {
            currentPage = page;
            renderSalesTable();
        }

        // Change items per page
        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            renderSalesTable();
        }

        // Load sales by tab
        function loadSalesTab(tab, element) {
            currentTab = tab;
            currentPage = 1;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            renderSalesTable();
        }

        // Search sales
        function searchSales() {
            currentPage = 1;
            renderSalesTable();
        }

        // Open new sale modal
        async function openNewSaleModal() {
            cart = [];
            await loadInventory();
            renderItemsGrid();
            updateCartCalculations();
            document.getElementById('availablePoints').textContent = '0'; // Would come from customer loyalty
            document.getElementById('newSaleModal').style.display = 'flex';
        }

        // Render items grid
        function renderItemsGrid() {
            const grid = document.getElementById('itemsGrid');
            const searchTerm = document.getElementById('searchItems')?.value.toLowerCase() || '';
            const storeId = document.getElementById('saleStore').value;

            if (inventoryItems.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-box-open"></i>
                        <h4>No Items Found</h4>
                        <p>Please add items to your inventory first</p>
                    </div>
                `;
                return;
            }

            const filteredItems = inventoryItems.filter(item => {
                const stock = storeId ? (item.storeStock?.[storeId] || 0) : item.currentStock || 0;
                return stock > 0 && 
                    (item.name?.toLowerCase().includes(searchTerm) ||
                     (item.category || '').toLowerCase().includes(searchTerm));
            });

            if (filteredItems.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-search"></i>
                        <h4>No matching items</h4>
                        <p>Try a different search term or store</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredItems.map(item => {
                const stock = storeId ? (item.storeStock?.[storeId] || 0) : item.currentStock || 0;
                const stockClass = stock <= (item.minStock || 5) ? 'stock-low' : 'stock-good';
                
                return `
                    <div class="item-card" onclick="addToCart('${item.id}')">
                        <h5>${item.name || 'Unnamed Item'}</h5>
                        <div class="item-price">â‚¹${(item.sellingPrice || 0).toFixed(2)}</div>
                        <div class="item-stock ${stockClass}">
                            Stock: ${stock} ${item.unit || 'pcs'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update store inventory
        function updateStoreInventory() {
            renderItemsGrid();
        }

        // Filter items
        function filterItems() {
            renderItemsGrid();
        }

        // Add to cart
        function addToCart(itemId) {
            const item = inventoryItems.find(i => i.id === itemId);
            const storeId = document.getElementById('saleStore').value;
            const stock = storeId ? (item.storeStock?.[storeId] || 0) : item.currentStock || 0;
            
            if (!item) return;

            const existingItem = cart.find(i => i.id === itemId);
            if (existingItem) {
                if (existingItem.quantity < stock) {
                    existingItem.quantity++;
                } else {
                    showToast('Not enough stock!', 'error');
                    return;
                }
            } else {
                cart.push({
                    id: item.id,
                    name: item.name,
                    price: item.sellingPrice || 0,
                    quantity: 1,
                    maxStock: stock,
                    unit: item.unit || 'pcs'
                });
            }

            updateCartCalculations();
            showToast(`${item.name} added to cart`, 'success');
        }

        // Update cart display
        function updateCartDisplay() {
            const cartContainer = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Cart is empty</p>
                    </div>
                `;
            } else {
                cartContainer.innerHTML = cart.map((item, index) => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h6>${item.name}</h6>
                            <small>â‚¹${item.price} Ã— ${item.quantity} ${item.unit}</small>
                        </div>
                        <div class="cart-item-actions">
                            <input type="number" class="cart-quantity" min="1" max="${item.maxStock}" 
                                   value="${item.quantity}" onchange="updateQuantity(${index}, this.value)">
                            <i class="fas fa-trash" style="color: var(--danger); cursor: pointer;" onclick="removeFromCart(${index})"></i>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Update cart calculations
        function updateCartCalculations() {
            updateCartDisplay();

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Get coupon discount
            const couponSelect = document.getElementById('saleCoupon');
            const couponDiscount = couponSelect.selectedOptions[0]?.dataset ? 
                calculateCouponDiscount(couponSelect.selectedOptions[0].dataset, subtotal) : 0;

            // Get loyalty discount
            const loyaltyPoints = parseInt(document.getElementById('loyaltyPoints').value) || 0;
            const loyaltyDiscount = calculateLoyaltyDiscount(loyaltyPoints);

            // Calculate total discount
            const totalDiscount = couponDiscount + loyaltyDiscount;
            
            // Calculate taxable amount
            const taxableAmount = subtotal - totalDiscount;
            
            // Calculate tax (18% GST)
            const taxRate = 18;
            const tax = (taxableAmount * taxRate) / 100;
            
            // Calculate total
            const total = taxableAmount + tax;

            // Update display
            document.getElementById('cartSubtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
            document.getElementById('cartDiscount').textContent = `-â‚¹${totalDiscount.toFixed(2)}`;
            document.getElementById('couponDiscount').textContent = `-â‚¹${couponDiscount.toFixed(2)}`;
            document.getElementById('loyaltyDiscount').textContent = `-â‚¹${loyaltyDiscount.toFixed(2)}`;
            document.getElementById('cartTax').textContent = `â‚¹${tax.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `â‚¹${total.toFixed(2)}`;
            
            updatePaymentBalance();
        }

        // Calculate coupon discount
        function calculateCouponDiscount(couponData, subtotal) {
            if (!couponData) return 0;
            
            const type = couponData.type;
            const value = parseFloat(couponData.value);
            const minPurchase = parseFloat(couponData.min) || 0;

            if (subtotal < minPurchase) return 0;

            if (type === 'percentage') {
                return (subtotal * value) / 100;
            } else {
                return Math.min(value, subtotal);
            }
        }

        // Calculate loyalty discount
        function calculateLoyaltyDiscount(points) {
            if (points < loyaltySettings.minRedeemPoints) return 0;
            return (points / 100) * loyaltySettings.redeemRate;
        }

        // Update quantity
        function updateQuantity(index, quantity) {
            quantity = parseInt(quantity);
            if (quantity < 1) quantity = 1;
            if (quantity > cart[index].maxStock) {
                showToast('Not enough stock!', 'error');
                quantity = cart[index].maxStock;
            }
            cart[index].quantity = quantity;
            updateCartCalculations();
        }

        // Remove from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCalculations();
        }

        // Apply coupon
        function applyCoupon() {
            updateCartCalculations();
        }

        // Calculate loyalty discount on input
        function calculateLoyaltyDiscount() {
            updateCartCalculations();
        }

        // Toggle partial payment
        function togglePartialPayment() {
            const method = document.getElementById('paymentMethod').value;
            const partialInfo = document.getElementById('partialPaymentInfo');
            
            if (method === 'partial') {
                partialInfo.style.display = 'block';
            } else {
                partialInfo.style.display = 'none';
                document.getElementById('amountPaid').value = 0;
            }
            
            updatePaymentBalance();
        }

        // Update payment balance
        function updatePaymentBalance() {
            const totalText = document.getElementById('cartTotal').textContent;
            const total = parseFloat(totalText.replace('â‚¹', '')) || 0;
            
            const method = document.getElementById('paymentMethod').value;
            let amountPaid = total;
            
            if (method === 'partial') {
                amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
                if (amountPaid > total) {
                    amountPaid = total;
                    document.getElementById('amountPaid').value = total;
                }
            }
            
            const balance = total - amountPaid;
            document.getElementById('balanceDue').textContent = `â‚¹${balance.toFixed(2)}`;
        }

        // Process sale
        async function processSale() {
            if (cart.length === 0) {
                showToast('Cart is empty! Add items to cart', 'error');
                return;
            }

            const storeId = document.getElementById('saleStore').value;
            const salesPersonId = document.getElementById('saleSalesPerson').value;

            if (!storeId || !salesPersonId) {
                showToast('Please select store and sales person', 'error');
                return;
            }

            try {
                showToast('Processing sale...', 'info');

                const store = stores.find(s => s.id === storeId);
                const salesPerson = salesPersons.find(s => s.id === salesPersonId);

                // Calculate amounts
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Get coupon discount
                const couponSelect = document.getElementById('saleCoupon');
                const couponCode = couponSelect.value;
                const couponDiscount = couponCode ? 
                    calculateCouponDiscount(couponSelect.selectedOptions[0]?.dataset, subtotal) : 0;

                // Get loyalty discount
                const loyaltyPoints = parseInt(document.getElementById('loyaltyPoints').value) || 0;
                const loyaltyDiscount = calculateLoyaltyDiscount(loyaltyPoints);

                // Total discount
                const totalDiscount = couponDiscount + loyaltyDiscount;

                // Tax and total
                const taxRate = 18;
                const taxableAmount = subtotal - totalDiscount;
                const tax = (taxableAmount * taxRate) / 100;
                const total = taxableAmount + tax;

                // Payment
                const paymentMethod = document.getElementById('paymentMethod').value;
                let amountPaid = total;
                let balanceDue = 0;
                let paymentStatus = 'paid';
                
                if (paymentMethod === 'partial') {
                    amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
                    if (amountPaid >= total) {
                        amountPaid = total;
                        paymentStatus = 'paid';
                    } else if (amountPaid > 0) {
                        balanceDue = total - amountPaid;
                        paymentStatus = 'partial';
                    } else {
                        paymentStatus = 'pending';
                    }
                }

                const invoiceNumber = 'INV-' + Date.now().toString().slice(-8) + '-' + Math.random().toString(36).substring(2, 5).toUpperCase();

                const saleData = {
                    invoiceNumber: invoiceNumber,
                    date: firebase.firestore.FieldValue.serverTimestamp(),
                    storeId: storeId,
                    storeName: store.name,
                    salesPersonId: salesPersonId,
                    salesPersonName: salesPerson.name,
                    customerName: document.getElementById('saleCustomer').value || 'Walk-in Customer',
                    customerPhone: document.getElementById('saleCustomerPhone').value || '',
                    items: cart.map(item => ({
                        itemId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        total: item.price * item.quantity
                    })),
                    subtotal: subtotal,
                    discount: totalDiscount,
                    couponCode: couponCode || '',
                    couponDiscount: couponDiscount,
                    loyaltyPoints: loyaltyPoints,
                    loyaltyDiscount: loyaltyDiscount,
                    tax: tax,
                    total: total,
                    amountPaid: amountPaid,
                    balanceDue: balanceDue,
                    paymentMethod: paymentMethod,
                    paymentStatus: paymentStatus,
                    status: paymentStatus === 'pending' ? 'pending' : 'completed',
                    deliveryAddress: document.getElementById('deliveryAddress').value || '',
                    notes: ''
                };

                // Start batch
                const batch = db.batch();

                // Add sale
                const saleRef = db.collection('users').doc(currentUser.uid).collection('sales').doc();
                batch.set(saleRef, saleData);

                // Update inventory stock for store
                for (const item of cart) {
                    const inventoryRef = db.collection('users').doc(currentUser.uid).collection('inventory').doc(item.id);
                    const inventoryItem = inventoryItems.find(i => i.id === item.id);
                    
                    if (inventoryItem) {
                        const storeStock = inventoryItem.storeStock || {};
                        const currentStock = storeStock[storeId] || 0;
                        storeStock[storeId] = currentStock - item.quantity;
                        
                        batch.update(inventoryRef, {
                            storeStock: storeStock,
                            lastSold: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                // Update sales person stats
                const salesPersonRef = db.collection('users').doc(currentUser.uid).collection('salesPersons').doc(salesPersonId);
                batch.update(salesPersonRef, {
                    totalSales: firebase.firestore.FieldValue.increment(total),
                    saleCount: firebase.firestore.FieldValue.increment(1),
                    lastSale: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();

                // Show invoice
                showInvoice({
                    ...saleData,
                    id: saleRef.id,
                    date: new Date(),
                    storeGST: store.gst
                });

                // Reset and reload
                closeModal('newSaleModal');
                await loadSales();
                updateStats();
                updateSalesChart();
                updatePaymentChart();
                renderSalesTable();
                
                showToast('Sale completed successfully!', 'success');

            } catch (error) {
                console.error('Error processing sale:', error);
                showToast('Failed to process sale: ' + error.message, 'error');
            }
        }

        // Show invoice
        function showInvoice(sale) {
            const itemsHtml = sale.items.map((item, index) => `
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #e9ecef;">${index + 1}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e9ecef;">${item.name}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e9ecef;">${item.quantity}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e9ecef;">â‚¹${item.price.toFixed(2)}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #e9ecef;">â‚¹${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            // Generate QR code data
            const qrData = JSON.stringify({
                invoice: sale.invoiceNumber,
                date: formatDate(sale.date),
                total: sale.total,
                gst: sale.tax,
                store: sale.storeName
            });

            const invoiceHtml = `
                <div style="padding: 30px;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <h2 style="color: var(--primary); margin-bottom: 5px;">TAX INVOICE</h2>
                            <p style="color: #666;">${sale.storeName}</p>
                            <p style="color: #666;">GST: ${sale.storeGST || 'GST12345678'}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <p><strong>Invoice No:</strong> ${sale.invoiceNumber}</p>
                                <p><strong>Date:</strong> ${formatDate(sale.date)}</p>
                                <p><strong>Time:</strong> ${formatTime(sale.date)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Placeholder -->
                    <div style="text-align: right; margin-bottom: 20px;">
                        <div style="display: inline-block; background: #f8f9fa; padding: 10px; border-radius: 10px;">
                            <i class="fas fa-qrcode" style="font-size: 64px; color: var(--dark);"></i>
                            <p style="font-size: 10px; margin-top: 5px;">Scan for details</p>
                        </div>
                    </div>

                    <!-- Bill To -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 10px;">Bill To:</h4>
                        <p><strong>${sale.customerName}</strong></p>
                        ${sale.customerPhone ? `<p>Phone: ${sale.customerPhone}</p>` : ''}
                        ${sale.deliveryAddress ? `<p>Address: ${sale.deliveryAddress}</p>` : ''}
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                <th style="padding: 12px; text-align: left;">#</th>
                                <th style="padding: 12px; text-align: left;">Item</th>
                                <th style="padding: 12px; text-align: left;">Qty</th>
                                <th style="padding: 12px; text-align: left;">Price</th>
                                <th style="padding: 12px; text-align: left;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <!-- Summary -->
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="width: 350px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span>Subtotal:</span>
                                <span>â‚¹${sale.subtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span>Discount:</span>
                                <span>-â‚¹${(sale.discount || 0).toFixed(2)}</span>
                            </div>
                            ${sale.couponCode ? `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>Coupon (${sale.couponCode}):</span>
                                    <span>-â‚¹${sale.couponDiscount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${sale.loyaltyPoints > 0 ? `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>Loyalty Points (${sale.loyaltyPoints}):</span>
                                    <span>-â‚¹${sale.loyaltyDiscount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span>Tax (GST 18%):</span>
                                <span>â‚¹${sale.tax.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px 0; border-top: 2px solid #e9ecef; font-weight: bold; font-size: 18px;">
                                <span>Total:</span>
                                <span>â‚¹${sale.total.toFixed(2)}</span>
                            </div>
                            ${sale.paymentStatus !== 'paid' ? `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>Amount Paid:</span>
                                    <span>â‚¹${sale.amountPaid.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; color: var(--danger);">
                                    <span>Balance Due:</span>
                                    <span>â‚¹${sale.balanceDue.toFixed(2)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 50px; text-align: center; color: #666;">
                        <p>Thank you for your business!</p>
                        <p style="font-size: 12px;">This is a computer generated invoice</p>
                    </div>
                </div>
            `;

            document.getElementById('invoiceContent').innerHTML = invoiceHtml;
            document.getElementById('invoiceModal').style.display = 'flex';
        }

        // Generate QR invoice
        function generateQRInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (sale) {
                showInvoice(sale);
            }
        }

        // View invoice
        function viewInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (sale) showInvoice(sale);
        }

        // Record payment
        function recordPayment(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            // Create simple payment modal
            const modalHtml = `
                <div class="modal-overlay" id="paymentModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header" style="background: var(--gradient-warning);">
                            <h3><i class="fas fa-money-bill"></i> Record Payment</h3>
                            <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="paymentSaleId" value="${sale.id}">
                            <div class="form-group">
                                <label>Invoice Number</label>
                                <input type="text" class="form-control" value="${sale.invoiceNumber}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Customer</label>
                                <input type="text" class="form-control" value="${sale.customerName}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Total Amount</label>
                                <input type="text" class="form-control" value="â‚¹${sale.total.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Balance Due</label>
                                <input type="text" class="form-control" value="â‚¹${sale.balanceDue.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Payment Amount</label>
                                <input type="number" id="paymentAmount" class="form-control" min="0" max="${sale.balanceDue}" step="0.01" value="${sale.balanceDue}">
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="paymentMethodSelect" class="form-control">
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="bank">Bank Transfer</option>
                                </select>
                            </div>
                            <button class="action-btn warning" onclick="processPayment()" style="width: 100%;">
                                <i class="fas fa-check-circle"></i> Record Payment
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('paymentModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Process payment
        async function processPayment() {
            const saleId = document.getElementById('paymentSaleId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethodSelect').value;

            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            if (amount <= 0 || amount > sale.balanceDue) {
                showToast('Invalid payment amount', 'error');
                return;
            }

            try {
                showToast('Processing payment...', 'info');

                const newAmountPaid = sale.amountPaid + amount;
                const newBalanceDue = sale.total - newAmountPaid;
                const newPaymentStatus = newBalanceDue <= 0 ? 'paid' : 'partial';
                const newStatus = newPaymentStatus === 'paid' ? 'completed' : sale.status;

                const batch = db.batch();

                const saleRef = db.collection('users').doc(currentUser.uid).collection('sales').doc(saleId);
                batch.update(saleRef, {
                    amountPaid: newAmountPaid,
                    balanceDue: newBalanceDue,
                    paymentStatus: newPaymentStatus,
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();

                closeModal('paymentModal');
                await loadSales();
                updateStats();
                renderSalesTable();
                
                showToast('Payment recorded successfully!', 'success');
            } catch (error) {
                console.error('Error recording payment:', error);
                showToast('Failed to record payment: ' + error.message, 'error');
            }
        }

        // Cancel sale
        async function cancelSale(saleId) {
            if (!confirm('Are you sure you want to cancel this sale? This will restore inventory stock.')) return;

            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;

            try {
                showToast('Cancelling sale...', 'info');

                const batch = db.batch();

                // Update sale status
                const saleRef = db.collection('users').doc(currentUser.uid).collection('sales').doc(saleId);
                batch.update(saleRef, {
                    status: 'cancelled',
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Restore inventory
                for (const item of sale.items) {
                    if (item.itemId && sale.storeId) {
                        const inventoryRef = db.collection('users').doc(currentUser.uid).collection('inventory').doc(item.itemId);
                        const inventoryItem = inventoryItems.find(i => i.id === item.itemId);
                        
                        if (inventoryItem) {
                            const storeStock = inventoryItem.storeStock || {};
                            const currentStock = storeStock[sale.storeId] || 0;
                            storeStock[sale.storeId] = currentStock + item.quantity;
                            
                            batch.update(inventoryRef, {
                                storeStock: storeStock
                            });
                        }
                    }
                }

                await batch.commit();

                await loadSales();
                await loadInventory();
                updateStats();
                renderSalesTable();
                
                showToast('Sale cancelled successfully!', 'success');
            } catch (error) {
                console.error('Error cancelling sale:', error);
                showToast('Failed to cancel sale: ' + error.message, 'error');
            }
        }

        // Open return modal
        function openReturnModal() {
            document.getElementById('returnInvoice').value = '';
            document.getElementById('returnItems').innerHTML = '';
            document.getElementById('returnModal').style.display = 'flex';
        }

        // Search return invoice
        function searchReturnInvoice() {
            const invoiceNumber = document.getElementById('returnInvoice').value.trim();
            const sale = sales.find(s => s.invoiceNumber === invoiceNumber);

            const returnDiv = document.getElementById('returnItems');
            
            if (!sale) {
                returnDiv.innerHTML = '<p class="empty-state">Invoice not found</p>';
                return;
            }

            if (sale.status === 'cancelled' || sale.status === 'returned') {
                returnDiv.innerHTML = '<p class="empty-state">This sale cannot be returned</p>';
                return;
            }

            const itemsHtml = `
                <h5 style="margin-bottom: 15px;">Sale Date: ${formatDate(sale.date)}</h5>
                <div style="margin-bottom: 20px;">
                    ${sale.items.map((item, index) => `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 10px;">
                            <input type="checkbox" id="returnItem${index}" value="${item.itemId}" data-price="${item.price}" data-quantity="${item.quantity}">
                            <div style="flex: 1;">
                                <strong>${item.name}</strong><br>
                                <small>Qty: ${item.quantity} Ã— â‚¹${item.price}</small>
                            </div>
                            <input type="number" id="returnQty${index}" min="1" max="${item.quantity}" value="${item.quantity}" style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    `).join('')}
                </div>
                <div style="margin-bottom: 20px;">
                    <label>Return Reason</label>
                    <select id="returnReason" class="form-control">
                        <option value="defective">Defective Product</option>
                        <option value="wrong_item">Wrong Item</option>
                        <option value="customer_not_satisfied">Customer Not Satisfied</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label>Refund Method</label>
                    <select id="refundMethod" class="form-control">
                        <option value="original">Original Payment Method</option>
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                    </select>
                </div>
            `;

            returnDiv.innerHTML = itemsHtml;
        }

        // Process return
        async function processReturn() {
            const invoiceNumber = document.getElementById('returnInvoice').value.trim();
            const sale = sales.find(s => s.invoiceNumber === invoiceNumber);

            if (!sale) {
                showToast('Sale not found', 'error');
                return;
            }

            try {
                showToast('Processing return...', 'info');

                const batch = db.batch();
                const returnedItems = [];

                for (let i = 0; i < sale.items.length; i++) {
                    const checkbox = document.getElementById(`returnItem${i}`);
                    if (checkbox && checkbox.checked) {
                        const qtyInput = document.getElementById(`returnQty${i}`);
                        const quantity = parseInt(qtyInput.value);

                        returnedItems.push({
                            itemId: sale.items[i].itemId,
                            name: sale.items[i].name,
                            quantity: quantity,
                            price: sale.items[i].price
                        });

                        // Restore inventory
                        if (sale.storeId) {
                            const inventoryRef = db.collection('users').doc(currentUser.uid).collection('inventory').doc(sale.items[i].itemId);
                            const inventoryItem = inventoryItems.find(item => item.id === sale.items[i].itemId);
                            
                            if (inventoryItem) {
                                const storeStock = inventoryItem.storeStock || {};
                                storeStock[sale.storeId] = (storeStock[sale.storeId] || 0) + quantity;
                                
                                batch.update(inventoryRef, {
                                    storeStock: storeStock
                                });
                            }
                        }
                    }
                }

                if (returnedItems.length === 0) {
                    showToast('Select items to return', 'error');
                    return;
                }

                const returnData = {
                    saleId: sale.id,
                    invoiceNumber: sale.invoiceNumber,
                    items: returnedItems,
                    reason: document.getElementById('returnReason').value,
                    refundMethod: document.getElementById('refundMethod').value,
                    date: firebase.firestore.FieldValue.serverTimestamp(),
                    totalRefund: returnedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };

                // Add return record
                const returnRef = db.collection('users').doc(currentUser.uid).collection('returns').doc();
                batch.set(returnRef, returnData);

                // Update sale status
                const saleRef = db.collection('users').doc(currentUser.uid).collection('sales').doc(sale.id);
                batch.update(saleRef, {
                    status: 'returned',
                    returnedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();

                closeModal('returnModal');
                await loadSales();
                await loadReturns();
                await loadInventory();
                updateStats();
                renderSalesTable();
                
                showToast(`Return processed successfully! Refund: â‚¹${returnData.totalRefund.toFixed(2)}`, 'success');
            } catch (error) {
                console.error('Error processing return:', error);
                showToast('Failed to process return: ' + error.message, 'error');
            }
        }

        // Open coupon modal
        function openCouponModal() {
            document.getElementById('couponCode').value = '';
            document.getElementById('couponValue').value = '';
            document.getElementById('couponMinPurchase').value = '0';
            
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('couponValidUntil').value = nextMonth.toISOString().split('T')[0];
            
            document.getElementById('couponModal').style.display = 'flex';
        }

        // Save coupon
        async function saveCoupon() {
            const code = document.getElementById('couponCode').value.trim();
            const type = document.getElementById('couponType').value;
            const value = parseFloat(document.getElementById('couponValue').value);
            const minPurchase = parseFloat(document.getElementById('couponMinPurchase').value);
            const validUntil = document.getElementById('couponValidUntil').value;

            if (!code || !value || !validUntil) {
                showToast('Please fill all fields', 'error');
                return;
            }

            try {
                showToast('Creating coupon...', 'info');

                const couponData = {
                    code: code,
                    type: type,
                    value: value,
                    minPurchase: minPurchase,
                    validUntil: validUntil,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid).collection('coupons').add(couponData);

                closeModal('couponModal');
                await loadCoupons();
                updateCouponDropdown();
                
                showToast('Coupon created successfully!', 'success');
            } catch (error) {
                console.error('Error creating coupon:', error);
                showToast('Failed to create coupon: ' + error.message, 'error');
            }
        }

        // Open target modal
        function openTargetModal() {
            document.getElementById('monthlyTarget').value = salesTargets.monthly || 100000;
            document.getElementById('dailyTarget').value = salesTargets.daily || 5000;
            document.getElementById('commissionRate').value = salesTargets.commission || 5;
            document.getElementById('targetModal').style.display = 'flex';
        }

        // Save targets
        async function saveTargets() {
            const monthly = parseFloat(document.getElementById('monthlyTarget').value);
            const daily = parseFloat(document.getElementById('dailyTarget').value);
            const commission = parseFloat(document.getElementById('commissionRate').value);

            try {
                showToast('Saving targets...', 'info');

                const targetData = {
                    monthly: monthly,
                    daily: daily,
                    commission: commission,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid).collection('settings').doc('targets').set(targetData);

                salesTargets = targetData;
                closeModal('targetModal');
                updateStats();
                
                showToast('Targets saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving targets:', error);
                showToast('Failed to save targets: ' + error.message, 'error');
            }
        }

        // Open sales person modal
        function openSalesPersonModal() {
            document.getElementById('salesPersonName').value = '';
            document.getElementById('salesPersonId').value = '';
            document.getElementById('salesPersonModal').style.display = 'flex';
        }

        // Save sales person
        async function saveSalesPerson() {
            const name = document.getElementById('salesPersonName').value.trim();
            const employeeId = document.getElementById('salesPersonId').value.trim();
            const storeId = document.getElementById('salesPersonStore').value;

            if (!name || !employeeId || !storeId) {
                showToast('Please fill all fields', 'error');
                return;
            }

            try {
                showToast('Adding sales person...', 'info');

                const store = stores.find(s => s.id === storeId);

                const personData = {
                    name: name,
                    employeeId: employeeId,
                    storeId: storeId,
                    storeName: store.name,
                    totalSales: 0,
                    saleCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid).collection('salesPersons').add(personData);

                closeModal('salesPersonModal');
                await loadSalesPersons();
                updateDropdowns();
                
                showToast('Sales person added successfully!', 'success');
            } catch (error) {
                console.error('Error adding sales person:', error);
                showToast('Failed to add sales person: ' + error.message, 'error');
            }
        }

        // Open store modal
        async function openStoreModal() {
            renderStoresList();
            document.getElementById('storeModal').style.display = 'flex';
        }

        // Render stores list
        function renderStoresList() {
            const storesList = document.getElementById('storesList');
            
            if (stores.length === 0) {
                storesList.innerHTML = '<p>No stores added yet</p>';
                return;
            }

            storesList.innerHTML = stores.map(store => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8fafc; border-radius: 10px; margin-bottom: 10px;">
                    <div>
                        <strong>${store.name}</strong><br>
                        <small>${store.location} | GST: ${store.gst}</small>
                    </div>
                    <button class="icon-btn danger" onclick="deleteStore('${store.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Save store
        async function saveStore() {
            const name = document.getElementById('storeName').value.trim();
            const location = document.getElementById('storeLocation').value.trim();
            const gst = document.getElementById('storeGST').value.trim();

            if (!name || !location || !gst) {
                showToast('Please fill all fields', 'error');
                return;
            }

            try {
                showToast('Adding store...', 'info');

                const storeData = {
                    name: name,
                    location: location,
                    gst: gst,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid).collection('stores').add(storeData);

                document.getElementById('storeName').value = '';
                document.getElementById('storeLocation').value = '';
                document.getElementById('storeGST').value = '';

                await loadStores();
                updateDropdowns();
                renderStoresList();
                
                showToast('Store added successfully!', 'success');
            } catch (error) {
                console.error('Error adding store:', error);
                showToast('Failed to add store: ' + error.message, 'error');
            }
        }

        // Delete store
        async function deleteStore(storeId) {
            if (!confirm('Are you sure you want to delete this store?')) return;

            try {
                showToast('Deleting store...', 'info');

                await db.collection('users').doc(currentUser.uid).collection('stores').doc(storeId).delete();

                await loadStores();
                updateDropdowns();
                renderStoresList();
                
                showToast('Store deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting store:', error);
                showToast('Failed to delete store: ' + error.message, 'error');
            }
        }

        // Open loyalty modal
        function openLoyaltyModal() {
            document.getElementById('pointsPerHundred').value = loyaltySettings.pointsPerHundred || 1;
            document.getElementById('redeemRate').value = loyaltySettings.redeemRate || 50;
            document.getElementById('minRedeemPoints').value = loyaltySettings.minRedeemPoints || 100;
            document.getElementById('loyaltyModal').style.display = 'flex';
        }

        // Save loyalty settings
        async function saveLoyaltySettings() {
            const pointsPerHundred = parseFloat(document.getElementById('pointsPerHundred').value);
            const redeemRate = parseFloat(document.getElementById('redeemRate').value);
            const minRedeemPoints = parseInt(document.getElementById('minRedeemPoints').value);

            try {
                showToast('Saving loyalty settings...', 'info');

                const settings = {
                    pointsPerHundred: pointsPerHundred,
                    redeemRate: redeemRate,
                    minRedeemPoints: minRedeemPoints,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(currentUser.uid).collection('settings').doc('loyalty').set(settings);

                loyaltySettings = settings;
                closeModal('loyaltyModal');
                
                showToast('Loyalty settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving loyalty settings:', error);
                showToast('Failed to save loyalty settings: ' + error.message, 'error');
            }
        }

        // Export sales report
        async function exportSalesReport() {
            try {
                showToast('Generating sales report...', 'info');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(20);
                doc.text('Sales Report', 14, 22);

                // Date
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);

                // Summary
                const totalSales = sales.length;
                const totalRevenue = sales.reduce((sum, s) => sum + s.total, 0);
                const avgOrder = totalSales > 0 ? totalRevenue / totalSales : 0;

                doc.setFontSize(12);
                doc.text(`Total Sales: ${totalSales}`, 14, 40);
                doc.text(`Total Revenue: â‚¹${totalRevenue.toFixed(2)}`, 14, 48);
                doc.text(`Average Order: â‚¹${avgOrder.toFixed(2)}`, 14, 56);

                // Table
                const tableData = sales.slice(0, 50).map(sale => [
                    sale.invoiceNumber,
                    formatDate(sale.date),
                    sale.storeName,
                    sale.salesPersonName,
                    `â‚¹${sale.total.toFixed(2)}`,
                    sale.paymentStatus
                ]);

                doc.autoTable({
                    startY: 65,
                    head: [['Invoice', 'Date', 'Store', 'Sales Person', 'Total', 'Status']],
                    body: tableData
                });

                doc.save('sales_report.pdf');
                
                showToast('Report generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Failed to generate report: ' + error.message, 'error');
            }
        }

        // Refresh data
        function refreshData() {
            loadInitialData();
        }

        // Format date
        function formatDate(date) {
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatTime(date) {
            if (!date) return 'N/A';
            return date.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Print invoice
        function printInvoice() {
            window.print();
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 
                        'info-circle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>