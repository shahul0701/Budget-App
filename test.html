<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Budget Analytics & Forecasting</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
    }

    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }

    .page {
      max-width:1800px;
      margin:20px auto;
      padding:15px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      margin-bottom:20px;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; }

    .content-body { padding:20px 22px 32px; }

    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
      height:100%;
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-subtext { font-size:11px; color:var(--muted); margin-top:5px; }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    .forecast-card {
      background: linear-gradient(135deg, var(--purple-1) 0%, var(--purple-2) 100%);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }

    .savings-suggestion {
      background: rgba(25, 135, 84, 0.1);
      border-left: 4px solid var(--success);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
    }
    .savings-suggestion.warning {
      background: rgba(255, 193, 7, 0.1);
      border-left-color: var(--warning);
    }
    .savings-suggestion.danger {
      background: rgba(220, 53, 69, 0.1);
      border-left-color: var(--danger);
    }

    .limit-card {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid var(--border-color);
    }

    .top-expense-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .progress {
      height: 8px;
      border-radius: 4px;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .trend-up {
      background: rgba(25, 135, 84, 0.1);
      color: var(--success);
    }
    .trend-down {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    .trend-neutral {
      background: rgba(108, 117, 125, 0.1);
      color: var(--secondary);
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .analysis-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="nav-buttons">
      <button id="backBtn" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left me-1"></i> Back
      </button>
      <button id="homeBtn" class="btn btn-outline-secondary">
        <i class="fa fa-home me-1"></i> Home
      </button>
      <button id="refreshBtn" class="btn btn-outline-success">
        <i class="fa fa-sync me-1"></i> Refresh Data
      </button>
    </div>
    
    <div class="app-card">
      <div class="tm-header">
        <h2><i class="fa fa-chart-pie"></i> Advanced Budget Analytics & Forecasting</h2>
        <div class="header-actions">
          <button id="themeToggle" class="btn btn-light btn-sm text-primary">
            <i class="fa fa-moon me-1"></i> Theme
          </button>
        </div>
      </div>

      <div class="content-body">
        <!-- Status Alert -->
        <div class="alert alert-info d-flex justify-content-between align-items-center">
          <div>
            <i class="fa fa-database me-2"></i>
            <span id="dataStatus">Connecting to Firebase...</span>
          </div>
          <span id="transactionCount" class="badge bg-primary">0 transactions</span>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
              <div class="stat-label">Total Income</div>
              <div id="totalIncome" class="stat-value text-success">$0.00</div>
              <div class="stat-subtext" id="incomeTrend">
                <span class="trend-indicator trend-neutral">
                  <i class="fa fa-minus"></i> Loading...
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
              <div class="stat-label">Total Expenses</div>
              <div id="totalExpenses" class="stat-value text-danger">$0.00</div>
              <div class="stat-subtext" id="expenseTrend">
                <span class="trend-indicator trend-neutral">
                  <i class="fa fa-minus"></i> Loading...
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
              <div class="stat-label">Net Savings</div>
              <div id="netSavings" class="stat-value text-info">$0.00</div>
              <div class="stat-subtext" id="savingsRate">Savings rate: 0%</div>
            </div>
          </div>
          <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
              <div class="stat-label">Avg Daily Spend</div>
              <div id="avgDailySpend" class="stat-value text-warning">$0.00</div>
              <div class="stat-subtext" id="spendTrend">
                <span class="trend-indicator trend-neutral">
                  <i class="fa fa-minus"></i> Loading...
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Charts -->
        <div class="row mb-4">
          <div class="col-lg-8 mb-4">
            <div class="app-card">
              <div class="content-body">
                <div class="section-title">
                  <i class="fa fa-chart-line"></i> Monthly Income vs Expenses
                </div>
                <div class="chart-container">
                  <canvas id="monthlyChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 mb-4">
            <div class="app-card">
              <div class="content-body">
                <div class="section-title">
                  <i class="fa fa-chart-pie"></i> Expense Distribution
                </div>
                <div class="chart-container">
                  <canvas id="categoryChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Grid -->
        <div class="analysis-grid">
          <!-- Top Expenses -->
          <div class="app-card">
            <div class="content-body">
              <div class="section-title">
                <i class="fa fa-arrow-up text-danger"></i> Top Expenses This Month
              </div>
              <div id="topExpensesList">
                <div class="text-center text-muted py-4">Loading expenses...</div>
              </div>
            </div>
          </div>

          <!-- Savings Suggestions -->
          <div class="app-card">
            <div class="content-body">
              <div class="section-title">
                <i class="fa fa-lightbulb text-warning"></i> Smart Savings Tips
              </div>
              <div id="savingsSuggestions">
                <div class="text-center text-muted py-4">Analyzing your data...</div>
              </div>
            </div>
          </div>

          <!-- Forecasting -->
          <div class="app-card">
            <div class="content-body">
              <div class="section-title">
                <i class="fa fa-crystal-ball text-purple"></i> Next Month Forecast
              </div>
              <div class="forecast-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <div>
                    <div style="font-size: 12px; opacity: 0.9;">Projected Savings</div>
                    <div id="forecastSavings" style="font-size: 24px; font-weight: 700;">$0.00</div>
                  </div>
                  <div id="forecastTrend" class="trend-indicator trend-neutral">
                    <i class="fa fa-minus"></i> Stable
                  </div>
                </div>
                <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                  <div id="forecastProgress" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
                <div class="row mt-3" style="font-size: 12px;">
                  <div class="col-6">
                    <div>Projected Income</div>
                    <div id="forecastIncome" style="font-weight: 600;">$0.00</div>
                  </div>
                  <div class="col-6 text-end">
                    <div>Projected Expenses</div>
                    <div id="forecastExpenses" style="font-weight: 600;">$0.00</div>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button id="runForecastBtn" class="btn btn-sm btn-outline-primary w-100">
                  <i class="fa fa-chart-line me-1"></i> Run Advanced Forecast
                </button>
              </div>
            </div>
          </div>

          <!-- Budget Limits -->
          <div class="app-card">
            <div class="content-body">
              <div class="section-title">
                <i class="fa fa-tachometer-alt text-info"></i> Set Budget Limits
              </div>
              <div class="mb-3">
                <label class="form-label">Monthly Limit for All Expenses</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" id="monthlyLimit" class="form-control" placeholder="e.g., 2000" min="0">
                  <button id="setLimitBtn" class="btn btn-primary">Set</button>
                </div>
              </div>
              <div id="limitProgress">
                <div class="progress-label d-flex justify-content-between mb-1">
                  <small>Limit Usage</small>
                  <small id="limitPercent">0%</small>
                </div>
                <div class="progress">
                  <div id="limitProgressBar" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="limitStatus">No limit set</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="app-card mt-4">
          <div class="content-body">
            <div class="section-title">
              <i class="fa fa-search"></i> Detailed Financial Analysis
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="text-center">
                  <div class="stat-label">Savings Rate</div>
                  <div id="savingsRateValue" class="stat-value">0%</div>
                  <div class="stat-subtext">of total income</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <div class="stat-label">Essential Spending</div>
                  <div id="essentialRatio" class="stat-value">0%</div>
                  <div class="stat-subtext">of total expenses</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <div class="stat-label">Financial Health</div>
                  <div id="financialHealth" class="stat-value">Good</div>
                  <div class="stat-subtext" id="healthIndicator">Based on your metrics</div>
                </div>
              </div>
            </div>
            
            <!-- Trend Analysis -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="section-title">
                  <i class="fa fa-chart-bar"></i> Spending Trends
                </div>
                <div class="chart-container">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Forecasting Modal -->
        <div class="modal fade" id="forecastModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="fa fa-crystal-ball me-2"></i> Advanced Forecasting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Forecast Period</label>
                      <select id="forecastPeriod" class="form-select">
                        <option value="30">Next 30 days</option>
                        <option value="90">Next 90 days</option>
                        <option value="180">Next 6 months</option>
                        <option value="365">Next 1 year</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Forecast Method</label>
                      <select id="forecastMethod" class="form-select">
                        <option value="average">Based on averages</option>
                        <option value="trend">Based on trends</option>
                        <option value="seasonal">Seasonal adjustment</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="chart-container">
                  <canvas id="forecastChart"></canvas>
                </div>
                
                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="stat-card">
                      <div class="stat-label">Projected Total Income</div>
                      <div id="detailedForecastIncome" class="stat-value text-success">$0.00</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="stat-card">
                      <div class="stat-label">Projected Total Expenses</div>
                      <div id="detailedForecastExpenses" class="stat-value text-danger">$0.00</div>
                    </div>
                  </div>
                </div>
                
                <div class="alert alert-info mt-3">
                  <i class="fa fa-info-circle me-2"></i>
                  Forecast is based on your historical spending patterns and trends.
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveForecastBtn">
                  <i class="fa fa-save me-1"></i> Save Forecast
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Loading data from Firebase...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, where, orderBy, 
      addDoc, doc, setDoc, getDoc, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Configuration (Same as your ledger)
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global Variables
    let currentUser = null;
    let transactions = [];
    let analysisData = {};
    let monthlyChart, categoryChart, trendChart, forecastChart;
    let monthlyLimit = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeEventListeners();
      loadThemePreference();
      
      // Check authentication
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          await initializeData();
        } else {
          window.location.href = "index.html";
        }
      });
    });

    // Initialize Event Listeners
    function initializeEventListeners() {
      backBtn.addEventListener('click', () => window.history.back());
      homeBtn.addEventListener('click', () => window.location.href = 'home.html');
      refreshBtn.addEventListener('click', () => refreshData());
      themeToggle.addEventListener('click', toggleTheme);
      setLimitBtn.addEventListener('click', setMonthlyLimit);
      runForecastBtn.addEventListener('click', showAdvancedForecast);
      saveForecastBtn.addEventListener('click', saveForecast);
    }

    // Initialize Data
    async function initializeData() {
      showLoading('Loading from Firebase...');
      
      try {
        // Load user's budget limit
        await loadBudgetLimit();
        
        // Set up real-time listener for transactions
        await setupTransactionsListener();
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        console.error('Error initializing:', error);
        Swal.fire({
          icon: 'error',
          title: 'Connection Error',
          text: 'Failed to load data from Firebase',
          footer: error.message
        });
      }
    }

    // Set up real-time transactions listener
    async function setupTransactionsListener() {
      if (!currentUser) return;
      
      const transactionsRef = collection(db, "users", currentUser.uid, "transactions");
      const q = query(transactionsRef, orderBy("DATE", "desc"));
      
      onSnapshot(q, (snapshot) => {
        transactions = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          transactions.push({
            id: doc.id,
            ...data
          });
        });
        
        // Update transaction count
        document.getElementById('transactionCount').textContent = `${transactions.length} transactions`;
        document.getElementById('dataStatus').textContent = `Live data: ${transactions.length} transactions loaded`;
        
        // Perform analysis
        performComprehensiveAnalysis();
        
      }, (error) => {
        console.error("Error listening to transactions:", error);
        document.getElementById('dataStatus').textContent = "Error loading data";
      });
    }

    // Load budget limit
    async function loadBudgetLimit() {
      if (!currentUser) return;
      
      try {
        const limitRef = doc(db, "users", currentUser.uid, "settings", "budgetLimit");
        const limitDoc = await getDoc(limitRef);
        
        if (limitDoc.exists()) {
          monthlyLimit = limitDoc.data().amount || 0;
          document.getElementById('monthlyLimit').value = monthlyLimit;
          updateLimitProgress();
        }
      } catch (error) {
        console.error("Error loading budget limit:", error);
      }
    }

    // Set monthly limit
    async function setMonthlyLimit() {
      const limit = parseFloat(document.getElementById('monthlyLimit').value);
      
      if (!limit || limit <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Limit',
          text: 'Please enter a valid monthly limit amount'
        });
        return;
      }
      
      if (!currentUser) return;
      
      showLoading('Saving budget limit...');
      
      try {
        const limitRef = doc(db, "users", currentUser.uid, "settings", "budgetLimit");
        await setDoc(limitRef, {
          amount: limit,
          updatedAt: new Date().toISOString()
        });
        
        monthlyLimit = limit;
        updateLimitProgress();
        
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: 'Limit Saved',
          text: `Monthly budget limit set to $${limit.toFixed(2)}`,
          timer: 2000
        });
        
      } catch (error) {
        hideLoading();
        Swal.fire({
          icon: 'error',
          title: 'Save Failed',
          text: error.message
        });
      }
    }

    // Update limit progress
    function updateLimitProgress() {
      if (!monthlyLimit || monthlyLimit <= 0) {
        document.getElementById('limitStatus').textContent = 'No limit set';
        document.getElementById('limitProgressBar').style.width = '0%';
        document.getElementById('limitPercent').textContent = '0%';
        return;
      }
      
      const currentMonthExpenses = calculateCurrentMonthExpenses();
      const percentage = (currentMonthExpenses / monthlyLimit) * 100;
      const percentText = `${percentage.toFixed(1)}%`;
      
      document.getElementById('limitProgressBar').style.width = `${Math.min(percentage, 100)}%`;
      document.getElementById('limitPercent').textContent = percentText;
      
      // Update progress bar color based on usage
      let status = '';
      let color = 'bg-success';
      
      if (percentage >= 100) {
        status = `Over limit by $${(currentMonthExpenses - monthlyLimit).toFixed(2)}`;
        color = 'bg-danger';
      } else if (percentage >= 80) {
        status = `Approaching limit (${percentText} used)`;
        color = 'bg-warning';
      } else {
        status = `$${currentMonthExpenses.toFixed(2)} of $${monthlyLimit.toFixed(2)} used`;
        color = 'bg-success';
      }
      
      document.getElementById('limitProgressBar').className = `progress-bar ${color}`;
      document.getElementById('limitStatus').textContent = status;
    }

    // Calculate current month expenses
    function calculateCurrentMonthExpenses() {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      return transactions
        .filter(t => {
          const transDate = t.DATE ? (t.DATE.toDate ? t.DATE.toDate() : new Date(t.DATE)) : null;
          return transDate && transDate >= startOfMonth && transDate <= endOfMonth;
        })
        .reduce((total, t) => total + (parseFloat(t.EXPENSE) || 0), 0);
    }

    // Perform comprehensive analysis
    function performComprehensiveAnalysis() {
      if (transactions.length === 0) {
        showNoDataState();
        return;
      }
      
      // Perform analysis
      analysisData = analyzeTransactions(transactions);
      
      // Update all UI components
      updateMetrics();
      updateCharts();
      updateTopExpenses();
      updateSavingsSuggestions();
      updateForecast();
      updateLimitProgress();
      updateDetailedAnalysis();
    }

    // Analyze transactions
    function analyzeTransactions(transactions) {
      const analysis = {
        income: 0,
        expenses: 0,
        categories: {},
        monthlyData: {},
        dailyData: {},
        topExpenses: [],
        essentialExpenses: 0,
        discretionaryExpenses: 0,
        startDate: null,
        endDate: null
      };
      
      // Process each transaction
      transactions.forEach(transaction => {
        const income = parseFloat(transaction.INCOME) || 0;
        const expense = parseFloat(transaction.EXPENSE) || 0;
        const type = (transaction.TYPE || '').toLowerCase();
        const description = (transaction.DESCRIPTION || '').toLowerCase();
        const date = transaction.DATE ? (transaction.DATE.toDate ? transaction.DATE.toDate() : new Date(transaction.DATE)) : new Date();
        
        // Track dates
        if (!analysis.startDate || date < analysis.startDate) analysis.startDate = date;
        if (!analysis.endDate || date > analysis.endDate) analysis.endDate = date;
        
        // Add to totals
        analysis.income += income;
        analysis.expenses += expense;
        
        // Process expenses
        if (expense > 0) {
          // Determine category
          let category = 'other';
          const searchText = description + ' ' + (transaction.ACCOUNT_HEADER || '').toLowerCase();
          
          if (searchText.includes('food') || searchText.includes('grocer') || searchText.includes('restaurant')) {
            category = 'food';
          } else if (searchText.includes('rent') || searchText.includes('mortgage') || searchText.includes('housing')) {
            category = 'housing';
          } else if (searchText.includes('utility') || searchText.includes('electric') || searchText.includes('water')) {
            category = 'utilities';
          } else if (searchText.includes('transport') || searchText.includes('gas') || searchText.includes('car')) {
            category = 'transportation';
          } else if (searchText.includes('medical') || searchText.includes('health') || searchText.includes('doctor')) {
            category = 'health';
          } else if (searchText.includes('entertain') || searchText.includes('movie') || searchText.includes('game')) {
            category = 'entertainment';
          } else if (searchText.includes('shop') || searchText.includes('clothes') || searchText.includes('store')) {
            category = 'shopping';
          }
          
          // Add to category totals
          analysis.categories[category] = (analysis.categories[category] || 0) + expense;
          
          // Categorize as essential or discretionary
          const essentialCategories = ['food', 'housing', 'utilities', 'transportation', 'health'];
          if (essentialCategories.includes(category)) {
            analysis.essentialExpenses += expense;
          } else {
            analysis.discretionaryExpenses += expense;
          }
          
          // Track top expenses
          analysis.topExpenses.push({
            description: transaction.DESCRIPTION || 'Unknown',
            amount: expense,
            category: category,
            date: date.toISOString().split('T')[0]
          });
          
          // Monthly data
          const monthKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
          if (!analysis.monthlyData[monthKey]) {
            analysis.monthlyData[monthKey] = { income: 0, expenses: 0 };
          }
          analysis.monthlyData[monthKey].expenses += expense;
          
          // Daily data for trend analysis
          const dayKey = date.toISOString().split('T')[0];
          analysis.dailyData[dayKey] = (analysis.dailyData[dayKey] || 0) + expense;
        }
        
        // Process income
        if (income > 0) {
          const monthKey = date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
          if (!analysis.monthlyData[monthKey]) {
            analysis.monthlyData[monthKey] = { income: 0, expenses: 0 };
          }
          analysis.monthlyData[monthKey].income += income;
        }
      });
      
      // Sort top expenses
      analysis.topExpenses.sort((a, b) => b.amount - a.amount);
      
      // Calculate derived metrics
      analysis.netSavings = analysis.income - analysis.expenses;
      analysis.savingsRate = analysis.income > 0 ? (analysis.netSavings / analysis.income) * 100 : 0;
      analysis.essentialRatio = analysis.expenses > 0 ? (analysis.essentialExpenses / analysis.expenses) * 100 : 0;
      
      // Calculate average daily spend
      const daysDiff = Math.ceil((analysis.endDate - analysis.startDate) / (1000 * 60 * 60 * 24)) || 1;
      analysis.avgDailySpend = analysis.expenses / daysDiff;
      
      // Calculate trend
      analysis.trend = calculateSpendingTrend(analysis.dailyData);
      
      return analysis;
    }

    // Calculate spending trend
    function calculateSpendingTrend(dailyData) {
      const dates = Object.keys(dailyData).sort();
      if (dates.length < 10) return 'stable';
      
      const firstHalf = dates.slice(0, Math.floor(dates.length / 2));
      const secondHalf = dates.slice(Math.floor(dates.length / 2));
      
      const firstHalfAvg = firstHalf.reduce((sum, date) => sum + dailyData[date], 0) / firstHalf.length;
      const secondHalfAvg = secondHalf.reduce((sum, date) => sum + dailyData[date], 0) / secondHalf.length;
      
      if (secondHalfAvg > firstHalfAvg * 1.1) return 'up';
      if (secondHalfAvg < firstHalfAvg * 0.9) return 'down';
      return 'stable';
    }

    // Update metrics
    function updateMetrics() {
      document.getElementById('totalIncome').textContent = `$${analysisData.income.toFixed(2)}`;
      document.getElementById('totalExpenses').textContent = `$${analysisData.expenses.toFixed(2)}`;
      document.getElementById('netSavings').textContent = `$${analysisData.netSavings.toFixed(2)}`;
      document.getElementById('avgDailySpend').textContent = `$${analysisData.avgDailySpend.toFixed(2)}`;
      
      // Update trends
      const trend = analysisData.trend || 'stable';
      const trendIcon = trend === 'up' ? 'fa-arrow-up' : trend === 'down' ? 'fa-arrow-down' : 'fa-minus';
      const trendClass = trend === 'up' ? 'trend-up' : trend === 'down' ? 'trend-down' : 'trend-neutral';
      const trendText = trend === 'up' ? 'Increasing' : trend === 'down' ? 'Decreasing' : 'Stable';
      
      document.getElementById('incomeTrend').innerHTML = 
        `<span class="trend-indicator ${trendClass}"><i class="fa ${trendIcon}"></i> ${trendText}</span>`;
      
      document.getElementById('expenseTrend').innerHTML = 
        `<span class="trend-indicator ${trendClass}"><i class="fa ${trendIcon}"></i> ${trendText}</span>`;
      
      document.getElementById('savingsRate').textContent = 
        `Savings rate: ${analysisData.savingsRate.toFixed(1)}%`;
    }

    // Update charts
    function updateCharts() {
      // Destroy existing charts
      if (monthlyChart) monthlyChart.destroy();
      if (categoryChart) categoryChart.destroy();
      if (trendChart) trendChart.destroy();
      
      // Create monthly chart
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      const monthlyLabels = Object.keys(analysisData.monthlyData).sort();
      const monthlyIncomeData = monthlyLabels.map(m => analysisData.monthlyData[m].income || 0);
      const monthlyExpenseData = monthlyLabels.map(m => analysisData.monthlyData[m].expenses || 0);
      
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthlyLabels.map(m => {
            const [year, month] = m.split('-');
            return new Date(year, month-1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
          }),
          datasets: [
            {
              label: 'Income',
              data: monthlyIncomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: 'rgb(25, 135, 84)',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: monthlyExpenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgb(220, 53, 69)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
              }
            }
          },
          scales: {
            x: {
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') }
            },
            y: {
              beginAtZero: true,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--muted'),
                callback: function(value) { return '$' + value; }
              }
            }
          }
        }
      });
      
      // Create category chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryEntries = Object.entries(analysisData.categories)
        .filter(([, value]) => value > 0)
        .sort(([,a], [,b]) => b - a);
      
      categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: categoryEntries.map(([name]) => name.charAt(0).toUpperCase() + name.slice(1)),
          datasets: [{
            data: categoryEntries.map(([,value]) => value),
            backgroundColor: [
              'rgb(220, 53, 69)',    // Red
              'rgb(255, 193, 7)',    // Yellow
              'rgb(25, 135, 84)',    // Green
              'rgb(13, 202, 240)',   // Cyan
              'rgb(111, 66, 193)',   // Purple
              'rgb(253, 126, 20)',   // Orange
              'rgb(32, 201, 151)'    // Teal
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
              }
            }
          }
        }
      });
      
      // Create trend chart
      const trendCtx = document.getElementById('trendChart').getContext('2d');
      const trendDates = Object.keys(analysisData.dailyData).sort();
      const trendData = trendDates.map(date => analysisData.dailyData[date]);
      
      trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: trendDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'Daily Spending',
            data: trendData,
            borderColor: 'rgb(220, 53, 69)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
              }
            }
          },
          scales: {
            x: {
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') }
            },
            y: {
              beginAtZero: true,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--muted'),
                callback: function(value) { return '$' + value; }
              }
            }
          }
        }
      });
    }

    // Update top expenses
    function updateTopExpenses() {
      const container = document.getElementById('topExpensesList');
      const topExpenses = analysisData.topExpenses.slice(0, 5);
      
      if (topExpenses.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No expenses found</div>';
        return;
      }
      
      let html = '';
      topExpenses.forEach(expense => {
        const date = new Date(expense.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        html += `
          <div class="top-expense-item">
            <div>
              <div style="font-weight: 600; font-size: 14px;">${escapeHtml(expense.description)}</div>
              <div style="font-size: 12px; color: var(--muted);">
                ${date} â€¢ ${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}
              </div>
            </div>
            <div style="font-weight: 700; color: var(--danger);">$${expense.amount.toFixed(2)}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Update savings suggestions
    function updateSavingsSuggestions() {
      const container = document.getElementById('savingsSuggestions');
      let suggestions = [];
      
      // Generate suggestions based on analysis
      if (analysisData.discretionaryExpenses > analysisData.essentialExpenses) {
        suggestions.push({
          title: 'Reduce Discretionary Spending',
          message: `You're spending more on non-essentials ($${analysisData.discretionaryExpenses.toFixed(2)}) than essentials ($${analysisData.essentialExpenses.toFixed(2)}).`,
          type: 'warning'
        });
      }
      
      if (analysisData.avgDailySpend > 50) {
        suggestions.push({
          title: 'High Daily Spending',
          message: `Your average daily spend is $${analysisData.avgDailySpend.toFixed(2)}. Try to reduce this to under $40.`,
          type: 'danger'
        });
      }
      
      if (analysisData.savingsRate < 20) {
        suggestions.push({
          title: 'Increase Savings Rate',
          message: `Your savings rate is ${analysisData.savingsRate.toFixed(1)}%. Aim for at least 20% for financial security.`,
          type: 'warning'
        });
      }
      
      // Positive suggestions
      if (analysisData.savingsRate >= 30) {
        suggestions.push({
          title: 'Great Savings Rate!',
          message: `Your savings rate of ${analysisData.savingsRate.toFixed(1)}% is excellent. Keep up the good work!`,
          type: 'success'
        });
      }
      
      if (analysisData.trend === 'down') {
        suggestions.push({
          title: 'Spending Improving',
          message: 'Your spending trend is decreasing. Great job managing your expenses!',
          type: 'success'
        });
      }
      
      // Default suggestion
      if (suggestions.length === 0) {
        suggestions.push({
          title: 'Track Your Spending',
          message: 'Continue tracking all expenses to identify savings opportunities.',
          type: 'info'
        });
      }
      
      // Display suggestions
      let html = '';
      suggestions.slice(0, 3).forEach(suggestion => {
        html += `
          <div class="savings-suggestion ${suggestion.type}">
            <h6 style="font-weight: 600; margin-bottom: 8px;">${suggestion.title}</h6>
            <p style="font-size: 13px; margin: 0;">${suggestion.message}</p>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Update forecast
    function updateForecast() {
      // Simple forecast based on last 30 days
      const last30DaysExpenses = calculateLast30DaysExpenses();
      const last30DaysIncome = calculateLast30DaysIncome();
      
      const forecastIncome = last30DaysIncome;
      const forecastExpenses = last30DaysExpenses;
      const forecastSavings = forecastIncome - forecastExpenses;
      const forecastSavingsRate = forecastIncome > 0 ? (forecastSavings / forecastIncome) * 100 : 0;
      
      // Update forecast display
      document.getElementById('forecastIncome').textContent = `$${forecastIncome.toFixed(2)}`;
      document.getElementById('forecastExpenses').textContent = `$${forecastExpenses.toFixed(2)}`;
      document.getElementById('forecastSavings').textContent = `$${forecastSavings.toFixed(2)}`;
      
      // Update progress bar
      const progress = Math.min(Math.max(forecastSavingsRate, 0), 100);
      document.getElementById('forecastProgress').style.width = `${progress}%`;
      
      // Update trend
      const currentSavingsRate = analysisData.savingsRate || 0;
      let forecastTrend = 'neutral';
      if (forecastSavingsRate > currentSavingsRate + 5) forecastTrend = 'up';
      if (forecastSavingsRate < currentSavingsRate - 5) forecastTrend = 'down';
      
      const trendIcon = forecastTrend === 'up' ? 'fa-arrow-up' : 
                       forecastTrend === 'down' ? 'fa-arrow-down' : 'fa-minus';
      const trendClass = forecastTrend === 'up' ? 'trend-up' : 
                        forecastTrend === 'down' ? 'trend-down' : 'trend-neutral';
      const trendText = forecastTrend === 'up' ? 'Improving' : 
                       forecastTrend === 'down' ? 'Declining' : 'Stable';
      
      document.getElementById('forecastTrend').className = `trend-indicator ${trendClass}`;
      document.getElementById('forecastTrend').innerHTML = 
        `<i class="fa ${trendIcon}"></i> ${trendText}`;
    }

    // Calculate last 30 days expenses
    function calculateLast30DaysExpenses() {
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
      
      return transactions
        .filter(t => {
          const transDate = t.DATE ? (t.DATE.toDate ? t.DATE.toDate() : new Date(t.DATE)) : null;
          return transDate && transDate >= thirtyDaysAgo && transDate <= now;
        })
        .reduce((total, t) => total + (parseFloat(t.EXPENSE) || 0), 0);
    }

    // Calculate last 30 days income
    function calculateLast30DaysIncome() {
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
      
      return transactions
        .filter(t => {
          const transDate = t.DATE ? (t.DATE.toDate ? t.DATE.toDate() : new Date(t.DATE)) : null;
          return transDate && transDate >= thirtyDaysAgo && transDate <= now;
        })
        .reduce((total, t) => total + (parseFloat(t.INCOME) || 0), 0);
    }

    // Update detailed analysis
    function updateDetailedAnalysis() {
      document.getElementById('savingsRateValue').textContent = `${analysisData.savingsRate.toFixed(1)}%`;
      document.getElementById('essentialRatio').textContent = `${analysisData.essentialRatio.toFixed(1)}%`;
      
      // Update financial health
      updateFinancialHealth();
    }

    // Update financial health
    function updateFinancialHealth() {
      let health = 'Good';
      let indicator = 'Maintaining good financial habits';
      let color = 'success';
      
      if (analysisData.savingsRate < 0) {
        health = 'Critical';
        indicator = 'Spending exceeds income - urgent action needed';
        color = 'danger';
      } else if (analysisData.savingsRate < 10) {
        health = 'Risky';
        indicator = 'Very low savings rate';
        color = 'warning';
      } else if (analysisData.savingsRate < 20) {
        health = 'Fair';
        indicator = 'Could improve savings rate';
        color = 'info';
      } else if (analysisData.savingsRate >= 30) {
        health = 'Excellent';
        indicator = 'Strong financial position';
        color = 'success';
      }
      
      document.getElementById('financialHealth').textContent = health;
      document.getElementById('financialHealth').className = `stat-value text-${color}`;
      document.getElementById('healthIndicator').textContent = indicator;
    }

    // Show advanced forecast
    function showAdvancedForecast() {
      const modal = new bootstrap.Modal(document.getElementById('forecastModal'));
      modal.show();
      
      // Generate advanced forecast
      generateAdvancedForecast();
    }

    // Generate advanced forecast
    function generateAdvancedForecast() {
      const period = parseInt(document.getElementById('forecastPeriod').value);
      const method = document.getElementById('forecastMethod').value;
      
      // Generate forecast data based on method
      let forecastData = [];
      let totalIncome = 0;
      let totalExpenses = 0;
      
      if (method === 'average') {
        // Based on averages
        const avgDailyIncome = analysisData.income > 0 ? analysisData.income / Object.keys(analysisData.dailyData).length : 0;
        const avgDailyExpense = analysisData.expenses > 0 ? analysisData.expenses / Object.keys(analysisData.dailyData).length : 0;
        
        totalIncome = avgDailyIncome * period;
        totalExpenses = avgDailyExpense * period;
        
        // Generate daily forecast data
        for (let i = 0; i < period; i++) {
          forecastData.push({
            day: i + 1,
            income: avgDailyIncome,
            expense: avgDailyExpense
          });
        }
      } else if (method === 'trend') {
        // Based on trend
        const trend = analysisData.trend;
        const avgDailyExpense = analysisData.avgDailySpend;
        
        let trendMultiplier = 1;
        if (trend === 'up') trendMultiplier = 1.1;
        if (trend === 'down') trendMultiplier = 0.9;
        
        totalExpenses = avgDailyExpense * period * trendMultiplier;
        totalIncome = analysisData.income > 0 ? analysisData.income / Object.keys(analysisData.monthlyData).length * (period / 30) : 0;
        
        // Generate trend-based forecast
        for (let i = 0; i < period; i++) {
          const dayMultiplier = 1 + (i * 0.01 * (trend === 'up' ? 1 : -1));
          forecastData.push({
            day: i + 1,
            income: totalIncome / period,
            expense: avgDailyExpense * dayMultiplier
          });
        }
      }
      
      // Update forecast display
      document.getElementById('detailedForecastIncome').textContent = `$${totalIncome.toFixed(2)}`;
      document.getElementById('detailedForecastExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
      
      // Update forecast chart
      updateForecastChart(forecastData);
    }

    // Update forecast chart
    function updateForecastChart(forecastData) {
      if (forecastChart) forecastChart.destroy();
      
      const forecastCtx = document.getElementById('forecastChart').getContext('2d');
      const labels = forecastData.map(d => `Day ${d.day}`);
      const incomeData = forecastData.map(d => d.income);
      const expenseData = forecastData.map(d => d.expense);
      
      forecastChart = new Chart(forecastCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Projected Income',
              data: incomeData,
              borderColor: 'rgb(25, 135, 84)',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Projected Expenses',
              data: expenseData,
              borderColor: 'rgb(220, 53, 69)',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
              }
            }
          },
          scales: {
            x: {
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') }
            },
            y: {
              beginAtZero: true,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--muted'),
                callback: function(value) { return '$' + value; }
              }
            }
          }
        }
      });
    }

    // Save forecast
    async function saveForecast() {
      if (!currentUser) return;
      
      try {
        const forecastRef = doc(db, "users", currentUser.uid, "forecasts", "latest");
        await setDoc(forecastRef, {
          income: document.getElementById('detailedForecastIncome').textContent,
          expenses: document.getElementById('detailedForecastExpenses').textContent,
          period: document.getElementById('forecastPeriod').value,
          method: document.getElementById('forecastMethod').value,
          savedAt: new Date().toISOString()
        });
        
        Swal.fire({
          icon: 'success',
          title: 'Forecast Saved',
          text: 'Your forecast has been saved',
          timer: 2000
        });
        
        bootstrap.Modal.getInstance(document.getElementById('forecastModal')).hide();
        
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Save Failed',
          text: error.message
        });
      }
    }

    // Refresh data
    function refreshData() {
      showLoading('Refreshing data...');
      
      // Force re-analysis
      performComprehensiveAnalysis();
      
      setTimeout(() => {
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: 'Data Refreshed',
          text: 'All analytics have been updated',
          timer: 1500
        });
      }, 1000);
    }

    // Show no data state
    function showNoDataState() {
      document.getElementById('totalIncome').textContent = '$0.00';
      document.getElementById('totalExpenses').textContent = '$0.00';
      document.getElementById('netSavings').textContent = '$0.00';
      document.getElementById('avgDailySpend').textContent = '$0.00';
      
      document.getElementById('topExpensesList').innerHTML = 
        '<div class="text-center text-muted py-4">No transactions found</div>';
      
      document.getElementById('savingsSuggestions').innerHTML = 
        '<div class="text-center text-muted py-4">Add transactions to get suggestions</div>';
    }

    // Helper functions
    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(message) {
      document.getElementById('loadingMessage').textContent = message;
      const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
      modal.show();
    }

    function hideLoading() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
      if (modal) modal.hide();
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update charts
      if (monthlyChart) monthlyChart.destroy();
      if (categoryChart) categoryChart.destroy();
      if (trendChart) trendChart.destroy();
      updateCharts();
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
    }
  </script>
</body>
</html>