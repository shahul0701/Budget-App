<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Budget & Financial Insights</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #6f42c1;
            --secondary-color: #6a3dd6;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-bg: #f4f6fb;
            --card-bg: #ffffff;
            --text-primary: #222;
            --border-color: #eaeef2;
        }

        [data-theme="dark"] {
            --primary-color: #8b66cc;
            --secondary-color: #7d5ddb;
            --light-bg: #1a1d28;
            --card-bg: #2a2d3a;
            --text-primary: #f0f2f5;
            --border-color: #3a3f50;
        }

        body {
            background: var(--light-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: rgba(111, 66, 193, 0.1);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 15px 20px;
            color: var(--primary-color);
        }

        .stats-card {
            text-align: center;
            padding: 20px 15px;
        }

        .stats-value {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stats-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress {
            height: 12px;
            margin: 15px 0;
            border-radius: 6px;
        }

        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .data-source-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--light-bg); display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div class="text-center">
            <div class="loading-spinner text-primary" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3">Loading Budget App...</h4>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <h2 class="text-center mb-4">Budget & Financial Insights</h2>
        <div class="mb-4">
            <h5>Connect to Firebase</h5>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="your@email.com" value="test@example.com">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Password" value="password123">
            </div>
            <button class="btn btn-primary w-100 mb-3" onclick="loginToFirebase()">
                <span id="loginSpinner" class="spinner-border spinner-border-sm me-2 d-none"></span>
                Connect to Firebase
            </button>
            
            <h5 class="mt-4">Or Use Demo Mode</h5>
            <p class="text-muted small mb-3">Try the app with sample data</p>
            <button class="btn btn-outline-primary w-100" onclick="useDemoData()">
                <i class="fas fa-play-circle me-2"></i>Launch Demo Mode
            </button>
        </div>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-chart-pie me-2"></i>Advanced Budget & Financial Insights</h1>
                    <p class="mb-0">Real-time budget tracking with individual account limits</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span id="dataSourceBadge" class="badge bg-info">
                        <i class="fas fa-database me-1"></i>
                        <span id="dataSourceText">Demo Data</span>
                    </span>
                    <button id="themeToggle" class="btn btn-light">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Period Selector -->
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <label class="form-label">Select Period</label>
                        <select id="periodSelect" class="form-select">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1" id="currentPeriodLabel">Current Month: August 2024</h5>
                                <p class="text-muted mb-0" id="periodDateRange">Aug 1 - Aug 31, 2024</p>
                            </div>
                            <button class="btn btn-primary" onclick="loadData()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mt-4">
            <div class="col-lg-3 col-md-6">
                <div class="card stats-card">
                    <div class="stats-label">Total Budget</div>
                    <div id="totalBudget" class="stats-value">$0.00</div>
                    <div class="progress">
                        <div id="budgetProgress" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="budgetUsage">0% used</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stats-card">
                    <div class="stats-label">Current Spending</div>
                    <div id="currentSpending" class="stats-value">$0.00</div>
                    <div class="stats-label" id="spendingPeriodLabel">This Period</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stats-card">
                    <div class="stats-label">Remaining Budget</div>
                    <div id="remainingBudget" class="stats-value">$0.00</div>
                    <div id="budgetStatus" class="mt-2">
                        <span class="badge bg-success">On Track</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stats-card">
                    <div class="stats-label">Transactions</div>
                    <div id="totalTransactions" class="stats-value">0</div>
                    <div class="stats-label">This period</div>
                </div>
            </div>
        </div>

        <!-- Charts and Data -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>Spending Trend
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="spendingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="fas fa-tags me-2"></i>Top Categories
                    </div>
                    <div class="card-body">
                        <div id="topCategoriesList">
                            <div class="text-center py-4">
                                <div class="loading-spinner text-primary mb-3"></div>
                                <p>Loading categories...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Limits Configuration -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-sliders-h me-2"></i>Account Limits Configuration
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Account/Category</label>
                            <input type="text" id="accountName" class="form-control" placeholder="e.g., Groceries, Entertainment">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Weekly Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="weeklyLimit" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Monthly Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="monthlyLimit" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Quarterly Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="quarterlyLimit" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Yearly Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="yearlyLimit" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="addAccountLimit()">
                        <i class="fas fa-plus me-2"></i>Add Account Limit
                    </button>
                    <button class="btn btn-success" onclick="saveAllLimits()">
                        <i class="fas fa-save me-2"></i>Save All Limits
                    </button>
                    <button class="btn btn-info" onclick="loadAccountLimits()">
                        <i class="fas fa-sync me-2"></i>Reload Limits
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Limits Display -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>Account Limits Overview
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Account/Category</th>
                                <th>Weekly Limit</th>
                                <th>Monthly Limit</th>
                                <th>Quarterly Limit</th>
                                <th>Yearly Limit</th>
                                <th>Current Usage</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountLimitsTable">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="loading-spinner text-primary"></div>
                                    <p class="mt-2">Loading account limits...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-history me-2"></i>Recent Transactions
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Bank</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="loading-spinner text-primary"></div>
                                    <p class="mt-2">Loading transactions...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Float Button -->
    <button id="themeToggleFloat" class="theme-toggle" style="display: none;">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let db = null;
        let auth = null;
        let currentUser = null;
        let isDemoMode = false;
        let allTransactions = [];
        let accountLimits = {};
        let currentPeriod = 'monthly';
        let spendingChart = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            
            // Initialize Firebase
            initializeFirebase();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load theme preference
            loadThemePreference();
            
            // Hide loading screen after a short delay
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
            }, 1000);
        });

        // Initialize Firebase
        function initializeFirebase() {
            try {
                // Your Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
                    authDomain: "budget-app-1365f.firebaseapp.com",
                    projectId: "budget-app-1365f",
                    storageBucket: "budget-app-1365f.appspot.com",
                    messagingSenderId: "1036194450411",
                    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
                    measurementId: "G-YFFJL2H54X"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                console.log('Firebase initialized successfully');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showAlert('Firebase initialization failed. Using demo mode.', 'warning');
            }
        }

        // Login to Firebase
        async function loginToFirebase() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginSpinner = document.getElementById('loginSpinner');
            
            if (!email || !password) {
                showAlert('Please enter email and password', 'error');
                return;
            }
            
            if (!auth) {
                showAlert('Firebase not initialized. Using demo mode.', 'warning');
                useDemoData();
                return;
            }
            
            loginSpinner.classList.remove('d-none');
            
            try {
                // Try to sign in
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                console.log('Login successful:', currentUser.email);
                
                // Switch to app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('themeToggleFloat').style.display = 'flex';
                document.getElementById('dataSourceText').textContent = 'Firebase Data';
                isDemoMode = false;
                
                // Load data
                await loadAllData();
                showAlert('Connected to Firebase successfully!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                
                // If user doesn't exist, try to create account
                if (error.code === 'auth/user-not-found') {
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        currentUser = userCredential.user;
                        console.log('New user created');
                        
                        // Switch to app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        document.getElementById('themeToggleFloat').style.display = 'flex';
                        document.getElementById('dataSourceText').textContent = 'Firebase Data';
                        isDemoMode = false;
                        
                        // Load data
                        await loadAllData();
                        showAlert('Account created successfully!', 'success');
                        
                    } catch (createError) {
                        console.error('Create user error:', createError);
                        showAlert('Error creating user: ' + createError.message, 'error');
                    }
                } else {
                    showAlert('Login error: ' + error.message, 'error');
                }
            } finally {
                loginSpinner.classList.add('d-none');
            }
        }

        // Use demo data
        function useDemoData() {
            isDemoMode = true;
            currentUser = null;
            
            // Switch to app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('themeToggleFloat').style.display = 'flex';
            document.getElementById('dataSourceText').textContent = 'Demo Data';
            
            // Load demo data
            loadDemoData();
            showAlert('Using demo data. Sign in to connect to your Firebase account.', 'info');
        }

        // Load all data
        async function loadAllData() {
            try {
                showLoadingState();
                
                // Load transactions
                await loadTransactions();
                
                // Load account limits
                await loadAccountLimits();
                
                // Update all displays
                updateAllDisplays();
                
                hideLoadingState();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data: ' + error.message, 'error');
                hideLoadingState();
            }
        }

        // Load transactions
        async function loadTransactions() {
            if (isDemoMode) {
                // Generate demo transactions
                allTransactions = generateDemoTransactions();
                console.log('Generated', allTransactions.length, 'demo transactions');
                return;
            }
            
            if (!currentUser || !db) {
                console.log('No user or Firebase, using demo data');
                allTransactions = generateDemoTransactions();
                isDemoMode = true;
                document.getElementById('dataSourceText').textContent = 'Demo Data';
                return;
            }
            
            try {
                console.log('Loading transactions from Firebase...');
                
                // Try to load from different collections
                const collections = ['transactions', 'budget-transactions', 'expenses'];
                let transactionsLoaded = false;
                
                for (const collectionName of collections) {
                    try {
                        const querySnapshot = await db.collection(collectionName)
                            .orderBy('DATE', 'desc')
                            .limit(100)
                            .get();
                        
                        if (!querySnapshot.empty) {
                            console.log(`Found ${querySnapshot.size} transactions in ${collectionName}`);
                            allTransactions = [];
                            
                            querySnapshot.forEach(doc => {
                                const data = doc.data();
                                const transaction = parseTransaction(data);
                                if (transaction) {
                                    allTransactions.push(transaction);
                                }
                            });
                            
                            transactionsLoaded = true;
                            break;
                        }
                    } catch (error) {
                        console.log(`No transactions in ${collectionName}:`, error.message);
                    }
                }
                
                if (!transactionsLoaded) {
                    console.log('No transactions found, using demo data');
                    allTransactions = generateDemoTransactions();
                    showAlert('No transactions found. Using demo data.', 'info');
                }
                
                console.log(`Loaded ${allTransactions.length} transactions`);
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                allTransactions = generateDemoTransactions();
                showAlert('Error loading transactions. Using demo data.', 'warning');
            }
        }

        // Parse transaction data
        function parseTransaction(data) {
            try {
                // Determine amount and type
                let amount = 0;
                let type = 'Expense';
                
                if (data.INCOME && data.INCOME > 0) {
                    amount = parseFloat(data.INCOME);
                    type = 'Income';
                } else if (data.EXPENSE && data.EXPENSE > 0) {
                    amount = parseFloat(data.EXPENSE);
                    type = 'Expense';
                } else if (data.AMOUNT) {
                    amount = parseFloat(data.AMOUNT);
                    type = data.TYPE || (amount >= 0 ? 'Income' : 'Expense');
                } else {
                    return null;
                }
                
                // Parse date
                let date = new Date();
                if (data.DATE && data.DATE.toDate) {
                    date = data.DATE.toDate();
                } else if (data.DATE) {
                    date = new Date(data.DATE);
                } else if (data.TIMESTAMP && data.TIMESTAMP.toDate) {
                    date = data.TIMESTAMP.toDate();
                }
                
                // Get category
                let category = data.ACCOUNT_HEADER || data.CATEGORY || data.ACCOUNT || 'Uncategorized';
                
                // Get description
                let description = data.DESCRIPTION || data.NOTES || data.NAME || 'No description';
                
                // Get bank
                let bank = data.BANK_NAME || data.BANK || data.MODE || 'Unknown';
                
                return {
                    id: data.id || Math.random().toString(36).substr(2, 9),
                    date: date,
                    description: description,
                    category: category,
                    type: type,
                    amount: Math.abs(amount),
                    bank: bank
                };
                
            } catch (error) {
                console.error('Error parsing transaction:', error, data);
                return null;
            }
        }

        // Generate demo transactions
        function generateDemoTransactions() {
            const transactions = [];
            const now = new Date();
            const categories = ['Groceries', 'Dining', 'Entertainment', 'Transport', 'Shopping', 'Utilities', 'Healthcare', 'Education'];
            const banks = ['Chase', 'Bank of America', 'Wells Fargo', 'Citibank', 'Capital One'];
            
            // Generate expenses for last 90 days
            for (let i = 0; i < 90; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // Add 1-2 expenses per day
                const numExpenses = Math.floor(Math.random() * 2) + 1;
                for (let j = 0; j < numExpenses; j++) {
                    const amount = Math.floor(Math.random() * 200) + 10;
                    const category = categories[Math.floor(Math.random() * categories.length)];
                    const bank = banks[Math.floor(Math.random() * banks.length)];
                    
                    transactions.push({
                        id: `demo-expense-${i}-${j}`,
                        date: new Date(date),
                        description: `${category} purchase`,
                        category: category,
                        type: 'Expense',
                        amount: amount,
                        bank: bank
                    });
                }
                
                // Add income occasionally
                if (i % 7 === 0) {
                    const amount = Math.floor(Math.random() * 1000) + 500;
                    const category = 'Salary';
                    const bank = banks[Math.floor(Math.random() * banks.length)];
                    
                    transactions.push({
                        id: `demo-income-${i}`,
                        date: new Date(date),
                        description: 'Monthly salary',
                        category: category,
                        type: 'Income',
                        amount: amount,
                        bank: bank
                    });
                }
            }
            
            return transactions;
        }

        // Load account limits
        async function loadAccountLimits() {
            if (isDemoMode) {
                // Load demo limits from localStorage
                const demoLimits = localStorage.getItem('demoAccountLimits');
                if (demoLimits) {
                    accountLimits = JSON.parse(demoLimits);
                } else {
                    // Create default demo limits
                    accountLimits = {
                        'Groceries': { weekly: 200, monthly: 800, quarterly: 2400, yearly: 9600 },
                        'Dining': { weekly: 100, monthly: 400, quarterly: 1200, yearly: 4800 },
                        'Entertainment': { weekly: 50, monthly: 200, quarterly: 600, yearly: 2400 },
                        'Transport': { weekly: 75, monthly: 300, quarterly: 900, yearly: 3600 },
                        'Utilities': { weekly: 0, monthly: 500, quarterly: 1500, yearly: 6000 }
                    };
                    localStorage.setItem('demoAccountLimits', JSON.stringify(accountLimits));
                }
                return;
            }
            
            if (!currentUser || !db) return;
            
            try {
                console.log('Loading account limits from Firebase...');
                
                // Try to load from user's accountLimits collection
                const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('accountLimits').get();
                
                if (!querySnapshot.empty) {
                    accountLimits = {};
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const accountName = data.accountName || data.account || data.category || doc.id;
                        accountLimits[accountName] = {
                            weekly: parseFloat(data.weekly) || 0,
                            monthly: parseFloat(data.monthly) || 0,
                            quarterly: parseFloat(data.quarterly) || 0,
                            yearly: parseFloat(data.yearly) || 0
                        };
                    });
                    console.log(`Loaded ${Object.keys(accountLimits).length} account limits`);
                } else {
                    console.log('No account limits found');
                    accountLimits = {};
                }
                
            } catch (error) {
                console.error('Error loading account limits:', error);
                accountLimits = {};
            }
        }

        // Save account limits
        async function saveAccountLimits() {
            if (isDemoMode) {
                // Save to localStorage
                localStorage.setItem('demoAccountLimits', JSON.stringify(accountLimits));
                showAlert('Account limits saved (demo mode)', 'success');
                return;
            }
            
            if (!currentUser || !db) {
                showAlert('Please sign in to save account limits', 'error');
                return;
            }
            
            try {
                // Save each account limit to Firebase
                for (const [accountName, limits] of Object.entries(accountLimits)) {
                    await db.collection('users').doc(currentUser.uid).collection('accountLimits').doc(accountName).set({
                        accountName: accountName,
                        weekly: limits.weekly,
                        monthly: limits.monthly,
                        quarterly: limits.quarterly,
                        yearly: limits.yearly,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showAlert('Account limits saved to Firebase', 'success');
                
            } catch (error) {
                console.error('Error saving account limits:', error);
                showAlert('Error saving account limits: ' + error.message, 'error');
            }
        }

        // Add account limit
        function addAccountLimit() {
            const accountName = document.getElementById('accountName').value.trim();
            const weekly = parseFloat(document.getElementById('weeklyLimit').value) || 0;
            const monthly = parseFloat(document.getElementById('monthlyLimit').value) || 0;
            const quarterly = parseFloat(document.getElementById('quarterlyLimit').value) || 0;
            const yearly = parseFloat(document.getElementById('yearlyLimit').value) || 0;
            
            if (!accountName) {
                showAlert('Please enter an account/category name', 'error');
                return;
            }
            
            // Add or update the limit
            accountLimits[accountName] = {
                weekly: weekly,
                monthly: monthly,
                quarterly: quarterly,
                yearly: yearly
            };
            
            // Clear form
            document.getElementById('accountName').value = '';
            document.getElementById('weeklyLimit').value = '0';
            document.getElementById('monthlyLimit').value = '0';
            document.getElementById('quarterlyLimit').value = '0';
            document.getElementById('yearlyLimit').value = '0';
            
            // Update display
            updateAccountLimitsTable();
            
            showAlert(`Added limit for ${accountName}`, 'success');
        }

        // Save all limits
        async function saveAllLimits() {
            await saveAccountLimits();
        }

        // Update account limits table
        function updateAccountLimitsTable() {
            const table = document.getElementById('accountLimitsTable');
            
            if (Object.keys(accountLimits).length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="fas fa-sliders-h fa-2x mb-3 text-muted"></i>
                            <p class="mb-0">No account limits configured</p>
                            <small class="text-muted">Add account limits above</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            Object.entries(accountLimits).forEach(([accountName, limits]) => {
                // Calculate current usage for this account
                const currentPeriodSpending = calculateAccountSpending(accountName, currentPeriod);
                const periodLimit = limits[currentPeriod] || 0;
                const usagePercentage = periodLimit > 0 ? (currentPeriodSpending / periodLimit * 100) : 0;
                
                // Determine status
                let statusBadge = 'bg-success';
                let statusText = 'Good';
                
                if (usagePercentage >= 100) {
                    statusBadge = 'bg-danger';
                    statusText = 'Exceeded';
                } else if (usagePercentage >= 80) {
                    statusBadge = 'bg-warning';
                    statusText = 'Warning';
                } else if (usagePercentage >= 50) {
                    statusBadge = 'bg-info';
                    statusText = 'Moderate';
                }
                
                html += `
                    <tr>
                        <td><strong>${accountName}</strong></td>
                        <td>$${limits.weekly.toFixed(2)}</td>
                        <td>$${limits.monthly.toFixed(2)}</td>
                        <td>$${limits.quarterly.toFixed(2)}</td>
                        <td>$${limits.yearly.toFixed(2)}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar ${statusBadge}" style="width: ${Math.min(usagePercentage, 100)}%"></div>
                                </div>
                                <small class="ms-2">${usagePercentage.toFixed(1)}%</small>
                            </div>
                            <small class="text-muted">$${currentPeriodSpending.toFixed(2)} / $${periodLimit.toFixed(2)}</small>
                        </td>
                        <td>
                            <span class="badge ${statusBadge}">${statusText}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAccountLimit('${accountName}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }

        // Delete account limit
        async function deleteAccountLimit(accountName) {
            if (confirm(`Are you sure you want to delete the limit for ${accountName}?`)) {
                delete accountLimits[accountName];
                
                if (!isDemoMode && currentUser && db) {
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('accountLimits').doc(accountName).delete();
                    } catch (error) {
                        console.error('Error deleting limit:', error);
                    }
                }
                
                updateAccountLimitsTable();
                showAlert(`Deleted limit for ${accountName}`, 'success');
            }
        }

        // Calculate account spending for period
        function calculateAccountSpending(accountName, period) {
            const filtered = filterTransactionsByPeriod(allTransactions, period);
            return filtered
                .filter(tx => tx.type === 'Expense' && tx.category === accountName)
                .reduce((total, tx) => total + tx.amount, 0);
        }

        // Filter transactions by period
        function filterTransactionsByPeriod(transactions, period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'weekly':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'quarterly':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'yearly':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                default:
                    return transactions;
            }
            
            return transactions.filter(tx => {
                const txDate = new Date(tx.date);
                return txDate >= startDate && txDate <= endDate;
            });
        }

        // Update all displays
        function updateAllDisplays() {
            updatePeriodDisplay();
            updateStats();
            updateSpendingChart();
            updateTopCategories();
            updateAccountLimitsTable();
            updateRecentTransactions();
        }

        // Update period display
        function updatePeriodDisplay() {
            const now = new Date();
            let periodLabel = '';
            let dateRange = '';
            
            switch (currentPeriod) {
                case 'weekly':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    periodLabel = `Week ${Math.ceil((now.getDate() + 6 - now.getDay()) / 7)}`;
                    dateRange = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
                    break;
                    
                case 'monthly':
                    const monthName = now.toLocaleDateString('en-US', { month: 'long' });
                    periodLabel = `${monthName} ${now.getFullYear()}`;
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    dateRange = `${formatDate(firstDay)} - ${formatDate(lastDay)}`;
                    break;
                    
                case 'quarterly':
                    const quarter = Math.floor(now.getMonth() / 3) + 1;
                    periodLabel = `Q${quarter} ${now.getFullYear()}`;
                    const quarterStart = new Date(now.getFullYear(), (quarter - 1) * 3, 1);
                    const quarterEnd = new Date(now.getFullYear(), quarter * 3, 0);
                    dateRange = `${formatDate(quarterStart)} - ${formatDate(quarterEnd)}`;
                    break;
                    
                case 'yearly':
                    periodLabel = `Year ${now.getFullYear()}`;
                    dateRange = `Jan 1 - Dec 31, ${now.getFullYear()}`;
                    break;
            }
            
            document.getElementById('currentPeriodLabel').textContent = periodLabel;
            document.getElementById('periodDateRange').textContent = dateRange;
            document.getElementById('spendingPeriodLabel').textContent = `This ${currentPeriod}`;
        }

        // Update stats
        function updateStats() {
            const filteredTransactions = filterTransactionsByPeriod(allTransactions, currentPeriod);
            const expenses = filteredTransactions.filter(tx => tx.type === 'Expense');
            
            // Calculate totals
            const totalExpenses = expenses.reduce((sum, tx) => sum + tx.amount, 0);
            
            // Calculate total budget (sum of all account limits for current period)
            const totalBudget = Object.values(accountLimits).reduce((sum, limits) => {
                return sum + (limits[currentPeriod] || 0);
            }, 0);
            
            // Calculate budget usage
            const budgetUsage = totalBudget > 0 ? (totalExpenses / totalBudget * 100) : 0;
            const remainingBudget = Math.max(0, totalBudget - totalExpenses);
            
            // Update display
            document.getElementById('totalBudget').textContent = `$${totalBudget.toFixed(2)}`;
            document.getElementById('currentSpending').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('remainingBudget').textContent = `$${remainingBudget.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = filteredTransactions.length;
            
            // Update progress bar
            const progressBar = document.getElementById('budgetProgress');
            progressBar.style.width = `${Math.min(budgetUsage, 100)}%`;
            
            // Update progress bar color
            if (budgetUsage >= 100) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (budgetUsage >= 80) {
                progressBar.className = 'progress-bar bg-warning';
            } else if (budgetUsage >= 50) {
                progressBar.className = 'progress-bar bg-info';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
            
            // Update budget usage text
            document.getElementById('budgetUsage').textContent = `${budgetUsage.toFixed(1)}% used`;
            
            // Update status badge
            const statusElement = document.getElementById('budgetStatus');
            let statusBadge = '';
            let statusText = '';
            
            if (budgetUsage >= 100) {
                statusBadge = 'bg-danger';
                statusText = 'Exceeded';
            } else if (budgetUsage >= 80) {
                statusBadge = 'bg-warning';
                statusText = 'Warning';
            } else if (budgetUsage >= 50) {
                statusBadge = 'bg-info';
                statusText = 'Moderate';
            } else {
                statusBadge = 'bg-success';
                statusText = 'On Track';
            }
            
            statusElement.innerHTML = `<span class="badge ${statusBadge}">${statusText}</span>`;
        }

        // Update spending chart
        function updateSpendingChart() {
            const ctx = document.getElementById('spendingChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (spendingChart) {
                spendingChart.destroy();
            }
            
            // Prepare data for last 30 days
            const days = 30;
            const dailyData = [];
            const labels = [];
            const today = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                labels.push(dateStr);
                
                // Calculate total spending for this day
                const daySpending = allTransactions
                    .filter(tx => {
                        const txDate = new Date(tx.date);
                        return txDate.getDate() === date.getDate() &&
                               txDate.getMonth() === date.getMonth() &&
                               txDate.getFullYear() === date.getFullYear() &&
                               tx.type === 'Expense';
                    })
                    .reduce((sum, tx) => sum + tx.amount, 0);
                
                dailyData.push(daySpending);
            }
            
            // Create chart
            spendingChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: dailyData,
                        borderColor: 'rgba(220, 53, 69, 1)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: (value) => `$${value}`
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Update top categories
        function updateTopCategories() {
            const container = document.getElementById('topCategoriesList');
            const filteredTransactions = filterTransactionsByPeriod(allTransactions, currentPeriod);
            const expenses = filteredTransactions.filter(tx => tx.type === 'Expense');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-tags fa-2x mb-3 text-muted"></i>
                        <p class="mb-0">No expenses this period</p>
                    </div>
                `;
                return;
            }
            
            // Group by category
            const categoryTotals = {};
            expenses.forEach(tx => {
                const category = tx.category || 'Uncategorized';
                categoryTotals[category] = (categoryTotals[category] || 0) + tx.amount;
            });
            
            // Sort by amount (descending)
            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            sortedCategories.forEach(([category, amount], index) => {
                // Get the account limit for this category
                const limit = accountLimits[category] ? accountLimits[category][currentPeriod] || 0 : 0;
                const usagePercentage = limit > 0 ? (amount / limit * 100) : 0;
                
                let progressColor = 'bg-success';
                if (usagePercentage >= 100) progressColor = 'bg-danger';
                else if (usagePercentage >= 80) progressColor = 'bg-warning';
                else if (usagePercentage >= 50) progressColor = 'bg-info';
                
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span><strong>${index + 1}.</strong> ${category}</span>
                            <span>$${amount.toFixed(2)}</span>
                        </div>
                        ${limit > 0 ? `
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar ${progressColor}" style="width: ${Math.min(usagePercentage, 100)}%"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span>${usagePercentage.toFixed(1)}% of limit</span>
                                <span>Limit: $${limit.toFixed(2)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update recent transactions
        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            const filteredTransactions = filterTransactionsByPeriod(allTransactions, currentPeriod)
                .slice(0, 10); // Show only last 10
            
            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-receipt fa-2x mb-3 text-muted"></i>
                            <p class="mb-0">No transactions this period</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredTransactions.forEach(tx => {
                const date = new Date(tx.date).toLocaleDateString();
                const typeClass = tx.type === 'Income' ? 'text-success' : 'text-danger';
                const typeIcon = tx.type === 'Income' ? 'fa-arrow-down' : 'fa-arrow-up';
                const typeSign = tx.type === 'Income' ? '+' : '-';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${tx.description}</td>
                        <td>
                            <span class="badge bg-light text-dark">${tx.category}</span>
                        </td>
                        <td>
                            <span class="${typeClass}">
                                <i class="fas ${typeIcon} me-1"></i>${tx.type}
                            </span>
                        </td>
                        <td class="${typeClass}">
                            ${typeSign}$${tx.amount.toFixed(2)}
                        </td>
                        <td>
                            <small class="text-muted">${tx.bank}</small>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        // Load data
        async function loadData() {
            await loadAllData();
            showAlert('Data refreshed', 'success');
        }

        // Load demo data
        function loadDemoData() {
            allTransactions = generateDemoTransactions();
            updateAllDisplays();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Period select change
            document.getElementById('periodSelect').addEventListener('change', function() {
                currentPeriod = this.value;
                updateAllDisplays();
            });
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('themeToggleFloat').addEventListener('click', toggleTheme);
            
            // Enter key in account name input
            document.getElementById('accountName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addAccountLimit();
                }
            });
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('budgetTheme', newTheme);
            
            const icon = newTheme === 'light' ? 'fa-moon' : 'fa-sun';
            document.getElementById('themeToggle').innerHTML = `<i class="fas ${icon}"></i>`;
            document.getElementById('themeToggleFloat').innerHTML = `<i class="fas ${icon}"></i>`;
        }

        // Load theme preference
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('budgetTheme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const icon = savedTheme === 'light' ? 'fa-moon' : 'fa-sun';
            document.getElementById('themeToggle').innerHTML = `<i class="fas ${icon}"></i>`;
            document.getElementById('themeToggleFloat').innerHTML = `<i class="fas ${icon}"></i>`;
        }

        // Show loading state
        function showLoadingState() {
            // You can add a loading overlay if needed
            console.log('Loading...');
        }

        // Hide loading state
        function hideLoadingState() {
            console.log('Loading complete');
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Show alert
        function showAlert(message, type = 'info') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: message,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    </script>
</body>
</html>