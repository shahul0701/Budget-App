<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget & Forecasting Dashboard</title>
  
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Date Range Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment/moment.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global variables
    let allTransactions = [];
    let allBudgets = [];
    let allAccounts = [];
    let forecasts = {};
    let userUID = null;

    // DOM elements
    const logoutBtn = document.getElementById("logoutBtn");
    const userDisplay = document.getElementById("userDisplay");
    const loadingStatus = document.getElementById("loadingStatus");

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize date range picker
      $('#dateRange').daterangepicker({
        opens: 'left',
        startDate: moment().startOf('month'),
        endDate: moment().endOf('month'),
        ranges: {
          'Today': [moment(), moment()],
          'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
          'This Quarter': [moment().startOf('quarter'), moment().endOf('quarter')],
          'This Year': [moment().startOf('year'), moment().endOf('year')]
        }
      });

      // Set default budget period to current month
      const currentMonth = moment().format('YYYY-MM');
      document.getElementById('budgetPeriod').value = currentMonth;
      
      // Generate forecast for next 12 months by default
      generateForecast();
    });

    // Authentication
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Main initialization
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      userUID = user.uid;
      userDisplay.textContent = user.displayName || user.email || "User";
      loadingStatus.textContent = "Loading Budget Data...";

      try {
        // Load all transactions
        const txSnap = await getDocs(collection(db, "users", user.uid, "transactions"));
        allTransactions = txSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Load budgets
        await loadBudgets(user.uid);
        
        // Extract unique accounts
        allAccounts = [...new Set(allTransactions.map(tx => tx.ACCOUNT_HEADER || "Uncategorized").filter(Boolean))];
        
        // Initialize dashboard
        initializeDashboard();
        
        loadingStatus.textContent = `Loaded ${allTransactions.length} transactions and ${allBudgets.length} budgets`;
      } catch (error) {
        loadingStatus.textContent = `Error loading data: ${error.message}`;
        console.error("Error:", error);
      }
    });

    // Load budgets from Firestore
    async function loadBudgets(uid) {
      try {
        const budgetsSnap = await getDocs(collection(db, "users", uid, "budgets"));
        allBudgets = budgetsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log(`Loaded ${allBudgets.length} budgets`);
      } catch (error) {
        console.error("Error loading budgets:", error);
        allBudgets = [];
      }
    }

    // Save budget to Firestore
    async function saveBudget(budgetData) {
      try {
        const budgetId = budgetData.id || `budget_${Date.now()}`;
        const budgetRef = doc(db, "users", userUID, "budgets", budgetId);
        await setDoc(budgetRef, { ...budgetData, id: budgetId, lastUpdated: new Date().toISOString() });
        
        // Reload budgets
        await loadBudgets(userUID);
        return true;
      } catch (error) {
        console.error("Error saving budget:", error);
        return false;
      }
    }

    // Delete budget
    async function deleteBudget(budgetId) {
      try {
        const budgetRef = doc(db, "users", userUID, "budgets", budgetId);
        await deleteDoc(budgetRef);
        await loadBudgets(userUID);
        return true;
      } catch (error) {
        console.error("Error deleting budget:", error);
        return false;
      }
    }

    // Initialize dashboard
    function initializeDashboard() {
      updateDashboard();
      populateAccountDropdowns();
      renderBudgetTable();
      updateForecastChart();
      updateVarianceAnalysis();
    }

    // Update dashboard with current data
    function updateDashboard() {
      // Get current date range
      const dateRange = document.getElementById('dateRange').value;
      const [startDate, endDate] = dateRange.split(' - ').map(d => moment(d, 'MM/DD/YYYY'));
      
      // Filter transactions
      const filteredTx = allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = moment(tx.DATE);
        return txDate.isBetween(startDate, endDate, null, '[]');
      });
      
      // Calculate summary
      const summary = calculateFinancialSummary(filteredTx);
      
      // Update stats
      updateDashboardStats(summary);
      
      // Update charts
      updateBudgetVsActualChart(summary);
      updateSpendingByCategoryChart(filteredTx);
      
      // Update budget progress
      updateBudgetProgress();
    }

    // Calculate financial summary
    function calculateFinancialSummary(transactions) {
      const summary = {
        income: 0,
        expense: 0,
        net: 0,
        byAccount: {},
        byCategory: {}
      };
      
      transactions.forEach(tx => {
        const account = tx.ACCOUNT_HEADER || "Uncategorized";
        const amount = Number(tx.INCOME || 0) - Number(tx.EXPENSE || 0);
        
        // Update account summary
        if (!summary.byAccount[account]) {
          summary.byAccount[account] = { income: 0, expense: 0, net: 0 };
        }
        
        summary.byAccount[account].income += Number(tx.INCOME || 0);
        summary.byAccount[account].expense += Number(tx.EXPENSE || 0);
        summary.byAccount[account].net += amount;
        
        // Update totals
        summary.income += Number(tx.INCOME || 0);
        summary.expense += Number(tx.EXPENSE || 0);
        summary.net += amount;
      });
      
      return summary;
    }

    // Update dashboard statistics
    function updateDashboardStats(summary) {
      document.getElementById('totalIncome').textContent = formatCurrency(summary.income);
      document.getElementById('totalExpense').textContent = formatCurrency(summary.expense);
      document.getElementById('netBalance').textContent = formatCurrency(summary.net);
      document.getElementById('savingsRate').textContent = summary.income > 0 ? 
        ((summary.net / summary.income) * 100).toFixed(1) + '%' : '0%';
      
      // Update color for net balance
      const netElem = document.getElementById('netBalance');
      netElem.style.color = summary.net >= 0 ? '#2ecc71' : '#e74c3c';
    }

    // Update Budget vs Actual chart
    function updateBudgetVsActualChart(summary) {
      const ctx = document.getElementById('budgetVsActualChart').getContext('2d');
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      
      // Get budgets for current period
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const totalBudgeted = periodBudgets.reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      if (window.budgetVsActualChart) {
        window.budgetVsActualChart.destroy();
      }
      
      window.budgetVsActualChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses', 'Net'],
          datasets: [
            {
              label: 'Budgeted',
              data: [totalBudgeted, totalBudgeted, 0],
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Actual',
              data: [summary.income, summary.expense, summary.net],
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Amount ($)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Budget vs Actual'
            }
          }
        }
      });
    }

    // Update spending by category chart
    function updateSpendingByCategoryChart(transactions) {
      const ctx = document.getElementById('spendingByCategoryChart').getContext('2d');
      
      // Group by category/account
      const categoryData = {};
      transactions.forEach(tx => {
        if (tx.EXPENSE > 0) {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          categoryData[category] = (categoryData[category] || 0) + Number(tx.EXPENSE);
        }
      });
      
      const labels = Object.keys(categoryData);
      const data = Object.values(categoryData);
      
      // Generate colors
      const colors = labels.map((_, i) => {
        const hue = (i * 137.508) % 360;
        return `hsl(${hue}, 70%, 60%)`;
      });
      
      if (window.spendingByCategoryChart) {
        window.spendingByCategoryChart.destroy();
      }
      
      window.spendingByCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
            },
            title: {
              display: true,
              text: 'Spending by Category'
            }
          }
        }
      });
    }

    // Populate account dropdowns
    function populateAccountDropdowns() {
      const accountSelects = document.querySelectorAll('.account-select');
      accountSelects.forEach(select => {
        // Clear existing options except the first
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // Add account options
        allAccounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account;
          option.textContent = account;
          select.appendChild(option);
        });
      });
    }

    // Render budget table
    function renderBudgetTable() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const tbody = document.getElementById('budgetTableBody');
      
      if (periodBudgets.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">No budgets set for ${budgetPeriod}</td></tr>`;
        return;
      }
      
      let html = '';
      periodBudgets.forEach((budget, index) => {
        // Calculate actual spending for this budget
        const actual = calculateActualForBudget(budget);
        const variance = budget.amount - actual;
        const variancePercent = budget.amount > 0 ? (variance / budget.amount * 100).toFixed(1) : 0;
        
        html += `
          <tr>
            <td>${index + 1}</td>
            <td>${budget.account}</td>
            <td>${budget.type}</td>
            <td>${budget.frequency}</td>
            <td class="text-right">${formatCurrency(budget.amount)}</td>
            <td class="text-right">${formatCurrency(actual)}</td>
            <td class="text-right ${variance >= 0 ? 'text-success' : 'text-danger'}">
              ${formatCurrency(variance)} (${variancePercent}%)
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary edit-budget" data-id="${budget.id}">
                <i class="material-icons">edit</i>
              </button>
              <button class="btn btn-sm btn-outline-danger delete-budget" data-id="${budget.id}">
                <i class="material-icons">delete</i>
              </button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
      
      // Add event listeners for edit/delete buttons
      document.querySelectorAll('.edit-budget').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const budgetId = e.currentTarget.getAttribute('data-id');
          editBudget(budgetId);
        });
      });
      
      document.querySelectorAll('.delete-budget').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const budgetId = e.currentTarget.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this budget?')) {
            await deleteBudget(budgetId);
            renderBudgetTable();
            updateDashboard();
          }
        });
      });
    }

    // Calculate actual spending for a budget
    function calculateActualForBudget(budget) {
      const budgetPeriod = budget.period;
      const [year, month] = budgetPeriod.split('-').map(Number);
      
      // Filter transactions for this budget period and account
      const filteredTx = allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = new Date(tx.DATE);
        return txDate.getFullYear() === year && 
               txDate.getMonth() + 1 === month &&
               tx.ACCOUNT_HEADER === budget.account;
      });
      
      // Calculate total based on budget type
      if (budget.type === 'Income') {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.INCOME || 0), 0);
      } else {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.EXPENSE || 0), 0);
      }
    }

    // Update budget progress
    function updateBudgetProgress() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      let totalBudgeted = 0;
      let totalActual = 0;
      
      periodBudgets.forEach(budget => {
        totalBudgeted += Number(budget.amount || 0);
        totalActual += calculateActualForBudget(budget);
      });
      
      const progressPercent = totalBudgeted > 0 ? Math.min(100, (totalActual / totalBudgeted) * 100) : 0;
      const progressBar = document.getElementById('budgetProgressBar');
      progressBar.style.width = `${progressPercent}%`;
      progressBar.textContent = `${progressPercent.toFixed(1)}%`;
      
      document.getElementById('budgetProgressText').textContent = 
        `${formatCurrency(totalActual)} of ${formatCurrency(totalBudgeted)}`;
    }

    // Generate forecast
    function generateForecast() {
      const forecastType = document.getElementById('forecastType').value;
      const forecastPeriods = parseInt(document.getElementById('forecastPeriods').value);
      const forecastMethod = document.getElementById('forecastMethod').value;
      
      // Calculate forecast based on historical data
      forecasts = calculateForecast(forecastType, forecastPeriods, forecastMethod);
      
      // Update forecast chart
      updateForecastChart();
    }

    // Calculate forecast
    function calculateForecast(type, periods, method) {
      const forecastData = {
        labels: [],
        data: []
      };
      
      // Get historical data based on type
      const historicalData = getHistoricalData(type);
      
      // Generate forecast labels
      const startDate = moment();
      for (let i = 0; i < periods; i++) {
        let label;
        if (type === 'monthly') {
          label = startDate.clone().add(i, 'months').format('MMM YYYY');
        } else if (type === 'weekly') {
          label = `Week ${i + 1}`;
        } else if (type === 'quarterly') {
          label = `Q${Math.floor(i / 3) + 1} ${startDate.clone().add(i * 3, 'months').format('YYYY')}`;
        } else {
          label = `${startDate.clone().add(i, 'years').format('YYYY')}`;
        }
        forecastData.labels.push(label);
      }
      
      // Simple forecasting methods
      if (method === 'average') {
        const avg = historicalData.length > 0 ? 
          historicalData.reduce((a, b) => a + b, 0) / historicalData.length : 0;
        forecastData.data = Array(periods).fill(avg);
      } else if (method === 'trend') {
        // Simple linear trend
        if (historicalData.length > 1) {
          const lastValue = historicalData[historicalData.length - 1];
          const growthRate = 0.05; // 5% growth assumption
          forecastData.data = Array(periods).fill(0).map((_, i) => 
            lastValue * Math.pow(1 + growthRate, i + 1)
          );
        } else {
          forecastData.data = Array(periods).fill(0);
        }
      } else if (method === 'last') {
        const lastValue = historicalData.length > 0 ? historicalData[historicalData.length - 1] : 0;
        forecastData.data = Array(periods).fill(lastValue);
      }
      
      return forecastData;
    }

    // Get historical data for forecasting
    function getHistoricalData(type) {
      const data = [];
      const now = moment();
      
      // Get last 12 periods of data
      for (let i = 11; i >= 0; i--) {
        let periodStart, periodEnd;
        
        if (type === 'monthly') {
          periodStart = now.clone().subtract(i, 'months').startOf('month');
          periodEnd = now.clone().subtract(i, 'months').endOf('month');
        } else if (type === 'weekly') {
          periodStart = now.clone().subtract(i, 'weeks').startOf('week');
          periodEnd = now.clone().subtract(i, 'weeks').endOf('week');
        } else if (type === 'quarterly') {
          periodStart = now.clone().subtract(i * 3, 'months').startOf('quarter');
          periodEnd = now.clone().subtract(i * 3, 'months').endOf('quarter');
        } else {
          periodStart = now.clone().subtract(i, 'years').startOf('year');
          periodEnd = now.clone().subtract(i, 'years').endOf('year');
        }
        
        // Calculate total for period
        const periodTotal = allTransactions
          .filter(tx => {
            if (!tx.DATE) return false;
            const txDate = moment(tx.DATE);
            return txDate.isBetween(periodStart, periodEnd, null, '[]');
          })
          .reduce((sum, tx) => sum + Number(tx.INCOME || 0) - Number(tx.EXPENSE || 0), 0);
        
        data.push(periodTotal);
      }
      
      return data;
    }

    // Update forecast chart
    function updateForecastChart() {
      const ctx = document.getElementById('forecastChart').getContext('2d');
      
      if (window.forecastChart) {
        window.forecastChart.destroy();
      }
      
      window.forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: forecasts.labels || [],
          datasets: [{
            label: 'Forecast',
            data: forecasts.data || [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Financial Forecast'
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: 'Amount ($)'
              }
            }
          }
        }
      });
    }

    // Update variance analysis
    function updateVarianceAnalysis() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      let totalVariance = 0;
      let overBudgetCount = 0;
      let underBudgetCount = 0;
      
      periodBudgets.forEach(budget => {
        const actual = calculateActualForBudget(budget);
        const variance = budget.amount - actual;
        
        if (variance < 0) {
          overBudgetCount++;
        } else if (variance > 0) {
          underBudgetCount++;
        }
        
        totalVariance += variance;
      });
      
      document.getElementById('varianceTotal').textContent = formatCurrency(totalVariance);
      document.getElementById('overBudgetCount').textContent = overBudgetCount;
      document.getElementById('underBudgetCount').textContent = underBudgetCount;
      document.getElementById('onBudgetCount').textContent = periodBudgets.length - overBudgetCount - underBudgetCount;
      
      // Update color for total variance
      const varianceElem = document.getElementById('varianceTotal');
      varianceElem.style.color = totalVariance >= 0 ? '#2ecc71' : '#e74c3c';
    }

    // Add new budget
    async function addNewBudget() {
      const account = document.getElementById('newBudgetAccount').value;
      const type = document.getElementById('newBudgetType').value;
      const amount = parseFloat(document.getElementById('newBudgetAmount').value);
      const frequency = document.getElementById('newBudgetFrequency').value;
      const period = document.getElementById('budgetPeriod').value;
      
      if (!account || !amount || isNaN(amount)) {
        alert('Please fill in all required fields');
        return;
      }
      
      const budgetData = {
        account,
        type,
        amount,
        frequency,
        period,
        created: new Date().toISOString()
      };
      
      const success = await saveBudget(budgetData);
      if (success) {
        // Clear form
        document.getElementById('newBudgetAmount').value = '';
        
        // Update UI
        renderBudgetTable();
        updateDashboard();
        updateVarianceAnalysis();
        
        alert('Budget added successfully!');
      } else {
        alert('Error saving budget. Please try again.');
      }
    }

    // Edit budget
    function editBudget(budgetId) {
      const budget = allBudgets.find(b => b.id === budgetId);
      if (!budget) return;
      
      // Populate edit form (simplified - in a real app you'd have a proper modal)
      document.getElementById('newBudgetAccount').value = budget.account;
      document.getElementById('newBudgetType').value = budget.type;
      document.getElementById('newBudgetAmount').value = budget.amount;
      document.getElementById('newBudgetFrequency').value = budget.frequency;
      
      // Scroll to form
      document.getElementById('budgetForm').scrollIntoView({ behavior: 'smooth' });
      
      // Change button text
      const addBtn = document.getElementById('addBudgetBtn');
      addBtn.textContent = 'Update Budget';
      addBtn.onclick = async () => {
        await updateExistingBudget(budgetId);
      };
    }

    // Update existing budget
    async function updateExistingBudget(budgetId) {
      const account = document.getElementById('newBudgetAccount').value;
      const type = document.getElementById('newBudgetType').value;
      const amount = parseFloat(document.getElementById('newBudgetAmount').value);
      const frequency = document.getElementById('newBudgetFrequency').value;
      const period = document.getElementById('budgetPeriod').value;
      
      if (!account || !amount || isNaN(amount)) {
        alert('Please fill in all required fields');
        return;
      }
      
      const budgetData = {
        id: budgetId,
        account,
        type,
        amount,
        frequency,
        period,
        lastUpdated: new Date().toISOString()
      };
      
      const success = await saveBudget(budgetData);
      if (success) {
        // Reset form
        document.getElementById('newBudgetAmount').value = '';
        document.getElementById('addBudgetBtn').textContent = 'Add Budget';
        document.getElementById('addBudgetBtn').onclick = addNewBudget;
        
        // Update UI
        renderBudgetTable();
        updateDashboard();
        updateVarianceAnalysis();
        
        alert('Budget updated successfully!');
      } else {
        alert('Error updating budget. Please try again.');
      }
    }

    // Export budgets to CSV
    function exportBudgets() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      if (periodBudgets.length === 0) {
        alert('No budgets to export for this period');
        return;
      }
      
      // Create CSV content
      let csv = 'Account,Type,Frequency,Amount,Period\n';
      periodBudgets.forEach(budget => {
        csv += `"${budget.account}",${budget.type},${budget.frequency},${budget.amount},${budget.period}\n`;
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `budgets_${budgetPeriod}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Import budgets from CSV (simplified)
    function importBudgets() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv';
      
      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          const csv = event.target.result;
          const lines = csv.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          
          let importedCount = 0;
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            if (values.length < headers.length) continue;
            
            const budgetData = {};
            headers.forEach((header, index) => {
              budgetData[header.toLowerCase()] = values[index];
            });
            
            // Convert amount to number
            budgetData.amount = parseFloat(budgetData.amount) || 0;
            
            // Add current period if not specified
            if (!budgetData.period) {
              budgetData.period = document.getElementById('budgetPeriod').value;
            }
            
            await saveBudget(budgetData);
            importedCount++;
          }
          
          // Reload budgets
          await loadBudgets(userUID);
          renderBudgetTable();
          updateDashboard();
          
          alert(`Successfully imported ${importedCount} budgets`);
        };
        
        reader.readAsText(file);
      };
      
      fileInput.click();
    }

    // Utility function to format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
      }).format(amount);
    }

    // Event Listeners
    document.getElementById('addBudgetBtn').addEventListener('click', addNewBudget);
    document.getElementById('exportBudgetsBtn').addEventListener('click', exportBudgets);
    document.getElementById('importBudgetsBtn').addEventListener('click', importBudgets);
    document.getElementById('generateForecastBtn').addEventListener('click', generateForecast);
    document.getElementById('dateRange').addEventListener('change', updateDashboard);
    document.getElementById('budgetPeriod').addEventListener('change', () => {
      renderBudgetTable();
      updateBudgetProgress();
      updateVarianceAnalysis();
      updateDashboard();
    });

  </script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      color: #333;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: linear-gradient(to right, #2c3e50, #34495e);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .top-bar a:hover {
      color: #3498db;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header {
      font-size: 22px;
      font-weight: 600;
      color: #2c3e50;
      margin: 30px 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
      background: #2ecc71;
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #d68910;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid #3498db;
      color: #3498db;
    }

    .btn-outline:hover {
      background: #3498db;
      color: white;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
    }

    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-container {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      align-items: flex-end;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .table-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(to right, #3498db, #2c3e50);
      color: white;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #2980b9;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .text-success {
      color: #2ecc71;
    }

    .text-danger {
      color: #e74c3c;
    }

    .progress-container {
      margin: 20px 0;
    }

    .progress {
      height: 25px;
      background: #ecf0f1;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, #2ecc71, #3498db);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .variance-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .variance-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .variance-card h4 {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .variance-value {
      font-size: 28px;
      font-weight: 700;
    }

    .forecast-controls {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .forecast-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }

    .material-icons {
      vertical-align: middle;
      font-size: 18px;
    }

    .status-bar {
      padding: 10px 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
      margin-top: 30px;
      border-radius: 0 0 10px 10px;
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .btn {
        flex: 1;
        justify-content: center;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        min-width: 100%;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-group {
        min-width: 100%;
      }
    }

    /* Investment Section */
    .investment-summary {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .investment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .investment-item {
      padding: 15px;
      border-left: 4px solid #3498db;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .investment-item h5 {
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .investment-item .value {
      font-size: 20px;
      font-weight: 700;
      color: #2ecc71;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="coa.html"><i class="material-icons">arrow_back</i> Back to Chart of Accounts</a>
    <div id="loadingStatus">Loading Budget Dashboard...</div>
    <div class="user-info">
      <span id="userDisplay">User</span>
      <button id="logoutBtn" class="logout-btn">
        <i class="material-icons">logout</i> Logout
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">
        <i class="material-icons">trending_up</i> Budget & Forecasting Dashboard
      </h1>
      <div class="action-buttons">
        <button id="exportBudgetsBtn" class="btn btn-outline">
          <i class="material-icons">download</i> Export
        </button>
        <button id="importBudgetsBtn" class="btn btn-outline">
          <i class="material-icons">upload</i> Import
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-container">
      <div class="stat-card">
        <h3>Total Income</h3>
        <div class="stat-value" id="totalIncome">$0.00</div>
      </div>
      <div class="stat-card">
        <h3>Total Expenses</h3>
        <div class="stat-value" id="totalExpense">$0.00</div>
      </div>
      <div class="stat-card">
        <h3>Net Balance</h3>
        <div class="stat-value" id="netBalance">$0.00</div>
      </div>
      <div class="stat-card">
        <h3>Savings Rate</h3>
        <div class="stat-value" id="savingsRate">0%</div>
      </div>
    </div>

    <!-- Date Range Filter -->
    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>Date Range:</label>
          <input type="text" id="dateRange" class="form-control" />
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-title">
          <i class="material-icons">bar_chart</i> Budget vs Actual
        </div>
        <canvas id="budgetVsActualChart" height="300"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">
          <i class="material-icons">pie_chart</i> Spending by Category
        </div>
        <canvas id="spendingByCategoryChart" height="300"></canvas>
      </div>
    </div>

    <!-- Budget Management -->
    <h2 class="section-header">
      <i class="material-icons">account_balance_wallet</i> Budget Management
    </h2>

    <!-- Budget Period Selector -->
    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>Budget Period:</label>
          <input type="month" id="budgetPeriod" class="form-control" />
        </div>
        <div class="form-group">
          <label>Budget Progress:</label>
          <div class="progress-container">
            <div class="progress">
              <div class="progress-bar" id="budgetProgressBar" style="width: 0%">0%</div>
            </div>
            <div id="budgetProgressText" style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">
              $0.00 of $0.00
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Budget Form -->
    <div class="form-container" id="budgetForm">
      <h3 style="margin-bottom: 20px; color: #2c3e50;">Add New Budget</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Account:</label>
          <select id="newBudgetAccount" class="form-control account-select">
            <option value="">Select Account</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select id="newBudgetType" class="form-control">
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="Investment">Investment</option>
            <option value="Savings">Savings</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount:</label>
          <input type="number" id="newBudgetAmount" class="form-control" placeholder="0.00" step="0.01" />
        </div>
        <div class="form-group">
          <label>Frequency:</label>
          <select id="newBudgetFrequency" class="form-control">
            <option value="Monthly">Monthly</option>
            <option value="Weekly">Weekly</option>
            <option value="Bi-Weekly">Bi-Weekly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Yearly">Yearly</option>
            <option value="One-time">One-time</option>
          </select>
        </div>
        <div class="form-group">
          <button id="addBudgetBtn" class="btn btn-primary" style="height: 42px;">
            <i class="material-icons">add</i> Add Budget
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Account</th>
            <th>Type</th>
            <th>Frequency</th>
            <th class="text-right">Budgeted</th>
            <th class="text-right">Actual</th>
            <th class="text-right">Variance</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <tr><td colspan="8" class="text-center">Loading budgets...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Variance Analysis -->
    <h2 class="section-header">
      <i class="material-icons">analytics</i> Variance Analysis
    </h2>
    
    <div class="variance-container">
      <div class="variance-card">
        <h4>Total Variance</h4>
        <div class="variance-value" id="varianceTotal">$0.00</div>
      </div>
      <div class="variance-card">
        <h4>Over Budget</h4>
        <div class="variance-value" id="overBudgetCount">0</div>
        <small>Categories</small>
      </div>
      <div class="variance-card">
        <h4>Under Budget</h4>
        <div class="variance-value text-success" id="underBudgetCount">0</div>
        <small>Categories</small>
      </div>
      <div class="variance-card">
        <h4>On Budget</h4>
        <div class="variance-value" id="onBudgetCount">0</div>
        <small>Categories</small>
      </div>
    </div>

    <!-- Forecasting Section -->
    <h2 class="section-header">
      <i class="material-icons">timeline</i> Financial Forecasting
    </h2>

    <div class="forecast-controls">
      <div class="forecast-row">
        <div class="form-group">
          <label>Forecast Type:</label>
          <select id="forecastType" class="form-control">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Periods to Forecast:</label>
          <input type="number" id="forecastPeriods" class="form-control" value="12" min="1" max="60" />
        </div>
        <div class="form-group">
          <label>Forecast Method:</label>
          <select id="forecastMethod" class="form-control">
            <option value="average">Historical Average</option>
            <option value="trend">Trend Analysis</option>
            <option value="last">Last Period</option>
          </select>
        </div>
        <div class="form-group">
          <button id="generateForecastBtn" class="btn btn-warning" style="height: 42px;">
            <i class="material-icons">refresh</i> Generate Forecast
          </button>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">
        <i class="material-icons">show_chart</i> Financial Forecast
      </div>
      <canvas id="forecastChart" height="350"></canvas>
    </div>

    <!-- Investment Section -->
    <h2 class="section-header">
      <i class="material-icons">attach_money</i> Investment Overview
    </h2>

    <div class="investment-summary">
      <div class="investment-grid">
        <div class="investment-item">
          <h5>Total Investments</h5>
          <div class="value" id="totalInvestments">$0.00</div>
          <small>Current Value</small>
        </div>
        <div class="investment-item">
          <h5>Monthly Investment</h5>
          <div class="value" id="monthlyInvestment">$0.00</div>
          <small>Budgeted Amount</small>
        </div>
        <div class="investment-item">
          <h5>Investment Growth</h5>
          <div class="value" id="investmentGrowth">0.0%</div>
          <small>Annual Return</small>
        </div>
        <div class="investment-item">
          <h5>Future Value (5 yrs)</h5>
          <div class="value" id="futureValue">$0.00</div>
          <small>Projected Value</small>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="dataStatus">Budget Dashboard Ready</span>
    </div>
  </div>
</body>
</html>