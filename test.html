<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget & Forecasting Dashboard (INR Only)</title>
  
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Date Range Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment/moment.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --secondary-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --dark-color: #1f2937;
      --light-color: #f9fafb;
      --gray-color: #6b7280;
      --border-color: #e5e7eb;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      min-height: 100vh;
      color: var(--dark-color);
      line-height: 1.6;
      transition: all 0.3s ease;
    }

    /* Top Navigation */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 25px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .dashboard-title i {
      color: var(--primary-color);
      font-size: 36px;
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark-color);
      margin: 40px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-success {
      background: var(--secondary-color);
      color: white;
    }

    .btn-success:hover {
      background: #0da271;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    /* Stats Container */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s, box-shadow 0.3s;
      border-left: 4px solid var(--primary-color);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }

    .stat-card h3 {
      font-size: 14px;
      color: var(--gray-color);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--dark-color);
    }

    .stat-value.income {
      color: var(--secondary-color);
    }

    .stat-value.expense {
      color: var(--danger-color);
    }

    /* Charts Container - FIXED PADDING */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px; /* Reduced padding */
      box-shadow: var(--card-shadow);
      height: 420px; /* Increased height */
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      flex: 1;
      position: relative;
      margin: 0;
      padding: 0;
      width: 100%;
      height: calc(100% - 50px); /* Dynamic height calculation */
    }

    /* Chart Switcher Styles */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .chart-switcher {
      display: flex;
      gap: 5px;
      background: var(--border-color);
      padding: 4px;
      border-radius: 8px;
    }
    
    .chart-type-btn {
      padding: 8px 15px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-color);
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .chart-type-btn:hover {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary-color);
    }
    
    .chart-type-btn.active {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Feature Cards */
    .feature-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .feature-card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s, box-shadow 0.3s;
      border-top: 4px solid transparent;
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }
    
    .feature-card.insight {
      border-top-color: var(--info-color);
    }
    
    .feature-card.trend {
      border-top-color: var(--secondary-color);
    }
    
    .feature-card.alert {
      border-top-color: var(--warning-color);
    }
    
    .feature-card.summary {
      border-top-color: var(--primary-color);
    }
    
    .feature-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: white;
      margin-bottom: 20px;
    }
    
    .feature-card.insight .feature-icon {
      background: linear-gradient(135deg, var(--info-color), #60a5fa);
    }
    
    .feature-card.trend .feature-icon {
      background: linear-gradient(135deg, var(--secondary-color), #34d399);
    }
    
    .feature-card.alert .feature-icon {
      background: linear-gradient(135deg, var(--warning-color), #fbbf24);
    }
    
    .feature-card.summary .feature-icon {
      background: linear-gradient(135deg, var(--primary-color), #818cf8);
    }
    
    .feature-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--dark-color);
    }
    
    .feature-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .feature-desc {
      font-size: 14px;
      color: var(--gray-color);
      line-height: 1.5;
    }

    /* Budget Progress */
    .progress-container {
      margin: 20px 0;
    }

    .progress {
      height: 28px;
      background: #f3f4f6;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    .progress-bar.success {
      background: linear-gradient(90deg, var(--secondary-color), #34d399);
    }

    .progress-bar.warning {
      background: linear-gradient(90deg, var(--warning-color), #fbbf24);
    }

    .progress-bar.danger {
      background: linear-gradient(90deg, var(--danger-color), #f87171);
    }

    /* Budget Table */
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
    }

    th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    /* New Features Styles */
    
    /* Debt Tracker */
    .debt-tracker {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    
    .debt-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .debt-card {
      padding: 20px;
      border-radius: 10px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      text-align: center;
    }
    
    .debt-card h4 {
      margin-bottom: 10px;
      color: var(--dark-color);
    }
    
    .debt-amount {
      font-size: 24px;
      font-weight: 700;
      margin: 10px 0;
    }
    
    /* Bill Reminders */
    .bill-reminders {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    
    .bill-list {
      margin-top: 20px;
    }
    
    .bill-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .bill-item:last-child {
      border-bottom: none;
    }
    
    .bill-due {
      color: var(--danger-color);
      font-weight: 600;
    }
    
    /* Savings Goals */
    .savings-goals {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    
    .goal-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    /* Financial Health Score */
    .health-score {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .score-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: conic-gradient(var(--secondary-color) 0% 75%, var(--border-color) 75% 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      position: relative;
    }
    
    .score-value {
      font-size: 42px;
      font-weight: 700;
      color: var(--dark-color);
    }
    
    /* Cash Flow Calendar */
    .cashflow-calendar {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .calendar-day {
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      background: #f8fafc;
    }
    
    .calendar-day.income {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--secondary-color);
    }
    
    .calendar-day.expense {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger-color);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .nav-links {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .btn {
        flex: 1;
        justify-content: center;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        min-width: 100%;
        height: 400px;
      }
      
      .feature-cards {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global variables
    let allTransactions = [];
    let allBudgets = [];
    let allAccounts = [];
    let forecasts = {};
    let userUID = null;
    let currentCurrency = 'INR';
    
    // Chart instances
    let budgetVsActualChart = null;
    let spendingByCategoryChart = null;
    let forecastChart = null;
    let cashFlowChart = null;
    
    // Current chart types
    let currentChartType = {
      budgetVsActual: 'bar',
      spendingByCategory: 'doughnut',
      forecast: 'line'
    };
    
    // DOM elements
    const logoutBtn = document.getElementById("logoutBtn");
    const userDisplay = document.getElementById("userDisplay");
    const loadingStatus = document.getElementById("loadingStatus");

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Initializing dashboard (INR Only)...');
      
      try {
        // Set currency to INR only
        currentCurrency = 'INR';
        document.title = 'Budget Dashboard (INR Only)';
        
        // Initialize UI components
        initializeDateRangeSelector();
        initializeChartSwitchers();
        initializeNewFeatures();
        
        console.log('UI initialized successfully');
        showNotification('Dashboard loading...', 'info');
        
        // Load initial data
        await loadInitialData();
        
        // Generate all visualizations
        generateAllCharts();
        updateDashboard();
        generateForecast();
        
        console.log('Dashboard initialized successfully (INR Only)');
        showNotification('Dashboard loaded successfully!', 'success');
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        showNotification('Error initializing dashboard: ' + error.message, 'error');
      }
    });

    // Initialize chart switchers
    function initializeChartSwitchers() {
      // Budget vs Actual chart switcher
      const budgetChartSwitcher = document.getElementById('budgetChartSwitcher');
      if (budgetChartSwitcher) {
        const buttons = budgetChartSwitcher.querySelectorAll('.chart-type-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const chartType = btn.getAttribute('data-chart-type');
            switchChartType('budgetVsActual', chartType);
            
            // Update active state
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
      }
      
      // Spending by category chart switcher
      const spendingChartSwitcher = document.getElementById('spendingChartSwitcher');
      if (spendingChartSwitcher) {
        const buttons = spendingChartSwitcher.querySelectorAll('.chart-type-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const chartType = btn.getAttribute('data-chart-type');
            switchChartType('spendingByCategory', chartType);
            
            // Update active state
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
      }
      
      // Forecast chart switcher
      const forecastChartSwitcher = document.getElementById('forecastChartSwitcher');
      if (forecastChartSwitcher) {
        const buttons = forecastChartSwitcher.querySelectorAll('.chart-type-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const chartType = btn.getAttribute('data-chart-type');
            switchChartType('forecast', chartType);
            
            // Update active state
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
      }
    }
    
    // Switch chart type
    function switchChartType(chartName, chartType) {
      currentChartType[chartName] = chartType;
      
      // Re-render the chart with new type
      switch(chartName) {
        case 'budgetVsActual':
          updateBudgetVsActualChart();
          break;
        case 'spendingByCategory':
          updateSpendingByCategoryChart();
          break;
        case 'forecast':
          updateForecastChart();
          break;
      }
      
      showNotification(`Switched to ${chartType} chart`, 'info');
    }

    // Initialize all new features
    function initializeNewFeatures() {
      addDebtTracker();
      addBillReminders();
      addSavingsGoals();
      addFinancialHealthScore();
      addCashFlowCalendar();
      addExpenseTrends();
    }
    
    // Add Debt Tracker
    function addDebtTracker() {
      const debtHTML = `
        <h2 class="section-header">
          <i class="fas fa-credit-card"></i> Debt Tracker
        </h2>
        
        <div class="debt-tracker" id="debtTracker">
          <div class="debt-summary">
            <div class="debt-card" style="border-left: 4px solid #ef4444;">
              <h4>Total Debt</h4>
              <div class="debt-amount" id="totalDebt">₹0</div>
              <small>All outstanding loans</small>
            </div>
            <div class="debt-card" style="border-left: 4px solid #f59e0b;">
              <h4>Monthly Payment</h4>
              <div class="debt-amount" id="monthlyPayment">₹0</div>
              <small>Total monthly payments</small>
            </div>
            <div class="debt-card" style="border-left: 4px solid #10b981;">
              <h4>Interest Rate</h4>
              <div class="debt-amount" id="avgInterest">0%</div>
              <small>Average interest rate</small>
            </div>
            <div class="debt-card" style="border-left: 4px solid #3b82f6;">
              <h4>Payoff Time</h4>
              <div class="debt-amount" id="payoffTime">0 mos</div>
              <small>Estimated payoff</small>
            </div>
          </div>
        </div>
      `;
      
      // Insert after Investment Overview section
      const investmentSection = document.querySelector('.investment-summary');
      if (investmentSection) {
        investmentSection.insertAdjacentHTML('afterend', debtHTML);
      }
    }
    
    // Add Bill Reminders
    function addBillReminders() {
      const billsHTML = `
        <h2 class="section-header">
          <i class="fas fa-calendar-alt"></i> Bill Reminders
        </h2>
        
        <div class="bill-reminders" id="billReminders">
          <div class="bill-list">
            <div class="bill-item">
              <div>
                <strong>Electricity Bill</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Due: 15th of every month</div>
              </div>
              <div class="bill-due">₹2,500</div>
            </div>
            <div class="bill-item">
              <div>
                <strong>Internet Bill</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Due: 10th of every month</div>
              </div>
              <div class="bill-due">₹899</div>
            </div>
            <div class="bill-item">
              <div>
                <strong>Credit Card</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Due: 20th of every month</div>
              </div>
              <div class="bill-due">₹12,000</div>
            </div>
          </div>
        </div>
      `;
      
      const debtSection = document.getElementById('debtTracker');
      if (debtSection) {
        debtSection.insertAdjacentHTML('afterend', billsHTML);
      }
    }
    
    // Add Savings Goals
    function addSavingsGoals() {
      const goalsHTML = `
        <h2 class="section-header">
          <i class="fas fa-bullseye"></i> Savings Goals
        </h2>
        
        <div class="savings-goals" id="savingsGoals">
          <div class="goal-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <strong>Emergency Fund</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Target: ₹3,00,000</div>
              </div>
              <div style="font-weight: 700; color: var(--secondary-color);">65%</div>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar success" style="width: 65%"></div>
            </div>
          </div>
          
          <div class="goal-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <strong>Vacation Fund</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Target: ₹1,50,000</div>
              </div>
              <div style="font-weight: 700; color: var(--warning-color);">40%</div>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar warning" style="width: 40%"></div>
            </div>
          </div>
          
          <div class="goal-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <strong>New Car</strong>
                <div style="font-size: 14px; color: var(--gray-color);">Target: ₹5,00,000</div>
              </div>
              <div style="font-weight: 700; color: var(--info-color);">25%</div>
            </div>
            <div class="progress" style="height: 10px;">
              <div class="progress-bar" style="width: 25%; background: var(--info-color);"></div>
            </div>
          </div>
        </div>
      `;
      
      const billsSection = document.getElementById('billReminders');
      if (billsSection) {
        billsSection.insertAdjacentHTML('afterend', goalsHTML);
      }
    }
    
    // Add Financial Health Score
    function addFinancialHealthScore() {
      const healthHTML = `
        <h2 class="section-header">
          <i class="fas fa-heartbeat"></i> Financial Health Score
        </h2>
        
        <div class="health-score" id="healthScore">
          <div class="score-circle">
            <div class="score-value">78</div>
          </div>
          <h3>Good Financial Health</h3>
          <p style="color: var(--gray-color); max-width: 500px; margin: 0 auto;">
            Your financial health is better than 65% of users. Keep up the good work with saving and debt management.
          </p>
          <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <div style="text-align: center;">
              <div style="font-weight: 700; font-size: 18px;">Savings Rate</div>
              <div style="color: var(--secondary-color); font-weight: 700;">15%</div>
            </div>
            <div style="text-align: center;">
              <div style="font-weight: 700; font-size: 18px;">Debt Ratio</div>
              <div style="color: var(--warning-color); font-weight: 700;">28%</div>
            </div>
            <div style="text-align: center;">
              <div style="font-weight: 700; font-size: 18px;">Emergency Fund</div>
              <div style="color: var(--info-color); font-weight: 700;">4 mos</div>
            </div>
          </div>
        </div>
      `;
      
      const goalsSection = document.getElementById('savingsGoals');
      if (goalsSection) {
        goalsSection.insertAdjacentHTML('afterend', healthHTML);
      }
    }
    
    // Add Cash Flow Calendar
    function addCashFlowCalendar() {
      const calendarHTML = `
        <h2 class="section-header">
          <i class="fas fa-calendar-day"></i> Cash Flow Calendar
        </h2>
        
        <div class="cashflow-calendar" id="cashflowCalendar">
          <div class="calendar-header">
            <h3 style="margin: 0;">February 2026</h3>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-sm btn-outline"><i class="fas fa-chevron-left"></i></button>
              <button class="btn btn-sm btn-outline"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
          
          <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar will be populated by JavaScript -->
          </div>
          
          <div style="margin-top: 20px;">
            <h4>Cash Flow Summary</h4>
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--gray-color);">Total Income</div>
                <div style="font-weight: 700; font-size: 18px; color: var(--secondary-color);">₹38,951</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--gray-color);">Total Expenses</div>
                <div style="font-weight: 700; font-size: 18px; color: var(--danger-color);">₹35,819</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--gray-color);">Net Cash Flow</div>
                <div style="font-weight: 700; font-size: 18px; color: var(--primary-color);">₹3,132</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const healthSection = document.getElementById('healthScore');
      if (healthSection) {
        healthSection.insertAdjacentHTML('afterend', calendarHTML);
        populateCalendar();
      }
    }
    
    // Add Expense Trends
    function addExpenseTrends() {
      const trendsHTML = `
        <h2 class="section-header">
          <i class="fas fa-chart-line"></i> Expense Trends & Predictions
        </h2>
        
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fas fa-trend-up"></i> Monthly Expense Trends
            </div>
          </div>
          <div class="chart-container">
            <canvas id="expenseTrendsChart"></canvas>
          </div>
        </div>
      `;
      
      const calendarSection = document.getElementById('cashflowCalendar');
      if (calendarSection) {
        calendarSection.insertAdjacentHTML('afterend', trendsHTML);
      }
    }
    
    // Populate calendar
    function populateCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      if (!calendarGrid) return;
      
      // Add day headers
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      days.forEach(day => {
        const dayElem = document.createElement('div');
        dayElem.className = 'calendar-day';
        dayElem.innerHTML = `<strong>${day}</strong>`;
        calendarGrid.appendChild(dayElem);
      });
      
      // Add days (1-28 for February)
      for (let i = 1; i <= 28; i++) {
        const dayElem = document.createElement('div');
        dayElem.className = 'calendar-day';
        
        // Simulate income/expense days
        if (i === 5 || i === 15 || i === 25) {
          dayElem.classList.add('income');
          dayElem.innerHTML = `${i}<br><small style="color: var(--secondary-color);">₹15,000</small>`;
        } else if (i === 2 || i === 10 || i === 20) {
          dayElem.classList.add('expense');
          dayElem.innerHTML = `${i}<br><small style="color: var(--danger-color);">₹5,000</small>`;
        } else {
          dayElem.textContent = i;
        }
        
        calendarGrid.appendChild(dayElem);
      }
    }

    // Initialize date range selector
    function initializeDateRangeSelector() {
      const dateRangeButtons = document.querySelectorAll('.date-range-btn');
      const customStartDate = document.getElementById('customStartDate');
      const customEndDate = document.getElementById('customEndDate');
      const applyCustomBtn = document.getElementById('applyCustomDate');
      
      // Set default dates
      const today = moment();
      const oneMonthAgo = moment().subtract(1, 'month');
      
      if (customStartDate) customStartDate.value = oneMonthAgo.format('YYYY-MM-DD');
      if (customEndDate) customEndDate.value = today.format('YYYY-MM-DD');
      
      // Set active button to "Monthly"
      document.querySelector('.date-range-btn[data-range="monthly"]').classList.add('active');
      
      // Add event listeners
      dateRangeButtons.forEach(button => {
        button.addEventListener('click', () => {
          const range = button.getAttribute('data-range');
          dateRangeButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          applyDateRange(range);
        });
      });
      
      if (applyCustomBtn) {
        applyCustomBtn.addEventListener('click', () => {
          const startDate = customStartDate.value;
          const endDate = customEndDate.value;
          
          if (!startDate || !endDate) {
            showNotification('Please select both start and end dates', 'warning');
            return;
          }
          
          if (moment(startDate).isAfter(moment(endDate))) {
            showNotification('Start date cannot be after end date', 'error');
            return;
          }
          
          applyCustomDateRange(startDate, endDate);
        });
      }
      
      // Set initial date range
      applyDateRange('monthly');
    }
    
    // Apply date range
    function applyDateRange(range) {
      let startDate, endDate;
      const today = moment();
      
      switch(range) {
        case 'today':
          startDate = today.clone();
          endDate = today.clone();
          break;
        case 'yesterday':
          startDate = today.clone().subtract(1, 'day');
          endDate = today.clone().subtract(1, 'day');
          break;
        case 'weekly':
          startDate = today.clone().startOf('week');
          endDate = today.clone().endOf('week');
          break;
        case 'biweekly':
          startDate = today.clone().subtract(2, 'weeks');
          endDate = today.clone();
          break;
        case 'monthly':
          startDate = today.clone().startOf('month');
          endDate = today.clone().endOf('month');
          break;
        case 'quarterly':
          startDate = today.clone().startOf('quarter');
          endDate = today.clone().endOf('quarter');
          break;
        case 'yearly':
          startDate = today.clone().startOf('year');
          endDate = today.clone().endOf('year');
          break;
        default:
          startDate = today.clone().startOf('month');
          endDate = today.clone().endOf('month');
      }
      
      updateDashboardWithDates(startDate, endDate);
    }
    
    // Apply custom date range
    function applyCustomDateRange(startDateStr, endDateStr) {
      const startDate = moment(startDateStr);
      const endDate = moment(endDateStr);
      
      updateDashboardWithDates(startDate, endDate);
    }
    
    // Update dashboard with specific dates
    function updateDashboardWithDates(startDate, endDate) {
      window.currentStartDate = startDate;
      window.currentEndDate = endDate;
      
      updateDashboard();
      
      const format = 'DD/MM/YYYY';
      showNotification(`Date range set to: ${startDate.format(format)} - ${endDate.format(format)}`, 'info');
    }

    // Authentication
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Load initial data
    async function loadInitialData() {
      return new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async user => {
          if (!user) {
            window.location.href = "login.html";
            return;
          }
          
          userUID = user.uid;
          userDisplay.textContent = user.displayName || user.email || "User";
          loadingStatus.innerHTML = '<span class="loading-spinner"></span> Loading Budget Data...';

          try {
            await loadTransactions(user.uid);
            await loadBudgets(user.uid);
            
            // Extract unique accounts
            allAccounts = [...new Set(allTransactions.map(tx => tx.ACCOUNT_HEADER || "Uncategorized").filter(Boolean))];
            
            populateAccountDropdowns();
            initializeDashboard();
            
            loadingStatus.textContent = `Loaded ${allTransactions.length} transactions and ${allBudgets.length} budgets`;
            
            resolve();
          } catch (error) {
            loadingStatus.textContent = `Error loading data: ${error.message}`;
            console.error("Error loading data:", error);
            showNotification('Error loading data: ' + error.message, 'error');
            reject(error);
          }
        });
      });
    }

    // Load transactions
    async function loadTransactions(uid) {
      try {
        console.log('Loading transactions...');
        // Simulated data - in real app, this would come from Firebase
        allTransactions = [
          { DATE: '2026-02-01', INCOME: 15000, EXPENSE: 0, ACCOUNT_HEADER: 'Salary', DESCRIPTION: 'Monthly salary' },
          { DATE: '2026-02-02', INCOME: 0, EXPENSE: 1500, ACCOUNT_HEADER: 'Money transfer', DESCRIPTION: 'Transfer to friend' },
          { DATE: '2026-02-03', INCOME: 0, EXPENSE: 299, ACCOUNT_HEADER: 'Recharge', DESCRIPTION: 'Mobile recharge' },
          { DATE: '2026-02-04', INCOME: 0, EXPENSE: 120, ACCOUNT_HEADER: 'Petrol', DESCRIPTION: 'Fuel' },
          { DATE: '2026-02-05', INCOME: 8000, EXPENSE: 0, ACCOUNT_HEADER: 'Freelance', DESCRIPTION: 'Freelance work' },
          { DATE: '2026-02-10', INCOME: 0, EXPENSE: 2500, ACCOUNT_HEADER: 'Electricity', DESCRIPTION: 'Electricity bill' },
          { DATE: '2026-02-15', INCOME: 10000, EXPENSE: 0, ACCOUNT_HEADER: 'Bonus', DESCRIPTION: 'Performance bonus' },
          { DATE: '2026-02-20', INCOME: 0, EXPENSE: 12000, ACCOUNT_HEADER: 'Credit Card', DESCRIPTION: 'Credit card payment' },
        ];
        console.log(`Loaded ${allTransactions.length} transactions`);
      } catch (error) {
        console.error("Error loading transactions:", error);
        allTransactions = [];
        throw error;
      }
    }

    // Load budgets
    async function loadBudgets(uid) {
      try {
        console.log('Loading budgets...');
        // Simulated data - in real app, this would come from Firebase
        allBudgets = [
          { id: '1', account: 'Meals & Entertainment', type: 'Expense', frequency: 'Monthly', amount: 500, period: '2026-02' },
          { id: '2', account: 'Petrol', type: 'Expense', frequency: 'Monthly', amount: 1200, period: '2026-02' },
          { id: '3', account: 'Salary', type: 'Income', frequency: 'Monthly', amount: 25000, period: '2026-02' },
          { id: '4', account: 'Electricity', type: 'Expense', frequency: 'Monthly', amount: 2000, period: '2026-02' },
        ];
        console.log(`Loaded ${allBudgets.length} budgets`);
      } catch (error) {
        console.error("Error loading budgets:", error);
        allBudgets = [];
        throw error;
      }
    }

    // Initialize dashboard
    function initializeDashboard() {
      updateDashboard();
      renderBudgetTable();
      updateFeatureCards();
      updateDebtTracker();
    }

    // Update dashboard
    function updateDashboard() {
      const filteredTx = getFilteredTransactions();
      const summary = calculateFinancialSummary(filteredTx);
      
      updateDashboardStats(summary);
      updateBudgetProgress();
      generateAllCharts();
    }

    // Get filtered transactions
    function getFilteredTransactions() {
      let startDate, endDate;
      
      if (window.currentStartDate && window.currentEndDate) {
        startDate = window.currentStartDate;
        endDate = window.currentEndDate;
      } else {
        startDate = moment().startOf('month');
        endDate = moment().endOf('month');
        window.currentStartDate = startDate;
        window.currentEndDate = endDate;
      }
      
      return allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = moment(tx.DATE);
        return txDate.isBetween(startDate, endDate, null, '[]');
      });
    }

    // Calculate financial summary
    function calculateFinancialSummary(transactions) {
      const summary = {
        income: 0,
        expense: 0,
        net: 0
      };
      
      transactions.forEach(tx => {
        summary.income += Number(tx.INCOME || 0);
        summary.expense += Number(tx.EXPENSE || 0);
        summary.net += Number(tx.INCOME || 0) - Number(tx.EXPENSE || 0);
      });
      
      return summary;
    }

    // Update dashboard statistics
    function updateDashboardStats(summary) {
      document.getElementById('totalIncome').textContent = formatCurrency(summary.income);
      document.getElementById('totalExpense').textContent = formatCurrency(summary.expense);
      document.getElementById('netBalance').textContent = formatCurrency(summary.net);
      
      const savingsRate = summary.income > 0 ? ((summary.net / summary.income) * 100).toFixed(1) : 0;
      document.getElementById('savingsRate').textContent = savingsRate + '%';
      
      document.getElementById('netBalance').className = 'stat-value ' + (summary.net >= 0 ? 'income' : 'expense');
    }

    // Generate all charts
    function generateAllCharts() {
      updateBudgetVsActualChart();
      updateSpendingByCategoryChart();
      updateForecastChart();
      updateExpenseTrendsChart();
    }

    // Update Budget vs Actual chart
    function updateBudgetVsActualChart() {
      const ctx = document.getElementById('budgetVsActualChart')?.getContext('2d');
      if (!ctx) return;
      
      const chartType = currentChartType.budgetVsActual;
      const summary = calculateFinancialSummaryForCharts();
      
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const totalBudgetedIncome = periodBudgets
        .filter(b => b.type === 'Income')
        .reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      const totalBudgetedExpense = periodBudgets
        .filter(b => b.type === 'Expense')
        .reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      if (budgetVsActualChart) {
        try {
          budgetVsActualChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      budgetVsActualChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: ['Income', 'Expenses'],
          datasets: [
            {
              label: 'Budgeted (INR)',
              data: [totalBudgetedIncome, totalBudgetedExpense],
              backgroundColor: 'rgba(99, 102, 241, 0.7)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: chartType === 'line' ? 3 : 1,
              borderRadius: chartType === 'bar' ? 6 : 0,
              tension: chartType === 'line' ? 0.4 : 0
            },
            {
              label: 'Actual (INR)',
              data: [summary.income, summary.expense],
              backgroundColor: 'rgba(16, 185, 129, 0.7)',
              borderColor: 'rgba(16, 185, 129, 1)',
              borderWidth: chartType === 'line' ? 3 : 1,
              borderRadius: chartType === 'bar' ? 6 : 0,
              tension: chartType === 'line' ? 0.4 : 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatCurrency(context.parsed);
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Amount (INR)'
              }
            }
          }
        }
      });
    }

    // Update spending by category chart
    function updateSpendingByCategoryChart() {
      const ctx = document.getElementById('spendingByCategoryChart')?.getContext('2d');
      if (!ctx) return;
      
      const chartType = currentChartType.spendingByCategory;
      const transactions = getFilteredTransactions();
      const categoryData = {};
      
      transactions.forEach(tx => {
        if (tx.EXPENSE > 0) {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          categoryData[category] = (categoryData[category] || 0) + Number(tx.EXPENSE);
        }
      });
      
      const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      
      const labels = sortedCategories.map(([category]) => category);
      const data = sortedCategories.map(([_, amount]) => amount);
      
      const colors = [
        'rgba(239, 68, 68, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(139, 92, 246, 0.8)',
        'rgba(236, 72, 153, 0.8)'
      ];
      
      if (spendingByCategoryChart) {
        try {
          spendingByCategoryChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      spendingByCategoryChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 1,
            borderColor: 'rgba(255, 255, 255, 0.2)',
            ...(chartType === 'bar' && {
              borderRadius: 6
            }),
            ...(chartType === 'line' && {
              fill: true,
              tension: 0.4,
              borderWidth: 3
            })
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: chartType === 'doughnut' || chartType === 'pie' ? {
              position: 'right',
            } : { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCurrency(context.parsed);
                }
              }
            }
          },
          ...(chartType === 'doughnut' && {
            cutout: '70%'
          })
        }
      });
    }

    // Update forecast chart
    function updateForecastChart() {
      const ctx = document.getElementById('forecastChart')?.getContext('2d');
      if (!ctx) return;
      
      const chartType = currentChartType.forecast;
      
      // Generate forecast data
      const labels = ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const data = [3000, 3500, 4000, 4200, 4500, 4800, 5000, 5200, 5500, 5800];
      
      if (forecastChart) {
        try {
          forecastChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      forecastChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: 'Forecasted Net Balance (INR)',
            data: data,
            borderColor: 'rgba(139, 92, 246, 1)',
            backgroundColor: chartType === 'line' ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.8)',
            tension: 0.3,
            fill: chartType === 'line',
            pointBackgroundColor: 'rgba(139, 92, 246, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            ...(chartType === 'bar' && {
              borderRadius: 6
            })
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCurrency(context.parsed);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Amount (INR)'
              }
            }
          }
        }
      });
    }

    // Update expense trends chart
    function updateExpenseTrendsChart() {
      const ctx = document.getElementById('expenseTrendsChart')?.getContext('2d');
      if (!ctx) return;
      
      if (cashFlowChart) {
        try {
          cashFlowChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      cashFlowChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [
            {
              label: 'Expenses (INR)',
              data: [32000, 35819, 34000, 38000, 35000, 37000, 39000, 41000, 40000, 42000, 43000, 45000],
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Income (INR)',
              data: [35000, 38951, 37000, 40000, 38000, 39000, 41000, 43000, 42000, 44000, 45000, 47000],
              borderColor: 'rgba(16, 185, 129, 1)',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + formatCurrency(context.parsed);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Amount (INR)'
              }
            }
          }
        }
      });
    }

    // Update feature cards
    function updateFeatureCards() {
      const featureCardsContainer = document.getElementById('featureCards');
      if (!featureCardsContainer) return;
      
      const summary = calculateFinancialSummary(getFilteredTransactions());
      const biggestExpense = findBiggestExpense();
      
      featureCardsContainer.innerHTML = `
        <div class="feature-card insight">
          <div class="feature-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3 class="feature-title">Monthly Trend</h3>
          <div class="feature-value">${formatCurrency(summary.expense)}</div>
          <div class="feature-desc">Current month spending</div>
        </div>
        
        <div class="feature-card trend">
          <div class="feature-icon">
            <i class="fas fa-piggy-bank"></i>
          </div>
          <h3 class="feature-title">Savings Rate</h3>
          <div class="feature-value">${(summary.income > 0 ? ((summary.net / summary.income) * 100).toFixed(1) : 0)}%</div>
          <div class="feature-desc">Percentage of income saved</div>
        </div>
        
        <div class="feature-card alert">
          <div class="feature-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h3 class="feature-title">Biggest Expense</h3>
          <div class="feature-value">${biggestExpense.category}</div>
          <div class="feature-desc">${formatCurrency(biggestExpense.amount)} spent</div>
        </div>
        
        <div class="feature-card summary">
          <div class="feature-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <h3 class="feature-title">Budget Utilization</h3>
          <div class="feature-value">75%</div>
          <div class="feature-desc">Of total budget used this month</div>
        </div>
      `;
    }

    // Update debt tracker
    function updateDebtTracker() {
      document.getElementById('totalDebt').textContent = formatCurrency(450000);
      document.getElementById('monthlyPayment').textContent = formatCurrency(15000);
      document.getElementById('avgInterest').textContent = '12%';
      document.getElementById('payoffTime').textContent = '36 mos';
    }

    // Find biggest expense
    function findBiggestExpense() {
      const transactions = getFilteredTransactions();
      const categoryData = {};
      
      transactions.forEach(tx => {
        if (tx.EXPENSE > 0) {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          categoryData[category] = (categoryData[category] || 0) + Number(tx.EXPENSE);
        }
      });
      
      let biggestCategory = 'None';
      let biggestAmount = 0;
      
      Object.entries(categoryData).forEach(([category, amount]) => {
        if (amount > biggestAmount) {
          biggestAmount = amount;
          biggestCategory = category;
        }
      });
      
      return { category: biggestCategory, amount: biggestAmount };
    }

    // Calculate financial summary for charts
    function calculateFinancialSummaryForCharts() {
      const transactions = getFilteredTransactions();
      return calculateFinancialSummary(transactions);
    }

    // Update budget progress
    function updateBudgetProgress() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      let totalBudgeted = periodBudgets.reduce((sum, b) => sum + Number(b.amount || 0), 0);
      let totalActual = 0;
      
      periodBudgets.forEach(budget => {
        totalActual += calculateActualForBudget(budget);
      });
      
      const progressPercent = totalBudgeted > 0 ? Math.min(100, (totalActual / totalBudgeted) * 100) : 0;
      const progressBar = document.getElementById('budgetProgressBar');
      if (progressBar) {
        progressBar.style.width = `${progressPercent}%`;
        progressBar.textContent = `${progressPercent.toFixed(1)}%`;
        
        if (progressPercent > 90) {
          progressBar.className = 'progress-bar danger';
        } else if (progressPercent > 75) {
          progressBar.className = 'progress-bar warning';
        } else {
          progressBar.className = 'progress-bar success';
        }
      }
      
      const progressText = document.getElementById('budgetProgressText');
      if (progressText) {
        progressText.textContent = `${formatCurrency(totalActual)} of ${formatCurrency(totalBudgeted)}`;
      }
    }

    // Calculate actual for budget
    function calculateActualForBudget(budget) {
      const transactions = getFilteredTransactions();
      const filteredTx = transactions.filter(tx => tx.ACCOUNT_HEADER === budget.account);
      
      if (budget.type === 'Income') {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.INCOME || 0), 0);
      } else {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.EXPENSE || 0), 0);
      }
    }

    // Render budget table
    function renderBudgetTable() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const tbody = document.getElementById('budgetTableBody');
      
      if (!tbody) return;
      
      if (periodBudgets.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center no-data">No budgets set for ${budgetPeriod}</td></tr>`;
        return;
      }
      
      let html = '';
      periodBudgets.forEach((budget, index) => {
        const actual = calculateActualForBudget(budget);
        const variance = budget.amount - actual;
        const variancePercent = budget.amount > 0 ? (variance / budget.amount * 100).toFixed(1) : 0;
        
        let varianceClass = '';
        let varianceIcon = '';
        if (variance > 0) {
          varianceClass = 'variance-positive';
          varianceIcon = '<i class="fas fa-arrow-down text-success"></i>';
        } else if (variance < 0) {
          varianceClass = 'variance-negative';
          varianceIcon = '<i class="fas fa-arrow-up text-danger"></i>';
        } else {
          varianceClass = 'variance-neutral';
          varianceIcon = '<i class="fas fa-equals text-muted"></i>';
        }
        
        const typeClass = budget.type === 'Income' ? 'type-income' : 
                         budget.type === 'Expense' ? 'type-expense' :
                         budget.type === 'Investment' ? 'type-investment' : 'type-savings';
        
        html += `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td>${budget.account}</td>
            <td><span class="budget-type ${typeClass}">${budget.type}</span></td>
            <td><span class="frequency-badge">${budget.frequency}</span></td>
            <td class="text-right amount">${formatCurrency(budget.amount)}</td>
            <td class="text-right amount">${formatCurrency(actual)}</td>
            <td class="text-right ${varianceClass}">
              ${varianceIcon} ${formatCurrency(Math.abs(variance))} (${Math.abs(variancePercent)}%)
            </td>
            <td class="actions">
              <button class="btn-icon edit-budget" data-id="${budget.id}" title="Edit Budget">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon delete-budget" data-id="${budget.id}" title="Delete Budget">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    // Populate account dropdowns
    function populateAccountDropdowns() {
      const accountSelects = document.querySelectorAll('.account-select');
      accountSelects.forEach(select => {
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        allAccounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account;
          option.textContent = account;
          select.appendChild(option);
        });
      });
    }

    // Generate forecast
    function generateForecast() {
      const forecastType = document.getElementById('forecastType')?.value || 'monthly';
      const forecastPeriods = parseInt(document.getElementById('forecastPeriods')?.value || 12);
      
      forecasts = calculateForecast(forecastType, forecastPeriods);
      updateForecastChart();
    }

    // Calculate forecast
    function calculateForecast(type, periods) {
      return {
        labels: ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        data: [3000, 3500, 4000, 4200, 4500, 4800, 5000, 5200, 5500, 5800]
      };
    }

    // Format currency
    function formatCurrency(amount) {
      const numAmount = Number(amount) || 0;
      
      return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(numAmount);
    }

    // Show notification
    function showNotification(message, type) {
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        </div>
        <button class="notification-close"><i class="fas fa-times"></i></button>
      `;
      
      document.body.appendChild(notification);
      
      notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.remove();
      });
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    // Add event listener for forecast generation
    document.getElementById('generateForecastBtn')?.addEventListener('click', generateForecast);
    
    // Add event listener for budget period change
    document.getElementById('budgetPeriod')?.addEventListener('change', () => {
      updateDashboard();
      renderBudgetTable();
    });

    // Fix charts on resize
    window.addEventListener('resize', () => {
      if (budgetVsActualChart) budgetVsActualChart.resize();
      if (spendingByCategoryChart) spendingByCategoryChart.resize();
      if (forecastChart) forecastChart.resize();
      if (cashFlowChart) cashFlowChart.resize();
    });

  </script>
</head>
<body class="new-style-view">
  <!-- Top Navigation -->
  <div class="top-bar">
    <div class="nav-links">
      <a href="home.html">
        <i class="fas fa-home"></i> Home
      </a>
      <a href="#" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    
    <div id="loadingStatus"><span class="loading-spinner"></span> Loading Dashboard...</div>
    
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <span id="userDisplay">User</span>
      <button id="logoutBtn" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">
        <i class="fas fa-chart-line"></i> Budget & Forecasting Dashboard <span style="font-size: 14px; color: var(--secondary-color); margin-left: 10px;">INR Only</span>
      </h1>
      <div class="action-buttons">
        <button id="exportBudgetsBtn" class="btn btn-outline btn-sm">
          <i class="fas fa-download"></i> Export
        </button>
        <button id="importBudgetsBtn" class="btn btn-outline btn-sm">
          <i class="fas fa-upload"></i> Import
        </button>
      </div>
    </div>

    <!-- Date Range Selector -->
    <div class="date-range-selector">
      <button class="date-range-btn" data-range="today">
        <i class="fas fa-calendar-day"></i> Today
      </button>
      <button class="date-range-btn" data-range="yesterday">
        <i class="fas fa-calendar-minus"></i> Yesterday
      </button>
      <button class="date-range-btn" data-range="weekly">
        <i class="fas fa-calendar-week"></i> Weekly
      </button>
      <button class="date-range-btn" data-range="biweekly">
        <i class="fas fa-calendar-alt"></i> Bi-Weekly
      </button>
      <button class="date-range-btn active" data-range="monthly">
        <i class="fas fa-calendar"></i> Monthly
      </button>
      <button class="date-range-btn" data-range="quarterly">
        <i class="fas fa-calendar-check"></i> Quarterly
      </button>
      <button class="date-range-btn" data-range="yearly">
        <i class="fas fa-calendar-star"></i> Yearly
      </button>
      <div class="date-range-custom">
        <input type="date" id="customStartDate" class="form-control">
        <span>to</span>
        <input type="date" id="customEndDate" class="form-control">
        <button id="applyCustomDate" class="btn btn-outline btn-sm">
          <i class="fas fa-check"></i> Apply
        </button>
      </div>
    </div>

    <!-- Feature Cards -->
    <h2 class="section-header">
      <i class="fas fa-lightbulb"></i> Key Insights
    </h2>
    
    <div class="feature-cards" id="featureCards">
      <!-- Feature cards will be populated by JavaScript -->
    </div>

    <!-- Stats Overview -->
    <h2 class="section-header">
      <i class="fas fa-chart-bar"></i> Financial Overview
    </h2>
    
    <div class="stats-container">
      <div class="stat-card">
        <h3>Total Income</h3>
        <div class="stat-value" id="totalIncome">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Total Expenses</h3>
        <div class="stat-value" id="totalExpense">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Net Balance</h3>
        <div class="stat-value" id="netBalance">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Savings Rate</h3>
        <div class="stat-value" id="savingsRate">0%</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-balance-scale"></i> Budget vs Actual
          </div>
          <div class="chart-switcher" id="budgetChartSwitcher">
            <button class="chart-type-btn active" data-chart-type="bar">
              <i class="fas fa-chart-bar"></i> Bar
            </button>
            <button class="chart-type-btn" data-chart-type="line">
              <i class="fas fa-chart-line"></i> Line
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="budgetVsActualChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-pie"></i> Spending by Category
          </div>
          <div class="chart-switcher" id="spendingChartSwitcher">
            <button class="chart-type-btn active" data-chart-type="doughnut">
              <i class="fas fa-chart-pie"></i> Doughnut
            </button>
            <button class="chart-type-btn" data-chart-type="pie">
              <i class="fas fa-chart-pie"></i> Pie
            </button>
            <button class="chart-type-btn" data-chart-type="bar">
              <i class="fas fa-chart-bar"></i> Bar
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="spendingByCategoryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Budget Management -->
    <h2 class="section-header">
      <i class="fas fa-wallet"></i> Budget Management
    </h2>

    <!-- Budget Period Selector -->
    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>Budget Period:</label>
          <input type="month" id="budgetPeriod" class="form-control" value="2026-02" />
        </div>
        <div class="form-group">
          <label>Budget Progress:</label>
          <div class="progress-container">
            <div class="progress">
              <div class="progress-bar" id="budgetProgressBar" style="width: 0%">0%</div>
            </div>
            <div id="budgetProgressText" style="margin-top: 8px; font-size: 13px; color: var(--gray-color);">
              ₹0 of ₹0
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Budget Form -->
    <div class="form-container" id="budgetForm">
      <h3 style="margin-bottom: 20px; color: var(--dark-color); font-size: 18px;">Add New Budget</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Account:</label>
          <select id="newBudgetAccount" class="form-control account-select">
            <option value="">Select Account</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select id="newBudgetType" class="form-control">
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="Investment">Investment</option>
            <option value="Savings">Savings</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount (₹):</label>
          <input type="number" id="newBudgetAmount" class="form-control" placeholder="₹0" step="1" min="0" />
        </div>
        <div class="form-group">
          <label>Frequency:</label>
          <select id="newBudgetFrequency" class="form-control">
            <option value="Monthly">Monthly</option>
            <option value="Weekly">Weekly</option>
            <option value="Bi-Weekly">Bi-Weekly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Yearly">Yearly</option>
          </select>
        </div>
        <div class="form-group">
          <button id="addBudgetBtn" class="btn btn-primary" style="height: 46px;">
            <i class="fas fa-plus"></i> Add Budget
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="text-center">#</th>
            <th>Account</th>
            <th>Type</th>
            <th>Frequency</th>
            <th class="text-right">Budgeted</th>
            <th class="text-right">Actual</th>
            <th class="text-right">Variance</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <tr><td colspan="8" class="text-center no-data">Loading budgets...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Forecasting Section -->
    <h2 class="section-header">
      <i class="fas fa-chart-line"></i> Financial Forecasting
    </h2>

    <div class="forecast-controls">
      <div class="forecast-row">
        <div class="form-group">
          <label>Forecast Type:</label>
          <select id="forecastType" class="form-control">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Periods to Forecast:</label>
          <input type="number" id="forecastPeriods" class="form-control" value="10" min="1" max="24" />
        </div>
        <div class="form-group">
          <button id="generateForecastBtn" class="btn btn-warning" style="height: 46px;">
            <i class="fas fa-sync-alt"></i> Generate Forecast
          </button>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">
          <i class="fas fa-project-diagram"></i> Financial Forecast
        </div>
        <div class="chart-switcher" id="forecastChartSwitcher">
          <button class="chart-type-btn active" data-chart-type="line">
            <i class="fas fa-chart-line"></i> Line
          </button>
          <button class="chart-type-btn" data-chart-type="bar">
            <i class="fas fa-chart-bar"></i> Bar
          </button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="forecastChart"></canvas>
      </div>
    </div>

    <!-- Investment Section -->
    <h2 class="section-header">
      <i class="fas fa-coins"></i> Investment Overview
    </h2>

    <div class="investment-summary">
      <div class="investment-grid">
        <div class="investment-card">
          <h5>Total Investments</h5>
          <div class="value" id="totalInvestments">₹3,50,000</div>
          <small>Current Value</small>
        </div>
        <div class="investment-card">
          <h5>Monthly Investment</h5>
          <div class="value" id="monthlyInvestment">₹15,000</div>
          <small>Budgeted Amount</small>
        </div>
        <div class="investment-card">
          <h5>Investment Growth</h5>
          <div class="value" id="investmentGrowth">12.5%</div>
          <small>Annual Return</small>
        </div>
        <div class="investment-card">
          <h5>Future Value (5 yrs)</h5>
          <div class="value" id="futureValue">₹6,30,000</div>
          <small>Projected Value</small>
        </div>
      </div>
    </div>

    <!-- NEW FEATURES WILL BE INSERTED HERE BY JAVASCRIPT -->

    <div class="status-bar">
      <span id="dataStatus">Budget Dashboard Ready (INR Only) | Data updated: Just now</span>
    </div>
  </div>

  <script>
    // Additional initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize budget period to current month
      const now = new Date();
      const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      const budgetPeriodInput = document.getElementById('budgetPeriod');
      if (budgetPeriodInput && !budgetPeriodInput.value) {
        budgetPeriodInput.value = currentMonth;
      }
      
      // Add click handlers for action buttons
      document.getElementById('exportBudgetsBtn')?.addEventListener('click', () => {
        alert('Export feature would be implemented here');
      });
      
      document.getElementById('importBudgetsBtn')?.addEventListener('click', () => {
        alert('Import feature would be implemented here');
      });
      
      document.getElementById('addBudgetBtn')?.addEventListener('click', () => {
        alert('Add budget feature would be implemented here');
      });
    });
  </script>
</body>
</html>