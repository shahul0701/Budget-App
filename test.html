<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .inventory-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .low-stock {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .out-of-stock {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="inventory-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-box"></i> Inventory Management</h2>
                    <p class="mb-0">Company: <span id="companyName">Loading...</span></p>
                </div>
                <div>
                    <button class="btn btn-light me-2" onclick="goBack()">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </button>
                    <button class="btn btn-success" onclick="showAddItemModal()">
                        <i class="bi bi-plus-circle"></i> Add Item
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Inventory Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <h6 class="text-muted">Total Items</h6>
                    <h3 id="totalItems">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h6 class="text-muted">Total Value</h6>
                    <h3 id="totalValue">$0.00</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h6 class="text-muted">Low Stock Items</h6>
                    <h3 id="lowStockCount">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h6 class="text-muted">Categories</h6>
                    <h3 id="categoryCount">0</h3>
                </div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search items..." onkeyup="filterItems()">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="categoryFilter" onchange="filterItems()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="stockFilter" onchange="filterItems()">
                        <option value="">All Stock Status</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="exportInventory()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning w-100" onclick="showStockAdjustmentModal()">
                        <i class="bi bi-arrow-left-right"></i> Stock Adjustment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Inventory Table -->
        <div class="table-container">
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#items">Inventory Items</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#categories">Categories</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#movements">Stock Movements</a>
                </li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane active" id="items">
                    <table class="table table-hover" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr>
                                <td colspan="10" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-pane" id="categories">
                    <button class="btn btn-primary mb-3" onclick="showAddCategoryModal()">
                        <i class="bi bi-folder-plus"></i> Add Category
                    </button>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Description</th>
                                <th>Items Count</th>
                                <th>Total Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-pane" id="movements">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Reference</th>
                                <th>Notes</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="movementsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Inventory Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="itemForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Item Name *</label>
                                <input type="text" class="form-control" id="itemName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="itemSku" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="itemCategory">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Unit</label>
                                <select class="form-select" id="itemUnit">
                                    <option value="piece">Piece</option>
                                    <option value="kg">Kilogram</option>
                                    <option value="liter">Liter</option>
                                    <option value="meter">Meter</option>
                                    <option value="box">Box</option>
                                    <option value="pack">Pack</option>
                                    <option value="dozen">Dozen</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="itemQuantity" value="0" min="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cost Price</label>
                                <input type="number" class="form-control" id="itemCost" step="0.01" value="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Selling Price</label>
                                <input type="number" class="form-control" id="itemPrice" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="reorderLevel" value="10" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" id="itemLocation" placeholder="e.g., Warehouse A, Shelf 1">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Barcode</label>
                            <input type="text" class="form-control" id="itemBarcode">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Supplier</label>
                            <select class="form-select" id="itemSupplier">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveItem()">Save Item</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label class="form-label">Category Name *</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stock Adjustment Modal -->
    <div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stock Adjustment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustmentForm">
                        <div class="mb-3">
                            <label class="form-label">Item *</label>
                            <select class="form-select" id="adjustmentItem" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adjustment Type *</label>
                            <select class="form-select" id="adjustmentType" required>
                                <option value="add">Add Stock</option>
                                <option value="remove">Remove Stock</option>
                                <option value="set">Set to Quantity</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="adjustmentQuantity" required min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <input type="text" class="form-control" id="adjustmentReason" placeholder="e.g., Damaged, Found, Adjustment">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="adjustmentNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveStockAdjustment()">Save Adjustment</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let currentCompany = null;
        let inventoryItems = [];
        let categories = [];
        
        const urlParams = new URLSearchParams(window.location.search);
        const companyId = urlParams.get('company');
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadCompanyData();
                loadInventoryItems();
                loadCategories();
                loadStockMovements();
            } else {
                window.location.href = 'login.html';
            }
        });
        
        function loadCompanyData() {
            if (!currentUser || !companyId) return;
            
            const companyFromSession = sessionStorage.getItem('selectedCompany');
            if (companyFromSession) {
                currentCompany = JSON.parse(companyFromSession);
                document.getElementById('companyName').textContent = currentCompany.name;
            }
        }
        
        function loadInventoryItems() {
            if (!currentUser || !companyId) return;
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('inventory')
                .orderBy('name')
                .get()
                .then((snapshot) => {
                    inventoryItems = [];
                    let totalValue = 0;
                    let lowStock = 0;
                    
                    let html = '';
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = { id: doc.id, ...data };
                        inventoryItems.push(item);
                        
                        const value = (data.quantity || 0) * (data.costPrice || 0);
                        totalValue += value;
                        
                        const status = getStockStatus(data.quantity, data.reorderLevel);
                        if (status === 'low-stock') lowStock++;
                        
                        const statusClass = status === 'low-stock' ? 'low-stock' : (status === 'out-of-stock' ? 'out-of-stock' : '');
                        
                        html += `
                            <tr class="${statusClass}">
                                <td>${data.sku || 'N/A'}</td>
                                <td>${data.name}</td>
                                <td>${data.categoryName || 'Uncategorized'}</td>
                                <td>${data.quantity || 0}</td>
                                <td>${data.unit || 'piece'}</td>
                                <td>${formatCurrency(data.costPrice || 0)}</td>
                                <td>${formatCurrency(data.sellingPrice || 0)}</td>
                                <td>${formatCurrency(value)}</td>
                                <td>
                                    <span class="badge bg-${getStatusBadgeColor(status)}">${status}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editItem('${doc.id}')"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-success" onclick="adjustStock('${doc.id}')"><i class="bi bi-plus-slash-minus"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem('${doc.id}')"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (html === '') {
                        html = '<tr><td colspan="10" class="text-center">No inventory items found</td></tr>';
                    }
                    
                    document.getElementById('inventoryTableBody').innerHTML = html;
                    document.getElementById('totalItems').textContent = inventoryItems.length;
                    document.getElementById('totalValue').textContent = formatCurrency(totalValue);
                    document.getElementById('lowStockCount').textContent = lowStock;
                });
        }
        
        function loadCategories() {
            if (!currentUser || !companyId) return;
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('categories')
                .orderBy('name')
                .get()
                .then((snapshot) => {
                    categories = [];
                    let html = '';
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        categories.push({ id: doc.id, ...data });
                        
                        html += `
                            <tr>
                                <td>${data.name}</td>
                                <td>${data.description || '-'}</td>
                                <td>${data.itemCount || 0}</td>
                                <td>${formatCurrency(data.totalValue || 0)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editCategory('${doc.id}')"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCategory('${doc.id}')"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (html === '') {
                        html = '<tr><td colspan="5" class="text-center">No categories found</td></tr>';
                    }
                    
                    document.getElementById('categoriesTableBody').innerHTML = html;
                    document.getElementById('categoryCount').textContent = categories.length;
                    
                    // Populate category dropdowns
                    populateCategoryDropdowns();
                });
        }
        
        function loadStockMovements() {
            if (!currentUser || !companyId) return;
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('stockMovements')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get()
                .then((snapshot) => {
                    let html = '';
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        html += `
                            <tr>
                                <td>${formatDate(data.createdAt)}</td>
                                <td>${data.itemName || 'N/A'}</td>
                                <td>
                                    <span class="badge bg-${getMovementTypeColor(data.type)}">${data.type}</span>
                                </td>
                                <td>${data.quantity || 0}</td>
                                <td>${data.reference || '-'}</td>
                                <td>${data.notes || '-'}</td>
                                <td>${data.user || 'System'}</td>
                            </tr>
                        `;
                    });
                    
                    if (html === '') {
                        html = '<tr><td colspan="7" class="text-center">No stock movements found</td></tr>';
                    }
                    
                    document.getElementById('movementsTableBody').innerHTML = html;
                });
        }
        
        function populateCategoryDropdowns() {
            let options = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });
            
            document.getElementById('itemCategory').innerHTML = options;
            
            // Populate category filter
            let filterOptions = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                filterOptions += `<option value="${cat.id}">${cat.name}</option>`;
            });
            document.getElementById('categoryFilter').innerHTML = filterOptions;
        }
        
        function getStockStatus(quantity, reorderLevel) {
            if (!quantity || quantity <= 0) return 'out-of-stock';
            if (quantity <= reorderLevel) return 'low-stock';
            return 'in-stock';
        }
        
        function getStatusBadgeColor(status) {
            switch(status) {
                case 'in-stock': return 'success';
                case 'low-stock': return 'warning';
                case 'out-of-stock': return 'danger';
                default: return 'secondary';
            }
        }
        
        function getMovementTypeColor(type) {
            switch(type) {
                case 'add': return 'success';
                case 'remove': return 'danger';
                case 'set': return 'warning';
                default: return 'secondary';
            }
        }
        
        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            const filtered = inventoryItems.filter(item => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.sku && item.sku.toLowerCase().includes(searchTerm)) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                // Category filter
                const matchesCategory = categoryFilter === '' || item.categoryId === categoryFilter;
                
                // Stock filter
                const status = getStockStatus(item.quantity, item.reorderLevel);
                const matchesStock = stockFilter === '' || status === stockFilter;
                
                return matchesSearch && matchesCategory && matchesStock;
            });
            
            displayFilteredItems(filtered);
        }
        
        function displayFilteredItems(items) {
            let html = '';
            items.forEach(item => {
                const value = (item.quantity || 0) * (item.costPrice || 0);
                const status = getStockStatus(item.quantity, item.reorderLevel);
                const statusClass = status === 'low-stock' ? 'low-stock' : (status === 'out-of-stock' ? 'out-of-stock' : '');
                
                html += `
                    <tr class="${statusClass}">
                        <td>${item.sku || 'N/A'}</td>
                        <td>${item.name}</td>
                        <td>${item.categoryName || 'Uncategorized'}</td>
                        <td>${item.quantity || 0}</td>
                        <td>${item.unit || 'piece'}</td>
                        <td>${formatCurrency(item.costPrice || 0)}</td>
                        <td>${formatCurrency(item.sellingPrice || 0)}</td>
                        <td>${formatCurrency(value)}</td>
                        <td>
                            <span class="badge bg-${getStatusBadgeColor(status)}">${status}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editItem('${item.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-success" onclick="adjustStock('${item.id}')"><i class="bi bi-plus-slash-minus"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem('${item.id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="10" class="text-center">No matching items found</td></tr>';
            }
            
            document.getElementById('inventoryTableBody').innerHTML = html;
        }
        
        function showAddItemModal() {
            if (!currentCompany) {
                alert('Please select a company first');
                return;
            }
            
            document.getElementById('itemForm').reset();
            
            // Generate SKU
            const sku = 'SKU-' + Date.now().toString().slice(-8);
            document.getElementById('itemSku').value = sku;
            
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }
        
        function saveItem() {
            if (!currentUser || !companyId) {
                alert('Please login and select a company');
                return;
            }
            
            const categoryId = document.getElementById('itemCategory').value;
            const category = categories.find(c => c.id === categoryId);
            
            const itemData = {
                name: document.getElementById('itemName').value,
                sku: document.getElementById('itemSku').value,
                categoryId: categoryId,
                categoryName: category ? category.name : 'Uncategorized',
                unit: document.getElementById('itemUnit').value,
                quantity: parseFloat(document.getElementById('itemQuantity').value) || 0,
                costPrice: parseFloat(document.getElementById('itemCost').value) || 0,
                sellingPrice: parseFloat(document.getElementById('itemPrice').value) || 0,
                reorderLevel: parseFloat(document.getElementById('reorderLevel').value) || 10,
                location: document.getElementById('itemLocation').value,
                description: document.getElementById('itemDescription').value,
                barcode: document.getElementById('itemBarcode').value,
                supplier: document.getElementById('itemSupplier').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!itemData.name || !itemData.sku) {
                alert('Please fill in required fields');
                return;
            }
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('inventory')
                .add(itemData)
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
                    loadInventoryItems();
                    
                    // Update category item count
                    if (categoryId) {
                        updateCategoryItemCount(categoryId);
                    }
                    
                    alert('Item added successfully!');
                })
                .catch((error) => {
                    console.error('Error adding item:', error);
                    alert('Error adding item: ' + error.message);
                });
        }
        
        function showAddCategoryModal() {
            document.getElementById('categoryForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
            modal.show();
        }
        
        function saveCategory() {
            if (!currentUser || !companyId) {
                alert('Please login and select a company');
                return;
            }
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                itemCount: 0,
                totalValue: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!categoryData.name) {
                alert('Please enter category name');
                return;
            }
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('categories')
                .add(categoryData)
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                    loadCategories();
                    alert('Category added successfully!');
                })
                .catch((error) => {
                    console.error('Error adding category:', error);
                    alert('Error adding category: ' + error.message);
                });
        }
        
        function showStockAdjustmentModal() {
            // Populate item dropdown
            let options = '<option value="">Select Item</option>';
            inventoryItems.forEach(item => {
                options += `<option value="${item.id}">${item.name} (Qty: ${item.quantity})</option>`;
            });
            document.getElementById('adjustmentItem').innerHTML = options;
            
            document.getElementById('adjustmentForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
            modal.show();
        }
        
        function adjustStock(itemId) {
            const item = inventoryItems.find(i => i.id === itemId);
            if (!item) return;
            
            let options = `<option value="${item.id}">${item.name} (Qty: ${item.quantity})</option>`;
            document.getElementById('adjustmentItem').innerHTML = options;
            document.getElementById('adjustmentItem').value = itemId;
            
            document.getElementById('adjustmentForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
            modal.show();
        }
        
        function saveStockAdjustment() {
            if (!currentUser || !companyId) {
                alert('Please login and select a company');
                return;
            }
            
            const itemId = document.getElementById('adjustmentItem').value;
            const adjustmentType = document.getElementById('adjustmentType').value;
            const adjustmentQuantity = parseFloat(document.getElementById('adjustmentQuantity').value);
            const reason = document.getElementById('adjustmentReason').value;
            const notes = document.getElementById('adjustmentNotes').value;
            
            if (!itemId || !adjustmentType || !adjustmentQuantity) {
                alert('Please fill in all required fields');
                return;
            }
            
            const item = inventoryItems.find(i => i.id === itemId);
            if (!item) return;
            
            // Calculate new quantity
            let newQuantity = item.quantity;
            switch(adjustmentType) {
                case 'add':
                    newQuantity += adjustmentQuantity;
                    break;
                case 'remove':
                    newQuantity -= adjustmentQuantity;
                    break;
                case 'set':
                    newQuantity = adjustmentQuantity;
                    break;
            }
            
            if (newQuantity < 0) {
                alert('Quantity cannot be negative');
                return;
            }
            
            // Update item quantity
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('inventory')
                .doc(itemId)
                .update({
                    quantity: newQuantity
                })
                .then(() => {
                    // Log stock movement
                    const movementData = {
                        itemId: itemId,
                        itemName: item.name,
                        type: adjustmentType,
                        quantity: adjustmentQuantity,
                        previousQuantity: item.quantity,
                        newQuantity: newQuantity,
                        reference: reason,
                        notes: notes,
                        user: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    return db.collection('users').doc(currentUser.uid)
                        .collection('companies').doc(companyId)
                        .collection('stockMovements')
                        .add(movementData);
                })
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal')).hide();
                    loadInventoryItems();
                    loadStockMovements();
                    alert('Stock adjustment completed successfully!');
                })
                .catch((error) => {
                    console.error('Error adjusting stock:', error);
                    alert('Error adjusting stock: ' + error.message);
                });
        }
        
        function updateCategoryItemCount(categoryId) {
            if (!currentUser || !companyId) return;
            
            // Count items in this category
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('inventory')
                .where('categoryId', '==', categoryId)
                .get()
                .then((snapshot) => {
                    let count = 0;
                    let totalValue = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        count++;
                        totalValue += (data.quantity || 0) * (data.costPrice || 0);
                    });
                    
                    // Update category
                    return db.collection('users').doc(currentUser.uid)
                        .collection('companies').doc(companyId)
                        .collection('categories')
                        .doc(categoryId)
                        .update({
                            itemCount: count,
                            totalValue: totalValue
                        });
                })
                .catch((error) => {
                    console.error('Error updating category:', error);
                });
        }
        
        function editItem(itemId) {
            alert('Edit functionality coming soon');
        }
        
        function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            db.collection('users').doc(currentUser.uid)
                .collection('companies').doc(companyId)
                .collection('inventory')
                .doc(itemId)
                .delete()
                .then(() => {
                    loadInventoryItems();
                })
                .catch((error) => {
                    console.error('Error deleting item:', error);
                    alert('Error deleting item');
                });
        }
        
        function exportInventory() {
            // Create CSV
            let csv = 'SKU,Item Name,Category,Quantity,Unit,Cost Price,Selling Price,Value,Location\n';
            
            inventoryItems.forEach(item => {
                const value = (item.quantity || 0) * (item.costPrice || 0);
                csv += `"${item.sku || ''}","${item.name || ''}","${item.categoryName || ''}",${item.quantity || 0},"${item.unit || 'piece'}",${item.costPrice || 0},${item.sellingPrice || 0},${value},"${item.location || ''}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function goBack() {
            window.close();
        }
    </script>
</body>
</html>