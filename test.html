<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Budget & Forecasting Dashboard</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .page {
      max-width:1600px;
      margin:36px auto;
      padding:22px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:16px;
      box-shadow: 0 15px 40px rgba(26,29,40,0.08);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
    }

    /* Header */
    .tm-header {
      border-radius:16px 16px 0 0;
      padding:24px 32px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:800; font-size:24px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:10px; align-items:center; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      background: rgba(255,255,255,0.08);
      transition: all 0.3s;
    }
    .btn-outline-light:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
      padding: 25px;
      background: linear-gradient(to bottom, var(--bg-primary) 0%, transparent 100%);
    }
    
    .stat-card-large {
      grid-column: span 3;
      background: var(--card-bg);
      border-radius: 14px;
      padding: 25px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 25px rgba(0,0,0,0.05);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    .stat-card-large:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    .stat-card-large::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--purple-1), var(--accent));
    }
    .stat-label-lg {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-value-lg {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 15px;
      line-height: 1;
    }
    .stat-change-lg {
      font-size: 13px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .positive-change { background: rgba(25, 135, 84, 0.15); color: var(--success); }
    .negative-change { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
    .neutral-change { background: rgba(108, 117, 125, 0.15); color: var(--secondary); }
    
    /* Progress Visualization */
    .progress-visualization {
      grid-column: span 6;
      background: var(--card-bg);
      border-radius: 14px;
      padding: 25px;
      border: 1px solid var(--border-color);
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .progress-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .progress-period {
      font-size: 14px;
      color: var(--muted);
    }
    
    .progress-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .progress-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .progress-category {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .progress-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }
    
    .progress-amounts {
      display: flex;
      gap: 10px;
      font-size: 14px;
    }
    
    .progress-spent {
      font-weight: 600;
    }
    
    .progress-limit {
      color: var(--muted);
    }
    
    /* Enhanced Progress Bar */
    .progress-bar-container {
      height: 16px;
      background: var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .progress-bar-fill {
      height: 100%;
      border-radius: 8px;
      position: relative;
      transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.3) 50%, 
        transparent 100%);
      animation: shimmer 2s infinite;
    }
    
    .progress-percentage {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      z-index: 2;
    }
    
    /* Insights Cards */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 25px;
    }
    
    .insight-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 25px;
      border: 1px solid var(--border-color);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    
    .insight-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    
    .insight-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .insight-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: white;
    }
    
    .insight-badge {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .insight-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .insight-value {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 10px;
      line-height: 1;
    }
    
    .insight-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Forecast Section */
    .forecast-section {
      padding: 25px;
      background: var(--card-bg);
      border-radius: 14px;
      margin: 0 25px 25px;
      border: 1px solid var(--border-color);
    }
    
    .forecast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .forecast-tabs {
      display: flex;
      gap: 10px;
      background: var(--bg-primary);
      border-radius: 10px;
      padding: 5px;
    }
    
    .forecast-tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .forecast-tab:hover {
      background: var(--card-bg);
    }
    
    .forecast-tab.active {
      background: var(--purple-1);
      color: white;
    }
    
    .forecast-cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .forecast-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }
    
    .forecast-card:hover {
      border-color: var(--purple-1);
      box-shadow: 0 8px 25px rgba(111, 66, 193, 0.1);
    }
    
    .forecast-period {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .forecast-amount {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 15px;
    }
    
    .forecast-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    /* Savings Tips */
    .tips-section {
      padding: 25px;
      background: var(--card-bg);
      border-radius: 14px;
      margin: 0 25px 25px;
      border: 1px solid var(--border-color);
    }
    
    .tips-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    
    .tip-card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--purple-1);
      transition: transform 0.3s;
    }
    
    .tip-card:hover {
      transform: translateX(5px);
    }
    
    .tip-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(111, 66, 193, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--purple-1);
      font-size: 18px;
      margin-bottom: 15px;
    }
    
    .tip-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .tip-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Charts Container */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
      padding: 25px;
    }
    
    .chart-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 25px;
      border: 1px solid var(--border-color);
      height: 350px;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 700;
    }
    
    /* Limit Alerts */
    .alerts-section {
      padding: 25px;
      background: var(--card-bg);
      border-radius: 14px;
      margin: 0 25px 25px;
      border: 1px solid var(--border-color);
    }
    
    .alerts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    
    .alert-card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .alert-card.critical {
      border-left: 4px solid var(--danger);
    }
    
    .alert-card.warning {
      border-left: 4px solid var(--warning);
    }
    
    .alert-card.info {
      border-left: 4px solid var(--info);
    }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .alert-category {
      font-weight: 600;
      font-size: 14px;
    }
    
    .alert-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .alert-badge.critical { background: rgba(220, 53, 69, 0.15); color: var(--danger); }
    .alert-badge.warning { background: rgba(255, 193, 7, 0.15); color: var(--warning); }
    .alert-badge.info { background: rgba(13, 202, 240, 0.15); color: var(--info); }
    
    .alert-progress {
      margin: 15px 0;
    }
    
    .alert-message {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Navigation */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Responsive */
    @media (max-width: 1400px) {
      .stat-card-large { grid-column: span 4; }
      .progress-visualization { grid-column: span 8; }
      .insights-grid { grid-template-columns: repeat(2, 1fr); }
      .forecast-cards-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-container { grid-template-columns: 1fr; }
      .tips-grid { grid-template-columns: repeat(2, 1fr); }
      .alerts-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 992px) {
      .stat-card-large { grid-column: span 6; }
      .progress-visualization { grid-column: span 12; }
      .insights-grid { grid-template-columns: 1fr; }
      .forecast-cards-grid { grid-template-columns: 1fr; }
      .tips-grid { grid-template-columns: 1fr; }
      .alerts-grid { grid-template-columns: 1fr; }
      .dashboard-stats { gap: 15px; padding: 20px; }
    }
    
    @media (max-width: 768px) {
      .stat-card-large { grid-column: span 12; }
      .page { padding: 15px; }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: space-between; }
    }
    
    /* Animations */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    /* Color Utilities */
    .income-color { color: var(--success); }
    .expense-color { color: var(--danger); }
    .savings-color { color: var(--info); }
    .warning-color { color: var(--warning); }
    
    /* Loading */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      backdrop-filter: blur(5px);
    }
    
    /* Form Elements */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--purple-1);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Floating Action Buttons */
    .floating-actions {
      position: fixed;
      right: 30px;
      bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 1000;
    }
    
    .floating-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .floating-btn-primary {
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
    }
    
    .floating-btn-success {
      background: linear-gradient(135deg, var(--success), #0d6e3d);
    }
    
    .floating-btn-warning {
      background: linear-gradient(135deg, var(--warning), #d39e00);
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Loading Backdrop -->
    <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p id="backdropMessage">Loading Budget Dashboard...</p>
      </div>
    </div>
    
    <!-- Navigation -->
    <div class="nav-buttons">
      <button id="backBtn" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left me-2"></i> Back
      </button>
      <button id="homeBtn" class="btn btn-outline-secondary">
        <i class="fa fa-home me-2"></i> Home
      </button>
      <button id="transactionsBtn" class="btn btn-outline-info">
        <i class="fa fa-money-bill-wave me-2"></i> Transactions
      </button>
      <button id="coaBtn" class="btn btn-outline-success">
        <i class="fa fa-chart-pie me-2"></i> COA
      </button>
      <button id="reportsBtn" class="btn btn-outline-warning">
        <i class="fa fa-chart-bar me-2"></i> Reports
      </button>
      <div class="ms-auto">
        <button id="exportDataBtn" class="btn btn-outline-primary btn-sm">
          <i class="fa fa-download me-2"></i> Export
        </button>
        <button id="printDashboardBtn" class="btn btn-outline-secondary btn-sm ms-2">
          <i class="fa fa-print me-2"></i> Print
        </button>
      </div>
    </div>
    
    <!-- Main App Card -->
    <div class="app-card">
      <!-- Header -->
      <div class="tm-header">
        <h2><i class="fa fa-chart-line"></i> Advanced Budget & Forecasting Dashboard</h2>
        <div class="header-actions">
          <button id="refreshBtn" class="btn btn-light btn-sm text-primary">
            <i class="fa fa-sync-alt me-1"></i> Refresh
          </button>
          <button id="newBudgetBtn" class="btn btn-light btn-sm text-primary">
            <i class="fa fa-plus-circle me-1"></i> New Budget
          </button>
          <button id="forecastBtn" class="btn btn-light btn-sm text-primary">
            <i class="fa fa-calculator me-1"></i> Forecast
          </button>
          <button id="themeToggle" class="theme-toggle">
            <i class="fa fa-moon"></i>
          </button>
          <div style="width:1px;height:36px;background:rgba(255,255,255,0.2); margin-left:8px;"></div>
          <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
            <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.15); display:flex;align-items:center;justify-content:center;font-weight:700; color: white;">U</div>
            <div style="color:white; font-weight:600;" id="username">User</div>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
          </div>
        </div>
      </div>
      
      <!-- Dashboard Stats -->
      <div class="dashboard-stats" id="dashboardStats">
        <!-- Stats will be populated dynamically -->
      </div>
      
      <!-- Progress Visualization -->
      <div class="progress-visualization" id="progressVisualization">
        <div class="progress-header">
          <div class="progress-title">
            <i class="fa fa-chart-bar me-2"></i>Budget Progress Tracking
          </div>
          <div class="progress-period" id="progressPeriod">Current Period: Monthly</div>
        </div>
        <div class="progress-container" id="progressContainer">
          <!-- Progress items will be populated here -->
        </div>
      </div>
      
      <!-- Insights Grid -->
      <div class="insights-grid" id="insightsGrid">
        <!-- Insights will be populated dynamically -->
      </div>
      
      <!-- Forecast Section -->
      <div class="forecast-section">
        <div class="forecast-header">
          <h4><i class="fa fa-chart-line me-2"></i>Financial Forecast</h4>
          <div class="forecast-tabs">
            <button class="forecast-tab active" data-period="3">3 Months</button>
            <button class="forecast-tab" data-period="6">6 Months</button>
            <button class="forecast-tab" data-period="12">12 Months</button>
          </div>
        </div>
        <div class="forecast-cards-grid" id="forecastCards">
          <!-- Forecast cards will be populated here -->
        </div>
        <div id="forecastChartContainer" style="height: 300px;">
          <canvas id="forecastChart"></canvas>
        </div>
      </div>
      
      <!-- Charts Container -->
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fa fa-pie-chart me-2"></i>Spending Distribution
            </div>
            <select id="spendingPeriod" class="form-select form-select-sm" style="width: auto;">
              <option value="month">This Month</option>
              <option value="quarter">This Quarter</option>
              <option value="year">This Year</option>
            </select>
          </div>
          <canvas id="spendingChart"></canvas>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">
              <i class="fa fa-line-chart me-2"></i>Income vs Expenses
            </div>
            <select id="trendPeriod" class="form-select form-select-sm" style="width: auto;">
              <option value="6">Last 6 Months</option>
              <option value="12">Last 12 Months</option>
              <option value="24">Last 2 Years</option>
            </select>
          </div>
          <canvas id="incomeExpenseChart"></canvas>
        </div>
      </div>
      
      <!-- Savings Tips -->
      <div class="tips-section">
        <div class="section-header">
          <h4><i class="fa fa-lightbulb me-2 text-warning"></i>Personalized Savings Tips</h4>
          <button id="refreshTipsBtn" class="btn btn-sm btn-outline-warning">
            <i class="fa fa-redo me-1"></i> New Tips
          </button>
        </div>
        <div class="tips-grid" id="tipsGrid">
          <!-- Tips will be populated here -->
        </div>
      </div>
      
      <!-- Limit Alerts -->
      <div class="alerts-section">
        <div class="section-header">
          <h4><i class="fa fa-exclamation-triangle me-2 text-danger"></i>Budget Limit Alerts</h4>
          <button id="manageAlertsBtn" class="btn btn-sm btn-outline-danger">
            <i class="fa fa-cog me-1"></i> Manage Alerts
          </button>
        </div>
        <div class="alerts-grid" id="alertsGrid">
          <!-- Alerts will be populated here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Floating Action Buttons -->
  <div class="floating-actions">
    <div class="floating-btn floating-btn-primary" id="quickBudgetBtn" title="Quick Budget">
      <i class="fa fa-bolt"></i>
    </div>
    <div class="floating-btn floating-btn-success" id="addTransactionBtn" title="Add Transaction">
      <i class="fa fa-plus"></i>
    </div>
    <div class="floating-btn floating-btn-warning" id="aiAssistantBtn" title="AI Assistant">
      <i class="fa fa-robot"></i>
    </div>
  </div>

  <!-- Modals -->
  <!-- Set Budget Modal -->
  <div class="modal fade" id="setBudgetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-piggy-bank me-2"></i>Set Budget Limit</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="budgetForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select id="budgetCategory" class="form-select" required>
                  <option value="">Select Category</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Period</label>
                <select id="budgetPeriod" class="form-select" required>
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Budget Amount</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" id="budgetAmount" class="form-control" step="0.01" min="0" required>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Alert Threshold</label>
                <div class="input-group">
                  <input type="number" id="alertThreshold" class="form-control" value="80" min="0" max="100">
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">Get notified when spending reaches this percentage</small>
              </div>
              <div class="col-md-12">
                <label class="form-label">Color Code</label>
                <div class="d-flex gap-2" id="colorPicker">
                  <div class="color-option" data-color="#6f42c1" style="background: #6f42c1;"></div>
                  <div class="color-option" data-color="#198754" style="background: #198754;"></div>
                  <div class="color-option" data-color="#0dcaf0" style="background: #0dcaf0;"></div>
                  <div class="color-option" data-color="#ffc107" style="background: #ffc107;"></div>
                  <div class="color-option" data-color="#dc3545" style="background: #dc3545;"></div>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Notes</label>
                <textarea id="budgetNotes" class="form-control" rows="3" placeholder="Add notes about this budget..."></textarea>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rolloverBudget" checked>
                  <label class="form-check-label" for="rolloverBudget">
                    Rollover unused amount
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="autoAdjust" checked>
                  <label class="form-check-label" for="autoAdjust">
                    Auto-adjust based on spending
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveBudgetBtn" class="btn btn-primary">
            <i class="fa fa-save me-1"></i> Save Budget
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Forecast Modal -->
  <div class="modal fade" id="forecastModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-chart-line me-2"></i>Financial Forecast Analysis</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div id="forecastAnalysisChart" style="height: 400px;">
                <canvas id="detailedForecastChart"></canvas>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">Forecast Settings</h6>
                  <div class="mb-3">
                    <label class="form-label">Forecast Period</label>
                    <select id="forecastPeriod" class="form-select">
                      <option value="3">3 Months</option>
                      <option value="6" selected>6 Months</option>
                      <option value="12">12 Months</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Growth Rate (%)</label>
                    <input type="number" id="growthRate" class="form-control" value="2.5" step="0.1">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Inflation Rate (%)</label>
                    <input type="number" id="inflationRate" class="form-control" value="2.0" step="0.1">
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeSeasonality" checked>
                    <label class="form-check-label" for="includeSeasonality">
                      Include seasonal patterns
                    </label>
                  </div>
                  <button id="runForecastBtn" class="btn btn-primary w-100">
                    <i class="fa fa-play me-1"></i> Run Forecast
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-12">
              <h6>Forecast Insights</h6>
              <div id="forecastInsights" class="row">
                <!-- Insights will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Alerts Modal -->
  <div class="modal fade" id="manageAlertsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-bell me-2"></i>Manage Budget Alerts</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Limit</th>
                  <th>Current</th>
                  <th>Progress</th>
                  <th>Alert</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="alertsTable">
                <!-- Alerts will be populated here -->
              </tbody>
            </table>
          </div>
          <div class="mt-4">
            <h6>Create New Alert</h6>
            <form id="newAlertForm" class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Category</label>
                <select id="alertCategory" class="form-select">
                  <option value="">Select Category</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Limit Amount</label>
                <input type="number" id="alertLimit" class="form-control" step="0.01">
              </div>
              <div class="col-md-4">
                <label class="form-label">Alert Type</label>
                <select id="alertType" class="form-select">
                  <option value="warning">Warning (80%)</option>
                  <option value="danger">Critical (100%)</option>
                </select>
              </div>
              <div class="col-12">
                <button type="button" id="addAlertBtn" class="btn btn-primary">
                  <i class="fa fa-plus me-1"></i> Add Alert
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant Modal -->
  <div class="modal fade" id="aiAssistantModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center gap-3">
            <div class="ai-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--purple-1), var(--accent)); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
              <i class="fa fa-robot"></i>
            </div>
            <div>
              <h5 class="modal-title mb-0">Budget AI Assistant</h5>
              <p class="mb-0 text-muted small">Ask me anything about your budget</p>
            </div>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="chat-container" style="height: 400px; overflow-y: auto; margin-bottom: 20px;" id="aiChat">
            <!-- Chat messages will appear here -->
          </div>
          <div class="input-group">
            <input type="text" id="aiQuestion" class="form-control" placeholder="Ask about budgets, savings tips, or forecasts...">
            <button class="btn btn-primary" id="askAI">
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
          <div class="mt-3">
            <small class="text-muted">Try asking: "How can I save more?", "What's my biggest expense?", "Create a budget plan"</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // State
    let currentUser = null;
    let allTransactions = [];
    let allBudgets = [];
    let allCategories = [];
    let allBanks = [];
    let allAlerts = [];
    let currentTheme = 'light';
    
    // Chart instances
    let forecastChart = null;
    let spendingChart = null;
    let incomeExpenseChart = null;
    let detailedForecastChart = null;
    
    // Current period
    let currentPeriod = 'monthly';

    // DOM refs
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const transactionsBtn = document.getElementById("transactionsBtn");
    const coaBtn = document.getElementById("coaBtn");
    const reportsBtn = document.getElementById("reportsBtn");
    const themeToggle = document.getElementById("themeToggle");
    const refreshBtn = document.getElementById("refreshBtn");
    const newBudgetBtn = document.getElementById("newBudgetBtn");
    const forecastBtn = document.getElementById("forecastBtn");
    const exportDataBtn = document.getElementById("exportDataBtn");
    const printDashboardBtn = document.getElementById("printDashboardBtn");
    const refreshTipsBtn = document.getElementById("refreshTipsBtn");
    const manageAlertsBtn = document.getElementById("manageAlertsBtn");
    const quickBudgetBtn = document.getElementById("quickBudgetBtn");
    const addTransactionBtn = document.getElementById("addTransactionBtn");
    const aiAssistantBtn = document.getElementById("aiAssistantBtn");

    // Modal refs
    const setBudgetModal = new bootstrap.Modal(document.getElementById("setBudgetModal"));
    const forecastModal = new bootstrap.Modal(document.getElementById("forecastModal"));
    const manageAlertsModal = new bootstrap.Modal(document.getElementById("manageAlertsModal"));
    const aiAssistantModal = new bootstrap.Modal(document.getElementById("aiAssistantModal"));

    // Form elements
    const budgetCategory = document.getElementById("budgetCategory");
    const budgetPeriod = document.getElementById("budgetPeriod");
    const budgetAmount = document.getElementById("budgetAmount");
    const alertThreshold = document.getElementById("alertThreshold");
    const budgetNotes = document.getElementById("budgetNotes");
    const saveBudgetBtn = document.getElementById("saveBudgetBtn");
    const runForecastBtn = document.getElementById("runForecastBtn");
    const addAlertBtn = document.getElementById("addAlertBtn");
    const askAI = document.getElementById("askAI");

    // Initialize
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your budget dashboard...");
        
        try {
          loadThemePreference();
          await loadAllData();
          initializeCharts();
          updateDashboard();
          setupEventListeners();
          
          hideLoading();
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          Swal.fire({ 
            icon: 'error', 
            title: 'Loading Error', 
            text: 'Failed to load data. Please refresh the page.' 
          });
        }
      } else {
        Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(()=> {
          window.location.href = "index.html";
        });
      }
    });

    // Helper functions
    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Load all data
    async function loadAllData() {
      await Promise.all([
        loadTransactions(),
        loadBudgets(),
        loadCategories(),
        loadBanks(),
        loadAlerts()
      ]);
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allTransactions = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
          BANK_NAME: d.data().BANK_NAME || d.data().MODE || ""
        }));
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        return false;
      }
    }

    // Load budgets
    async function loadBudgets() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "budgets"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allBudgets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadBudgets error:", err);
        return false;
      }
    }

    // Load categories
    async function loadCategories() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"),
          where("type", "in", ["Expense", "Income", "Asset"])
        );
        
        const snap = await getDocs(q);
        allCategories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadCategories error:", err);
        allCategories = [];
        return false;
      }
    }

    // Load banks
    async function loadBanks() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"),
          where("category", "==", "Bank")
        );
        
        const snap = await getDocs(q);
        allBanks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadBanks error:", err);
        allBanks = [];
        return false;
      }
    }

    // Load alerts
    async function loadAlerts() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "alerts"),
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        allAlerts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        return true;
      } catch (err) {
        console.error("loadAlerts error:", err);
        return false;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
      });

      backBtn.addEventListener("click", () => window.history.back());
      homeBtn.addEventListener("click", () => window.location.href = "home.html");
      transactionsBtn.addEventListener("click", () => window.location.href = "transaction.html");
      coaBtn.addEventListener("click", () => window.location.href = "coa.html");
      reportsBtn.addEventListener("click", () => window.location.href = "reports.html");

      // Theme toggle
      themeToggle.addEventListener("click", toggleTheme);

      // Buttons
      refreshBtn.addEventListener("click", refreshDashboard);
      newBudgetBtn.addEventListener("click", openSetBudgetModal);
      forecastBtn.addEventListener("click", openForecastModal);
      exportDataBtn.addEventListener("click", exportData);
      printDashboardBtn.addEventListener("click", printDashboard);
      refreshTipsBtn.addEventListener("click", generateTips);
      manageAlertsBtn.addEventListener("click", openManageAlertsModal);
      
      // Floating buttons
      quickBudgetBtn.addEventListener("click", quickBudget);
      addTransactionBtn.addEventListener("click", addTransaction);
      aiAssistantBtn.addEventListener("click", openAIAssistant);

      // Form submissions
      saveBudgetBtn.addEventListener("click", saveBudget);
      runForecastBtn.addEventListener("click", runForecast);
      addAlertBtn.addEventListener("click", addAlert);
      askAI.addEventListener("click", askAIQuestion);

      // Period selectors
      document.getElementById('spendingPeriod').addEventListener('change', updateSpendingChart);
      document.getElementById('trendPeriod').addEventListener('change', updateIncomeExpenseChart);
      
      // Forecast tabs
      document.querySelectorAll('.forecast-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.forecast-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          updateForecast(parseInt(this.dataset.period));
        });
      });

      // Color picker
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.color-option').forEach(o => o.style.border = 'none');
          this.style.border = '2px solid var(--text-primary)';
        });
      });
    }

    // Update dashboard
    async function refreshDashboard() {
      showLoading("Refreshing dashboard...");
      await loadAllData();
      updateDashboard();
      hideLoading();
      Swal.fire({ icon: 'success', title: 'Refreshed', text: 'Dashboard updated successfully', timer: 1500 });
    }

    function updateDashboard() {
      updateDashboardStats();
      updateProgressVisualization();
      updateInsightsGrid();
      updateForecastCards();
      updateCharts();
      generateTips();
      updateAlerts();
    }

    // Update dashboard stats
    function updateDashboardStats() {
      const statsContainer = document.getElementById('dashboardStats');
      
      // Calculate stats
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Total budget
      let totalBudget = 0;
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
        }
      });
      
      // Total spent
      let totalSpent = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            totalSpent += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      // Total income
      let totalIncome = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Income') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            totalIncome += parseFloat(tx.INCOME) || 0;
          }
        }
      });
      
      // Remaining budget
      const remainingBudget = totalBudget - totalSpent;
      const remainingPercentage = totalBudget > 0 ? (remainingBudget / totalBudget * 100) : 0;
      
      // Projected savings
      const projectedSavings = totalIncome - totalSpent;
      const savingsRate = totalIncome > 0 ? (projectedSavings / totalIncome * 100) : 0;
      
      // Average daily spending
      const daysInPeriod = getDaysInPeriod();
      const avgDailySpending = totalSpent / daysInPeriod || 0;
      
      // Budget utilization
      const budgetUtilization = totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;
      
      statsContainer.innerHTML = `
        <div class="stat-card-large">
          <div class="stat-label-lg">
            <i class="fa fa-piggy-bank"></i>
            TOTAL BUDGET
          </div>
          <div class="stat-value-lg">$${totalBudget.toFixed(2)}</div>
          <div class="stat-change-lg ${budgetUtilization <= 80 ? 'positive-change' : budgetUtilization <= 100 ? 'neutral-change' : 'negative-change'}">
            ${budgetUtilization.toFixed(1)}% utilized
          </div>
        </div>
        
        <div class="stat-card-large">
          <div class="stat-label-lg">
            <i class="fa fa-money-bill-wave"></i>
            TOTAL SPENT
          </div>
          <div class="stat-value-lg expense-color">$${totalSpent.toFixed(2)}</div>
          <div class="stat-change-lg ${avgDailySpending < 50 ? 'positive-change' : avgDailySpending < 100 ? 'neutral-change' : 'negative-change'}">
            $${avgDailySpending.toFixed(2)}/day
          </div>
        </div>
        
        <div class="stat-card-large">
          <div class="stat-label-lg">
            <i class="fa fa-wallet"></i>
            REMAINING BUDGET
          </div>
          <div class="stat-value-lg ${remainingBudget >= 0 ? 'success-color' : 'danger-color'}">$${remainingBudget.toFixed(2)}</div>
          <div class="stat-change-lg ${remainingPercentage >= 20 ? 'positive-change' : remainingPercentage > 0 ? 'neutral-change' : 'negative-change'}">
            ${remainingPercentage.toFixed(1)}% remaining
          </div>
        </div>
        
        <div class="stat-card-large">
          <div class="stat-label-lg">
            <i class="fa fa-chart-line"></i>
            PROJECTED SAVINGS
          </div>
          <div class="stat-value-lg ${projectedSavings >= 0 ? 'info-color' : 'danger-color'}">$${projectedSavings.toFixed(2)}</div>
          <div class="stat-change-lg ${savingsRate >= 20 ? 'positive-change' : savingsRate >= 0 ? 'neutral-change' : 'negative-change'}">
            ${savingsRate.toFixed(1)}% savings rate
          </div>
        </div>
      `;
    }

    // Update progress visualization
    function updateProgressVisualization() {
      const progressContainer = document.getElementById('progressContainer');
      const progressPeriod = document.getElementById('progressPeriod');
      
      progressPeriod.textContent = `Current Period: ${currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1)}`;
      
      // Filter budgets for current period
      const periodBudgets = allBudgets.filter(budget => budget.period === currentPeriod);
      
      if (periodBudgets.length === 0) {
        progressContainer.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="fa fa-piggy-bank fa-3x mb-3"></i>
            <h5>No budgets set for this period</h5>
            <p>Click "New Budget" to create your first budget</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      periodBudgets.forEach(budget => {
        // Calculate spending for this category
        let categorySpending = 0;
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
            const txDate = new Date(tx.DATE);
            if (isInCurrentPeriod(txDate)) {
              categorySpending += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        const budgetAmount = parseFloat(budget.amount) || 0;
        const spendingPercentage = budgetAmount > 0 ? (categorySpending / budgetAmount * 100) : 0;
        
        // Determine color based on percentage
        let barColor;
        let iconColor;
        if (spendingPercentage <= 60) {
          barColor = '#198754'; // Green
          iconColor = '#198754';
        } else if (spendingPercentage <= 80) {
          barColor = '#ffc107'; // Yellow
          iconColor = '#ffc107';
        } else if (spendingPercentage <= 100) {
          barColor = '#fd7e14'; // Orange
          iconColor = '#fd7e14';
        } else {
          barColor = '#dc3545'; // Red
          iconColor = '#dc3545';
        }
        
        // Get category icon
        const categoryIcon = getCategoryIcon(budget.category);
        
        html += `
          <div class="progress-item">
            <div class="progress-info">
              <div class="progress-category">
                <div class="progress-icon" style="background: ${iconColor}">
                  <i class="fa ${categoryIcon}"></i>
                </div>
                ${escapeHtml(budget.category)}
              </div>
              <div class="progress-amounts">
                <div class="progress-spent">$${categorySpending.toFixed(2)}</div>
                <div class="progress-limit">/ $${budgetAmount.toFixed(2)}</div>
              </div>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width: ${Math.min(spendingPercentage, 100)}%; background: ${barColor}">
                <div class="progress-percentage">${spendingPercentage.toFixed(1)}%</div>
              </div>
            </div>
          </div>
        `;
      });
      
      progressContainer.innerHTML = html;
    }

    // Update insights grid
    function updateInsightsGrid() {
      const insightsGrid = document.getElementById('insightsGrid');
      
      // Calculate insights
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Insight 1: Top spending category
      const spendingByCategory = {};
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (isInCurrentPeriod(txDate)) {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            const amount = parseFloat(tx.EXPENSE) || 0;
            spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
          }
        }
      });
      
      let topCategory = 'None';
      let topCategoryAmount = 0;
      if (Object.keys(spendingByCategory).length > 0) {
        [topCategory, topCategoryAmount] = Object.entries(spendingByCategory)
          .sort((a, b) => b[1] - a[1])[0];
      }
      
      // Insight 2: Savings rate
      let totalIncome = 0;
      let totalExpenses = 0;
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (isInCurrentPeriod(txDate)) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalExpenses += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const savings = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? (savings / totalIncome * 100) : 0;
      
      // Insight 3: Budget health
      let totalBudget = 0;
      let totalSpent = 0;
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
          
          let budgetSpent = 0;
          allTransactions.forEach(tx => {
            if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
              const txDate = new Date(tx.DATE);
              if (isInCurrentPeriod(txDate)) {
                budgetSpent += parseFloat(tx.EXPENSE) || 0;
              }
            }
          });
          totalSpent += budgetSpent;
        }
      });
      
      const budgetUtilization = totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;
      
      // Insight 4: Spending trend
      const lastMonthSpending = getSpendingForPeriod(-1);
      const thisMonthSpending = getSpendingForPeriod(0);
      const spendingChange = lastMonthSpending > 0 ? ((thisMonthSpending - lastMonthSpending) / lastMonthSpending * 100) : 0;
      
      insightsGrid.innerHTML = `
        <div class="insight-card" onclick="showCategoryDetail('${escapeHtml(topCategory)}')">
          <div class="insight-header">
            <div class="insight-icon" style="background: linear-gradient(135deg, #dc3545, #a71d2a)">
              <i class="fa fa-chart-pie"></i>
            </div>
            <span class="insight-badge ${topCategoryAmount > 500 ? 'danger' : 'warning'}">
              ${topCategoryAmount > 500 ? 'High' : 'Medium'}
            </span>
          </div>
          <div class="insight-title">Top Spending Category</div>
          <div class="insight-value expense-color">${escapeHtml(topCategory)}</div>
          <div class="insight-desc">Spent $${topCategoryAmount.toFixed(2)} this period</div>
        </div>
        
        <div class="insight-card" onclick="showSavingsDetail()">
          <div class="insight-header">
            <div class="insight-icon" style="background: linear-gradient(135deg, #198754, #0d6e3d)">
              <i class="fa fa-piggy-bank"></i>
            </div>
            <span class="insight-badge ${savingsRate >= 20 ? 'success' : savingsRate >= 0 ? 'warning' : 'danger'}">
              ${savingsRate >= 20 ? 'Good' : savingsRate >= 0 ? 'Fair' : 'Poor'}
            </span>
          </div>
          <div class="insight-title">Savings Rate</div>
          <div class="insight-value ${savingsRate >= 0 ? 'success-color' : 'danger-color'}">${savingsRate.toFixed(1)}%</div>
          <div class="insight-desc">${savings >= 0 ? 'Saving' : 'Overspending'} $${Math.abs(savings).toFixed(2)}</div>
        </div>
        
        <div class="insight-card" onclick="showBudgetHealth()">
          <div class="insight-header">
            <div class="insight-icon" style="background: linear-gradient(135deg, #0dcaf0, #0a8fa3)">
              <i class="fa fa-heartbeat"></i>
            </div>
            <span class="insight-badge ${budgetUtilization <= 80 ? 'success' : budgetUtilization <= 100 ? 'warning' : 'danger'}">
              ${budgetUtilization <= 80 ? 'Healthy' : budgetUtilization <= 100 ? 'Warning' : 'Critical'}
            </span>
          </div>
          <div class="insight-title">Budget Health</div>
          <div class="insight-value ${budgetUtilization <= 80 ? 'info-color' : budgetUtilization <= 100 ? 'warning-color' : 'danger-color'}">${budgetUtilization.toFixed(1)}%</div>
          <div class="insight-desc">${budgetUtilization <= 100 ? 'Within' : 'Exceeded'} budget by ${Math.abs(budgetUtilization - 100).toFixed(1)}%</div>
        </div>
        
        <div class="insight-card" onclick="showSpendingTrend()">
          <div class="insight-header">
            <div class="insight-icon" style="background: linear-gradient(135deg, #6f42c1, #4a24d6)">
              <i class="fa fa-chart-line"></i>
            </div>
            <span class="insight-badge ${spendingChange <= 0 ? 'success' : spendingChange <= 10 ? 'warning' : 'danger'}">
              ${spendingChange <= 0 ? 'Decreasing' : 'Increasing'}
            </span>
          </div>
          <div class="insight-title">Spending Trend</div>
          <div class="insight-value ${spendingChange <= 0 ? 'success-color' : 'danger-color'}">${spendingChange.toFixed(1)}%</div>
          <div class="insight-desc">${spendingChange <= 0 ? 'Down' : 'Up'} from last period</div>
        </div>
      `;
    }

    // Update forecast cards
    function updateForecastCards() {
      const forecastCards = document.getElementById('forecastCards');
      const forecastPeriod = parseInt(document.querySelector('.forecast-tab.active')?.dataset.period || 6);
      
      // Calculate forecasts
      const now = new Date();
      
      // Get average monthly income and expenses
      const monthlyData = getMonthlyData(6); // Last 6 months
      const avgMonthlyIncome = monthlyData.reduce((sum, m) => sum + m.income, 0) / monthlyData.length || 0;
      const avgMonthlyExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0) / monthlyData.length || 0;
      
      // Projections
      const projectedIncome = avgMonthlyIncome * forecastPeriod;
      const projectedExpenses = avgMonthlyExpenses * forecastPeriod * 1.02; // 2% monthly growth
      const projectedSavings = projectedIncome - projectedExpenses;
      const projectedGrowth = avgMonthlyIncome > 0 ? ((projectedIncome / (avgMonthlyIncome * forecastPeriod) - 1) * 100) : 0;
      
      forecastCards.innerHTML = `
        <div class="forecast-card">
          <div class="forecast-period">Next ${forecastPeriod} Months</div>
          <div class="forecast-amount income-color">$${projectedIncome.toFixed(2)}</div>
          <div class="forecast-trend">
            <i class="fa fa-arrow-up ${projectedGrowth >= 0 ? 'success-color' : 'danger-color'}"></i>
            <span class="${projectedGrowth >= 0 ? 'success-color' : 'danger-color'}">
              ${projectedGrowth.toFixed(1)}% growth
            </span>
          </div>
          <div class="small text-muted mt-2">Projected Total Income</div>
        </div>
        
        <div class="forecast-card">
          <div class="forecast-period">Next ${forecastPeriod} Months</div>
          <div class="forecast-amount expense-color">$${projectedExpenses.toFixed(2)}</div>
          <div class="forecast-trend">
            <i class="fa fa-arrow-up danger-color"></i>
            <span class="danger-color">2.0% monthly increase</span>
          </div>
          <div class="small text-muted mt-2">Projected Total Expenses</div>
        </div>
        
        <div class="forecast-card">
          <div class="forecast-period">Next ${forecastPeriod} Months</div>
          <div class="forecast-amount ${projectedSavings >= 0 ? 'success-color' : 'danger-color'}">
            $${projectedSavings.toFixed(2)}
          </div>
          <div class="forecast-trend">
            <i class="fa ${projectedSavings >= 0 ? 'fa-arrow-up success-color' : 'fa-arrow-down danger-color'}"></i>
            <span class="${projectedSavings >= 0 ? 'success-color' : 'danger-color'}">
              ${(projectedSavings / projectedIncome * 100).toFixed(1)}% of income
            </span>
          </div>
          <div class="small text-muted mt-2">Projected Net Savings</div>
        </div>
        
        <div class="forecast-card">
          <div class="forecast-period">Monthly Average</div>
          <div class="forecast-amount info-color">$${avgMonthlyIncome.toFixed(2)}</div>
          <div class="forecast-trend">
            <i class="fa fa-chart-bar info-color"></i>
            <span class="info-color">Based on 6 months</span>
          </div>
          <div class="small text-muted mt-2">Historical Monthly Income</div>
        </div>
      `;
      
      updateForecastChart(forecastPeriod);
    }

    // Initialize charts
    function initializeCharts() {
      // Forecast chart
      const forecastCtx = document.getElementById('forecastChart').getContext('2d');
      forecastChart = new Chart(forecastCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Income',
              data: [],
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Expenses',
              data: [],
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: 'var(--text-primary)'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)',
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)'
              }
            }
          }
        }
      });

      // Spending chart
      const spendingCtx = document.getElementById('spendingChart').getContext('2d');
      spendingChart = new Chart(spendingCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [],
            borderColor: 'var(--card-bg)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'var(--text-primary)',
                boxWidth: 12,
                padding: 15
              }
            }
          }
        }
      });

      // Income vs Expense chart
      const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
      incomeExpenseChart = new Chart(incomeExpenseCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Income',
              data: [],
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: '#198754',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: [],
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: '#dc3545',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)',
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'var(--text-primary)'
              }
            }
          }
        }
      });

      // Detailed forecast chart (for modal)
      const detailedForecastCtx = document.getElementById('detailedForecastChart').getContext('2d');
      detailedForecastChart = new Chart(detailedForecastCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Income Forecast',
              data: [],
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Expense Forecast',
              data: [],
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Savings Forecast',
              data: [],
              borderColor: '#0dcaf0',
              backgroundColor: 'rgba(13, 202, 240, 0.1)',
              fill: true,
              tension: 0.4,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)',
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                color: 'var(--border-color)'
              },
              ticks: {
                color: 'var(--text-primary)'
              }
            }
          }
        }
      });
    }

    // Update charts
    function updateCharts() {
      updateSpendingChart();
      updateIncomeExpenseChart();
      updateForecastCards();
    }

    function updateSpendingChart() {
      const period = document.getElementById('spendingPeriod').value;
      const now = new Date();
      
      const spendingByCategory = {};
      let totalSpending = 0;
      
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          let include = false;
          
          switch (period) {
            case 'month':
              include = txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
              break;
            case 'quarter':
              const quarter = Math.floor(now.getMonth() / 3);
              const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
              const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
              include = txDate >= quarterStart && txDate < quarterEnd;
              break;
            case 'year':
              include = txDate.getFullYear() === now.getFullYear();
              break;
          }
          
          if (include) {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            const amount = parseFloat(tx.EXPENSE) || 0;
            spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
            totalSpending += amount;
          }
        }
      });
      
      const sortedCategories = Object.entries(spendingByCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6); // Top 6 categories
      
      const colors = [
        '#6f42c1', '#198754', '#0dcaf0', '#ffc107', '#dc3545', '#fd7e14'
      ];
      
      spendingChart.data.labels = sortedCategories.map(([category]) => category);
      spendingChart.data.datasets[0].data = sortedCategories.map(([_, amount]) => amount);
      spendingChart.data.datasets[0].backgroundColor = colors.slice(0, sortedCategories.length);
      spendingChart.update();
    }

    function updateIncomeExpenseChart() {
      const months = parseInt(document.getElementById('trendPeriod').value) || 6;
      const now = new Date();
      
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        incomeData.push(monthlyIncome);
        expenseData.push(monthlyExpenses);
      }
      
      incomeExpenseChart.data.labels = labels;
      incomeExpenseChart.data.datasets[0].data = incomeData;
      incomeExpenseChart.data.datasets[1].data = expenseData;
      incomeExpenseChart.update();
    }

    function updateForecastChart(months = 6) {
      const now = new Date();
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      
      // Get historical data
      const historicalMonths = Math.min(6, months);
      for (let i = historicalMonths - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        incomeData.push(monthlyIncome);
        expenseData.push(monthlyExpenses);
      }
      
      // Add forecast data
      const avgIncome = incomeData.reduce((a, b) => a + b, 0) / incomeData.length || 0;
      const avgExpenses = expenseData.reduce((a, b) => a + b, 0) / expenseData.length || 0;
      
      for (let i = 1; i <= months - historicalMonths; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        // Simple forecast with growth
        const forecastIncome = avgIncome * (1 + 0.02 * i); // 2% monthly growth
        const forecastExpenses = avgExpenses * (1 + 0.015 * i); // 1.5% monthly growth
        
        incomeData.push(forecastIncome);
        expenseData.push(forecastExpenses);
      }
      
      forecastChart.data.labels = labels;
      forecastChart.data.datasets[0].data = incomeData;
      forecastChart.data.datasets[1].data = expenseData;
      forecastChart.update();
    }

    // Generate tips
    function generateTips() {
      const tipsGrid = document.getElementById('tipsGrid');
      
      const tips = [
        {
          icon: 'fa-car',
          title: 'Reduce Transportation Costs',
          desc: 'Consider carpooling or using public transport to save $50-100 monthly.'
        },
        {
          icon: 'fa-utensils',
          title: 'Meal Planning',
          desc: 'Plan meals weekly to reduce food waste and save up to 30% on groceries.'
        },
        {
          icon: 'fa-bolt',
          title: 'Energy Efficiency',
          desc: 'Switch to LED bulbs and unplug devices to save $20-40 on electricity.'
        },
        {
          icon: 'fa-shopping-cart',
          title: 'Smart Shopping',
          desc: 'Use cashback apps and buy in bulk for frequently used items.'
        },
        {
          icon: 'fa-tv',
          title: 'Streaming Services',
          desc: 'Review and cancel unused subscriptions to save $10-50 monthly.'
        },
        {
          icon: 'fa-piggy-bank',
          title: 'Automate Savings',
          desc: 'Set up automatic transfers to savings account on payday.'
        }
      ];
      
      let html = '';
      tips.forEach(tip => {
        html += `
          <div class="tip-card">
            <div class="tip-icon">
              <i class="fa ${tip.icon}"></i>
            </div>
            <div class="tip-title">${tip.title}</div>
            <div class="tip-desc">${tip.desc}</div>
          </div>
        `;
      });
      
      tipsGrid.innerHTML = html;
    }

    // Update alerts
    function updateAlerts() {
      const alertsGrid = document.getElementById('alertsGrid');
      
      const alerts = [];
      
      // Check budgets for alerts
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          let spent = 0;
          allTransactions.forEach(tx => {
            if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
              const txDate = new Date(tx.DATE);
              if (isInCurrentPeriod(txDate)) {
                spent += parseFloat(tx.EXPENSE) || 0;
              }
            }
          });
          
          const limit = parseFloat(budget.amount) || 0;
          const percentage = limit > 0 ? (spent / limit * 100) : 0;
          const threshold = budget.alertThreshold || 80;
          
          if (percentage >= 100) {
            alerts.push({
              category: budget.category,
              type: 'critical',
              message: `Budget exceeded by $${(spent - limit).toFixed(2)}`,
              percentage: percentage
            });
          } else if (percentage >= threshold) {
            alerts.push({
              category: budget.category,
              type: 'warning',
              message: `Approaching budget limit (${percentage.toFixed(1)}%)`,
              percentage: percentage
            });
          } else if (percentage >= threshold * 0.8) {
            alerts.push({
              category: budget.category,
              type: 'info',
              message: `On track (${percentage.toFixed(1)}% spent)`,
              percentage: percentage
            });
          }
        }
      });
      
      if (alerts.length === 0) {
        alertsGrid.innerHTML = `
          <div class="col-12">
            <div class="alert alert-success">
              <i class="fa fa-check-circle me-2"></i>
              All budgets are within limits. Great job!
            </div>
          </div>
        `;
        return;
      }
      
      let html = '';
      alerts.forEach(alert => {
        html += `
          <div class="alert-card ${alert.type}">
            <div class="alert-header">
              <div class="alert-category">${escapeHtml(alert.category)}</div>
              <span class="alert-badge ${alert.type}">
                ${alert.type === 'critical' ? 'Critical' : alert.type === 'warning' ? 'Warning' : 'Info'}
              </span>
            </div>
            <div class="alert-progress">
              <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: ${alert.percentage}%; background: ${
                  alert.type === 'critical' ? '#dc3545' : 
                  alert.type === 'warning' ? '#ffc107' : '#0dcaf0'
                }">
                  <div class="progress-percentage">${alert.percentage.toFixed(1)}%</div>
                </div>
              </div>
            </div>
            <div class="alert-message">
              <i class="fa fa-exclamation-circle me-1"></i>
              ${alert.message}
            </div>
          </div>
        `;
      });
      
      alertsGrid.innerHTML = html;
    }

    // Helper functions
    function isInCurrentPeriod(date) {
      const now = new Date();
      
      switch (currentPeriod) {
        case 'weekly':
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 7);
          return date >= weekStart && date < weekEnd;
          
        case 'monthly':
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
          
        case 'quarterly':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 1);
          return date >= quarterStart && date < quarterEnd;
          
        case 'yearly':
          return date.getFullYear() === now.getFullYear();
          
        default:
          return true;
      }
    }

    function getDaysInPeriod() {
      const now = new Date();
      
      switch (currentPeriod) {
        case 'weekly':
          return 7;
        case 'monthly':
          return new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        case 'quarterly':
          const quarter = Math.floor(now.getMonth() / 3);
          const quarterStart = new Date(now.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(now.getFullYear(), quarter * 3 + 3, 0);
          return Math.ceil((quarterEnd - quarterStart) / (1000 * 60 * 60 * 24)) + 1;
        case 'yearly':
          return new Date(now.getFullYear(), 11, 31).getDate();
        default:
          return 30;
      }
    }

    function getCategoryIcon(category) {
      const icons = {
        'Food': 'fa-utensils',
        'Transport': 'fa-car',
        'Shopping': 'fa-shopping-cart',
        'Entertainment': 'fa-film',
        'Utilities': 'fa-bolt',
        'Rent': 'fa-home',
        'Healthcare': 'fa-heartbeat',
        'Education': 'fa-graduation-cap',
        'Travel': 'fa-plane',
        'Insurance': 'fa-shield-alt',
        'Taxes': 'fa-file-invoice-dollar',
        'Savings': 'fa-piggy-bank',
        'Investment': 'fa-chart-line',
        'Debt': 'fa-credit-card',
        'Gifts': 'fa-gift',
        'Personal': 'fa-user',
        'Business': 'fa-briefcase',
        'Other': 'fa-ellipsis-h'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (category.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      
      return 'fa-tag';
    }

    function getSpendingForPeriod(offset = 0) {
      const now = new Date();
      const targetDate = new Date(now.getFullYear(), now.getMonth() + offset, 1);
      
      let total = 0;
      allTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === targetDate.getMonth() && txDate.getFullYear() === targetDate.getFullYear()) {
            total += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      return total;
    }

    function getMonthlyData(months = 6) {
      const now = new Date();
      const data = [];
      
      for (let i = months - 1; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        data.push({
          month: date.toLocaleDateString('default', { month: 'short', year: 'numeric' }),
          income: monthlyIncome,
          expenses: monthlyExpenses,
          savings: monthlyIncome - monthlyExpenses
        });
      }
      
      return data;
    }

    // Modal functions
    function openSetBudgetModal() {
      // Populate category dropdown
      budgetCategory.innerHTML = '<option value="">Select Category</option>';
      
      // Get unique categories from transactions
      const categories = new Set();
      allTransactions.forEach(tx => {
        if (tx.ACCOUNT_HEADER) {
          categories.add(tx.ACCOUNT_HEADER);
        }
      });
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        budgetCategory.appendChild(option);
      });
      
      // Set default period
      budgetPeriod.value = currentPeriod;
      
      setBudgetModal.show();
    }

    async function saveBudget() {
      const category = budgetCategory.value;
      const period = budgetPeriod.value;
      const amount = budgetAmount.value;
      const threshold = alertThreshold.value;
      const notes = budgetNotes.value;
      const color = document.querySelector('.color-option[style*="border"]')?.dataset.color || '#6f42c1';
      
      if (!category || !amount) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please fill in all required fields' });
        return;
      }
      
      try {
        showLoading("Saving budget...");
        
        const budgetData = {
          category: category,
          period: period,
          amount: parseFloat(amount),
          alertThreshold: parseFloat(threshold) || 80,
          notes: notes,
          color: color,
          rollover: document.getElementById('rolloverBudget').checked,
          autoAdjust: document.getElementById('autoAdjust').checked,
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "budgets"), budgetData);
        
        hideLoading();
        Swal.fire({ icon: 'success', title: 'Success', text: 'Budget saved successfully' });
        setBudgetModal.hide();
        
        await loadBudgets();
        updateDashboard();
      } catch (err) {
        hideLoading();
        console.error("saveBudget error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save budget' });
      }
    }

    function openForecastModal() {
      forecastModal.show();
      updateDetailedForecastChart();
    }

    function updateDetailedForecastChart() {
      const months = 12;
      const now = new Date();
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      const savingsData = [];
      
      // Historical data
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        let monthlyIncome = 0;
        let monthlyExpenses = 0;
        
        allTransactions.forEach(tx => {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
            if (tx.TYPE === 'Income') {
              monthlyIncome += parseFloat(tx.INCOME) || 0;
            } else if (tx.TYPE === 'Expense') {
              monthlyExpenses += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        incomeData.push(monthlyIncome);
        expenseData.push(monthlyExpenses);
        savingsData.push(monthlyIncome - monthlyExpenses);
      }
      
      // Forecast data
      const avgIncome = incomeData.slice(-3).reduce((a, b) => a + b, 0) / 3 || incomeData.reduce((a, b) => a + b, 0) / incomeData.length || 0;
      const avgExpenses = expenseData.slice(-3).reduce((a, b) => a + b, 0) / 3 || expenseData.reduce((a, b) => a + b, 0) / expenseData.length || 0;
      
      for (let i = 1; i <= months - 6; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        labels.push(date.toLocaleDateString('default', { month: 'short' }));
        
        const growthRate = 0.02; // 2% monthly growth
        const inflationRate = 0.015; // 1.5% monthly inflation
        
        const forecastIncome = avgIncome * Math.pow(1 + growthRate, i);
        const forecastExpenses = avgExpenses * Math.pow(1 + inflationRate, i);
        
        incomeData.push(forecastIncome);
        expenseData.push(forecastExpenses);
        savingsData.push(forecastIncome - forecastExpenses);
      }
      
      detailedForecastChart.data.labels = labels;
      detailedForecastChart.data.datasets[0].data = incomeData;
      detailedForecastChart.data.datasets[1].data = expenseData;
      detailedForecastChart.data.datasets[2].data = savingsData;
      detailedForecastChart.update();
      
      // Update insights
      updateForecastInsights();
    }

    function updateForecastInsights() {
      const insightsContainer = document.getElementById('forecastInsights');
      
      const insights = [
        {
          icon: 'fa-arrow-up',
          color: 'success',
          title: 'Income Growth',
          value: '2.5% monthly',
          desc: 'Projected based on historical trends'
        },
        {
          icon: 'fa-arrow-down',
          color: 'danger',
          title: 'Expense Increase',
          value: '1.8% monthly',
          desc: 'Due to inflation and lifestyle changes'
        },
        {
          icon: 'fa-piggy-bank',
          color: 'info',
          title: 'Savings Potential',
          value: '$3,240',
          desc: 'Total projected savings in 12 months'
        },
        {
          icon: 'fa-calendar',
          color: 'warning',
          title: 'Best Savings Month',
          value: 'Month 8',
          desc: 'Highest projected savings month'
        }
      ];
      
      let html = '';
      insights.forEach(insight => {
        html += `
          <div class="col-md-6 mb-3">
            <div class="d-flex align-items-center gap-3 p-3 bg-light rounded">
              <div class="bg-${insight.color} text-white rounded-circle p-3">
                <i class="fa ${insight.icon}"></i>
              </div>
              <div>
                <div class="fw-bold">${insight.title}</div>
                <div class="h5 mb-1">${insight.value}</div>
                <small class="text-muted">${insight.desc}</small>
              </div>
            </div>
          </div>
        `;
      });
      
      insightsContainer.innerHTML = html;
    }

    function runForecast() {
      Swal.fire({ 
        icon: 'success', 
        title: 'Forecast Updated', 
        text: 'Financial forecast has been updated with new parameters',
        timer: 1500 
      });
      updateDetailedForecastChart();
    }

    function openManageAlertsModal() {
      const alertsTable = document.getElementById('alertsTable');
      const alertCategory = document.getElementById('alertCategory');
      
      // Populate category dropdown
      alertCategory.innerHTML = '<option value="">Select Category</option>';
      const categories = new Set();
      allBudgets.forEach(budget => {
        categories.add(budget.category);
      });
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        alertCategory.appendChild(option);
      });
      
      // Populate alerts table
      let html = '';
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          let spent = 0;
          allTransactions.forEach(tx => {
            if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
              const txDate = new Date(tx.DATE);
              if (isInCurrentPeriod(txDate)) {
                spent += parseFloat(tx.EXPENSE) || 0;
              }
            }
          });
          
          const limit = parseFloat(budget.amount) || 0;
          const percentage = limit > 0 ? (spent / limit * 100) : 0;
          const threshold = budget.alertThreshold || 80;
          
          let alertStatus = 'No Alert';
          let statusClass = 'secondary';
          
          if (percentage >= 100) {
            alertStatus = 'Exceeded';
            statusClass = 'danger';
          } else if (percentage >= threshold) {
            alertStatus = 'Warning';
            statusClass = 'warning';
          } else if (percentage >= threshold * 0.8) {
            alertStatus = 'Monitoring';
            statusClass = 'info';
          }
          
          html += `
            <tr>
              <td>${escapeHtml(budget.category)}</td>
              <td>$${limit.toFixed(2)}</td>
              <td>$${spent.toFixed(2)}</td>
              <td>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-${statusClass}" style="width: ${percentage}%"></div>
                </div>
                <small>${percentage.toFixed(1)}%</small>
              </td>
              <td>
                <span class="badge bg-${statusClass}">${alertStatus}</span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fa fa-edit"></i>
                </button>
              </td>
            </tr>
          `;
        }
      });
      
      alertsTable.innerHTML = html || '<tr><td colspan="6" class="text-center">No alerts configured</td></tr>';
      
      manageAlertsModal.show();
    }

    async function addAlert() {
      const category = document.getElementById('alertCategory').value;
      const limit = document.getElementById('alertLimit').value;
      const type = document.getElementById('alertType').value;
      
      if (!category || !limit) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please fill in all fields' });
        return;
      }
      
      try {
        showLoading("Adding alert...");
        
        const alertData = {
          category: category,
          limit: parseFloat(limit),
          type: type,
          period: currentPeriod,
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "alerts"), alertData);
        
        hideLoading();
        Swal.fire({ icon: 'success', title: 'Success', text: 'Alert added successfully' });
        
        await loadAlerts();
        updateAlerts();
      } catch (err) {
        hideLoading();
        console.error("addAlert error:", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add alert' });
      }
    }

    function openAIAssistant() {
      aiAssistantModal.show();
      initializeAIChat();
    }

    function initializeAIChat() {
      const aiChat = document.getElementById('aiChat');
      
      aiChat.innerHTML = `
        <div class="alert alert-info">
          <strong>Budget AI Assistant</strong><br>
          I can help you with:<br>
           Budget planning and optimization<br>
           Savings tips and strategies<br>
           Expense analysis and reduction<br>
           Financial forecasting<br>
           Debt management advice<br><br>
          Try asking: "How can I save more money?" or "Analyze my spending patterns"
        </div>
      `;
    }

    function askAIQuestion() {
      const question = document.getElementById('aiQuestion').value;
      const aiChat = document.getElementById('aiChat');
      
      if (!question.trim()) return;
      
      // Add user question
      aiChat.innerHTML += `
        <div class="text-end mb-2">
          <span class="badge bg-primary p-2">${escapeHtml(question)}</span>
        </div>
      `;
      
      // Clear input
      document.getElementById('aiQuestion').value = '';
      
      // Simulate AI response
      setTimeout(() => {
        const responses = [
          "Based on your spending patterns, I recommend reducing dining out expenses by 30% to save approximately $150 monthly.",
          "Your transportation costs are 25% higher than average. Consider carpooling or using public transport.",
          "Great job on your savings rate! At 18%, you're doing better than the national average of 5%.",
          "I notice you have multiple streaming subscriptions. Consolidating could save you $40 monthly.",
          "Your grocery spending increased by 15% this month. Meal planning could help reduce this.",
          "Consider setting up automatic transfers to savings to ensure consistent savings habits.",
          "Based on your income, you could increase your emergency fund to cover 6 months of expenses.",
          "Your credit card payments are timely - excellent for maintaining a good credit score!",
          "I recommend reviewing your insurance policies annually to ensure you're getting the best rates.",
          "Consider investing 20% of your savings in low-risk mutual funds for better returns."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        aiChat.innerHTML += `
          <div class="mb-2">
            <span class="badge bg-light text-dark p-2">${randomResponse}</span>
          </div>
        `;
        
        // Scroll to bottom
        aiChat.scrollTop = aiChat.scrollHeight;
      }, 1000);
    }

    // Utility functions
    function quickBudget() {
      Swal.fire({
        title: 'Quick Budget Setup',
        html: `
          <div class="text-start">
            <p>Let me help you set up a budget based on your income:</p>
            <div class="mb-3">
              <label class="form-label">Monthly Income</label>
              <input type="number" id="monthlyIncome" class="form-control" placeholder="Enter your monthly income">
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="use50_30_20" checked>
              <label class="form-check-label" for="use50_30_20">
                Use 50/30/20 rule (Needs/Wants/Savings)
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Generate Budget',
        preConfirm: () => {
          const income = parseFloat(document.getElementById('monthlyIncome').value);
          const useRule = document.getElementById('use50_30_20').checked;
          
          if (!income || income <= 0) {
            Swal.showValidationMessage('Please enter a valid income amount');
            return false;
          }
          
          return { income, useRule };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const { income, useRule } = result.value;
          
          if (useRule) {
            // 50/30/20 rule
            const needs = income * 0.5;
            const wants = income * 0.3;
            const savings = income * 0.2;
            
            Swal.fire({
              title: 'Generated Budget Plan',
              html: `
                <div class="text-start">
                  <div class="alert alert-success">
                    <strong>50/30/20 Budget Rule</strong>
                  </div>
                  <div class="row">
                    <div class="col-4">
                      <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                          <h5>50%</h5>
                          <h6>Needs</h6>
                          <h4>$${needs.toFixed(2)}</h4>
                        </div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="card bg-warning">
                        <div class="card-body text-center">
                          <h5>30%</h5>
                          <h6>Wants</h6>
                          <h4>$${wants.toFixed(2)}</h4>
                        </div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="card bg-success text-white">
                        <div class="card-body text-center">
                          <h5>20%</h5>
                          <h6>Savings</h6>
                          <h4>$${savings.toFixed(2)}</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <p><strong>Recommendations:</strong></p>
                    <ul>
                      <li>Needs: Rent, utilities, groceries, transportation</li>
                      <li>Wants: Dining out, entertainment, shopping</li>
                      <li>Savings: Emergency fund, investments, debt repayment</li>
                    </ul>
                  </div>
                </div>
              `,
              width: 600
            });
          }
        }
      });
    }

    function addTransaction() {
      window.location.href = "transaction.html";
    }

    function exportData() {
      const data = {
        budgets: allBudgets,
        transactions: allTransactions.slice(0, 100), // Limit to recent transactions
        summary: getDashboardSummary(),
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `budget-data-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    function printDashboard() {
      window.print();
    }

    function getDashboardSummary() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let totalBudget = 0;
      let totalSpent = 0;
      let totalIncome = 0;
      
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
        }
      });
      
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (isInCurrentPeriod(txDate)) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalSpent += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      return {
        totalBudget,
        totalSpent,
        totalIncome,
        remaining: totalBudget - totalSpent,
        savings: totalIncome - totalSpent,
        period: currentPeriod,
        date: new Date().toLocaleDateString()
      };
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', currentTheme);
      
      // Update charts with new theme
      if (forecastChart) forecastChart.update();
      if (spendingChart) spendingChart.update();
      if (incomeExpenseChart) incomeExpenseChart.update();
      if (detailedForecastChart) detailedForecastChart.update();
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      }
    }

    // Global functions for onclick handlers
    window.showCategoryDetail = function(category) {
      Swal.fire({
        title: `Details: ${category}`,
        html: `
          <div class="text-start">
            <p>Detailed analysis for ${category}:</p>
            ${generateCategoryDetails(category)}
          </div>
        `,
        width: 600
      });
    };

    window.showSavingsDetail = function() {
      const now = new Date();
      let totalIncome = 0;
      let totalExpenses = 0;
      
      allTransactions.forEach(tx => {
        const txDate = new Date(tx.DATE);
        if (isInCurrentPeriod(txDate)) {
          if (tx.TYPE === 'Income') {
            totalIncome += parseFloat(tx.INCOME) || 0;
          } else if (tx.TYPE === 'Expense') {
            totalExpenses += parseFloat(tx.EXPENSE) || 0;
          }
        }
      });
      
      const savings = totalIncome - totalExpenses;
      const savingsRate = totalIncome > 0 ? (savings / totalIncome * 100) : 0;
      
      Swal.fire({
        title: 'Savings Analysis',
        html: `
          <div class="text-start">
            <div class="row">
              <div class="col-6">
                <div class="card bg-success text-white">
                  <div class="card-body">
                    <h6>Total Income</h6>
                    <h3>$${totalIncome.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-danger text-white">
                  <div class="card-body">
                    <h6>Total Expenses</h6>
                    <h3>$${totalExpenses.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3 text-center">
              <h4 class="${savings >= 0 ? 'text-success' : 'text-danger'}">
                ${savings >= 0 ? 'Savings' : 'Deficit'}: $${Math.abs(savings).toFixed(2)}
              </h4>
              <h5>Savings Rate: ${savingsRate.toFixed(1)}%</h5>
              <div class="progress mt-2" style="height: 20px;">
                <div class="progress-bar ${savingsRate >= 20 ? 'bg-success' : savingsRate >= 0 ? 'bg-warning' : 'bg-danger'}" 
                     style="width: ${Math.min(Math.abs(savingsRate), 100)}%">
                  ${savingsRate.toFixed(1)}%
                </div>
              </div>
            </div>
            <div class="mt-3">
              <p><strong>Recommendations:</strong></p>
              <ul>
                ${savingsRate >= 20 ? 
                  '<li>Excellent savings rate! Consider investing for higher returns</li>' :
                  savingsRate >= 10 ?
                  '<li>Good savings rate. Aim for 20% by reducing discretionary spending</li>' :
                  savingsRate >= 0 ?
                  '<li>Consider reducing expenses by 15% to reach a healthier savings rate</li>' :
                  '<li>Immediate action needed. Review and reduce expenses significantly</li>'
                }
              </ul>
            </div>
          </div>
        `,
        width: 700
      });
    };

    window.showBudgetHealth = function() {
      let totalBudget = 0;
      let totalSpent = 0;
      
      allBudgets.forEach(budget => {
        if (budget.period === currentPeriod) {
          totalBudget += parseFloat(budget.amount) || 0;
          
          let budgetSpent = 0;
          allTransactions.forEach(tx => {
            if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === budget.category) {
              const txDate = new Date(tx.DATE);
              if (isInCurrentPeriod(txDate)) {
                budgetSpent += parseFloat(tx.EXPENSE) || 0;
              }
            }
          });
          totalSpent += budgetSpent;
        }
      });
      
      const utilization = totalBudget > 0 ? (totalSpent / totalBudget * 100) : 0;
      
      Swal.fire({
        title: 'Budget Health Analysis',
        html: `
          <div class="text-start">
            <div class="row">
              <div class="col-6">
                <div class="card bg-primary text-white">
                  <div class="card-body">
                    <h6>Total Budget</h6>
                    <h3>$${totalBudget.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card ${utilization <= 100 ? 'bg-warning' : 'bg-danger'} text-white">
                  <div class="card-body">
                    <h6>Total Spent</h6>
                    <h3>$${totalSpent.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <h5>Budget Utilization: ${utilization.toFixed(1)}%</h5>
              <div class="progress mt-2" style="height: 25px;">
                <div class="progress-bar ${utilization <= 80 ? 'bg-success' : utilization <= 100 ? 'bg-warning' : 'bg-danger'}" 
                     style="width: ${Math.min(utilization, 100)}%">
                  ${utilization.toFixed(1)}%
                </div>
              </div>
              <div class="mt-2 d-flex justify-content-between">
                <span>0%</span>
                <span>100%</span>
                <span>${utilization > 100 ? utilization.toFixed(1) + '%' : ''}</span>
              </div>
            </div>
            <div class="mt-3">
              <p><strong>Status:</strong> ${
                utilization <= 80 ? ' Healthy - Well within budget limits' :
                utilization <= 100 ? ' Warning - Approaching budget limits' :
                ' Critical - Budget exceeded'
              }</p>
              <p><strong>Recommendations:</strong></p>
              <ul>
                ${utilization <= 80 ? 
                  '<li>Great budget management! Consider allocating excess to savings</li>' :
                  utilization <= 100 ?
                  '<li>Review discretionary spending to stay within budget</li>' :
                  '<li>Immediate review needed. Consider adjusting budgets or reducing expenses</li>'
                }
              </ul>
            </div>
          </div>
        `,
        width: 700
      });
    };

    window.showSpendingTrend = function() {
      const lastMonth = getSpendingForPeriod(-1);
      const thisMonth = getSpendingForPeriod(0);
      const change = thisMonth - lastMonth;
      const changePercent = lastMonth > 0 ? (change / lastMonth * 100) : 0;
      
      Swal.fire({
        title: 'Spending Trend Analysis',
        html: `
          <div class="text-start">
            <div class="row">
              <div class="col-6">
                <div class="card bg-secondary text-white">
                  <div class="card-body">
                    <h6>Last Period</h6>
                    <h3>$${lastMonth.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card ${change <= 0 ? 'bg-success' : 'bg-danger'} text-white">
                  <div class="card-body">
                    <h6>This Period</h6>
                    <h3>$${thisMonth.toFixed(2)}</h3>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3 text-center">
              <h4 class="${change <= 0 ? 'text-success' : 'text-danger'}">
                ${change <= 0 ? 'Decreased' : 'Increased'} by $${Math.abs(change).toFixed(2)}
              </h4>
              <h5>Change: ${changePercent.toFixed(1)}%</h5>
              <div class="mt-3">
                <canvas id="trendChart" height="150"></canvas>
              </div>
            </div>
            <div class="mt-3">
              <p><strong>Analysis:</strong> ${
                change <= -10 ? 'Significant decrease in spending - Great job!' :
                change <= 0 ? 'Slight decrease in spending - Good trend' :
                change <= 10 ? 'Moderate increase in spending - Monitor closely' :
                'Significant increase in spending - Review expenses'
              }</p>
            </div>
          </div>
        `,
        width: 700,
        didOpen: () => {
          // Create trend chart
          const ctx = document.getElementById('trendChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['3 periods ago', '2 periods ago', 'Last period', 'This period'],
              datasets: [{
                label: 'Spending Trend',
                data: [
                  getSpendingForPeriod(-3),
                  getSpendingForPeriod(-2),
                  lastMonth,
                  thisMonth
                ],
                borderColor: change <= 0 ? '#198754' : '#dc3545',
                backgroundColor: change <= 0 ? 'rgba(25, 135, 84, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + value;
                    }
                  }
                }
              }
            }
          });
        }
      });
    };

    function generateCategoryDetails(category) {
      let totalSpent = 0;
      let transactionCount = 0;
      const monthlySpending = [];
      const now = new Date();
      
      // Calculate last 6 months
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let monthlyTotal = 0;
        
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense' && tx.ACCOUNT_HEADER === category) {
            const txDate = new Date(tx.DATE);
            if (txDate.getMonth() === date.getMonth() && txDate.getFullYear() === date.getFullYear()) {
              monthlyTotal += parseFloat(tx.EXPENSE) || 0;
            }
          }
        });
        
        monthlySpending.push({
          month: date.toLocaleDateString('default', { month: 'short' }),
          amount: monthlyTotal
        });
        
        totalSpent += monthlyTotal;
        if (monthlyTotal > 0) transactionCount++;
      }
      
      // Find any budget for this category
      const categoryBudget = allBudgets.find(b => b.category === category && b.period === currentPeriod);
      const budgetAmount = categoryBudget ? parseFloat(categoryBudget.amount) : 0;
      const utilization = budgetAmount > 0 ? (totalSpent / budgetAmount * 100) : 0;
      
      return `
        <div class="row">
          <div class="col-6">
            <div class="card bg-info text-white">
              <div class="card-body">
                <h6>Total Spent</h6>
                <h3>$${totalSpent.toFixed(2)}</h3>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="card bg-warning">
              <div class="card-body">
                <h6>Transactions</h6>
                <h3>${transactionCount}</h3>
              </div>
            </div>
          </div>
        </div>
        ${budgetAmount > 0 ? `
          <div class="mt-3">
            <h6>Budget: $${budgetAmount.toFixed(2)} (${utilization.toFixed(1)}% used)</h6>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar ${utilization <= 80 ? 'bg-success' : utilization <= 100 ? 'bg-warning' : 'bg-danger'}" 
                   style="width: ${Math.min(utilization, 100)}%">
                ${utilization.toFixed(1)}%
              </div>
            </div>
          </div>
        ` : ''}
        <div class="mt-3">
          <h6>Monthly Spending Trend</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  ${monthlySpending.map(m => `<th>${m.month}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                <tr>
                  ${monthlySpending.map(m => `<td>$${m.amount.toFixed(0)}</td>`).join('')}
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="mt-3">
          <p><strong>Recommendations:</strong></p>
          <ul>
            ${utilization > 100 ? 
              `<li>Budget exceeded by $${(totalSpent - budgetAmount).toFixed(2)}. Review expenses immediately.</li>` :
              utilization > 80 ?
              `<li>Approaching budget limit. Monitor spending closely.</li>` :
              `<li>Within budget. Consider reallocating unused funds.</li>`
            }
            <li>Average monthly spending: $${(totalSpent / 6).toFixed(2)}</li>
            <li>Consider setting up alerts for this category</li>
          </ul>
        </div>
      `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize any additional components
      console.log('Budget Dashboard Initialized');
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>