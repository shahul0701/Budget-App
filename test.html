<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget & Forecasting Dashboard (INR Only)</title>
  
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Date Range Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment/moment.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --secondary-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
      --dark-color: #1f2937;
      --light-color: #f9fafb;
      --gray-color: #6b7280;
      --border-color: #e5e7eb;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      min-height: 100vh;
      color: var(--dark-color);
      line-height: 1.6;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 25px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .dashboard-title i {
      color: var(--primary-color);
      font-size: 36px;
    }

    .section-header {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark-color);
      margin: 40px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-success {
      background: var(--secondary-color);
      color: white;
    }

    .btn-success:hover {
      background: #0da271;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: var(--card-shadow-hover);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--gray-color);
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--border-color);
      color: var(--dark-color);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s, box-shadow 0.3s;
      border-left: 4px solid var(--primary-color);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-shadow-hover);
    }

    .stat-card h3 {
      font-size: 14px;
      color: var(--gray-color);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--dark-color);
    }

    .stat-value.income {
      color: var(--secondary-color);
    }

    .stat-value.expense {
      color: var(--danger-color);
    }

    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      height: 400px;
      display: flex;
      flex-direction: column;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--dark-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      flex: 1;
      position: relative;
    }

    .form-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--card-shadow);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      align-items: flex-end;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      background: white;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Custom date range selector */
    .date-range-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    .date-range-btn {
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 14px;
    }

    .date-range-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .date-range-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .date-range-custom {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 15px;
    }

    .date-range-custom input {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      width: 120px;
    }

    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
    }

    th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    td {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .no-data {
      color: var(--gray-color);
      padding: 40px !important;
    }

    .account-name {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .account-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .account-icon.type-income {
      background: var(--secondary-color);
    }

    .account-icon.type-expense {
      background: var(--danger-color);
    }

    .account-icon.type-investment {
      background: var(--info-color);
    }

    .account-icon.type-savings {
      background: var(--warning-color);
    }

    .budget-type {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .budget-type.type-income {
      background: rgba(16, 185, 129, 0.1);
      color: var(--secondary-color);
    }

    .budget-type.type-expense {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger-color);
    }

    .budget-type.type-investment {
      background: rgba(59, 130, 246, 0.1);
      color: var(--info-color);
    }

    .budget-type.type-savings {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
    }

    .frequency-badge {
      padding: 4px 10px;
      background: #f3f4f6;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-color);
    }

    .amount {
      font-weight: 600;
      font-family: 'Inter', monospace;
    }

    .variance-positive {
      color: var(--secondary-color);
      font-weight: 600;
    }

    .variance-negative {
      color: var(--danger-color);
      font-weight: 600;
    }

    .variance-neutral {
      color: var(--gray-color);
      font-weight: 600;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .progress-container {
      margin: 20px 0;
    }

    .progress {
      height: 28px;
      background: #f3f4f6;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    .progress-bar.success {
      background: linear-gradient(90deg, var(--secondary-color), #34d399);
    }

    .progress-bar.warning {
      background: linear-gradient(90deg, var(--warning-color), #fbbf24);
    }

    .progress-bar.danger {
      background: linear-gradient(90deg, var(--danger-color), #f87171);
    }

    .variance-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .variance-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--card-shadow);
      text-align: center;
      transition: transform 0.3s;
    }

    .variance-card:hover {
      transform: translateY(-5px);
    }

    .variance-card h4 {
      font-size: 14px;
      color: var(--gray-color);
      margin-bottom: 15px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .variance-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .variance-value.positive {
      color: var(--secondary-color);
    }

    .variance-value.negative {
      color: var(--danger-color);
    }

    .forecast-controls {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--card-shadow);
    }

    .forecast-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }

    .investment-summary {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--card-shadow);
    }

    .investment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-top: 25px;
    }

    .investment-card {
      padding: 25px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid var(--border-color);
      transition: transform 0.3s;
    }

    .investment-card:hover {
      transform: translateY(-5px);
    }

    .investment-card h5 {
      color: var(--dark-color);
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: 600;
    }

    .investment-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .investment-card small {
      color: var(--gray-color);
      font-size: 13px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: var(--card-shadow-hover);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 300px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
      border-left: 4px solid var(--primary-color);
    }

    .notification.success {
      border-left-color: var(--secondary-color);
    }

    .notification.error {
      border-left-color: var(--danger-color);
    }

    .notification.info {
      border-left-color: var(--info-color);
    }

    .notification.warning {
      border-left-color: var(--warning-color);
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification-content i {
      font-size: 20px;
    }

    .notification.success .notification-content i {
      color: var(--secondary-color);
    }

    .notification.error .notification-content i {
      color: var(--danger-color);
    }

    .notification.info .notification-content i {
      color: var(--info-color);
    }

    .notification.warning .notification-content i {
      color: var(--warning-color);
    }

    .notification-close {
      background: transparent;
      border: none;
      color: var(--gray-color);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .notification-close:hover {
      background: var(--border-color);
      color: var(--dark-color);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .status-bar {
      padding: 15px 25px;
      background: white;
      border-top: 1px solid var(--border-color);
      text-align: center;
      color: var(--gray-color);
      font-size: 14px;
      margin-top: 30px;
      border-radius: 0 0 12px 12px;
      box-shadow: var(--card-shadow);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--card-shadow-hover);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: var(--dark-color);
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-body {
      margin-bottom: 25px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Budget Rollover Options */
    .rollover-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }

    .rollover-option {
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rollover-option:hover {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .rollover-option.selected {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.1);
    }

    .rollover-option h4 {
      margin-bottom: 5px;
      font-size: 16px;
      color: var(--dark-color);
    }

    .rollover-option p {
      font-size: 14px;
      color: var(--gray-color);
    }

    /* Date Filter Fix */
    .daterangepicker {
      z-index: 9999 !important;
    }

    /* View Mode Toggle */
    .view-toggle-container {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      background: white;
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    .view-toggle-btn {
      padding: 12px 20px;
      border: 2px solid var(--border-color);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.2s;
      flex: 1;
      justify-content: center;
    }

    .view-toggle-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .view-toggle-btn:hover:not(.active) {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    /* Budget Limit Warning */
    .budget-limit-warning {
      padding: 15px 25px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid var(--warning-color);
      border-radius: 8px;
      margin-bottom: 25px;
      color: #92400e;
      display: none;
    }

    .budget-limit-warning.show {
      display: block;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Date Display */
    .date-display {
      font-size: 14px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 12px;
      border-radius: 20px;
      margin-left: 10px;
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .nav-links {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 20px;
        align-items: flex-start;
      }
      
      .action-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .btn {
        flex: 1;
        justify-content: center;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        min-width: 100%;
        height: 350px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-group {
        min-width: 100%;
      }
      
      .forecast-row {
        flex-direction: column;
      }
      
      .notification {
        min-width: auto;
        left: 20px;
        right: 20px;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      
      .view-toggle-container {
        flex-direction: column;
      }
      
      .date-range-selector {
        flex-direction: column;
        align-items: stretch;
      }
      
      .date-range-custom {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .date-range-custom input {
        width: 100%;
      }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global variables
    let allTransactions = [];
    let allBudgets = [];
    let allAccounts = [];
    let forecasts = {};
    let userUID = null;
    let currentCurrency = 'INR';
    let currentViewMode = 'monthly';
    let budgetLimits = {};
    let budgetRolloverSettings = {};
    let currentDateRange = 'monthly';
    
    // Chart instances
    let budgetVsActualChart = null;
    let spendingByCategoryChart = null;
    let forecastChart = null;

    // DOM elements
    const logoutBtn = document.getElementById("logoutBtn");
    const userDisplay = document.getElementById("userDisplay");
    const loadingStatus = document.getElementById("loadingStatus");

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Initializing dashboard (INR Only)...');
      
      try {
        // Set currency to INR only
        currentCurrency = 'INR';
        document.title = 'Budget Dashboard (INR Only)';
        
        // Set default budget period to current month
        const currentMonth = moment().format('YYYY-MM');
        document.getElementById('budgetPeriod').value = currentMonth;
        
        // Remove currency toggle since we only need INR
        removeCurrencyToggle();
        
        // Force all currency displays to show INR
        forceINRDisplay();
        
        // Initialize date range selector (simple version)
        initDateRangeSelector();
        
        // Initialize view mode toggle
        initializeViewModeToggle();
        
        // Add INR indicator to dashboard
        addINRIndicator();
        
        console.log('UI initialized successfully');
        showNotification('Dashboard loading...', 'info');
        
        // Load initial data
        await loadInitialData();
        
        // Generate forecast
        generateForecast();
        
        console.log('Dashboard initialized successfully (INR Only)');
        showNotification('Dashboard loaded successfully!', 'success');
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        showNotification('Error initializing dashboard: ' + error.message, 'error');
      }
    });

    // Add INR indicator to dashboard
    function addINRIndicator() {
      const dashboardTitle = document.querySelector('.dashboard-title');
      if (dashboardTitle && !document.querySelector('.currency-indicator')) {
        const currencyIndicator = document.createElement('span');
        currencyIndicator.className = 'currency-indicator';
        currencyIndicator.style.cssText = 'font-size: 14px; color: var(--secondary-color); margin-left: 10px; padding: 4px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 20px;';
        currencyIndicator.innerHTML = '<i class="fas fa-rupee-sign"></i> INR Only';
        dashboardTitle.appendChild(currencyIndicator);
      }
    }

    // Force INR display throughout the UI
    function forceINRDisplay() {
      // Update all chart titles and labels
      document.querySelectorAll('.chart-title').forEach(title => {
        if (!title.textContent.includes('INR')) {
          title.innerHTML = title.innerHTML + ' <span style="font-size: 12px; color: var(--gray-color);">(INR)</span>';
        }
      });
      
      // Update all section headers
      const headers = document.querySelectorAll('.section-header, .dashboard-title');
      headers.forEach(header => {
        if (!header.innerHTML.includes('INR')) {
          header.innerHTML = header.innerHTML + ' <small style="font-size: 12px; color: var(--gray-color);">(INR)</small>';
        }
      });
      
      // Update all input placeholders
      document.querySelectorAll('input[type="number"]').forEach(input => {
        if (!input.placeholder.includes('₹')) {
          input.placeholder = '₹' + (input.placeholder || '0');
        }
      });
    }

    // Initialize simple date range selector
    function initDateRangeSelector() {
      console.log('Initializing date range selector...');
      
      const dateRangeButtons = document.querySelectorAll('.date-range-btn');
      const customStartDate = document.getElementById('customStartDate');
      const customEndDate = document.getElementById('customEndDate');
      const applyCustomBtn = document.getElementById('applyCustomDate');
      
      // Set default dates for custom range
      const today = moment();
      const oneMonthAgo = moment().subtract(1, 'month');
      
      if (customStartDate) customStartDate.value = oneMonthAgo.format('YYYY-MM-DD');
      if (customEndDate) customEndDate.value = today.format('YYYY-MM-DD');
      
      // Set active button to "Monthly"
      setActiveDateRangeButton('monthly');
      
      // Add event listeners to date range buttons
      dateRangeButtons.forEach(button => {
        button.addEventListener('click', () => {
          const range = button.getAttribute('data-range');
          setActiveDateRangeButton(range);
          applyDateRange(range);
        });
      });
      
      // Add event listener to apply custom date button
      if (applyCustomBtn) {
        applyCustomBtn.addEventListener('click', () => {
          const startDate = customStartDate.value;
          const endDate = customEndDate.value;
          
          if (!startDate || !endDate) {
            showNotification('Please select both start and end dates', 'warning');
            return;
          }
          
          if (moment(startDate).isAfter(moment(endDate))) {
            showNotification('Start date cannot be after end date', 'error');
            return;
          }
          
          setActiveDateRangeButton('custom');
          applyCustomDateRange(startDate, endDate);
        });
      }
      
      // Set initial date range
      applyDateRange('monthly');
      
      console.log('Date range selector initialized successfully');
    }

    // Set active date range button
    function setActiveDateRangeButton(range) {
      currentDateRange = range;
      
      // Remove active class from all buttons
      document.querySelectorAll('.date-range-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to selected button
      const activeBtn = document.querySelector(`.date-range-btn[data-range="${range}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
      
      // Update date display in top bar
      updateDateDisplay();
    }

    // Apply date range
    function applyDateRange(range) {
      let startDate, endDate;
      const today = moment();
      
      switch(range) {
        case 'today':
          startDate = today.clone();
          endDate = today.clone();
          break;
        case 'yesterday':
          startDate = today.clone().subtract(1, 'day');
          endDate = today.clone().subtract(1, 'day');
          break;
        case 'weekly':
          startDate = today.clone().startOf('week');
          endDate = today.clone().endOf('week');
          break;
        case 'biweekly':
          startDate = today.clone().subtract(2, 'weeks');
          endDate = today.clone();
          break;
        case 'monthly':
          startDate = today.clone().startOf('month');
          endDate = today.clone().endOf('month');
          break;
        case 'quarterly':
          startDate = today.clone().startOf('quarter');
          endDate = today.clone().endOf('quarter');
          break;
        case 'yearly':
          startDate = today.clone().startOf('year');
          endDate = today.clone().endOf('year');
          break;
        default:
          startDate = today.clone().startOf('month');
          endDate = today.clone().endOf('month');
      }
      
      // Update dashboard with new date range
      updateDashboardWithDates(startDate, endDate);
    }

    // Apply custom date range
    function applyCustomDateRange(startDateStr, endDateStr) {
      const startDate = moment(startDateStr);
      const endDate = moment(endDateStr);
      
      updateDashboardWithDates(startDate, endDate);
    }

    // Update dashboard with specific dates
    function updateDashboardWithDates(startDate, endDate) {
      // Store dates globally for reference
      window.currentStartDate = startDate;
      window.currentEndDate = endDate;
      
      // Update dashboard
      updateDashboard();
      
      // Show notification
      const format = 'DD/MM/YYYY';
      showNotification(`Date range set to: ${startDate.format(format)} - ${endDate.format(format)}`, 'info');
    }

    // Update date display in top bar
    function updateDateDisplay() {
      const dateDisplay = document.querySelector('.date-display') || createDateDisplay();
      
      if (currentDateRange === 'custom' && window.currentStartDate && window.currentEndDate) {
        dateDisplay.textContent = `${window.currentStartDate.format('DD/MM')} - ${window.currentEndDate.format('DD/MM')}`;
      } else {
        const today = moment();
        let displayText = '';
        
        switch(currentDateRange) {
          case 'today':
            displayText = 'Today';
            break;
          case 'yesterday':
            displayText = 'Yesterday';
            break;
          case 'weekly':
            displayText = 'This Week';
            break;
          case 'biweekly':
            displayText = 'Last 2 Weeks';
            break;
          case 'monthly':
            displayText = 'This Month';
            break;
          case 'quarterly':
            displayText = 'This Quarter';
            break;
          case 'yearly':
            displayText = 'This Year';
            break;
          default:
            displayText = 'This Month';
        }
        
        dateDisplay.textContent = displayText;
      }
    }

    // Create date display element
    function createDateDisplay() {
      const dateDisplay = document.createElement('div');
      dateDisplay.className = 'date-display';
      dateDisplay.innerHTML = '<i class="fas fa-calendar-alt"></i> This Month';
      
      const loadingStatus = document.getElementById('loadingStatus');
      if (loadingStatus && loadingStatus.parentNode) {
        loadingStatus.parentNode.insertBefore(dateDisplay, loadingStatus);
      }
      
      return dateDisplay;
    }

    // Remove currency toggle since we only use INR
    function removeCurrencyToggle() {
      const currencyToggle = document.querySelector('.currency-toggle');
      if (currencyToggle) {
        currencyToggle.remove();
      }
      
      // Also remove any currency switcher buttons or dropdowns
      const currencySwitchers = document.querySelectorAll('[class*="currency"], [id*="Currency"], [class*="usd"], [class*="inr"]');
      currencySwitchers.forEach(element => {
        if (element && element.parentNode && element !== loadingStatus && element !== userDisplay) {
          element.parentNode.removeChild(element);
        }
      });
    }

    // Initialize view mode toggle
    function initializeViewModeToggle() {
      const monthlyBtn = document.getElementById('viewMonthlyBtn');
      const weeklyBtn = document.getElementById('viewWeeklyBtn');
      const generalBtn = document.getElementById('viewGeneralBtn');
      
      if (monthlyBtn) {
        monthlyBtn.addEventListener('click', () => {
          setViewMode('monthly');
          applyDateRange('monthly');
        });
      }
      
      if (weeklyBtn) {
        weeklyBtn.addEventListener('click', () => {
          setViewMode('weekly');
          applyDateRange('weekly');
        });
      }
      
      if (generalBtn) {
        generalBtn.addEventListener('click', () => {
          setViewMode('general');
          applyDateRange('monthly');
        });
      }
      
      // Set initial active state
      setViewMode('monthly');
    }

    // Set view mode
    function setViewMode(mode) {
      currentViewMode = mode;
      
      // Update toggle buttons
      const monthlyBtn = document.getElementById('viewMonthlyBtn');
      const weeklyBtn = document.getElementById('viewWeeklyBtn');
      const generalBtn = document.getElementById('viewGeneralBtn');
      
      if (monthlyBtn) monthlyBtn.classList.remove('active');
      if (weeklyBtn) weeklyBtn.classList.remove('active');
      if (generalBtn) generalBtn.classList.remove('active');
      
      const activeBtn = document.getElementById(`view${mode.charAt(0).toUpperCase() + mode.slice(1)}Btn`);
      if (activeBtn) activeBtn.classList.add('active');
    }

    // Authentication
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Load initial data - OPTIMIZED for faster loading
    async function loadInitialData() {
      return new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async user => {
          if (!user) {
            window.location.href = "login.html";
            return;
          }
          
          userUID = user.uid;
          userDisplay.textContent = user.displayName || user.email || "User";
          loadingStatus.innerHTML = '<span class="loading-spinner"></span> Loading Budget Data...';

          try {
            // Load data in parallel for faster loading
            await Promise.all([
              loadTransactions(user.uid),
              loadBudgets(user.uid)
            ]);
            
            // Load additional data
            await Promise.all([
              loadBudgetLimits(),
              loadRolloverSettings()
            ]);
            
            // Extract unique accounts
            allAccounts = [...new Set(allTransactions.map(tx => tx.ACCOUNT_HEADER || "Uncategorized").filter(Boolean))];
            
            // Populate dropdowns
            populateAccountDropdowns();
            
            // Initialize dashboard
            initializeDashboard();
            
            loadingStatus.textContent = `Loaded ${allTransactions.length} transactions and ${allBudgets.length} budgets`;
            
            // Check for budget rollover
            setTimeout(() => checkBudgetRollover(), 1000);
            
            resolve();
          } catch (error) {
            loadingStatus.textContent = `Error loading data: ${error.message}`;
            console.error("Error loading data:", error);
            showNotification('Error loading data: ' + error.message, 'error');
            reject(error);
          }
        });
      });
    }

    // Load transactions with optimization
    async function loadTransactions(uid) {
      try {
        console.log('Loading transactions...');
        const txSnap = await getDocs(collection(db, "users", uid, "transactions"));
        allTransactions = txSnap.docs.map(doc => {
          const data = doc.data();
          return validateTransactionData({
            id: doc.id,
            ...data
          });
        });
        console.log(`Loaded ${allTransactions.length} transactions`);
      } catch (error) {
        console.error("Error loading transactions:", error);
        allTransactions = [];
        throw error;
      }
    }

    // Validate transaction data - ensure INR amounts
    function validateTransactionData(tx) {
      return {
        ...tx,
        DATE: tx.DATE || new Date().toISOString(),
        INCOME: Math.abs(Number(tx.INCOME) || 0),
        EXPENSE: Math.abs(Number(tx.EXPENSE) || 0),
        ACCOUNT_HEADER: tx.ACCOUNT_HEADER || 'Uncategorized',
        DESCRIPTION: tx.DESCRIPTION || 'No description'
      };
    }

    // Validate INR amount input
    function validateINRAmount(amount) {
      const cleanAmount = String(amount).replace(/[₹$,]/g, '');
      const numAmount = parseFloat(cleanAmount);
      return isNaN(numAmount) ? 0 : numAmount;
    }

    // Load budgets from Firestore
    async function loadBudgets(uid) {
      try {
        console.log('Loading budgets...');
        const budgetsSnap = await getDocs(collection(db, "users", uid, "budgets"));
        allBudgets = budgetsSnap.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            amount: Number(data.amount) || 0
          };
        });
        console.log(`Loaded ${allBudgets.length} budgets`);
      } catch (error) {
        console.error("Error loading budgets:", error);
        allBudgets = [];
        throw error;
      }
    }

    // Load budget limits
    async function loadBudgetLimits() {
      try {
        const limitsSnap = await getDocs(collection(db, "users", userUID, "budgetLimits"));
        budgetLimits = {};
        limitsSnap.docs.forEach(doc => {
          const data = doc.data();
          budgetLimits[data.category] = Number(data.limit) || 0;
        });
        console.log(`Loaded ${Object.keys(budgetLimits).length} budget limits`);
      } catch (error) {
        console.error("Error loading budget limits:", error);
        budgetLimits = {};
      }
    }

    // Load rollover settings
    async function loadRolloverSettings() {
      try {
        const rolloverSnap = await getDocs(collection(db, "users", userUID, "rolloverSettings"));
        budgetRolloverSettings = {};
        rolloverSnap.docs.forEach(doc => {
          const data = doc.data();
          budgetRolloverSettings[data.category] = data;
        });
        console.log(`Loaded ${Object.keys(budgetRolloverSettings).length} rollover settings`);
      } catch (error) {
        console.error("Error loading rollover settings:", error);
        budgetRolloverSettings = {};
      }
    }

    // Check for budget rollover
    async function checkBudgetRollover() {
      const today = moment();
      const currentMonth = today.format('YYYY-MM');
      const lastMonth = today.clone().subtract(1, 'month').format('YYYY-MM');
      
      const lastMonthBudgets = allBudgets.filter(b => b.period === lastMonth && b.frequency === 'Monthly');
      
      if (lastMonthBudgets.length > 0) {
        const currentMonthBudgets = allBudgets.filter(b => b.period === currentMonth);
        
        if (currentMonthBudgets.length === 0) {
          showRolloverModal(lastMonthBudgets, lastMonth, currentMonth);
        }
      }
    }

    // Show rollover modal
    function showRolloverModal(lastMonthBudgets, lastMonth, currentMonth) {
      const modal = document.getElementById('rolloverModal');
      const budgetList = document.getElementById('rolloverBudgetList');
      const rolloverAllBtn = document.getElementById('rolloverAllBtn');
      const rolloverSelectedBtn = document.getElementById('rolloverSelectedBtn');
      const skipRolloverBtn = document.getElementById('skipRolloverBtn');
      
      budgetList.innerHTML = '';
      
      lastMonthBudgets.forEach(budget => {
        const div = document.createElement('div');
        div.className = 'rollover-option';
        div.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" class="budget-checkbox" data-id="${budget.id}" checked style="width: 18px; height: 18px;">
            <div>
              <h4>${budget.account} - ${budget.type}</h4>
              <p>Amount: ${formatCurrency(budget.amount)} | Frequency: ${budget.frequency}</p>
            </div>
          </div>
        `;
        budgetList.appendChild(div);
        
        div.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            const checkbox = div.querySelector('.budget-checkbox');
            checkbox.checked = !checkbox.checked;
            div.classList.toggle('selected', checkbox.checked);
          }
        });
      });
      
      document.getElementById('rolloverModalTitle').innerHTML = `
        <i class="fas fa-sync-alt"></i> Rollover Budgets from ${lastMonth} to ${currentMonth}
      `;
      
      rolloverAllBtn.onclick = () => handleRollover('all', lastMonthBudgets, currentMonth);
      rolloverSelectedBtn.onclick = () => handleRollover('selected', lastMonthBudgets, currentMonth);
      skipRolloverBtn.onclick = () => {
        modal.classList.remove('active');
        showNotification('Skipped budget rollover', 'info');
      };
      
      modal.classList.add('active');
    }

    // Handle budget rollover
    async function handleRollover(type, lastMonthBudgets, currentMonth) {
      const modal = document.getElementById('rolloverModal');
      let budgetsToRollover = [];
      
      if (type === 'all') {
        budgetsToRollover = lastMonthBudgets;
      } else {
        const checkboxes = document.querySelectorAll('.budget-checkbox:checked');
        budgetsToRollover = lastMonthBudgets.filter(budget => 
          Array.from(checkboxes).some(cb => cb.getAttribute('data-id') === budget.id)
        );
      }
      
      let rolledOverCount = 0;
      
      for (const budget of budgetsToRollover) {
        const newBudget = {
          account: budget.account,
          type: budget.type,
          amount: budget.amount,
          frequency: budget.frequency,
          period: currentMonth,
          created: new Date().toISOString(),
          rolledOverFrom: budget.period,
          lastRollover: new Date().toISOString()
        };
        
        const success = await saveBudget(newBudget);
        if (success) rolledOverCount++;
      }
      
      modal.classList.remove('active');
      
      if (rolledOverCount > 0) {
        await loadBudgets(userUID);
        renderBudgetTable();
        updateDashboard();
        showNotification(`Successfully rolled over ${rolledOverCount} budgets to ${currentMonth}`, 'success');
      } else {
        showNotification('No budgets were rolled over', 'warning');
      }
    }

    // Save budget to Firestore
    async function saveBudget(budgetData) {
      try {
        const budgetId = budgetData.id || `budget_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const budgetRef = doc(db, "users", userUID, "budgets", budgetId);
        
        await setDoc(budgetRef, { 
          ...budgetData, 
          id: budgetId, 
          userId: userUID,
          lastUpdated: new Date().toISOString() 
        });
        
        if (!budgetData.id) {
          allBudgets.push({ ...budgetData, id: budgetId });
        } else {
          const index = allBudgets.findIndex(b => b.id === budgetData.id);
          if (index !== -1) {
            allBudgets[index] = { ...budgetData, id: budgetId };
          }
        }
        
        return true;
      } catch (error) {
        console.error("Error saving budget:", error);
        return false;
      }
    }

    // Delete budget
    async function deleteBudget(budgetId) {
      try {
        const budgetRef = doc(db, "users", userUID, "budgets", budgetId);
        await deleteDoc(budgetRef);
        
        allBudgets = allBudgets.filter(b => b.id !== budgetId);
        
        return true;
      } catch (error) {
        console.error("Error deleting budget:", error);
        return false;
      }
    }

    // Save budget limit
    async function saveBudgetLimit(category, limit) {
      try {
        const limitRef = doc(db, "users", userUID, "budgetLimits", category);
        await setDoc(limitRef, { 
          category: category,
          limit: limit,
          userId: userUID,
          lastUpdated: new Date().toISOString() 
        });
        
        budgetLimits[category] = limit;
        return true;
      } catch (error) {
        console.error("Error saving budget limit:", error);
        return false;
      }
    }

    // Save rollover setting
    async function saveRolloverSetting(category, setting) {
      try {
        const rolloverRef = doc(db, "users", userUID, "rolloverSettings", category);
        await setDoc(rolloverRef, { 
          category: category,
          ...setting,
          userId: userUID,
          lastUpdated: new Date().toISOString() 
        });
        
        budgetRolloverSettings[category] = setting;
        return true;
      } catch (error) {
        console.error("Error saving rollover setting:", error);
        return false;
      }
    }

    // Initialize dashboard
    function initializeDashboard() {
      console.log('Initializing dashboard UI...');
      
      updateDashboard();
      renderBudgetTable();
      updateForecastChart();
      updateVarianceAnalysis();
      updateInvestmentSummary();
      updateBudgetLimitWarnings();
      initializeEventListeners();
      
      // Update date display
      updateDateDisplay();
      
      console.log('Dashboard initialized successfully');
    }

    // Initialize event listeners
    function initializeEventListeners() {
      const addBudgetBtn = document.getElementById('addBudgetBtn');
      const exportBudgetsBtn = document.getElementById('exportBudgetsBtn');
      const importBudgetsBtn = document.getElementById('importBudgetsBtn');
      const generateForecastBtn = document.getElementById('generateForecastBtn');
      const setBudgetLimitBtn = document.getElementById('setBudgetLimitBtn');
      const budgetPeriodSelect = document.getElementById('budgetPeriod');
      
      if (addBudgetBtn) addBudgetBtn.addEventListener('click', addNewBudget);
      if (exportBudgetsBtn) exportBudgetsBtn.addEventListener('click', exportBudgets);
      if (importBudgetsBtn) importBudgetsBtn.addEventListener('click', importBudgets);
      if (generateForecastBtn) generateForecastBtn.addEventListener('click', generateForecast);
      if (setBudgetLimitBtn) setBudgetLimitBtn.addEventListener('click', setBudgetLimit);
      
      if (budgetPeriodSelect) {
        budgetPeriodSelect.addEventListener('change', () => {
          renderBudgetTable();
          updateBudgetProgress();
          updateVarianceAnalysis();
          updateInvestmentSummary();
          updateDashboard();
        });
      }
      
      console.log('Event listeners initialized');
    }

    // Update dashboard with current data
    function updateDashboard() {
      console.log('Updating dashboard...');
      
      // Get current date range
      let startDate, endDate;
      
      if (window.currentStartDate && window.currentEndDate) {
        startDate = window.currentStartDate;
        endDate = window.currentEndDate;
      } else {
        // Default to current month
        startDate = moment().startOf('month');
        endDate = moment().endOf('month');
        window.currentStartDate = startDate;
        window.currentEndDate = endDate;
      }
      
      console.log('Date range:', startDate.format('DD/MM/YYYY'), 'to', endDate.format('DD/MM/YYYY'));
      
      // Filter transactions for date range
      const filteredTx = allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = moment(tx.DATE);
        return txDate.isBetween(startDate, endDate, null, '[]');
      });
      
      console.log(`Filtered ${filteredTx.length} transactions for date range`);
      
      // Calculate summary
      const summary = calculateFinancialSummary(filteredTx);
      
      // Update stats
      updateDashboardStats(summary);
      
      // Update charts
      updateBudgetVsActualChart(summary);
      updateSpendingByCategoryChart(filteredTx);
      
      // Update budget progress
      updateBudgetProgress();
      
      // Update budget limit warnings
      updateBudgetLimitWarnings();
    }

    // Calculate financial summary
    function calculateFinancialSummary(transactions) {
      const summary = {
        income: 0,
        expense: 0,
        net: 0,
        byAccount: {},
        byCategory: {}
      };
      
      transactions.forEach(tx => {
        const account = tx.ACCOUNT_HEADER || "Uncategorized";
        const amount = Number(tx.INCOME || 0) - Number(tx.EXPENSE || 0);
        
        if (!summary.byAccount[account]) {
          summary.byAccount[account] = { income: 0, expense: 0, net: 0 };
        }
        
        summary.byAccount[account].income += Number(tx.INCOME || 0);
        summary.byAccount[account].expense += Number(tx.EXPENSE || 0);
        summary.byAccount[account].net += amount;
        
        summary.income += Number(tx.INCOME || 0);
        summary.expense += Number(tx.EXPENSE || 0);
        summary.net += amount;
      });
      
      return summary;
    }

    // Update dashboard statistics
    function updateDashboardStats(summary) {
      const totalIncomeElem = document.getElementById('totalIncome');
      const totalExpenseElem = document.getElementById('totalExpense');
      const netBalanceElem = document.getElementById('netBalance');
      const savingsRateElem = document.getElementById('savingsRate');
      
      if (totalIncomeElem) totalIncomeElem.textContent = formatCurrency(summary.income);
      if (totalExpenseElem) totalExpenseElem.textContent = formatCurrency(summary.expense);
      if (netBalanceElem) netBalanceElem.textContent = formatCurrency(summary.net);
      
      const savingsRate = summary.income > 0 ? ((summary.net / summary.income) * 100).toFixed(1) : 0;
      if (savingsRateElem) savingsRateElem.textContent = savingsRate + '%';
      
      if (netBalanceElem) {
        netBalanceElem.className = 'stat-value ' + (summary.net >= 0 ? 'income' : 'expense');
      }
    }

    // Update Budget vs Actual chart
    function updateBudgetVsActualChart(summary) {
      const ctx = document.getElementById('budgetVsActualChart')?.getContext('2d');
      if (!ctx) return;
      
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const totalBudgetedIncome = periodBudgets
        .filter(b => b.type === 'Income')
        .reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      const totalBudgetedExpense = periodBudgets
        .filter(b => b.type === 'Expense')
        .reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      if (budgetVsActualChart) {
        try {
          budgetVsActualChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      budgetVsActualChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses'],
          datasets: [
            {
              label: 'Budgeted (INR)',
              data: [totalBudgetedIncome, totalBudgetedExpense],
              backgroundColor: 'rgba(99, 102, 241, 0.7)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              label: 'Actual (INR)',
              data: [summary.income, summary.expense],
              backgroundColor: 'rgba(16, 185, 129, 0.7)',
              borderColor: 'rgba(16, 185, 129, 1)',
              borderWidth: 1,
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Amount (INR)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatCurrency(context.parsed);
                  return label;
                }
              }
            }
          }
        }
      });
    }

    // Update spending by category chart
    function updateSpendingByCategoryChart(transactions) {
      const ctx = document.getElementById('spendingByCategoryChart')?.getContext('2d');
      if (!ctx) return;
      
      const categoryData = {};
      transactions.forEach(tx => {
        if (tx.EXPENSE > 0) {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          categoryData[category] = (categoryData[category] || 0) + Number(tx.EXPENSE);
        }
      });
      
      const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      
      const labels = sortedCategories.map(([category]) => category);
      const data = sortedCategories.map(([_, amount]) => amount);
      
      const colors = [
        'rgba(239, 68, 68, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(139, 92, 246, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(249, 115, 22, 0.8)',
        'rgba(6, 182, 212, 0.8)'
      ];
      
      if (spendingByCategoryChart) {
        try {
          spendingByCategoryChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      spendingByCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 1,
            borderColor: 'rgba(255, 255, 255, 0.2)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatCurrency(context.parsed);
                  return label;
                }
              }
            }
          },
          cutout: '70%'
        }
      });
    }

    // Populate account dropdowns
    function populateAccountDropdowns() {
      const accountSelects = document.querySelectorAll('.account-select');
      accountSelects.forEach(select => {
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        allAccounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account;
          option.textContent = account;
          select.appendChild(option);
        });
      });
      
      // Also populate budget limit category
      const limitCategorySelect = document.getElementById('budgetLimitCategory');
      if (limitCategorySelect) {
        while (limitCategorySelect.options.length > 1) {
          limitCategorySelect.remove(1);
        }
        
        allAccounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account;
          option.textContent = account;
          limitCategorySelect.appendChild(option);
        });
      }
    }

    // Render budget table
    function renderBudgetTable() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const tbody = document.getElementById('budgetTableBody');
      
      if (!tbody) return;
      
      if (periodBudgets.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center no-data">No budgets set for ${budgetPeriod}</td></tr>`;
        return;
      }
      
      let html = '';
      periodBudgets.forEach((budget, index) => {
        const actual = calculateActualForBudget(budget);
        const variance = budget.amount - actual;
        const variancePercent = budget.amount > 0 ? (variance / budget.amount * 100).toFixed(1) : 0;
        
        let varianceClass = '';
        let varianceIcon = '';
        if (variance > 0) {
          varianceClass = 'variance-positive';
          varianceIcon = '<i class="fas fa-arrow-down text-success"></i>';
        } else if (variance < 0) {
          varianceClass = 'variance-negative';
          varianceIcon = '<i class="fas fa-arrow-up text-danger"></i>';
        } else {
          varianceClass = 'variance-neutral';
          varianceIcon = '<i class="fas fa-equals text-muted"></i>';
        }
        
        const typeClass = budget.type === 'Income' ? 'type-income' : 
                         budget.type === 'Expense' ? 'type-expense' :
                         budget.type === 'Investment' ? 'type-investment' : 'type-savings';
        
        const rolledOverBadge = budget.rolledOverFrom ? 
          `<span class="frequency-badge" style="background: #e0f2fe; color: #0369a1; margin-left: 5px;">
            <i class="fas fa-sync-alt"></i> Rolled
          </span>` : '';
        
        html += `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td>
              <div class="account-name">
                <span class="account-icon ${typeClass}">
                  <i class="fas ${getBudgetTypeIcon(budget.type)}"></i>
                </span>
                ${budget.account} ${rolledOverBadge}
              </div>
            </td>
            <td><span class="budget-type ${typeClass}">${budget.type}</span></td>
            <td><span class="frequency-badge">${budget.frequency}</span></td>
            <td class="text-right amount">${formatCurrency(budget.amount)}</td>
            <td class="text-right amount">${formatCurrency(actual)}</td>
            <td class="text-right ${varianceClass}">
              ${varianceIcon} ${formatCurrency(Math.abs(variance))} (${Math.abs(variancePercent)}%)
            </td>
            <td class="actions">
              <button class="btn-icon edit-budget" data-id="${budget.id}" title="Edit Budget">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon delete-budget" data-id="${budget.id}" title="Delete Budget">
                <i class="fas fa-trash"></i>
              </button>
              <button class="btn-icon rollover-budget" data-id="${budget.id}" title="Rollover to Next Month">
                <i class="fas fa-forward"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
      
      // Add event listeners
      document.querySelectorAll('.edit-budget').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const budgetId = e.currentTarget.getAttribute('data-id');
          editBudget(budgetId);
        });
      });
      
      document.querySelectorAll('.delete-budget').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const budgetId = e.currentTarget.getAttribute('data-id');
          if (confirm('Are you sure you want to delete this budget?')) {
            await deleteBudget(budgetId);
            renderBudgetTable();
            updateDashboard();
          }
        });
      });
      
      document.querySelectorAll('.rollover-budget').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const budgetId = e.currentTarget.getAttribute('data-id');
          const budget = allBudgets.find(b => b.id === budgetId);
          if (budget) {
            await showSingleBudgetRollover(budget);
          }
        });
      });
    }

    // Get icon for budget type
    function getBudgetTypeIcon(type) {
      switch(type) {
        case 'Income': return 'fa-money-bill-wave';
        case 'Expense': return 'fa-shopping-cart';
        case 'Investment': return 'fa-chart-line';
        case 'Savings': return 'fa-piggy-bank';
        default: return 'fa-dollar-sign';
      }
    }

    // Calculate actual spending for a budget
    function calculateActualForBudget(budget) {
      const budgetPeriod = budget.period;
      const [year, month] = budgetPeriod.split('-').map(Number);
      
      const filteredTx = allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = new Date(tx.DATE);
        return txDate.getFullYear() === year && 
               txDate.getMonth() + 1 === month &&
               tx.ACCOUNT_HEADER === budget.account;
      });
      
      if (budget.type === 'Income') {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.INCOME || 0), 0);
      } else {
        return filteredTx.reduce((sum, tx) => sum + Number(tx.EXPENSE || 0), 0);
      }
    }

    // Update budget progress
    function updateBudgetProgress() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      let totalBudgeted = 0;
      let totalActual = 0;
      
      periodBudgets.forEach(budget => {
        totalBudgeted += Number(budget.amount || 0);
        totalActual += calculateActualForBudget(budget);
      });
      
      const progressPercent = totalBudgeted > 0 ? Math.min(100, (totalActual / totalBudgeted) * 100) : 0;
      const progressBar = document.getElementById('budgetProgressBar');
      if (progressBar) {
        progressBar.style.width = `${progressPercent}%`;
        progressBar.textContent = `${progressPercent.toFixed(1)}%`;
        
        if (progressPercent > 90) {
          progressBar.className = 'progress-bar danger';
        } else if (progressPercent > 75) {
          progressBar.className = 'progress-bar warning';
        } else {
          progressBar.className = 'progress-bar success';
        }
      }
      
      const progressText = document.getElementById('budgetProgressText');
      if (progressText) {
        progressText.textContent = 
          `${formatCurrency(totalActual)} of ${formatCurrency(totalBudgeted)}`;
      }
    }

    // Update budget limit warnings
    function updateBudgetLimitWarnings() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      const warningContainer = document.getElementById('budgetLimitWarning');
      
      if (!warningContainer) return;
      
      let warnings = [];
      
      periodBudgets.forEach(budget => {
        if (budget.type === 'Expense') {
          const actual = calculateActualForBudget(budget);
          const limit = budgetLimits[budget.account] || budget.amount;
          
          if (actual > limit) {
            warnings.push({
              account: budget.account,
              limit: formatCurrency(limit),
              actual: formatCurrency(actual),
              overspend: formatCurrency(actual - limit)
            });
          }
        }
      });
      
      if (warnings.length > 0) {
        let warningHTML = '<strong><i class="fas fa-exclamation-triangle"></i> Budget Limit Exceeded!</strong><br>';
        warnings.forEach(warning => {
          warningHTML += `<div style="margin-top: 5px;">${warning.account}: Limit ${warning.limit}, Actual ${warning.actual} (Overspent: ${warning.overspend})</div>`;
        });
        warningContainer.innerHTML = warningHTML;
        warningContainer.classList.add('show');
      } else {
        warningContainer.classList.remove('show');
      }
    }

    // Show single budget rollover dialog
    async function showSingleBudgetRollover(budget) {
      const nextMonth = moment(budget.period + '-01').add(1, 'month').format('YYYY-MM');
      
      const response = await showConfirmDialog(
        'Rollover Budget',
        `Do you want to rollover "${budget.account}" budget to ${nextMonth}?<br>
        <small>Current amount: ${formatCurrency(budget.amount)}</small>`,
        ['Keep Same Amount', 'Change Amount', 'Skip']
      );
      
      if (response === 'Keep Same Amount') {
        await rolloverBudgetToMonth(budget, nextMonth, budget.amount);
      } else if (response === 'Change Amount') {
        const newAmount = prompt(`Enter new amount for ${nextMonth}:`, budget.amount);
        if (newAmount && !isNaN(newAmount)) {
          await rolloverBudgetToMonth(budget, nextMonth, parseFloat(newAmount));
        }
      }
    }

    // Rollover budget to specific month
    async function rolloverBudgetToMonth(budget, targetMonth, amount) {
      const newBudget = {
        account: budget.account,
        type: budget.type,
        amount: amount,
        frequency: budget.frequency,
        period: targetMonth,
        created: new Date().toISOString(),
        rolledOverFrom: budget.period,
        lastRollover: new Date().toISOString()
      };
      
      const success = await saveBudget(newBudget);
      if (success) {
        showNotification(`Budget rolled over to ${targetMonth}`, 'success');
        renderBudgetTable();
        updateDashboard();
      }
    }

    // Show confirm dialog
    function showConfirmDialog(title, message, buttons) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3><i class="fas fa-question-circle"></i> ${title}</h3>
            </div>
            <div class="modal-body">
              ${message}
            </div>
            <div class="modal-footer">
              ${buttons.map((btn, i) => 
                `<button class="btn ${i === 0 ? 'btn-primary' : i === buttons.length - 1 ? 'btn-outline' : 'btn-warning'}" 
                        data-action="${btn}">${btn}</button>`
              ).join('')}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.target.getAttribute('data-action');
            document.body.removeChild(modal);
            resolve(action);
          });
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            resolve(null);
          }
        });
      });
    }

    // Edit budget
    function editBudget(budgetId) {
      const budget = allBudgets.find(b => b.id === budgetId);
      if (!budget) return;
      
      document.getElementById('newBudgetAccount').value = budget.account;
      document.getElementById('newBudgetType').value = budget.type;
      document.getElementById('newBudgetAmount').value = budget.amount;
      document.getElementById('newBudgetFrequency').value = budget.frequency;
      
      document.getElementById('budgetForm').scrollIntoView({ behavior: 'smooth' });
      
      const addBtn = document.getElementById('addBudgetBtn');
      addBtn.innerHTML = '<i class="fas fa-save"></i> Update Budget';
      addBtn.onclick = async () => {
        await updateExistingBudget(budgetId);
      };
      
      showNotification('Editing budget for ' + budget.account, 'info');
    }

    // Update existing budget
    async function updateExistingBudget(budgetId) {
      const account = document.getElementById('newBudgetAccount').value;
      const type = document.getElementById('newBudgetType').value;
      const rawAmount = document.getElementById('newBudgetAmount').value;
      const frequency = document.getElementById('newBudgetFrequency').value;
      const period = document.getElementById('budgetPeriod').value;
      
      const amount = validateINRAmount(rawAmount);
      
      if (!account || !amount || amount <= 0) {
        alert('Please enter a valid INR amount');
        return;
      }
      
      const budgetData = {
        id: budgetId,
        account,
        type,
        amount,
        frequency,
        period,
        lastUpdated: new Date().toISOString()
      };
      
      const success = await saveBudget(budgetData);
      if (success) {
        document.getElementById('newBudgetAmount').value = '';
        document.getElementById('addBudgetBtn').innerHTML = '<i class="fas fa-plus"></i> Add Budget';
        document.getElementById('addBudgetBtn').onclick = addNewBudget;
        
        renderBudgetTable();
        updateDashboard();
        updateVarianceAnalysis();
        updateInvestmentSummary();
        
        showNotification('Budget updated successfully!', 'success');
      } else {
        showNotification('Error updating budget. Please try again.', 'error');
      }
    }

    // Add new budget
    async function addNewBudget() {
      const account = document.getElementById('newBudgetAccount').value;
      const type = document.getElementById('newBudgetType').value;
      const rawAmount = document.getElementById('newBudgetAmount').value;
      const frequency = document.getElementById('newBudgetFrequency').value;
      const period = document.getElementById('budgetPeriod').value;
      
      const amount = validateINRAmount(rawAmount);
      
      if (!account || !amount || amount <= 0) {
        alert('Please enter a valid INR amount');
        return;
      }
      
      const budgetData = {
        account,
        type,
        amount,
        frequency,
        period,
        created: new Date().toISOString()
      };
      
      const success = await saveBudget(budgetData);
      if (success) {
        document.getElementById('newBudgetAmount').value = '';
        
        if (frequency === 'Monthly') {
          const setRollover = confirm('Do you want to automatically rollover this budget to next month?');
          if (setRollover) {
            await saveRolloverSetting(account, {
              autoRollover: true,
              frequency: 'Monthly',
              lastUpdated: new Date().toISOString()
            });
            showNotification('Auto-rollover enabled for this budget', 'success');
          }
        }
        
        renderBudgetTable();
        updateDashboard();
        updateVarianceAnalysis();
        updateInvestmentSummary();
        
        showNotification('Budget added successfully!', 'success');
      } else {
        showNotification('Error saving budget. Please try again.', 'error');
      }
    }

    // Set budget limit
    async function setBudgetLimit() {
      const category = document.getElementById('budgetLimitCategory').value;
      const rawAmount = document.getElementById('budgetLimitAmount').value;
      
      const limit = validateINRAmount(rawAmount);
      
      if (!category || !limit || limit <= 0) {
        alert('Please enter a valid INR amount');
        return;
      }
      
      const success = await saveBudgetLimit(category, limit);
      if (success) {
        document.getElementById('budgetLimitAmount').value = '';
        updateBudgetLimitWarnings();
        showNotification(`Budget limit set for ${category}: ${formatCurrency(limit)}`, 'success');
      } else {
        showNotification('Error setting budget limit', 'error');
      }
    }

    // Generate forecast
    function generateForecast() {
      const forecastType = document.getElementById('forecastType')?.value || 'monthly';
      const forecastPeriods = parseInt(document.getElementById('forecastPeriods')?.value || 12);
      const forecastMethod = document.getElementById('forecastMethod')?.value || 'average';
      
      forecasts = calculateForecast(forecastType, forecastPeriods, forecastMethod);
      updateForecastChart();
    }

    // Calculate forecast
    function calculateForecast(type, periods, method) {
      const forecastData = {
        labels: [],
        data: []
      };
      
      const historicalData = getHistoricalData(type);
      const startDate = moment();
      
      for (let i = 0; i < periods; i++) {
        let label;
        if (type === 'monthly') {
          label = startDate.clone().add(i, 'months').format('MMM YYYY');
        } else if (type === 'weekly') {
          label = `W${i + 1}`;
        } else if (type === 'quarterly') {
          label = `Q${Math.floor(i / 3) + 1} ${startDate.clone().add(i * 3, 'months').format('YY')}`;
        } else {
          label = `${startDate.clone().add(i, 'years').format('YYYY')}`;
        }
        forecastData.labels.push(label);
      }
      
      if (method === 'average') {
        const avg = historicalData.length > 0 ? 
          historicalData.reduce((a, b) => a + b, 0) / historicalData.length : 0;
        forecastData.data = Array(periods).fill(avg);
      } else if (method === 'trend') {
        if (historicalData.length > 1) {
          const lastValue = historicalData[historicalData.length - 1];
          const growthRate = 0.03;
          forecastData.data = Array(periods).fill(0).map((_, i) => 
            lastValue * Math.pow(1 + growthRate/12, i + 1)
          );
        } else {
          forecastData.data = Array(periods).fill(0);
        }
      } else if (method === 'last') {
        const lastValue = historicalData.length > 0 ? historicalData[historicalData.length - 1] : 0;
        forecastData.data = Array(periods).fill(lastValue);
      }
      
      return forecastData;
    }

    // Get historical data for forecasting
    function getHistoricalData(type) {
      const data = [];
      const now = moment();
      
      for (let i = 11; i >= 0; i--) {
        let periodStart, periodEnd;
        
        if (type === 'monthly') {
          periodStart = now.clone().subtract(i, 'months').startOf('month');
          periodEnd = now.clone().subtract(i, 'months').endOf('month');
        } else if (type === 'weekly') {
          periodStart = now.clone().subtract(i, 'weeks').startOf('week');
          periodEnd = now.clone().subtract(i, 'weeks').endOf('week');
        } else if (type === 'quarterly') {
          periodStart = now.clone().subtract(i * 3, 'months').startOf('quarter');
          periodEnd = now.clone().subtract(i * 3, 'months').endOf('quarter');
        } else {
          periodStart = now.clone().subtract(i, 'years').startOf('year');
          periodEnd = now.clone().subtract(i, 'years').endOf('year');
        }
        
        const periodTotal = allTransactions
          .filter(tx => {
            if (!tx.DATE) return false;
            const txDate = moment(tx.DATE);
            return txDate.isBetween(periodStart, periodEnd, null, '[]');
          })
          .reduce((sum, tx) => sum + Number(tx.INCOME || 0) - Number(tx.EXPENSE || 0), 0);
        
        data.push(periodTotal);
      }
      
      return data;
    }

    // Update forecast chart
    function updateForecastChart() {
      const ctx = document.getElementById('forecastChart')?.getContext('2d');
      if (!ctx) return;
      
      if (forecastChart) {
        try {
          forecastChart.destroy();
        } catch (e) {
          console.log("Error destroying chart:", e);
        }
      }
      
      forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: forecasts.labels || [],
          datasets: [{
            label: 'Forecasted Net Balance (INR)',
            data: forecasts.data || [],
            borderColor: 'rgba(139, 92, 246, 1)',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: 'rgba(139, 92, 246, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Forecast: ${formatCurrency(context.parsed)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Amount (INR)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
    }

    // Update variance analysis
    function updateVarianceAnalysis() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      let totalVariance = 0;
      let overBudgetCount = 0;
      let underBudgetCount = 0;
      
      periodBudgets.forEach(budget => {
        const actual = calculateActualForBudget(budget);
        const variance = budget.amount - actual;
        
        if (variance < 0) {
          overBudgetCount++;
        } else if (variance > 0) {
          underBudgetCount++;
        }
        
        totalVariance += variance;
      });
      
      const varianceTotalElem = document.getElementById('varianceTotal');
      const overBudgetCountElem = document.getElementById('overBudgetCount');
      const underBudgetCountElem = document.getElementById('underBudgetCount');
      const onBudgetCountElem = document.getElementById('onBudgetCount');
      
      if (varianceTotalElem) varianceTotalElem.textContent = formatCurrency(totalVariance);
      if (overBudgetCountElem) overBudgetCountElem.textContent = overBudgetCount;
      if (underBudgetCountElem) underBudgetCountElem.textContent = underBudgetCount;
      if (onBudgetCountElem) onBudgetCountElem.textContent = periodBudgets.length - overBudgetCount - underBudgetCount;
      
      if (varianceTotalElem) {
        if (totalVariance >= 0) {
          varianceTotalElem.className = 'variance-value positive';
        } else {
          varianceTotalElem.className = 'variance-value negative';
        }
      }
    }

    // Update investment summary
    function updateInvestmentSummary() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      
      const investmentBudgets = allBudgets.filter(b => 
        b.type === 'Investment' && b.period === budgetPeriod
      );
      
      const totalInvestmentBudget = investmentBudgets.reduce((sum, b) => sum + Number(b.amount || 0), 0);
      
      const [year, month] = budgetPeriod.split('-').map(Number);
      const investmentTransactions = allTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = new Date(tx.DATE);
        return txDate.getFullYear() === year && 
               txDate.getMonth() + 1 === month &&
               (tx.ACCOUNT_HEADER || '').toLowerCase().includes('investment');
      });
      
      const actualInvestment = investmentTransactions.reduce((sum, tx) => sum + Number(tx.EXPENSE || 0), 0);
      const growthRate = 0.07;
      const futureValue = actualInvestment * Math.pow(1 + growthRate/12, 60);
      
      const totalInvestmentsElem = document.getElementById('totalInvestments');
      const monthlyInvestmentElem = document.getElementById('monthlyInvestment');
      const investmentGrowthElem = document.getElementById('investmentGrowth');
      const futureValueElem = document.getElementById('futureValue');
      
      if (totalInvestmentsElem) totalInvestmentsElem.textContent = formatCurrency(actualInvestment * 12);
      if (monthlyInvestmentElem) monthlyInvestmentElem.textContent = formatCurrency(totalInvestmentBudget);
      if (investmentGrowthElem) investmentGrowthElem.textContent = (growthRate * 100).toFixed(1) + '%';
      if (futureValueElem) futureValueElem.textContent = formatCurrency(futureValue);
    }

    // Export budgets to CSV
    function exportBudgets() {
      const budgetPeriod = document.getElementById('budgetPeriod').value;
      const periodBudgets = allBudgets.filter(b => b.period === budgetPeriod);
      
      if (periodBudgets.length === 0) {
        showNotification('No budgets to export for this period', 'warning');
        return;
      }
      
      let csv = 'Account,Type,Frequency,Amount,Period\n';
      periodBudgets.forEach(budget => {
        csv += `"${budget.account}",${budget.type},${budget.frequency},${budget.amount},${budget.period}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `budgets_${budgetPeriod}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showNotification('Budgets exported successfully!', 'success');
    }

    // Import budgets from CSV
    function importBudgets() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv';
      
      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          const csv = event.target.result;
          const lines = csv.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          
          let importedCount = 0;
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            if (values.length < headers.length) continue;
            
            const budgetData = {};
            headers.forEach((header, index) => {
              budgetData[header.toLowerCase()] = values[index];
            });
            
            budgetData.amount = validateINRAmount(budgetData.amount);
            
            if (!budgetData.period) {
              budgetData.period = document.getElementById('budgetPeriod').value;
            }
            
            await saveBudget(budgetData);
            importedCount++;
          }
          
          await loadBudgets(userUID);
          renderBudgetTable();
          updateDashboard();
          updateInvestmentSummary();
          
          showNotification(`Successfully imported ${importedCount} budgets`, 'success');
        };
        
        reader.readAsText(file);
      };
      
      fileInput.click();
    }

    // Format currency - ONLY INR (No USD conversion)
    function formatCurrency(amount) {
      const numAmount = Number(amount) || 0;
      
      return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(numAmount);
    }

    // Show notification
    function showNotification(message, type) {
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        </div>
        <button class="notification-close"><i class="fas fa-times"></i></button>
      `;
      
      document.body.appendChild(notification);
      
      notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.remove();
      });
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

  </script>
</head>
<body>
  <!-- Rollover Modal -->
  <div id="rolloverModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="rolloverModalTitle"><i class="fas fa-sync-alt"></i> Rollover Budgets</h3>
      </div>
      <div class="modal-body">
        <p>You have monthly budgets from previous month that can be rolled over to current month:</p>
        <div id="rolloverBudgetList" class="rollover-options"></div>
      </div>
      <div class="modal-footer">
        <button id="rolloverAllBtn" class="btn btn-primary">Rollover All</button>
        <button id="rolloverSelectedBtn" class="btn btn-warning">Rollover Selected</button>
        <button id="skipRolloverBtn" class="btn btn-outline">Skip</button>
      </div>
    </div>
  </div>

  <div class="top-bar">
    <div class="nav-links">
      <a href="home.html">
        <i class="fas fa-home"></i> Home
      </a>
      <a href="#" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    
    <div id="loadingStatus"><span class="loading-spinner"></span> Loading Dashboard...</div>
    
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <span id="userDisplay">User</span>
      <button id="logoutBtn" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">
        <i class="fas fa-chart-line"></i> Budget & Forecasting Dashboard
      </h1>
      <div class="action-buttons">
        <button id="exportBudgetsBtn" class="btn btn-outline btn-sm">
          <i class="fas fa-download"></i> Export
        </button>
        <button id="importBudgetsBtn" class="btn btn-outline btn-sm">
          <i class="fas fa-upload"></i> Import
        </button>
      </div>
    </div>

    <!-- Date Range Selector -->
    <div class="date-range-selector">
      <button class="date-range-btn" data-range="today">
        <i class="fas fa-calendar-day"></i> Today
      </button>
      <button class="date-range-btn" data-range="yesterday">
        <i class="fas fa-calendar-minus"></i> Yesterday
      </button>
      <button class="date-range-btn" data-range="weekly">
        <i class="fas fa-calendar-week"></i> Weekly
      </button>
      <button class="date-range-btn" data-range="biweekly">
        <i class="fas fa-calendar-alt"></i> Bi-Weekly
      </button>
      <button class="date-range-btn active" data-range="monthly">
        <i class="fas fa-calendar"></i> Monthly
      </button>
      <button class="date-range-btn" data-range="quarterly">
        <i class="fas fa-calendar-check"></i> Quarterly
      </button>
      <button class="date-range-btn" data-range="yearly">
        <i class="fas fa-calendar-star"></i> Yearly
      </button>
      <div class="date-range-custom">
        <input type="date" id="customStartDate" class="form-control">
        <span>to</span>
        <input type="date" id="customEndDate" class="form-control">
        <button id="applyCustomDate" class="btn btn-outline btn-sm">
          <i class="fas fa-check"></i> Apply
        </button>
      </div>
    </div>

    <!-- View Mode Toggle -->
    <div class="view-toggle-container">
      <button id="viewMonthlyBtn" class="view-toggle-btn active">
        <i class="fas fa-calendar-alt"></i> Monthly View
      </button>
      <button id="viewWeeklyBtn" class="view-toggle-btn">
        <i class="fas fa-calendar-week"></i> Weekly View
      </button>
      <button id="viewGeneralBtn" class="view-toggle-btn">
        <i class="fas fa-chart-bar"></i> General View
      </button>
    </div>

    <!-- Budget Limit Warning -->
    <div id="budgetLimitWarning" class="budget-limit-warning"></div>

    <!-- Stats Overview -->
    <div class="stats-container">
      <div class="stat-card">
        <h3>Total Income</h3>
        <div class="stat-value" id="totalIncome">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Total Expenses</h3>
        <div class="stat-value" id="totalExpense">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Net Balance</h3>
        <div class="stat-value" id="netBalance">₹0</div>
      </div>
      <div class="stat-card">
        <h3>Savings Rate</h3>
        <div class="stat-value" id="savingsRate">0%</div>
      </div>
    </div>

    <!-- Budget Limit Setter -->
    <div class="form-container">
      <h3 style="margin-bottom: 20px; color: var(--dark-color); font-size: 18px;">Set Budget Limit</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Category:</label>
          <select id="budgetLimitCategory" class="form-control">
            <option value="">Select Category</option>
          </select>
        </div>
        <div class="form-group">
          <label>Limit Amount (₹):</label>
          <input type="number" id="budgetLimitAmount" class="form-control" placeholder="₹0" step="1" min="0" />
        </div>
        <div class="form-group">
          <button id="setBudgetLimitBtn" class="btn btn-warning" style="height: 46px;">
            <i class="fas fa-bullseye"></i> Set Limit
          </button>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-title">
          <i class="fas fa-balance-scale"></i> Budget vs Actual
        </div>
        <div class="chart-container">
          <canvas id="budgetVsActualChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">
          <i class="fas fa-chart-pie"></i> Spending by Category
        </div>
        <div class="chart-container">
          <canvas id="spendingByCategoryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Budget Management -->
    <h2 class="section-header">
      <i class="fas fa-wallet"></i> Budget Management
    </h2>

    <!-- Budget Period Selector -->
    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>Budget Period:</label>
          <input type="month" id="budgetPeriod" class="form-control" />
        </div>
        <div class="form-group">
          <label>Budget Progress:</label>
          <div class="progress-container">
            <div class="progress">
              <div class="progress-bar" id="budgetProgressBar" style="width: 0%">0%</div>
            </div>
            <div id="budgetProgressText" style="margin-top: 8px; font-size: 13px; color: var(--gray-color);">
              ₹0 of ₹0
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Budget Form -->
    <div class="form-container" id="budgetForm">
      <h3 style="margin-bottom: 20px; color: var(--dark-color); font-size: 18px;">Add New Budget</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Account:</label>
          <select id="newBudgetAccount" class="form-control account-select">
            <option value="">Select Account</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select id="newBudgetType" class="form-control">
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="Investment">Investment</option>
            <option value="Savings">Savings</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount (₹):</label>
          <input type="number" id="newBudgetAmount" class="form-control" placeholder="₹0" step="1" min="0" />
        </div>
        <div class="form-group">
          <label>Frequency:</label>
          <select id="newBudgetFrequency" class="form-control">
            <option value="Monthly">Monthly</option>
            <option value="Weekly">Weekly</option>
            <option value="Bi-Weekly">Bi-Weekly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Yearly">Yearly</option>
            <option value="One-time">One-time</option>
          </select>
        </div>
        <div class="form-group">
          <button id="addBudgetBtn" class="btn btn-primary" style="height: 46px;">
            <i class="fas fa-plus"></i> Add Budget
          </button>
        </div>
      </div>
    </div>

    <!-- Budget Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="text-center">#</th>
            <th>Account</th>
            <th>Type</th>
            <th>Frequency</th>
            <th class="text-right">Budgeted</th>
            <th class="text-right">Actual</th>
            <th class="text-right">Variance</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="budgetTableBody">
          <tr><td colspan="8" class="text-center no-data">Loading budgets...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Variance Analysis -->
    <h2 class="section-header">
      <i class="fas fa-chart-bar"></i> Variance Analysis
    </h2>
    
    <div class="variance-container">
      <div class="variance-card">
        <h4>Total Variance</h4>
        <div class="variance-value" id="varianceTotal">₹0</div>
        <small>Overall Budget Performance</small>
      </div>
      <div class="variance-card">
        <h4>Over Budget</h4>
        <div class="variance-value" id="overBudgetCount">0</div>
        <small>Categories</small>
      </div>
      <div class="variance-card">
        <h4>Under Budget</h4>
        <div class="variance-value" id="underBudgetCount">0</div>
        <small>Categories</small>
      </div>
      <div class="variance-card">
        <h4>On Budget</h4>
        <div class="variance-value" id="onBudgetCount">0</div>
        <small>Categories</small>
      </div>
    </div>

    <!-- Forecasting Section -->
    <h2 class="section-header">
      <i class="fas fa-chart-line"></i> Financial Forecasting
    </h2>

    <div class="forecast-controls">
      <div class="forecast-row">
        <div class="form-group">
          <label>Forecast Type:</label>
          <select id="forecastType" class="form-control">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Periods to Forecast:</label>
          <input type="number" id="forecastPeriods" class="form-control" value="12" min="1" max="60" />
        </div>
        <div class="form-group">
          <label>Forecast Method:</label>
          <select id="forecastMethod" class="form-control">
            <option value="average">Historical Average</option>
            <option value="trend">Trend Analysis</option>
            <option value="last">Last Period</option>
          </select>
        </div>
        <div class="form-group">
          <button id="generateForecastBtn" class="btn btn-warning" style="height: 46px;">
            <i class="fas fa-sync-alt"></i> Generate Forecast
          </button>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">
        <i class="fas fa-project-diagram"></i> Financial Forecast
      </div>
      <div class="chart-container">
        <canvas id="forecastChart"></canvas>
      </div>
    </div>

    <!-- Investment Section -->
    <h2 class="section-header">
      <i class="fas fa-coins"></i> Investment Overview
    </h2>

    <div class="investment-summary">
      <div class="investment-grid">
        <div class="investment-card">
          <h5>Total Investments</h5>
          <div class="value" id="totalInvestments">₹0</div>
          <small>Current Value</small>
        </div>
        <div class="investment-card">
          <h5>Monthly Investment</h5>
          <div class="value" id="monthlyInvestment">₹0</div>
          <small>Budgeted Amount</small>
        </div>
        <div class="investment-card">
          <h5>Investment Growth</h5>
          <div class="value" id="investmentGrowth">0.0%</div>
          <small>Annual Return</small>
        </div>
        <div class="investment-card">
          <h5>Future Value (5 yrs)</h5>
          <div class="value" id="futureValue">₹0</div>
          <small>Projected Value</small>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="dataStatus">Budget Dashboard Ready (INR Only)</span>
    </div>
  </div>

  <script>
    // Additional initialization for dropdowns
    document.addEventListener('DOMContentLoaded', function() {
      // Populate category dropdowns after a short delay to ensure data is loaded
      setTimeout(() => {
        if (typeof allAccounts !== 'undefined' && allAccounts.length > 0) {
          const categories = [...new Set(allAccounts)];
          const categorySelects = document.querySelectorAll('#budgetLimitCategory, #newBudgetAccount');
          
          categorySelects.forEach(select => {
            while (select.options.length > 1) {
              select.remove(1);
            }
            
            categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              select.appendChild(option);
            });
          });
        }
      }, 2000);
    });
  </script>
</body>
</html>
