<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart of Accounts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-left {
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #userInitials {
      background: #007bff;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    #username {
      font-weight: bold;
    }

    #logoutBtn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #a71d2a;
    }

    .container {
      max-width: 1000px;
      margin: 30px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      position: relative;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    .form-group {
      display: flex;
      margin-bottom: 15px;
    }

    .form-group label {
      width: 200px;
      font-weight: bold;
      margin-top: 6px;
    }

    .form-group select,
    .form-group input {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
    }

    button {
      background-color: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background-color: #218838;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f1f1f1;
    }

    .Income {
      color: green;
    }

    .Expense,
    .COGS,
    .OtherExpense {
      color: red;
    }

    .Asset,
    .Liability,
    .Equity,
    .OtherIncome {
      color: #333;
    }

    .action-btn {
      background-color: #007bff;
      margin-right: 5px;
    }

    .action-btn:hover {
      background-color: #0056b3;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .delete-btn:hover {
      background-color: #a71d2a;
    }

    .popup-menu {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      font-size: 14px;
      min-width: 150px;
      border-radius: 4px;
      z-index: 1000;
    }
    .popup-menu a {
      text-decoration: none;
      color: #007bff;
    }
    .popup-menu a:hover {
      text-decoration: underline;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      display: none;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: #28a745;
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.error {
      background-color: #dc3545;
    }

    .toast.warning {
      background-color: #ffc107;
      color: #212529;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Validation error styling */
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }

    .has-error {
      border-color: #dc3545 !important;
    }

    /* Form button group */
    .form-buttons {
      display: flex;
      gap: 10px;
    }

    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal-btn-primary {
      background: #007bff;
      color: white;
    }

    .modal-btn-secondary {
      background: #6c757d;
      color: white;
    }

    .modal-btn-success {
      background: #28a745;
      color: white;
    }

    /* Bank Account Wizard */
    .bank-account-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .bank-account-item h4 {
      margin-top: 0;
      color: #495057;
    }

    /* Expense Categories Checkboxes */
    .expense-categories {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .expense-category {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
    }

    .expense-category:hover {
      background: #e9ecef;
    }

    .expense-category input[type="checkbox"] {
      margin: 0;
    }

    /* Navigation Tour */
    .tour-highlight {
      position: relative;
      z-index: 3000;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 123, 255, 0.8);
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .tour-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 4000;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .tour-popup h3 {
      color: #007bff;
      margin-top: 0;
    }

    .tour-popup p {
      margin: 15px 0;
      line-height: 1.5;
    }

    .tour-progress {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }

    /* Income Type Selection */
    .income-type-selection {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }

    .income-type {
      flex: 1;
      text-align: center;
      padding: 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .income-type:hover {
      border-color: #007bff;
      background: #f8f9fa;
    }

    .income-type.selected {
      border-color: #28a745;
      background: #e8f5e9;
    }

    .income-type i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #495057;
    }

    .income-type.selected i {
      color: #28a745;
    }
  </style>
</head>
<body>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<!-- Setup Wizard Modal -->
<div id="setupWizard" class="modal">
  <div class="modal-content">
    <div class="modal-header">Account Setup Wizard</div>
    <div class="modal-body">
      <div id="wizardStep1">
        <h3>Welcome to Chart of Accounts!</h3>
        <p>Let's set up your accounts step by step.</p>
        <p>This wizard will help you create:</p>
        <ul>
          <li>Bank accounts (Assets)</li>
          <li>Income sources</li>
          <li>Expense categories</li>
        </ul>
      </div>
      <div id="wizardStep2" style="display: none;">
        <h3>Bank Accounts</h3>
        <p>How many bank accounts do you have?</p>
        <input type="number" id="numBankAccounts" min="1" max="10" value="1" style="width: 100px; padding: 10px; font-size: 16px;">
        <div id="bankAccountsContainer" style="margin-top: 20px;"></div>
      </div>
      <div id="wizardStep3" style="display: none;">
        <h3>Income Sources</h3>
        <p>Where do you get your income from?</p>
        <div class="income-type-selection">
          <div class="income-type" data-type="salary">
            <i class="fas fa-money-bill-wave"></i>
            <h4>Salary</h4>
            <p>Regular employment income</p>
          </div>
          <div class="income-type" data-type="business">
            <i class="fas fa-briefcase"></i>
            <h4>Business</h4>
            <p>Business or self-employment</p>
          </div>
        </div>
        <div id="otherIncomeContainer" style="margin-top: 20px; display: none;">
          <label>Other Income Accounts (comma separated):</label>
          <input type="text" id="otherIncomeAccounts" placeholder="e.g., Investments, Rentals, Freelance" style="width: 100%; padding: 8px; margin-top: 5px;">
        </div>
      </div>
      <div id="wizardStep4" style="display: none;">
        <h3>Expense Categories</h3>
        <p>Select your common expense categories:</p>
        <div class="expense-categories">
          <label class="expense-category">
            <input type="checkbox" value="Rent" checked> Rent/Mortgage
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Utilities" checked> Utilities
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Groceries" checked> Groceries
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Transportation" checked> Transportation
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Entertainment" checked> Entertainment
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Healthcare" checked> Healthcare
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Insurance" checked> Insurance
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Education" checked> Education
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Shopping" checked> Shopping
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Travel" checked> Travel
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Dining" checked> Dining Out
          </label>
          <label class="expense-category">
            <input type="checkbox" value="Subscriptions" checked> Subscriptions
          </label>
        </div>
        <div style="margin-top: 15px;">
          <label>Custom Expenses (comma separated):</label>
          <input type="text" id="customExpenses" placeholder="e.g., Gym, Pet Care, Hobbies" style="width: 100%; padding: 8px; margin-top: 5px;">
        </div>
      </div>
      <div id="wizardStep5" style="display: none;">
        <h3>Setup Complete!</h3>
        <p>Your accounts have been created successfully.</p>
        <p>Would you like a quick tour of the interface?</p>
      </div>
    </div>
    <div class="modal-footer">
      <button id="wizardPrev" class="modal-btn modal-btn-secondary" style="display: none;">Previous</button>
      <button id="wizardNext" class="modal-btn modal-btn-primary">Next</button>
      <button id="wizardSkip" class="modal-btn modal-btn-secondary">Skip Setup</button>
      <button id="wizardFinish" class="modal-btn modal-btn-success" style="display: none;">Finish</button>
    </div>
  </div>
</div>

<!-- Navigation Tour Popup -->
<div id="tourPopup" class="tour-popup" style="display: none;">
  <h3 id="tourTitle"></h3>
  <p id="tourDescription"></p>
  <div id="tourProgress" class="tour-progress"></div>
  <div>
    <button id="tourPrev" class="modal-btn modal-btn-secondary">Previous</button>
    <button id="tourNext" class="modal-btn modal-btn-primary">Next</button>
    <button id="tourSkip" class="modal-btn modal-btn-secondary">Skip Tour</button>
  </div>
</div>

<!-- Top Header -->
<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left: 20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <h2>Chart of Accounts</h2>
  <button type="button" id="starterAccountsBtn" style="margin-bottom:20px;">
    üí° Add Common Starter Accounts
  </button>
  <button type="button" id="setupWizardBtn" style="margin-bottom:20px; background-color: #6f42c1;">
    üöÄ Setup Wizard
  </button>
  <button type="button" id="startTourBtn" style="margin-bottom:20px; background-color: #17a2b8;">
    üß≠ Start Tour
  </button>

  <!-- Add/Edit Account Form -->
  <form id="accountForm">
    <input type="hidden" id="accountId" />
    <div class="form-group">
      <label for="accountType">Account Type</label>
      <select id="accountType" required> 
        <option value="">Select Type</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Equity">Equity</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="COGS">Cost of Goods Sold</option>
        <option value="OtherIncome">Other Income</option>
        <option value="OtherExpense">Other Expense</option>
      </select>
      <div id="typeError" class="error-message"></div>
      <small id="typeHint" style="color: gray; display: block; margin-top: 4px;"></small>
    </div>

    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="add-new">‚ûï Add new category...</option>
      </select>
      <div id="categoryError" class="error-message"></div>
      <small id="categoryHint" style="color: gray; display: block; margin-top: 4px;"></small>
    </div>

    <div class="form-group">
      <label for="accountName">Account Name</label>
      <input type="text" id="accountName" placeholder="e.g. Bank Account" required />
      <div id="nameError" class="error-message"></div>
    </div>

    <div class="form-group">
      <label></label>
      <div class="form-buttons">
        <button type="submit" id="submitBtn">Add Account</button>
        <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
      </div>
    </div>
  </form>

  <!-- Account Table -->
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Category</th>
        <th>Account Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="accountsTable">
      <tr id="loadingRow">
        <td colspan="4" style="text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto;"></div>
          <p>Loading accounts...</p>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM Elements
  const accountTypeSelect = document.getElementById("accountType");
  const categorySelect = document.getElementById("category");
  const accountForm = document.getElementById("accountForm");
  const accountsTable = document.getElementById("accountsTable");
  const accountNameInput = document.getElementById("accountName");
  const accountIdInput = document.getElementById("accountId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");
  const starterAccountsBtn = document.getElementById("starterAccountsBtn");
  const setupWizardBtn = document.getElementById("setupWizardBtn");
  const startTourBtn = document.getElementById("startTourBtn");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const toast = document.getElementById("toast");
  const loadingRow = document.getElementById("loadingRow");

  // Modal elements
  const setupWizardModal = document.getElementById("setupWizard");
  const wizardNextBtn = document.getElementById("wizardNext");
  const wizardPrevBtn = document.getElementById("wizardPrev");
  const wizardSkipBtn = document.getElementById("wizardSkip");
  const wizardFinishBtn = document.getElementById("wizardFinish");

  // Tour elements
  const tourPopup = document.getElementById("tourPopup");
  const tourTitle = document.getElementById("tourTitle");
  const tourDescription = document.getElementById("tourDescription");
  const tourProgress = document.getElementById("tourProgress");
  const tourNextBtn = document.getElementById("tourNext");
  const tourPrevBtn = document.getElementById("tourPrev");
  const tourSkipBtn = document.getElementById("tourSkip");

  // Error message elements
  const typeError = document.getElementById("typeError");
  const categoryError = document.getElementById("categoryError");
  const nameError = document.getElementById("nameError");

  let currentUser = null;
  let categories = {};
  let existingAccounts = new Set(); // Store existing account names for duplicate checking
  
  // Setup Wizard State
  let currentWizardStep = 1;
  let selectedIncomeType = '';
  let bankAccountsData = [];
  let selectedExpenses = [];

  // Navigation Tour State
  let currentTourStep = 0;
  const tourSteps = [
    {
      element: '#accountForm',
      title: 'Add New Account',
      description: 'Here you can add new accounts to your chart of accounts. Select the type, category, and name.'
    },
    {
      element: '#accountsTable',
      title: 'Accounts List',
      description: 'This table shows all your accounts. You can edit, delete, or view details for each account.'
    },
    {
      element: '#starterAccountsBtn',
      title: 'Starter Accounts',
      description: 'Click this button to quickly add common starter accounts for your business.'
    },
    {
      element: '#setupWizardBtn',
      title: 'Setup Wizard',
      description: 'Use this wizard for guided setup of bank accounts, income sources, and expenses.'
    }
  ];

  // Toast notification function
  function showToast(message, type = "success") {
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = "block";
    
    setTimeout(() => {
      toast.style.display = "none";
    }, 3000);
  }

  // Show/hide loading overlay
  function showLoading() {
    loadingOverlay.style.display = "flex";
  }

  function hideLoading() {
    loadingOverlay.style.display = "none";
  }

  // Real-time clock
  function updateTime() {
    const now = new Date();
    if (datetimeElem) {
      datetimeElem.textContent = now.toLocaleString();
    }
  }
  setInterval(updateTime, 1000);
  updateTime();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;

      // Save username in localStorage for persistence
      const nameToStore = user.displayName || user.email;
      localStorage.setItem("username", nameToStore);

      // Display name
      const storedUsername = localStorage.getItem("username");
      if (storedUsername) {
        usernameElem.textContent = storedUsername;
        profileCircle.textContent = storedUsername.charAt(0).toUpperCase();
      } else {
        usernameElem.textContent = nameToStore;
        profileCircle.textContent = nameToStore.charAt(0).toUpperCase();
      }

      await init(); // Load categories + accounts
      
      // Check if user has any accounts (show setup wizard if none)
      checkFirstTimeUser();
    } else {
      setTimeout(() => {
        if (!auth.currentUser) {
          alert("You must be logged in.");
          window.location.href = "index.html";
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    localStorage.removeItem("username");
    await signOut(auth);
    window.location.href = "index.html";
  });

  async function checkFirstTimeUser() {
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"), 
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);
      
      if (snapshot.empty && !localStorage.getItem('setupCompleted')) {
        setTimeout(() => {
          showSetupWizard();
        }, 1000);
      }
    } catch (error) {
      console.error("Error checking first-time user:", error);
    }
  }

  // Setup Wizard Functions
  function showSetupWizard() {
    currentWizardStep = 1;
    updateWizardStep();
    setupWizardModal.style.display = "flex";
  }

  function updateWizardStep() {
    // Hide all steps
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`wizardStep${i}`).style.display = "none";
    }
    
    // Show current step
    document.getElementById(`wizardStep${currentWizardStep}`).style.display = "block";
    
    // Update buttons
    wizardPrevBtn.style.display = currentWizardStep > 1 ? "inline-block" : "none";
    wizardNextBtn.style.display = currentWizardStep < 5 ? "inline-block" : "none";
    wizardFinishBtn.style.display = currentWizardStep === 5 ? "inline-block" : "none";
    
    // Load step-specific content
    if (currentWizardStep === 2) {
      generateBankAccountFields();
    }
  }

  function generateBankAccountFields() {
    const numAccounts = parseInt(document.getElementById('numBankAccounts').value) || 1;
    const container = document.getElementById('bankAccountsContainer');
    container.innerHTML = '';
    
    for (let i = 0; i < numAccounts; i++) {
      const div = document.createElement('div');
      div.className = 'bank-account-item';
      div.innerHTML = `
        <h4>Bank Account ${i + 1}</h4>
        <div style="display: grid; gap: 10px; margin-top: 10px;">
          <div>
            <label>Bank Name:</label>
            <input type="text" class="bank-name" placeholder="e.g., Chase, Bank of America" style="width: 100%; padding: 8px;">
          </div>
          <div>
            <label>Account Name:</label>
            <input type="text" class="account-name" placeholder="e.g., Checking Account" style="width: 100%; padding: 8px;">
          </div>
        </div>
      `;
      container.appendChild(div);
    }
  }

  async function saveWizardData() {
    showLoading();
    try {
      // 1. Save bank accounts
      const bankContainers = document.querySelectorAll('.bank-account-item');
      for (const container of bankContainers) {
        const bankName = container.querySelector('.bank-name').value.trim() || 'Bank';
        const accountName = container.querySelector('.account-name').value.trim() || 'Checking Account';
        
        const fullName = `${bankName} - ${accountName}`;
        
        // Check for duplicate
        const duplicateCheck = await getDocs(
          query(
            collection(db, "users", currentUser.uid, "chartOfAccounts"),
            where("userId", "==", currentUser.uid),
            where("type", "==", "Asset"),
            where("name", "==", fullName)
          )
        );

        if (duplicateCheck.empty) {
          await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
            userId: currentUser.uid,
            type: "Asset",
            category: "Bank",
            name: fullName,
            createdAt: serverTimestamp(),
          });
        }
      }

      // 2. Save income accounts
      if (selectedIncomeType === 'salary') {
        await saveAccountIfNotExists("Income", "Salary", "Salary Income");
      } else if (selectedIncomeType === 'business') {
        await saveAccountIfNotExists("Income", "Business", "Business Income");
      }

      // 3. Save other income accounts
      const otherIncomeInput = document.getElementById('otherIncomeAccounts');
      if (otherIncomeInput && otherIncomeInput.value.trim()) {
        const otherIncomes = otherIncomeInput.value.split(',').map(s => s.trim()).filter(s => s);
        for (const income of otherIncomes) {
          await saveAccountIfNotExists("Income", "Other Income", income);
        }
      }

      // 4. Save expense categories
      const expenseCheckboxes = document.querySelectorAll('.expense-categories input[type="checkbox"]:checked');
      for (const checkbox of expenseCheckboxes) {
        await saveAccountIfNotExists("Expense", "General", checkbox.value);
      }

      // 5. Save custom expenses
      const customExpensesInput = document.getElementById('customExpenses');
      if (customExpensesInput && customExpensesInput.value.trim()) {
        const customExpenses = customExpensesInput.value.split(',').map(s => s.trim()).filter(s => s);
        for (const expense of customExpenses) {
          await saveAccountIfNotExists("Expense", "General", expense);
        }
      }

      // Mark setup as completed
      localStorage.setItem('setupCompleted', 'true');
      
      // Reload accounts
      await loadAccounts();
      
      // Close modal
      setupWizardModal.style.display = "none";
      
      // Ask if user wants a tour
      if (confirm("Setup complete! Would you like a quick tour of the interface?")) {
        startNavigationTour();
      }
      
      showToast("Accounts created successfully!");
    } catch (error) {
      showToast("Error saving accounts: " + error.message, "error");
    } finally {
      hideLoading();
    }
  }

  async function saveAccountIfNotExists(type, category, name) {
    const duplicateCheck = await getDocs(
      query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid),
        where("type", "==", type),
        where("name", "==", name)
      )
    );

    if (duplicateCheck.empty) {
      await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
        userId: currentUser.uid,
        type: type,
        category: category,
        name: name,
        createdAt: serverTimestamp(),
      });
      return true;
    }
    return false;
  }

  // Navigation Tour Functions
  function startNavigationTour() {
    currentTourStep = 0;
    showTourStep();
  }

  function showTourStep() {
    // Remove previous highlights
    document.querySelectorAll('.tour-highlight').forEach(el => {
      el.classList.remove('tour-highlight');
    });

    if (currentTourStep < tourSteps.length) {
      const step = tourSteps[currentTourStep];
      
      // Show tour popup
      tourTitle.textContent = step.title;
      tourDescription.textContent = step.description;
      tourProgress.textContent = `Step ${currentTourStep + 1} of ${tourSteps.length}`;
      tourPopup.style.display = 'block';

      // Highlight element
      const element = document.querySelector(step.element);
      if (element) {
        element.classList.add('tour-highlight');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      // Update buttons
      tourPrevBtn.style.display = currentTourStep > 0 ? 'inline-block' : 'none';
      tourNextBtn.textContent = currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next';
    } else {
      endTour();
    }
  }

  function endTour() {
    tourPopup.style.display = 'none';
    document.querySelectorAll('.tour-highlight').forEach(el => {
      el.classList.remove('tour-highlight');
    });
    showToast("Tour completed! You're ready to use the Chart of Accounts.", "success");
  }

  // Event Listeners for Wizard
  wizardNextBtn.addEventListener('click', async () => {
    if (currentWizardStep === 2) {
      // Collect bank account data
      bankAccountsData = [];
      const bankContainers = document.querySelectorAll('.bank-account-item');
      for (const container of bankContainers) {
        const bankName = container.querySelector('.bank-name').value.trim();
        const accountName = container.querySelector('.account-name').value.trim();
        if (bankName || accountName) {
          bankAccountsData.push({ bankName, accountName });
        }
      }
    } else if (currentWizardStep === 3) {
      // Validate income type selection
      if (!selectedIncomeType) {
        showToast("Please select an income type.", "warning");
        return;
      }
    } else if (currentWizardStep === 4) {
      // Collect expense selections
      selectedExpenses = [];
      const checkboxes = document.querySelectorAll('.expense-categories input[type="checkbox"]:checked');
      checkboxes.forEach(cb => selectedExpenses.push(cb.value));
      
      if (selectedExpenses.length === 0) {
        showToast("Please select at least one expense category.", "warning");
        return;
      }
    } else if (currentWizardStep === 5) {
      await saveWizardData();
      return;
    }
    
    currentWizardStep++;
    updateWizardStep();
  });

  wizardPrevBtn.addEventListener('click', () => {
    currentWizardStep--;
    updateWizardStep();
  });

  wizardSkipBtn.addEventListener('click', () => {
    setupWizardModal.style.display = "none";
    localStorage.setItem('setupCompleted', 'true');
  });

  wizardFinishBtn.addEventListener('click', async () => {
    await saveWizardData();
  });

  // Event Listeners for Tour
  tourNextBtn.addEventListener('click', () => {
    currentTourStep++;
    showTourStep();
  });

  tourPrevBtn.addEventListener('click', () => {
    currentTourStep--;
    showTourStep();
  });

  tourSkipBtn.addEventListener('click', endTour);

  // Setup Wizard Button
  setupWizardBtn.addEventListener('click', showSetupWizard);

  // Start Tour Button
  startTourBtn.addEventListener('click', startNavigationTour);

  // Income Type Selection
  document.addEventListener('click', (e) => {
    if (e.target.closest('.income-type')) {
      const incomeType = e.target.closest('.income-type');
      document.querySelectorAll('.income-type').forEach(el => {
        el.classList.remove('selected');
      });
      incomeType.classList.add('selected');
      selectedIncomeType = incomeType.dataset.type;
      
      // Show other income input
      document.getElementById('otherIncomeContainer').style.display = 'block';
    }
  });

  // Update bank account fields when number changes
  document.getElementById('numBankAccounts').addEventListener('change', generateBankAccountFields);

  async function loadCategories() {
    categories = {};
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">‚ûï Add new category...</option>';

    const catSnapshot = await getDocs(
      query(
        collection(db, "users", currentUser.uid, "categories"), 
        where("userId", "==", currentUser.uid)
      )
    );
    
    catSnapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!categories[data.accountType]) categories[data.accountType] = [];
      if (!categories[data.accountType].includes(data.categoryName)) {
        categories[data.accountType].push(data.categoryName);
      }
    });
  }

  const starterAccounts = [
    { type: "Asset", category: "Bank", name: "Bank Account" },
    { type: "Asset", category: "Cash", name: "Petty Cash" },
    { type: "Liability", category: "Credit Card", name: "Credit Card Payable" },
    { type: "Income", category: "Sales", name: "Product Sales" },
    { type: "Expense", category: "Rent", name: "Office Rent" },
    { type: "Expense", category: "Utilities", name: "Electric Bill" },
    { type: "Expense", category: "Supplies", name: "Office Supplies" },
    { type: "COGS", category: "Raw Materials", name: "Materials Purchased" },
    { type: "Equity", category: "Owner's Equity", name: "Owner's Contribution" },
  ];

  starterAccountsBtn.addEventListener("click", async () => {
    if (!currentUser) {
      showToast("You must be logged in!", "error");
      return;
    }

    if (!confirm("Do you want to add common starter accounts?")) return;

    showLoading();
    try {
      for (const acc of starterAccounts) {
        // Check if account already exists
        const duplicateCheck = await getDocs(
          query(
            collection(db, "users", currentUser.uid, "chartOfAccounts"),
            where("userId", "==", currentUser.uid),
            where("type", "==", acc.type),
            where("name", "==", acc.name)
          )
        );

        if (duplicateCheck.empty) {
          await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
            userId: currentUser.uid,
            type: acc.type,
            category: acc.category,
            name: acc.name,
            createdAt: serverTimestamp(),
          });
        }
      }
      await loadAccounts();
      showToast("Starter accounts added successfully!");
    } catch (error) {
      showToast("Error adding starter accounts: " + error.message, "error");
    } finally {
      hideLoading();
    }
  });

  function updateCategoryOptions(type) {
    const defaultCategories = {
      Asset: ["Cash", "Bank", "Accounts Receivable", "Inventory"],
      Liability: ["Accounts Payable", "Loans Payable", "Credit Card"],
      Equity: ["Owner's Equity", "Retained Earnings"],
      Income: ["Sales", "Service Revenue", "Interest Income"],
      Expense: ["Rent", "Utilities", "Supplies", "Salaries", "Travel"],
      COGS: ["Raw Materials", "Direct Labor", "Manufacturing Overhead"],
      OtherIncome: ["Gain on Sale", "Dividend Income"],
      OtherExpense: ["Loss on Sale", "Fines", "Miscellaneous"],
    };

    const typeHints = {
      Asset: "Assets are things you own. e.g., Bank, Inventory, Cash.",
      Liability: "Liabilities are things you owe. e.g., Loans, Credit Cards.",
      Equity: "Owner's stake in the business. e.g., Retained Earnings.",
      Income: "Money you earn. e.g., Sales, Services.",
      Expense: "Costs you pay. e.g., Rent, Utilities, Supplies.",
      COGS: "Costs directly tied to producing goods. e.g., Raw Materials.",
      OtherIncome: "Other money you earn. e.g., Interest, Dividends.",
      OtherExpense: "Other costs. e.g., Fines, Loss on Sale."
    };

    categorySelect.innerHTML = '<option value="">Select Category</option>';
    const userCats = categories[type] || [];
    const combined = [...new Set([...defaultCategories[type] || [], ...userCats])];

    combined.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });

    const addNewOption = document.createElement("option");
    addNewOption.value = "add-new";
    addNewOption.textContent = "‚ûï Add new category...";
    categorySelect.appendChild(addNewOption);

    if(document.getElementById("typeHint")){
      document.getElementById("typeHint").textContent = typeHints[type] || "";
    }
    if(document.getElementById("categoryHint")){
      const firstCategory = combined[0] || "";
      document.getElementById("categoryHint").textContent = firstCategory ? `e.g., ${firstCategory}` : "";
    }
  }

  accountTypeSelect.addEventListener("change", () => {
    const type = accountTypeSelect.value;
    updateCategoryOptions(type);
    categorySelect.value = "";
    clearErrors();
  });

  categorySelect.addEventListener("change", async () => {
    clearErrors();
    if (categorySelect.value === "add-new") {
      if (!accountTypeSelect.value) {
        showToast("Please select Account Type first.", "warning");
        categorySelect.value = "";
        return;
      }
      const newCat = prompt(`Enter new category name for "${accountTypeSelect.value}":`);
      if (newCat && newCat.trim()) {
        const trimmedCat = newCat.trim();
        if (categories[accountTypeSelect.value]?.some(c => c.toLowerCase() === trimmedCat.toLowerCase())) {
          showToast("Category already exists.", "warning");
          categorySelect.value = "";
          return;
        }
        showLoading();
        try {
          await addDoc(collection(db, "users", currentUser.uid, "categories"), {
            userId: currentUser.uid,
            accountType: accountTypeSelect.value,
            categoryName: trimmedCat,
            createdAt: serverTimestamp(),
          });
          await loadCategories();
          updateCategoryOptions(accountTypeSelect.value);
          categorySelect.value = trimmedCat;
          showToast("Category added successfully!");
        } catch (error) {
          showToast("Failed to add category: " + error.message, "error");
          categorySelect.value = "";
        } finally {
          hideLoading();
        }
      } else {
        categorySelect.value = "";
      }
    }
  });

  // Clear all error messages
  function clearErrors() {
    typeError.style.display = "none";
    categoryError.style.display = "none";
    nameError.style.display = "none";
    
    accountTypeSelect.classList.remove("has-error");
    categorySelect.classList.remove("has-error");
    accountNameInput.classList.remove("has-error");
  }

  // Check for duplicate account name
  async function checkDuplicateAccount(type, name) {
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid),
        where("type", "==", type),
        where("name", "==", name)
      );
      const snapshot = await getDocs(q);
      return !snapshot.empty;
    } catch (error) {
      console.error("Error checking duplicate:", error);
      return false;
    }
  }

  async function loadAccounts() {
    showLoading();
    accountsTable.innerHTML = "";
    
    // Add loading row
    const loadingRow = document.createElement("tr");
    loadingRow.id = "loadingRow";
    loadingRow.innerHTML = `
      <td colspan="4" style="text-align: center; padding: 40px;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p>Loading accounts...</p>
      </td>
    `;
    accountsTable.appendChild(loadingRow);

    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"), 
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);
      
      // Clear existing accounts set
      existingAccounts.clear();
      
      // Remove loading row
      loadingRow.remove();
      
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        // Add to existing accounts set for duplicate checking
        const key = `${data.type.toLowerCase()}_${data.name.toLowerCase()}`;
        existingAccounts.add(key);
        addAccountRow(docSnap.id, data.type, data.category, data.name);
      });
      
      if (snapshot.empty) {
        accountsTable.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
              No accounts found. Click "Setup Wizard" to get started.
            </td>
          </tr>
        `;
      }
    } catch (error) {
      loadingRow.remove();
      accountsTable.innerHTML = `
        <tr>
          <td colspan="4" style="text-align: center; padding: 40px; color: #dc3545;">
            Error loading accounts: ${error.message}
          </td>
        </tr>
      `;
    } finally {
      hideLoading();
    }
  }

  function addAccountRow(id, type, category, name) {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", id);
    tr.innerHTML = `
      <td class="${type}">${type}</td>
      <td>${category}</td>
      <td>${name}</td>
      <td>
        <button class="action-btn edit-btn">Edit</button>
        <button class="action-btn delete-btn">Delete</button>
        <button class="action-btn settings-btn">‚öôÔ∏è</button>
        <div class="popup-menu">
          <div><a href="#" class="view-link" target="_blank">üëÅÔ∏è View</a></div>
          <div class="balance-line">üí∞ Balance: <span class="balance-amount">Loading...</span></div>
        </div>
      </td>
    `;

    // Setup event listeners
    tr.querySelector(".edit-btn").addEventListener("click", () => {
      startEditAccount(id, type, category, name);
    });

    tr.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this account?")) {
        showLoading();
        try {
          await deleteDoc(doc(db, "users", currentUser.uid, "chartOfAccounts", id));
          tr.remove();
          resetForm();
          
          // Remove from existing accounts set
          const key = `${type.toLowerCase()}_${name.toLowerCase()}`;
          existingAccounts.delete(key);
          
          showToast("Account deleted successfully!");
        } catch (err) {
          showToast("Delete failed: " + err.message, "error");
        } finally {
          hideLoading();
        }
      }
    });

    const settingsBtn = tr.querySelector(".settings-btn");
    const popupMenu = tr.querySelector(".popup-menu");
    const viewLink = tr.querySelector(".view-link");
    const balanceAmountSpan = tr.querySelector(".balance-amount");

    settingsBtn.addEventListener("click", async (e) => {
      // Toggle popup
      const isVisible = popupMenu.style.display === "block";
      document.querySelectorAll('.popup-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      
      if (!isVisible) {
        popupMenu.style.display = "block";
        const rect = settingsBtn.getBoundingClientRect();
        popupMenu.style.top = `${rect.bottom + window.scrollY}px`;
        popupMenu.style.left = `${rect.left + window.scrollX - 100}px`;

        // Load balance
        try {
          const q = query(
            collection(db, "users", currentUser.uid, "transactions"), 
            where("accountId", "==", id)
          );
          const snap = await getDocs(q);
          let balance = 0;
          snap.forEach(docSnap => {
            const t = docSnap.data();
            balance += Number(t.amount || 0);
          });
          balanceAmountSpan.textContent = balance.toFixed(2);
        } catch (error) {
          balanceAmountSpan.textContent = "Error";
        }

        // Setup link
        viewLink.href = `trialbalance.html?accountId=${id}&accountName=${encodeURIComponent(name)}`;
      }
    });

    // Close popup when clicking outside
    document.addEventListener("click", (e) => {
      if (!tr.contains(e.target)) {
        popupMenu.style.display = "none";
      }
    });

    accountsTable.appendChild(tr);
  }

  function startEditAccount(id, type, category, name) {
    accountIdInput.value = id;
    accountTypeSelect.value = type;
    updateCategoryOptions(type);
    categorySelect.value = category;
    accountNameInput.value = name;
    submitBtn.textContent = "Update Account";
    cancelEditBtn.style.display = "inline-block";
    clearErrors();
  }

  function resetForm() {
    accountForm.reset();
    accountIdInput.value = "";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">‚ûï Add new category...</option>';
    clearErrors();
  }

  cancelEditBtn.addEventListener("click", resetForm);

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const id = accountIdInput.value.trim();
    const type = accountTypeSelect.value.trim();
    const category = categorySelect.value.trim();
    const name = accountNameInput.value.trim();

    // Clear previous errors
    clearErrors();

    // Validation
    let isValid = true;

    if (!type) {
      typeError.textContent = "Account type is required";
      typeError.style.display = "block";
      accountTypeSelect.classList.add("has-error");
      isValid = false;
    }

    if (!category) {
      categoryError.textContent = "Category is required";
      categoryError.style.display = "block";
      categorySelect.classList.add("has-error");
      isValid = false;
    }

    if (!name) {
      nameError.textContent = "Account name is required";
      nameError.style.display = "block";
      accountNameInput.classList.add("has-error");
      isValid = false;
    }

    if (!isValid) return;

    // Check for duplicates (only for new accounts, not when editing)
    if (!id) {
      const isDuplicate = existingAccounts.has(`${type.toLowerCase()}_${name.toLowerCase()}`);
      if (isDuplicate) {
        nameError.textContent = "An account with this name already exists in this type";
        nameError.style.display = "block";
        accountNameInput.classList.add("has-error");
        showToast("Account name already exists!", "warning");
        return;
      }
    }

    // Disable submit button and show loading
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Saving...";
    submitBtn.disabled = true;
    showLoading();

    try {
      if (id) {
        // Update existing account
        const docRef = doc(db, "users", currentUser.uid, "chartOfAccounts", id);
        await updateDoc(docRef, { type, category, name });
        
        // Update in table
        const tr = accountsTable.querySelector(`tr[data-id="${id}"]`);
        if (tr) {
          tr.children[0].textContent = type;
          tr.children[0].className = type;
          tr.children[1].textContent = category;
          tr.children[2].textContent = name;
        }
        showToast("Account updated successfully!");
      } else {
        // Add new account
        const docRef = await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), {
          userId: currentUser.uid,
          type,
          category,
          name,
          createdAt: serverTimestamp(),
        });
        
        // Add to existing accounts set
        existingAccounts.add(`${type.toLowerCase()}_${name.toLowerCase()}`);
        
        // Add to table
        addAccountRow(docRef.id, type, category, name);
        showToast("Account added successfully!");
      }
      
      resetForm();
      
      // Scroll to show the new/updated account
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      
    } catch (err) {
      showToast("Operation failed: " + err.message, "error");
      console.error(err);
    } finally {
      // Restore button state
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      hideLoading();
    }
  });

  async function init() {
    showLoading();
    try {
      await loadCategories();
      await loadAccounts();
    } catch (error) {
      showToast("Error initializing: " + error.message, "error");
    } finally {
      hideLoading();
    }
  }

  // Validate account name input in real-time
  accountNameInput.addEventListener("input", function() {
    if (this.value.trim()) {
      nameError.style.display = "none";
      this.classList.remove("has-error");
    }
  });

  // Prevent form submission on Enter key in input fields
  accountForm.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && e.target.tagName === "INPUT") {
      e.preventDefault();
    }
  });
</script>
</body>
</html>