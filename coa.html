  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chart of Accounts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 0;
        padding: 0;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .header-left {
        font-weight: bold;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #userInitials {
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      #username {
        font-weight: bold;
      }

      #logoutBtn {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
      }

      #logoutBtn:hover {
        background-color: #a71d2a;
      }

      .container {
        max-width: 1000px;
        margin: 30px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
      }

      h2 {
        text-align: center;
        margin-bottom: 10px;
      }

      .form-group {
        display: flex;
        margin-bottom: 15px;
      }

      .form-group label {
        width: 200px;
        font-weight: bold;
        margin-top: 6px;
      }

      .form-group select,
      .form-group input {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
      }

      button {
        background-color: #28a745;
        color: #fff;
        padding: 10px 20px;
        border: none;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
      }

      button:hover {
        background-color: #218838;
      }

      table {
        width: 100%;
        margin-top: 30px;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px;
        border: 1px solid #ccc;
        text-align: left;
      }

      th {
        background-color: #f1f1f1;
      }

      .Income {
        color: green;
      }

      .Expense,
      .COGS,
      .OtherExpense {
        color: red;
      }

      .Asset,
      .Liability,
      .Equity,
      .OtherIncome {
        color: #333;
      }

      .action-btn {
        background-color: #007bff;
        margin-right: 5px;
      }

      .action-btn:hover {
        background-color: #0056b3;
      }

      .delete-btn {
        background-color: #dc3545;
      }

      .delete-btn:hover {
        background-color: #a71d2a;
      }

      .popup-menu {
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  padding: 10px;
  display: none;
  font-size: 14px;
  min-width: 150px;
  border-radius: 4px;
}
.popup-menu a {
  text-decoration: none;
  color: #007bff;
}
.popup-menu a:hover {
  text-decoration: underline;
}

    </style>
  </head>
  <body>

  <!-- Top Header -->
  <!-- Inside .header (REPLACE this block) -->
  <div class="header">
    <div class="header-left">
      <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
        <i class="fa fa-home"></i> Home
      </a>
      <span style="margin-left: 20px;" id="datetime">Loading time...</span>
    </div>
    <div class="header-right">
      <div id="userInitials">U</div>
      <span id="username">User</span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <h2>Chart of Accounts</h2>
<button type="button" id="starterAccountsBtn" style="margin-bottom:20px;">
  💡 Add Common Starter Accounts
</button>



    <!-- Add/Edit Account Form -->
    <form id="accountForm">
      <input type="hidden" id="accountId" />
      <div class="form-group">
        <label for="accountType">Account Type</label>
  <select id="accountType" required> 
  <small id="typeHint" style="color: gray; display: block; margin-top: 4px;"></small>

          <option value="">Select Type</option>
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Equity">Equity</option>
          <option value="Income">Income</option>
          <option value="Expense">Expense</option>
          <option value="COGS">Cost of Goods Sold</option>
          <option value="OtherIncome">Other Income</option>
          <option value="OtherExpense">Other Expense</option>
        </select>
      </div>

      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" required>
          <small id="categoryHint" style="color: gray; display: block; margin-top: 4px;"></small>
          <option value="">Select Category</option>
          <option value="add-new">➕ Add new category...</option>
        </select>
      </div>

    <div class="form-group">
  <label for="accountName">Account Name</label>
  <input type="text" id="accountName" placeholder="e.g. Bank Account" required />
</div>


      <div class="form-group">
        <label></label>
        <button type="submit" id="submitBtn">Add Account</button>
        <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
      </div>
    </form>

    <!-- Account Table -->
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Category</th>
          <th>Account Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="accountsTable"></tbody>
    </table>
  </div>

 <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const accountTypeSelect = document.getElementById("accountType");
  const categorySelect = document.getElementById("category");
  const accountForm = document.getElementById("accountForm");
  const accountsTable = document.getElementById("accountsTable");
  const accountNameInput = document.getElementById("accountName");
  const accountIdInput = document.getElementById("accountId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");

  let currentUser = null;
  let categories = {};

  // Real-time clock
  function updateTime() {
    const now = new Date();
    if (datetimeElem) {
      datetimeElem.textContent = now.toLocaleString();
    }
  }
  setInterval(updateTime, 1000);
  updateTime();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;

      // Save username in localStorage for persistence
      const nameToStore = user.displayName || user.email;
      localStorage.setItem("username", nameToStore);

      // Display name
      const storedUsername = localStorage.getItem("username");
      if (storedUsername) {
        usernameElem.textContent = storedUsername;
        profileCircle.textContent = storedUsername.charAt(0).toUpperCase();
      } else {
        usernameElem.textContent = nameToStore;
        profileCircle.textContent = nameToStore.charAt(0).toUpperCase();
      }

      await init(); // Load categories + accounts
    } else {
      // Wait a moment before redirecting to allow Firebase to finish initializing
      setTimeout(() => {
        if (!auth.currentUser) {
          alert("You must be logged in.");
          window.location.href = "index.html";
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    localStorage.removeItem("username");
    await signOut(auth);
    window.location.href = "index.html";
  });

  async function loadCategories() {
  const categoriesTable = document.getElementById("categoriesTable");
  categoriesTable.innerHTML = ""; // Clear previous data
  
  const q = query(collection(db, "users", currentUser.uid, "categories"));
  const snapshot = await getDocs(q);

  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    addCategoryRow(docSnap.id, data.name, data.type);
  });
}

  const starterAccounts = [
    { type: "Asset", category: "Bank", name: "Bank Account" },
    { type: "Asset", category: "Cash", name: "Petty Cash" },
    { type: "Liability", category: "Credit Card", name: "Credit Card Payable" },
    { type: "Income", category: "Sales", name: "Product Sales" },
    { type: "Expense", category: "Rent", name: "Office Rent" },
    { type: "Expense", category: "Utilities", name: "Electric Bill" },
    { type: "Expense", category: "Supplies", name: "Office Supplies" },
    { type: "COGS", category: "Raw Materials", name: "Materials Purchased" },
    { type: "Equity", category: "Owner's Equity", name: "Owner's Contribution" },
  ];

  // Button click listener for smart add account
  // When the user clicks to add a starter account
document.getElementById("starterAccountsBtn").addEventListener("click", async () => {
  if (!currentUser) {
    alert("You must be logged in!");
    return;
  }

  const input = prompt("Enter an account name (e.g., 'Axis Bank', 'Office Expense'):");
  if (!input || !input.trim()) {
    alert("Input was empty.");
    return;
  }

  const enteredName = input.trim();
  const words = enteredName.toLowerCase().split(/\s+/); // Split input by space

  // Define matching logic
  const keywordMappings = {
    bank: { type: "Asset", category: "Bank" },
    cash: { type: "Asset", category: "Cash" },
    credit: { type: "Liability", category: "Credit Card" },
    expense: { type: "Expense", category: "General Expense" },
    salary: { type: "Expense", category: "Salaries" },
    sales: { type: "Income", category: "Sales" },
    income: { type: "Income", category: "Sales" },
    equity: { type: "Equity", category: "Owner's Equity" },
    materials: { type: "COGS", category: "Raw Materials" },
  };

  // Attempt to match any word with predefined keywords
  let matched = null;
  for (const word of words) {
    if (keywordMappings[word]) {
      matched = keywordMappings[word];
      break; // Use the first match found
    }
  }

  // Default if no match found
  if (!matched) {
    matched = { type: "Asset", category: "Miscellaneous" };
  }

  // Confirm with the user
  const confirmMsg = `Detected:\nAccount Name: ${enteredName}\nType: ${matched.type}\nCategory: ${matched.category}\n\nAdd this account?`;
  if (!confirm(confirmMsg)) return;

 // When adding a new category
async function addCategory(categoryName, categoryType) {
  if (!currentUser) {
    alert("You must be logged in!");
    return;
  }

  // Add category to the categories subcollection
  try {
    await addDoc(collection(db, "users", currentUser.uid, "categories"), {
      name: categoryName,
      type: categoryType,
      createdAt: serverTimestamp(),
    });
    alert("Category added successfully!");
  } catch (err) {
    alert("Error adding category: " + err.message);
  }
}

  function updateCategoryOptions(type) {
    // Default categories for each account type
    const defaultCategories = {
      Asset: ["Cash", "Bank", "Accounts Receivable", "Inventory"],
      Liability: ["Accounts Payable", "Loans Payable", "Credit Card"],
      Equity: ["Owner's Equity", "Retained Earnings"],
      Income: ["Sales", "Service Revenue", "Interest Income"],
      Expense: ["Rent", "Utilities", "Supplies", "Salaries", "Travel"],
      COGS: ["Raw Materials", "Direct Labor", "Manufacturing Overhead"],
      OtherIncome: ["Gain on Sale", "Dividend Income"],
      OtherExpense: ["Loss on Sale", "Fines", "Miscellaneous"],
    };

    const typeHints = {
      Asset: "Assets are things you own. e.g., Bank, Inventory, Cash.",
      Liability: "Liabilities are things you owe. e.g., Loans, Credit Cards.",
      Equity: "Owner's stake in the business. e.g., Retained Earnings.",
      Income: "Money you earn. e.g., Sales, Services.",
      Expense: "Costs you pay. e.g., Rent, Utilities, Supplies.",
      COGS: "Costs directly tied to producing goods. e.g., Raw Materials.",
      OtherIncome: "Other money you earn. e.g., Interest, Dividends.",
      OtherExpense: "Other costs. e.g., Fines, Loss on Sale."
    };

    // Reset category dropdown
    categorySelect.innerHTML = '<option value="">Select Category</option>';

    // Combine predefined with user-defined categories
    const userCats = categories[type] || [];
    const combined = [...new Set([...defaultCategories[type] || [], ...userCats])];

    combined.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });

    // Always add "Add new" last
    const addNewOption = document.createElement("option");
    addNewOption.value = "add-new";
    addNewOption.textContent = "➕ Add new category...";
    categorySelect.appendChild(addNewOption);

    // Update hints if element exists
    if(document.getElementById("typeHint")){
      document.getElementById("typeHint").textContent = typeHints[type] || "";
    }
    if(document.getElementById("categoryHint")){
      const firstCategory = combined[0] || "";
      document.getElementById("categoryHint").textContent = firstCategory ? `e.g., ${firstCategory}` : "";
    }
  }

  accountTypeSelect.addEventListener("change", () => {
    const type = accountTypeSelect.value;
    updateCategoryOptions(type);
    categorySelect.value = "";
  });

categorySelect.addEventListener("change", async () => {
  if (categorySelect.value === "add-new") {
    if (!accountTypeSelect.value) {
      alert("Please select Account Type first.");
      categorySelect.value = "";
      return;
    }
    const newCat = prompt(`Enter new category name for "${accountTypeSelect.value}":`);
    if (newCat && newCat.trim()) {
      const trimmedCat = newCat.trim();
      // Check if it already exists
      if (categories[accountTypeSelect.value]?.some(c => c.toLowerCase() === trimmedCat.toLowerCase())) {
        alert("Category already exists.");
        categorySelect.value = "";
        return;
      }
      try {
        await addDoc(collection(db, "Categories"), {
          userId: currentUser.uid,
          accountType: accountTypeSelect.value,
          categoryName: trimmedCat,
          createdAt: serverTimestamp(),
        });
        await loadCategories();
        updateCategoryOptions(accountTypeSelect.value);
        categorySelect.value = trimmedCat;
      } catch (error) {
        alert("Failed to add category: " + error.message);
        categorySelect.value = "";
      }
    } else {
      categorySelect.value = "";
    }
  }
});


async function loadAccounts() {
  const accountsTable = document.getElementById("accountsTable");
  accountsTable.innerHTML = ""; // Clear previous data

  const q = query(collection(db, "users", currentUser.uid, "chartOfAccounts"));
  const snapshot = await getDocs(q);
  
  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    addAccountRow(docSnap.id, data.type, data.category, data.name);
  });
}


function addAccountRow(id, type, category, name) {
  const tr = document.createElement("tr");
  tr.setAttribute("data-id", id);
  tr.innerHTML = `
    <td class="${type}">${type}</td>
    <td>${category}</td>
    <td>${name}</td>
    <td>
      <button class="action-btn edit-btn">Edit</button>
      <button class="action-btn delete-btn">Delete</button>
      <button class="action-btn settings-btn">⚙️</button>
      <div class="popup-menu" style="display:none; position:absolute; background:white; border:1px solid #ccc; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:10;">
        <div><a href="#" class="view-link">👁️ View</a></div>
        <div class="balance-line">💰 Balance: <span class="balance-amount">Loading...</span></div>
      </div>
    </td>
  `;

  // Setup event listeners
  tr.querySelector(".edit-btn").addEventListener("click", () => {
    startEditAccount(id, type, category, name);
  });

  tr.querySelector(".delete-btn").addEventListener("click", async () => {
    if (confirm("Are you sure you want to delete this account?")) {
      try {
        await deleteDoc(doc(db, "chartOfAccounts", id));
        tr.remove();
        resetForm();
      } catch (err) {
        alert("Delete failed: " + err.message);
        console.error(err);
      }
    }
  });

  const settingsBtn = tr.querySelector(".settings-btn");
  const popupMenu = tr.querySelector(".popup-menu");
  const viewLink = tr.querySelector(".view-link");
  const balanceAmountSpan = tr.querySelector(".balance-amount");

  settingsBtn.addEventListener("click", async (e) => {
    // Position popup
    popupMenu.style.display = popupMenu.style.display === "block" ? "none" : "block";
    const rect = settingsBtn.getBoundingClientRect();
    popupMenu.style.top = `${rect.bottom + window.scrollY}px`;
    popupMenu.style.left = `${rect.left + window.scrollX}px`;

    // Load balance from 'transactions'
    try {
      const q = query(collection(db, `users/${currentUser.uid}/transactions`), where("accountId", "==", id));
      const snap = await getDocs(q);
      let balance = 0;
      snap.forEach(docSnap => {
        const t = docSnap.data();
        balance += Number(t.amount || 0); // assume each transaction has 'amount'
      });
      balanceAmountSpan.textContent = balance.toFixed(2);
    } catch (error) {
      balanceAmountSpan.textContent = "Error";
    }

    // Setup link to trail balance page
    viewLink.href = `trialbalance.html?accountId=${id}`;
  });

  // Optional: Hide popup on outside click
  document.addEventListener("click", (e) => {
    if (!tr.contains(e.target)) {
      popupMenu.style.display = "none";
    }
  });

  accountsTable.appendChild(tr);
}


function startEditAccount(id, type, category, name) {
  accountIdInput.value = id;
  accountTypeSelect.value = type;
  updateCategoryOptions(type);
  categorySelect.value = category;
  accountNameInput.value = name;  // <-- Account Name loaded into input field here
  submitBtn.textContent = "Update Account";
  cancelEditBtn.style.display = "inline-block";
}


  function resetForm() {
    accountForm.reset();
    accountIdInput.value = "";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">➕ Add new category...</option>';
  }

  cancelEditBtn.addEventListener("click", resetForm);

  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = accountIdInput.value.trim();
    const type = accountTypeSelect.value.trim();
    const category = categorySelect.value.trim();
    const name = accountNameInput.value.trim();

    if (!type || !category || !name) {
      alert("Please fill all fields.");
      return;
    }

    try {
      if (id) {
        const docRef = doc(db, "chartOfAccounts", id);
        await updateDoc(docRef, { type, category, name });
        const tr = accountsTable.querySelector(`tr[data-id="${id}"]`);
        if (tr) {
          tr.children[0].textContent = type;
          tr.children[0].className = type;
          tr.children[1].textContent = category;
          tr.children[2].textContent = name;
        }
        alert("Account updated.");
      } else {
        await addDoc(collection(db, "chartOfAccounts"), {
          userId: currentUser.uid,
          type,
          category,
          name,
          createdAt: serverTimestamp(),
        });
        await loadAccounts();
        alert("Account added.");
      }
      resetForm();
    } catch (err) {
      alert("Operation failed: " + err.message);
    }
  });

  async function init() {
    await loadCategories();
    await loadAccounts();
  }

  // Starter accounts button to add predefined starter accounts
  document.getElementById("addStarterAccountsBtn")?.addEventListener("click", async () => {
    if (!currentUser) {
      alert("You must be logged in!");
      return;
    }
    if (!confirm("Do you want to add common starter accounts?")) return;

    try {
      for (const acc of starterAccounts) {
        await addDoc(collection(db, "chartOfAccounts"), {
          userId: currentUser.uid,
          type: acc.type,
          category: acc.category,
          name: acc.name,
          createdAt: serverTimestamp(),
        });
      }
      await loadAccounts(); // reload the list after adding
      alert("Starter accounts added successfully!");
    } catch (error) {
      alert("Error adding starter accounts: " + error.message);
    }
  });

</script>
</body>
</html>
