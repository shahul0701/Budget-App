<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt & Credit Card Tracker</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #6200ee;
            --secondary: #3700b3;
            --accent: #03dac6;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --light: #ffffff;
            --dark: #1a1a1a;
            --gray: #f5f5f5;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 32px;
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
            min-height: calc(100vh - 200px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 30px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-card {
            background: var(--gray);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .stat-item.total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 16px;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--light);
            border: 2px solid var(--primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--primary);
            text-align: left;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
        }

        /* Main Content */
        .main-content {
            background: var(--light);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            background: var(--gray);
            padding: 5px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: rgba(98, 0, 238, 0.1);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Content Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .content-header h2 {
            color: var(--primary);
            font-size: 24px;
        }

        .add-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(98, 0, 238, 0.2);
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card-item {
            background: var(--light);
            border-radius: 15px;
            border: 2px solid #eee;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .card-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--primary);
        }

        .card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary);
        }

        .card-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-inactive { background: #e2e3e5; color: #383d41; }

        .card-balance {
            font-size: 32px;
            font-weight: 700;
            margin: 15px 0;
            color: var(--primary);
        }

        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            font-size: 14px;
        }

        .detail-item small {
            display: block;
            color: #666;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-icon {
            padding: 10px;
            border-radius: 50%;
            background: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .action-icon:hover {
            background: var(--primary);
            color: white;
            transform: rotate(15deg);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 22px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .chart-container {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #eee;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .app-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .content-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .card-details {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Login Prompt */
        .login-prompt {
            display: none;
            text-align: center;
            padding: 100px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .login-prompt.active {
            display: block;
        }

        .login-prompt i {
            font-size: 80px;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .login-prompt h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 32px;
        }

        .login-prompt p {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <!-- Login Prompt -->
    <div id="loginPrompt" class="login-prompt active">
        <div class="container" style="max-width: 600px;">
            <i class="bi bi-shield-lock"></i>
            <h2>Authentication Required</h2>
            <p>Please login to your account to access the Debt & Credit Card Tracker. This ensures your financial data remains private and secure.</p>
            <button class="btn btn-primary" onclick="redirectToLogin()">
                <i class="bi bi-box-arrow-in-right"></i> Go to Login
            </button>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="appContainer" class="container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <i class="bi bi-cash-stack"></i>
                <h1>Debt & Credit Tracker</h1>
            </div>
            <div class="user-info">
                <span><i class="bi bi-person-circle"></i> <span id="userEmail"></span></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3><i class="bi bi-graph-up"></i> Financial Overview</h3>
                    <div class="stats-card">
                        <div class="stat-item">
                            <span>Total Debt:</span>
                            <span id="totalDebt">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span>Credit Limit:</span>
                            <span id="totalCredit">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span>Available Credit:</span>
                            <span id="availableCredit">$0.00</span>
                        </div>
                        <div class="stat-item total">
                            <span>Net Debt:</span>
                            <span id="netDebt">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-lightning"></i> Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="openDebtModal()">
                            <i class="bi bi-plus-circle"></i> Add Debt
                        </button>
                        <button class="action-btn" onclick="openCreditCardModal()">
                            <i class="bi bi-credit-card"></i> Add Credit Card
                        </button>
                        <button class="action-btn" onclick="openPaymentModal()">
                            <i class="bi bi-cash"></i> Record Payment
                        </button>
                        <button class="action-btn" onclick="openNoteModal()">
                            <i class="bi bi-sticky"></i> Add Note
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-calendar-check"></i> Upcoming Payments</h3>
                    <div id="upcomingPayments">
                        <div class="loading" style="padding: 10px;">
                            <div class="spinner" style="width: 30px; height: 30px;"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('debts')">Debts</button>
                    <button class="tab" onclick="switchTab('creditCards')">Credit Cards</button>
                    <button class="tab" onclick="switchTab('payments')">Payments</button>
                    <button class="tab" onclick="switchTab('analytics')">Analytics</button>
                </div>

                <!-- Debts Tab -->
                <div id="debtsTab" class="tab-content active">
                    <div class="content-header">
                        <h2><i class="bi bi-cash"></i> Your Debts</h2>
                        <button class="add-btn" onclick="openDebtModal()">
                            <i class="bi bi-plus-lg"></i> Add New Debt
                        </button>
                    </div>
                    
                    <div class="cards-grid" id="debtsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading debts...</p>
                        </div>
                    </div>
                </div>

                <!-- Credit Cards Tab -->
                <div id="creditCardsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-credit-card"></i> Credit Cards</h2>
                        <button class="add-btn" onclick="openCreditCardModal()">
                            <i class="bi bi-plus-lg"></i> Add Credit Card
                        </button>
                    </div>
                    
                    <div class="cards-grid" id="creditCardsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading credit cards...</p>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="paymentsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-cash-stack"></i> Payment History</h2>
                        <button class="add-btn" onclick="openPaymentModal()">
                            <i class="bi bi-plus-lg"></i> Record Payment
                        </button>
                    </div>
                    
                    <div id="paymentsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading payment history...</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analyticsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-graph-up-arrow"></i> Financial Analytics</h2>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3>Debt Distribution</h3>
                            <canvas id="debtDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Credit Utilization</h3>
                            <canvas id="creditUtilizationChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Payment Trends</h3>
                            <canvas id="paymentTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Debt Modal -->
    <div id="debtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="debtModalTitle">Add New Debt</h3>
                <button class="close-modal" onclick="closeDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="debtForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Debt Name *</label>
                            <input type="text" id="debtName" required>
                        </div>
                        <div class="form-group">
                            <label>Creditor *</label>
                            <input type="text" id="creditor" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Debt Type *</label>
                            <select id="debtType" required>
                                <option value="">Select Type</option>
                                <option value="personal_loan">Personal Loan</option>
                                <option value="mortgage">Mortgage</option>
                                <option value="car_loan">Car Loan</option>
                                <option value="student_loan">Student Loan</option>
                                <option value="business_loan">Business Loan</option>
                                <option value="medical_debt">Medical Debt</option>
                                <option value="credit_card_debt">Credit Card Debt</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="debtStatus" required>
                                <option value="active">Active</option>
                                <option value="paid_off">Paid Off</option>
                                <option value="defaulted">Defaulted</option>
                                <option value="in_collection">In Collection</option>
                                <option value="settled">Settled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Principal Amount ($) *</label>
                            <input type="number" id="principalAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Current Balance ($) *</label>
                            <input type="number" id="currentBalance" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Interest Rate (%) *</label>
                            <input type="number" id="interestRate" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Minimum Payment ($) *</label>
                            <input type="number" id="minimumPayment" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Frequency</label>
                            <select id="paymentFrequency">
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="bi_weekly">Bi-weekly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Due Day</label>
                            <input type="number" id="paymentDueDay" min="1" max="31" value="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="debtNotes" placeholder="Add any additional notes about this debt..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDebtModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Debt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Credit Card Modal -->
    <div id="creditCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="creditCardModalTitle">Add Credit Card</h3>
                <button class="close-modal" onclick="closeCreditCardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="creditCardForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Card Name *</label>
                            <input type="text" id="cardName" required>
                        </div>
                        <div class="form-group">
                            <label>Issuer *</label>
                            <input type="text" id="issuer" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Card Type *</label>
                            <select id="cardType" required>
                                <option value="">Select Type</option>
                                <option value="visa">Visa</option>
                                <option value="mastercard">MasterCard</option>
                                <option value="amex">American Express</option>
                                <option value="discover">Discover</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Last 4 Digits *</label>
                            <input type="text" id="lastFourDigits" maxlength="4" required pattern="\d{4}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Limit ($) *</label>
                            <input type="number" id="creditLimit" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Current Balance ($) *</label>
                            <input type="number" id="cardBalance" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" id="cardInterestRate" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Annual Fee ($)</label>
                            <input type="number" id="annualFee" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Due Day</label>
                            <input type="number" id="cardDueDay" min="1" max="31" value="1">
                        </div>
                        <div class="form-group">
                            <label>Statement Due Day</label>
                            <input type="number" id="statementDueDay" min="1" max="31" value="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="cardNotes" placeholder="Add any notes about this credit card..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreditCardModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Card</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment For *</label>
                            <select id="paymentFor" required onchange="updatePaymentType()">
                                <option value="">Select Debt/Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Type</label>
                            <select id="paymentType">
                                <option value="regular">Regular Payment</option>
                                <option value="extra">Extra Payment</option>
                                <option value="settlement">Settlement</option>
                                <option value="minimum">Minimum Payment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount ($) *</label>
                            <input type="number" id="paymentAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Date *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod">
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="check">Check</option>
                                <option value="cash">Cash</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="debit_card">Debit Card</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reference Number</label>
                            <input type="text" id="referenceNumber" placeholder="Optional">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="paymentNotes" placeholder="Add any notes about this payment..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Record Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Note</h3>
                <button class="close-modal" onclick="closeNoteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <div class="form-group">
                        <label>Select Item *</label>
                        <select id="noteFor" required>
                            <option value="">Select Debt/Card</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Note Type</label>
                        <select id="noteType">
                            <option value="general">General Note</option>
                            <option value="contact">Contact Info</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="legal">Legal Notes</option>
                            <option value="reminder">Reminder</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Content *</label>
                        <textarea id="noteContent" rows="6" required placeholder="Write your note here..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailsTitle">Details</h3>
                <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detailsContent"></div>
                <div class="sidebar-section" style="margin-top: 30px;">
                    <h3><i class="bi bi-sticky"></i> Notes</h3>
                    <div id="itemNotes" style="margin-bottom: 20px;">
                        <div class="loading" style="padding: 10px;">
                            <div class="spinner" style="width: 30px; height: 30px;"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addNoteToCurrentItem()">
                        <i class="bi bi-plus"></i> Add Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const analytics = firebase.analytics();

        // Global Variables
        let currentUser = null;
        let currentTab = 'debts';
        let currentItemId = null;
        let currentItemType = null;
        let debts = [];
        let creditCards = [];
        let payments = [];
        let notes = [];

        // Check Authentication State
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('loginPrompt').classList.remove('active');
                document.getElementById('appContainer').style.display = 'block';
                loadUserData();
            } else {
                // User is signed out
                document.getElementById('loginPrompt').classList.add('active');
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Redirect to Login
        function redirectToLogin() {
            window.location.href = 'index.html'; // Change this to your login page
        }

        // Logout Function
        function logout() {
            auth.signOut()
                .then(() => {
                    alert('Logged out successfully!');
                    window.location.reload();
                })
                .catch((error) => {
                    alert('Error logging out: ' + error.message);
                });
        }

        // Tab Navigation
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'debts') {
                loadDebts();
            } else if (tabName === 'creditCards') {
                loadCreditCards();
            } else if (tabName === 'payments') {
                loadPayments();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Load User Data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                await loadDebts();
                await loadCreditCards();
                await loadPayments();
                loadUpcomingPayments();
                updateFinancialOverview();
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Failed to load data. Please refresh the page.');
            }
        }

        // Load Debts
        async function loadDebts() {
            if (!currentUser) return;
            
            try {
                const debtsRef = db.collection('users').doc(currentUser.uid).collection('debts');
                const snapshot = await debtsRef.orderBy('createdAt', 'desc').get();
                
                debts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    debts.push({
                        id: doc.id,
                        name: data.name || '',
                        creditor: data.creditor || '',
                        type: data.type || 'personal_loan',
                        status: data.status || 'active',
                        principalAmount: data.principalAmount || 0,
                        currentBalance: data.currentBalance || 0,
                        interestRate: data.interestRate || 0,
                        minimumPayment: data.minimumPayment || 0,
                        paymentFrequency: data.paymentFrequency || 'monthly',
                        paymentDueDay: data.paymentDueDay || 1,
                        notes: data.notes || '',
                        createdAt: data.createdAt?.toDate() || new Date(),
                        updatedAt: data.updatedAt?.toDate() || new Date()
                    });
                });
                
                renderDebts();
            } catch (error) {
                console.error('Error loading debts:', error);
                document.getElementById('debtsList').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading debts</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Render Debts
        function renderDebts() {
            const debtsList = document.getElementById('debtsList');
            
            if (debts.length === 0) {
                debtsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-cash"></i>
                        <h3>No debts found</h3>
                        <p>Add your first debt to get started</p>
                        <button class="btn btn-primary" onclick="openDebtModal()" style="margin-top: 20px;">
                            <i class="bi bi-plus"></i> Add Debt
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            debts.forEach(debt => {
                const statusClass = `status-${debt.status === 'paid_off' ? 'paid' : debt.status === 'defaulted' ? 'overdue' : 'active'}`;
                const statusText = debt.status.charAt(0).toUpperCase() + debt.status.slice(1).replace('_', ' ');
                const typeText = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                
                html += `
                    <div class="card-item" onclick="viewDebtDetails('${debt.id}')">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="bi bi-cash"></i>
                                ${debt.name}
                            </div>
                            <span class="card-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="card-balance">$${formatCurrency(debt.currentBalance)}</div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <small>Creditor</small>
                                <div>${debt.creditor}</div>
                            </div>
                            <div class="detail-item">
                                <small>Type</small>
                                <div>${typeText}</div>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <small>Interest Rate</small>
                                <div>${debt.interestRate}%</div>
                            </div>
                            <div class="detail-item">
                                <small>Minimum Payment</small>
                                <div>$${formatCurrency(debt.minimumPayment)}</div>
                            </div>
                        </div>
                        
                        <div class="card-actions">
                            <div class="action-icon" onclick="event.stopPropagation(); recordPaymentFor('debt', '${debt.id}')" title="Record Payment">
                                <i class="bi bi-cash"></i>
                            </div>
                            <div class="action-icon" onclick="event.stopPropagation(); editDebt('${debt.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </div>
                            <div class="action-icon" onclick="event.stopPropagation(); deleteItem('debt', '${debt.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            debtsList.innerHTML = html;
        }

        // Load Credit Cards
        async function loadCreditCards() {
            if (!currentUser) return;
            
            try {
                const cardsRef = db.collection('users').doc(currentUser.uid).collection('creditCards');
                const snapshot = await cardsRef.orderBy('createdAt', 'desc').get();
                
                creditCards = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    creditCards.push({
                        id: doc.id,
                        cardName: data.cardName || '',
                        issuer: data.issuer || '',
                        cardType: data.cardType || 'visa',
                        lastFourDigits: data.lastFourDigits || '',
                        creditLimit: data.creditLimit || 0,
                        currentBalance: data.currentBalance || 0,
                        interestRate: data.interestRate || 0,
                        annualFee: data.annualFee || 0,
                        paymentDueDay: data.paymentDueDay || 1,
                        statementDueDay: data.statementDueDay || 1,
                        status: data.status || 'active',
                        notes: data.notes || '',
                        createdAt: data.createdAt?.toDate() || new Date(),
                        updatedAt: data.updatedAt?.toDate() || new Date()
                    });
                });
                
                renderCreditCards();
            } catch (error) {
                console.error('Error loading credit cards:', error);
                document.getElementById('creditCardsList').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading credit cards</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Render Credit Cards
        function renderCreditCards() {
            const cardsList = document.getElementById('creditCardsList');
            
            if (creditCards.length === 0) {
                cardsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-credit-card"></i>
                        <h3>No credit cards found</h3>
                        <p>Add your first credit card to get started</p>
                        <button class="btn btn-primary" onclick="openCreditCardModal()" style="margin-top: 20px;">
                            <i class="bi bi-plus"></i> Add Credit Card
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            creditCards.forEach(card => {
                const availableCredit = card.creditLimit - card.currentBalance;
                const utilization = card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100).toFixed(1) : 0;
                const statusClass = card.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = card.status.charAt(0).toUpperCase() + card.status.slice(1);
                const typeText = card.cardType.charAt(0).toUpperCase() + card.cardType.slice(1);
                
                html += `
                    <div class="card-item" onclick="viewCreditCardDetails('${card.id}')">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="bi bi-credit-card"></i>
                                ${card.cardName}
                            </div>
                            <span class="card-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="card-balance">$${formatCurrency(card.currentBalance)}</div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <small>Available Credit</small>
                                <div>$${formatCurrency(availableCredit)}</div>
                            </div>
                            <div class="detail-item">
                                <small>Credit Limit</small>
                                <div>$${formatCurrency(card.creditLimit)}</div>
                            </div>
                        </div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <small>Utilization</small>
                                <div>${utilization}%</div>
                            </div>
                            <div class="detail-item">
                                <small>Due Day</small>
                                <div>${card.paymentDueDay}</div>
                            </div>
                        </div>
                        
                        <div class="card-actions">
                            <div class="action-icon" onclick="event.stopPropagation(); recordPaymentFor('card', '${card.id}')" title="Record Payment">
                                <i class="bi bi-cash"></i>
                            </div>
                            <div class="action-icon" onclick="event.stopPropagation(); editCreditCard('${card.id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </div>
                            <div class="action-icon" onclick="event.stopPropagation(); deleteItem('card', '${card.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cardsList.innerHTML = html;
        }

        // Load Payments
        async function loadPayments() {
            if (!currentUser) return;
            
            try {
                let allPayments = [];
                
                // Load debt payments
                for (const debt of debts) {
                    const paymentsRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(debt.id).collection('payments');
                    const snapshot = await paymentsRef.orderBy('paymentDate', 'desc').get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allPayments.push({
                            id: doc.id,
                            debtId: debt.id,
                            debtName: debt.name,
                            type: 'debt',
                            amount: data.amount || 0,
                            paymentDate: data.paymentDate?.toDate() || new Date(),
                            paymentType: data.paymentType || 'regular',
                            paymentMethod: data.paymentMethod || 'bank_transfer',
                            referenceNumber: data.referenceNumber || '',
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date()
                        });
                    });
                }
                
                // Load credit card payments
                for (const card of creditCards) {
                    const paymentsRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(card.id).collection('payments');
                    const snapshot = await paymentsRef.orderBy('paymentDate', 'desc').get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allPayments.push({
                            id: doc.id,
                            cardId: card.id,
                            cardName: card.cardName,
                            type: 'card',
                            amount: data.amount || 0,
                            paymentDate: data.paymentDate?.toDate() || new Date(),
                            paymentType: data.paymentType || 'regular',
                            paymentMethod: data.paymentMethod || 'bank_transfer',
                            referenceNumber: data.referenceNumber || '',
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date()
                        });
                    });
                }
                
                payments = allPayments.sort((a, b) => b.paymentDate - a.paymentDate);
                renderPayments();
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('paymentsList').innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading payments</h3>
                        <p>Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Render Payments
        function renderPayments() {
            const paymentsList = document.getElementById('paymentsList');
            
            if (payments.length === 0) {
                paymentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-cash-stack"></i>
                        <h3>No payments found</h3>
                        <p>Record your first payment to get started</p>
                        <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 20px;">
                            <i class="bi bi-plus"></i> Record Payment
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="cards-grid">';
            payments.forEach(payment => {
                const paymentDate = new Date(payment.paymentDate);
                const formattedDate = paymentDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const itemName = payment.type === 'debt' ? payment.debtName : payment.cardName;
                const icon = payment.type === 'debt' ? 'bi-cash' : 'bi-credit-card';
                
                html += `
                    <div class="card-item">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="bi ${icon}"></i>
                                ${itemName}
                            </div>
                            <small>${formattedDate}</small>
                        </div>
                        
                        <div class="card-balance">$${formatCurrency(payment.amount)}</div>
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <small>Type</small>
                                <div>${payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1)}</div>
                            </div>
                            <div class="detail-item">
                                <small>Method</small>
                                <div>${payment.paymentMethod.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</div>
                            </div>
                        </div>
                        
                        ${payment.referenceNumber ? `
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Reference</small>
                                    <div>${payment.referenceNumber}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${payment.notes ? `
                            <div style="margin-top: 15px; padding: 10px; background: var(--gray); border-radius: 8px; font-size: 14px;">
                                <small style="display: block; margin-bottom: 5px; color: #666;">Notes:</small>
                                ${payment.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            paymentsList.innerHTML = html;
        }

        // Load Upcoming Payments
        function loadUpcomingPayments() {
            const upcomingDiv = document.getElementById('upcomingPayments');
            const today = new Date();
            const currentDay = today.getDate();
            
            let upcoming = [];
            
            // Check debt due dates
            debts.forEach(debt => {
                if (debt.status === 'active' && debt.paymentDueDay) {
                    const dueDay = parseInt(debt.paymentDueDay);
                    upcoming.push({
                        type: 'debt',
                        name: debt.name,
                        amount: debt.minimumPayment || 0,
                        dueDay: dueDay,
                        isOverdue: dueDay < currentDay
                    });
                }
            });
            
            // Check credit card due dates
            creditCards.forEach(card => {
                if (card.status === 'active' && card.paymentDueDay) {
                    const dueDay = parseInt(card.paymentDueDay);
                    upcoming.push({
                        type: 'card',
                        name: card.cardName,
                        amount: card.currentBalance * 0.02 || 25, // 2% or $25 minimum
                        dueDay: dueDay,
                        isOverdue: dueDay < currentDay
                    });
                }
            });
            
            if (upcoming.length === 0) {
                upcomingDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: var(--gray); border-radius: 10px;">
                        <i class="bi bi-check-circle" style="font-size: 24px; color: var(--success); margin-bottom: 10px;"></i>
                        <p style="color: #666;">No upcoming payments</p>
                    </div>
                `;
                return;
            }
            
            // Sort by due date
            upcoming.sort((a, b) => a.dueDay - b.dueDay);
            
            let html = '';
            upcoming.forEach(item => {
                html += `
                    <div style="background: ${item.isOverdue ? '#fff5f5' : '#f8f9fa'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${item.isOverdue ? 'var(--danger)' : 'var(--primary)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong style="font-size: 14px;">${item.name}</strong>
                            <span style="font-weight: bold; color: var(--primary);">$${formatCurrency(item.amount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: ${item.isOverdue ? 'var(--danger)' : '#666'};">
                            <span>Due on ${item.dueDay}</span>
                            <span>${item.type === 'debt' ? 'Debt' : 'Card'}</span>
                        </div>
                        ${item.isOverdue ? '<div style="font-size: 11px; color: var(--danger); margin-top: 5px;"> Overdue</div>' : ''}
                    </div>
                `;
            });
            
            upcomingDiv.innerHTML = html;
        }

        // Update Financial Overview
        function updateFinancialOverview() {
            const totalDebt = debts.reduce((sum, debt) => sum + (debt.currentBalance || 0), 0);
            const totalCreditLimit = creditCards.reduce((sum, card) => sum + (card.creditLimit || 0), 0);
            const totalCreditBalance = creditCards.reduce((sum, card) => sum + (card.currentBalance || 0), 0);
            const availableCredit = totalCreditLimit - totalCreditBalance;
            const netDebt = totalDebt + totalCreditBalance;
            
            document.getElementById('totalDebt').textContent = '$' + formatCurrency(totalDebt);
            document.getElementById('totalCredit').textContent = '$' + formatCurrency(totalCreditLimit);
            document.getElementById('availableCredit').textContent = '$' + formatCurrency(availableCredit);
            document.getElementById('netDebt').textContent = '$' + formatCurrency(netDebt);
        }

        // Debt Modal Functions
        function openDebtModal(debtId = null) {
            currentItemId = debtId;
            const modal = document.getElementById('debtModal');
            
            if (debtId) {
                document.getElementById('debtModalTitle').textContent = 'Edit Debt';
                const debt = debts.find(d => d.id === debtId);
                if (debt) {
                    document.getElementById('debtName').value = debt.name;
                    document.getElementById('creditor').value = debt.creditor;
                    document.getElementById('debtType').value = debt.type;
                    document.getElementById('debtStatus').value = debt.status;
                    document.getElementById('principalAmount').value = debt.principalAmount;
                    document.getElementById('currentBalance').value = debt.currentBalance;
                    document.getElementById('interestRate').value = debt.interestRate;
                    document.getElementById('minimumPayment').value = debt.minimumPayment;
                    document.getElementById('paymentFrequency').value = debt.paymentFrequency || 'monthly';
                    document.getElementById('paymentDueDay').value = debt.paymentDueDay || 1;
                    document.getElementById('debtNotes').value = debt.notes || '';
                }
            } else {
                document.getElementById('debtModalTitle').textContent = 'Add New Debt';
                document.getElementById('debtForm').reset();
                document.getElementById('paymentDueDay').value = 1;
            }
            
            modal.classList.add('active');
        }

        function closeDebtModal() {
            document.getElementById('debtModal').classList.remove('active');
            currentItemId = null;
        }

        // Save Debt
        document.getElementById('debtForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const debtData = {
                name: document.getElementById('debtName').value.trim(),
                creditor: document.getElementById('creditor').value.trim(),
                type: document.getElementById('debtType').value,
                status: document.getElementById('debtStatus').value,
                principalAmount: parseFloat(document.getElementById('principalAmount').value) || 0,
                currentBalance: parseFloat(document.getElementById('currentBalance').value) || 0,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                minimumPayment: parseFloat(document.getElementById('minimumPayment').value) || 0,
                paymentFrequency: document.getElementById('paymentFrequency').value,
                paymentDueDay: parseInt(document.getElementById('paymentDueDay').value) || 1,
                notes: document.getElementById('debtNotes').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const debtsRef = db.collection('users').doc(currentUser.uid).collection('debts');
                
                if (currentItemId) {
                    await debtsRef.doc(currentItemId).update(debtData);
                } else {
                    debtData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    debtData.userId = currentUser.uid;
                    await debtsRef.add(debtData);
                }
                
                closeDebtModal();
                loadDebts();
                updateFinancialOverview();
                loadUpcomingPayments();
            } catch (error) {
                console.error('Error saving debt:', error);
                alert('Failed to save debt: ' + error.message);
            }
        });

        // Credit Card Modal Functions
        function openCreditCardModal(cardId = null) {
            currentItemId = cardId;
            const modal = document.getElementById('creditCardModal');
            
            if (cardId) {
                document.getElementById('creditCardModalTitle').textContent = 'Edit Credit Card';
                const card = creditCards.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('cardName').value = card.cardName;
                    document.getElementById('issuer').value = card.issuer;
                    document.getElementById('cardType').value = card.cardType;
                    document.getElementById('lastFourDigits').value = card.lastFourDigits;
                    document.getElementById('creditLimit').value = card.creditLimit;
                    document.getElementById('cardBalance').value = card.currentBalance;
                    document.getElementById('cardInterestRate').value = card.interestRate || '';
                    document.getElementById('annualFee').value = card.annualFee || '';
                    document.getElementById('cardDueDay').value = card.paymentDueDay || 1;
                    document.getElementById('statementDueDay').value = card.statementDueDay || 1;
                    document.getElementById('cardNotes').value = card.notes || '';
                }
            } else {
                document.getElementById('creditCardModalTitle').textContent = 'Add Credit Card';
                document.getElementById('creditCardForm').reset();
                document.getElementById('cardDueDay').value = 1;
                document.getElementById('statementDueDay').value = 1;
            }
            
            modal.classList.add('active');
        }

        function closeCreditCardModal() {
            document.getElementById('creditCardModal').classList.remove('active');
            currentItemId = null;
        }

        // Save Credit Card
        document.getElementById('creditCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const cardData = {
                cardName: document.getElementById('cardName').value.trim(),
                issuer: document.getElementById('issuer').value.trim(),
                cardType: document.getElementById('cardType').value,
                lastFourDigits: document.getElementById('lastFourDigits').value.trim(),
                creditLimit: parseFloat(document.getElementById('creditLimit').value) || 0,
                currentBalance: parseFloat(document.getElementById('cardBalance').value) || 0,
                interestRate: parseFloat(document.getElementById('cardInterestRate').value) || 0,
                annualFee: parseFloat(document.getElementById('annualFee').value) || 0,
                paymentDueDay: parseInt(document.getElementById('cardDueDay').value) || 1,
                statementDueDay: parseInt(document.getElementById('statementDueDay').value) || 1,
                status: 'active',
                notes: document.getElementById('cardNotes').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const cardsRef = db.collection('users').doc(currentUser.uid).collection('creditCards');
                
                if (currentItemId) {
                    await cardsRef.doc(currentItemId).update(cardData);
                } else {
                    cardData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    cardData.userId = currentUser.uid;
                    await cardsRef.add(cardData);
                }
                
                closeCreditCardModal();
                loadCreditCards();
                updateFinancialOverview();
                loadUpcomingPayments();
            } catch (error) {
                console.error('Error saving credit card:', error);
                alert('Failed to save credit card: ' + error.message);
            }
        });

        // Payment Modal Functions
        function openPaymentModal() {
            const modal = document.getElementById('paymentModal');
            const select = document.getElementById('paymentFor');
            
            // Clear previous options
            select.innerHTML = '<option value="">Select Debt/Card</option>';
            
            // Add debt options
            debts.forEach(debt => {
                if (debt.status === 'active') {
                    select.innerHTML += `<option value="debt_${debt.id}">Debt: ${debt.name} ($${formatCurrency(debt.currentBalance)})</option>`;
                }
            });
            
            // Add credit card options
            creditCards.forEach(card => {
                if (card.status === 'active') {
                    select.innerHTML += `<option value="card_${card.id}">Card: ${card.cardName} ($${formatCurrency(card.currentBalance)})</option>`;
                }
            });
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            
            modal.classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function updatePaymentType() {
            const selected = document.getElementById('paymentFor').value;
            const amountInput = document.getElementById('paymentAmount');
            
            if (selected.startsWith('debt_')) {
                const debtId = selected.split('_')[1];
                const debt = debts.find(d => d.id === debtId);
                if (debt) {
                    amountInput.placeholder = `Minimum: $${debt.minimumPayment}`;
                }
            } else if (selected.startsWith('card_')) {
                const cardId = selected.split('_')[1];
                const card = creditCards.find(c => c.id === cardId);
                if (card) {
                    const minPayment = Math.max(card.currentBalance * 0.02, 25);
                    amountInput.placeholder = `Minimum: $${formatCurrency(minPayment)}`;
                }
            }
        }

        // Save Payment
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const selected = document.getElementById('paymentFor').value;
            if (!selected) {
                alert('Please select a debt or credit card');
                return;
            }
            
            const [type, itemId] = selected.split('_');
            const paymentData = {
                amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
                paymentDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('paymentDate').value)),
                paymentType: document.getElementById('paymentType').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                referenceNumber: document.getElementById('referenceNumber').value.trim(),
                notes: document.getElementById('paymentNotes').value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (type === 'debt') {
                    // Save to debt payments
                    const paymentRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId).collection('payments');
                    await paymentRef.add(paymentData);
                    
                    // Update debt balance
                    const debtRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId);
                    const debtDoc = await debtRef.get();
                    const currentBalance = debtDoc.data().currentBalance || 0;
                    const newBalance = Math.max(0, currentBalance - paymentData.amount);
                    
                    await debtRef.update({
                        currentBalance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                } else if (type === 'card') {
                    // Save to credit card payments
                    const paymentRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId).collection('payments');
                    await paymentRef.add(paymentData);
                    
                    // Update card balance
                    const cardRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId);
                    const cardDoc = await cardRef.get();
                    const currentBalance = cardDoc.data().currentBalance || 0;
                    const newBalance = Math.max(0, currentBalance - paymentData.amount);
                    
                    await cardRef.update({
                        currentBalance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                closePaymentModal();
                loadDebts();
                loadCreditCards();
                loadPayments();
                updateFinancialOverview();
                alert('Payment recorded successfully!');
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('Failed to record payment: ' + error.message);
            }
        });

        // Note Modal Functions
        function openNoteModal() {
            const modal = document.getElementById('noteModal');
            const select = document.getElementById('noteFor');
            
            // Clear previous options
            select.innerHTML = '<option value="">Select Debt/Card</option>';
            
            // Add debt options
            debts.forEach(debt => {
                select.innerHTML += `<option value="debt_${debt.id}">Debt: ${debt.name}</option>`;
            });
            
            // Add credit card options
            creditCards.forEach(card => {
                select.innerHTML += `<option value="card_${card.id}">Credit Card: ${card.cardName}</option>`;
            });
            
            modal.classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
        }

        // Save Note
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const selected = document.getElementById('noteFor').value;
            if (!selected) {
                alert('Please select a debt or credit card');
                return;
            }
            
            const [type, itemId] = selected.split('_');
            const noteData = {
                content: document.getElementById('noteContent').value.trim(),
                type: document.getElementById('noteType').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            try {
                if (type === 'debt') {
                    const notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId).collection('notes');
                    await notesRef.add(noteData);
                    
                } else if (type === 'card') {
                    const notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId).collection('notes');
                    await notesRef.add(noteData);
                }
                
                closeNoteModal();
                alert('Note saved successfully!');
                
                // If details modal is open, refresh notes
                if (currentItemId && currentItemType) {
                    loadItemNotes();
                }
                
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note: ' + error.message);
            }
        });

        // View Details Functions
        async function viewDebtDetails(debtId) {
            currentItemId = debtId;
            currentItemType = 'debt';
            
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            document.getElementById('detailsTitle').textContent = debt.name;
            
            const typeText = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            const statusText = debt.status.charAt(0).toUpperCase() + debt.status.slice(1).replace('_', ' ');
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${debt.name}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #666; margin-bottom: 5px;">Creditor</small>
                            <strong>${debt.creditor}</strong>
                        </div>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #666; margin-bottom: 5px;">Status</small>
                            <strong>${statusText}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Original Amount</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(debt.principalAmount)}</div>
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(debt.currentBalance)}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Interest Rate</label>
                        <div>${debt.interestRate}%</div>
                    </div>
                    <div class="form-group">
                        <label>Minimum Payment</label>
                        <div>$${formatCurrency(debt.minimumPayment)}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Frequency</label>
                        <div>${debt.paymentFrequency.charAt(0).toUpperCase() + debt.paymentFrequency.slice(1)}</div>
                    </div>
                    <div class="form-group">
                        <label>Due Day</label>
                        <div>${debt.paymentDueDay}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Debt Type</label>
                        <div>${typeText}</div>
                    </div>
                </div>
            `;
            
            if (debt.notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Additional Notes</h4>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px; white-space: pre-wrap;">${debt.notes}</div>
                    </div>
                `;
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            
            // Load notes for this debt
            await loadItemNotes();
            
            document.getElementById('detailsModal').classList.add('active');
        }

        async function viewCreditCardDetails(cardId) {
            currentItemId = cardId;
            currentItemType = 'card';
            
            const card = creditCards.find(c => c.id === cardId);
            if (!card) return;
            
            document.getElementById('detailsTitle').textContent = card.cardName;
            
            const availableCredit = card.creditLimit - card.currentBalance;
            const utilization = card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100).toFixed(1) : 0;
            const typeText = card.cardType.charAt(0).toUpperCase() + card.cardType.slice(1);
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${card.cardName}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #666; margin-bottom: 5px;">Issuer</small>
                            <strong>${card.issuer}</strong>
                        </div>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #666; margin-bottom: 5px;">Card Type</small>
                            <strong>${typeText}  ${card.lastFourDigits}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Credit Limit</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(card.creditLimit)}</div>
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(card.currentBalance)}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Available Credit</label>
                        <div>$${formatCurrency(availableCredit)}</div>
                    </div>
                    <div class="form-group">
                        <label>Credit Utilization</label>
                        <div>${utilization}%</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Due Day</label>
                        <div>${card.paymentDueDay}</div>
                    </div>
                    <div class="form-group">
                        <label>Statement Due Day</label>
                        <div>${card.statementDueDay}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Interest Rate</label>
                        <div>${card.interestRate || 0}%</div>
                    </div>
                    <div class="form-group">
                        <label>Annual Fee</label>
                        <div>$${formatCurrency(card.annualFee || 0)}</div>
                    </div>
                </div>
            `;
            
            if (card.notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Additional Notes</h4>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px; white-space: pre-wrap;">${card.notes}</div>
                    </div>
                `;
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            
            // Load notes for this card
            await loadItemNotes();
            
            document.getElementById('detailsModal').classList.add('active');
        }

        async function loadItemNotes() {
            if (!currentItemId || !currentItemType || !currentUser) return;
            
            try {
                let notesRef;
                if (currentItemType === 'debt') {
                    notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(currentItemId).collection('notes');
                } else {
                    notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(currentItemId).collection('notes');
                }
                
                const snapshot = await notesRef.orderBy('createdAt', 'desc').get();
                const notes = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    notes.push({
                        id: doc.id,
                        content: data.content || '',
                        type: data.type || 'general',
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                let html = '';
                if (notes.length === 0) {
                    html = '<p style="text-align: center; color: #666; padding: 20px;">No notes yet</p>';
                } else {
                    notes.forEach(note => {
                        const date = new Date(note.createdAt).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const typeText = note.type.charAt(0).toUpperCase() + note.type.slice(1).replace('_', ' ');
                        
                        html += `
                            <div style="background: var(--gray); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #666;">
                                    <span style="background: white; padding: 3px 8px; border-radius: 4px; font-weight: 500;">${typeText}</span>
                                    <span>${date}</span>
                                </div>
                                <div style="white-space: pre-wrap;">${note.content}</div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('itemNotes').innerHTML = html;
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('itemNotes').innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading notes</p>';
            }
        }

        function addNoteToCurrentItem() {
            if (!currentItemId || !currentItemType) return;
            
            closeDetailsModal();
            
            // Set the note modal to current item
            const select = document.getElementById('noteFor');
            const optionValue = `${currentItemType === 'debt' ? 'debt' : 'card'}_${currentItemId}`;
            
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === optionValue) {
                    select.selectedIndex = i;
                    break;
                }
            }
            
            openNoteModal();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
            currentItemId = null;
            currentItemType = null;
        }

        // Edit Functions
        function editDebt(debtId) {
            openDebtModal(debtId);
        }

        function editCreditCard(cardId) {
            openCreditCardModal(cardId);
        }

        // Delete Function
        async function deleteItem(type, id) {
            if (!confirm(`Are you sure you want to delete this ${type === 'debt' ? 'debt' : 'credit card'}?`)) return;
            
            try {
                if (type === 'debt') {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(id).delete();
                    loadDebts();
                } else {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(id).delete();
                    loadCreditCards();
                }
                
                updateFinancialOverview();
                loadUpcomingPayments();
                alert(`${type === 'debt' ? 'Debt' : 'Credit card'} deleted successfully!`);
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Failed to delete item: ' + error.message);
            }
        }

        // Record Payment For Specific Item
        function recordPaymentFor(type, id) {
            currentItemId = id;
            currentItemType = type;
            
            openPaymentModal();
            
            // Set the dropdown to the selected item
            const select = document.getElementById('paymentFor');
            const optionValue = `${type === 'debt' ? 'debt' : 'card'}_${id}`;
            
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === optionValue) {
                    select.selectedIndex = i;
                    updatePaymentType();
                    break;
                }
            }
        }

        // Analytics Functions
        function loadAnalytics() {
            // Debt Distribution Chart
            const debtCtx = document.getElementById('debtDistributionChart').getContext('2d');
            
            const debtTypes = {};
            debts.forEach(debt => {
                const type = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                debtTypes[type] = (debtTypes[type] || 0) + debt.currentBalance;
            });
            
            new Chart(debtCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(debtTypes),
                    datasets: [{
                        data: Object.values(debtTypes),
                        backgroundColor: [
                            '#6200ee',
                            '#3700b3',
                            '#03dac6',
                            '#ff9800',
                            '#f44336',
                            '#4caf50',
                            '#9c27b0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Debt by Type'
                        }
                    }
                }
            });
            
            // Credit Utilization Chart
            const creditCtx = document.getElementById('creditUtilizationChart').getContext('2d');
            
            const cardNames = creditCards.map(card => card.cardName);
            const balances = creditCards.map(card => card.currentBalance);
            const limits = creditCards.map(card => card.creditLimit);
            const utilizations = creditCards.map(card => 
                card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100) : 0
            );
            
            new Chart(creditCtx, {
                type: 'bar',
                data: {
                    labels: cardNames,
                    datasets: [
                        {
                            label: 'Current Balance',
                            data: balances,
                            backgroundColor: '#6200ee'
                        },
                        {
                            label: 'Credit Limit',
                            data: limits,
                            backgroundColor: '#03dac6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Credit Card Balances vs Limits'
                        }
                    }
                }
            });
            
            // Payment Trend Chart
            const paymentCtx = document.getElementById('paymentTrendChart').getContext('2d');
            
            // Group payments by month
            const monthlyPayments = {};
            payments.forEach(payment => {
                const date = new Date(payment.paymentDate);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyPayments[monthYear] = (monthlyPayments[monthYear] || 0) + payment.amount;
            });
            
            // Get last 6 months
            const months = [];
            const paymentData = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                months.push(monthName);
                paymentData.push(monthlyPayments[monthYear] || 0);
            }
            
            new Chart(paymentCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Payments',
                        data: paymentData,
                        borderColor: '#6200ee',
                        backgroundColor: 'rgba(98, 0, 238, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Payment Trends'
                        }
                    }
                }
            });
        }

        // Helper Functions
        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date for payment modal
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('paymentDate')) {
                document.getElementById('paymentDate').value = today;
            }
        });
    </script>
</body>
</html>