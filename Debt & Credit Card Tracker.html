<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt & Credit Card Tracker Pro</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #4f46e5;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --light: #ffffff;
            --dark: #1f2937;
            --gray: #f3f4f6;
            --dark-gray: #374151;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f59e0b 100%);
            --gradient-dark: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.3;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .logo i {
            font-size: 36px;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo .subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.15);
            padding: 12px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            z-index: 1;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            min-height: calc(100vh - 200px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--light);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 30px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-card {
            background: var(--gradient-dark);
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: var(--shadow);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .stat-item.total {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 15px;
            background: var(--light);
            border: 2px solid;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s ease;
            text-align: center;
            min-height: 120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .action-btn i {
            font-size: 28px;
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 12px;
            color: white;
        }

        .action-btn:nth-child(1) { border-color: var(--primary); }
        .action-btn:nth-child(1) i { background: var(--gradient-primary); }
        .action-btn:nth-child(2) { border-color: var(--success); }
        .action-btn:nth-child(2) i { background: var(--gradient-success); }
        .action-btn:nth-child(3) { border-color: var(--warning); }
        .action-btn:nth-child(3) i { background: var(--gradient-warning); }
        .action-btn:nth-child(4) { border-color: var(--accent); }
        .action-btn:nth-child(4) i { background: var(--gradient-success); }

        /* Main Content */
        .main-content {
            background: var(--light);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            background: var(--gray);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-gray);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        /* Content Header */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray);
        }

        .content-header h2 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: var(--gray);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--dark-gray);
            transition: all 0.3s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .add-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card-item {
            background: white;
            border-radius: 18px;
            padding: 25px;
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .card-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .card-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: var(--dark);
            font-size: 18px;
        }

        .card-title i {
            padding: 10px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 10px;
            font-size: 18px;
        }

        .card-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .status-active { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
        .status-paid { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
        .status-overdue { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
        .status-inactive { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; }
        .status-warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }

        .card-balance {
            font-size: 36px;
            font-weight: 800;
            margin: 20px 0;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .card-progress {
            margin: 20px 0;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--dark-gray);
            margin-top: 5px;
        }

        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            font-size: 14px;
        }

        .detail-item {
            background: var(--gray);
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .detail-item:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .detail-item small {
            display: block;
            color: #6b7280;
            margin-bottom: 5px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item:hover small {
            color: rgba(255,255,255,0.8);
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--gray);
        }

        .action-icon {
            padding: 12px;
            border-radius: 12px;
            background: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
        }

        .action-icon:hover {
            transform: rotate(15deg) scale(1.1);
            color: white;
        }

        .action-icon:nth-child(1):hover { background: var(--success); }
        .action-icon:nth-child(2):hover { background: var(--primary); }
        .action-icon:nth-child(3):hover { background: var(--warning); }
        .action-icon:nth-child(4):hover { background: var(--danger); }

        /* Calendar Container */
        .calendar-container {
            background: white;
            border-radius: 18px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 2px solid var(--gray);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            padding: 10px;
            background: var(--gray);
            border-radius: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            border: 2px solid var(--gray);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .calendar-day.today {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background: var(--danger);
            border-radius: 50%;
        }

        .calendar-day.has-card-events::after {
            background: var(--primary);
        }

        .calendar-day.has-payment-events::after {
            background: var(--success);
        }

        .calendar-events {
            margin-top: 20px;
        }

        .calendar-event {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: var(--gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-event.debt {
            border-left: 4px solid var(--danger);
        }

        .calendar-event.card {
            border-left: 4px solid var(--primary);
        }

        .calendar-event.payment {
            border-left: 4px solid var(--success);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.5s ease;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-60px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gradient-primary);
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
        }

        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid var(--gray);
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--dark);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 70px;
            color: var(--gray);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 24px;
            font-weight: 700;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .insight-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .insight-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 24px;
            color: white;
        }

        .insight-card:nth-child(1) .insight-icon { background: var(--gradient-primary); }
        .insight-card:nth-child(2) .insight-icon { background: var(--gradient-success); }
        .insight-card:nth-child(3) .insight-icon { background: var(--gradient-warning); }
        .insight-card:nth-child(4) .insight-icon { background: var(--gradient-danger); }

        /* Enhanced UI Components */
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .spinner {
            width: 70px;
            height: 70px;
            border-width: 5px;
        }

        .data-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            border-left: 5px solid;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .data-status.success {
            border-left-color: #10b981;
        }

        .data-status.error {
            border-left-color: #ef4444;
        }

        .data-status.warning {
            border-left-color: #f59e0b;
        }

        .offline-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #ef4444;
            color: #991b1b;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .indicator-high { background: var(--danger); }
        .indicator-medium { background: var(--warning); }
        .indicator-low { background: var(--success); }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 300px 1fr;
            }
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .app-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
                padding: 20px;
            }
            
            .content-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                font-size: 12px;
            }
            
            .refresh-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Login Prompt */
        .login-prompt {
            display: none;
            text-align: center;
            padding: 100px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 50px auto;
        }

        .login-prompt.active {
            display: block;
        }

        .login-prompt i {
            font-size: 80px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .login-prompt h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 32px;
            font-weight: 800;
        }

        .login-prompt p {
            color: #6b7280;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Print Styles */
        @media print {
            .refresh-btn,
            .add-btn,
            .logout-btn,
            .action-btn,
            .action-icon {
                display: none !important;
            }
            
            .card-item:hover {
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #6366f1; font-weight: 600;" id="loadingText">Loading Data...</p>
    </div>

    <!-- Data Status Indicator -->
    <div id="dataStatus" class="data-status">
        <i class="bi bi-check-circle"></i>
        <span>Data refreshed successfully!</span>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="bi bi-wifi-off"></i>
        <span>You are offline. Working with cached data.</span>
    </div>

    <!-- Error Message Container -->
    <div id="errorContainer" style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 1002; display: none;"></div>

    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshAllData()" id="refreshBtn" title="Refresh Data">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- Login Prompt -->
    <div id="loginPrompt" class="login-prompt active">
        <i class="bi bi-shield-lock"></i>
        <h2>Welcome to Debt Tracker Pro</h2>
        <p>Securely manage your debts, credit cards, and payments with advanced analytics and calendar integration.</p>
        <button class="btn btn-primary" onclick="redirectToLogin()">
            <i class="bi bi-box-arrow-in-right"></i> Go to Login
        </button>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="appContainer" class="container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <i class="bi bi-piggy-bank"></i>
                <div>
                    <h1>Debt Tracker Pro</h1>
                    <div class="subtitle">Smart Financial Management</div>
                </div>
            </div>
            <div class="user-info">
                <span><i class="bi bi-person-circle"></i> <span id="userEmail"></span></span>
                <div style="position: relative; cursor: pointer;" onclick="showNotifications()">
                    <i class="bi bi-bell" style="font-size: 20px;"></i>
                    <div id="notificationCount" class="notification-badge" style="display: none;">0</div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3><i class="bi bi-speedometer2"></i> Financial Dashboard</h3>
                    <div class="stats-card">
                        <div class="stat-item">
                            <span>Total Debt:</span>
                            <span id="totalDebt">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span>Credit Limit:</span>
                            <span id="totalCredit">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span>Available Credit:</span>
                            <span id="availableCredit">$0.00</span>
                        </div>
                        <div class="stat-item total">
                            <span>Net Debt:</span>
                            <span id="netDebt">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-rocket-takeoff"></i> Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="openDebtModal()">
                            <i class="bi bi-plus-circle"></i>
                            <span>Add Debt</span>
                        </button>
                        <button class="action-btn" onclick="openCreditCardModal()">
                            <i class="bi bi-credit-card"></i>
                            <span>Add Card</span>
                        </button>
                        <button class="action-btn" onclick="openPaymentModal()">
                            <i class="bi bi-cash"></i>
                            <span>Record Payment</span>
                        </button>
                        <button class="action-btn" onclick="openNoteModal()">
                            <i class="bi bi-sticky"></i>
                            <span>Add Note</span>
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-calendar-week"></i> Due This Week</h3>
                    <div id="upcomingPayments">
                        <div class="loading" style="padding: 10px;">
                            <div class="spinner" style="width: 30px; height: 30px;"></div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-lightbulb"></i> Quick Insights</h3>
                    <div id="quickInsights">
                        <div class="loading" style="padding: 10px;">
                            <div class="spinner" style="width: 30px; height: 30px;"></div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="bi bi-clock-history"></i> Last Updated</h3>
                    <div id="lastUpdated" style="text-align: center; padding: 10px; background: var(--gray); border-radius: 10px;">
                        <span style="font-size: 12px; color: var(--dark-gray);">Never</span>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('debts')">
                        <i class="bi bi-cash"></i> Debts
                    </button>
                    <button class="tab" onclick="switchTab('creditCards')">
                        <i class="bi bi-credit-card"></i> Cards
                    </button>
                    <button class="tab" onclick="switchTab('calendar')">
                        <i class="bi bi-calendar3"></i> Calendar
                    </button>
                    <button class="tab" onclick="switchTab('payments')">
                        <i class="bi bi-cash-stack"></i> Payments
                    </button>
                    <button class="tab" onclick="switchTab('analytics')">
                        <i class="bi bi-graph-up"></i> Analytics
                    </button>
                </div>

                <!-- Debts Tab -->
                <div id="debtsTab" class="tab-content active">
                    <div class="content-header">
                        <h2><i class="bi bi-cash-stack"></i> Your Debts</h2>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterDebts('all')">All</button>
                                <button class="filter-btn" onclick="filterDebts('active')">Active</button>
                                <button class="filter-btn" onclick="filterDebts('overdue')">Overdue</button>
                                <button class="filter-btn" onclick="filterDebts('paid')">Paid</button>
                            </div>
                            <button class="add-btn" onclick="openDebtModal()">
                                <i class="bi bi-plus-lg"></i> Add Debt
                            </button>
                        </div>
                    </div>
                    
                    <div class="cards-grid" id="debtsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading debts...</p>
                        </div>
                    </div>
                </div>

                <!-- Credit Cards Tab -->
                <div id="creditCardsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-credit-card-2-front"></i> Credit Cards</h2>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterCards('all')">All</button>
                                <button class="filter-btn" onclick="filterCards('high')">High Utilization</button>
                                <button class="filter-btn" onclick="filterCards('due')">Due Soon</button>
                                <button class="filter-btn" onclick="filterCards('inactive')">Inactive</button>
                            </div>
                            <button class="add-btn" onclick="openCreditCardModal()">
                                <i class="bi bi-plus-lg"></i> Add Card
                            </button>
                        </div>
                    </div>
                    
                    <div class="cards-grid" id="creditCardsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading credit cards...</p>
                        </div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="calendarTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-calendar3"></i> Payment Calendar</h2>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn btn-success" onclick="printCalendar()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                            <button class="btn btn-primary" onclick="exportCalendarData()">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="btn btn-secondary" onclick="prevMonth()">
                                <i class="bi bi-chevron-left"></i> Prev
                            </button>
                            <h3 id="currentMonth" style="margin: 0; color: var(--primary);"></h3>
                            <button class="btn btn-secondary" onclick="nextMonth()">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-grid" id="calendarDays">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                        
                        <div class="calendar-events" id="calendarEvents">
                            <!-- Events will be displayed here -->
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; background: var(--danger); border-radius: 3px;"></div>
                            <span>Debt Due Dates</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; background: var(--primary); border-radius: 3px;"></div>
                            <span>Card Due Dates</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; background: var(--success); border-radius: 3px;"></div>
                            <span>Payments Made</span>
                        </div>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div id="paymentsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-cash-stack"></i> Payment History</h2>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterPayments('all')">All</button>
                                <button class="filter-btn" onclick="filterPayments('month')">This Month</button>
                                <button class="filter-btn" onclick="filterPayments('year')">This Year</button>
                                <button class="filter-btn" onclick="filterPayments('large')">Large Payments</button>
                            </div>
                            <button class="add-btn" onclick="openPaymentModal()">
                                <i class="bi bi-plus-lg"></i> Record Payment
                            </button>
                        </div>
                    </div>
                    
                    <div id="paymentsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading payment history...</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div id="analyticsTab" class="tab-content">
                    <div class="content-header">
                        <h2><i class="bi bi-graph-up-arrow"></i> Financial Analytics</h2>
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterAnalytics('month')">Month</button>
                            <button class="filter-btn" onclick="filterAnalytics('quarter')">Quarter</button>
                            <button class="filter-btn" onclick="filterAnalytics('year')">Year</button>
                        </div>
                    </div>
                    
                    <!-- Insights Cards -->
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-arrow-down-circle"></i>
                            </div>
                            <h3 id="debtReduction">$0.00</h3>
                            <p>Total Debt Reduction</p>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-percent"></i>
                            </div>
                            <h3 id="avgInterest">0%</h3>
                            <p>Average Interest Rate</p>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <h3 id="onTimePayments">0</h3>
                            <p>On-Time Payments</p>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <h3 id="daysToPayoff">0</h3>
                            <p>Avg Days to Payoff</p>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3><i class="bi bi-pie-chart"></i> Debt Distribution</h3>
                            <canvas id="debtDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="bi bi-bar-chart"></i> Credit Utilization</h3>
                            <canvas id="creditUtilizationChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="bi bi-graph-up"></i> Payment Trends</h3>
                            <canvas id="paymentTrendChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3><i class="bi bi-currency-dollar"></i> Interest Analysis</h3>
                            <canvas id="interestChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Debt Payoff Forecast -->
                    <div class="chart-container" style="margin-top: 30px;">
                        <h3><i class="bi bi-hourglass-split"></i> Debt Payoff Forecast</h3>
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Debt Modal -->
    <div id="debtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="debtModalTitle">Add New Debt</h3>
                <button class="close-modal" onclick="closeDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="debtForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Debt Name *</label>
                            <input type="text" id="debtName" required placeholder="e.g., Student Loan">
                        </div>
                        <div class="form-group">
                            <label>Creditor *</label>
                            <input type="text" id="creditor" required placeholder="e.g., Bank of America">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Debt Type *</label>
                            <select id="debtType" required>
                                <option value="">Select Type</option>
                                <option value="personal_loan">Personal Loan</option>
                                <option value="mortgage">Mortgage</option>
                                <option value="car_loan">Car Loan</option>
                                <option value="student_loan">Student Loan</option>
                                <option value="business_loan">Business Loan</option>
                                <option value="medical_debt">Medical Debt</option>
                                <option value="credit_card_debt">Credit Card Debt</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="debtStatus" required>
                                <option value="active">Active</option>
                                <option value="paid_off">Paid Off</option>
                                <option value="defaulted">Defaulted</option>
                                <option value="in_collection">In Collection</option>
                                <option value="settled">Settled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Principal Amount ($) *</label>
                            <input type="number" id="principalAmount" step="0.01" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Current Balance ($) *</label>
                            <input type="number" id="currentBalance" step="0.01" required min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Interest Rate (%) *</label>
                            <input type="number" id="interestRate" step="0.01" required min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Minimum Payment ($) *</label>
                            <input type="number" id="minimumPayment" step="0.01" required min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Due Date Day *</label>
                            <input type="number" id="paymentDueDay" min="1" max="31" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Payment Frequency</label>
                            <select id="paymentFrequency">
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="bi_weekly">Bi-weekly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="debtNotes" placeholder="Add any additional notes about this debt..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDebtModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Debt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Credit Card Modal -->
    <div id="creditCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="creditCardModalTitle">Add Credit Card</h3>
                <button class="close-modal" onclick="closeCreditCardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="creditCardForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Card Name *</label>
                            <input type="text" id="cardName" required placeholder="e.g., Platinum Card">
                        </div>
                        <div class="form-group">
                            <label>Issuer *</label>
                            <input type="text" id="issuer" required placeholder="e.g., Chase">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Card Type *</label>
                            <select id="cardType" required>
                                <option value="">Select Type</option>
                                <option value="visa">Visa</option>
                                <option value="mastercard">MasterCard</option>
                                <option value="amex">American Express</option>
                                <option value="discover">Discover</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Last 4 Digits *</label>
                            <input type="text" id="lastFourDigits" maxlength="4" required pattern="\d{4}" placeholder="1234">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Credit Limit ($) *</label>
                            <input type="number" id="creditLimit" step="0.01" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Current Balance ($) *</label>
                            <input type="number" id="cardBalance" step="0.01" required min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Interest Rate (%)</label>
                            <input type="number" id="cardInterestRate" step="0.01" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Annual Fee ($)</label>
                            <input type="number" id="annualFee" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Due Day</label>
                            <input type="number" id="cardDueDay" min="1" max="31" value="1">
                        </div>
                        <div class="form-group">
                            <label>Statement Due Day</label>
                            <input type="number" id="statementDueDay" min="1" max="31" value="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="cardNotes" placeholder="Add any notes about this credit card..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreditCardModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Card</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment For *</label>
                            <select id="paymentFor" required onchange="updatePaymentType()">
                                <option value="">Select Debt/Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Type</label>
                            <select id="paymentType">
                                <option value="regular">Regular Payment</option>
                                <option value="extra">Extra Payment</option>
                                <option value="settlement">Settlement</option>
                                <option value="minimum">Minimum Payment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount ($) *</label>
                            <input type="number" id="paymentAmount" step="0.01" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Payment Date *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod">
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="check">Check</option>
                                <option value="cash">Cash</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="debit_card">Debit Card</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reference Number</label>
                            <input type="text" id="referenceNumber" placeholder="Optional">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="paymentNotes" placeholder="Add any notes about this payment..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Record Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Note</h3>
                <button class="close-modal" onclick="closeNoteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <div class="form-group">
                        <label>Select Item *</label>
                        <select id="noteFor" required>
                            <option value="">Select Debt/Card</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Note Type</label>
                        <select id="noteType">
                            <option value="general">General Note</option>
                            <option value="contact">Contact Info</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="legal">Legal Notes</option>
                            <option value="reminder">Reminder</option>
                            <option value="followup">Follow-up</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Content *</label>
                        <textarea id="noteContent" rows="6" required placeholder="Write your note here..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailsTitle">Details</h3>
                <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detailsContent"></div>
                <div class="sidebar-section" style="margin-top: 30px;">
                    <h3><i class="bi bi-sticky"></i> Notes</h3>
                    <div id="itemNotes" style="margin-bottom: 20px;">
                        <div class="loading" style="padding: 10px;">
                            <div class="spinner" style="width: 30px; height: 30px;"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addNoteToCurrentItem()">
                        <i class="bi bi-plus"></i> Add Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.firebasestorage.app",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        };

        // Initialize Firebase
        let app, db, auth;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Enable offline persistence
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.log('The current browser doesn\'t support persistence.');
                    }
                });
        } catch (error) {
            showError('Failed to initialize Firebase: ' + error.message);
        }

        // Global Variables
        let currentUser = null;
        let currentTab = 'debts';
        let currentItemId = null;
        let currentItemType = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        
        // Data State
        let dataState = {
            debts: [],
            creditCards: [],
            payments: [],
            notes: [],
            lastUpdated: null,
            isLoading: false,
            error: null
        };

        // Chart instances
        let charts = {};

        // Real-time listeners
        let debtListener = null;
        let cardListener = null;

        // Network status
        let isOnline = navigator.onLine;

        // Check Authentication State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                try {
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('loginPrompt').classList.remove('active');
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // Clear previous listeners
                    cleanupListeners();
                    
                    // Load initial data
                    await loadUserData();
                    
                    // Set up real-time listeners
                    setupRealtimeListeners();
                    
                } catch (error) {
                    showError('Failed to initialize app: ' + error.message);
                }
            } else {
                currentUser = null;
                document.getElementById('loginPrompt').classList.add('active');
                document.getElementById('appContainer').style.display = 'none';
                cleanupListeners();
            }
        });

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            document.getElementById('offlineIndicator').style.display = 'none';
            if (currentUser) {
                showLoading('Syncing data...');
                setTimeout(() => {
                    refreshAllData();
                }, 1000);
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            document.getElementById('offlineIndicator').style.display = 'flex';
        });

        // Setup real-time listeners
        function setupRealtimeListeners() {
            if (!currentUser) return;

            // Debts listener
            const debtsRef = db.collection('users').doc(currentUser.uid).collection('debts');
            debtListener = debtsRef.onSnapshot(
                (snapshot) => {
                    const newDebts = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        newDebts.push({
                            id: doc.id,
                            name: data.name || '',
                            creditor: data.creditor || '',
                            type: data.type || 'personal_loan',
                            status: data.status || 'active',
                            principalAmount: parseFloat(data.principalAmount) || 0,
                            currentBalance: parseFloat(data.currentBalance) || 0,
                            interestRate: parseFloat(data.interestRate) || 0,
                            minimumPayment: parseFloat(data.minimumPayment) || 0,
                            paymentFrequency: data.paymentFrequency || 'monthly',
                            paymentDueDay: data.paymentDueDay || 1,
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date(),
                            updatedAt: data.updatedAt?.toDate() || new Date()
                        });
                    });
                    
                    dataState.debts = newDebts;
                    renderDebts();
                    updateFinancialOverview();
                    updateNotifications();
                    updateUpcomingPayments();
                    loadQuickInsights();
                    
                    if (currentTab === 'calendar') {
                        renderCalendar();
                    }
                    if (currentTab === 'analytics') {
                        loadAnalytics();
                    }
                    
                    saveToCache();
                    updateLastUpdated();
                },
                (error) => {
                    console.error('Error listening to debts:', error);
                }
            );

            // Credit Cards listener
            const cardsRef = db.collection('users').doc(currentUser.uid).collection('creditCards');
            cardListener = cardsRef.onSnapshot(
                (snapshot) => {
                    const newCards = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        newCards.push({
                            id: doc.id,
                            cardName: data.cardName || '',
                            issuer: data.issuer || '',
                            cardType: data.cardType || 'visa',
                            lastFourDigits: data.lastFourDigits || '',
                            creditLimit: parseFloat(data.creditLimit) || 0,
                            currentBalance: parseFloat(data.currentBalance) || 0,
                            interestRate: parseFloat(data.interestRate) || 0,
                            annualFee: parseFloat(data.annualFee) || 0,
                            paymentDueDay: data.paymentDueDay || 1,
                            statementDueDay: data.statementDueDay || 1,
                            status: data.status || 'active',
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date(),
                            updatedAt: data.updatedAt?.toDate() || new Date()
                        });
                    });
                    
                    dataState.creditCards = newCards;
                    renderCreditCards();
                    updateFinancialOverview();
                    updateNotifications();
                    updateUpcomingPayments();
                    loadQuickInsights();
                    
                    if (currentTab === 'calendar') {
                        renderCalendar();
                    }
                    if (currentTab === 'analytics') {
                        loadAnalytics();
                    }
                    
                    saveToCache();
                    updateLastUpdated();
                },
                (error) => {
                    console.error('Error listening to credit cards:', error);
                }
            );
        }

        // Cleanup listeners
        function cleanupListeners() {
            if (debtListener) {
                debtListener();
                debtListener = null;
            }
            if (cardListener) {
                cardListener();
                cardListener = null;
            }
        }

        // Load User Data
        async function loadUserData() {
            if (!currentUser) {
                showError('No user logged in');
                return;
            }

            showLoading('Loading your financial data...');
            dataState.isLoading = true;

            try {
                // Try to load from cache first
                await loadCachedData();
                
                // Then try to load from Firebase
                await Promise.all([
                    loadInitialDebts(),
                    loadInitialCreditCards()
                ]);
                
                // Load payments
                await loadInitialPayments();
                
                // Update UI
                updateFinancialOverview();
                updateUpcomingPayments();
                loadQuickInsights();
                updateNotifications();
                
                if (currentTab === 'calendar') {
                    renderCalendar();
                }
                if (currentTab === 'analytics') {
                    loadAnalytics();
                }
                
                dataState.lastUpdated = new Date();
                dataState.isLoading = false;
                
                hideLoading();
                showDataStatus('Data loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading user data:', error);
                dataState.error = error.message;
                dataState.isLoading = false;
                
                hideLoading();
                showError('Failed to load data: ' + error.message);
            }
        }

        // Load initial debts
        async function loadInitialDebts() {
            try {
                const debtsRef = db.collection('users').doc(currentUser.uid).collection('debts');
                const snapshot = await debtsRef.orderBy('createdAt', 'desc').get();
                
                const newDebts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newDebts.push({
                        id: doc.id,
                        name: data.name || '',
                        creditor: data.creditor || '',
                        type: data.type || 'personal_loan',
                        status: data.status || 'active',
                        principalAmount: parseFloat(data.principalAmount) || 0,
                        currentBalance: parseFloat(data.currentBalance) || 0,
                        interestRate: parseFloat(data.interestRate) || 0,
                        minimumPayment: parseFloat(data.minimumPayment) || 0,
                        paymentFrequency: data.paymentFrequency || 'monthly',
                        paymentDueDay: data.paymentDueDay || 1,
                        notes: data.notes || '',
                        createdAt: data.createdAt?.toDate() || new Date(),
                        updatedAt: data.updatedAt?.toDate() || new Date()
                    });
                });
                
                dataState.debts = newDebts;
                renderDebts();
            } catch (error) {
                console.error('Error loading debts:', error);
                throw error;
            }
        }

        // Load initial credit cards
        async function loadInitialCreditCards() {
            try {
                const cardsRef = db.collection('users').doc(currentUser.uid).collection('creditCards');
                const snapshot = await cardsRef.orderBy('createdAt', 'desc').get();
                
                const newCards = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newCards.push({
                        id: doc.id,
                        cardName: data.cardName || '',
                        issuer: data.issuer || '',
                        cardType: data.cardType || 'visa',
                        lastFourDigits: data.lastFourDigits || '',
                        creditLimit: parseFloat(data.creditLimit) || 0,
                        currentBalance: parseFloat(data.currentBalance) || 0,
                        interestRate: parseFloat(data.interestRate) || 0,
                        annualFee: parseFloat(data.annualFee) || 0,
                        paymentDueDay: data.paymentDueDay || 1,
                        statementDueDay: data.statementDueDay || 1,
                        status: data.status || 'active',
                        notes: data.notes || '',
                        createdAt: data.createdAt?.toDate() || new Date(),
                        updatedAt: data.updatedAt?.toDate() || new Date()
                    });
                });
                
                dataState.creditCards = newCards;
                renderCreditCards();
            } catch (error) {
                console.error('Error loading credit cards:', error);
                throw error;
            }
        }

        // Load initial payments
        async function loadInitialPayments() {
            try {
                dataState.payments = await getAllPayments();
                renderPayments();
            } catch (error) {
                console.error('Error loading payments:', error);
                throw error;
            }
        }

        // Get all payments
        async function getAllPayments() {
            const allPayments = [];
            
            try {
                // Get debt payments
                for (const debt of dataState.debts) {
                    const paymentsRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(debt.id).collection('payments');
                    const snapshot = await paymentsRef.orderBy('paymentDate', 'desc').limit(50).get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allPayments.push({
                            id: doc.id,
                            debtId: debt.id,
                            debtName: debt.name,
                            type: 'debt',
                            amount: parseFloat(data.amount) || 0,
                            paymentDate: data.paymentDate?.toDate() || new Date(),
                            paymentType: data.paymentType || 'regular',
                            paymentMethod: data.paymentMethod || 'bank_transfer',
                            referenceNumber: data.referenceNumber || '',
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date()
                        });
                    });
                }
                
                // Get credit card payments
                for (const card of dataState.creditCards) {
                    const paymentsRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(card.id).collection('payments');
                    const snapshot = await paymentsRef.orderBy('paymentDate', 'desc').limit(50).get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allPayments.push({
                            id: doc.id,
                            cardId: card.id,
                            cardName: card.cardName,
                            type: 'card',
                            amount: parseFloat(data.amount) || 0,
                            paymentDate: data.paymentDate?.toDate() || new Date(),
                            paymentType: data.paymentType || 'regular',
                            paymentMethod: data.paymentMethod || 'bank_transfer',
                            referenceNumber: data.referenceNumber || '',
                            notes: data.notes || '',
                            createdAt: data.createdAt?.toDate() || new Date()
                        });
                    });
                }
                
                return allPayments.sort((a, b) => b.paymentDate - a.paymentDate);
            } catch (error) {
                console.error('Error getting payments:', error);
                return allPayments;
            }
        }

        // Load cached data
        async function loadCachedData() {
            try {
                const cachedDebts = localStorage.getItem(`debts_${currentUser.uid}`);
                const cachedCards = localStorage.getItem(`cards_${currentUser.uid}`);
                const cachedPayments = localStorage.getItem(`payments_${currentUser.uid}`);
                
                if (cachedDebts) {
                    dataState.debts = JSON.parse(cachedDebts);
                }
                if (cachedCards) {
                    dataState.creditCards = JSON.parse(cachedCards);
                }
                if (cachedPayments) {
                    dataState.payments = JSON.parse(cachedPayments);
                }
                
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading cached data:', error);
            }
        }

        // Save to cache
        function saveToCache() {
            if (!currentUser) return;
            
            try {
                localStorage.setItem(`debts_${currentUser.uid}`, JSON.stringify(dataState.debts));
                localStorage.setItem(`cards_${currentUser.uid}`, JSON.stringify(dataState.creditCards));
                localStorage.setItem(`payments_${currentUser.uid}`, JSON.stringify(dataState.payments));
                localStorage.setItem(`lastUpdated_${currentUser.uid}`, new Date().toISOString());
            } catch (error) {
                console.error('Error saving to cache:', error);
            }
        }

        // Refresh all data
        async function refreshAllData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');
            
            try {
                showLoading('Refreshing data...');
                
                // Clear cache and reload
                cleanupListeners();
                await loadUserData();
                setupRealtimeListeners();
                
                showDataStatus('Data refreshed successfully!', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('Failed to refresh data: ' + error.message);
            } finally {
                refreshBtn.classList.remove('spinning');
                hideLoading();
            }
        }

        // Render Debts
        function renderDebts(filter = 'all') {
            const debtsList = document.getElementById('debtsList');
            if (!debtsList) return;
            
            try {
                let filteredDebts = dataState.debts;
                
                if (filter === 'active') {
                    filteredDebts = dataState.debts.filter(d => d.status === 'active');
                } else if (filter === 'overdue') {
                    const today = new Date();
                    filteredDebts = dataState.debts.filter(debt => {
                        const dueDate = new Date(today.getFullYear(), today.getMonth(), debt.paymentDueDay);
                        return debt.status === 'active' && today > dueDate;
                    });
                } else if (filter === 'paid') {
                    filteredDebts = dataState.debts.filter(d => d.status === 'paid_off');
                }
                
                if (filteredDebts.length === 0) {
                    debtsList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-cash"></i>
                            <h3>No debts found</h3>
                            <p>${filter !== 'all' ? `No ${filter} debts` : 'Add your first debt to get started'}</p>
                            <button class="btn btn-primary" onclick="openDebtModal()" style="margin-top: 20px;">
                                <i class="bi bi-plus"></i> Add Debt
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredDebts.forEach(debt => {
                    const statusClass = `status-${debt.status === 'paid_off' ? 'paid' : debt.status === 'defaulted' ? 'overdue' : 'active'}`;
                    const statusText = debt.status.charAt(0).toUpperCase() + debt.status.slice(1).replace('_', ' ');
                    const typeText = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    const progress = debt.principalAmount > 0 ? ((debt.principalAmount - debt.currentBalance) / debt.principalAmount * 100) : 0;
                    
                    html += `
                        <div class="card-item" onclick="viewDebtDetails('${debt.id}')">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-cash"></i>
                                    ${debt.name}
                                </div>
                                <span class="card-status ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="card-balance">$${formatCurrency(debt.currentBalance)}</div>
                            
                            ${debt.principalAmount > 0 ? `
                                <div class="card-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%; background: ${progress > 70 ? '#10b981' : progress > 40 ? '#f59e0b' : '#ef4444'};"></div>
                                    </div>
                                    <div class="progress-text">
                                        <span>Paid: $${formatCurrency(debt.principalAmount - debt.currentBalance)}</span>
                                        <span>${progress.toFixed(1)}%</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Creditor</small>
                                    <div>${debt.creditor}</div>
                                </div>
                                <div class="detail-item">
                                    <small>Type</small>
                                    <div>${typeText}</div>
                                </div>
                            </div>
                            
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Interest Rate</small>
                                    <div>${debt.interestRate}%</div>
                                </div>
                                <div class="detail-item">
                                    <small>Due Day</small>
                                    <div>${debt.paymentDueDay}</div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <div class="action-icon" onclick="event.stopPropagation(); recordPaymentFor('debt', '${debt.id}')" title="Record Payment">
                                    <i class="bi bi-cash"></i>
                                </div>
                                <div class="action-icon" onclick="event.stopPropagation(); editDebt('${debt.id}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </div>
                                <div class="action-icon" onclick="event.stopPropagation(); deleteItem('debt', '${debt.id}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                debtsList.innerHTML = html;
            } catch (error) {
                console.error('Error rendering debts:', error);
                debtsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading debts</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Render Credit Cards
        function renderCreditCards(filter = 'all') {
            const cardsList = document.getElementById('creditCardsList');
            if (!cardsList) return;
            
            try {
                let filteredCards = dataState.creditCards;
                
                if (filter === 'high') {
                    filteredCards = dataState.creditCards.filter(card => 
                        card.creditLimit > 0 && (card.currentBalance / card.creditLimit) > 0.5
                    );
                } else if (filter === 'due') {
                    const today = new Date();
                    const currentDay = today.getDate();
                    filteredCards = dataState.creditCards.filter(card => 
                        card.status === 'active' && card.paymentDueDay >= currentDay && card.paymentDueDay <= currentDay + 7
                    );
                } else if (filter === 'inactive') {
                    filteredCards = dataState.creditCards.filter(card => card.status !== 'active');
                }
                
                if (filteredCards.length === 0) {
                    cardsList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-credit-card"></i>
                            <h3>No credit cards found</h3>
                            <p>${filter !== 'all' ? `No ${filter} credit cards` : 'Add your first credit card to get started'}</p>
                            <button class="btn btn-primary" onclick="openCreditCardModal()" style="margin-top: 20px;">
                                <i class="bi bi-plus"></i> Add Credit Card
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredCards.forEach(card => {
                    const availableCredit = card.creditLimit - card.currentBalance;
                    const utilization = card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100).toFixed(1) : 0;
                    const statusClass = card.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = card.status.charAt(0).toUpperCase() + card.status.slice(1);
                    const typeText = card.cardType.charAt(0).toUpperCase() + card.cardType.slice(1);
                    
                    html += `
                        <div class="card-item" onclick="viewCreditCardDetails('${card.id}')">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi bi-credit-card"></i>
                                    ${card.cardName}
                                </div>
                                <span class="card-status ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="card-balance">$${formatCurrency(card.currentBalance)}</div>
                            
                            <div class="card-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${utilization}%; background: ${utilization > 80 ? '#ef4444' : utilization > 50 ? '#f59e0b' : '#10b981'};"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Available: $${formatCurrency(availableCredit)}</span>
                                    <span>${utilization}%</span>
                                </div>
                            </div>
                            
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Credit Limit</small>
                                    <div>$${formatCurrency(card.creditLimit)}</div>
                                </div>
                                <div class="detail-item">
                                    <small>Due Day</small>
                                    <div>${card.paymentDueDay}</div>
                                </div>
                            </div>
                            
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Issuer</small>
                                    <div>${card.issuer}</div>
                                </div>
                                <div class="detail-item">
                                    <small>Card Type</small>
                                    <div>${typeText}  ${card.lastFourDigits}</div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <div class="action-icon" onclick="event.stopPropagation(); recordPaymentFor('card', '${card.id}')" title="Record Payment">
                                    <i class="bi bi-cash"></i>
                                </div>
                                <div class="action-icon" onclick="event.stopPropagation(); editCreditCard('${card.id}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </div>
                                <div class="action-icon" onclick="event.stopPropagation(); deleteItem('card', '${card.id}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cardsList.innerHTML = html;
            } catch (error) {
                console.error('Error rendering credit cards:', error);
                cardsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading credit cards</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Render Payments
        function renderPayments(filter = 'all') {
            const paymentsList = document.getElementById('paymentsList');
            if (!paymentsList) return;
            
            try {
                let filteredPayments = dataState.payments;
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                
                if (filter === 'month') {
                    filteredPayments = dataState.payments.filter(payment => {
                        const paymentDate = new Date(payment.paymentDate);
                        return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                    });
                } else if (filter === 'year') {
                    filteredPayments = dataState.payments.filter(payment => {
                        const paymentDate = new Date(payment.paymentDate);
                        return paymentDate.getFullYear() === currentYear;
                    });
                } else if (filter === 'large') {
                    filteredPayments = dataState.payments.filter(payment => payment.amount > 500);
                }
                
                if (filteredPayments.length === 0) {
                    paymentsList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-cash-stack"></i>
                            <h3>No payments found</h3>
                            <p>${filter !== 'all' ? `No ${filter} payments` : 'Record your first payment to get started'}</p>
                            <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 20px;">
                                <i class="bi bi-plus"></i> Record Payment
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="cards-grid">';
                filteredPayments.forEach(payment => {
                    const paymentDate = new Date(payment.paymentDate);
                    const formattedDate = paymentDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const itemName = payment.type === 'debt' ? payment.debtName : payment.cardName;
                    const icon = payment.type === 'debt' ? 'bi-cash' : 'bi-credit-card';
                    const colorClass = payment.type === 'debt' ? 'debt' : 'card';
                    
                    html += `
                        <div class="card-item ${colorClass}">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="bi ${icon}"></i>
                                    ${itemName}
                                </div>
                                <small>${formattedDate}</small>
                            </div>
                            
                            <div class="card-balance">$${formatCurrency(payment.amount)}</div>
                            
                            <div class="card-details">
                                <div class="detail-item">
                                    <small>Type</small>
                                    <div>${payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1)}</div>
                                </div>
                                <div class="detail-item">
                                    <small>Method</small>
                                    <div>${payment.paymentMethod.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</div>
                                </div>
                            </div>
                            
                            ${payment.referenceNumber ? `
                                <div class="card-details">
                                    <div class="detail-item">
                                        <small>Reference</small>
                                        <div>${payment.referenceNumber}</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${payment.notes ? `
                                <div style="margin-top: 15px; padding: 15px; background: var(--gray); border-radius: 10px; font-size: 14px;">
                                    <small style="display: block; margin-bottom: 5px; color: #6b7280;">Notes:</small>
                                    ${payment.notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                
                paymentsList.innerHTML = html;
            } catch (error) {
                console.error('Error rendering payments:', error);
                paymentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Error loading payments</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Render Calendar
        function renderCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const currentMonthElement = document.getElementById('currentMonth');
            
            if (!calendarDays || !currentMonthElement) return;
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const totalDays = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday
            
            // Clear previous calendar
            calendarDays.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                calendarDays.innerHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add empty cells for days before the first day of month
            for (let i = 0; i < startingDay; i++) {
                calendarDays.innerHTML += '<div class="calendar-day"></div>';
            }
            
            // Add days of month
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
            
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const isToday = isCurrentMonth && day === today.getDate();
                
                // Check for events on this day
                const hasDebtEvents = dataState.debts.some(debt => 
                    debt.status === 'active' && debt.paymentDueDay === day
                );
                const hasCardEvents = dataState.creditCards.some(card => 
                    card.status === 'active' && card.paymentDueDay === day
                );
                const hasPaymentEvents = dataState.payments.some(payment => {
                    const paymentDate = new Date(payment.paymentDate);
                    return paymentDate.getDate() === day && 
                           paymentDate.getMonth() === currentMonth && 
                           paymentDate.getFullYear() === currentYear;
                });
                
                let eventClasses = '';
                if (hasDebtEvents) eventClasses += ' has-events';
                if (hasCardEvents) eventClasses += ' has-card-events';
                if (hasPaymentEvents) eventClasses += ' has-payment-events';
                
                calendarDays.innerHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}${eventClasses}" 
                         onclick="showDayEvents(${day})">
                        ${day}
                    </div>
                `;
            }
            
            // Update events display
            updateCalendarEvents();
        }

        // Show day events
        function showDayEvents(day) {
            const date = new Date(currentYear, currentMonth, day);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let eventsHtml = `<h4>${formattedDate}</h4>`;
            
            // Debt due dates
            const debtEvents = dataState.debts.filter(debt => 
                debt.status === 'active' && debt.paymentDueDay === day
            );
            
            if (debtEvents.length > 0) {
                eventsHtml += `<h5 style="color: var(--danger); margin-top: 15px;">Debts Due:</h5>`;
                debtEvents.forEach(debt => {
                    eventsHtml += `
                        <div class="calendar-event debt">
                            <div>
                                <strong>${debt.name}</strong><br>
                                <small>$${formatCurrency(debt.minimumPayment)} minimum payment</small>
                            </div>
                            <button class="btn btn-sm" onclick="recordPaymentFor('debt', '${debt.id}')">
                                Pay
                            </button>
                        </div>
                    `;
                });
            }
            
            // Credit card due dates
            const cardEvents = dataState.creditCards.filter(card => 
                card.status === 'active' && card.paymentDueDay === day
            );
            
            if (cardEvents.length > 0) {
                eventsHtml += `<h5 style="color: var(--primary); margin-top: 15px;">Credit Cards Due:</h5>`;
                cardEvents.forEach(card => {
                    const minPayment = Math.max(card.currentBalance * 0.02, 25);
                    eventsHtml += `
                        <div class="calendar-event card">
                            <div>
                                <strong>${card.cardName}</strong><br>
                                <small>$${formatCurrency(minPayment)} minimum payment</small>
                            </div>
                            <button class="btn btn-sm" onclick="recordPaymentFor('card', '${card.id}')">
                                Pay
                            </button>
                        </div>
                    `;
                });
            }
            
            // Payments made on this day
            const paymentEvents = dataState.payments.filter(payment => {
                const paymentDate = new Date(payment.paymentDate);
                return paymentDate.getDate() === day && 
                       paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear;
            });
            
            if (paymentEvents.length > 0) {
                eventsHtml += `<h5 style="color: var(--success); margin-top: 15px;">Payments Made:</h5>`;
                paymentEvents.forEach(payment => {
                    eventsHtml += `
                        <div class="calendar-event payment">
                            <div>
                                <strong>${payment.type === 'debt' ? payment.debtName : payment.cardName}</strong><br>
                                <small>$${formatCurrency(payment.amount)} - ${payment.paymentType}</small>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (debtEvents.length === 0 && cardEvents.length === 0 && paymentEvents.length === 0) {
                eventsHtml += `<p style="text-align: center; color: #6b7280; padding: 20px;">No events scheduled for this day.</p>`;
            }
            
            document.getElementById('calendarEvents').innerHTML = eventsHtml;
        }

        // Update calendar events
        function updateCalendarEvents() {
            const today = new Date();
            if (today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                showDayEvents(today.getDate());
            } else {
                showDayEvents(1);
            }
        }

        // Calendar navigation
        function prevMonth() {
            if (currentMonth === 0) {
                currentMonth = 11;
                currentYear--;
            } else {
                currentMonth--;
            }
            renderCalendar();
        }

        function nextMonth() {
            if (currentMonth === 11) {
                currentMonth = 0;
                currentYear++;
            } else {
                currentMonth++;
            }
            renderCalendar();
        }

        // Print calendar
        function printCalendar() {
            window.print();
        }

        // Export calendar data
        function exportCalendarData() {
            const calendarData = {
                month: currentMonth + 1,
                year: currentYear,
                debts: dataState.debts,
                creditCards: dataState.creditCards,
                payments: dataState.payments.filter(p => {
                    const paymentDate = new Date(p.paymentDate);
                    return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                })
            };
            
            const dataStr = JSON.stringify(calendarData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `calendar-${currentYear}-${currentMonth + 1}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showDataStatus('Calendar data exported!', 'success');
        }

        // Update Financial Overview
        function updateFinancialOverview() {
            try {
                const totalDebt = dataState.debts.reduce((sum, debt) => sum + (debt.currentBalance || 0), 0);
                const totalCreditLimit = dataState.creditCards.reduce((sum, card) => sum + (card.creditLimit || 0), 0);
                const totalCreditBalance = dataState.creditCards.reduce((sum, card) => sum + (card.currentBalance || 0), 0);
                const availableCredit = totalCreditLimit - totalCreditBalance;
                const netDebt = totalDebt + totalCreditBalance;
                
                document.getElementById('totalDebt').textContent = '$' + formatCurrency(totalDebt);
                document.getElementById('totalCredit').textContent = '$' + formatCurrency(totalCreditLimit);
                document.getElementById('availableCredit').textContent = '$' + formatCurrency(availableCredit);
                document.getElementById('netDebt').textContent = '$' + formatCurrency(netDebt);
            } catch (error) {
                console.error('Error updating financial overview:', error);
            }
        }

        // Update Upcoming Payments
        function updateUpcomingPayments() {
            const upcomingDiv = document.getElementById('upcomingPayments');
            if (!upcomingDiv) return;
            
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let upcoming = [];
            
            // Check debt due dates for next 30 days
            dataState.debts.forEach(debt => {
                if (debt.status === 'active' && debt.paymentDueDay) {
                    const dueDay = parseInt(debt.paymentDueDay);
                    const dueDate = new Date(currentYear, currentMonth, dueDay);
                    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                        upcoming.push({
                            type: 'debt',
                            name: debt.name,
                            amount: debt.minimumPayment || 0,
                            dueDay: dueDay,
                            daysUntilDue: daysUntilDue,
                            isOverdue: daysUntilDue < 0
                        });
                    }
                }
            });
            
            // Check credit card due dates for next 30 days
            dataState.creditCards.forEach(card => {
                if (card.status === 'active' && card.paymentDueDay) {
                    const dueDay = parseInt(card.paymentDueDay);
                    const dueDate = new Date(currentYear, currentMonth, dueDay);
                    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                        const minPayment = Math.max(card.currentBalance * 0.02, 25);
                        upcoming.push({
                            type: 'card',
                            name: card.cardName,
                            amount: minPayment,
                            dueDay: dueDay,
                            daysUntilDue: daysUntilDue,
                            isOverdue: daysUntilDue < 0
                        });
                    }
                }
            });
            
            if (upcoming.length === 0) {
                upcomingDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: var(--gray); border-radius: 10px;">
                        <i class="bi bi-check-circle" style="font-size: 24px; color: var(--success); margin-bottom: 10px;"></i>
                        <p style="color: #6b7280;">No upcoming payments in the next 30 days</p>
                    </div>
                `;
                return;
            }
            
            // Sort by days until due
            upcoming.sort((a, b) => a.daysUntilDue - b.daysUntilDue);
            
            let html = '';
            upcoming.forEach(item => {
                html += `
                    <div style="background: ${item.isOverdue ? '#fff5f5' : '#f8f9fa'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${item.isOverdue ? 'var(--danger)' : 'var(--primary)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <strong style="font-size: 14px;">${item.name}</strong>
                            <span style="font-weight: bold; color: var(--primary);">$${formatCurrency(item.amount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: ${item.isOverdue ? 'var(--danger)' : '#6b7280'};">
                            <span>Due in ${item.daysUntilDue} days</span>
                            <span>${item.type === 'debt' ? 'Debt' : 'Card'}</span>
                        </div>
                        ${item.isOverdue ? '<div style="font-size: 11px; color: var(--danger); margin-top: 5px;"> Overdue</div>' : ''}
                    </div>
                `;
            });
            
            upcomingDiv.innerHTML = html;
        }

        // Load Quick Insights
        function loadQuickInsights() {
            const insightsDiv = document.getElementById('quickInsights');
            if (!insightsDiv) return;
            
            const totalUtilization = dataState.creditCards.length > 0 
                ? dataState.creditCards.reduce((sum, card) => {
                    return sum + (card.creditLimit > 0 ? (card.currentBalance / card.creditLimit) : 0);
                }, 0) / dataState.creditCards.length * 100
                : 0;
            
            const overdueItems = dataState.debts.filter(debt => {
                const today = new Date();
                const dueDate = new Date(today.getFullYear(), today.getMonth(), debt.paymentDueDay);
                return debt.status === 'active' && today > dueDate;
            }).length + dataState.creditCards.filter(card => {
                const today = new Date();
                const dueDate = new Date(today.getFullYear(), today.getMonth(), card.paymentDueDay);
                return card.status === 'active' && today > dueDate;
            }).length;
            
            const highInterestDebts = dataState.debts.filter(debt => debt.interestRate > 15).length;
            const totalDebt = dataState.debts.reduce((sum, debt) => sum + debt.currentBalance, 0);
            
            let html = '';
            
            if (totalUtilization > 50) {
                html += `
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #ef4444;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <i class="bi bi-exclamation-triangle" style="color: #991b1b;"></i>
                            <strong style="color: #991b1b;">High Credit Utilization</strong>
                        </div>
                        <p style="font-size: 12px; color: #991b1b;">Your credit utilization is ${totalUtilization.toFixed(1)}%. Try to keep it below 30%.</p>
                    </div>
                `;
            }
            
            if (overdueItems > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <i class="bi bi-clock-history" style="color: #92400e;"></i>
                            <strong style="color: #92400e;">${overdueItems} Overdue Items</strong>
                        </div>
                        <p style="font-size: 12px; color: #92400e;">You have ${overdueItems} overdue payments. Consider making payments soon.</p>
                    </div>
                `;
            }
            
            if (highInterestDebts > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <i class="bi bi-lightning-charge" style="color: #1e40af;"></i>
                            <strong style="color: #1e40af;">${highInterestDebts} High-Interest Debts</strong>
                        </div>
                        <p style="font-size: 12px; color: #1e40af;">Consider focusing on paying off high-interest debts first.</p>
                    </div>
                `;
            }
            
            if (totalDebt > 10000) {
                html += `
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #8b5cf6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <i class="bi bi-cash-stack" style="color: #6d28d9;"></i>
                            <strong style="color: #6d28d9;">Significant Debt Load</strong>
                        </div>
                        <p style="font-size: 12px; color: #6d28d9;">Consider debt consolidation or speaking with a financial advisor.</p>
                    </div>
                `;
            }
            
            if (html === '') {
                html = `
                    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px; text-align: center;">
                        <i class="bi bi-emoji-smile" style="color: #065f46; font-size: 24px; margin-bottom: 10px;"></i>
                        <p style="color: #065f46; font-size: 14px; font-weight: 600;">Great job! Your finances look healthy.</p>
                    </div>
                `;
            }
            
            insightsDiv.innerHTML = html;
        }

        // Update Notifications
        function updateNotifications() {
            const today = new Date();
            const overdueCount = dataState.debts.filter(debt => {
                const dueDate = new Date(today.getFullYear(), today.getMonth(), debt.paymentDueDay);
                return debt.status === 'active' && today > dueDate;
            }).length + dataState.creditCards.filter(card => {
                const dueDate = new Date(today.getFullYear(), today.getMonth(), card.paymentDueDay);
                return card.status === 'active' && today > dueDate;
            }).length;
            
            const notificationCount = document.getElementById('notificationCount');
            if (overdueCount > 0) {
                notificationCount.style.display = 'flex';
                notificationCount.textContent = overdueCount > 9 ? '9+' : overdueCount.toString();
            } else {
                notificationCount.style.display = 'none';
            }
        }

        // Show Notifications
        function showNotifications() {
            const today = new Date();
            const overdueItems = [];
            
            // Check overdue debts
            dataState.debts.forEach(debt => {
                const dueDate = new Date(today.getFullYear(), today.getMonth(), debt.paymentDueDay);
                if (debt.status === 'active' && today > dueDate) {
                    overdueItems.push({
                        type: 'debt',
                        id: debt.id,
                        name: debt.name,
                        daysOverdue: Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24))
                    });
                }
            });
            
            // Check overdue credit cards
            dataState.creditCards.forEach(card => {
                const dueDate = new Date(today.getFullYear(), today.getMonth(), card.paymentDueDay);
                if (card.status === 'active' && today > dueDate) {
                    overdueItems.push({
                        type: 'card',
                        id: card.id,
                        name: card.cardName,
                        daysOverdue: Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24))
                    });
                }
            });
            
            let html = '<h3 style="color: var(--danger); margin-bottom: 15px;">Overdue Items</h3>';
            
            if (overdueItems.length === 0) {
                html = '<p style="text-align: center; padding: 20px; color: #6b7280;">No overdue items! Great job!</p>';
            } else {
                overdueItems.forEach(item => {
                    html += `
                        <div style="padding: 12px; margin-bottom: 10px; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>${item.name}</strong><br>
                            <small style="color: #991b1b;">${item.daysOverdue} days overdue</small><br>
                            <button class="btn btn-sm" onclick="recordPaymentFor('${item.type}', '${item.id}')" style="margin-top: 8px; background: #ef4444; color: white; border: none;">
                                <i class="bi bi-cash"></i> Record Payment
                            </button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            document.getElementById('detailsModal').classList.add('active');
        }

        // Load Analytics
        function loadAnalytics() {
            updateInsights();
            renderCharts();
        }

        // Update Insights
        function updateInsights() {
            const totalDebtReduction = dataState.debts.reduce((sum, debt) => 
                sum + (debt.principalAmount - debt.currentBalance), 0);
            
            const avgInterestRate = dataState.debts.length > 0 
                ? (dataState.debts.reduce((sum, debt) => sum + debt.interestRate, 0) / dataState.debts.length).toFixed(1)
                : 0;
            
            const onTimePayments = dataState.payments.filter(p => {
                const paymentDate = new Date(p.paymentDate);
                const dueDate = new Date(paymentDate);
                dueDate.setDate(paymentDate.getDate() + 30);
                return paymentDate <= dueDate;
            }).length;
            
            const daysToPayoff = calculateAverageDaysToPayoff();
            
            document.getElementById('debtReduction').textContent = '$' + formatCurrency(totalDebtReduction);
            document.getElementById('avgInterest').textContent = avgInterestRate + '%';
            document.getElementById('onTimePayments').textContent = onTimePayments;
            document.getElementById('daysToPayoff').textContent = daysToPayoff;
        }

        // Calculate average days to payoff
        function calculateAverageDaysToPayoff() {
            let totalDays = 0;
            let count = 0;
            
            dataState.debts.forEach(debt => {
                if (debt.currentBalance > 0 && debt.minimumPayment > 0) {
                    const months = debt.currentBalance / debt.minimumPayment;
                    totalDays += months * 30;
                    count++;
                }
            });
            
            return count > 0 ? Math.round(totalDays / count) : 0;
        }

        // Render Charts
        function renderCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            // Debt Distribution Chart
            const debtCtx = document.getElementById('debtDistributionChart');
            if (debtCtx) {
                const debtTypes = {};
                dataState.debts.forEach(debt => {
                    const type = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    debtTypes[type] = (debtTypes[type] || 0) + debt.currentBalance;
                });
                
                charts.debtDistribution = new Chart(debtCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(debtTypes),
                        datasets: [{
                            data: Object.values(debtTypes),
                            backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#ef4444', '#f59e0b', '#10b981', '#3b82f6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
            
            // Credit Utilization Chart
            const creditCtx = document.getElementById('creditUtilizationChart');
            if (creditCtx) {
                const cardNames = dataState.creditCards.map(card => card.cardName);
                const utilizations = dataState.creditCards.map(card => 
                    card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100).toFixed(1) : 0
                );
                
                charts.creditUtilization = new Chart(creditCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cardNames,
                        datasets: [{
                            label: 'Utilization %',
                            data: utilizations,
                            backgroundColor: utilizations.map(u => 
                                u > 80 ? '#ef4444' : u > 50 ? '#f59e0b' : '#10b981'
                            ),
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Utilization %'
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Interest Analysis Chart
            const interestCtx = document.getElementById('interestChart');
            if (interestCtx) {
                const highInterestDebts = dataState.debts.filter(d => d.interestRate > 10);
                const mediumInterestDebts = dataState.debts.filter(d => d.interestRate >= 5 && d.interestRate <= 10);
                const lowInterestDebts = dataState.debts.filter(d => d.interestRate < 5);
                
                charts.interest = new Chart(interestCtx.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['High Interest (>10%)', 'Medium Interest (5-10%)', 'Low Interest (<5%)'],
                        datasets: [{
                            label: 'Debt Count',
                            data: [highInterestDebts.length, mediumInterestDebts.length, lowInterestDebts.length],
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: '#6366f1',
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#6366f1'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
            
            // Payment Trend Chart
            const paymentCtx = document.getElementById('paymentTrendChart');
            if (paymentCtx) {
                // Group payments by month for last 6 months
                const monthlyPayments = {};
                const today = new Date();
                
                // Initialize last 6 months
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyPayments[monthYear] = 0;
                }
                
                // Add payments
                dataState.payments.forEach(payment => {
                    const paymentDate = new Date(payment.paymentDate);
                    const monthYear = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyPayments[monthYear] !== undefined) {
                        monthlyPayments[monthYear] += payment.amount;
                    }
                });
                
                // Prepare data
                const months = [];
                const paymentData = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    months.push(monthName);
                    paymentData.push(monthlyPayments[monthYear] || 0);
                }
                
                charts.paymentTrend = new Chart(paymentCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Payments',
                            data: paymentData,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Amount ($)'
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `$${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Forecast Chart
            const forecastCtx = document.getElementById('forecastChart');
            if (forecastCtx) {
                // Calculate 12-month forecast
                const forecastMonths = [];
                const forecastDebt = [];
                let currentDebt = dataState.debts.reduce((sum, debt) => sum + debt.currentBalance, 0);
                const avgMonthlyPayment = dataState.payments.length > 0 
                    ? dataState.payments.reduce((sum, p) => sum + p.amount, 0) / Math.max(1, dataState.payments.length / 30)
                    : 100; // Default $100 if no payments
                
                for (let i = 0; i <= 12; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() + i);
                    forecastMonths.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                    forecastDebt.push(Math.max(0, currentDebt - (avgMonthlyPayment * i)));
                }
                
                charts.forecast = new Chart(forecastCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: forecastMonths,
                        datasets: [{
                            label: 'Projected Debt',
                            data: forecastDebt,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Debt Amount ($)'
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `$${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Filter Functions
        function filterDebts(filter) {
            document.querySelectorAll('#debtsTab .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderDebts(filter);
        }

        function filterCards(filter) {
            document.querySelectorAll('#creditCardsTab .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCreditCards(filter);
        }

        function filterPayments(filter) {
            document.querySelectorAll('#paymentsTab .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPayments(filter);
        }

        function filterAnalytics(period) {
            document.querySelectorAll('#analyticsTab .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Re-render analytics with filtered period
            renderCharts();
        }

        // Tab Navigation
        function switchTab(tabName) {
            try {
                currentTab = tabName;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Show active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const tabElement = document.getElementById(tabName + 'Tab');
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                
                // Load tab-specific data
                if (tabName === 'debts') {
                    renderDebts();
                } else if (tabName === 'creditCards') {
                    renderCreditCards();
                } else if (tabName === 'calendar') {
                    renderCalendar();
                } else if (tabName === 'payments') {
                    renderPayments();
                } else if (tabName === 'analytics') {
                    loadAnalytics();
                }
                
            } catch (error) {
                console.error('Error switching tab:', error);
                showError('Failed to switch tab: ' + error.message);
            }
        }

        // Debt Modal Functions
        function openDebtModal(debtId = null) {
            currentItemId = debtId;
            const modal = document.getElementById('debtModal');
            
            if (debtId) {
                document.getElementById('debtModalTitle').textContent = 'Edit Debt';
                const debt = dataState.debts.find(d => d.id === debtId);
                if (debt) {
                    document.getElementById('debtName').value = debt.name;
                    document.getElementById('creditor').value = debt.creditor;
                    document.getElementById('debtType').value = debt.type;
                    document.getElementById('debtStatus').value = debt.status;
                    document.getElementById('principalAmount').value = debt.principalAmount;
                    document.getElementById('currentBalance').value = debt.currentBalance;
                    document.getElementById('interestRate').value = debt.interestRate;
                    document.getElementById('minimumPayment').value = debt.minimumPayment;
                    document.getElementById('paymentFrequency').value = debt.paymentFrequency || 'monthly';
                    document.getElementById('paymentDueDay').value = debt.paymentDueDay || 1;
                    document.getElementById('debtNotes').value = debt.notes || '';
                }
            } else {
                document.getElementById('debtModalTitle').textContent = 'Add New Debt';
                document.getElementById('debtForm').reset();
                document.getElementById('paymentDueDay').value = 1;
                document.getElementById('paymentFrequency').value = 'monthly';
            }
            
            modal.classList.add('active');
        }

        function closeDebtModal() {
            document.getElementById('debtModal').classList.remove('active');
            currentItemId = null;
        }

        // Save Debt
        document.getElementById('debtForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const debtData = {
                name: document.getElementById('debtName').value.trim(),
                creditor: document.getElementById('creditor').value.trim(),
                type: document.getElementById('debtType').value,
                status: document.getElementById('debtStatus').value,
                principalAmount: parseFloat(document.getElementById('principalAmount').value) || 0,
                currentBalance: parseFloat(document.getElementById('currentBalance').value) || 0,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                minimumPayment: parseFloat(document.getElementById('minimumPayment').value) || 0,
                paymentFrequency: document.getElementById('paymentFrequency').value,
                paymentDueDay: parseInt(document.getElementById('paymentDueDay').value) || 1,
                notes: document.getElementById('debtNotes').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const debtsRef = db.collection('users').doc(currentUser.uid).collection('debts');
                
                if (currentItemId) {
                    await debtsRef.doc(currentItemId).update(debtData);
                    showDataStatus('Debt updated successfully!', 'success');
                } else {
                    debtData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    debtData.userId = currentUser.uid;
                    await debtsRef.add(debtData);
                    showDataStatus('Debt added successfully!', 'success');
                }
                
                closeDebtModal();
            } catch (error) {
                console.error('Error saving debt:', error);
                showError('Failed to save debt: ' + error.message);
            }
        });

        // Credit Card Modal Functions
        function openCreditCardModal(cardId = null) {
            currentItemId = cardId;
            const modal = document.getElementById('creditCardModal');
            
            if (cardId) {
                document.getElementById('creditCardModalTitle').textContent = 'Edit Credit Card';
                const card = dataState.creditCards.find(c => c.id === cardId);
                if (card) {
                    document.getElementById('cardName').value = card.cardName;
                    document.getElementById('issuer').value = card.issuer;
                    document.getElementById('cardType').value = card.cardType;
                    document.getElementById('lastFourDigits').value = card.lastFourDigits;
                    document.getElementById('creditLimit').value = card.creditLimit;
                    document.getElementById('cardBalance').value = card.currentBalance;
                    document.getElementById('cardInterestRate').value = card.interestRate || '';
                    document.getElementById('annualFee').value = card.annualFee || '';
                    document.getElementById('cardDueDay').value = card.paymentDueDay || 1;
                    document.getElementById('statementDueDay').value = card.statementDueDay || 1;
                    document.getElementById('cardNotes').value = card.notes || '';
                }
            } else {
                document.getElementById('creditCardModalTitle').textContent = 'Add Credit Card';
                document.getElementById('creditCardForm').reset();
                document.getElementById('cardDueDay').value = 1;
                document.getElementById('statementDueDay').value = 1;
            }
            
            modal.classList.add('active');
        }

        function closeCreditCardModal() {
            document.getElementById('creditCardModal').classList.remove('active');
            currentItemId = null;
        }

        // Save Credit Card
        document.getElementById('creditCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const cardData = {
                cardName: document.getElementById('cardName').value.trim(),
                issuer: document.getElementById('issuer').value.trim(),
                cardType: document.getElementById('cardType').value,
                lastFourDigits: document.getElementById('lastFourDigits').value.trim(),
                creditLimit: parseFloat(document.getElementById('creditLimit').value) || 0,
                currentBalance: parseFloat(document.getElementById('cardBalance').value) || 0,
                interestRate: parseFloat(document.getElementById('cardInterestRate').value) || 0,
                annualFee: parseFloat(document.getElementById('annualFee').value) || 0,
                paymentDueDay: parseInt(document.getElementById('cardDueDay').value) || 1,
                statementDueDay: parseInt(document.getElementById('statementDueDay').value) || 1,
                status: 'active',
                notes: document.getElementById('cardNotes').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                const cardsRef = db.collection('users').doc(currentUser.uid).collection('creditCards');
                
                if (currentItemId) {
                    await cardsRef.doc(currentItemId).update(cardData);
                    showDataStatus('Credit card updated successfully!', 'success');
                } else {
                    cardData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    cardData.userId = currentUser.uid;
                    await cardsRef.add(cardData);
                    showDataStatus('Credit card added successfully!', 'success');
                }
                
                closeCreditCardModal();
            } catch (error) {
                console.error('Error saving credit card:', error);
                showError('Failed to save credit card: ' + error.message);
            }
        });

        // Payment Modal Functions
        function openPaymentModal() {
            const modal = document.getElementById('paymentModal');
            const select = document.getElementById('paymentFor');
            
            // Clear previous options
            select.innerHTML = '<option value="">Select Debt/Card</option>';
            
            // Add debt options
            dataState.debts.forEach(debt => {
                if (debt.status === 'active') {
                    select.innerHTML += `<option value="debt_${debt.id}">Debt: ${debt.name} ($${formatCurrency(debt.currentBalance)})</option>`;
                }
            });
            
            // Add credit card options
            dataState.creditCards.forEach(card => {
                if (card.status === 'active') {
                    select.innerHTML += `<option value="card_${card.id}">Card: ${card.cardName} ($${formatCurrency(card.currentBalance)})</option>`;
                }
            });
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
            
            modal.classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function updatePaymentType() {
            const selected = document.getElementById('paymentFor').value;
            const amountInput = document.getElementById('paymentAmount');
            
            if (selected.startsWith('debt_')) {
                const debtId = selected.split('_')[1];
                const debt = dataState.debts.find(d => d.id === debtId);
                if (debt) {
                    amountInput.placeholder = `Minimum: $${debt.minimumPayment}`;
                }
            } else if (selected.startsWith('card_')) {
                const cardId = selected.split('_')[1];
                const card = dataState.creditCards.find(c => c.id === cardId);
                if (card) {
                    const minPayment = Math.max(card.currentBalance * 0.02, 25);
                    amountInput.placeholder = `Minimum: $${formatCurrency(minPayment)}`;
                }
            }
        }

        // Save Payment
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const selected = document.getElementById('paymentFor').value;
            if (!selected) {
                alert('Please select a debt or credit card');
                return;
            }
            
            const [type, itemId] = selected.split('_');
            const paymentData = {
                amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
                paymentDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('paymentDate').value)),
                paymentType: document.getElementById('paymentType').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                referenceNumber: document.getElementById('referenceNumber').value.trim(),
                notes: document.getElementById('paymentNotes').value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (type === 'debt') {
                    // Save to debt payments
                    const paymentRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId).collection('payments');
                    await paymentRef.add(paymentData);
                    
                    // Update debt balance
                    const debtRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId);
                    const debtDoc = await debtRef.get();
                    const currentBalance = debtDoc.data().currentBalance || 0;
                    const newBalance = Math.max(0, currentBalance - paymentData.amount);
                    
                    await debtRef.update({
                        currentBalance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                } else if (type === 'card') {
                    // Save to credit card payments
                    const paymentRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId).collection('payments');
                    await paymentRef.add(paymentData);
                    
                    // Update card balance
                    const cardRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId);
                    const cardDoc = await cardRef.get();
                    const currentBalance = cardDoc.data().currentBalance || 0;
                    const newBalance = Math.max(0, currentBalance - paymentData.amount);
                    
                    await cardRef.update({
                        currentBalance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                closePaymentModal();
                showDataStatus('Payment recorded successfully!', 'success');
                
                // Reload payments
                dataState.payments = await getAllPayments();
                renderPayments();
                
            } catch (error) {
                console.error('Error saving payment:', error);
                showError('Failed to record payment: ' + error.message);
            }
        });

        // Note Modal Functions
        function openNoteModal() {
            const modal = document.getElementById('noteModal');
            const select = document.getElementById('noteFor');
            
            // Clear previous options
            select.innerHTML = '<option value="">Select Debt/Card</option>';
            
            // Add debt options
            dataState.debts.forEach(debt => {
                select.innerHTML += `<option value="debt_${debt.id}">Debt: ${debt.name}</option>`;
            });
            
            // Add credit card options
            dataState.creditCards.forEach(card => {
                select.innerHTML += `<option value="card_${card.id}">Credit Card: ${card.cardName}</option>`;
            });
            
            modal.classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
        }

        // Save Note
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please login to save data');
                return;
            }
            
            const selected = document.getElementById('noteFor').value;
            if (!selected) {
                alert('Please select a debt or credit card');
                return;
            }
            
            const [type, itemId] = selected.split('_');
            const noteData = {
                content: document.getElementById('noteContent').value.trim(),
                type: document.getElementById('noteType').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };
            
            try {
                if (type === 'debt') {
                    const notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(itemId).collection('notes');
                    await notesRef.add(noteData);
                    
                } else if (type === 'card') {
                    const notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(itemId).collection('notes');
                    await notesRef.add(noteData);
                }
                
                closeNoteModal();
                showDataStatus('Note saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving note:', error);
                showError('Failed to save note: ' + error.message);
            }
        });

        // View Details Functions
        async function viewDebtDetails(debtId) {
            currentItemId = debtId;
            currentItemType = 'debt';
            
            const debt = dataState.debts.find(d => d.id === debtId);
            if (!debt) return;
            
            document.getElementById('detailsTitle').textContent = debt.name;
            
            const typeText = debt.type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            const statusText = debt.status.charAt(0).toUpperCase() + debt.status.slice(1).replace('_', ' ');
            const progress = debt.principalAmount > 0 ? ((debt.principalAmount - debt.currentBalance) / debt.principalAmount * 100) : 0;
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${debt.name}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #6b7280; margin-bottom: 5px;">Creditor</small>
                            <strong>${debt.creditor}</strong>
                        </div>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #6b7280; margin-bottom: 5px;">Status</small>
                            <strong>${statusText}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Original Amount</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(debt.principalAmount)}</div>
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(debt.currentBalance)}</div>
                    </div>
                </div>
                
                ${debt.principalAmount > 0 ? `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <div style="font-size: 18px; color: var(--success);">$${formatCurrency(debt.principalAmount - debt.currentBalance)}</div>
                        </div>
                        <div class="form-group">
                            <label>Progress</label>
                            <div style="font-size: 18px; color: var(--primary);">${progress.toFixed(1)}%</div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Interest Rate</label>
                        <div>${debt.interestRate}%</div>
                    </div>
                    <div class="form-group">
                        <label>Minimum Payment</label>
                        <div>$${formatCurrency(debt.minimumPayment)}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Frequency</label>
                        <div>${debt.paymentFrequency.charAt(0).toUpperCase() + debt.paymentFrequency.slice(1)}</div>
                    </div>
                    <div class="form-group">
                        <label>Due Day</label>
                        <div>${debt.paymentDueDay}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Debt Type</label>
                        <div>${typeText}</div>
                    </div>
                </div>
            `;
            
            if (debt.notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Additional Notes</h4>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px; white-space: pre-wrap;">${debt.notes}</div>
                    </div>
                `;
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            
            // Load notes for this debt
            await loadItemNotes();
            
            document.getElementById('detailsModal').classList.add('active');
        }

        async function viewCreditCardDetails(cardId) {
            currentItemId = cardId;
            currentItemType = 'card';
            
            const card = dataState.creditCards.find(c => c.id === cardId);
            if (!card) return;
            
            document.getElementById('detailsTitle').textContent = card.cardName;
            
            const availableCredit = card.creditLimit - card.currentBalance;
            const utilization = card.creditLimit > 0 ? (card.currentBalance / card.creditLimit * 100).toFixed(1) : 0;
            const typeText = card.cardType.charAt(0).toUpperCase() + card.cardType.slice(1);
            
            let html = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${card.cardName}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #6b7280; margin-bottom: 5px;">Issuer</small>
                            <strong>${card.issuer}</strong>
                        </div>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px;">
                            <small style="display: block; color: #6b7280; margin-bottom: 5px;">Card Type</small>
                            <strong>${typeText}  ${card.lastFourDigits}</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Credit Limit</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(card.creditLimit)}</div>
                    </div>
                    <div class="form-group">
                        <label>Current Balance</label>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);">$${formatCurrency(card.currentBalance)}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Available Credit</label>
                        <div style="font-size: 18px; color: ${availableCredit > 0 ? 'var(--success)' : 'var(--danger)'};">$${formatCurrency(availableCredit)}</div>
                    </div>
                    <div class="form-group">
                        <label>Credit Utilization</label>
                        <div style="font-size: 18px; color: ${utilization > 80 ? 'var(--danger)' : utilization > 50 ? 'var(--warning)' : 'var(--success)'};">${utilization}%</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Due Day</label>
                        <div>${card.paymentDueDay}</div>
                    </div>
                    <div class="form-group">
                        <label>Statement Due Day</label>
                        <div>${card.statementDueDay}</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Interest Rate</label>
                        <div>${card.interestRate || 0}%</div>
                    </div>
                    <div class="form-group">
                        <label>Annual Fee</label>
                        <div>$${formatCurrency(card.annualFee || 0)}</div>
                    </div>
                </div>
            `;
            
            if (card.notes) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Additional Notes</h4>
                        <div style="background: var(--gray); padding: 15px; border-radius: 10px; white-space: pre-wrap;">${card.notes}</div>
                    </div>
                `;
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            
            // Load notes for this card
            await loadItemNotes();
            
            document.getElementById('detailsModal').classList.add('active');
        }

        async function loadItemNotes() {
            if (!currentItemId || !currentItemType || !currentUser) return;
            
            try {
                let notesRef;
                if (currentItemType === 'debt') {
                    notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(currentItemId).collection('notes');
                } else {
                    notesRef = db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(currentItemId).collection('notes');
                }
                
                const snapshot = await notesRef.orderBy('createdAt', 'desc').get();
                const notes = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    notes.push({
                        id: doc.id,
                        content: data.content || '',
                        type: data.type || 'general',
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                let html = '';
                if (notes.length === 0) {
                    html = '<p style="text-align: center; color: #6b7280; padding: 20px;">No notes yet</p>';
                } else {
                    notes.forEach(note => {
                        const date = new Date(note.createdAt).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const typeText = note.type.charAt(0).toUpperCase() + note.type.slice(1).replace('_', ' ');
                        
                        html += `
                            <div style="background: var(--gray); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #6b7280;">
                                    <span style="background: white; padding: 3px 8px; border-radius: 4px; font-weight: 500;">${typeText}</span>
                                    <span>${date}</span>
                                </div>
                                <div style="white-space: pre-wrap;">${note.content}</div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('itemNotes').innerHTML = html;
            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('itemNotes').innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading notes</p>';
            }
        }

        function addNoteToCurrentItem() {
            if (!currentItemId || !currentItemType) return;
            
            closeDetailsModal();
            
            // Set the note modal to current item
            const select = document.getElementById('noteFor');
            const optionValue = `${currentItemType === 'debt' ? 'debt' : 'card'}_${currentItemId}`;
            
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === optionValue) {
                    select.selectedIndex = i;
                    break;
                }
            }
            
            openNoteModal();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
            currentItemId = null;
            currentItemType = null;
        }

        // Edit Functions
        function editDebt(debtId) {
            openDebtModal(debtId);
        }

        function editCreditCard(cardId) {
            openCreditCardModal(cardId);
        }

        // Delete Function
        async function deleteItem(type, id) {
            if (!confirm(`Are you sure you want to delete this ${type === 'debt' ? 'debt' : 'credit card'}?`)) return;
            
            try {
                if (type === 'debt') {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('debts').doc(id).delete();
                    showDataStatus('Debt deleted successfully!', 'success');
                } else {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('creditCards').doc(id).delete();
                    showDataStatus('Credit card deleted successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showError('Failed to delete item: ' + error.message);
            }
        }

        // Record Payment For Specific Item
        function recordPaymentFor(type, id) {
            currentItemId = id;
            currentItemType = type;
            
            openPaymentModal();
            
            // Set the dropdown to the selected item
            const select = document.getElementById('paymentFor');
            const optionValue = `${type === 'debt' ? 'debt' : 'card'}_${id}`;
            
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === optionValue) {
                    select.selectedIndex = i;
                    updatePaymentType();
                    break;
                }
            }
        }

        // UI Helper Functions
        function showLoading(text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        function showDataStatus(message, type = 'success') {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.className = `data-status ${type}`;
            
            const icon = statusDiv.querySelector('i');
            const text = statusDiv.querySelector('span');
            
            if (type === 'success') {
                icon.className = 'bi bi-check-circle';
            } else if (type === 'error') {
                icon.className = 'bi bi-exclamation-triangle';
            } else if (type === 'warning') {
                icon.className = 'bi bi-exclamation-circle';
            }
            
            text.textContent = message;
            
            statusDiv.style.display = 'flex';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                    <div style="margin-top: 10px;">
                        <button onclick="refreshAllData()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Retry</button>
                        <button onclick="location.reload()" style="margin-left: 10px; background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Reload Page</button>
                    </div>
                </div>
            `;
            errorContainer.style.display = 'block';
            
            // Auto hide after 10 seconds
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 10000);
        }

        function updateLastUpdated() {
            const lastUpdatedDiv = document.getElementById('lastUpdated');
            if (lastUpdatedDiv && dataState.lastUpdated) {
                const timeAgo = getTimeAgo(dataState.lastUpdated);
                lastUpdatedDiv.innerHTML = `
                    <span style="font-size: 12px; color: var(--dark-gray);">${timeAgo}</span>
                `;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Helper Functions
        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Redirect to Login
        function redirectToLogin() {
            window.location.href = 'index.html';
        }

        // Logout Function
        function logout() {
            showLoading('Logging out...');
            
            auth.signOut()
                .then(() => {
                    cleanupListeners();
                    dataState = {
                        debts: [],
                        creditCards: [],
                        payments: [],
                        notes: [],
                        lastUpdated: null,
                        isLoading: false,
                        error: null
                    };
                    hideLoading();
                    window.location.reload();
                })
                .catch((error) => {
                    hideLoading();
                    showError('Error logging out: ' + error.message);
                });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check initial network status
            if (!isOnline) {
                document.getElementById('offlineIndicator').style.display = 'flex';
            }
            
            // Set up auto-refresh every 5 minutes if online
            if (isOnline) {
                setInterval(() => {
                    if (currentUser && !dataState.isLoading) {
                        refreshAllData();
                    }
                }, 5 * 60 * 1000); // 5 minutes
            }
            
            // Set today's date for payment modal
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('paymentDate')) {
                document.getElementById('paymentDate').value = today;
            }
        });
    </script>
</body>
</html>