<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart of Accounts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }

    header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      align-items: center;
    }

    header h1 {
      margin: 0;
    }

    #userSession {
      font-weight: bold;
      color: #555;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      margin-bottom: 15px;
    }

    .form-group label {
      width: 200px;
      font-weight: bold;
      margin-top: 6px;
    }

    .form-group select,
    .form-group input {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
    }

    button {
      background-color: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #218838;
    }

    button.delete-btn {
      background-color: #dc3545;
    }

    button.delete-btn:hover {
      background-color: #b02a37;
    }

    button.edit-btn {
      background-color: #ffc107;
      color: #333;
    }

    button.edit-btn:hover {
      background-color: #e0a800;
      color: #000;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f1f1f1;
    }

    .Income { color: green; }
    .Expense, .COGS, .OtherExpense { color: red; }
    .Asset, .Liability, .Equity, .OtherIncome { color: #333; }

    #loginSection {
      max-width: 400px;
      margin: 80px auto;
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login (Simulated)</h2>
  <p>Enter your User ID (from Firestore Users collection):</p>
  <input type="text" id="userIdInput" placeholder="User ID" style="width: 80%; padding: 8px; margin-bottom: 15px;" />
  <br />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color: red;"></p>
</div>

<div class="container" style="display:none;">
  <header>
    <h1>Chart of Accounts</h1>
    <div id="userSession"></div>
    <button id="logoutBtn" style="background:#007bff;">Logout</button>
  </header>

  <!-- Add/Edit Account Form -->
  <form id="accountForm">
    <h2 id="formTitle">Add Account</h2>

    <div class="form-group">
      <label for="accountType">Account Type</label>
      <select id="accountType" required>
        <option value="">Select Type</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Equity">Equity</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="COGS">Cost of Goods Sold</option>
        <option value="OtherIncome">Other Income</option>
        <option value="OtherExpense">Other Expense</option>
      </select>
    </div>

    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
      </select>
    </div>

    <div class="form-group">
      <label></label>
      <button type="button" id="addCategoryBtn">+ Add New Category</button>
    </div>

    <div class="form-group">
      <label for="accountName">Account Name</label>
      <input type="text" id="accountName" placeholder="e.g. Bank Account" required />
    </div>

    <div class="form-group">
      <label></label>
      <button type="submit" id="submitBtn">Add Account</button>
      <button type="button" id="cancelEditBtn" style="display:none; background:#6c757d;">Cancel</button>
    </div>
  </form>

  <!-- Account Table -->
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Category</th>
        <th>Account Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="accountsTable"></tbody>
  </table>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc,
    updateDoc, deleteDoc, query, where
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Categories per account type
  const categories = {
    Asset: ['Cash', 'Bank', 'Accounts Receivable', 'Inventory', 'Fixed Assets'],
    Liability: ['Accounts Payable', 'Credit Card', 'Loan Payable'],
    Equity: ['Ownerâ€™s Equity', 'Retained Earnings', 'Common Stock'],
    Income: ['Sales Revenue', 'Service Income'],
    Expense: ['Rent', 'Utilities', 'Payroll', 'Supplies', 'Insurance'],
    COGS: ['Raw Materials', 'Freight In', 'Packaging'],
    OtherIncome: ['Investment Gains', 'Interest Received'],
    OtherExpense: ['Penalties', 'Asset Disposal Loss']
  };

  // DOM
  const loginSection = document.getElementById('loginSection');
  const userIdInput = document.getElementById('userIdInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  const container = document.querySelector('.container');
  const userSessionDiv = document.getElementById('userSession');
  const logoutBtn = document.getElementById('logoutBtn');

  const accountTypeSelect = document.getElementById('accountType');
  const categorySelect = document.getElementById('category');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const accountForm = document.getElementById('accountForm');
  const accountsTable = document.getElementById('accountsTable');
  const formTitle = document.getElementById('formTitle');
  const submitBtn = document.getElementById('submitBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const accountNameInput = document.getElementById('accountName');

  let currentUser = null;
  let editDocId = null; // ID of doc being edited

  // Show categories when account type changes
  accountTypeSelect.addEventListener('change', () => {
    const type = accountTypeSelect.value;
    updateCategoryOptions(type);
  });

  function updateCategoryOptions(type) {
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    if (categories[type]) {
      categories[type].forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }
  }

  // Add new category button
  addCategoryBtn.addEventListener('click', () => {
    const type = accountTypeSelect.value;
    if (!type) {
      alert("Please select Account Type first.");
      return;
    }
    const newCat = prompt(`Enter new category for "${type}"`);
    if (newCat && !categories[type].includes(newCat)) {
      categories[type].push(newCat);
      updateCategoryOptions(type);
      categorySelect.value = newCat;
    }
  });

  // Login simulation - check user exists in Firestore Users collection
  loginBtn.addEventListener('click', async () => {
    const userId = userIdInput.value.trim();
    loginError.textContent = '';
    if (!userId) {
      loginError.textContent = "Please enter a User ID.";
      return;
    }
    try {
      const userDocRef = doc(db, "Users", userId);
      const userSnap = await getDocs(query(collection(db, "Users"), where("__name__", "==", userId)));

      if (userSnap.empty) {
        loginError.textContent = "User not found. Please enter a valid User ID.";
        return;
      }

      currentUser = userId;
      loginSection.style.display = "none";
      container.style.display = "block";
      userSessionDiv.textContent = `Logged in as: ${currentUser}`;

      await loadAccounts();

    } catch (err) {
      loginError.textContent = "Error checking user: " + err.message;
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    editDocId = null;
    accountsTable.innerHTML = '';
    accountForm.reset();
    formTitle.textContent = "Add Account";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    container.style.display = "none";
    loginSection.style.display = "block";
    userIdInput.value = "";
  });

  // Submit form for Add/Edit
  accountForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentUser) {
      alert("Please login first.");
      return;
    }
    const type = accountTypeSelect.value;
    const category = categorySelect.value;
    const name = accountNameInput.value.trim();

    if (!type || !category || !name) {
      alert("All fields are required.");
      return;
    }

    try {
      if (editDocId) {
        // Update existing
        const docRef = doc(db, "chartOfAccounts", editDocId);
        await updateDoc(docRef, {
          type,
          category,
          name,
          updatedAt: new Date().toISOString()
        });
        editDocId = null;
        formTitle.textContent = "Add Account";
        submitBtn.textContent = "Add Account";
        cancelEditBtn.style.display = "none";
      } else {
        // Add new
        await addDoc(collection(db, "chartOfAccounts"), {
          userId: currentUser,
          type,
          category,
          name,
          createdAt: new Date().toISOString()
        });
      }

      accountForm.reset();
      categorySelect.innerHTML = '<option value="">Select Category</option>';
      await loadAccounts();

    } catch (error) {
      alert("Error saving to Firebase: " + error.message);
    }
  });

  // Cancel edit
  cancelEditBtn.addEventListener('click', () => {
    editDocId = null;
    formTitle.textContent = "Add Account";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    accountForm.reset();
    categorySelect.innerHTML = '<option value="">Select Category</option>';
  });

  // Load accounts for current user
  async function loadAccounts() {
    accountsTable.innerHTML = '';
    if (!currentUser) return;

    try {
      const q = query(collection(db, "chartOfAccounts"), where("userId", "==", currentUser));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        accountsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No accounts found.</td></tr>';
        return;
      }

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="${data.type}">${data.type}</td>
          <td>${data.category}</td>
          <td>${data.name}</td>
          <td>
            <button class="edit-btn" data-id="${docSnap.id}"><i class="fa fa-edit"></i> Edit</button>
            <button class="delete-btn" data-id="${docSnap.id}"><i class="fa fa-trash"></i> Delete</button>
          </td>
        `;
        accountsTable.appendChild(tr);
      });

      // Add edit/delete event listeners
      accountsTable.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => startEditAccount(btn.dataset.id));
      });

      accountsTable.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteAccount(btn.dataset.id));
      });

    } catch (error) {
      console.error("Failed to load accounts:", error);
      accountsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Failed to load accounts.</td></tr>';
    }
  }

  // Start editing account
  async function startEditAccount(docId) {
    if (!currentUser) return;

    try {
      const docRef = doc(db, "chartOfAccounts", docId);
      // get document data (Firestore lite doesn't have getDoc, so workaround)
      const snapshot = await getDocs(query(collection(db, "chartOfAccounts"), where("__name__", "==", docId)));
      if (snapshot.empty) {
        alert("Document not found.");
        return;
      }
      const docSnap = snapshot.docs[0];
      const data = docSnap.data();

      if (data.userId !== currentUser) {
        alert("You do not have permission to edit this account.");
        return;
      }

      editDocId = docId;
      formTitle.textContent = "Edit Account";
      submitBtn.textContent = "Update Account";
      cancelEditBtn.style.display = "inline-block";

      accountTypeSelect.value = data.type;
      updateCategoryOptions(data.type);
      categorySelect.value = data.category;
      accountNameInput.value = data.name;

    } catch (error) {
      alert("Failed to load account for editing: " + error.message);
    }
  }

  // Delete account
  async function deleteAccount(docId) {
    if (!currentUser) return;
    if (!confirm("Are you sure you want to delete this account?")) return;

    try {
      const docRef = doc(db, "chartOfAccounts", docId);
      // Verify ownership before deleting
      const snapshot = await getDocs(query(collection(db, "chartOfAccounts"), where("__name__", "==", docId)));
      if (snapshot.empty) {
        alert("Document not found.");
        return;
      }
      const docSnap = snapshot.docs[0];
      const data = docSnap.data();

      if (data.userId !== currentUser) {
        alert("You do not have permission to delete this account.");
        return;
      }

      await deleteDoc(docRef);
      await loadAccounts();
    } catch (error) {
      alert("Failed to delete account: " + error.message);
    }
  }
</script>

</body>
</html>
