<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chart of Accounts</title>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f7f7f7;
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 1000px;
    margin: 40px auto;
    background-color: #fff;
    padding: 30px;
    border-radius: 8px;
  }

  h2 {
    text-align: center;
    margin-bottom: 30px;
  }

  .form-group {
    display: flex;
    margin-bottom: 15px;
  }

  .form-group label {
    width: 200px;
    font-weight: bold;
    margin-top: 6px;
  }

  .form-group select,
  .form-group input {
    flex: 1;
    padding: 8px;
    font-size: 1rem;
  }

  button {
    background-color: #28a745;
    color: #fff;
    padding: 10px 20px;
    border: none;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 10px;
  }

  button:hover {
    background-color: #218838;
  }

  table {
    width: 100%;
    margin-top: 30px;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 12px;
    border: 1px solid #ccc;
    text-align: left;
  }

  th {
    background-color: #f1f1f1;
  }

  .Income {
    color: green;
  }

  .Expense,
  .COGS,
  .OtherExpense {
    color: red;
  }

  .Asset,
  .Liability,
  .Equity,
  .OtherIncome {
    color: #333;
  }

  .action-btn {
    background-color: #007bff;
    margin-right: 5px;
  }
  .action-btn:hover {
    background-color: #0056b3;
  }

  .delete-btn {
    background-color: #dc3545;
  }
  .delete-btn:hover {
    background-color: #a71d2a;
  }
</style>
</head>
<body>
<div class="container">
  <h2>Chart of Accounts</h2>

  <!-- Add/Edit Account Form -->
  <form id="accountForm">
    <input type="hidden" id="accountId" />
    <div class="form-group">
      <label for="accountType">Account Type</label>
      <select id="accountType" required>
        <option value="">Select Type</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Equity">Equity</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="COGS">Cost of Goods Sold</option>
        <option value="OtherIncome">Other Income</option>
        <option value="OtherExpense">Other Expense</option>
      </select>
    </div>

    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="add-new">➕ Add new category...</option>
      </select>
    </div>

    <div class="form-group">
      <label for="accountName">Account Name</label>
      <input type="text" id="accountName" placeholder="e.g. Bank Account" required />
    </div>

    <div class="form-group">
      <label></label>
      <button type="submit" id="submitBtn">Add Account</button>
      <button type="button" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
    </div>
  </form>

  <!-- Account Table -->
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Category</th>
        <th>Account Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="accountsTable"></tbody>
  </table>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // Firebase config (replace with your own config)
  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM Elements
  const accountTypeSelect = document.getElementById("accountType");
  const categorySelect = document.getElementById("category");
  const accountForm = document.getElementById("accountForm");
  const accountsTable = document.getElementById("accountsTable");
  const accountNameInput = document.getElementById("accountName");
  const accountIdInput = document.getElementById("accountId");
  const submitBtn = document.getElementById("submitBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");

  let currentUser = null;
  let categories = {};

  // Wait for auth state and initialize app
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await init();
    } else {
      alert("You must be logged in to view this page.");
      window.location.href = "index.html"; // redirect to login page
    }
  });

  // Load categories from Firestore for the current user
  async function loadCategories() {
    categories = {};
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">➕ Add new category...</option>';

    try {
    const catSnapshot = await getDocs(
  query(collection(db, "Categories"), where("userId", "==", userId))
);


      catSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!categories[data.accountType]) categories[data.accountType] = [];
        if (!categories[data.accountType].includes(data.categoryName)) {
          categories[data.accountType].push(data.categoryName);
        }
      });
    } catch (err) {
      console.error("Error loading categories:", err);
    }
  }

  // Update category options based on selected account type
  function updateCategoryOptions(type) {
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">➕ Add new category...</option>';

    if (categories[type]) {
      categories[type].forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }
  }

  accountTypeSelect.addEventListener("change", () => {
    updateCategoryOptions(accountTypeSelect.value);
    categorySelect.value = "";
  });

  // Handle "Add new category" selection
  categorySelect.addEventListener("change", async () => {
    if (categorySelect.value === "add-new") {
      if (!accountTypeSelect.value) {
        alert("Please select Account Type first.");
        categorySelect.value = "";
        return;
      }
      const newCat = prompt(`Enter new category name for "${accountTypeSelect.value}":`);
      if (newCat && newCat.trim()) {
        const trimmedCat = newCat.trim();

        if (categories[accountTypeSelect.value] &&
            categories[accountTypeSelect.value].some(c => c.toLowerCase() === trimmedCat.toLowerCase())
        ) {
          alert("Category already exists.");
          categorySelect.value = "";
          return;
        }

        try {
      await addDoc(collection(db, "Categories"), {
  userId: request.auth.uid, // <-- pass UID from your client code as well (you can store it in localStorage after login)
  accountType: accountTypeSelect.value,
  categoryName: trimmedCat,
  createdAt: serverTimestamp(),
});

          await loadCategories();
          updateCategoryOptions(accountTypeSelect.value);
          categorySelect.value = trimmedCat;
        } catch (err) {
          alert("Error adding category: " + err.message);
          categorySelect.value = "";
        }
      } else {
        categorySelect.value = "";
      }
    }
  });

  // Load user accounts from Firestore
  async function loadAccounts() {
    accountsTable.innerHTML = "";
    try {
      const q = query(
        collection(db, "chartOfAccounts"),
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        addAccountRow(docSnap.id, data.type, data.category, data.name);
      });
    } catch (err) {
      console.error("Failed to load accounts:", err);
    }
  }

  // Add account row to table
  function addAccountRow(id, type, category, name) {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", id);
    tr.innerHTML = `
      <td class="${type}">${type}</td>
      <td>${category}</td>
      <td>${name}</td>
      <td>
        <button class="action-btn edit-btn">Edit</button>
        <button class="action-btn delete-btn">Delete</button>
      </td>
    `;

    tr.querySelector(".edit-btn").addEventListener("click", () => {
      startEditAccount(id, type, category, name);
    });

    tr.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this account?")) {
        try {
          await deleteDoc(doc(db, "chartOfAccounts", id));
          tr.remove();
          resetForm();
        } catch (err) {
          alert("Delete failed: " + err.message);
        }
      }
    });

    accountsTable.appendChild(tr);
  }

  // Start editing an account
  function startEditAccount(id, type, category, name) {
    accountIdInput.value = id;
    accountTypeSelect.value = type;
    updateCategoryOptions(type);
    categorySelect.value = category;
    accountNameInput.value = name;
    submitBtn.textContent = "Update Account";
    cancelEditBtn.style.display = "inline-block";
  }

  // Reset form to Add mode
  function resetForm() {
    accountForm.reset();
    accountIdInput.value = "";
    submitBtn.textContent = "Add Account";
    cancelEditBtn.style.display = "none";
    categorySelect.innerHTML = '<option value="">Select Category</option><option value="add-new">➕ Add new category...</option>';
  }

  cancelEditBtn.addEventListener("click", () => {
    resetForm();
  });

  // Form submit handler for Add or Update
  accountForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const type = accountTypeSelect.value;
    const category = categorySelect.value;
    const name = accountNameInput.value.trim();
    const id = accountIdInput.value;

    if (!type || !category || !name) {
      alert("All fields are required.");
      return;
    }

    try {
      if (id) {
        // Update existing
        await updateDoc(doc(db, "chartOfAccounts", id), {
          type,
          category,
          name,
          updatedAt: serverTimestamp(),
        });

        // Update UI row
        const row = accountsTable.querySelector(`tr[data-id="${id}"]`);
        if (row) {
          row.children[0].textContent = type;
          row.children[0].className = type;
          row.children[1].textContent = category;
          row.children[2].textContent = name;
        }
        alert("Account updated successfully!");
      } else {
        // Add new
        const docRef = await addDoc(collection(db, "chartOfAccounts"), {
          userId: currentUser.uid,
          type,
          category,
          name,
          createdAt: serverTimestamp(),
        });
        addAccountRow(docRef.id, type, category, name);
        alert("Account added successfully!");
      }

      resetForm();
    } catch (err) {
      alert("Failed to save account: " + err.message);
    }
  });

  // Initialize after login
  async function init() {
    await loadCategories();
    await loadAccounts();
  }
</script>
</body>
</html>
