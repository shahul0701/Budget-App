<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager Pro</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      transition: all 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-logo {
      font-weight: 700;
      font-size: 20px;
      color: var(--purple-1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      transition: all 0.2s;
      gap: 12px;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(111, 66, 193, 0.1);
      color: var(--purple-1);
      border-left: 3px solid var(--purple-1);
    }

    .sidebar-menu a i {
      width: 20px;
      text-align: center;
    }

    .sidebar-menu span {
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-menu span {
      opacity: 0;
      display: none;
    }

    .sidebar.collapsed .sidebar-logo span {
      display: none;
    }

    /* Main content with sidebar */
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: var(--sidebar-collapsed);
    }

    .page {
      max-width:1400px;
      margin:20px auto;
      padding:20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-trend { font-size:12px; display: flex; align-items: center; gap: 4px; margin-top: 5px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }
    .transactions-table tbody tr:hover td { background-color: rgba(111, 66, 193, 0.05); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.1); }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-recurring { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; right:30px; bottom:30px; width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(70,34,173,0.2); z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }

    /* responsive */
    @media (max-width: 1200px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .sidebar.show { transform: translateX(0); }
      .page { padding: 15px; }
    }
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: flex-end; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { width: 100%; min-width: unset; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      flex: 1;
      min-width: 200px;
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .quick-stat:hover {
      transform: translateY(-2px);
      background: var(--card-bg);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bg-primary);
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .split-summary {
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      font-weight: 600;
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }

    /* Tag system */
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .tag {
      background: var(--purple-1);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag-remove {
      background: none;
      border: none;
      color: white;
      padding: 0;
      cursor: pointer;
      font-size: 10px;
    }

    /* Search highlight */
    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
    }
    .nav-tabs .nav-link {
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
    }
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
    }

    /* Drag and drop */
    .drag-handle {
      cursor: move;
      color: var(--muted);
    }
    .dragging {
      opacity: 0.5;
      background: var(--bg-primary);
    }

    /* Recurring transactions */
    .recurring-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: black;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    /* AI Assistant */
    .ai-assistant {
      position: fixed;
      bottom: 100px;
      right: 30px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(70,34,173,0.3);
      z-index: 1100;
      transition: all 0.3s;
    }
    .ai-assistant:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(70,34,173,0.4);
    }
    .ai-panel {
      position: fixed;
      bottom: 170px;
      right: 30px;
      width: 350px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1099;
      display: none;
    }
    .ai-panel.show {
      display: block;
    }
    .ai-header {
      padding: 15px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-body {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .ai-message.user {
      background: rgba(111, 66, 193, 0.1);
      margin-left: 40px;
    }
    .ai-message.bot {
      background: var(--bg-primary);
      margin-right: 40px;
    }
    .ai-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid var(--border-color);
    }

    /* Mobile menu toggle */
    .mobile-menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 1200px) {
      .mobile-menu-toggle {
        display: flex;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Color picker */
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--purple-1);
    }

    /* Grid View Styles */
    .grid-card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 15px;
      transition: all 0.3s;
      height: 100%;
    }
    .grid-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .grid-card-income {
      border-left: 4px solid var(--success);
    }
    .grid-card-expense {
      border-left: 4px solid var(--danger);
    }
    .grid-card-transfer {
      border-left: 4px solid var(--info);
    }
    .grid-card-recurring {
      border-left: 4px solid var(--warning);
    }
    .grid-amount {
      font-size: 18px;
      font-weight: 700;
      margin: 10px 0;
    }
    .grid-date {
      font-size: 12px;
      color: var(--muted);
    }
    .grid-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
    }

    /* Calendar View Styles */
    .calendar {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 20px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      padding: 10px;
      color: var(--muted);
      font-size: 14px;
    }
    .calendar-day {
      min-height: 80px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 8px;
      background: var(--bg-primary);
      transition: all 0.2s;
    }
    .calendar-day:hover {
      background: rgba(111, 66, 193, 0.1);
    }
    .calendar-day.empty {
      background: transparent;
      border: none;
    }
    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .calendar-day-transactions {
      font-size: 11px;
    }
    .calendar-transaction {
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .calendar-transaction-income {
      background: rgba(25, 135, 84, 0.1);
      color: var(--success);
    }
    .calendar-transaction-expense {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    .calendar-nav-btn {
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .calendar-nav-btn:hover {
      background: var(--purple-2);
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fa fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fa fa-chart-line"></i>
        <span>FinancePro</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fa fa-chevron-left"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active"><i class="fa fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fa fa-exchange-alt"></i> <span>Transactions</span></a></li>
      <li><a href="#"><i class="fa fa-wallet"></i> <span>Accounts</span></a></li>
      <li><a href="#"><i class="fa fa-tags"></i> <span>Categories</span></a></li>
      <li><a href="#"><i class="fa fa-calendar-alt"></i> <span>Recurring</span></a></li>
      <li><a href="#"><i class="fa fa-bell"></i> <span>Reminders</span></a></li>
      <li><a href="#"><i class="fa fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="page">
      <!-- Loading Backdrop -->
      <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="backdropMessage">Loading...</p>
        </div>
      </div>
      
      <!-- Toast Container -->
      <div class="toast-container" id="toastContainer"></div>
      
      <!-- Navigation buttons -->
      <div class="nav-buttons">
        <button id="backBtn" class="btn btn-outline-primary">
          <i class="fa fa-arrow-left me-1"></i> Back
        </button>
        <button id="homeBtn" class="btn btn-outline-secondary">
          <i class="fa fa-home me-1"></i> Home
        </button>
        <button id="coaBtn" class="btn btn-outline-info">
          <i class="fa fa-chart-pie me-1"></i> Manage COA
        </button>
        <button id="recurringBtn" class="btn btn-outline-warning">
          <i class="fa fa-redo me-1"></i> Recurring
        </button>
        <div class="export-buttons">
          <button id="exportCSV" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-csv me-1"></i> CSV
          </button>
          <button id="exportExcel" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-excel me-1"></i> Excel
          </button>
        </div>
      </div>
      
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager Pro</h2>
          <div class="header-actions">
            <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
            <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
            <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
            <button id="tagManagerBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-tags me-1"></i> Tags</button>
            <button id="themeToggle" class="theme-toggle">
              <i class="fa fa-moon"></i>
            </button>
            <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
            <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
              <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
              <div style="color:white; font-weight:600;" id="username">User</div>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="bulkCategoryBtn" class="btn btn-outline-success btn-sm">
            <i class="fa fa-folder me-1"></i> Change Category
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>

        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card" onclick="showIncomeDetails()">
            <div class="stat-label">Total Income</div>
            <div id="statIncome" class="stat-value income-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-up text-success"></i> <span id="incomeTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="showExpenseDetails()">
            <div class="stat-label">Total Expenses</div>
            <div id="statExpense" class="stat-value expense-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-down text-danger"></i> <span id="expenseTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="toggleBalanceVisibility()">
            <div class="stat-label">Current Balance</div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">
              <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          <div class="stat-card" onclick="showTransactionStats()">
            <div class="stat-label">Transactions</div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card" onclick="showCashflowChart()">
            <div class="stat-label">Cash Flow</div>
            <div id="statCashflow" class="stat-value">$0.00</div>
            <div class="small-muted">Monthly average</div>
          </div>
        </div>
        
        <!-- Quick stats -->
        <div class="quick-stats" id="quickStats">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart">
          <!-- Chart will be rendered here -->
        </div>
        
        <!-- Bank balances section -->
        <div class="info-banner">
          <i class="fa fa-info-circle me-2"></i> 
          <span id="dynamicTip">Manage your transactions, view attachments, and track your finances in one place.</span>
          <button class="btn btn-sm btn-outline-primary ms-3" onclick="showNextTip()">Next Tip</button>
          <span class="float-end" id="lastSync"></span>
        </div>
        
        <div class="content-body">
          <!-- Tabs for different views -->
          <ul class="nav nav-tabs mb-3" id="viewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#listView">List View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#gridView">Grid View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#calendarView">Calendar View</a>
            </li>
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content">
            <!-- List View -->
            <div class="tab-pane fade show active" id="listView">
              <!-- Bank balances -->
              <div id="bankBalances" class="bank-balances">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- filters -->
              <div class="filters mb-2">
                <select id="dateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="quarter">This Quarter</option>
                </select>

                <div id="customRangeControls" style="display:none; gap:8px;">
                  <input id="startDate" type="date" class="form-control form-control-sm" />
                  <input id="endDate" type="date" class="form-control form-control-sm" />
                </div>

                <select id="typeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                  <option value="recurring">Recurring</option>
                </select>

                <!-- Bank Filter -->
                <select id="bankFilter" class="form-select form-select-sm">
                  <option value="all">All Banks</option>
                  <!-- Will be populated dynamically -->
                </select>

                <!-- Category Filter -->
                <select id="categoryFilter" class="form-select form-select-sm">
                  <option value="all">All Categories</option>
                  <!-- Will be populated dynamically -->
                </select>

                <select id="statusFilter" class="form-select form-select-sm">
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>

                <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes, tags..." />

                <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
                <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                <button id="advancedFiltersBtn" class="btn btn-sm btn-outline-info">Advanced</button>
                <button id="saveFilterBtn" class="btn btn-sm btn-outline-success" title="Save current filter as preset">
                  <i class="fa fa-save"></i>
                </button>
                <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
              </div>
              
              <!-- Advanced filters (initially hidden) -->
              <div id="advancedFilters" style="display: none;" class="filters mb-2">
                <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="Min Amount" step="0.01" />
                <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="Max Amount" step="0.01" />
                <input id="tagFilter" type="text" class="form-control form-control-sm" placeholder="Filter by tags (comma separated)" />
                <select id="sortBy" class="form-select form-select-sm">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="category">Category</option>
                  <option value="bank">Bank</option>
                </select>
                <select id="groupBy" class="form-select form-select-sm">
                  <option value="none">No Grouping</option>
                  <option value="date">Group by Date</option>
                  <option value="category">Group by Category</option>
                  <option value="bank">Group by Bank</option>
                  <option value="type">Group by Type</option>
                </select>
              </div>

              <!-- transactions table -->
              <div class="transactions-table">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th style="width:40px;">
                        <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                        <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
                      </th>
                      <th style="width:110px;">Date</th>
                      <th style="width:120px; text-align:right;">Account Header</th>
                      <th>Description</th>
                      <th style="width:120px;">Type</th>
                      <th style="width:110px;">Voucher #</th>
                      <th style="width:120px;">Bank Name</th>
                      <th style="width:120px; text-align:right;">Income</th>
                      <th style="width:120px; text-align:right;">Expense</th>
                      <th style="width:120px;">Balance</th>
                      <th style="width:120px;">Tags</th>
                      <th style="width:120px;">Attachment</th>
                      <th style="width:130px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr><td colspan="13" class="text-center text-muted py-4">No transactions loaded.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Grid View -->
            <div class="tab-pane fade" id="gridView">
              <div class="row" id="gridViewContainer">
                <!-- Will be populated dynamically -->
              </div>
              <div class="pagination-wrap mt-3" id="gridPaginationControls"></div>
            </div>

            <!-- Calendar View -->
            <div class="tab-pane fade" id="calendarView">
              <div id="calendarContainer">
                <!-- Calendar will be rendered here -->
              </div>
            </div>
          </div>

          <!-- pagination -->
          <div class="pagination-wrap mt-3" id="paginationControls"></div>
          
          <!-- Summary footer -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Selected Summary</h6>
                  <div id="selectedSummary">No transactions selected</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Filter Summary</h6>
                  <div id="filterSummary">Showing all transactions</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="ai-assistant" id="aiAssistant">
    <i class="fa fa-robot"></i>
  </div>
  <div class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <span>Finance Assistant</span>
      <button class="btn btn-sm btn-light" onclick="toggleAIPanel()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="ai-body" id="aiChat">
      <div class="ai-message bot">
        Hi! I'm your finance assistant. How can I help you today?
      </div>
    </div>
    <div class="ai-input">
      <input type="text" class="form-control" id="aiInput" placeholder="Ask me anything..." />
      <button class="btn btn-primary" onclick="sendAIMessage()">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- floating add button -->
  <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>

  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date *</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # (SINO) *</label>
                <input id="formSINO" type="text" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header *</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Account Header</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type *</label>
                <select id="formVOUCHERTYPE" class="form-select" required>
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Contra">Contra</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type *</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Adjustment">Adjustment</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name *</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency *</label>
                <select id="formCURRENCY" class="form-select" required>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="GBP">GBP (£)</option>
                  <option value="INR">INR (₹)</option>
                  <option value="JPY">JPY (¥)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Balance (manual)</label>
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description *</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description" required></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes"></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input id="formTAGS" type="text" class="form-control" placeholder="Enter tags (comma separated)" />
                <div class="tag-container mt-2" id="tagsPreview"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.csv" />
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>

            <!-- Recurring transaction options -->
            <div class="row g-2 mt-2" id="recurringOptions" style="display: none;">
              <div class="col-md-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Recurring Transaction</h6>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">Frequency</label>
                        <select id="formRECURRING_FREQ" class="form-select">
                          <option value="daily">Daily</option>
                          <option value="weekly">Weekly</option>
                          <option value="monthly">Monthly</option>
                          <option value="quarterly">Quarterly</option>
                          <option value="yearly">Yearly</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Interval</label>
                        <input id="formRECURRING_INTERVAL" type="number" class="form-control" value="1" min="1" />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input id="formRECURRING_ENDDATE" type="date" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="duplicateTransactionBtn">
            <i class="fa fa-copy me-1"></i> Duplicate
          </button>
          <button type="button" class="btn btn-info" id="makeRecurringBtn">
            <i class="fa fa-redo me-1"></i> Make Recurring
          </button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction in natural language:</label>
            <textarea id="quickAddInput" class="form-control" rows="3" placeholder="Examples:&#10;• Add 500 to cash&#10;• Spent 200 on petrol from SBI&#10;• Received 1000 payment from client in AXIS&#10;• Transfer 500 from SBI to HDFC"></textarea>
          </div>
          <div class="card bg-light">
            <div class="card-body py-2">
              <small class="text-muted">
                <strong>Format examples:</strong><br>
                • Add [amount] to [account]<br>
                • Spent [amount] on [category] from [bank]<br>
                • Received [amount] for [description] in [bank]<br>
                • Transfer [amount] from [bank1] to [bank2]<br>
                • You can include dates like "yesterday", "last friday", "15th jan"
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="processQuickAddBtn" class="btn btn-primary">Process</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Multiple Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Income Amount to Split</label>
            <input id="splitIncomeAmount" type="number" step="0.01" class="form-control" placeholder="Enter total income amount" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Description</label>
            <input id="splitIncomeDescription" type="text" class="form-control" placeholder="Description for the income transaction" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Bank Account</label>
            <select id="splitIncomeBank" class="form-select">
              <option value="">Select Bank</option>
              <!-- Will be populated from COA -->
            </select>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Expense Transactions</h6>
            <button type="button" id="addSplitExpenseBtn" class="btn btn-sm btn-primary">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div id="splitExpensesContainer">
            <!-- Split expense items will be added here -->
          </div>
          
          <div id="splitSummary" class="split-summary">
            <!-- Summary will be updated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="saveSplitTransactionsBtn" class="btn btn-primary">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Update Field</label>
            <select id="bulkEditField" class="form-select">
              <option value="BANK_NAME">Bank Name</option>
              <option value="ACCOUNT_HEADER">Account Header</option>
              <option value="TYPE">Transaction Type</option>
              <option value="VOUCHER_TYPE">Voucher Type</option>
              <option value="STATUS">Status</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Value</label>
            <input id="bulkEditValue" type="text" class="form-control" placeholder="Enter new value" />
          </div>
          <div class="alert alert-info">
            <small>This will update <span id="bulkEditCount">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkEditBtn" class="btn btn-primary">Update Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal fade" id="bulkTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Tags to Selected Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tags (comma separated)</label>
            <input id="bulkTagsInput" type="text" class="form-control" placeholder="e.g., business, travel, tax-deductible" />
            <small class="text-muted">Existing tags will be preserved, new tags will be added.</small>
          </div>
          <div class="alert alert-info">
            <small>This will add tags to <span id="bulkTagCount">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkTagBtn" class="btn btn-primary">Add Tags</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Manager Modal -->
  <div class="modal fade" id="tagManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tag Manager</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Manage Tags</h6>
              <div class="input-group mb-3">
                <input type="text" class="form-control" id="newTagInput" placeholder="New tag name" />
                <button class="btn btn-primary" onclick="addNewTag()">Add Tag</button>
              </div>
              <div id="tagList" class="mb-3">
                <!-- Tags will be listed here -->
              </div>
            </div>
            <div class="col-md-6">
              <h6>Tag Statistics</h6>
              <div id="tagStats">
                <!-- Tag statistics will be shown here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="attachmentModalBody">
          <!-- filled dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete this transaction?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirm -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete <span id="bulkDeleteCount">0</span> selected transactions?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkDeleteBtn" class="btn btn-danger">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing transaction...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Flatpickr for date range selection -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<!-- Firebase + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// state
let currentUser = null;
let allTransactions = [];
let filteredTransactions = [];
let currentPage = 1;
const rowsPerPage = 10;
let txToDelete = null;
let balanceVisible = false;
let isSubmitting = false;
let lastVoucherNumber = 0;
let currentTheme = 'light';
let mainChart = null;
let selectedTransactions = new Set();
let hasLoadedSavedState = false;
let allTags = new Set();
let recurringTransactions = [];
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// COA data
let coaAccounts = [];
let coaBanks = [];

// DOM refs
const loadingBackdrop = document.getElementById("loadingBackdrop");
const backdropMessage = document.getElementById("backdropMessage");
const usernameElem = document.getElementById("username");
const initialsElem = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const newTxBtn = document.getElementById("newTxBtn");
const quickAddBtn = document.getElementById("quickAddBtn");
const splitIncomeBtn = document.getElementById("splitIncomeBtn");
const floatingAdd = document.getElementById("floatingAdd");
const balanceToggle = document.getElementById("balanceToggle");
const backBtn = document.getElementById("backBtn");
const homeBtn = document.getElementById("homeBtn");
const coaBtn = document.getElementById("coaBtn");
const recurringBtn = document.getElementById("recurringBtn");
const tagManagerBtn = document.getElementById("tagManagerBtn");
const themeToggle = document.getElementById("themeToggle");
const exportCSV = document.getElementById("exportCSV");
const exportExcel = document.getElementById("exportExcel");
const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
const advancedFilters = document.getElementById("advancedFilters");
const includeTimeCheckbox = document.getElementById("includeTime");
const formTIME = document.getElementById("formTIME");
const formCURRENCY = document.getElementById("formCURRENCY");
const minAmount = document.getElementById("minAmount");
const maxAmount = document.getElementById("maxAmount");
const sortBy = document.getElementById("sortBy");
const groupBy = document.getElementById("groupBy");
const tagFilter = document.getElementById("tagFilter");
const formDESCRIPTION = document.getElementById("formDESCRIPTION");
const quickAddInput = document.getElementById("quickAddInput");
const processQuickAddBtn = document.getElementById("processQuickAddBtn");
const loadingModalEl = document.getElementById("loadingModal");
const loadingModal = new bootstrap.Modal(loadingModalEl);
const loadingMessage = document.getElementById("loadingMessage");
const selectAllBtn = document.getElementById("selectAllBtn");
const deselectAllBtn = document.getElementById("deselectAllBtn");
const selectAllCheckbox = document.getElementById("selectAllCheckbox");
const bulkActions = document.getElementById("bulkActions");
const selectedCount = document.getElementById("selectedCount");
const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
const bulkEditBtn = document.getElementById("bulkEditBtn");
const bulkTagBtn = document.getElementById("bulkTagBtn");
const bulkCategoryBtn = document.getElementById("bulkCategoryBtn");
const clearSelectionBtn = document.getElementById("clearSelectionBtn");
const splitIncomeModalEl = document.getElementById("splitIncomeModal");
const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
const splitIncomeAmount = document.getElementById("splitIncomeAmount");
const splitIncomeDescription = document.getElementById("splitIncomeDescription");
const splitIncomeBank = document.getElementById("splitIncomeBank");
const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
const splitExpensesContainer = document.getElementById("splitExpensesContainer");
const splitSummary = document.getElementById("splitSummary");
const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
const bulkEditModalEl = document.getElementById("bulkEditModal");
const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
const bulkEditField = document.getElementById("bulkEditField");
const bulkEditValue = document.getElementById("bulkEditValue");
const bulkEditCount = document.getElementById("bulkEditCount");
const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
const bulkDeleteCount = document.getElementById("bulkDeleteCount");
const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
const duplicateTransactionBtn = document.getElementById("duplicateTransactionBtn");
const makeRecurringBtn = document.getElementById("makeRecurringBtn");
const sidebar = document.getElementById("sidebar");
const sidebarToggle = document.getElementById("sidebarToggle");
const mobileMenuToggle = document.getElementById("mobileMenuToggle");
const mainContent = document.getElementById("mainContent");
const aiAssistant = document.getElementById("aiAssistant");
const aiPanel = document.getElementById("aiPanel");
const aiChat = document.getElementById("aiChat");
const aiInput = document.getElementById("aiInput");
const viewTabs = document.getElementById("viewTabs");
const gridViewContainer = document.getElementById("gridViewContainer");
const calendarContainer = document.getElementById("calendarContainer");
const selectedSummary = document.getElementById("selectedSummary");
const filterSummary = document.getElementById("filterSummary");
const dynamicTip = document.getElementById("dynamicTip");
const lastSync = document.getElementById("lastSync");
const saveFilterBtn = document.getElementById("saveFilterBtn");
const statusFilter = document.getElementById("statusFilter");
const categoryFilter = document.getElementById("categoryFilter");
const tagManagerModalEl = document.getElementById("tagManagerModal");
const tagManagerModal = new bootstrap.Modal(tagManagerModalEl);
const bulkTagModalEl = document.getElementById("bulkTagModal");
const bulkTagModal = new bootstrap.Modal(bulkTagModalEl);
const bulkTagsInput = document.getElementById("bulkTagsInput");
const bulkTagCount = document.getElementById("bulkTagCount");
const confirmBulkTagBtn = document.getElementById("confirmBulkTagBtn");

// Other DOM refs
const dateFilter = document.getElementById("dateFilter");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const customRangeControls = document.getElementById("customRangeControls");
const typeFilter = document.getElementById("typeFilter");
const bankFilter = document.getElementById("bankFilter");
const searchDesc = document.getElementById("searchDesc");
const applyFiltersBtn = document.getElementById("applyFiltersBtn");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");
const transactionsTableBody = document.getElementById("transactionsTableBody");
const paginationControls = document.getElementById("paginationControls");
const gridPaginationControls = document.getElementById("gridPaginationControls");
const bankBalancesContainer = document.getElementById("bankBalances");
const quickStatsContainer = document.getElementById("quickStats");
const transactionsChart = document.getElementById("transactionsChart");

// Modal refs
const transactionModalEl = document.getElementById("transactionModal");
const transactionModal = new bootstrap.Modal(transactionModalEl);
const quickAddModalEl = document.getElementById("quickAddModal");
const quickAddModal = new bootstrap.Modal(quickAddModalEl);
const form = document.getElementById("transactionForm");
const txIdInput = document.getElementById("txId");
const formDATE = document.getElementById("formDATE");
const formSINO = document.getElementById("formSINO");
const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
const formTYPE = document.getElementById("formTYPE");
const formBANKNAME = document.getElementById("formBANKNAME");
const formINCOME = document.getElementById("formINCOME");
const formEXPENSE = document.getElementById("formEXPENSE");
const formBALANCE = document.getElementById("formBALANCE");
const formNOTES = document.getElementById("formNOTES");
const formTAGS = document.getElementById("formTAGS");
const formSTATUS = document.getElementById("formSTATUS");
const tagsPreview = document.getElementById("tagsPreview");
const formATTACHFILE = document.getElementById("formATTACHFILE");
const formATTACH = document.getElementById("formATTACH");
const attachmentPreview = document.getElementById("attachmentPreview");
const attachmentInfo = document.getElementById("attachmentInfo");
const saveTransactionBtn = document.getElementById("saveTransactionBtn");
const uploadProgress = document.getElementById("uploadProgress");
const uploadProgressBar = document.getElementById("uploadProgressBar");
const recurringOptions = document.getElementById("recurringOptions");

const attachmentModalEl = document.getElementById("attachmentModal");
const attachmentModal = new bootstrap.Modal(attachmentModalEl);
const attachmentModalBody = document.getElementById("attachmentModalBody");

const confirmDeleteModalEl = document.getElementById("confirmDeleteModal");
const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

// stats
const statIncome = document.getElementById("statIncome");
const statExpense = document.getElementById("statExpense");
const statBalance = document.getElementById("statBalance");
const statCount = document.getElementById("statCount");
const statCashflow = document.getElementById("statCashflow");
const incomeTrend = document.getElementById("incomeTrend");
const expenseTrend = document.getElementById("expenseTrend");

// Helper functions
function escapeHtml(text) {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function showLoading(message = "Loading...") {
  backdropMessage.textContent = message;
  loadingBackdrop.style.display = "flex";
}

function hideLoading() {
  loadingBackdrop.style.display = "none";
}

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} 
        text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  const container = document.getElementById("toastContainer");
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function formatDateToYyyyMmmDd(dateString) {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = date.toLocaleString('default', { month: 'short' });
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (e) {
    return dateString;
  }
}

// Auth handling
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const name = user.displayName || user.email || "User";
    usernameElem.textContent = name;
    initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
    
    showLoading("Loading your transactions...");
    
    try {
      // Load theme preference
      loadThemePreference();
      
      // Load user preferences and data
      await Promise.all([
        loadUserPreferences(),
        loadCOAData(),
        loadTransactions(),
        loadTags(),
        loadRecurringTransactions()
      ]);
      
      loadAppState();
      applyFilters();
      updateLastSync();
      startPeriodicSync();
      
      hideLoading();
      showToast("Welcome back!", "success");
    } catch (error) {
      hideLoading();
      console.error("Initialization error:", error);
      Swal.fire({ 
        icon: 'error', 
        title: 'Loading Error', 
        text: 'Failed to load data. Please refresh the page.' 
      });
    }
  } else {
    // not logged in
    Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(()=> {
      window.location.href = "index.html";
    });
  }
});

// Event listeners
logoutBtn.addEventListener("click", async () => {
  localStorage.removeItem('budgetAppState');
  await signOut(auth);
  window.location.href = "index.html";
});

newTxBtn.addEventListener("click", () => openAddModal());
floatingAdd.addEventListener("click", () => openAddModal());

balanceToggle.addEventListener("click", () => {
  toggleBalanceVisibility();
});

dateFilter.addEventListener("change", () => {
  if (dateFilter.value === "custom") {
    customRangeControls.style.display = "flex";
  } else {
    customRangeControls.style.display = "none";
  }
});

applyFiltersBtn.addEventListener("click", () => { applyFilters(); });
resetFiltersBtn.addEventListener("click", () => {
  dateFilter.value = "all";
  typeFilter.value = "all";
  bankFilter.value = "all";
  categoryFilter.value = "all";
  statusFilter.value = "all";
  searchDesc.value = "";
  startDateInput.value = "";
  endDateInput.value = "";
  minAmount.value = "";
  maxAmount.value = "";
  tagFilter.value = "";
  sortBy.value = "date-desc";
  groupBy.value = "none";
  customRangeControls.style.display = "none";
  advancedFilters.style.display = "none";
  advancedFiltersBtn.textContent = "Advanced";
  applyFilters();
});

// Navigation button handlers
backBtn.addEventListener("click", () => window.history.back());
homeBtn.addEventListener("click", () => window.location.href = "home.html");
coaBtn.addEventListener("click", () => window.location.href = "coa.html");
recurringBtn.addEventListener("click", () => showRecurringTransactions());
tagManagerBtn.addEventListener("click", () => tagManagerModal.show());

// Theme toggle
themeToggle.addEventListener("click", () => toggleTheme());

// Export buttons
exportCSV.addEventListener("click", () => exportToCSV());
exportExcel.addEventListener("click", () => exportToExcel());

// Advanced filters toggle
advancedFiltersBtn.addEventListener("click", () => {
  const isVisible = advancedFilters.style.display === "flex";
  advancedFilters.style.display = isVisible ? "none" : "flex";
  advancedFiltersBtn.textContent = isVisible ? "Advanced" : "Hide Advanced";
});

// Time toggle
includeTimeCheckbox.addEventListener("change", () => {
  formTIME.disabled = !includeTimeCheckbox.checked;
  if (!includeTimeCheckbox.checked) formTIME.value = "";
});

// Quick Add button
quickAddBtn.addEventListener("click", () => {
  quickAddInput.value = "";
  quickAddModal.show();
});
processQuickAddBtn.addEventListener("click", processQuickAdd);

// Split Income button
splitIncomeBtn.addEventListener("click", () => openSplitIncomeModal());

// Bulk action buttons
selectAllBtn.addEventListener("click", selectAllTransactions);
deselectAllBtn.addEventListener("click", deselectAllTransactions);
selectAllCheckbox.addEventListener("change", toggleSelectAll);
bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
bulkEditBtn.addEventListener("click", openBulkEditModal);
bulkTagBtn.addEventListener("click", openBulkTagModal);
bulkCategoryBtn.addEventListener("click", openBulkCategoryModal);
clearSelectionBtn.addEventListener("click", clearSelection);
confirmBulkEditBtn.addEventListener("click", processBulkEdit);
confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
confirmBulkTagBtn.addEventListener("click", processBulkTags);
duplicateTransactionBtn.addEventListener("click", duplicateTransaction);
makeRecurringBtn.addEventListener("click", toggleRecurringOptions);
saveFilterBtn.addEventListener("click", saveFilterPreset);

// Sidebar toggle
sidebarToggle.addEventListener("click", toggleSidebar);
mobileMenuToggle.addEventListener("click", toggleMobileMenu);

// AI Assistant
aiAssistant.addEventListener("click", toggleAIPanel);
aiInput.addEventListener("keypress", (e) => {
  if (e.key === 'Enter') sendAIMessage();
});

// Form inputs
formTAGS.addEventListener("input", updateTagsPreview);
formTYPE.addEventListener("change", updateFormFields);

// Tab switching
viewTabs.addEventListener("shown.bs.tab", (event) => {
  const activeTab = event.target.getAttribute("href");
  if (activeTab === "#gridView") {
    renderGridView();
  } else if (activeTab === "#calendarView") {
    renderCalendarView();
  }
});

// Save transaction
saveTransactionBtn.addEventListener("click", async () => {
  if (isSubmitting) return;
  isSubmitting = true;
      
  saveTransactionBtn.disabled = true;
  saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
  
  if (!formDATE.value) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Date is required' });
    resetSaveButton();
    return;
  }

  if (!formSINO.value) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Voucher number is required' });
    resetSaveButton();
    return;
  }
      
  const txData = {
    DATE: formDATE.value,
    SINO: formSINO.value,
    ACCOUNT_HEADER: formACCOUNTHEADER.value,
    MODE: formBANKNAME.value,
    BANK_NAME: formBANKNAME.value,
    VOUCHER_TYPE: formVOUCHERTYPE.value,
    TYPE: formTYPE.value,
    INCOME: parseFloat(formINCOME.value) || 0,
    EXPENSE: parseFloat(formEXPENSE.value) || 0,
    BALANCE: parseFloat(formBALANCE.value) || 0,
    DESCRIPTION: formDESCRIPTION.value,
    NOTES: formNOTES.value,
    TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
    STATUS: formSTATUS.value,
    ATTACHMENT: formATTACH.value,
    CURRENCY: formCURRENCY.value,
    createdAt: new Date(),
    updatedAt: new Date(),
    userId: currentUser.uid
  };
  
  if (includeTimeCheckbox.checked && formTIME.value) {
    txData.TIME = formTIME.value;
  }
  
  // Check if recurring
  if (recurringOptions.style.display === "block") {
    txData.RECURRING = {
      frequency: document.getElementById("formRECURRING_FREQ").value,
      interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1,
      endDate: document.getElementById("formRECURRING_ENDDATE").value,
      nextDate: calculateNextRecurringDate(txData.DATE, {
        frequency: document.getElementById("formRECURRING_FREQ").value,
        interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1
      })
    };
  }
  
  try {
    loadingMessage.textContent = "Saving transaction...";
    loadingModal.show();
    
    if (txIdInput.value) {
      // Update existing transaction
      await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), txData);
      showToast("Transaction updated successfully", "success");
    } else {
      // Add new transaction
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
      showToast("Transaction added successfully", "success");
      
      // Update tags collection
      await updateTagsCollection(txData.TAGS);
    }
    
    loadingModal.hide();
    transactionModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("saveTransaction", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transaction' });
  } finally {
    resetSaveButton();
  }
});

confirmDeleteBtn.addEventListener("click", async () => {
  if (!txToDelete) return;
  
  try {
    loadingMessage.textContent = "Deleting transaction...";
    loadingModal.show();
    
    await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
    
    loadingModal.hide();
    showToast("Transaction deleted successfully", "success");
    await loadTransactions();
    confirmDeleteModal.hide();
  } catch (err) {
    loadingModal.hide();
    console.error("deleteTransaction", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transaction' });
  }
});

// Load COA data
async function loadCOAData() {
  try {
    if (!currentUser) return;
    
    // Get account headers from chartOfAccounts collection
    const accountsQuery = query(
      collection(db, "users", currentUser.uid, "chartOfAccounts"), 
      where("userId", "==", currentUser.uid)
    );
    const accountsSnapshot = await getDocs(accountsQuery);
    
    coaAccounts = [];
    coaBanks = [];
    
    accountsSnapshot.forEach(doc => {
      const data = doc.data();
      coaAccounts.push(data.name);
      
      // Check if this is a bank account
      if (data.category === "Bank" || data.category === "Cash" || 
          data.type === "Asset" && data.name.toLowerCase().includes("bank")) {
        coaBanks.push(data.name);
      }
    });
    
    // If no accounts found, set default accounts
    if (coaAccounts.length === 0) {
      coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
    }
    
    if (coaBanks.length === 0) {
      coaBanks = ["AXIS", "BOM", "Cash"];
    }
    
    // Populate the dropdowns
    populateCOADropdowns();
    
  } catch (error) {
    console.warn('Error loading COA data:', error.message);
    // Use default accounts if COA is not available
    coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
    coaBanks = ["AXIS", "BOM", "Cash"];
    populateCOADropdowns();
  }
}

function populateCOADropdowns() {
  // Clear existing options (except the first one)
  formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
  formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
  bankFilter.innerHTML = '<option value="all">All Banks</option>';
  splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
  categoryFilter.innerHTML = '<option value="all">All Categories</option>';
  
  // Add account headers
  coaAccounts.forEach(account => {
    const option = document.createElement('option');
    option.value = account;
    option.textContent = account;
    formACCOUNTHEADER.appendChild(option);
    
    // Add to category filter
    const categoryOption = document.createElement('option');
    categoryOption.value = account;
    categoryOption.textContent = account;
    categoryFilter.appendChild(categoryOption);
  });
  
  // Add bank names
  coaBanks.forEach(bank => {
    const option = document.createElement('option');
    option.value = bank;
    option.textContent = bank;
    formBANKNAME.appendChild(option);
    splitIncomeBank.appendChild(option.cloneNode(true));
    
    // Also add to bank filter
    const filterOption = document.createElement('option');
    filterOption.value = bank;
    filterOption.textContent = bank;
    bankFilter.appendChild(filterOption);
  });
}

// Load user preferences
async function loadUserPreferences() {
  try {
    const userPrefsRef = doc(db, "users", currentUser.uid, "preferences", "settings");
    const userPrefsSnap = await getDoc(userPrefsRef);
    
    if (userPrefsSnap.exists()) {
      const prefs = userPrefsSnap.data();
      // Apply user preferences
      if (prefs.defaultCurrency) {
        formCURRENCY.value = prefs.defaultCurrency;
      }
      if (prefs.defaultBank) {
        formBANKNAME.value = prefs.defaultBank;
      }
    }
  } catch (error) {
    console.warn('Error loading user preferences:', error.message);
  }
}

// Optimized transaction loading
async function loadTransactions() {
  try {
    transactionsTableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4 small-muted">Loading transactions...</td></tr>`;
    
    const q = query(
      collection(db, "users", currentUser.uid, "transactions"), 
      orderBy("createdAt", "desc")
    );
    
    const snap = await getDocs(q);
    const txs = snap.docs.map(d => ({ 
      id: d.id, 
      ...d.data(),
      NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
      BANK_NAME: d.data().BANK_NAME || d.data().MODE || "",
      TAGS: d.data().TAGS || [],
      STATUS: d.data().STATUS || "completed"
    }));
    
    allTransactions = txs;
    filteredTransactions = allTransactions.slice();
    
    if (!hasLoadedSavedState) {
      currentPage = 1;
    }
    
    // Calculate running balance once for all transactions
    calculateRunningBalance();
    buildTable();
    updateStats();
    updateBankBalances();
    updateQuickStats();
    renderMainChart();
    updateSelectedSummary();
    updateFilterSummary();
    
    // Initialize voucher numbering (non-blocking)
    setTimeout(() => initVoucherNumbering(), 100);
    
    return true;
  } catch (err) {
    console.error("loadTransactions error:", err);
    transactionsTableBody.innerHTML = `<tr><td colspan="13" class="text-center text-danger py-4">
      <i class="fa fa-exclamation-triangle me-2"></i>Failed to load transactions. Please try again.
    </td></tr>`;
    return false;
  }
}

async function loadTags() {
  try {
    const tagsRef = collection(db, "users", currentUser.uid, "tags");
    const tagsSnap = await getDocs(tagsRef);
    
    allTags.clear();
    tagsSnap.forEach(doc => {
      const tagData = doc.data();
      allTags.add(tagData.name);
    });
    
    // Also extract tags from transactions
    allTransactions.forEach(tx => {
      if (tx.TAGS && Array.isArray(tx.TAGS)) {
        tx.TAGS.forEach(tag => allTags.add(tag));
      }
    });
  } catch (error) {
    console.warn('Error loading tags:', error.message);
  }
}

async function loadRecurringTransactions() {
  try {
    const recurringQuery = query(
      collection(db, "users", currentUser.uid, "transactions"),
      where("RECURRING", "!=", null)
    );
    
    const recurringSnap = await getDocs(recurringQuery);
    recurringTransactions = recurringSnap.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));
  } catch (error) {
    console.warn('Error loading recurring transactions:', error.message);
  }
}

async function initVoucherNumbering() {
  try {
    const q = query(
      collection(db, "users", currentUser.uid, "transactions"),
      orderBy("SINO", "desc"),
      limit(1)
    );
    const snap = await getDocs(q);
    
    if (!snap.empty) {
      const lastTx = snap.docs[0].data();
      if (lastTx.SINO) {
        const match = lastTx.SINO.match(/\d+$/);
        if (match) {
          lastVoucherNumber = parseInt(match[0]);
        }
      }
    }
  } catch (error) {
    console.error("Error initializing voucher numbering:", error);
  }
}

async function getNextVoucherNumber(voucherType) {
  try {
    // For better performance, use local allTransactions array
    let highestPaymentNumber = 0;
    let highestReceiptNumber = 0;
    let highestJournalNumber = 0;
    let highestTransferNumber = 0;
    let highestContraNumber = 0;
    
    // Find the highest numbers for each type from local data
    allTransactions.forEach(tx => {
      if (tx.SINO) {
        if (/^\d+$/.test(tx.SINO)) {
          const num = parseInt(tx.SINO);
          if (num > highestPaymentNumber) highestPaymentNumber = num;
        }
        else if (tx.SINO.startsWith('RP-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestReceiptNumber) highestReceiptNumber = num;
        }
        else if (tx.SINO.startsWith('JR-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestJournalNumber) highestJournalNumber = num;
        }
        else if (tx.SINO.startsWith('TR-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestTransferNumber) highestTransferNumber = num;
        }
        else if (tx.SINO.startsWith('CT-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestContraNumber) highestContraNumber = num;
        }
      }
    });
    
    // Generate the next number based on voucher type
    if (voucherType === "Payment") {
      return (highestPaymentNumber + 1).toString();
    } else if (voucherType === "Receipt") {
      return `RP-${(highestReceiptNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Journal") {
      return `JR-${(highestJournalNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Transfer") {
      return `TR-${(highestTransferNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Contra") {
      return `CT-${(highestContraNumber + 1).toString().padStart(3, '0')}`;
    }
    
    return `${voucherType.substring(0, 2).toUpperCase()}-001`;
    
  } catch (error) {
    console.error("Error getting voucher number:", error);
    // Fallback based on type
    if (voucherType === "Payment") {
      const paymentNumbers = allTransactions
        .filter(tx => tx.SINO && /^\d+$/.test(tx.SINO))
        .map(tx => parseInt(tx.SINO))
        .filter(num => !isNaN(num));
      
      const highestNumber = paymentNumbers.length > 0 ? Math.max(...paymentNumbers) : 0;
      return (highestNumber + 1).toString();
    } else if (voucherType === "Receipt") {
      return "RP-001";
    } else if (voucherType === "Journal") {
      return "JR-001";
    } else if (voucherType === "Transfer") {
      return "TR-001";
    } else if (voucherType === "Contra") {
      return "CT-001";
    }
    
    return `${voucherType.substring(0, 2).toUpperCase()}-001`;
  }
}

function calculateRunningBalance() {
  const sortedTransactions = [...allTransactions].sort((a, b) => {
    return new Date(a.DATE) - new Date(b.DATE);
  });
  
  let runningBalance = 0;
  
  sortedTransactions.forEach(tx => {
    const income = parseFloat(tx.INCOME) || 0;
    const expense = parseFloat(tx.EXPENSE) || 0;
    runningBalance += (income - expense);
    tx.BALANCE = runningBalance;
  });
  
  return sortedTransactions;
}

function calculateBankBalances() {
  const bankBalances = {};
  
  coaBanks.forEach(bank => {
    bankBalances[bank] = 0;
  });
  
  allTransactions.forEach(tx => {
    const bankName = tx.BANK_NAME || tx.MODE || "";
    if (bankName && coaBanks.includes(bankName)) {
      const income = parseFloat(tx.INCOME) || 0;
      const expense = parseFloat(tx.EXPENSE) || 0;
      bankBalances[bankName] += (income - expense);
    }
  });
  
  return bankBalances;
}

function updateBankBalances() {
  const bankBalances = calculateBankBalances();
  
  bankBalancesContainer.innerHTML = "";
  
  // Add cash balance
  let hasCash = false;
  allTransactions.forEach(tx => {
    if ((tx.BANK_NAME === "Cash" || tx.MODE === "Cash") && !coaBanks.includes("Cash")) {
      hasCash = true;
    }
  });
  
  if (hasCash) {
    let cashBalance = 0;
    allTransactions.forEach(tx => {
      if (tx.BANK_NAME === "Cash" || tx.MODE === "Cash") {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        cashBalance += (income - expense);
      }
    });
    
    const cashItem = document.createElement("div");
    cashItem.className = "bank-balance-item";
    cashItem.innerHTML = `
      <div class="bank-balance-name">Cash</div>
      <div class="bank-balance-value ${cashBalance >= 0 ? 'positive-balance' : 'negative-balance'}">
        ${balanceVisible ? `$${cashBalance.toFixed(2)}` : '••••'}
      </div>
      <button class="balance-toggle" title="Toggle balance visibility">
        <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
      </button>
    `;
    bankBalancesContainer.appendChild(cashItem);
    
    cashItem.querySelector('.balance-toggle').addEventListener('click', () => {
      toggleBalanceVisibility();
    });
  }
  
  // Add bank balances
  Object.entries(bankBalances).forEach(([bankName, balance]) => {
    const bankItem = document.createElement("div");
    bankItem.className = "bank-balance-item";
    bankItem.innerHTML = `
      <div class="bank-balance-name">${escapeHtml(bankName)}</div>
      <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
        ${balanceVisible ? `$${balance.toFixed(2)}` : '••••'}
      </div>
      <button class="balance-toggle" title="Toggle balance visibility">
        <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
      </button>
    `;
    bankBalancesContainer.appendChild(bankItem);
    
    bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
      toggleBalanceVisibility();
    });
  });
}

function toggleBalanceVisibility() {
  balanceVisible = !balanceVisible;
  updateBalanceDisplay();
  saveAppState();
}

function updateBalanceDisplay() {
  const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
  const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
  const balance = totalIncome - totalExpense;
  
  statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
  statBalance.classList.toggle('balance-hidden', !balanceVisible);
  
  balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
  
  updateBankBalances();
  buildTable(); // Refresh table to update balance display
}

function updateQuickStats() {
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
  const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
  
  // Current month stats
  const monthlyIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const monthlyExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
  // Last month stats
  const lastMonthIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === lastMonth && txDate.getFullYear() === lastMonthYear && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const lastMonthExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === lastMonth && txDate.getFullYear() === lastMonthYear && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
  // Calculate trends
  const incomeTrendValue = lastMonthIncome > 0 ? ((monthlyIncome - lastMonthIncome) / lastMonthIncome * 100).toFixed(1) : 0;
  const expenseTrendValue = lastMonthExpenses > 0 ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1) : 0;
  
  incomeTrend.textContent = `${incomeTrendValue}%`;
  expenseTrend.textContent = `${expenseTrendValue}%`;
  
  // Total amount and average
  const totalAmount = allTransactions.reduce((sum, tx) => {
    const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
    return sum + amount;
  }, 0);
  
  const avgTransaction = allTransactions.length > 0 ? totalAmount / allTransactions.length : 0;
  
  // Counts
  const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
  const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
  const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
  const recurringCount = recurringTransactions.length;
  
  // Cash flow (last 30 days)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const recentIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate >= thirtyDaysAgo && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const recentExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate >= thirtyDaysAgo && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  
  const cashflow = recentIncome - recentExpenses;
  statCashflow.textContent = `$${cashflow.toFixed(2)}`;
  
  quickStatsContainer.innerHTML = `
    <div class="quick-stat" onclick="showIncomeDetails()">
      <i class="fa fa-arrow-up text-success"></i>
      <span>Monthly Income: <strong>$${monthlyIncome.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showExpenseDetails()">
      <i class="fa fa-arrow-down text-danger"></i>
      <span>Monthly Expenses: <strong>$${monthlyExpenses.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showTransactionStats()">
      <i class="fa fa-chart-line text-info"></i>
      <span>Avg Transaction: <strong>$${avgTransaction.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showTransactionStats()">
      <i class="fa fa-list text-primary"></i>
      <span>Counts: <strong>${incomeCount}/${expenseCount}/${transferCount}</strong></span>
    </div>
    <div class="quick-stat" onclick="showRecurringTransactions()">
      <i class="fa fa-redo text-warning"></i>
      <span>Recurring: <strong>${recurringCount}</strong></span>
    </div>
  `;
}

function renderMainChart() {
  if (mainChart) {
    mainChart.destroy();
  }
  
  const monthlyData = {};
  allTransactions.forEach(tx => {
    if (tx.DATE) {
      try {
        const date = new Date(tx.DATE);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        
        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = { income: 0, expense: 0 };
        }
        
        if (tx.TYPE === 'Income') {
          monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
        } else if (tx.TYPE === 'Expense') {
          monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
        }
      } catch (e) {
        // Skip invalid dates
      }
    }
  });
  
  const sortedMonths = Object.keys(monthlyData).sort();
  
  const incomeData = sortedMonths.map(month => monthlyData[month].income);
  const expenseData = sortedMonths.map(month => monthlyData[month].expense);
  
  const monthLabels = sortedMonths.map(month => {
    const [year, monthNum] = month.split('-');
    const date = new Date(year, monthNum - 1);
    return date.toLocaleString('default', { month: 'short', year: 'numeric' });
  });
  
  const ctx = transactionsChart.getContext('2d');
  mainChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [
        {
          label: 'Income',
          data: incomeData,
          backgroundColor: 'rgba(25, 135, 84, 0.7)',
          borderColor: 'rgba(25, 135, 84, 1)',
          borderWidth: 1
        },
        {
          label: 'Expenses',
          data: expenseData,
          backgroundColor: 'rgba(220, 53, 69, 0.7)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value;
            }
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Monthly Income vs Expenses'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': $' + context.raw.toFixed(2);
            }
          }
        }
      }
    }
  });
}

function applyFilters(){
  filteredTransactions = allTransactions.slice();
  const now = new Date();

  function inRange(dateStr, start, end){
    if (!dateStr) return false;
    try {
      const d = new Date(dateStr);
      return d >= start && d <= end;
    } catch (e) {
      return false;
    }
  }

  // Date filter
  if (dateFilter.value !== "all") {
    let start, end;
    switch (dateFilter.value) {
      case "today":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "week":
        const day = now.getDay();
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
        break;
      case "month":
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        break;
      case "year":
        start = new Date(now.getFullYear(), 0, 1);
        end = new Date(now.getFullYear() + 1, 0, 1);
        break;
      case "quarter":
        const quarter = Math.floor(now.getMonth() / 3);
        start = new Date(now.getFullYear(), quarter * 3, 1);
        end = new Date(now.getFullYear(), (quarter + 1) * 3, 1);
        break;
      case "last7":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "last30":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "custom":
        if (startDateInput.value && endDateInput.value) {
          start = new Date(startDateInput.value);
          end = new Date(endDateInput.value);
          end.setDate(end.getDate() + 1);
        }
        break;
    }
    if (start && end) {
      filteredTransactions = filteredTransactions.filter(t => inRange(t.DATE, start, end));
    }
  }

  // Type filter
  if (typeFilter.value !== "all") {
    if (typeFilter.value === "recurring") {
      filteredTransactions = filteredTransactions.filter(t => t.RECURRING);
    } else {
      filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
    }
  }

  // Bank filter
  if (bankFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      (t.BANK_NAME || t.MODE || "") === bankFilter.value
    );
  }

  // Category filter
  if (categoryFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      t.ACCOUNT_HEADER === categoryFilter.value
    );
  }

  // Status filter
  if (statusFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      t.STATUS === statusFilter.value
    );
  }

  // Search filter
  if (searchDesc.value.trim()) {
    const term = searchDesc.value.trim().toLowerCase();
    filteredTransactions = filteredTransactions.filter(t => 
      (t.DESCRIPTION || "").toLowerCase().includes(term) ||
      (t.NOTES || "").toLowerCase().includes(term) ||
      (t.TAGS && t.TAGS.some(tag => tag.toLowerCase().includes(term))) ||
      (t.SINO || "").toLowerCase().includes(term)
    );
  }
  
  // Amount filters
  if (minAmount.value) {
    const min = parseFloat(minAmount.value);
    filteredTransactions = filteredTransactions.filter(t => {
      const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
      return amount >= min;
    });
  }
  
  if (maxAmount.value) {
    const max = parseFloat(maxAmount.value);
    filteredTransactions = filteredTransactions.filter(t => {
      const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
      return amount <= max;
    });
  }
  
  // Tag filter
  if (tagFilter.value.trim()) {
    const tags = tagFilter.value.split(',').map(tag => tag.trim().toLowerCase());
    filteredTransactions = filteredTransactions.filter(t => {
      if (!t.TAGS || !Array.isArray(t.TAGS)) return false;
      return tags.every(tag => 
        t.TAGS.some(t => t.toLowerCase().includes(tag))
      );
    });
  }
  
  // Sorting
  switch (sortBy.value) {
    case "date-asc":
      filteredTransactions.sort((a, b) => {
        try {
          return new Date(a.DATE) - new Date(b.DATE);
        } catch (e) {
          return 0;
        }
      });
      break;
    case "amount-desc":
      filteredTransactions.sort((a, b) => {
        const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
        const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
        return amountB - amountA;
      });
      break;
    case "amount-asc":
      filteredTransactions.sort((a, b) => {
        const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
        const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
        return amountA - amountB;
      });
      break;
    case "category":
      filteredTransactions.sort((a, b) => (a.ACCOUNT_HEADER || "").localeCompare(b.ACCOUNT_HEADER || ""));
      break;
    case "bank":
      filteredTransactions.sort((a, b) => (a.BANK_NAME || "").localeCompare(b.BANK_NAME || ""));
      break;
    default: // date-desc
      filteredTransactions.sort((a, b) => {
        try {
          return new Date(b.DATE) - new Date(a.DATE);
        } catch (e) {
          return 0;
        }
      });
      break;
  }
  
  // Grouping
  if (groupBy.value !== "none") {
    // Grouping will be handled in the table render function
  }

  currentPage = 1;
  buildTable();
  updateStats();
  updateSelectedSummary();
  updateFilterSummary();
  saveAppState();
}

// Optimized table building
function buildTable(){
  if (filteredTransactions.length === 0) {
    transactionsTableBody.innerHTML = `
      <tr>
        <td colspan="13" class="text-center text-muted py-5">
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fa fa-exchange-alt"></i>
            </div>
            <h5>No transactions found</h5>
            <p class="text-muted">Try changing your filters or add a new transaction.</p>
            <button class="btn btn-primary mt-2" onclick="openAddModal()">
              <i class="fa fa-plus me-1"></i> Add Transaction
            </button>
          </div>
        </td>
      </tr>`;
    paginationControls.innerHTML = "";
    return;
  }

  const startIndex = (currentPage - 1) * rowsPerPage;
  const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
  const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

  let html = "";
  
  // Handle grouping
  if (groupBy.value !== "none") {
    const groups = {};
    pageTransactions.forEach(tx => {
      const groupKey = tx[groupBy.value.toUpperCase()] || tx[groupBy.value] || "Uncategorized";
      if (!groups[groupKey]) {
        groups[groupKey] = [];
      }
      groups[groupKey].push(tx);
    });
    
    Object.entries(groups).forEach(([groupName, groupTransactions]) => {
      html += `
        <tr class="table-group">
          <td colspan="13" style="background: rgba(111, 66, 193, 0.1); font-weight: 600;">
            ${groupBy.value}: ${escapeHtml(groupName)}
            <small class="float-end">${groupTransactions.length} transactions</small>
          </td>
        </tr>
      `;
      
      html += groupTransactions.map(tx => renderTableRow(tx)).join('');
    });
  } else {
    pageTransactions.forEach(tx => {
      html += renderTableRow(tx);
    });
  }
  
  transactionsTableBody.innerHTML = html;

  // Add event listeners with event delegation
  transactionsTableBody.addEventListener("click", handleTableClick);
  transactionsTableBody.addEventListener("change", handleTableChange);

  // Build pagination
  buildPagination();
}

function renderTableRow(tx) {
  const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
  const income = parseFloat(tx.INCOME) || 0;
  const expense = parseFloat(tx.EXPENSE) || 0;
  const balance = parseFloat(tx.BALANCE) || 0;
  const isSelected = selectedTransactions.has(tx.id);
  
  const incomeDisplay = income > 0 ? `<span class="income-color">$${income.toFixed(2)}</span>` : "$0.00";
  const expenseDisplay = expense > 0 ? `<span class="expense-color">$${expense.toFixed(2)}</span>` : "$0.00";
  const balanceDisplay = balanceVisible ? `$${balance.toFixed(2)}` : "••••";
  
  let badgeClass = '';
  let badgeText = tx.TYPE;
  if (tx.TYPE === 'Income') badgeClass = 'badge-income';
  else if (tx.TYPE === 'Expense') badgeClass = 'badge-expense';
  else if (tx.TYPE === 'Transfer') badgeClass = 'badge-transfer';
  
  if (tx.RECURRING) {
    badgeClass = 'badge-recurring';
    badgeText = 'Recurring';
  }
  
  // Highlight search term
  let description = escapeHtml(tx.DESCRIPTION || tx.NOTES || "");
  if (searchDesc.value.trim()) {
    const term = searchDesc.value.trim();
    const regex = new RegExp(`(${term})`, 'gi');
    description = description.replace(regex, '<span class="highlight">$1</span>');
  }
  
  // Render tags
  let tagsHtml = '';
  if (tx.TAGS && tx.TAGS.length > 0) {
    tagsHtml = tx.TAGS.map(tag => `
      <span class="tag">
        ${escapeHtml(tag)}
        <button class="tag-remove" onclick="removeTagFromTransaction('${tx.id}', '${tag}')">
          <i class="fa fa-times"></i>
        </button>
      </span>
    `).join('');
  }
  
  return `
    <tr class="${isSelected ? 'selected' : ''}" data-id="${tx.id}">
      <td>
        <input type="checkbox" class="transaction-checkbox row-checkbox" data-id="${tx.id}" ${isSelected ? 'checked' : ''}>
        <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
      </td>
      <td>${date}</td>
      <td>${escapeHtml(tx.ACCOUNT_HEADER || "-")}</td>
      <td>${description}</td>
      <td><span class="badge ${badgeClass}">${badgeText}</span></td>
      <td>${escapeHtml(tx.SINO || "")}</td>
      <td>${escapeHtml(tx.BANK_NAME || tx.MODE || "")}</td>
      <td style="text-align:right;">${incomeDisplay}</td>
      <td style="text-align:right;">${expenseDisplay}</td>
      <td style="text-align:right;">${balanceDisplay}</td>
      <td>
        <div class="tag-container">
          ${tagsHtml}
        </div>
      </td>
      <td>
        ${
          tx.ATTACHMENT
            ? `<button class="btn btn-sm btn-outline-primary view-attachment" data-attachment="${escapeHtml(tx.ATTACHMENT)}">
                <i class="fa fa-paperclip"></i> View
              </button>`
            : `<span class="text-muted">None</span>`
        }
      </td>
      <td>
        <div class="d-flex gap-1">
          <button class="action-btn btn-view view-tx" data-id="${tx.id}" title="View"><i class="fa fa-eye"></i></button>
          <button class="action-btn btn-edit edit-tx" data-id="${tx.id}" title="Edit"><i class="fa fa-edit"></i></button>
          <button class="action-btn btn-duplicate duplicate-tx" data-id="${tx.id}" title="Duplicate"><i class="fa fa-copy"></i></button>
          ${tx.RECURRING ? '<button class="action-btn btn-recurring" data-id="${tx.id}" title="Recurring"><i class="fa fa-redo"></i></button>' : ''}
          <button class="action-btn btn-del delete-tx" data-id="${tx.id}" title="Delete"><i class="fa fa-trash"></i></button>
        </div>
      </td>
    </tr>
  `;
}

function handleTableClick(e) {
  const target = e.target;
  const button = target.closest("button");
  
  if (!button) return;
  
  if (button.classList.contains("view-tx")) {
    const id = button.getAttribute("data-id");
    viewTransaction(id);
  } else if (button.classList.contains("edit-tx")) {
    const id = button.getAttribute("data-id");
    editTransaction(id);
  } else if (button.classList.contains("delete-tx")) {
    const id = button.getAttribute("data-id");
    confirmDelete(id);
  } else if (button.classList.contains("duplicate-tx")) {
    const id = button.getAttribute("data-id");
    duplicateTransactionById(id);
  } else if (button.classList.contains("view-attachment")) {
    const attachment = button.getAttribute("data-attachment");
    viewAttachment(attachment);
  }
}

function handleTableChange(e) {
  if (e.target.classList.contains("row-checkbox")) {
    const id = e.target.getAttribute("data-id");
    const row = e.target.closest("tr");
    
    if (e.target.checked) {
      selectedTransactions.add(id);
      row.classList.add("selected");
    } else {
      selectedTransactions.delete(id);
      row.classList.remove("selected");
      selectAllCheckbox.checked = false;
    }
    
    updateBulkActions();
    updateSelectedSummary();
  }
}

function buildPagination() {
  const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
  if (totalPages <= 1) {
    paginationControls.innerHTML = "";
    return;
  }

  let html = `<nav><ul class="pagination pagination-sm">`;

  html += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
    </li>
  `;

  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, startPage + 4);

  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === currentPage ? 'active' : ''}">
        <a class="page-link" href="#" data-page="${i}">${i}</a>
      </li>
    `;
  }

  html += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
    </li>
  `;

  paginationControls.innerHTML = html;

  // Event delegation for pagination
  paginationControls.addEventListener("click", function(e) {
    const link = e.target.closest(".page-link");
    if (link) {
      e.preventDefault();
      const page = parseInt(link.getAttribute("data-page"));
      if (page && page !== currentPage && page > 0 && page <= totalPages) {
        currentPage = page;
        buildTable();
        saveAppState();
      }
    }
  });
}

function updateStats(){
  const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
  const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
  const balance = totalIncome - totalExpense;
  
  statIncome.textContent = `$${totalIncome.toFixed(2)}`;
  statExpense.textContent = `$${totalExpense.toFixed(2)}`;
  statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
  statCount.textContent = filteredTransactions.length;
  
  statIncome.className = "stat-value income-color";
  statExpense.className = "stat-value expense-color";
}

function updateSelectedSummary() {
  const count = selectedTransactions.size;
  if (count === 0) {
    selectedSummary.innerHTML = "No transactions selected";
    return;
  }
  
  let totalIncome = 0;
  let totalExpense = 0;
  
  selectedTransactions.forEach(id => {
    const tx = allTransactions.find(t => t.id === id);
    if (tx) {
      totalIncome += parseFloat(tx.INCOME) || 0;
      totalExpense += parseFloat(tx.EXPENSE) || 0;
    }
  });
  
  const net = totalIncome - totalExpense;
  
  selectedSummary.innerHTML = `
    <div class="row">
      <div class="col-4">Selected: <strong>${count}</strong></div>
      <div class="col-4">Income: <strong class="text-success">$${totalIncome.toFixed(2)}</strong></div>
      <div class="col-4">Expense: <strong class="text-danger">$${totalExpense.toFixed(2)}</strong></div>
    </div>
    <div class="row mt-1">
      <div class="col-12">Net: <strong class="${net >= 0 ? 'text-success' : 'text-danger'}">$${net.toFixed(2)}</strong></div>
    </div>
  `;
}

function updateFilterSummary() {
  const count = filteredTransactions.length;
  const total = allTransactions.length;
  const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
  
  filterSummary.innerHTML = `
    Showing ${count} of ${total} transactions (${percentage}%)
    ${dateFilter.value !== 'all' ? `<br><small>Date filter: ${dateFilter.options[dateFilter.selectedIndex].text}</small>` : ''}
    ${typeFilter.value !== 'all' ? `<br><small>Type: ${typeFilter.options[typeFilter.selectedIndex].text}</small>` : ''}
    ${searchDesc.value ? `<br><small>Search: "${searchDesc.value}"</small>` : ''}
  `;
}

// Optimized modal opening
async function openAddModal(){
  showLoading("Loading form...");
  
  try {
    txIdInput.value = "";
    form.reset();
    formDATE.value = new Date().toISOString().split('T')[0];
    formTYPE.value = "Income";
    formVOUCHERTYPE.value = "Payment";
    formTIME.disabled = true;
    includeTimeCheckbox.checked = false;
    formCURRENCY.value = "USD";
    formSTATUS.value = "completed";
    formTAGS.value = "";
    tagsPreview.innerHTML = "";
    recurringOptions.style.display = "none";
    
    // Generate voucher number (non-blocking)
    const voucherNumber = await getNextVoucherNumber(formVOUCHERTYPE.value);
    formSINO.value = voucherNumber;
    
    formINCOME.value = "";
    formEXPENSE.value = "";
    formBALANCE.value = "";
    formNOTES.value = "";
    formDESCRIPTION.value = "";
    formATTACH.value = "";
    attachmentPreview.style.display = "none";
    attachmentInfo.textContent = "";
    uploadProgress.style.display = "none";
    
    Array.from(form.elements).forEach(el => el.disabled = false);
    formTIME.disabled = true;
    saveTransactionBtn.style.display = "block";
    saveTransactionBtn.disabled = false;
    saveTransactionBtn.innerHTML = 'Save Transaction';

    formVOUCHERTYPE.addEventListener("change", async function() {
      if (!txIdInput.value) {
        formSINO.value = await getNextVoucherNumber(this.value);
      }
    }, { once: true });
    
    updateFormFields();
    
    document.getElementById("transactionModalLabel").textContent = "Add Transaction";
    duplicateTransactionBtn.style.display = "none";
    makeRecurringBtn.style.display = "inline-block";
    
    // Hide loading and show modal
    setTimeout(() => {
      hideLoading();
      transactionModal.show();
    }, 100);
    
  } catch (error) {
    hideLoading();
    console.error("Error opening modal:", error);
    Swal.fire({ 
      icon: 'error', 
      title: 'Error', 
      text: 'Failed to load form. Please try again.' 
    });
  }
}

function viewTransaction(id){
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  showLoading("Loading transaction...");
  
  setTimeout(() => {
    txIdInput.value = tx.id;
    formDATE.value = tx.DATE || "";
    formSINO.value = tx.SINO || "";
    formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
    formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
    formTYPE.value = tx.TYPE || "Income";
    formBANKNAME.value = tx.BANK_NAME || tx.MODE || "";
    formINCOME.value = tx.INCOME || "";
    formEXPENSE.value = tx.EXPENSE || "";
    formBALANCE.value = tx.BALANCE || "";
    formNOTES.value = tx.NOTES || "";
    formDESCRIPTION.value = tx.DESCRIPTION || "";
    formCURRENCY.value = tx.CURRENCY || "USD";
    formSTATUS.value = tx.STATUS || "completed";
    formTAGS.value = tx.TAGS ? tx.TAGS.join(', ') : "";
    updateTagsPreview();
    
    if (tx.TIME) {
      formTIME.value = tx.TIME;
      includeTimeCheckbox.checked = true;
      formTIME.disabled = false;
    } else {
      formTIME.value = "";
      includeTimeCheckbox.checked = false;
      formTIME.disabled = true;
    }
    
    if (tx.ATTACHMENT) {
      attachmentInfo.textContent = "Attachment: " + tx.ATTACHMENT;
    } else {
      attachmentInfo.textContent = "";
    }
    
    if (tx.RECURRING) {
      recurringOptions.style.display = "block";
      document.getElementById("formRECURRING_FREQ").value = tx.RECURRING.frequency || "monthly";
      document.getElementById("formRECURRING_INTERVAL").value = tx.RECURRING.interval || 1;
      document.getElementById("formRECURRING_ENDDATE").value = tx.RECURRING.endDate || "";
    } else {
      recurringOptions.style.display = "none";
    }
    
    updateFormFields();
    
    document.getElementById("transactionModalLabel").textContent = "View Transaction";
    
    Array.from(form.elements).forEach(el => el.disabled = true);
    saveTransactionBtn.style.display = "none";
    duplicateTransactionBtn.style.display = "inline-block";
    makeRecurringBtn.style.display = tx.RECURRING ? "none" : "inline-block";
    
    hideLoading();
    transactionModal.show();
  }, 100);
}

function editTransaction(id){
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  showLoading("Loading transaction...");
  
  setTimeout(() => {
    txIdInput.value = tx.id;
    formDATE.value = tx.DATE || "";
    formSINO.value = tx.SINO || "";
    formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
    formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
    formTYPE.value = tx.TYPE || "Income";
    formBANKNAME.value = tx.BANK_NAME || tx.MODE || "";
    formINCOME.value = tx.INCOME || "";
    formEXPENSE.value = tx.EXPENSE || "";
    formBALANCE.value = tx.BALANCE || "";
    formNOTES.value = tx.NOTES || "";
    formDESCRIPTION.value = tx.DESCRIPTION || "";
    formCURRENCY.value = tx.CURRENCY || "USD";
    formSTATUS.value = tx.STATUS || "completed";
    formTAGS.value = tx.TAGS ? tx.TAGS.join(', ') : "";
    updateTagsPreview();
    
    if (tx.TIME) {
      formTIME.value = tx.TIME;
      includeTimeCheckbox.checked = true;
      formTIME.disabled = false;
    } else {
      formTIME.value = "";
      includeTimeCheckbox.checked = false;
      formTIME.disabled = true;
    }
    
    if (tx.ATTACHMENT) {
      attachmentInfo.textContent = "Current: " + tx.ATTACHMENT;
    } else {
      attachmentInfo.textContent = "";
    }
    
    if (tx.RECURRING) {
      recurringOptions.style.display = "block";
      document.getElementById("formRECURRING_FREQ").value = tx.RECURRING.frequency || "monthly";
      document.getElementById("formRECURRING_INTERVAL").value = tx.RECURRING.interval || 1;
      document.getElementById("formRECURRING_ENDDATE").value = tx.RECURRING.endDate || "";
    } else {
      recurringOptions.style.display = "none";
    }
    
    updateFormFields();
    
    document.getElementById("transactionModalLabel").textContent = "Edit Transaction";
    
    Array.from(form.elements).forEach(el => el.disabled = false);
    formTIME.disabled = !includeTimeCheckbox.checked;
    saveTransactionBtn.style.display = "block";
    saveTransactionBtn.disabled = false;
    saveTransactionBtn.innerHTML = 'Save Transaction';
    duplicateTransactionBtn.style.display = "inline-block";
    makeRecurringBtn.style.display = tx.RECURRING ? "none" : "inline-block";
    
    hideLoading();
    transactionModal.show();
  }, 100);
}

function updateFormFields() {
  const type = formTYPE.value;
  const incomeInput = document.getElementById("formINCOME");
  const expenseInput = document.getElementById("formEXPENSE");
  
  if (type === "Income") {
    incomeInput.disabled = false;
    incomeInput.required = true;
    expenseInput.disabled = true;
    expenseInput.value = "";
    expenseInput.required = false;
  } else if (type === "Expense") {
    incomeInput.disabled = true;
    incomeInput.value = "";
    incomeInput.required = false;
    expenseInput.disabled = false;
    expenseInput.required = true;
  } else {
    incomeInput.disabled = false;
    expenseInput.disabled = false;
    incomeInput.required = false;
    expenseInput.required = false;
  }
}

function updateTagsPreview() {
  const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag);
  tagsPreview.innerHTML = tags.map(tag => `
    <span class="tag">
      ${escapeHtml(tag)}
      <button type="button" class="tag-remove" onclick="removeTagFromInput('${tag}')">
        <i class="fa fa-times"></i>
      </button>
    </span>
  `).join('');
}

function removeTagFromInput(tagToRemove) {
  const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== tagToRemove);
  formTAGS.value = tags.join(', ');
  updateTagsPreview();
}

async function removeTagFromTransaction(transactionId, tagToRemove) {
  try {
    const tx = allTransactions.find(t => t.id === transactionId);
    if (!tx) return;
    
    const updatedTags = tx.TAGS.filter(tag => tag !== tagToRemove);
    
    await updateDoc(doc(db, "users", currentUser.uid, "transactions", transactionId), {
      TAGS: updatedTags
    });
    
    showToast("Tag removed successfully", "success");
    await loadTransactions();
  } catch (error) {
    console.error("Error removing tag:", error);
    showToast("Failed to remove tag", "error");
  }
}

function confirmDelete(id){
  txToDelete = id;
  confirmDeleteModal.show();
}

function resetSaveButton() {
  isSubmitting = false;
  saveTransactionBtn.disabled = false;
  saveTransactionBtn.innerHTML = 'Save Transaction';
}

// File attachment handling with Firebase Storage
formATTACHFILE.addEventListener("change", async function () {
  const file = this.files[0];
  if (!file) return;
  
  if (file.size > 10 * 1024 * 1024) {
    Swal.fire({ icon: 'error', title: 'File too large', text: 'Please select a file smaller than 10MB' });
    this.value = '';
    return;
  }

  try {
    uploadProgress.style.display = "block";
    uploadProgressBar.style.width = "0%";
    
    // Simulate upload progress
    const progressInterval = setInterval(() => {
      if (uploadProgressBar.style.width === "100%") {
        clearInterval(progressInterval);
      } else {
        const currentWidth = parseInt(uploadProgressBar.style.width) || 0;
        uploadProgressBar.style.width = Math.min(currentWidth + 10, 100) + "%";
      }
    }, 200);
    
    // Create a unique filename
    const fileName = `${Date.now()}_${file.name}`;
    const storageRef = ref(storage, `users/${currentUser.uid}/attachments/${fileName}`);
    
    // Upload file to Firebase Storage
    const snapshot = await uploadBytes(storageRef, file);
    const downloadURL = await getDownloadURL(snapshot.ref);
    
    clearInterval(progressInterval);
    uploadProgressBar.style.width = "100%";
    
    setTimeout(() => {
      formATTACH.value = downloadURL;
      attachmentInfo.textContent = "Uploaded: " + file.name;
      
      if (file.type.startsWith('image/')) {
        attachmentPreview.src = URL.createObjectURL(file);
        attachmentPreview.style.display = "block";
      } else {
        attachmentPreview.style.display = "none";
      }
      
      uploadProgress.style.display = "none";
    }, 500);
    
  } catch (err) {
    console.error("Upload failed", err);
    uploadProgress.style.display = "none";
    Swal.fire({ 
      icon: 'error', 
      title: 'Upload failed', 
      text: 'Could not upload attachment' 
    });
    this.value = '';
  }
});

function viewAttachment(attachmentUrl) {
  if (!attachmentUrl) return;

  const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(attachmentUrl) || attachmentUrl.startsWith('data:image') || attachmentUrl.includes('firebasestorage');
  const isPDF = /\.(pdf)$/i.test(attachmentUrl) || attachmentUrl.includes('.pdf');
  const isDocument = /\.(doc|docx|xls|xlsx|txt)$/i.test(attachmentUrl);

  attachmentModalBody.innerHTML = `
    <div class="mb-3">
      <h6>Attachment Preview</h6>
      ${isImage 
        ? `<img src="${attachmentUrl}" class="img-fluid" style="max-height: 400px;" />`
        : isPDF
          ? `<iframe src="${attachmentUrl}" width="100%" height="400px"></iframe>`
          : isDocument
            ? `<div class="alert alert-info">Document files can be downloaded but not previewed</div>`
            : `<div class="alert alert-info">File type not supported for preview</div>`
      }
    </div>
    <div>
      <a class="btn btn-primary" href="${attachmentUrl}" download target="_blank">
        <i class="fa fa-download me-1"></i> Download
      </a>
    </div>
  `;

  attachmentModal.show();
}

// Quick Add processing
async function processQuickAdd() {
  const text = quickAddInput.value.trim();
  if (!text) {
    Swal.fire({ icon: 'warning', title: 'Input required', text: 'Please enter a transaction description' });
    return;
  }

  try {
    loadingMessage.textContent = "Processing your request...";
    loadingModal.show();
    
    const parsedData = parseQuickAddInput(text);
    
    if (!parsedData.amount) {
      loadingModal.hide();
      Swal.fire({ icon: 'warning', title: 'Invalid Input', text: 'Could not detect an amount in your input' });
      return;
    }

    const txData = {
      DATE: parsedData.date || new Date().toISOString().split('T')[0],
      SINO: "",
      ACCOUNT_HEADER: parsedData.accountHeader,
      BANK_NAME: parsedData.bankName,
      MODE: parsedData.bankName,
      VOUCHER_TYPE: parsedData.voucherType,
      TYPE: parsedData.type,
      INCOME: parsedData.type === "Income" ? parsedData.amount : 0,
      EXPENSE: parsedData.type === "Expense" ? parsedData.amount : 0,
      BALANCE: 0,
      DESCRIPTION: parsedData.description,
      NOTES: "Quick add transaction",
      TAGS: parsedData.tags || [],
      STATUS: "completed",
      CURRENCY: "USD",
      createdAt: new Date(),
      updatedAt: new Date(),
      userId: currentUser.uid
    };

    if (parsedData.type === "Transfer") {
      const fromTx = {
        ...txData,
        SINO: await getNextVoucherNumber("Transfer"),
        ACCOUNT_HEADER: parsedData.fromBank,
        BANK_NAME: parsedData.fromBank,
        MODE: parsedData.fromBank,
        EXPENSE: parsedData.amount,
        INCOME: 0,
        DESCRIPTION: `Transfer to ${parsedData.toBank}`
      };
      
      const toTx = {
        ...txData,
        SINO: await getNextVoucherNumber("Transfer"),
        ACCOUNT_HEADER: parsedData.toBank,
        BANK_NAME: parsedData.toBank,
        MODE: parsedData.toBank,
        INCOME: parsedData.amount,
        EXPENSE: 0,
        DESCRIPTION: `Transfer from ${parsedData.fromBank}`
      };
      
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), fromTx);
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), toTx);
      
      loadingModal.hide();
      showToast("Transfer completed successfully", "success");
    } else {
      const voucherNumber = await getNextVoucherNumber(parsedData.voucherType);
      txData.SINO = voucherNumber;
      
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
      loadingModal.hide();
      showToast("Transaction added successfully", "success");
    }
    
    quickAddModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("Quick add error", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add transaction' });
  }
}

function parseQuickAddInput(text) {
  const lowerText = text.toLowerCase();
  let amount = 0;
  let type = "";
  let accountHeader = "";
  let bankName = "";
  let description = text;
  let date = null;
  let fromBank = "";
  let toBank = "";
  let tags = [];
  
  // Extract amount
  const amountMatch = text.match(/(\d+)(\.\d+)?/);
  if (amountMatch) {
    amount = parseFloat(amountMatch[0]);
  }
  
  // Extract date
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  
  if (lowerText.includes('today')) {
    date = today.toISOString().split('T')[0];
  } else if (lowerText.includes('yesterday')) {
    date = yesterday.toISOString().split('T')[0];
  } else {
    const relativeDateMatch = lowerText.match(/(\d+) days? ago/);
    if (relativeDateMatch) {
      const daysAgo = parseInt(relativeDateMatch[1]);
      const pastDate = new Date(today);
      pastDate.setDate(pastDate.getDate() - daysAgo);
      date = pastDate.toISOString().split('T')[0];
    }
    
    const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
    for (let i = 0; i < monthNames.length; i++) {
      if (lowerText.includes(monthNames[i])) {
        const dayMatch = lowerText.match(/(\d+)(?:st|nd|rd|th)?/);
        if (dayMatch) {
          const day = parseInt(dayMatch[1]);
          const year = today.getFullYear();
          const month = i;
          date = new Date(year, month, day).toISOString().split('T')[0];
          break;
        }
      }
    }
  }

  // Determine transaction type
  if (lowerText.includes('transfer') && lowerText.includes('from') && lowerText.includes('to')) {
    type = "Transfer";
    const transferMatch = lowerText.match(/transfer.*?(\d+).*?from (.*?) to (.*)/);
    if (transferMatch) {
      amount = parseFloat(transferMatch[1]);
      fromBank = findMatchingBank(transferMatch[2]);
      toBank = findMatchingBank(transferMatch[3]);
      description = `Transfer from ${fromBank} to ${toBank}`;
    }
  } else if (lowerText.includes('add') || lowerText.includes('receive') || lowerText.includes('income') || 
      lowerText.includes('deposit') || lowerText.includes('credit')) {
    type = "Income";
  } else if (lowerText.includes('spent') || lowerText.includes('spend') || lowerText.includes('pay') || 
             lowerText.includes('expense') || lowerText.includes('debit') || lowerText.includes('withdraw')) {
    type = "Expense";
  }

  if (type !== "Transfer") {
    // Extract bank name
    for (const bank of coaBanks) {
      if (lowerText.includes(bank.toLowerCase())) {
        bankName = bank;
        break;
      }
    }

    // Extract account header
    for (const account of coaAccounts) {
      if (lowerText.includes(account.toLowerCase())) {
        accountHeader = account;
        break;
      }
    }

    // Extract tags
    const commonTags = ['business', 'personal', 'travel', 'food', 'entertainment', 'shopping', 'bills', 'utilities'];
    commonTags.forEach(tag => {
      if (lowerText.includes(tag)) {
        tags.push(tag);
      }
    });

    if (!accountHeader) {
      if (lowerText.includes('petrol') || lowerText.includes('fuel') || lowerText.includes('gas')) {
        accountHeader = "Fuel";
      } else if (lowerText.includes('food') || lowerText.includes('meal') || lowerText.includes('restaurant')) {
        accountHeader = "Meals & Entertainment";
      } else if (lowerText.includes('rent') || lowerText.includes('house') || lowerText.includes('apartment')) {
        accountHeader = "Rent";
      } else if (lowerText.includes('shopping') || lowerText.includes('store') || lowerText.includes('buy')) {
        accountHeader = "Shopping";
      } else if (bankName) {
        accountHeader = bankName;
      } else {
        accountHeader = "Miscellaneous";
      }
    }

    if (!bankName && lowerText.includes('cash')) {
      bankName = "Cash";
    }
  }

  let voucherType = "Payment";
  if (type === "Income") voucherType = "Receipt";
  else if (type === "Transfer") voucherType = "Transfer";

  return {
    amount,
    type,
    accountHeader,
    bankName,
    description,
    date,
    voucherType,
    fromBank,
    toBank,
    tags
  };
}

function findMatchingBank(bankText) {
  for (const bank of coaBanks) {
    if (bank.toLowerCase().includes(bankText.trim().toLowerCase()) || 
        bankText.trim().toLowerCase().includes(bank.toLowerCase())) {
      return bank;
    }
  }
  return bankText;
}

// Theme functions
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
  localStorage.setItem('theme', currentTheme);
  
  if (mainChart) {
    renderMainChart();
  }
}

function loadThemePreference() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    currentTheme = savedTheme;
    document.documentElement.setAttribute('data-theme', currentTheme);
    themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
  }
}

// Export functions
function exportToCSV() {
  if (filteredTransactions.length === 0) {
    Swal.fire({ icon: 'warning', title: 'No Data', text: 'There are no transactions to export.' });
    return;
  }
  
  const headers = ['Date', 'Account Header', 'Description', 'Type', 'Voucher #', 'Bank Name', 'Income', 'Expense', 'Balance', 'Currency', 'Status', 'Tags'];
  
  let csvContent = headers.join(',') + '\n';
  
  filteredTransactions.forEach(tx => {
    const row = [
      tx.DATE || '',
      tx.ACCOUNT_HEADER || '',
      `"${(tx.DESCRIPTION || tx.NOTES || '').replace(/"/g, '""')}"`,
      tx.TYPE || '',
      tx.SINO || '',
      tx.BANK_NAME || tx.MODE || '',
      tx.INCOME || 0,
      tx.EXPENSE || 0,
      tx.BALANCE || 0,
      tx.CURRENCY || '',
      tx.STATUS || '',
      tx.TAGS ? `"${tx.TAGS.join(', ')}"` : ''
    ];
    csvContent += row.join(',') + '\n';
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast("CSV exported successfully", "success");
}

function exportToExcel() {
  if (filteredTransactions.length === 0) {
    Swal.fire({ icon: 'warning', title: 'No Data', text: 'There are no transactions to export.' });
    return;
  }
  
  // Create worksheet
  const wsData = [
    ['Date', 'Account Header', 'Description', 'Type', 'Voucher #', 'Bank Name', 'Income', 'Expense', 'Balance', 'Currency', 'Status', 'Tags'],
    ...filteredTransactions.map(tx => [
      tx.DATE || '',
      tx.ACCOUNT_HEADER || '',
      tx.DESCRIPTION || tx.NOTES || '',
      tx.TYPE || '',
      tx.SINO || '',
      tx.BANK_NAME || tx.MODE || '',
      tx.INCOME || 0,
      tx.EXPENSE || 0,
      tx.BALANCE || 0,
      tx.CURRENCY || '',
      tx.STATUS || '',
      tx.TAGS ? tx.TAGS.join(', ') : ''
    ])
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Transactions");
  
  // Generate and download
  const fileName = `transactions_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb, fileName);
  
  showToast("Excel file exported successfully", "success");
}

// Save/Load app state
function saveAppState() {
  const state = {
    currentPage: currentPage,
    dateFilter: dateFilter.value,
    typeFilter: typeFilter.value,
    bankFilter: bankFilter.value,
    categoryFilter: categoryFilter.value,
    statusFilter: statusFilter.value,
    searchDesc: searchDesc.value,
    startDate: startDateInput.value,
    endDate: endDateInput.value,
    minAmount: minAmount.value,
    maxAmount: maxAmount.value,
    tagFilter: tagFilter.value,
    sortBy: sortBy.value,
    groupBy: groupBy.value,
    balanceVisible: balanceVisible,
    theme: currentTheme
  };
  localStorage.setItem('budgetAppState', JSON.stringify(state));
}

function loadAppState() {
  const savedState = localStorage.getItem('budgetAppState');
  if (savedState) {
    const state = JSON.parse(savedState);
    currentPage = state.currentPage || 1;
    dateFilter.value = state.dateFilter || "all";
    typeFilter.value = state.typeFilter || "all";
    bankFilter.value = state.bankFilter || "all";
    categoryFilter.value = state.categoryFilter || "all";
    statusFilter.value = state.statusFilter || "all";
    searchDesc.value = state.searchDesc || "";
    startDateInput.value = state.startDate || "";
    endDateInput.value = state.endDate || "";
    minAmount.value = state.minAmount || "";
    maxAmount.value = state.maxAmount || "";
    tagFilter.value = state.tagFilter || "";
    sortBy.value = state.sortBy || "date-desc";
    groupBy.value = state.groupBy || "none";
    balanceVisible = state.balanceVisible || false;
    
    if (state.theme) {
      currentTheme = state.theme;
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
    }
    
    if (dateFilter.value === "custom") {
      customRangeControls.style.display = "flex";
    }
    updateBalanceDisplay();
    
    hasLoadedSavedState = true;
  }
}
// Multiple Selection Functions
function selectAllTransactions() {
  const pageTransactions = filteredTransactions.slice(
    (currentPage - 1) * rowsPerPage,
    currentPage * rowsPerPage
  );
  
  pageTransactions.forEach(tx => {
    selectedTransactions.add(tx.id);
  });
  
  buildTable();
  updateBulkActions();
  updateSelectedSummary();
}

function deselectAllTransactions() {
  selectedTransactions.clear();
  buildTable();
  updateBulkActions();
  updateSelectedSummary();
}

function toggleSelectAll() {
  if (selectAllCheckbox.checked) {
    selectAllTransactions();
  } else {
    deselectAllTransactions();
  }
}

function clearSelection() {
  selectedTransactions.clear();
  buildTable();
  updateBulkActions();
  updateSelectedSummary();
}

function updateBulkActions() {
  const count = selectedTransactions.size;
  selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
  
  if (count > 0) {
    bulkActions.classList.remove('hidden');
  } else {
    bulkActions.classList.add('hidden');
  }
}

function confirmBulkDelete() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkDeleteCount.textContent = count;
  confirmBulkDeleteModal.show();
}

async function processBulkDelete() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  try {
    loadingMessage.textContent = `Deleting ${count} transactions...`;
    loadingModal.show();
    
    const batch = writeBatch(db);
    Array.from(selectedTransactions).forEach(id => {
      const docRef = doc(db, "users", currentUser.uid, "transactions", id);
      batch.delete(docRef);
    });
    
    await batch.commit();
    
    loadingModal.hide();
    showToast(`${count} transaction${count !== 1 ? 's' : ''} deleted successfully`, "success");
    
    selectedTransactions.clear();
    confirmBulkDeleteModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("bulkDeleteTransactions", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transactions' });
  }
}

function openBulkEditModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkEditCount.textContent = count;
  bulkEditValue.value = "";
  bulkEditModal.show();
}

async function processBulkEdit() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  const field = bulkEditField.value;
  const value = bulkEditValue.value.trim();
  
  if (!value) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a value' });
    return;
  }
  
  try {
    loadingMessage.textContent = `Updating ${count} transactions...`;
    loadingModal.show();
    
    const batch = writeBatch(db);
    Array.from(selectedTransactions).forEach(id => {
      const docRef = doc(db, "users", currentUser.uid, "transactions", id);
      const updateData = {};
      updateData[field] = value;
      updateData.updatedAt = new Date();
      batch.update(docRef, updateData);
    });
    
    await batch.commit();
    
    loadingModal.hide();
    showToast(`${count} transaction${count !== 1 ? 's' : ''} updated successfully`, "success");
    
    selectedTransactions.clear();
    bulkEditModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("bulkEditTransactions", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update transactions' });
  }
}

function openBulkTagModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkTagCount.textContent = count;
  bulkTagsInput.value = "";
  bulkTagModal.show();
}

async function processBulkTags() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  const tagsInput = bulkTagsInput.value.trim();
  if (!tagsInput) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter at least one tag' });
    return;
  }
  
  const newTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
  
  try {
    loadingMessage.textContent = `Adding tags to ${count} transactions...`;
    loadingModal.show();
    
    // Update tags collection
    await updateTagsCollection(newTags);
    
    // Update each transaction
    const batch = writeBatch(db);
    Array.from(selectedTransactions).forEach(id => {
      const tx = allTransactions.find(t => t.id === id);
      if (tx) {
        const existingTags = tx.TAGS || [];
        const updatedTags = [...new Set([...existingTags, ...newTags])];
        
        const docRef = doc(db, "users", currentUser.uid, "transactions", id);
        batch.update(docRef, {
          TAGS: updatedTags,
          updatedAt: new Date()
        });
      }
    });
    
    await batch.commit();
    
    loadingModal.hide();
    showToast(`Tags added to ${count} transaction${count !== 1 ? 's' : ''} successfully`, "success");
    
    selectedTransactions.clear();
    bulkTagModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("bulkTagTransactions", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add tags' });
  }
}

async function updateTagsCollection(tags) {
  try {
    const tagsRef = collection(db, "users", currentUser.uid, "tags");
    const tagsSnapshot = await getDocs(tagsRef);
    const existingTags = new Set();
    
    tagsSnapshot.forEach(doc => {
      existingTags.add(doc.data().name);
    });
    
    const batch = writeBatch(db);
    tags.forEach(tag => {
      if (!existingTags.has(tag)) {
        const newTagRef = doc(tagsRef);
        batch.set(newTagRef, {
          name: tag,
          createdAt: new Date(),
          userId: currentUser.uid
        });
      }
    });
    
    if (batch._mutations.length > 0) {
      await batch.commit();
    }
  } catch (error) {
    console.warn('Error updating tags collection:', error.message);
  }
}

function openBulkCategoryModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  Swal.fire({
    title: 'Change Category',
    input: 'select',
    inputOptions: coaAccounts.reduce((options, account) => {
      options[account] = account;
      return options;
    }, {}),
    inputPlaceholder: 'Select new category',
    showCancelButton: true,
    confirmButtonText: 'Update',
    cancelButtonText: 'Cancel',
    preConfirm: (category) => {
      if (!category) {
        Swal.showValidationMessage('Please select a category');
      }
      return category;
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        loadingMessage.textContent = `Updating categories for ${count} transactions...`;
        loadingModal.show();
        
        const batch = writeBatch(db);
        Array.from(selectedTransactions).forEach(id => {
          const docRef = doc(db, "users", currentUser.uid, "transactions", id);
          batch.update(docRef, {
            ACCOUNT_HEADER: result.value,
            updatedAt: new Date()
          });
        });
        
        await batch.commit();
        
        loadingModal.hide();
        showToast(`Category updated for ${count} transaction${count !== 1 ? 's' : ''}`, "success");
        
        selectedTransactions.clear();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("bulkCategoryUpdate", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update categories' });
      }
    }
  });
}

// Split Income Functions
function openSplitIncomeModal() {
  splitIncomeAmount.value = "";
  splitIncomeDescription.value = "";
  splitIncomeBank.value = "";
  splitExpensesContainer.innerHTML = "";
  splitSummary.innerHTML = "";
  
  addSplitExpense();
  
  splitIncomeModal.show();
}

function addSplitExpense() {
  const expenseId = 'expense-' + Date.now();
  const expenseHtml = `
    <div class="split-transaction-item" id="${expenseId}">
      <div class="split-header">
        <h6>Expense</h6>
        <button type="button" class="remove-split" onclick="removeSplitExpense('${expenseId}')">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Amount</label>
          <input type="number" step="0.01" class="form-control split-amount-input" placeholder="0.00" oninput="updateSplitSummary()">
        </div>
        <div class="col-md-4">
          <label class="form-label">Description</label>
          <input type="text" class="form-control split-description-input" placeholder="Expense description">
        </div>
        <div class="col-md-4">
          <label class="form-label">Bank Account</label>
          <select class="form-select split-bank-input">
            <option value="">Select Bank</option>
            ${coaBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-12">
          <label class="form-label">Account Header</label>
          <select class="form-select split-account-input">
            <option value="">Select Account Header</option>
            ${coaAccounts.map(account => `<option value="${account}">${account}</option>`).join('')}
          </select>
        </div>
      </div>
    </div>
  `;
  
  splitExpensesContainer.insertAdjacentHTML('beforeend', expenseHtml);
  updateSplitSummary();
}

function removeSplitExpense(id) {
  const element = document.getElementById(id);
  if (element) {
    element.remove();
    updateSplitSummary();
  }
}

function updateSplitSummary() {
  const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
  const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
  
  let totalExpenses = 0;
  expenseElements.forEach(element => {
    const amountInput = element.querySelector('.split-amount-input');
    const amount = parseFloat(amountInput.value) || 0;
    totalExpenses += amount;
  });
  
  const remaining = incomeAmount - totalExpenses;
  
  let summaryHtml = '';
  if (incomeAmount > 0) {
    summaryHtml = `
      <div class="d-flex justify-content-between">
        <span>Total Income:</span>
        <span>$${incomeAmount.toFixed(2)}</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Total Expenses:</span>
        <span>$${totalExpenses.toFixed(2)}</span>
      </div>
      <div class="d-flex justify-content-between ${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">
        <span>Remaining:</span>
        <span>$${remaining.toFixed(2)}</span>
      </div>
    `;
    
    if (remaining < 0) {
      summaryHtml += `<div class="text-danger small mt-1">Warning: Expenses exceed income by $${Math.abs(remaining).toFixed(2)}</div>`;
    } else if (remaining > 0) {
      summaryHtml += `<div class="text-warning small mt-1">Note: $${remaining.toFixed(2)} of income not allocated</div>`;
    } else {
      summaryHtml += `<div class="text-success small mt-1">Perfect! All income allocated to expenses</div>`;
    }
  }
  
  splitSummary.innerHTML = summaryHtml;
}

async function saveSplitTransactions() {
  const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
  const incomeDescription = splitIncomeDescription.value.trim();
  const incomeBank = splitIncomeBank.value;
  
  if (!incomeAmount || incomeAmount <= 0) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a valid income amount' });
    return;
  }
  
  if (!incomeDescription) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter an income description' });
    return;
  }
  
  if (!incomeBank) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please select an income bank account' });
    return;
  }
  
  const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
  if (expenseElements.length === 0) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please add at least one expense' });
    return;
  }
  
  let totalExpenses = 0;
  const expenses = [];
  
  for (const element of expenseElements) {
    const amountInput = element.querySelector('.split-amount-input');
    const descriptionInput = element.querySelector('.split-description-input');
    const bankInput = element.querySelector('.split-bank-input');
    const accountInput = element.querySelector('.split-account-input');
    
    const amount = parseFloat(amountInput.value) || 0;
    const description = descriptionInput.value.trim();
    const bank = bankInput.value;
    const account = accountInput.value;
    
    if (amount <= 0) {
      Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a positive amount' });
      return;
    }
    
    if (!description) {
      Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a description' });
      return;
    }
    
    if (!bank) {
      Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a bank account selected' });
      return;
    }
    
    if (!account) {
      Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have an account header selected' });
      return;
    }
    
    totalExpenses += amount;
    expenses.push({ amount, description, bank, account });
  }
  
  const remaining = incomeAmount - totalExpenses;
  if (remaining < 0) {
    const result = await Swal.fire({
      icon: 'warning',
      title: 'Expenses Exceed Income',
      text: `Your expenses ($${totalExpenses.toFixed(2)}) exceed your income ($${incomeAmount.toFixed(2)}) by $${Math.abs(remaining).toFixed(2)}. Do you want to continue?`,
      showCancelButton: true,
      confirmButtonText: 'Yes, Continue',
      cancelButtonText: 'No, Cancel'
    });
    
    if (!result.isConfirmed) {
      return;
    }
  }
  
  try {
    loadingMessage.textContent = "Saving split transactions...";
    loadingModal.show();
    
    const today = new Date().toISOString().split('T')[0];
    const batch = writeBatch(db);
    
    // Save income transaction
    const incomeVoucher = await getNextVoucherNumber("Receipt");
    const incomeData = {
      DATE: today,
      SINO: incomeVoucher,
      ACCOUNT_HEADER: "Income",
      BANK_NAME: incomeBank,
      MODE: incomeBank,
      VOUCHER_TYPE: "Receipt",
      TYPE: "Income",
      INCOME: incomeAmount,
      EXPENSE: 0,
      BALANCE: 0,
      DESCRIPTION: incomeDescription,
      NOTES: "Split income transaction",
      TAGS: ["split-income"],
      STATUS: "completed",
      CURRENCY: "USD",
      createdAt: new Date(),
      updatedAt: new Date(),
      userId: currentUser.uid
    };
    
    const incomeRef = doc(collection(db, "users", currentUser.uid, "transactions"));
    batch.set(incomeRef, incomeData);
    
    // Save all expense transactions
    for (const expense of expenses) {
      const expenseVoucher = await getNextVoucherNumber("Payment");
      const expenseData = {
        DATE: today,
        SINO: expenseVoucher,
        ACCOUNT_HEADER: expense.account,
        BANK_NAME: expense.bank,
        MODE: expense.bank,
        VOUCHER_TYPE: "Payment",
        TYPE: "Expense",
        INCOME: 0,
        EXPENSE: expense.amount,
        BALANCE: 0,
        DESCRIPTION: expense.description,
        NOTES: "Split from income",
        TAGS: ["split-expense"],
        STATUS: "completed",
        CURRENCY: "USD",
        createdAt: new Date(),
        updatedAt: new Date(),
        userId: currentUser.uid
      };
      
      const expenseRef = doc(collection(db, "users", currentUser.uid, "transactions"));
      batch.set(expenseRef, expenseData);
    }
    
    await batch.commit();
    
    loadingModal.hide();
    showToast(`Created ${1 + expenses.length} transactions successfully`, "success");
    
    splitIncomeModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("saveSplitTransactions", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transactions' });
  }
}

// Sidebar functions
function toggleSidebar() {
  sidebar.classList.toggle('collapsed');
  mainContent.classList.toggle('expanded');
  sidebarToggle.innerHTML = sidebar.classList.contains('collapsed') ? 
    '<i class="fa fa-chevron-right"></i>' : '<i class="fa fa-chevron-left"></i>';
}

function toggleMobileMenu() {
  sidebar.classList.toggle('show');
}

// AI Assistant functions
function toggleAIPanel() {
  aiPanel.classList.toggle('show');
}

async function sendAIMessage() {
  const message = aiInput.value.trim();
  if (!message) return;
  
  // Add user message to chat
  addAIMessage(message, 'user');
  aiInput.value = '';
  
  try {
    // Simulate AI response (in a real app, this would call an AI API)
    setTimeout(() => {
      const responses = [
        "Based on your transaction history, I recommend reviewing your monthly subscriptions to identify potential savings.",
        "Your spending on dining out has increased by 15% compared to last month. Consider setting a budget for this category.",
        "I notice you have several pending transactions. Would you like me to help you categorize them?",
        "Your cash flow looks healthy this month. You've saved 20% more than your target!",
        "Consider setting up automatic transfers to your savings account to build your emergency fund faster."
      ];
      
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      addAIMessage(randomResponse, 'bot');
    }, 1000);
  } catch (error) {
    addAIMessage("I'm having trouble processing your request. Please try again later.", 'bot');
  }
}

function addAIMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `ai-message ${sender}`;
  messageDiv.textContent = text;
  aiChat.appendChild(messageDiv);
  aiChat.scrollTop = aiChat.scrollHeight;
}

// Grid View functions
let gridCurrentPage = 1;
const gridRowsPerPage = 12;

function renderGridView() {
  if (filteredTransactions.length === 0) {
    gridViewContainer.innerHTML = `
      <div class="col-12 text-center py-5">
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fa fa-exchange-alt"></i>
          </div>
          <h5>No transactions found</h5>
          <p class="text-muted">Try changing your filters or add a new transaction.</p>
          <button class="btn btn-primary mt-2" onclick="openAddModal()">
            <i class="fa fa-plus me-1"></i> Add Transaction
          </button>
        </div>
      </div>
    `;
    gridPaginationControls.innerHTML = "";
    return;
  }

  const startIndex = (gridCurrentPage - 1) * gridRowsPerPage;
  const endIndex = Math.min(startIndex + gridRowsPerPage, filteredTransactions.length);
  const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

  let html = '';
  pageTransactions.forEach(tx => {
    const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
    const income = parseFloat(tx.INCOME) || 0;
    const expense = parseFloat(tx.EXPENSE) || 0;
    const amount = income > 0 ? income : expense;
    
    let cardClass = 'grid-card';
    let typeIcon = '';
    let amountColor = '';
    
    if (tx.TYPE === 'Income') {
      cardClass += ' grid-card-income';
      typeIcon = '<i class="fa fa-arrow-up text-success"></i>';
      amountColor = 'text-success';
    } else if (tx.TYPE === 'Expense') {
      cardClass += ' grid-card-expense';
      typeIcon = '<i class="fa fa-arrow-down text-danger"></i>';
      amountColor = 'text-danger';
    } else if (tx.TYPE === 'Transfer') {
      cardClass += ' grid-card-transfer';
      typeIcon = '<i class="fa fa-exchange-alt text-info"></i>';
      amountColor = 'text-info';
    }
    
    if (tx.RECURRING) {
      cardClass += ' grid-card-recurring';
    }
    
    html += `
      <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
        <div class="${cardClass}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0" style="font-size: 14px;">${escapeHtml(tx.DESCRIPTION || tx.NOTES || "").substring(0, 50)}${(tx.DESCRIPTION || tx.NOTES || "").length > 50 ? '...' : ''}</h6>
            ${tx.RECURRING ? '<span class="badge bg-warning text-dark grid-badge">Recurring</span>' : ''}
          </div>
          <p class="card-text small text-muted mb-2">
            ${escapeHtml(tx.ACCOUNT_HEADER || "")} • ${escapeHtml(tx.BANK_NAME || tx.MODE || "")}
          </p>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold ${amountColor}" style="font-size: 16px;">
              ${typeIcon} $${amount.toFixed(2)}
            </span>
            <small class="text-muted">${date}</small>
          </div>
          ${tx.TAGS && tx.TAGS.length > 0 ? `
            <div class="mb-3">
              ${tx.TAGS.map(tag => `<span class="badge bg-secondary me-1 grid-badge">${escapeHtml(tag)}</span>`).join('')}
            </div>
          ` : ''}
          <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-sm btn-outline-primary view-tx" data-id="${tx.id}">
              <i class="fa fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-warning edit-tx" data-id="${tx.id}">
              <i class="fa fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary duplicate-tx" data-id="${tx.id}">
              <i class="fa fa-copy"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-tx" data-id="${tx.id}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  gridViewContainer.innerHTML = html;
  
  // Add event listeners for grid view buttons
  gridViewContainer.addEventListener("click", handleGridViewClick);
  
  // Build pagination for grid view
  buildGridPagination();
}

function handleGridViewClick(e) {
  const target = e.target;
  const button = target.closest("button");
  
  if (!button) return;
  
  if (button.classList.contains("view-tx")) {
    const id = button.getAttribute("data-id");
    viewTransaction(id);
  } else if (button.classList.contains("edit-tx")) {
    const id = button.getAttribute("data-id");
    editTransaction(id);
  } else if (button.classList.contains("delete-tx")) {
    const id = button.getAttribute("data-id");
    confirmDelete(id);
  } else if (button.classList.contains("duplicate-tx")) {
    const id = button.getAttribute("data-id");
    duplicateTransactionById(id);
  }
}

function buildGridPagination() {
  const totalPages = Math.ceil(filteredTransactions.length / gridRowsPerPage);
  if (totalPages <= 1) {
    gridPaginationControls.innerHTML = "";
    return;
  }

  let html = `<nav><ul class="pagination pagination-sm">`;

  html += `
    <li class="page-item ${gridCurrentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${gridCurrentPage - 1}">Previous</a>
    </li>
  `;

  const startPage = Math.max(1, gridCurrentPage - 2);
  const endPage = Math.min(totalPages, startPage + 4);

  for (let i = startPage; i <= endPage; i++) {
    html += `
      <li class="page-item ${i === gridCurrentPage ? 'active' : ''}">
        <a class="page-link" href="#" data-page="${i}">${i}</a>
      </li>
    `;
  }

  html += `
    <li class="page-item ${gridCurrentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${gridCurrentPage + 1}">Next</a>
    </li>
  `;

  gridPaginationControls.innerHTML = html;

  // Event delegation for pagination
  gridPaginationControls.addEventListener("click", function(e) {
    const link = e.target.closest(".page-link");
    if (link) {
      e.preventDefault();
      const page = parseInt(link.getAttribute("data-page"));
      if (page && page !== gridCurrentPage && page > 0 && page <= totalPages) {
        gridCurrentPage = page;
        renderGridView();
      }
    }
  });
}

// Calendar View functions
function renderCalendarView() {
  const now = new Date();
  const year = currentCalendarYear;
  const month = currentCalendarMonth;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  
  // Get transactions for the current month
  const monthTransactions = filteredTransactions.filter(tx => {
    try {
      if (!tx.DATE) return false;
      const txDate = new Date(tx.DATE);
      return txDate.getMonth() === month && txDate.getFullYear() === year;
    } catch (e) {
      return false;
    }
  });
  
  // Group transactions by date
  const transactionsByDate = {};
  monthTransactions.forEach(tx => {
    try {
      const date = new Date(tx.DATE);
      const dateStr = date.toISOString().split('T')[0];
      if (!transactionsByDate[dateStr]) {
        transactionsByDate[dateStr] = [];
      }
      transactionsByDate[dateStr].push(tx);
    } catch (e) {
      // Skip invalid dates
    }
  });
  
  let html = `
    <div class="calendar">
      <div class="calendar-header">
        <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">
          <i class="fa fa-chevron-left"></i>
        </button>
        <h5 class="mb-0">${firstDay.toLocaleString('default', { month: 'long', year: 'numeric' })}</h5>
        <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar-grid">
        <div class="calendar-day-header">Sun</div>
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>
  `;
  
  // Empty cells for days before the first day of the month
  const startDay = firstDay.getDay();
  for (let i = 0; i < startDay; i++) {
    html += '<div class="calendar-day empty"></div>';
  }
  
  // Days of the month
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    const dayTransactions = transactionsByDate[dateStr] || [];
    
    const totalIncome = dayTransactions
      .filter(tx => tx.TYPE === 'Income')
      .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      
    const totalExpense = dayTransactions
      .filter(tx => tx.TYPE === 'Expense')
      .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
    let transactionsHtml = '';
    if (dayTransactions.length > 0) {
      // Show up to 2 transactions per day in calendar
      const displayTransactions = dayTransactions.slice(0, 2);
      displayTransactions.forEach(tx => {
        const amount = tx.INCOME > 0 ? tx.INCOME : tx.EXPENSE;
        const isIncome = tx.TYPE === 'Income';
        transactionsHtml += `
          <div class="calendar-transaction ${isIncome ? 'calendar-transaction-income' : 'calendar-transaction-expense'}">
            ${isIncome ? '+' : '-'}$${amount.toFixed(0)}
          </div>
        `;
      });
      
      if (dayTransactions.length > 2) {
        transactionsHtml += `<div class="calendar-transaction text-muted">+${dayTransactions.length - 2} more</div>`;
      }
    }
    
    html += `
      <div class="calendar-day ${dayTransactions.length > 0 ? 'has-transactions' : ''}" 
           onclick="showDayTransactions('${dateStr}')">
        <div class="calendar-day-number">${day}</div>
        <div class="calendar-day-transactions">
          ${transactionsHtml}
        </div>
        ${dayTransactions.length > 0 ? `
          <div class="small text-muted mt-1">
            <span class="text-success">+$${totalIncome.toFixed(0)}</span>
            <span class="text-danger"> -$${totalExpense.toFixed(0)}</span>
          </div>
        ` : ''}
      </div>
    `;
  }
  
  // Empty cells for days after the last day of the month
  const endDay = lastDay.getDay();
  for (let i = endDay + 1; i < 7; i++) {
    html += '<div class="calendar-day empty"></div>';
  }
  
  html += `
      </div>
    </div>
  `;
  
  calendarContainer.innerHTML = html;
}

function changeCalendarMonth(delta) {
  currentCalendarMonth += delta;
  
  // Handle year rollover
  if (currentCalendarMonth < 0) {
    currentCalendarMonth = 11;
    currentCalendarYear--;
  } else if (currentCalendarMonth > 11) {
    currentCalendarMonth = 0;
    currentCalendarYear++;
  }
  
  renderCalendarView();
}

function showDayTransactions(dateStr) {
  const dayTransactions = filteredTransactions.filter(tx => tx.DATE === dateStr);
  
  if (dayTransactions.length === 0) return;
  
  const date = new Date(dateStr);
  const formattedDate = date.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  const totalIncome = dayTransactions
    .filter(tx => tx.TYPE === 'Income')
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const totalExpense = dayTransactions
    .filter(tx => tx.TYPE === 'Expense')
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  
  let transactionsHtml = dayTransactions.map(tx => {
    const amount = tx.INCOME > 0 ? tx.INCOME : tx.EXPENSE;
    const isIncome = tx.TYPE === 'Income';
    const badgeClass = isIncome ? 'badge-income' : 'badge-expense';
    
    return `
      <div class="card mb-2">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div style="flex: 1;">
              <strong>${escapeHtml(tx.DESCRIPTION || tx.NOTES || "")}</strong>
              <div class="small text-muted">
                ${escapeHtml(tx.ACCOUNT_HEADER || "")} • ${escapeHtml(tx.BANK_NAME || tx.MODE || "")}
                ${tx.TAGS && tx.TAGS.length > 0 ? `• ${tx.TAGS.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')}` : ''}
              </div>
            </div>
            <div class="text-end ms-3">
              <span class="${isIncome ? 'text-success' : 'text-danger'} fw-bold">
                ${isIncome ? '+' : '-'}$${amount.toFixed(2)}
              </span>
              <div class="small mt-1">
                <span class="badge ${badgeClass}">${tx.TYPE}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  Swal.fire({
    title: `Transactions for ${formattedDate}`,
    html: `
      <div class="mb-3">
        <div class="row">
          <div class="col-6">
            <div class="text-success">
              <strong>Total Income:</strong>
              <div>$${totalIncome.toFixed(2)}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="text-danger">
              <strong>Total Expense:</strong>
              <div>$${totalExpense.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        ${transactionsHtml}
      </div>
    `,
    width: 700,
    showCloseButton: true
  });
}

// Dynamic tips
const tips = [
  "Try using the Quick Add feature to add transactions in natural language.",
  "Use tags to categorize transactions for better reporting.",
  "Set up recurring transactions for regular bills and income.",
  "Export your data regularly for backup purposes.",
  "Use the AI assistant for financial insights and recommendations.",
  "Try different view modes (List, Grid, Calendar) to visualize your transactions differently.",
  "Use the split income feature to allocate income to multiple expense categories.",
  "Take advantage of bulk actions to manage multiple transactions at once."
];

let currentTipIndex = 0;

function showNextTip() {
  currentTipIndex = (currentTipIndex + 1) % tips.length;
  dynamicTip.textContent = tips[currentTipIndex];
}

// Last sync time
function updateLastSync() {
  const now = new Date();
  lastSync.textContent = `Last sync: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
}

function startPeriodicSync() {
  // Update sync time every minute
  setInterval(updateLastSync, 60000);
  
  // Auto-sync every 5 minutes
  setInterval(async () => {
    try {
      await loadTransactions();
      showToast("Data synced automatically", "info");
    } catch (error) {
      console.warn("Auto-sync failed:", error);
    }
  }, 300000);
}

// Filter presets
async function saveFilterPreset() {
  const { value: name } = await Swal.fire({
    title: 'Save Filter Preset',
    input: 'text',
    inputLabel: 'Enter a name for this filter preset',
    showCancelButton: true,
    confirmButtonText: 'Save',
    cancelButtonText: 'Cancel'
  });
  
  if (name) {
    try {
      const presetData = {
        name,
        dateFilter: dateFilter.value,
        typeFilter: typeFilter.value,
        bankFilter: bankFilter.value,
        categoryFilter: categoryFilter.value,
        statusFilter: statusFilter.value,
        searchDesc: searchDesc.value,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        minAmount: minAmount.value,
        maxAmount: maxAmount.value,
        tagFilter: tagFilter.value,
        sortBy: sortBy.value,
        groupBy: groupBy.value,
        createdAt: new Date(),
        userId: currentUser.uid
      };
      
      await addDoc(collection(db, "users", currentUser.uid, "filterPresets"), presetData);
      showToast("Filter preset saved successfully", "success");
    } catch (error) {
      console.error("Error saving filter preset:", error);
      showToast("Failed to save filter preset", "error");
    }
  }
}

// Tag manager
async function addNewTag() {
  const tagInput = document.getElementById('newTagInput');
  const tagName = tagInput.value.trim();
  
  if (!tagName) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a tag name' });
    return;
  }
  
  try {
    const tagRef = doc(collection(db, "users", currentUser.uid, "tags"));
    await setDoc(tagRef, {
      name: tagName,
      createdAt: new Date(),
      userId: currentUser.uid
    });
    
    tagInput.value = '';
    await loadTags();
    showToast("Tag added successfully", "success");
  } catch (error) {
    console.error("Error adding tag:", error);
    showToast("Failed to add tag", "error");
  }
}

// Duplicate transaction
function duplicateTransaction() {
  if (!txIdInput.value) return;
  
  // Clear the ID to create a new transaction
  txIdInput.value = "";
  formSINO.value = "";
  document.getElementById("transactionModalLabel").textContent = "Duplicate Transaction";
  duplicateTransactionBtn.style.display = "none";
  makeRecurringBtn.style.display = "inline-block";
}

function duplicateTransactionById(id) {
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  editTransaction(id);
  duplicateTransaction(); // This will clear the ID and prepare for duplication
}

// Recurring transactions
function toggleRecurringOptions() {
  recurringOptions.style.display = recurringOptions.style.display === "none" ? "block" : "none";
}

function calculateNextRecurringDate(startDate, recurringConfig) {
  const date = new Date(startDate);
  const { frequency, interval } = recurringConfig;
  
  switch (frequency) {
    case 'daily':
      date.setDate(date.getDate() + interval);
      break;
    case 'weekly':
      date.setDate(date.getDate() + (interval * 7));
      break;
    case 'monthly':
      date.setMonth(date.getMonth() + interval);
      break;
    case 'quarterly':
      date.setMonth(date.getMonth() + (interval * 3));
      break;
    case 'yearly':
      date.setFullYear(date.getFullYear() + interval);
      break;
  }
  
  return date.toISOString().split('T')[0];
}

function showRecurringTransactions() {
  if (recurringTransactions.length === 0) {
    Swal.fire({ icon: 'info', title: 'No Recurring Transactions', text: 'You don\'t have any recurring transactions set up.' });
    return;
  }
  
  let html = `
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Description</th>
            <th>Frequency</th>
            <th>Next Date</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  recurringTransactions.forEach(tx => {
    const amount = tx.INCOME > 0 ? tx.INCOME : tx.EXPENSE;
    const nextDate = tx.RECURRING && tx.RECURRING.nextDate ? tx.RECURRING.nextDate : 
                    calculateNextRecurringDate(tx.DATE, tx.RECURRING || { frequency: 'monthly', interval: 1 });
    
    html += `
      <tr>
        <td>${escapeHtml(tx.DESCRIPTION || '')}</td>
        <td>${tx.RECURRING ? `${tx.RECURRING.frequency} (every ${tx.RECURRING.interval})` : 'Monthly'}</td>
        <td>${nextDate}</td>
        <td class="${tx.TYPE === 'Income' ? 'text-success' : 'text-danger'}">
          $${parseFloat(amount).toFixed(2)}
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${tx.id}')">
            <i class="fa fa-edit"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  Swal.fire({
    title: 'Recurring Transactions',
    html: html,
    width: 800,
    showCloseButton: true
  });
}

// Dashboard functions
function showIncomeDetails() {
  const incomeTransactions = allTransactions.filter(tx => tx.TYPE === 'Income');
  const totalIncome = incomeTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
  const avgIncome = incomeTransactions.length > 0 ? totalIncome / incomeTransactions.length : 0;
  
  Swal.fire({
    title: 'Income Details',
    html: `
      <div class="text-center">
        <h1 class="text-success">$${totalIncome.toFixed(2)}</h1>
        <p>Total Income from ${incomeTransactions.length} transactions</p>
        <p>Average: $${avgIncome.toFixed(2)} per transaction</p>
        <hr>
        <div class="text-start">
          <h6>Top Income Sources:</h6>
          ${getTopCategories(incomeTransactions, 5)}
        </div>
      </div>
    `,
    width: 500
  });
}

function showExpenseDetails() {
  const expenseTransactions = allTransactions.filter(tx => tx.TYPE === 'Expense');
  const totalExpense = expenseTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  const avgExpense = expenseTransactions.length > 0 ? totalExpense / expenseTransactions.length : 0;
  
  Swal.fire({
    title: 'Expense Details',
    html: `
      <div class="text-center">
        <h1 class="text-danger">$${totalExpense.toFixed(2)}</h1>
        <p>Total Expenses from ${expenseTransactions.length} transactions</p>
        <p>Average: $${avgExpense.toFixed(2)} per transaction</p>
        <hr>
        <div class="text-start">
          <h6>Top Expense Categories:</h6>
          ${getTopCategories(expenseTransactions, 5)}
        </div>
      </div>
    `,
    width: 500
  });
}

function getTopCategories(transactions, limit = 5) {
  const categories = {};
  
  transactions.forEach(tx => {
    const category = tx.ACCOUNT_HEADER || 'Uncategorized';
    const amount = parseFloat(tx.INCOME) || parseFloat(tx.EXPENSE) || 0;
    
    if (!categories[category]) {
      categories[category] = 0;
    }
    categories[category] += amount;
  });
  
  const sortedCategories = Object.entries(categories)
    .sort((a, b) => b[1] - a[1])
    .slice(0, limit);
  
  return sortedCategories.map(([category, amount]) => `
    <div class="d-flex justify-content-between mb-1">
      <span>${escapeHtml(category)}</span>
      <span>$${amount.toFixed(2)}</span>
    </div>
  `).join('');
}

function showTransactionStats() {
  const totalTransactions = allTransactions.length;
  const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
  const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
  const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
  
  const incomePercentage = totalTransactions > 0 ? (incomeCount / totalTransactions * 100).toFixed(1) : 0;
  const expensePercentage = totalTransactions > 0 ? (expenseCount / totalTransactions * 100).toFixed(1) : 0;
  const transferPercentage = totalTransactions > 0 ? (transferCount / totalTransactions * 100).toFixed(1) : 0;
  
  Swal.fire({
    title: 'Transaction Statistics',
    html: `
      <div class="text-center">
        <h1>${totalTransactions}</h1>
        <p>Total Transactions</p>
        <div class="row mt-3">
          <div class="col-4">
            <div class="text-success">
              <h3>${incomeCount}</h3>
              <small>Income (${incomePercentage}%)</small>
            </div>
          </div>
          <div class="col-4">
            <div class="text-danger">
              <h3>${expenseCount}</h3>
              <small>Expense (${expensePercentage}%)</small>
            </div>
          </div>
          <div class="col-4">
            <div class="text-info">
              <h3>${transferCount}</h3>
              <small>Transfer (${transferPercentage}%)</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="text-start">
          <h6>Transaction Timeline:</h6>
          <div class="small">
            <div>Oldest: ${getOldestTransactionDate()}</div>
            <div>Newest: ${getNewestTransactionDate()}</div>
            <div>Time Span: ${getTransactionTimeSpan()} days</div>
          </div>
        </div>
      </div>
    `,
    width: 600
  });
}

function getOldestTransactionDate() {
  if (allTransactions.length === 0) return 'N/A';
  const dates = allTransactions.map(tx => new Date(tx.DATE)).filter(date => !isNaN(date.getTime()));
  if (dates.length === 0) return 'N/A';
  const oldest = new Date(Math.min(...dates));
  return oldest.toLocaleDateString();
}

function getNewestTransactionDate() {
  if (allTransactions.length === 0) return 'N/A';
  const dates = allTransactions.map(tx => new Date(tx.DATE)).filter(date => !isNaN(date.getTime()));
  if (dates.length === 0) return 'N/A';
  const newest = new Date(Math.max(...dates));
  return newest.toLocaleDateString();
}

function getTransactionTimeSpan() {
  if (allTransactions.length === 0) return 0;
  const dates = allTransactions.map(tx => new Date(tx.DATE)).filter(date => !isNaN(date.getTime()));
  if (dates.length < 2) return 0;
  const oldest = new Date(Math.min(...dates));
  const newest = new Date(Math.max(...dates));
  const diffTime = Math.abs(newest - oldest);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

function showCashflowChart() {
  // Show detailed cash flow analysis
  const now = new Date();
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
  
  const monthlyCashflow = {};
  for (let i = 0; i < 6; i++) {
    const date = new Date();
    date.setMonth(date.getMonth() - i);
    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
    monthlyCashflow[monthYear] = { income: 0, expense: 0, cashflow: 0 };
  }
  
  allTransactions.forEach(tx => {
    if (tx.DATE) {
      try {
        const txDate = new Date(tx.DATE);
        if (txDate >= sixMonthsAgo) {
          const monthYear = `${txDate.getFullYear()}-${(txDate.getMonth() + 1).toString().padStart(2, '0')}`;
          if (monthlyCashflow[monthYear]) {
            if (tx.TYPE === 'Income') {
              monthlyCashflow[monthYear].income += (parseFloat(tx.INCOME) || 0);
            } else if (tx.TYPE === 'Expense') {
              monthlyCashflow[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
            }
            monthlyCashflow[monthYear].cashflow = monthlyCashflow[monthYear].income - monthlyCashflow[monthYear].expense;
          }
        }
      } catch (e) {
        // Skip invalid dates
      }
    }
  });
  
  const sortedMonths = Object.keys(monthlyCashflow).sort();
  const cashflowData = sortedMonths.map(month => monthlyCashflow[month].cashflow);
  
  const monthLabels = sortedMonths.map(month => {
    const [year, monthNum] = month.split('-');
    const date = new Date(year, monthNum - 1);
    return date.toLocaleString('default', { month: 'short', year: '2-digit' });
  });
  
  Swal.fire({
    title: 'Cash Flow Analysis (Last 6 Months)',
    html: `
      <div style="height: 300px;">
        <canvas id="cashflowChart"></canvas>
      </div>
      <div class="mt-3">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Month</th>
              <th>Income</th>
              <th>Expense</th>
              <th>Cash Flow</th>
            </tr>
          </thead>
          <tbody>
            ${sortedMonths.map(month => {
              const data = monthlyCashflow[month];
              const cashflowClass = data.cashflow >= 0 ? 'text-success' : 'text-danger';
              return `
                <tr>
                  <td>${monthLabels[sortedMonths.indexOf(month)]}</td>
                  <td class="text-success">$${data.income.toFixed(2)}</td>
                  <td class="text-danger">$${data.expense.toFixed(2)}</td>
                  <td class="${cashflowClass}">$${data.cashflow.toFixed(2)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `,
    width: 800,
    didOpen: () => {
      const ctx = document.getElementById('cashflowChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Cash Flow',
            data: cashflowData,
            borderColor: 'rgb(111, 66, 193)',
            backgroundColor: 'rgba(111, 66, 193, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Cash Flow: $' + context.raw.toFixed(2);
                }
              }
            }
          }
        }
      });
    }
  });
}

// Make functions available globally for inline event handlers
window.removeSplitExpense = removeSplitExpense;
window.updateSplitSummary = updateSplitSummary;
window.removeTagFromInput = removeTagFromInput;
window.removeTagFromTransaction = removeTagFromTransaction;
window.toggleBalanceVisibility = toggleBalanceVisibility;
window.showIncomeDetails = showIncomeDetails;
window.showExpenseDetails = showExpenseDetails;
window.showTransactionStats = showTransactionStats;
window.showCashflowChart = showCashflowChart;
window.showRecurringTransactions = showRecurringTransactions;
window.showNextTip = showNextTip;
window.addNewTag = addNewTag;
window.changeCalendarMonth = changeCalendarMonth;
window.showDayTransactions = showDayTransactions;
window.duplicateTransactionById = duplicateTransactionById;
window.editTransaction = editTransaction;
window.toggleAIPanel = toggleAIPanel;
window.sendAIMessage = sendAIMessage;

// Initialize add split expense button
addSplitExpenseBtn.addEventListener("click", addSplitExpense);
saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Set current date for date inputs
  const today = new Date().toISOString().split('T')[0];
  formDATE.value = today;
  startDateInput.value = today;
  endDateInput.value = today;
  
  // Initialize Flatpickr for date range
  if (typeof flatpickr !== 'undefined') {
    flatpickr("#startDate", {
      dateFormat: "Y-m-d",
      defaultDate: today
    });
    
    flatpickr("#endDate", {
      dateFormat: "Y-m-d",
      defaultDate: today
    });
  }
});

// Bootstrap JS for modals
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>