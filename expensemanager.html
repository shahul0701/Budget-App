<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager Pro</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Cloudinary Widget CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@uploadcare/uploader@3.19.0/uploader.css" />

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Main content */
    .main-content {
      min-height: 100vh;
    }

    .page {
      max-width:1400px;
      margin:20px auto;
      padding:20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-trend { font-size:12px; display: flex; align-items: center; gap: 4px; margin-top: 5px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }
    .transactions-table tbody tr:hover td { background-color: rgba(111, 66, 193, 0.05); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.1); }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-recurring { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; right:30px; bottom:30px; width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(70,34,173,0.2); z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }

    /* responsive */
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: flex-end; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { width: 100%; min-width: unset; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      flex: 1;
      min-width: 200px;
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .quick-stat:hover {
      transform: translateY(-2px);
      background: var(--card-bg);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Tag system */
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .tag {
      background: var(--purple-1);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag-remove {
      background: none;
      border: none;
      color: white;
      padding: 0;
      cursor: pointer;
      font-size: 10px;
    }

    /* Search highlight */
    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
    }
    .nav-tabs .nav-link {
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
    }
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
    }

    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--purple-1);
    }

    /* Cloudinary specific styles */
    .cloudinary-thumbnail {
      max-width: 100px;
      max-height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* AI Assistant */
    .ai-assistant {
      position: fixed;
      bottom: 100px;
      right: 30px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(70,34,173,0.3);
      z-index: 1100;
      transition: all 0.3s;
    }
    .ai-assistant:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(70,34,173,0.4);
    }
    .ai-panel {
      position: fixed;
      bottom: 170px;
      right: 30px;
      width: 350px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1099;
      display: none;
    }
    .ai-panel.show {
      display: block;
    }
    .ai-header {
      padding: 15px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-body {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .ai-message.user {
      background: rgba(111, 66, 193, 0.1);
      margin-left: 40px;
    }
    .ai-message.bot {
      background: var(--bg-primary);
      margin-right: 40px;
    }
    .ai-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <!-- Loading Backdrop -->
  <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p id="backdropMessage">Loading...</p>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="page">
      <div class="nav-buttons">
        <button id="homeBtn" class="btn btn-outline-secondary">
          <i class="fa fa-home me-1"></i> Home
        </button>
        <div class="export-buttons">
          <button id="exportCSV" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-csv me-1"></i> CSV
          </button>
          <button id="exportPDF" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-file-pdf me-1"></i> PDF
          </button>
        </div>
      </div>
      
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager Pro</h2>
          <div class="header-actions">
            <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
            <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
            <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
            <button id="tagManagerBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-tags me-1"></i> Tags</button>
            <button id="themeToggle" class="theme-toggle">
              <i class="fa fa-moon"></i>
            </button>
            <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
            <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
              <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
              <div style="color:white; font-weight:600;" id="username">User</div>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>

        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card" onclick="showIncomeDetails()">
            <div class="stat-label">Total Income</div>
            <div id="statIncome" class="stat-value income-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-up text-success"></i> <span id="incomeTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="showExpenseDetails()">
            <div class="stat-label">Total Expenses</div>
            <div id="statExpense" class="stat-value expense-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-down text-danger"></i> <span id="expenseTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="toggleBalanceVisibility()">
            <div class="stat-label">Current Balance</div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">
              <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          <div class="stat-card" onclick="showTransactionStats()">
            <div class="stat-label">Transactions</div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card" onclick="showCashflowChart()">
            <div class="stat-label">Cash Flow</div>
            <div id="statCashflow" class="stat-value">$0.00</div>
            <div class="small-muted">Monthly average</div>
          </div>
        </div>
        
        <!-- Quick stats -->
        <div class="quick-stats" id="quickStats"></div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart"></div>
        
        <!-- info banner -->
        <div class="info-banner">
          <i class="fa fa-info-circle me-2"></i> 
          <span id="dynamicTip">Manage your transactions, view attachments, and track your finances in one place.</span>
          <button class="btn btn-sm btn-outline-primary ms-3" onclick="showNextTip()">Next Tip</button>
          <span class="float-end" id="lastSync"></span>
        </div>
        
        <div class="content-body">
          <!-- Bank balances -->
          <div id="bankBalances" class="bank-balances"></div>
          
          <!-- filters -->
          <div class="filters mb-2">
            <select id="dateFilter" class="form-select form-select-sm">
              <option value="all">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
              <option value="custom">Custom Range</option>
              <option value="last7">Last 7 Days</option>
              <option value="last30">Last 30 Days</option>
            </select>

            <div id="customRangeControls" style="display:none; display:flex; gap:8px;">
              <input id="startDate" type="date" class="form-control form-control-sm" />
              <input id="endDate" type="date" class="form-control form-control-sm" />
            </div>

            <select id="typeFilter" class="form-select form-select-sm">
              <option value="all">All Types</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
            </select>

            <!-- Bank Filter -->
            <select id="bankFilter" class="form-select form-select-sm">
              <option value="all">All Banks</option>
            </select>

            <!-- Category Filter -->
            <select id="categoryFilter" class="form-select form-select-sm">
              <option value="all">All Categories</option>
            </select>

            <select id="statusFilter" class="form-select form-select-sm">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>

            <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes, tags..." />

            <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
            <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
            <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
            <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
          </div>

          <!-- transactions table -->
          <div class="transactions-table">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th style="width:40px;">
                    <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                  </th>
                  <th style="width:110px;">Date</th>
                  <th style="width:120px; text-align:right;">Account Header</th>
                  <th>Description</th>
                  <th style="width:120px;">Type</th>
                  <th style="width:110px;">Voucher #</th>
                  <th style="width:120px;">Bank Name</th>
                  <th style="width:120px; text-align:right;">Income</th>
                  <th style="width:120px; text-align:right;">Expense</th>
                  <th style="width:120px;">Balance</th>
                  <th style="width:120px;">Tags</th>
                  <th style="width:120px;">Attachment</th>
                  <th style="width:130px;">Actions</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody">
                <tr><td colspan="13" class="text-center text-muted py-4">No transactions loaded.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- pagination -->
          <div class="pagination-wrap mt-3" id="paginationControls"></div>
          
          <!-- Summary footer -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Selected Summary</h6>
                  <div id="selectedSummary">No transactions selected</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Filter Summary</h6>
                  <div id="filterSummary">Showing all transactions</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="ai-assistant" id="aiAssistant">
    <i class="fa fa-robot"></i>
  </div>
  <div class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <span>Finance Assistant</span>
      <button class="btn btn-sm btn-light" onclick="toggleAIPanel()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="ai-body" id="aiChat">
      <div class="ai-message bot">
        Hi! I'm your finance assistant. Ask me about your transactions, balances, or financial insights!
      </div>
    </div>
    <div class="ai-input">
      <input type="text" class="form-control" id="aiInput" placeholder="Ask about your transactions..." />
      <button class="btn btn-primary" onclick="sendAIMessage()">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- floating add button -->
  <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>

  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date *</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # *</label>
                <input id="formSINO" type="text" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header *</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Account Header</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type *</label>
                <select id="formVOUCHERTYPE" class="form-select" required>
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type *</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name *</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency *</label>
                <select id="formCURRENCY" class="form-select" required>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="INR">INR (₹)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description *</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description" required></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes"></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input id="formTAGS" type="text" class="form-control" placeholder="Enter tags (comma separated)" />
                <div class="tag-container mt-2" id="tagsPreview"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.csv" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction in natural language:</label>
            <textarea id="quickAddInput" class="form-control" rows="3" placeholder="Examples:&#10;• Add 500 to cash&#10;• Spent 200 on petrol from SBI&#10;• Received 1000 payment from client in AXIS&#10;• Transfer 500 from SBI to HDFC"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="processQuickAddBtn" class="btn btn-primary">Process</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Multiple Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Income Amount to Split</label>
            <input id="splitIncomeAmount" type="number" step="0.01" class="form-control" placeholder="Enter total income amount" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Description</label>
            <input id="splitIncomeDescription" type="text" class="form-control" placeholder="Description for the income transaction" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Bank Account</label>
            <select id="splitIncomeBank" class="form-select">
              <option value="">Select Bank</option>
            </select>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Expense Transactions</h6>
            <button type="button" id="addSplitExpenseBtn" class="btn btn-sm btn-primary">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div id="splitExpensesContainer"></div>
          
          <div id="splitSummary" class="split-summary"></div>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="saveSplitTransactionsBtn" class="btn btn-primary">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete this transaction?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirm -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete <span id="bulkDeleteCount">0</span> selected transactions?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkDeleteBtn" class="btn btn-danger">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // state
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let txToDelete = null;
    let balanceVisible = false;
    let isSubmitting = false;
    let lastVoucherNumber = 0;
    let currentTheme = 'light';
    let selectedTransactions = new Set();
    let allTags = new Set();
    
    // COA data
    let coaAccounts = ['Rent', 'AXIS', 'Amount Tally', 'Meals & Entertainment', 'BOM', 'Fuel', 'Shopping', 'Miscellaneous'];
    let coaBanks = ['AXIS', 'BOM', 'Cash'];
    
    // Chart instance
    let mainChart = null;

    // DOM refs
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const newTxBtn = document.getElementById("newTxBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const splitIncomeBtn = document.getElementById("splitIncomeBtn");
    const floatingAdd = document.getElementById("floatingAdd");
    const balanceToggle = document.getElementById("balanceToggle");
    const homeBtn = document.getElementById("homeBtn");
    const tagManagerBtn = document.getElementById("tagManagerBtn");
    const themeToggle = document.getElementById("themeToggle");
    const exportCSV = document.getElementById("exportCSV");
    const exportPDF = document.getElementById("exportPDF");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const bulkActions = document.getElementById("bulkActions");
    const selectedCount = document.getElementById("selectedCount");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkEditBtn = document.getElementById("bulkEditBtn");
    const bulkTagBtn = document.getElementById("bulkTagBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const splitIncomeModalEl = document.getElementById("splitIncomeModal");
    const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
    const splitIncomeAmount = document.getElementById("splitIncomeAmount");
    const splitIncomeDescription = document.getElementById("splitIncomeDescription");
    const splitIncomeBank = document.getElementById("splitIncomeBank");
    const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
    const splitExpensesContainer = document.getElementById("splitExpensesContainer");
    const splitSummary = document.getElementById("splitSummary");
    const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
    const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
    const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
    const bulkDeleteCount = document.getElementById("bulkDeleteCount");
    const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
    const aiAssistant = document.getElementById("aiAssistant");
    const aiPanel = document.getElementById("aiPanel");
    const aiChat = document.getElementById("aiChat");
    const aiInput = document.getElementById("aiInput");
    const selectedSummary = document.getElementById("selectedSummary");
    const filterSummary = document.getElementById("filterSummary");
    const dynamicTip = document.getElementById("dynamicTip");
    const lastSync = document.getElementById("lastSync");

    // Other DOM refs
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const searchDesc = document.getElementById("searchDesc");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const transactionsTableBody = document.getElementById("transactionsTableBody");
    const paginationControls = document.getElementById("paginationControls");
    const bankBalancesContainer = document.getElementById("bankBalances");
    const quickStatsContainer = document.getElementById("quickStats");
    const transactionsChart = document.getElementById("transactionsChart");

    // Modal refs
    const transactionModalEl = document.getElementById("transactionModal");
    const transactionModal = new bootstrap.Modal(transactionModalEl);
    const quickAddModalEl = document.getElementById("quickAddModal");
    const quickAddModal = new bootstrap.Modal(quickAddModalEl);
    const form = document.getElementById("transactionForm");
    const txIdInput = document.getElementById("txId");
    const formDATE = document.getElementById("formDATE");
    const formSINO = document.getElementById("formSINO");
    const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
    const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
    const formTYPE = document.getElementById("formTYPE");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formNOTES = document.getElementById("formNOTES");
    const formTAGS = document.getElementById("formTAGS");
    const formSTATUS = document.getElementById("formSTATUS");
    const formCURRENCY = document.getElementById("formCURRENCY");
    const tagsPreview = document.getElementById("tagsPreview");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentInfo = document.getElementById("attachmentInfo");
    const saveTransactionBtn = document.getElementById("saveTransactionBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadProgressBar = document.getElementById("uploadProgressBar");
    const quickAddInput = document.getElementById("quickAddInput");
    const processQuickAddBtn = document.getElementById("processQuickAddBtn");

    const confirmDeleteModalEl = document.getElementById("confirmDeleteModal");
    const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    // stats
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");
    const statCashflow = document.getElementById("statCashflow");
    const incomeTrend = document.getElementById("incomeTrend");
    const expenseTrend = document.getElementById("expenseTrend");

    // Helper functions
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} 
            text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      const container = document.getElementById("toastContainer");
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Auth handling
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your transactions...");
        
        try {
          // Load theme preference
          loadThemePreference();
          
          // Load data
          populateCOADropdowns();
          await loadTransactions();
          await loadTags();
          
          applyFilters();
          updateLastSync();
          
          hideLoading();
          showToast("Welcome back!", "success");
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          showToast("Failed to load data. Please refresh the page.", "error");
        }
      } else {
        // not logged in
        Swal.fire({ 
          icon: 'info', 
          title: 'Please login', 
          text: 'You will be redirected to login.' 
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Event listeners
    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem('budgetAppState');
      await signOut(auth);
      window.location.href = "index.html";
    });

    newTxBtn.addEventListener("click", () => openAddModal());
    floatingAdd.addEventListener("click", () => openAddModal());
    
    balanceToggle.addEventListener("click", () => {
      toggleBalanceVisibility();
    });

    dateFilter.addEventListener("change", () => {
      if (dateFilter.value === "custom") customRangeControls.style.display = "flex";
      else customRangeControls.style.display = "none";
    });

    applyFiltersBtn.addEventListener("click", () => { applyFilters(); });
    resetFiltersBtn.addEventListener("click", () => {
      dateFilter.value = "all";
      typeFilter.value = "all";
      bankFilter.value = "all";
      searchDesc.value = "";
      startDateInput.value = "";
      endDateInput.value = "";
      customRangeControls.style.display = "none";
      applyFilters();
    });

    // Navigation button handlers
    homeBtn.addEventListener("click", () => window.location.href = "home.html");
    tagManagerBtn.addEventListener("click", () => showTagManager());

    // Theme toggle
    themeToggle.addEventListener("click", () => toggleTheme());

    // Export buttons
    exportCSV.addEventListener("click", () => exportToCSV());
    exportPDF.addEventListener("click", () => exportToPDF());

    // Quick Add button
    quickAddBtn.addEventListener("click", () => {
      quickAddInput.value = "";
      quickAddModal.show();
    });
    processQuickAddBtn.addEventListener("click", processQuickAdd);

    // Split Income button
    splitIncomeBtn.addEventListener("click", () => openSplitIncomeModal());

    // Bulk action buttons
    selectAllBtn.addEventListener("click", selectAllTransactions);
    deselectAllBtn.addEventListener("click", deselectAllTransactions);
    selectAllCheckbox.addEventListener("change", toggleSelectAll);
    bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
    bulkEditBtn.addEventListener("click", openBulkEditModal);
    bulkTagBtn.addEventListener("click", openBulkTagModal);
    clearSelectionBtn.addEventListener("click", clearSelection);
    confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
    addSplitExpenseBtn.addEventListener("click", addSplitExpense);
    saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);

    // AI Assistant
    aiAssistant.addEventListener("click", toggleAIPanel);
    aiInput.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') sendAIMessage();
    });

    // Form inputs
    formTAGS.addEventListener("input", updateTagsPreview);
    formTYPE.addEventListener("change", updateFormFields);
    
    // File upload
    formATTACHFILE.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        Swal.fire({ icon: 'error', title: 'File too large', text: 'Please select a file smaller than 10MB' });
        this.value = '';
        return;
      }

      try {
        uploadProgress.style.display = "block";
        uploadProgressBar.style.width = "0%";
        
        // Create a unique filename
        const fileName = `${Date.now()}_${file.name}`;
        const storageRef = ref(storage, `users/${currentUser.uid}/attachments/${fileName}`);
        
        // Upload file to Firebase Storage
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        
        uploadProgressBar.style.width = "100%";
        
        setTimeout(() => {
          formATTACH.value = downloadURL;
          attachmentInfo.textContent = "Uploaded: " + file.name;
          
          if (file.type.startsWith('image/')) {
            attachmentPreview.src = URL.createObjectURL(file);
            attachmentPreview.style.display = "block";
            attachmentPreview.className = "attachment-preview";
          } else {
            attachmentPreview.style.display = "none";
          }
          
          uploadProgress.style.display = "none";
          showToast("File uploaded successfully!", "success");
          
          // Reset progress bar
          setTimeout(() => {
            uploadProgressBar.style.width = "0%";
          }, 1000);
        }, 500);
        
      } catch (err) {
        console.error("Upload failed", err);
        uploadProgress.style.display = "none";
        Swal.fire({ 
          icon: 'error', 
          title: 'Upload failed', 
          text: 'Could not upload attachment' 
        });
        formATTACHFILE.value = '';
      }
    });

    // Save transaction
    saveTransactionBtn.addEventListener("click", async () => {
      if (isSubmitting) return;
      isSubmitting = true;
          
      saveTransactionBtn.disabled = true;
      saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      
      if (!formDATE.value) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Date is required' });
        resetSaveButton();
        return;
      }

      if (!formSINO.value) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Voucher number is required' });
        resetSaveButton();
        return;
      }
          
      const txData = {
        DATE: formDATE.value,
        SINO: formSINO.value,
        ACCOUNT_HEADER: formACCOUNTHEADER.value,
        BANK_NAME: formBANKNAME.value,
        VOUCHER_TYPE: formVOUCHERTYPE.value,
        TYPE: formTYPE.value,
        INCOME: parseFloat(formINCOME.value) || 0,
        EXPENSE: parseFloat(formEXPENSE.value) || 0,
        DESCRIPTION: formDESCRIPTION.value,
        NOTES: formNOTES.value,
        TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        STATUS: formSTATUS.value,
        ATTACHMENT: formATTACH.value,
        CURRENCY: formCURRENCY.value,
        createdAt: new Date(),
        updatedAt: new Date(),
        userId: currentUser.uid
      };
      
      if (formTIME.value) {
        txData.TIME = formTIME.value;
      }
      
      try {
        if (txIdInput.value) {
          // Update existing transaction
          await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), txData);
          showToast("Transaction updated successfully", "success");
        } else {
          // Add new transaction
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
          showToast("Transaction added successfully", "success");
          
          // Update tags collection
          await updateTagsCollection(txData.TAGS);
        }
        
        transactionModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("saveTransaction", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transaction' });
      } finally {
        resetSaveButton();
      }
    });

    confirmDeleteBtn.addEventListener("click", async () => {
      if (!txToDelete) return;
      
      try {
        await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
        
        showToast("Transaction deleted successfully", "success");
        await loadTransactions();
        confirmDeleteModal.hide();
      } catch (err) {
        console.error("deleteTransaction", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transaction' });
      }
    });

    function populateCOADropdowns() {
      // Clear existing options
      formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
      formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
      
      // Add account headers
      coaAccounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account;
        option.textContent = account;
        formACCOUNTHEADER.appendChild(option);
      });
      
      // Add bank names
      coaBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        formBANKNAME.appendChild(option);
        splitIncomeBank.appendChild(option.cloneNode(true));
        
        // Also add to bank filter
        const filterOption = document.createElement('option');
        filterOption.value = bank;
        filterOption.textContent = bank;
        bankFilter.appendChild(filterOption);
      });
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        const txs = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || "",
          BANK_NAME: d.data().BANK_NAME || "",
          TAGS: d.data().TAGS || [],
          STATUS: d.data().STATUS || "completed"
        }));
        
        allTransactions = txs;
        filteredTransactions = allTransactions.slice();
        
        // Calculate running balance
        calculateRunningBalance();
        buildTable();
        updateStats();
        updateBankBalances();
        updateQuickStats();
        renderMainChart();
        updateSelectedSummary();
        updateFilterSummary();
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        transactionsTableBody.innerHTML = `<tr><td colspan="13" class="text-center text-danger py-4">
          <i class="fa fa-exclamation-triangle me-2"></i>Failed to load transactions. Please try again.
        </td></tr>`;
        return false;
      }
    }

    async function loadTags() {
      try {
        const tagsRef = collection(db, "users", currentUser.uid, "tags");
        const tagsSnap = await getDocs(tagsRef);
        
        allTags.clear();
        tagsSnap.forEach(doc => {
          const tagData = doc.data();
          allTags.add(tagData.name);
        });
        
        // Also extract tags from transactions
        allTransactions.forEach(tx => {
          if (tx.TAGS && Array.isArray(tx.TAGS)) {
            tx.TAGS.forEach(tag => allTags.add(tag));
          }
        });
      } catch (error) {
        console.warn('Error loading tags:', error.message);
      }
    }

    function calculateRunningBalance() {
      const sortedTransactions = [...allTransactions].sort((a, b) => {
        return new Date(a.DATE) - new Date(b.DATE);
      });
      
      let runningBalance = 0;
      
      sortedTransactions.forEach(tx => {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        runningBalance += (income - expense);
        tx.BALANCE = runningBalance;
      });
      
      return sortedTransactions;
    }

    function calculateBankBalances() {
      const bankBalances = {};
      
      coaBanks.forEach(bank => {
        bankBalances[bank] = 0;
      });
      
      allTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME || "";
        if (bankName && coaBanks.includes(bankName)) {
          const income = parseFloat(tx.INCOME) || 0;
          const expense = parseFloat(tx.EXPENSE) || 0;
          bankBalances[bankName] += (income - expense);
        }
      });
      
      return bankBalances;
    }
    
    function updateBankBalances() {
      const bankBalances = calculateBankBalances();
      
      bankBalancesContainer.innerHTML = "";
      
      // Add cash balance
      let hasCash = false;
      allTransactions.forEach(tx => {
        if (tx.BANK_NAME === "Cash" && !coaBanks.includes("Cash")) {
          hasCash = true;
        }
      });
      
      if (hasCash) {
        let cashBalance = 0;
        allTransactions.forEach(tx => {
          if (tx.BANK_NAME === "Cash") {
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            cashBalance += (income - expense);
          }
        });
        
        const cashItem = document.createElement("div");
        cashItem.className = "bank-balance-item";
        cashItem.innerHTML = `
          <div class="bank-balance-name">Cash</div>
          <div class="bank-balance-value ${cashBalance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? `$${cashBalance.toFixed(2)}` : '••••'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(cashItem);
        
        cashItem.querySelector('.balance-toggle').addEventListener('click', () => {
          toggleBalanceVisibility();
        });
      }
      
      // Add bank balances
      Object.entries(bankBalances).forEach(([bankName, balance]) => {
        const bankItem = document.createElement("div");
        bankItem.className = "bank-balance-item";
        bankItem.innerHTML = `
          <div class="bank-balance-name">${escapeHtml(bankName)}</div>
          <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? `$${balance.toFixed(2)}` : '••••'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(bankItem);
        
        bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
          toggleBalanceVisibility();
        });
      });
    }
    
    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      updateBalanceDisplay();
    }
    
    function updateBalanceDisplay() {
      const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
      const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
      const balance = totalIncome - totalExpense;
      
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
      statBalance.classList.toggle('balance-hidden', !balanceVisible);
      
      balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
      
      updateBankBalances();
      buildTable();
    }

    function updateQuickStats() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      // Current month stats
      const monthlyIncome = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      // Cash flow (last 30 days)
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      const recentIncome = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate >= thirtyDaysAgo && tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const recentExpenses = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate >= thirtyDaysAgo && tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      const cashflow = recentIncome - recentExpenses;
      statCashflow.textContent = `$${cashflow.toFixed(2)}`;
      
      quickStatsContainer.innerHTML = `
        <div class="quick-stat" onclick="showIncomeDetails()">
          <i class="fa fa-arrow-up text-success"></i>
          <span>Monthly Income: <strong>$${monthlyIncome.toFixed(2)}</strong></span>
        </div>
        <div class="quick-stat" onclick="showExpenseDetails()">
          <i class="fa fa-arrow-down text-danger"></i>
          <span>Monthly Expenses: <strong>$${monthlyExpenses.toFixed(2)}</strong></span>
        </div>
      `;
    }
    
    function renderMainChart() {
      if (mainChart) {
        mainChart.destroy();
      }
      
      const monthlyData = {};
      allTransactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = { income: 0, expense: 0 };
          }
          
          if (tx.TYPE === 'Income') {
            monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
          } else if (tx.TYPE === 'Expense') {
            monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
          }
        }
      });
      
      const sortedMonths = Object.keys(monthlyData).sort();
      
      const incomeData = sortedMonths.map(month => monthlyData[month].income);
      const expenseData = sortedMonths.map(month => monthlyData[month].expense);
      
      const monthLabels = sortedMonths.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return date.toLocaleString('default', { month: 'short', year: 'numeric' });
      });
      
      const ctx = transactionsChart.getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Monthly Income vs Expenses'
            }
          }
        }
      });
    }

    function applyFilters(){
      filteredTransactions = allTransactions.slice();
      const now = new Date();

      function inRange(dateStr, start, end){
        if (!dateStr) return false;
        const d = new Date(dateStr);
        return d >= start && d <= end;
      }

      // Date filter
      if (dateFilter.value !== "all") {
        let start, end;
        switch (dateFilter.value) {
          case "today":
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "week":
            const day = now.getDay();
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
            break;
          case "month":
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
          case "year":
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear() + 1, 0, 1);
            break;
          case "last7":
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "last30":
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "custom":
            if (startDateInput.value && endDateInput.value) {
              start = new Date(startDateInput.value);
              end = new Date(endDateInput.value);
              end.setDate(end.getDate() + 1);
            }
            break;
        }
        if (start && end) {
          filteredTransactions = filteredTransactions.filter(t => inRange(t.DATE, start, end));
        }
      }

      // Type filter
      if (typeFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
      }

      // Bank filter
      if (bankFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          t.BANK_NAME === bankFilter.value
        );
      }

      // Search filter
      if (searchDesc.value.trim()) {
        const term = searchDesc.value.trim().toLowerCase();
        filteredTransactions = filteredTransactions.filter(t => 
          (t.DESCRIPTION || "").toLowerCase().includes(term) ||
          (t.NOTES || "").toLowerCase().includes(term) ||
          (t.TAGS && t.TAGS.some(tag => tag.toLowerCase().includes(term))) ||
          (t.SINO || "").toLowerCase().includes(term)
        );
      }

      currentPage = 1;
      buildTable();
      updateStats();
      updateSelectedSummary();
      updateFilterSummary();
    }

    // Optimized table building
    function buildTable(){
      if (filteredTransactions.length === 0) {
        transactionsTableBody.innerHTML = `
          <tr>
            <td colspan="13" class="text-center text-muted py-5">
              <div class="empty-state">
                <h5>No transactions found</h5>
                <p class="text-muted">Try changing your filters or add a new transaction.</p>
                <button class="btn btn-primary mt-2" onclick="openAddModal()">
                  <i class="fa fa-plus me-1"></i> Add Transaction
                </button>
              </div>
            </td>
          </tr>`;
        paginationControls.innerHTML = "";
        return;
      }

      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

      let html = "";
      pageTransactions.forEach(tx => {
        html += renderTableRow(tx);
      });
      
      transactionsTableBody.innerHTML = html;

      // Add event listeners with event delegation
      transactionsTableBody.addEventListener("click", handleTableClick);
      transactionsTableBody.addEventListener("change", handleTableChange);

      // Build pagination
      buildPagination();
    }

    function renderTableRow(tx) {
      const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
      const income = parseFloat(tx.INCOME) || 0;
      const expense = parseFloat(tx.EXPENSE) || 0;
      const balance = parseFloat(tx.BALANCE) || 0;
      const isSelected = selectedTransactions.has(tx.id);
      
      const incomeDisplay = income > 0 ? `<span class="income-color">$${income.toFixed(2)}</span>` : "$0.00";
      const expenseDisplay = expense > 0 ? `<span class="expense-color">$${expense.toFixed(2)}</span>` : "$0.00";
      const balanceDisplay = balanceVisible ? `$${balance.toFixed(2)}` : "••••";
      
      let badgeClass = '';
      let badgeText = tx.TYPE;
      if (tx.TYPE === 'Income') badgeClass = 'badge-income';
      else if (tx.TYPE === 'Expense') badgeClass = 'badge-expense';
      else if (tx.TYPE === 'Transfer') badgeClass = 'badge-transfer';
      
      // Highlight search term
      let description = escapeHtml(tx.DESCRIPTION || tx.NOTES || "");
      if (searchDesc.value.trim()) {
        const term = searchDesc.value.trim();
        const regex = new RegExp(`(${term})`, 'gi');
        description = description.replace(regex, '<span class="highlight">$1</span>');
      }
      
      // Render tags
      let tagsHtml = '';
      if (tx.TAGS && tx.TAGS.length > 0) {
        tagsHtml = tx.TAGS.map(tag => `
          <span class="tag">
            ${escapeHtml(tag)}
          </span>
        `).join('');
      }
      
      return `
        <tr class="${isSelected ? 'selected' : ''}" data-id="${tx.id}">
          <td>
            <input type="checkbox" class="transaction-checkbox row-checkbox" data-id="${tx.id}" ${isSelected ? 'checked' : ''}>
          </td>
          <td>${date}</td>
          <td>${escapeHtml(tx.ACCOUNT_HEADER || "-")}</td>
          <td>${description}</td>
          <td><span class="badge ${badgeClass}">${badgeText}</span></td>
          <td>${escapeHtml(tx.SINO || "")}</td>
          <td>${escapeHtml(tx.BANK_NAME || "")}</td>
          <td style="text-align:right;">${incomeDisplay}</td>
          <td style="text-align:right;">${expenseDisplay}</td>
          <td style="text-align:right;">${balanceDisplay}</td>
          <td>
            <div class="tag-container">
              ${tagsHtml}
            </div>
          </td>
          <td>
            ${
              tx.ATTACHMENT
                ? `<button class="btn btn-sm btn-outline-primary view-attachment" data-attachment="${escapeHtml(tx.ATTACHMENT)}">
                    <i class="fa fa-paperclip"></i> View
                  </button>`
                : `<span class="text-muted">None</span>`
            }
          </td>
          <td>
            <div class="d-flex gap-1">
              <button class="action-btn btn-view view-tx" data-id="${tx.id}" title="View"><i class="fa fa-eye"></i></button>
              <button class="action-btn btn-edit edit-tx" data-id="${tx.id}" title="Edit"><i class="fa fa-edit"></i></button>
              <button class="action-btn btn-del delete-tx" data-id="${tx.id}" title="Delete"><i class="fa fa-trash"></i></button>
            </div>
          </td>
        </tr>
      `;
    }

    function handleTableClick(e) {
      const target = e.target;
      const button = target.closest("button");
      
      if (!button) return;
      
      if (button.classList.contains("view-tx")) {
        const id = button.getAttribute("data-id");
        viewTransaction(id);
      } else if (button.classList.contains("edit-tx")) {
        const id = button.getAttribute("data-id");
        editTransaction(id);
      } else if (button.classList.contains("delete-tx")) {
        const id = button.getAttribute("data-id");
        confirmDelete(id);
      } else if (button.classList.contains("view-attachment")) {
        const attachment = button.getAttribute("data-attachment");
        viewAttachment(attachment);
      }
    }

    function handleTableChange(e) {
      if (e.target.classList.contains("row-checkbox")) {
        const id = e.target.getAttribute("data-id");
        const row = e.target.closest("tr");
        
        if (e.target.checked) {
          selectedTransactions.add(id);
          row.classList.add("selected");
        } else {
          selectedTransactions.delete(id);
          row.classList.remove("selected");
          selectAllCheckbox.checked = false;
        }
        
        updateBulkActions();
        updateSelectedSummary();
      }
    }

    function buildPagination() {
      const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
      if (totalPages <= 1) {
        paginationControls.innerHTML = "";
        return;
      }

      let html = `<nav><ul class="pagination pagination-sm">`;

      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>
      `;

      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>
      `;

      paginationControls.innerHTML = html;

      // Event delegation for pagination
      paginationControls.addEventListener("click", function(e) {
        const link = e.target.closest(".page-link");
        if (link) {
          e.preventDefault();
          const page = parseInt(link.getAttribute("data-page"));
          if (page && page !== currentPage && page > 0 && page <= totalPages) {
            currentPage = page;
            buildTable();
          }
        }
      });
    }

    function updateStats(){
      const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      statIncome.textContent = `$${totalIncome.toFixed(2)}`;
      statExpense.textContent = `$${totalExpense.toFixed(2)}`;
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
      statCount.textContent = filteredTransactions.length;
      
      statIncome.className = "stat-value income-color";
      statExpense.className = "stat-value expense-color";
    }

    function updateSelectedSummary() {
      const count = selectedTransactions.size;
      if (count === 0) {
        selectedSummary.innerHTML = "No transactions selected";
        return;
      }
      
      let totalIncome = 0;
      let totalExpense = 0;
      
      selectedTransactions.forEach(id => {
        const tx = allTransactions.find(t => t.id === id);
        if (tx) {
          totalIncome += parseFloat(tx.INCOME) || 0;
          totalExpense += parseFloat(tx.EXPENSE) || 0;
        }
      });
      
      const net = totalIncome - totalExpense;
      
      selectedSummary.innerHTML = `
        <div class="row">
          <div class="col-4">Selected: <strong>${count}</strong></div>
          <div class="col-4">Income: <strong class="text-success">$${totalIncome.toFixed(2)}</strong></div>
          <div class="col-4">Expense: <strong class="text-danger">$${totalExpense.toFixed(2)}</strong></div>
        </div>
        <div class="row mt-1">
          <div class="col-12">Net: <strong class="${net >= 0 ? 'text-success' : 'text-danger'}">$${net.toFixed(2)}</strong></div>
        </div>
      `;
    }

    function updateFilterSummary() {
      const count = filteredTransactions.length;
      const total = allTransactions.length;
      const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
      
      filterSummary.innerHTML = `
        Showing ${count} of ${total} transactions (${percentage}%)
      `;
    }

    function viewAttachment(attachmentUrl) {
      if (!attachmentUrl) return;

      const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(attachmentUrl);
      const isPDF = /\.(pdf)$/i.test(attachmentUrl);

      Swal.fire({
        title: 'Attachment',
        html: `
          <div class="text-center">
            ${isImage 
              ? `<img src="${attachmentUrl}" class="img-fluid" style="max-height: 400px;" />`
              : isPDF
                ? `<iframe src="${attachmentUrl}" width="100%" height="400px"></iframe>`
                : `<div class="alert alert-info">File can be downloaded</div>`
            }
          </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    // Optimized modal opening
    async function openAddModal(){
      showLoading("Loading form...");
      
      try {
        txIdInput.value = "";
        form.reset();
        formDATE.value = new Date().toISOString().split('T')[0];
        formTYPE.value = "Income";
        formVOUCHERTYPE.value = "Payment";
        formCURRENCY.value = "USD";
        formSTATUS.value = "completed";
        formTAGS.value = "";
        tagsPreview.innerHTML = "";
        
        formINCOME.value = "";
        formEXPENSE.value = "";
        formNOTES.value = "";
        formDESCRIPTION.value = "";
        formATTACH.value = "";
        formATTACHFILE.value = "";
        attachmentPreview.style.display = "none";
        attachmentInfo.textContent = "";
        uploadProgress.style.display = "none";
        uploadProgressBar.style.width = "0%";
        
        Array.from(form.elements).forEach(el => el.disabled = false);
        saveTransactionBtn.style.display = "block";
        saveTransactionBtn.disabled = false;
        saveTransactionBtn.innerHTML = 'Save Transaction';

        updateFormFields();
        
        document.getElementById("transactionModalLabel").textContent = "Add Transaction";
        
        // Hide loading and show modal
        setTimeout(() => {
          hideLoading();
          transactionModal.show();
        }, 100);
        
      } catch (error) {
        hideLoading();
        console.error("Error opening modal:", error);
        Swal.fire({ 
          icon: 'error', 
          title: 'Error', 
          text: 'Failed to load form. Please try again.' 
        });
      }
    }

    function viewTransaction(id){
      const tx = allTransactions.find(t => t.id === id);
      if (!tx) return;
      
      showLoading("Loading transaction...");
      
      setTimeout(() => {
        txIdInput.value = tx.id;
        formDATE.value = tx.DATE || "";
        formSINO.value = tx.SINO || "";
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
        formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
        formTYPE.value = tx.TYPE || "Income";
        formBANKNAME.value = tx.BANK_NAME || "";
        formINCOME.value = tx.INCOME || "";
        formEXPENSE.value = tx.EXPENSE || "";
        formNOTES.value = tx.NOTES || "";
        formDESCRIPTION.value = tx.DESCRIPTION || "";
        formCURRENCY.value = tx.CURRENCY || "USD";
        formSTATUS.value = tx.STATUS || "completed";
        formTAGS.value = tx.TAGS ? tx.TAGS.join(', ') : "";
        updateTagsPreview();
        
        if (tx.TIME) {
          formTIME.value = tx.TIME;
        } else {
          formTIME.value = "";
        }
        
        if (tx.ATTACHMENT) {
          formATTACH.value = tx.ATTACHMENT;
          attachmentInfo.textContent = "Current attachment";
          
          if (tx.ATTACHMENT.includes('image')) {
            attachmentPreview.src = tx.ATTACHMENT;
            attachmentPreview.style.display = "block";
          } else {
            attachmentPreview.style.display = "none";
          }
        } else {
          attachmentInfo.textContent = "";
          attachmentPreview.style.display = "none";
        }
        
        updateFormFields();
        
        document.getElementById("transactionModalLabel").textContent = "View Transaction";
        
        Array.from(form.elements).forEach(el => el.disabled = true);
        saveTransactionBtn.style.display = "none";
        
        hideLoading();
        transactionModal.show();
      }, 100);
    }

    function editTransaction(id){
      const tx = allTransactions.find(t => t.id === id);
      if (!tx) return;
      
      showLoading("Loading transaction...");
      
      setTimeout(() => {
        txIdInput.value = tx.id;
        formDATE.value = tx.DATE || "";
        formSINO.value = tx.SINO || "";
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
        formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
        formTYPE.value = tx.TYPE || "Income";
        formBANKNAME.value = tx.BANK_NAME || "";
        formINCOME.value = tx.INCOME || "";
        formEXPENSE.value = tx.EXPENSE || "";
        formNOTES.value = tx.NOTES || "";
        formDESCRIPTION.value = tx.DESCRIPTION || "";
        formCURRENCY.value = tx.CURRENCY || "USD";
        formSTATUS.value = tx.STATUS || "completed";
        formTAGS.value = tx.TAGS ? tx.TAGS.join(', ') : "";
        updateTagsPreview();
        
        if (tx.TIME) {
          formTIME.value = tx.TIME;
        } else {
          formTIME.value = "";
        }
        
        if (tx.ATTACHMENT) {
          formATTACH.value = tx.ATTACHMENT;
          attachmentInfo.textContent = "Current attachment";
          
          if (tx.ATTACHMENT.includes('image')) {
            attachmentPreview.src = tx.ATTACHMENT;
            attachmentPreview.style.display = "block";
          } else {
            attachmentPreview.style.display = "none";
          }
        } else {
          attachmentInfo.textContent = "";
          attachmentPreview.style.display = "none";
        }
        
        updateFormFields();
        
        document.getElementById("transactionModalLabel").textContent = "Edit Transaction";
        
        Array.from(form.elements).forEach(el => el.disabled = false);
        saveTransactionBtn.style.display = "block";
        saveTransactionBtn.disabled = false;
        saveTransactionBtn.innerHTML = 'Save Transaction';
        
        hideLoading();
        transactionModal.show();
      }, 100);
    }

    function updateFormFields() {
      const type = formTYPE.value;
      const incomeInput = document.getElementById("formINCOME");
      const expenseInput = document.getElementById("formEXPENSE");
      
      if (type === "Income") {
        incomeInput.disabled = false;
        incomeInput.required = true;
        expenseInput.disabled = true;
        expenseInput.value = "";
        expenseInput.required = false;
      } else if (type === "Expense") {
        incomeInput.disabled = true;
        incomeInput.value = "";
        incomeInput.required = false;
        expenseInput.disabled = false;
        expenseInput.required = true;
      } else {
        incomeInput.disabled = false;
        expenseInput.disabled = false;
        incomeInput.required = false;
        expenseInput.required = false;
      }
    }

    function updateTagsPreview() {
      const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag);
      tagsPreview.innerHTML = tags.map(tag => `
        <span class="tag">
          ${escapeHtml(tag)}
        </span>
      `).join('');
    }

    function resetSaveButton() {
      isSubmitting = false;
      saveTransactionBtn.disabled = false;
      saveTransactionBtn.innerHTML = 'Save Transaction';
    }

    // Quick Add processing
    async function processQuickAdd() {
      const text = quickAddInput.value.trim();
      if (!text) {
        Swal.fire({ icon: 'warning', title: 'Input required', text: 'Please enter a transaction description' });
        return;
      }

      try {
        const parsedData = parseQuickAddInput(text);
        
        if (!parsedData.amount) {
          Swal.fire({ icon: 'warning', title: 'Invalid Input', text: 'Could not detect an amount in your input' });
          return;
        }

        const txData = {
          DATE: parsedData.date || new Date().toISOString().split('T')[0],
          SINO: "",
          ACCOUNT_HEADER: parsedData.accountHeader,
          BANK_NAME: parsedData.bankName,
          VOUCHER_TYPE: parsedData.voucherType,
          TYPE: parsedData.type,
          INCOME: parsedData.type === "Income" ? parsedData.amount : 0,
          EXPENSE: parsedData.type === "Expense" ? parsedData.amount : 0,
          DESCRIPTION: parsedData.description,
          NOTES: "Quick add transaction",
          TAGS: parsedData.tags || [],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date(),
          userId: currentUser.uid
        };

        if (parsedData.type === "Transfer") {
          const fromTx = {
            ...txData,
            SINO: "TR-001",
            ACCOUNT_HEADER: parsedData.fromBank,
            BANK_NAME: parsedData.fromBank,
            EXPENSE: parsedData.amount,
            INCOME: 0,
            DESCRIPTION: `Transfer to ${parsedData.toBank}`
          };
          
          const toTx = {
            ...txData,
            SINO: "TR-002",
            ACCOUNT_HEADER: parsedData.toBank,
            BANK_NAME: parsedData.toBank,
            INCOME: parsedData.amount,
            EXPENSE: 0,
            DESCRIPTION: `Transfer from ${parsedData.fromBank}`
          };
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), fromTx);
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), toTx);
          
          showToast("Transfer completed successfully", "success");
        } else {
          const voucherNumber = "PAY-001";
          txData.SINO = voucherNumber;
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
          showToast("Transaction added successfully", "success");
        }
        
        quickAddModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("Quick add error", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add transaction' });
      }
    }

    function parseQuickAddInput(text) {
      const lowerText = text.toLowerCase();
      let amount = 0;
      let type = "";
      let accountHeader = "";
      let bankName = "";
      let description = text;
      let date = null;
      let fromBank = "";
      let toBank = "";
      let tags = [];
      
      // Extract amount
      const amountMatch = text.match(/(\d+)(\.\d+)?/);
      if (amountMatch) {
        amount = parseFloat(amountMatch[0]);
      }
      
      // Determine transaction type
      if (lowerText.includes('transfer') && lowerText.includes('from') && lowerText.includes('to')) {
        type = "Transfer";
        const transferMatch = lowerText.match(/transfer.*?(\d+).*?from (.*?) to (.*)/);
        if (transferMatch) {
          amount = parseFloat(transferMatch[1]);
          fromBank = findMatchingBank(transferMatch[2]);
          toBank = findMatchingBank(transferMatch[3]);
          description = `Transfer from ${fromBank} to ${toBank}`;
        }
      } else if (lowerText.includes('add') || lowerText.includes('receive') || lowerText.includes('income') || 
          lowerText.includes('deposit')) {
        type = "Income";
      } else if (lowerText.includes('spent') || lowerText.includes('spend') || lowerText.includes('pay') || 
                 lowerText.includes('expense')) {
        type = "Expense";
      }

      if (type !== "Transfer") {
        // Extract bank name
        for (const bank of coaBanks) {
          if (lowerText.includes(bank.toLowerCase())) {
            bankName = bank;
            break;
          }
        }

        // Extract account header
        for (const account of coaAccounts) {
          if (lowerText.includes(account.toLowerCase())) {
            accountHeader = account;
            break;
          }
        }

        if (!accountHeader) {
          if (lowerText.includes('petrol') || lowerText.includes('fuel') || lowerText.includes('gas')) {
            accountHeader = "Fuel";
          } else if (lowerText.includes('food') || lowerText.includes('meal')) {
            accountHeader = "Meals & Entertainment";
          } else if (lowerText.includes('rent')) {
            accountHeader = "Rent";
          } else if (lowerText.includes('shopping')) {
            accountHeader = "Shopping";
          } else if (bankName) {
            accountHeader = bankName;
          } else {
            accountHeader = "Miscellaneous";
          }
        }

        if (!bankName && lowerText.includes('cash')) {
          bankName = "Cash";
        }
      }

      let voucherType = "Payment";
      if (type === "Income") voucherType = "Receipt";
      else if (type === "Transfer") voucherType = "Transfer";

      return {
        amount,
        type,
        accountHeader,
        bankName,
        description,
        date,
        voucherType,
        fromBank,
        toBank,
        tags
      };
    }

    function findMatchingBank(bankText) {
      for (const bank of coaBanks) {
        if (bank.toLowerCase().includes(bankText.trim().toLowerCase()) || 
            bankText.trim().toLowerCase().includes(bank.toLowerCase())) {
          return bank;
        }
      }
      return bankText;
    }

    // Theme functions
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', currentTheme);
      
      if (mainChart) {
        renderMainChart();
      }
    }
    
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      }
    }
    
    // Export functions
    function exportToCSV() {
      if (filteredTransactions.length === 0) {
        Swal.fire({ icon: 'warning', title: 'No Data', text: 'There are no transactions to export.' });
        return;
      }
      
      const headers = ['Date', 'Account Header', 'Description', 'Type', 'Voucher #', 'Bank Name', 'Income', 'Expense', 'Balance', 'Currency', 'Status', 'Tags'];
      
      let csvContent = headers.join(',') + '\n';
      
      filteredTransactions.forEach(tx => {
        const row = [
          tx.DATE || '',
          tx.ACCOUNT_HEADER || '',
          `"${(tx.DESCRIPTION || tx.NOTES || '').replace(/"/g, '""')}"`,
          tx.TYPE || '',
          tx.SINO || '',
          tx.BANK_NAME || '',
          tx.INCOME || 0,
          tx.EXPENSE || 0,
          tx.BALANCE || 0,
          tx.CURRENCY || '',
          tx.STATUS || '',
          tx.TAGS ? `"${tx.TAGS.join(', ')}"` : ''
        ];
        csvContent += row.join(',') + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast("CSV exported successfully", "success");
    }
    
    function exportToPDF() {
      Swal.fire({ 
        icon: 'info', 
        title: 'PDF Export', 
        text: 'PDF export functionality would typically require a library like jsPDF or browser print functionality.',
        showCancelButton: true,
        confirmButtonText: 'Print',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          window.print();
        }
      });
    }

    // Multiple Selection Functions
    function selectAllTransactions() {
      const pageTransactions = filteredTransactions.slice(
        (currentPage - 1) * rowsPerPage,
        currentPage * rowsPerPage
      );
      
      pageTransactions.forEach(tx => {
        selectedTransactions.add(tx.id);
      });
      
      buildTable();
      updateBulkActions();
      updateSelectedSummary();
    }

    function deselectAllTransactions() {
      selectedTransactions.clear();
      buildTable();
      updateBulkActions();
      updateSelectedSummary();
    }

    function toggleSelectAll() {
      if (selectAllCheckbox.checked) {
        selectAllTransactions();
      } else {
        deselectAllTransactions();
      }
    }

    function clearSelection() {
      selectedTransactions.clear();
      buildTable();
      updateBulkActions();
      updateSelectedSummary();
    }

    function updateBulkActions() {
      const count = selectedTransactions.size;
      selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
      
      if (count > 0) {
        bulkActions.classList.remove('hidden');
      } else {
        bulkActions.classList.add('hidden');
      }
    }

    function confirmBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      bulkDeleteCount.textContent = count;
      confirmBulkDeleteModal.show();
    }

    async function processBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      try {
        const batch = writeBatch(db);
        Array.from(selectedTransactions).forEach(id => {
          const docRef = doc(db, "users", currentUser.uid, "transactions", id);
          batch.delete(docRef);
        });
        
        await batch.commit();
        
        showToast(`${count} transaction${count !== 1 ? 's' : ''} deleted successfully`, "success");
        
        selectedTransactions.clear();
        confirmBulkDeleteModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("bulkDeleteTransactions", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transactions' });
      }
    }

    function openBulkEditModal() {
      Swal.fire({
        icon: 'info',
        title: 'Bulk Edit',
        text: 'Bulk edit functionality would allow editing multiple transactions at once.',
        confirmButtonText: 'OK'
      });
    }

    function openBulkTagModal() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      Swal.fire({
        title: 'Add Tags to Selected Transactions',
        input: 'text',
        inputLabel: 'Tags (comma separated)',
        showCancelButton: true,
        confirmButtonText: 'Add Tags',
        cancelButtonText: 'Cancel',
        preConfirm: (tagsInput) => {
          if (!tagsInput) {
            Swal.showValidationMessage('Please enter at least one tag');
          }
          return tagsInput;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          const newTags = result.value.split(',').map(tag => tag.trim()).filter(tag => tag);
          
          try {
            // Update tags collection
            await updateTagsCollection(newTags);
            
            // Update each transaction
            const batch = writeBatch(db);
            Array.from(selectedTransactions).forEach(id => {
              const tx = allTransactions.find(t => t.id === id);
              if (tx) {
                const existingTags = tx.TAGS || [];
                const updatedTags = [...new Set([...existingTags, ...newTags])];
                
                const docRef = doc(db, "users", currentUser.uid, "transactions", id);
                batch.update(docRef, {
                  TAGS: updatedTags,
                  updatedAt: new Date()
                });
              }
            });
            
            await batch.commit();
            
            showToast(`Tags added to ${count} transaction${count !== 1 ? 's' : ''} successfully`, "success");
            
            selectedTransactions.clear();
            await loadTransactions();
          } catch (err) {
            console.error("bulkTagTransactions", err);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add tags' });
          }
        }
      });
    }

    async function updateTagsCollection(tags) {
      try {
        const tagsRef = collection(db, "users", currentUser.uid, "tags");
        const tagsSnapshot = await getDocs(tagsRef);
        const existingTags = new Set();
        
        tagsSnapshot.forEach(doc => {
          existingTags.add(doc.data().name);
        });
        
        const batch = writeBatch(db);
        tags.forEach(tag => {
          if (!existingTags.has(tag)) {
            const newTagRef = doc(tagsRef);
            batch.set(newTagRef, {
              name: tag,
              createdAt: new Date(),
              userId: currentUser.uid
            });
          }
        });
        
        if (batch._mutations.length > 0) {
          await batch.commit();
        }
      } catch (error) {
        console.warn('Error updating tags collection:', error.message);
      }
    }

    // Split Income Functions
    function openSplitIncomeModal() {
      splitIncomeAmount.value = "";
      splitIncomeDescription.value = "";
      splitIncomeBank.value = "";
      splitExpensesContainer.innerHTML = "";
      splitSummary.innerHTML = "";
      
      addSplitExpense();
      
      splitIncomeModal.show();
    }

    function addSplitExpense() {
      const expenseId = 'expense-' + Date.now();
      const expenseHtml = `
        <div class="split-transaction-item" id="${expenseId}">
          <div class="split-header">
            <h6>Expense</h6>
            <button type="button" class="remove-split" onclick="removeSplitExpense('${expenseId}')">
              <i class="fa fa-times"></i>
            </button>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control split-amount-input" placeholder="0.00" oninput="updateSplitSummary()">
            </div>
            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" class="form-control split-description-input" placeholder="Expense description">
            </div>
            <div class="col-md-4">
              <label class="form-label">Bank Account</label>
              <select class="form-select split-bank-input">
                <option value="">Select Bank</option>
                ${coaBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-12">
              <label class="form-label">Account Header</label>
              <select class="form-select split-account-input">
                <option value="">Select Account Header</option>
                ${coaAccounts.map(account => `<option value="${account}">${account}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      `;
      
      splitExpensesContainer.insertAdjacentHTML('beforeend', expenseHtml);
      updateSplitSummary();
    }

    function removeSplitExpense(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
        updateSplitSummary();
      }
    }

    function updateSplitSummary() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      
      let totalExpenses = 0;
      expenseElements.forEach(element => {
        const amountInput = element.querySelector('.split-amount-input');
        const amount = parseFloat(amountInput.value) || 0;
        totalExpenses += amount;
      });
      
      const remaining = incomeAmount - totalExpenses;
      
      let summaryHtml = '';
      if (incomeAmount > 0) {
        summaryHtml = `
          <div class="d-flex justify-content-between">
            <span>Total Income:</span>
            <span>$${incomeAmount.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Total Expenses:</span>
            <span>$${totalExpenses.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between ${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">
            <span>Remaining:</span>
            <span>$${remaining.toFixed(2)}</span>
          </div>
        `;
        
        if (remaining < 0) {
          summaryHtml += `<div class="text-danger small mt-1">Warning: Expenses exceed income by $${Math.abs(remaining).toFixed(2)}</div>`;
        }
      }
      
      splitSummary.innerHTML = summaryHtml;
    }

    async function saveSplitTransactions() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const incomeDescription = splitIncomeDescription.value.trim();
      const incomeBank = splitIncomeBank.value;
      
      if (!incomeAmount || incomeAmount <= 0) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a valid income amount' });
        return;
      }
      
      if (!incomeDescription) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter an income description' });
        return;
      }
      
      if (!incomeBank) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please select an income bank account' });
        return;
      }
      
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      if (expenseElements.length === 0) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please add at least one expense' });
        return;
      }
      
      let totalExpenses = 0;
      const expenses = [];
      
      for (const element of expenseElements) {
        const amountInput = element.querySelector('.split-amount-input');
        const descriptionInput = element.querySelector('.split-description-input');
        const bankInput = element.querySelector('.split-bank-input');
        const accountInput = element.querySelector('.split-account-input');
        
        const amount = parseFloat(amountInput.value) || 0;
        const description = descriptionInput.value.trim();
        const bank = bankInput.value;
        const account = accountInput.value;
        
        if (amount <= 0) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a positive amount' });
          return;
        }
        
        if (!description) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a description' });
          return;
        }
        
        if (!bank) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a bank account selected' });
          return;
        }
        
        if (!account) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have an account header selected' });
          return;
        }
        
        totalExpenses += amount;
        expenses.push({ amount, description, bank, account });
      }
      
      try {
        const today = new Date().toISOString().split('T')[0];
        const batch = writeBatch(db);
        
        // Save income transaction
        const incomeData = {
          DATE: today,
          SINO: "INC-001",
          ACCOUNT_HEADER: "Income",
          BANK_NAME: incomeBank,
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: incomeAmount,
          EXPENSE: 0,
          DESCRIPTION: incomeDescription,
          NOTES: "Split income transaction",
          TAGS: ["split-income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date(),
          userId: currentUser.uid
        };
        
        const incomeRef = doc(collection(db, "users", currentUser.uid, "transactions"));
        batch.set(incomeRef, incomeData);
        
        // Save all expense transactions
        for (const expense of expenses) {
          const expenseData = {
            DATE: today,
            SINO: "EXP-001",
            ACCOUNT_HEADER: expense.account,
            BANK_NAME: expense.bank,
            VOUCHER_TYPE: "Payment",
            TYPE: "Expense",
            INCOME: 0,
            EXPENSE: expense.amount,
            DESCRIPTION: expense.description,
            NOTES: "Split from income",
            TAGS: ["split-expense"],
            STATUS: "completed",
            CURRENCY: "USD",
            createdAt: new Date(),
            updatedAt: new Date(),
            userId: currentUser.uid
          };
          
          const expenseRef = doc(collection(db, "users", currentUser.uid, "transactions"));
          batch.set(expenseRef, expenseData);
        }
        
        await batch.commit();
        
        showToast(`Created ${1 + expenses.length} transactions successfully`, "success");
        
        splitIncomeModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("saveSplitTransactions", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transactions' });
      }
    }

    // AI Assistant functions
    function toggleAIPanel() {
      aiPanel.classList.toggle('show');
    }

    async function sendAIMessage() {
      const message = aiInput.value.trim();
      if (!message) return;
      
      // Add user message to chat
      addAIMessage(message, 'user');
      aiInput.value = '';
      
      try {
        // Analyze transaction data for AI response
        const response = await analyzeTransactionData(message);
        addAIMessage(response, 'bot');
      } catch (error) {
        addAIMessage("I'm having trouble processing your request. Please try again later.", 'bot");
      }
    }

    async function analyzeTransactionData(message) {
      const lowerMessage = message.toLowerCase();
      
      // Check for specific transaction-related queries
      if (lowerMessage.includes('total') && lowerMessage.includes('income')) {
        const totalIncome = allTransactions
          .filter(tx => tx.TYPE === 'Income')
          .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        return `Total income: $${totalIncome.toFixed(2)}`;
        
      } else if (lowerMessage.includes('total') && lowerMessage.includes('expense')) {
        const totalExpense = allTransactions
          .filter(tx => tx.TYPE === 'Expense')
          .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
        return `Total expenses: $${totalExpense.toFixed(2)}`;
        
      } else if (lowerMessage.includes('balance')) {
        const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
        const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
        const balance = totalIncome - totalExpense;
        return `Current balance: $${balance.toFixed(2)}`;
        
      } else if (lowerMessage.includes('recent') || lowerMessage.includes('latest')) {
        const recent = allTransactions.slice(0, 5);
        if (recent.length === 0) return "No recent transactions found.";
        
        let response = "Recent transactions:\n";
        recent.forEach(tx => {
          const amount = tx.INCOME > 0 ? tx.INCOME : tx.EXPENSE;
          response += `• ${tx.DATE}: ${tx.DESCRIPTION} - $${amount}\n`;
        });
        return response;
        
      } else if (lowerMessage.includes('category') || lowerMessage.includes('spending')) {
        // Analyze spending by category
        const categorySpending = {};
        allTransactions.forEach(tx => {
          if (tx.TYPE === 'Expense') {
            const category = tx.ACCOUNT_HEADER || 'Uncategorized';
            categorySpending[category] = (categorySpending[category] || 0) + (parseFloat(tx.EXPENSE) || 0);
          }
        });
        
        const topCategories = Object.entries(categorySpending)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        if (topCategories.length === 0) return "No expense data available.";
        
        let response = "Top spending categories:\n";
        topCategories.forEach(([category, amount]) => {
          response += `• ${category}: $${amount.toFixed(2)}\n`;
        });
        return response;
        
      } else if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
        return "I can help you with:\n• Transaction totals (income, expenses, balance)\n• Recent transactions\n• Spending by category\n• Bank balances\n• Financial insights\n\nTry asking me about your transactions!";
        
      } else {
        // Default response
        const totalTransactions = allTransactions.length;
        const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
        const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
        
        return `I found ${totalTransactions} transactions in your account (${incomeCount} income, ${expenseCount} expenses). What specific information would you like to know about your transactions?`;
      }
    }

    function addAIMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ${sender}`;
      messageDiv.textContent = text;
      aiChat.appendChild(messageDiv);
      aiChat.scrollTop = aiChat.scrollHeight;
    }

    // Format date
    function formatDateToYyyyMmmDd(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.toLocaleString('default', { month: 'short' });
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Dynamic tips
    const tips = [
      "Try using the Quick Add feature to add transactions in natural language.",
      "Use tags to categorize transactions for better organization.",
      "Export your data regularly for backup purposes.",
      "Use the AI assistant for financial insights and recommendations.",
      "Toggle between light and dark mode for comfortable viewing."
    ];
    
    let currentTipIndex = 0;
    
    function showNextTip() {
      currentTipIndex = (currentTipIndex + 1) % tips.length;
      dynamicTip.textContent = tips[currentTipIndex];
    }
    
    // Last sync time
    function updateLastSync() {
      const now = new Date();
      lastSync.textContent = `Last sync: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }

    // Tag manager
    function showTagManager() {
      let tagList = '';
      allTags.forEach(tag => {
        tagList += `<span class="badge bg-secondary me-1 mb-1">${tag}</span>`;
      });
      
      Swal.fire({
        title: 'Tag Manager',
        html: `
          <div class="mb-3">
            <label class="form-label">Available Tags</label>
            <div class="p-3 border rounded">
              ${tagList || 'No tags yet'}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Add New Tag</label>
            <input type="text" class="form-control" id="newTagInput" placeholder="Enter new tag">
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Add Tag',
        cancelButtonText: 'Close',
        preConfirm: () => {
          const tagInput = document.getElementById('newTagInput');
          const tagName = tagInput.value.trim();
          
          if (!tagName) {
            Swal.showValidationMessage('Please enter a tag name');
            return false;
          }
          
          return tagName;
        }
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const tagRef = doc(collection(db, "users", currentUser.uid, "tags"));
            await setDoc(tagRef, {
              name: result.value,
              createdAt: new Date(),
              userId: currentUser.uid
            });
            
            showToast("Tag added successfully", "success");
            await loadTags();
          } catch (error) {
            console.error("Error adding tag:", error);
            showToast("Failed to add tag", "error");
          }
        }
      });
    }

    // Dashboard functions
    function showIncomeDetails() {
      const incomeTransactions = allTransactions.filter(tx => tx.TYPE === 'Income');
      const totalIncome = incomeTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      
      Swal.fire({
        title: 'Income Details',
        html: `
          <div class="text-center">
            <h1 class="text-success">$${totalIncome.toFixed(2)}</h1>
            <p>Total Income from ${incomeTransactions.length} transactions</p>
          </div>
        `,
        width: 400
      });
    }

    function showExpenseDetails() {
      const expenseTransactions = allTransactions.filter(tx => tx.TYPE === 'Expense');
      const totalExpense = expenseTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      Swal.fire({
        title: 'Expense Details',
        html: `
          <div class="text-center">
            <h1 class="text-danger">$${totalExpense.toFixed(2)}</h1>
            <p>Total Expenses from ${expenseTransactions.length} transactions</p>
          </div>
        `,
        width: 400
      });
    }

    function showTransactionStats() {
      const totalTransactions = allTransactions.length;
      const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
      
      Swal.fire({
        title: 'Transaction Statistics',
        html: `
          <div class="text-center">
            <h1>${totalTransactions}</h1>
            <p>Total Transactions</p>
            <div class="row mt-3">
              <div class="col-6">
                <div class="text-success">
                  <h3>${incomeCount}</h3>
                  <small>Income</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-danger">
                  <h3>${expenseCount}</h3>
                  <small>Expense</small>
                </div>
              </div>
            </div>
          </div>
        `,
        width: 400
      });
    }

    function showCashflowChart() {
      Swal.fire({
        title: 'Cash Flow Analysis',
        text: 'This would display a detailed cash flow chart and analysis.',
        icon: 'info'
      });
    }

    // Make functions available globally for inline event handlers
    window.removeSplitExpense = removeSplitExpense;
    window.updateSplitSummary = updateSplitSummary;
    window.toggleBalanceVisibility = toggleBalanceVisibility;
    window.showIncomeDetails = showIncomeDetails;
    window.showExpenseDetails = showExpenseDetails;
    window.showTransactionStats = showTransactionStats;
    window.showCashflowChart = showCashflowChart;
    window.showNextTip = showNextTip;
    window.openAddModal = openAddModal;
  </script>
</body>
</html>
