<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- New Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 280px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }

    /* Sidebar Styles */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .sidebar.collapsed {
      transform: translateX(-100%);
    }
    
    .sidebar-header {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    
    .user-info h6 {
      margin: 0;
      font-weight: 600;
    }
    
    .user-info small {
      color: var(--muted);
      font-size: 12px;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: var(--text-primary);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s;
      gap: 12px;
    }
    
    .sidebar-menu a:hover {
      background: var(--bg-primary);
      color: var(--accent);
    }
    
    .sidebar-menu a.active {
      background: var(--accent);
      color: white;
    }
    
    .sidebar-menu a i {
      width: 20px;
      text-align: center;
    }
    
    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s;
      padding: 20px;
    }
    
    .main-content.expanded {
      margin-left: 0;
    }

    /* Page header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }
    
    .page-title i {
      color: var(--accent);
    }

    .page {
      max-width:100%;
      margin:0 auto;
      padding:0 20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
      margin-bottom: 24px;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { 
      display:grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap:18px; 
      padding:22px;
    }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(25,30,40,0.08);
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
    }
    .stat-label { 
      font-size:13px; 
      color:var(--muted); 
      letter-spacing:0.5px; 
      text-transform:uppercase; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-value { 
      font-size:26px; 
      font-weight:800; 
      margin-top:8px; 
      font-family: 'Segoe UI', system-ui;
    }
    .stat-change {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .positive-change { color: var(--success); }
    .negative-change { color: var(--danger); }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:12px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:2px solid var(--border-color); 
      padding:16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
      white-space: nowrap;
    }
    .transactions-table tbody td { 
      padding:16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: rgba(0,0,0,0.02); }
    [data-theme="dark"] .transactions-table tbody tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
    .transactions-table tbody tr.selected td { 
      background-color: rgba(111, 66, 193, 0.15);
      border-left: 3px solid var(--accent);
    }
    .transactions-table tbody tr:hover td {
      background-color: rgba(111, 66, 193, 0.05);
    }

    /* Badges */
    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(15, 122, 58, 0.3);
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(13, 202, 240, 0.3);
    }
    
    /* New badge styles */
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 5px;
    }
    
    .badge-tag {
      background-color: rgba(108, 117, 125, 0.15);
      color: var(--secondary);
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-right: 5px;
      margin-bottom: 2px;
      display: inline-block;
    }

    /* action buttons */
    .action-btn { 
      width:36px; 
      height:36px; 
      border-radius:8px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      color:white; 
      border:none;
      transition: all 0.2s;
    }
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-attach { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      padding-top:18px; 
      gap:10px;
      flex-wrap: wrap;
    }
    .pagination-info {
      color: var(--muted);
      font-size: 14px;
    }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; 
      right:30px; 
      bottom:30px; 
      width:62px; 
      height:62px; 
      border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      box-shadow:0 10px 30px rgba(70,34,173,0.2); 
      z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }
    
    /* New floating action menu */
    .floating-menu {
      position: fixed;
      right: 30px;
      bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1199;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      pointer-events: none;
    }
    
    .floating-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .floating-menu-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .floating-menu-btn:hover {
      background: var(--accent);
      color: white;
      transform: scale(1.1);
    }

    /* responsive */
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.mobile-show {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .top-cards { grid-template-columns: repeat(2,1fr); }
    }
    
    @media (max-width: 768px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .tm-header { 
        flex-direction:column; 
        align-items:flex-start; 
        gap:12px; 
        border-radius:14px 14px 0 0; 
      }
      .header-actions {
        flex-wrap: wrap;
      }
      .pagination-wrap {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* filters area inside content */
    .filters { 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin-bottom:20px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
      border-radius: 8px;
    }
    .filters .form-control:focus, .filters .form-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.15);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 200px;
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      border: 1px solid var(--border-color);
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 18px;
      font-family: 'Segoe UI', system-ui;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
      transition: color 0.2s;
    }
    .balance-toggle:hover {
      color: var(--accent);
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
      background: linear-gradient(90deg, var(--muted), var(--muted));
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
      border-radius: 4px;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
      border-radius: 8px;
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 10px 15px;
      background: var(--card-bg);
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      flex: 1;
      min-width: 200px;
    }
    .quick-stat i {
      font-size: 18px;
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: var(--bg-primary);
      position: relative;
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .remove-split:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    .split-summary {
      margin-top: 20px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 10px;
      font-weight: 600;
      border: 1px solid var(--border-color);
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      backdrop-filter: blur(3px);
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }
    
    /* Notification badge */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }
    
    /* Dashboard grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .dashboard-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }
    
    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .dashboard-card h5 {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: var(--text-primary);
    }
    
    /* Tags input */
    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      min-height: 42px;
      align-items: center;
    }
    
    .tag-item {
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .tag-remove {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tag-input {
      border: none;
      background: transparent;
      color: var(--text-primary);
      flex: 1;
      min-width: 100px;
    }
    
    .tag-input:focus {
      outline: none;
    }
    
    /* Recurring transaction indicator */
    .recurring-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--warning);
      color: #000;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Search highlight */
    .highlight {
      background-color: rgba(255, 235, 59, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    /* Mobile menu toggle */
    .mobile-menu-toggle {
      display: none;
      background: var(--accent);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
    }
    
    @media (max-width: 992px) {
      .mobile-menu-toggle {
        display: flex;
      }
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Tooltip styles */
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]:before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: rgba(0,0,0,0.8);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 1000;
      pointer-events: none;
    }
    
    [data-tooltip]:hover:before {
      opacity: 1;
      visibility: visible;
      bottom: calc(100% + 5px);
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
  </style>
</head>
<body>
  <!-- Loading Backdrop -->
  <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p id="backdropMessage">Loading...</p>
    </div>
  </div>
  
  <!-- Mobile Menu Toggle -->
  <button id="mobileMenuToggle" class="mobile-menu-toggle">
    <i class="fa fa-bars"></i>
  </button>
  
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h4><i class="fa fa-chart-line text-primary me-2"></i>Finance Manager</h4>
      </div>
      
      <div class="sidebar-user">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info">
          <h6 id="sidebarUsername">User</h6>
          <small id="userEmail">user@example.com</small>
        </div>
      </div>
      
      <ul class="sidebar-menu">
        <li>
          <a href="dashboard.html" class="active">
            <i class="fa fa-home"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="transactions.html">
            <i class="fa fa-exchange-alt"></i>
            <span>Transactions</span>
            <span class="ms-auto badge bg-primary" id="txCountBadge">0</span>
          </a>
        </li>
        <li>
          <a href="coa.html">
            <i class="fa fa-chart-pie"></i>
            <span>Chart of Accounts</span>
          </a>
        </li>
        <li>
          <a href="budgets.html">
            <i class="fa fa-wallet"></i>
            <span>Budgets</span>
            <span class="ms-auto badge bg-warning" id="budgetAlertBadge">0</span>
          </a>
        </li>
        <li>
          <a href="reports.html">
            <i class="fa fa-chart-bar"></i>
            <span>Reports</span>
          </a>
        </li>
        <li>
          <a href="recurring.html">
            <i class="fa fa-redo"></i>
            <span>Recurring</span>
            <span class="ms-auto badge bg-info" id="recurringCountBadge">0</span>
          </a>
        </li>
        <li>
          <a href="tags.html">
            <i class="fa fa-tags"></i>
            <span>Tags</span>
          </a>
        </li>
        <li>
          <a href="categories.html">
            <i class="fa fa-folder"></i>
            <span>Categories</span>
          </a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <small>Theme</small>
          <label class="toggle-switch">
            <input type="checkbox" id="themeToggleSwitch">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="d-grid">
          <button id="sidebarLogoutBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-sign-out-alt me-2"></i>Logout
          </button>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Page header -->
      <div class="page-header">
        <div>
          <h2 class="page-title"><i class="fa fa-money-bill-wave"></i> Transaction Manager</h2>
          <small class="text-muted">Manage all your financial transactions in one place</small>
        </div>
        <div class="header-actions">
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="fa fa-plus me-2"></i>New Transaction
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" id="newIncomeBtn"><i class="fa fa-arrow-down text-success me-2"></i>Income</a></li>
              <li><a class="dropdown-item" href="#" id="newExpenseBtn"><i class="fa fa-arrow-up text-danger me-2"></i>Expense</a></li>
              <li><a class="dropdown-item" href="#" id="newTransferBtn"><i class="fa fa-exchange-alt text-info me-2"></i>Transfer</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="newRecurringBtn"><i class="fa fa-redo text-warning me-2"></i>Recurring</a></li>
            </ul>
          </div>
          <button id="quickAddBtn" class="btn btn-outline-primary" data-tooltip="Quick Add">
            <i class="fa fa-bolt"></i>
          </button>
          <button id="importBtn" class="btn btn-outline-success" data-tooltip="Import">
            <i class="fa fa-file-import"></i>
          </button>
          <div class="export-buttons">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                <i class="fa fa-download"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="exportCSV"><i class="fa fa-file-csv me-2"></i>Export CSV</a></li>
                <li><a class="dropdown-item" href="#" id="exportPDF"><i class="fa fa-file-pdf me-2"></i>Export PDF</a></li>
                <li><a class="dropdown-item" href="#" id="exportExcel"><i class="fa fa-file-excel me-2"></i>Export Excel</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Quick stats -->
      <div class="quick-stats" id="quickStats">
        <!-- Will be populated dynamically -->
      </div>
      
      <!-- Dashboard Grid -->
      <div class="dashboard-grid" id="dashboardGrid">
        <!-- Will be populated based on user preferences -->
      </div>
      
      <!-- Main App Card -->
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-exchange-alt"></i> Recent Transactions</h2>
          <div class="header-actions">
            <button id="viewAllBtn" class="btn btn-light btn-sm">
              <i class="fa fa-list me-1"></i> View All
            </button>
            <button id="filterToggleBtn" class="btn btn-outline-light btn-sm">
              <i class="fa fa-filter me-1"></i> Filters
            </button>
            <div class="btn-group">
              <button id="balanceToggle" class="btn btn-outline-light btn-sm" data-tooltip="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
              <button id="refreshBtn" class="btn btn-outline-light btn-sm" data-tooltip="Refresh data">
                <i class="fa fa-sync-alt"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>

        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card">
            <div class="stat-label">
              Total Income
              <span class="stat-change positive-change" id="incomeChange">+0.0%</span>
            </div>
            <div id="statIncome" class="stat-value income-color balance-hidden">$0.00</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              Total Expenses
              <span class="stat-change negative-change" id="expenseChange">-0.0%</span>
            </div>
            <div id="statExpense" class="stat-value expense-color balance-hidden">$0.00</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              Current Balance
              <span class="stat-change" id="balanceChange">0.0%</span>
            </div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">All accounts</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              Transactions
              <span class="stat-change positive-change" id="countChange">+0.0%</span>
            </div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">Last 30 days</div>
          </div>
        </div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart">
          <!-- Chart will be rendered here -->
        </div>
        
        <!-- Bank balances section -->
        <div id="bankBalances" class="bank-balances">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Filters area -->
        <div id="filtersContainer" class="content-body" style="display: none;">
          <div class="filters mb-3">
            <select id="dateFilter" class="form-select form-select-sm">
              <option value="all">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
              <option value="custom">Custom Range</option>
              <option value="last7">Last 7 Days</option>
              <option value="last30">Last 30 Days</option>
              <option value="last90">Last 90 Days</option>
            </select>

            <div id="customRangeControls" style="display:none; display:flex; gap:8px; align-items:center;">
              <input id="startDate" type="date" class="form-control form-control-sm" />
              <span>to</span>
              <input id="endDate" type="date" class="form-control form-control-sm" />
            </div>

            <select id="typeFilter" class="form-select form-select-sm">
              <option value="all">All Types</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="transfer">Transfer</option>
              <option value="recurring">Recurring</option>
            </select>

            <!-- Bank Filter -->
            <select id="bankFilter" class="form-select form-select-sm">
              <option value="all">All Banks</option>
              <!-- Will be populated dynamically -->
            </select>
            
            <!-- Category Filter -->
            <select id="categoryFilter" class="form-select form-select-sm">
              <option value="all">All Categories</option>
              <!-- Will be populated dynamically -->
            </select>
            
            <!-- Tags Filter -->
            <select id="tagsFilter" class="form-select form-select-sm" multiple="multiple">
              <option value="all">All Tags</option>
              <!-- Will be populated dynamically -->
            </select>

            <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes..." />

            <button id="applyFiltersBtn" class="btn btn-sm btn-primary">
              <i class="fa fa-search me-1"></i> Apply
            </button>
            <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
            <button id="saveFilterBtn" class="btn btn-sm btn-outline-success">Save Filter</button>
          </div>
          
          <!-- Advanced filters -->
          <div id="advancedFilters" style="display: none;" class="filters mb-3">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label small">Min Amount</label>
                <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="0.00" step="0.01" />
              </div>
              <div class="col-md-3">
                <label class="form-label small">Max Amount</label>
                <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="0.00" step="0.01" />
              </div>
              <div class="col-md-3">
                <label class="form-label small">Sort By</label>
                <select id="sortBy" class="form-select form-select-sm">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="type">Type</option>
                  <option value="bank">Bank</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small">Show</label>
                <select id="pageSize" class="form-select form-select-sm">
                  <option value="10">10 per page</option>
                  <option value="25">25 per page</option>
                  <option value="50">50 per page</option>
                  <option value="100">100 per page</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Saved Filters -->
          <div id="savedFilters" style="display: none;" class="mb-3">
            <div class="d-flex align-items-center gap-2">
              <small class="text-muted">Saved Filters:</small>
              <div id="savedFiltersList" class="d-flex gap-2">
                <!-- Saved filters will appear here -->
              </div>
            </div>
          </div>
        </div>

        <!-- transactions table -->
        <div class="transactions-table">
          <table class="table mb-0">
            <thead>
              <tr>
                <th style="width:40px;">
                  <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                </th>
                <th style="width:120px;">Date</th>
                <th style="width:140px;">Category</th>
                <th>Description</th>
                <th style="width:100px;">Type</th>
                <th style="width:100px;">Ref #</th>
                <th style="width:120px;">Account</th>
                <th style="width:120px; text-align:right;">Amount</th>
                <th style="width:100px; text-align:right;">Balance</th>
                <th style="width:120px;">Tags</th>
                <th style="width:100px;">Status</th>
                <th style="width:150px;">Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <tr>
                <td colspan="12" class="text-center text-muted py-5">
                  <i class="fa fa-exchange-alt fa-2x mb-3 d-block"></i>
                  <h5>No transactions found</h5>
                  <p class="small">Add your first transaction to get started</p>
                  <button id="addFirstTransactionBtn" class="btn btn-primary btn-sm">
                    <i class="fa fa-plus me-1"></i>Add Transaction
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- pagination -->
        <div class="pagination-wrap mt-3" id="paginationControls">
          <div class="pagination-info" id="paginationInfo">Showing 0 of 0 transactions</div>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="paginationNav">
              <!-- Pagination will be generated here -->
            </ul>
          </nav>
        </div>
      </div>
      
      <!-- Additional dashboard cards -->
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h5><i class="fa fa-chart-pie text-info"></i> Spending by Category</h5>
          <div id="categoryChart" style="height: 250px;"></div>
        </div>
        <div class="dashboard-card">
          <h5><i class="fa fa-calendar text-success"></i> Upcoming Transactions</h5>
          <div id="upcomingTransactions" style="max-height: 250px; overflow-y: auto;">
            <!-- Upcoming transactions list -->
          </div>
        </div>
        <div class="dashboard-card">
          <h5><i class="fa fa-bell text-warning"></i> Recent Alerts</h5>
          <div id="recentAlerts" style="max-height: 250px; overflow-y: auto;">
            <!-- Alerts list -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Menu -->
  <div class="floating-menu" id="floatingMenu">
    <button class="floating-menu-btn" id="floatingSplit" data-tooltip="Split Transaction">
      <i class="fa fa-share-alt"></i>
    </button>
    <button class="floating-menu-btn" id="floatingDuplicate" data-tooltip="Duplicate">
      <i class="fa fa-copy"></i>
    </button>
    <button class="floating-menu-btn" id="floatingAttachment" data-tooltip="Add Attachment">
      <i class="fa fa-paperclip"></i>
    </button>
  </div>
  
  <!-- Floating Add Button -->
  <div class="floating-add" id="floatingAdd" data-tooltip="Add Transaction">
    <i class="fa fa-plus fa-lg"></i>
  </div>
  <!-- Modals Section -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">
            <i class="fa fa-exchange-alt me-2"></i>Add Transaction
          </h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <input type="hidden" id="txRecurring" value="false" />
            
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label required">Date</label>
                <input id="formDATE" type="date" class="form-control" required />
                <div class="form-text">Transaction date</div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Time</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label required">Transaction Type</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Reference #</label>
                <div class="input-group">
                  <input id="formSINO" type="text" class="form-control" placeholder="Auto-generated" />
                  <button type="button" class="btn btn-outline-secondary" id="generateRefBtn" data-tooltip="Generate new reference">
                    <i class="fa fa-redo"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label required">Category</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Category</option>
                  <!-- Will be populated from COA -->
                </select>
                <div class="form-text">Account header/category</div>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Bank Account</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank Account</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Transfer Account</label>
                <select id="formTRANSFERTO" class="form-select" style="display: none;">
                  <option value="">Select Destination Account</option>
                  <!-- Will be populated from COA -->
                </select>
                <div id="transferAccountHelp" class="form-text" style="display: none;">Select destination account for transfer</div>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label required">Amount</label>
                <div class="input-group">
                  <select id="formCURRENCY" class="form-select" style="max-width: 100px;">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="INR">INR</option>
                    <option value="JPY">JPY</option>
                  </select>
                  <input id="formAMOUNT" type="number" step="0.01" class="form-control" placeholder="0.00" required />
                </div>
                <div class="d-flex justify-content-between mt-1">
                  <button type="button" class="btn btn-sm btn-outline-primary" id="quickAmount100">$100</button>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="quickAmount500">$500</button>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="quickAmount1000">$1,000</button>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="quickAmountCustom">Custom</button>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tax Amount</label>
                <input id="formTAX" type="number" step="0.01" class="form-control" placeholder="0.00" />
                <div class="form-check mt-2">
                  <input type="checkbox" class="form-check-input" id="includeTax">
                  <label class="form-check-label small" for="includeTax">Include tax</label>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="reconciled">Reconciled</option>
                </select>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-8">
                <label class="form-label required">Description</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter transaction description" required></textarea>
                <div class="form-text">Describe what this transaction is for</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tags</label>
                <div class="tags-input" id="tagsInputContainer">
                  <input type="text" id="tagInput" class="tag-input" placeholder="Add tags..." />
                </div>
                <div class="mt-1">
                  <small class="text-muted">Press Enter to add tags</small>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes or details"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <div class="input-group mb-2">
                  <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.zip,.rar" />
                  <button class="btn btn-outline-secondary" type="button" id="clearAttachmentBtn">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <div id="attachmentPreview" class="mt-2">
                  <img id="attachmentImagePreview" class="attachment-preview" alt="Preview" />
                  <div id="attachmentInfo" class="small-muted mt-1"></div>
                </div>
              </div>
            </div>

            <!-- Recurring Transaction Options -->
            <div class="recurring-options mt-3" id="recurringOptions" style="display: none;">
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fa fa-redo me-2"></i>Recurring Transaction Settings</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Frequency</label>
                      <select id="formRECURRING_FREQ" class="form-select">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Start Date</label>
                      <input id="formRECURRING_START" type="date" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">End Date</label>
                      <input id="formRECURRING_END" type="date" class="form-control" />
                      <div class="form-check mt-2">
                        <input type="checkbox" class="form-check-input" id="noEndDate">
                        <label class="form-check-label small" for="noEndDate">No end date</label>
                      </div>
                    </div>
                  </div>
                  <div class="row g-3 mt-2">
                    <div class="col-md-6">
                      <label class="form-label">Occurrences</label>
                      <input id="formRECURRING_COUNT" type="number" class="form-control" placeholder="Number of occurrences" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Reminder</label>
                      <select id="formRECURRING_REMINDER" class="form-select">
                        <option value="none">No reminder</option>
                        <option value="1day">1 day before</option>
                        <option value="3days">3 days before</option>
                        <option value="1week">1 week before</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Transaction Tags -->
            <div class="row g-3 mt-2">
              <div class="col-md-12">
                <label class="form-label">Payment Method</label>
                <div class="d-flex flex-wrap gap-2">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCash" value="cash">
                    <label class="form-check-label" for="paymentCash">
                      <i class="fa fa-money-bill me-1"></i> Cash
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCard" value="card" checked>
                    <label class="form-check-label" for="paymentCard">
                      <i class="fa fa-credit-card me-1"></i> Card
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentBank" value="bank">
                    <label class="form-check-label" for="paymentBank">
                      <i class="fa fa-university me-1"></i> Bank Transfer
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentDigital" value="digital">
                    <label class="form-check-label" for="paymentDigital">
                      <i class="fa fa-mobile-alt me-1"></i> Digital Payment
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-outline-info" id="saveDraftBtn">
            <i class="fa fa-save me-1"></i>Save Draft
          </button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">
            <i class="fa fa-check me-1"></i>Save Transaction
          </button>
          <button type="button" id="saveAndNewBtn" class="btn btn-success">
            <i class="fa fa-plus me-1"></i>Save & New
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-bolt me-2"></i>Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Enter transaction in natural language:</label>
                <textarea id="quickAddInput" class="form-control" rows="4" placeholder="Examples:&#10; Add 500 to cash&#10; Spent 200 on petrol from SBI&#10; Received 1000 payment from client in AXIS&#10; Transfer 500 from SBI to HDFC&#10; Monthly rent 1200 paid via bank transfer&#10; Coffee 5.50 at Starbucks with cash"></textarea>
              </div>
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Date</label>
                  <input type="date" id="quickAddDate" class="form-control" value="">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Amount</label>
                  <input type="number" id="quickAddAmount" class="form-control" placeholder="0.00" step="0.01">
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light h-100">
                <div class="card-body">
                  <h6 class="card-title">Examples</h6>
                  <small class="text-muted">
                    <strong>Common formats:</strong><br><br>
                     <strong>Income:</strong><br>
                    &nbsp;&nbsp;"Received 500 from client"<br>
                    &nbsp;&nbsp;"Salary 3000 deposited"<br><br>
                     <strong>Expense:</strong><br>
                    &nbsp;&nbsp;"Spent 50 on groceries"<br>
                    &nbsp;&nbsp;"Paid 120 for electricity"<br><br>
                     <strong>Transfer:</strong><br>
                    &nbsp;&nbsp;"Transfer 1000 to savings"<br>
                    &nbsp;&nbsp;"Moved 500 between accounts"
                  </small>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <h6>Detected Information</h6>
            <div class="row g-2" id="quickAddPreview">
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <small class="text-muted">Type:</small>
                    <div id="quickAddType" class="fw-bold">-</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <small class="text-muted">Amount:</small>
                    <div id="quickAddAmountPreview" class="fw-bold">-</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <small class="text-muted">Account:</small>
                    <div id="quickAddAccount" class="fw-bold">-</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body py-2">
                    <small class="text-muted">Category:</small>
                    <div id="quickAddCategory" class="fw-bold">-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="quickAddParseBtn" class="btn btn-info">
            <i class="fa fa-magic me-1"></i>Parse
          </button>
          <button id="processQuickAddBtn" class="btn btn-primary">Add Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-share-alt me-2"></i>Split Income into Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Income Amount</label>
              <input id="splitIncomeAmount" type="number" step="0.01" class="form-control" placeholder="0.00" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Description</label>
              <input id="splitIncomeDescription" type="text" class="form-control" placeholder="Source of income" />
            </div>
          </div>
          
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Income Bank Account</label>
              <select id="splitIncomeBank" class="form-select">
                <option value="">Select Bank</option>
                <!-- Will be populated from COA -->
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Date</label>
              <input id="splitIncomeDate" type="date" class="form-control" />
            </div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
            <h6><i class="fa fa-outdent me-2"></i>Expense Transactions</h6>
            <div class="btn-group">
              <button type="button" id="addSplitExpenseBtn" class="btn btn-sm btn-primary">
                <i class="fa fa-plus me-1"></i> Add Expense
              </button>
              <button type="button" id="clearSplitExpensesBtn" class="btn btn-sm btn-outline-secondary">
                <i class="fa fa-trash me-1"></i> Clear All
              </button>
            </div>
          </div>
          
          <div id="splitExpensesContainer">
            <!-- Split expense items will be added here -->
          </div>
          
          <div id="splitSummary" class="split-summary mt-3">
            <!-- Summary will be updated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="previewSplitBtn" class="btn btn-outline-info">Preview</button>
          <button id="saveSplitTransactionsBtn" class="btn btn-primary">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-edit me-2"></i>Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Field to Update</label>
            <select id="bulkEditField" class="form-select">
              <option value="BANK_NAME">Bank Account</option>
              <option value="ACCOUNT_HEADER">Category</option>
              <option value="TYPE">Transaction Type</option>
              <option value="STATUS">Status</option>
              <option value="CURRENCY">Currency</option>
              <option value="TAGS">Tags</option>
              <option value="NOTES">Notes</option>
            </select>
          </div>
          <div class="mb-3" id="bulkEditValueContainer">
            <label class="form-label">New Value</label>
            <input id="bulkEditValue" type="text" class="form-control" placeholder="Enter new value" />
          </div>
          <div class="mb-3" id="bulkEditTagsContainer" style="display: none;">
            <label class="form-label">Tags</label>
            <div class="tags-input">
              <input type="text" id="bulkTagInput" class="tag-input" placeholder="Add tags..." />
            </div>
            <small class="text-muted">Select action:</small>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="tagAction" id="tagActionAdd" value="add" checked>
              <label class="form-check-label" for="tagActionAdd">Add tags</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="tagAction" id="tagActionReplace" value="replace">
              <label class="form-check-label" for="tagActionReplace">Replace all tags</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="tagAction" id="tagActionRemove" value="remove">
              <label class="form-check-label" for="tagActionRemove">Remove tags</label>
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            <small>This will update <span id="bulkEditCount" class="fw-bold">0</span> selected transactions.</small>
          </div>
          <div class="alert alert-warning" id="bulkEditWarning">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <small>Warning: This action cannot be undone.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkEditBtn" class="btn btn-primary">Update Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal fade" id="bulkTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-tags me-2"></i>Add Tags to Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Select Tags</label>
            <select id="bulkTagSelect" class="form-select" multiple>
              <!-- Tags will be populated here -->
            </select>
            <div class="form-text">Hold Ctrl/Cmd to select multiple tags</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Or Create New Tags</label>
            <div class="tags-input">
              <input type="text" id="newBulkTagInput" class="tag-input" placeholder="Enter new tags, separated by commas" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Action</label>
            <select id="bulkTagAction" class="form-select">
              <option value="add">Add tags (keep existing)</option>
              <option value="replace">Replace all tags</option>
              <option value="remove">Remove selected tags</option>
            </select>
          </div>
          <div class="alert alert-info">
            <small>This will affect <span id="bulkTagCount" class="fw-bold">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkTagBtn" class="btn btn-primary">Apply Tags</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Transactions Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-file-import me-2"></i>Import Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Select File</label>
                <input type="file" id="importFile" class="form-control" accept=".csv,.xlsx,.xls,.json" />
                <div class="form-text">Supported formats: CSV, Excel, JSON</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Import Mode</label>
                <select id="importMode" class="form-select">
                  <option value="add">Add new transactions only</option>
                  <option value="replace">Replace all transactions</option>
                  <option value="update">Update existing and add new</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">File Format</label>
                <select id="importFormat" class="form-select">
                  <option value="auto">Auto-detect</option>
                  <option value="csv">CSV (Comma separated)</option>
                  <option value="excel">Excel</option>
                  <option value="json">JSON</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0">File Requirements</h6>
                </div>
                <div class="card-body">
                  <small class="text-muted">
                    <strong>CSV Format:</strong><br>
                     Must contain: Date, Description, Amount<br>
                     Optional: Category, Bank, Type, Notes<br><br>
                    <strong>Excel Format:</strong><br>
                     First row should be headers<br>
                     Date format: YYYY-MM-DD<br><br>
                    <strong>Sample CSV:</strong><br>
                    <code>Date,Description,Amount,Type<br>
                    2024-01-15,Grocery Shopping,150.50,Expense<br>
                    2024-01-16,Salary Deposit,3000.00,Income</code>
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-3" id="importMapping" style="display: none;">
            <h6>Column Mapping</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>File Column</th>
                    <th>Map To</th>
                    <th>Sample Data</th>
                  </tr>
                </thead>
                <tbody id="importMappingBody">
                  <!-- Will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="mt-3" id="importPreview" style="display: none;">
            <h6>Preview (First 5 rows)</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead id="importPreviewHeader">
                  <!-- Will be populated dynamically -->
                </thead>
                <tbody id="importPreviewBody">
                  <!-- Will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="mt-3" id="importProgress" style="display: none;">
            <div class="progress" style="height: 25px;">
              <div id="importProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div class="text-center mt-2">
              <span id="importStatus">Processing...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="importMappingBtn" class="btn btn-info" style="display: none;">
            <i class="fa fa-cog me-1"></i>Configure Mapping
          </button>
          <button id="importProcessBtn" class="btn btn-primary">
            <i class="fa fa-upload me-1"></i>Import
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-download me-2"></i>Export Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Export Format</label>
            <select id="exportFormat" class="form-select">
              <option value="csv">CSV (Comma Separated Values)</option>
              <option value="excel">Excel (XLSX)</option>
              <option value="json">JSON</option>
              <option value="pdf">PDF Report</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Date Range</label>
            <select id="exportDateRange" class="form-select">
              <option value="all">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div class="row g-2 mb-3" id="exportCustomRange" style="display: none;">
            <div class="col">
              <input type="date" id="exportStartDate" class="form-control form-control-sm" />
            </div>
            <div class="col-auto">
              <span>to</span>
            </div>
            <div class="col">
              <input type="date" id="exportEndDate" class="form-control form-control-sm" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Include Columns</label>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportDate" checked>
                  <label class="form-check-label" for="exportDate">Date</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportDescription" checked>
                  <label class="form-check-label" for="exportDescription">Description</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportAmount" checked>
                  <label class="form-check-label" for="exportAmount">Amount</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportType" checked>
                  <label class="form-check-label" for="exportType">Type</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportCategory">
                  <label class="form-check-label" for="exportCategory">Category</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportBank">
                  <label class="form-check-label" for="exportBank">Bank</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportTags">
                  <label class="form-check-label" for="exportTags">Tags</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="exportNotes">
                  <label class="form-check-label" for="exportNotes">Notes</label>
                </div>
              </div>
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            <small>Exporting <span id="exportCount" class="fw-bold">0</span> transactions matching current filters.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmExportBtn" class="btn btn-primary">Export</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-paperclip me-2"></i>Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="attachmentModalBody">
          <!-- filled dynamically -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a id="downloadAttachmentBtn" class="btn btn-primary" download>
            <i class="fa fa-download me-1"></i>Download
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="fa fa-exclamation-triangle fa-3x text-warning"></i>
          </div>
          <h5>Delete Transaction</h5>
          <p class="text-muted">Are you sure you want to delete this transaction?</p>
          <div class="alert alert-warning small" id="deleteWarning">
            <i class="fa fa-exclamation-circle me-1"></i>
            This action cannot be undone.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirm -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="fa fa-trash fa-3x text-danger"></i>
          </div>
          <h5>Delete Transactions</h5>
          <p class="text-muted">Are you sure you want to delete <span id="bulkDeleteCount" class="fw-bold">0</span> selected transactions?</p>
          <div class="alert alert-danger small">
            <i class="fa fa-exclamation-circle me-1"></i>
            This action cannot be undone. All selected transactions will be permanently deleted.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkDeleteBtn" class="btn btn-danger">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage" class="mb-0">Processing transaction...</p>
          <div class="progress mt-3" id="loadingProgress" style="display: none;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="loadingProgressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Alert Modal -->
  <div class="modal fade" id="budgetAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-exclamation-triangle text-warning me-2"></i>Budget Alert</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="budgetAlertContent">
            <!-- Alerts will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Dismiss</button>
          <button class="btn btn-primary" data-bs-dismiss="modal">View Budgets</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction Details Modal -->
  <div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-info-circle me-2"></i>Transaction Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <h4 id="detailDescription">-</h4>
                <div class="d-flex gap-2 align-items-center">
                  <span id="detailTypeBadge" class="badge-income">Income</span>
                  <span id="detailStatusBadge" class="badge bg-secondary">Completed</span>
                  <span id="detailRecurringBadge" class="badge-recurring" style="display: none;">Recurring</span>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="text-muted small">Amount</label>
                  <div class="h4" id="detailAmount">$0.00</div>
                </div>
                <div class="col-md-4">
                  <label class="text-muted small">Date</label>
                  <div class="h5" id="detailDate">-</div>
                </div>
                <div class="col-md-4">
                  <label class="text-muted small">Ref #</label>
                  <div class="h5" id="detailRef">-</div>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="text-muted small">Category</label>
                <div id="detailCategory">-</div>
              </div>
              
              <div class="mb-3">
                <label class="text-muted small">Bank Account</label>
                <div id="detailBank">-</div>
              </div>
              
              <div class="mb-3">
                <label class="text-muted small">Notes</label>
                <div id="detailNotes" class="p-3 bg-light rounded">No notes</div>
              </div>
              
              <div class="mb-3">
                <label class="text-muted small">Tags</label>
                <div id="detailTags">
                  <span class="badge-tag">No tags</span>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Transaction Info</h6>
                </div>
                <div class="card-body">
                  <div class="mb-2">
                    <small class="text-muted">Created:</small>
                    <div id="detailCreated">-</div>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">Last Updated:</small>
                    <div id="detailUpdated">-</div>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">Payment Method:</small>
                    <div id="detailPaymentMethod">-</div>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">Currency:</small>
                    <div id="detailCurrency">-</div>
                  </div>
                  <div class="mb-2">
                    <small class="text-muted">Tax:</small>
                    <div id="detailTax">$0.00</div>
                  </div>
                </div>
              </div>
              
              <div class="mt-3">
                <button class="btn btn-outline-primary w-100 mb-2" id="detailEditBtn">
                  <i class="fa fa-edit me-2"></i>Edit Transaction
                </button>
                <button class="btn btn-outline-secondary w-100 mb-2" id="detailDuplicateBtn">
                  <i class="fa fa-copy me-2"></i>Duplicate
                </button>
                <button class="btn btn-outline-info w-100 mb-2" id="detailAttachmentBtn">
                  <i class="fa fa-paperclip me-2"></i>View Attachment
                </button>
                <button class="btn btn-outline-danger w-100" id="detailDeleteBtn">
                  <i class="fa fa-trash me-2"></i>Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-cog me-2"></i>Settings</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="settingsTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#generalSettings">
                <i class="fa fa-sliders-h me-1"></i>General
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#displaySettings">
                <i class="fa fa-desktop me-1"></i>Display
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notificationSettings">
                <i class="fa fa-bell me-1"></i>Notifications
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dataSettings">
                <i class="fa fa-database me-1"></i>Data
              </button>
            </li>
          </ul>
          
          <div class="tab-content">
            <!-- General Settings -->
            <div class="tab-pane fade show active" id="generalSettings">
              <div class="mb-3">
                <label class="form-label">Default Currency</label>
                <select id="settingCurrency" class="form-select">
                  <option value="USD">US Dollar (USD)</option>
                  <option value="EUR">Euro (EUR)</option>
                  <option value="GBP">British Pound (GBP)</option>
                  <option value="JPY">Japanese Yen (JPY)</option>
                  <option value="INR">Indian Rupee (INR)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Default Transaction Type</label>
                <select id="settingDefaultType" class="form-select">
                  <option value="Expense">Expense</option>
                  <option value="Income">Income</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Default Bank Account</label>
                <select id="settingDefaultBank" class="form-select">
                  <option value="">Select default bank</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Date Format</label>
                <select id="settingDateFormat" class="form-select">
                  <option value="YYYY-MM-DD">YYYY-MM-DD (2024-01-15)</option>
                  <option value="MM/DD/YYYY">MM/DD/YYYY (01/15/2024)</option>
                  <option value="DD/MM/YYYY">DD/MM/YYYY (15/01/2024)</option>
                  <option value="Month D, YYYY">Month D, YYYY (Jan 15, 2024)</option>
                </select>
              </div>
            </div>
            
            <!-- Display Settings -->
            <div class="tab-pane fade" id="displaySettings">
              <div class="mb-3">
                <label class="form-label">Theme</label>
                <select id="settingTheme" class="form-select">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                  <option value="auto">Auto (System)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Transactions per page</label>
                <select id="settingPageSize" class="form-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingCompactView">
                  <label class="form-check-label" for="settingCompactView">Compact table view</label>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingShowCharts">
                  <label class="form-check-label" for="settingShowCharts">Show charts on dashboard</label>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingShowBalances" checked>
                  <label class="form-check-label" for="settingShowBalances">Show balances by default</label>
                </div>
                <div class="form-text">Toggle whether balances are visible when page loads</div>
              </div>
            </div>
            
            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notificationSettings">
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingNotifyLargeTx">
                  <label class="form-check-label" for="settingNotifyLargeTx">Notify on large transactions</label>
                </div>
                <div class="input-group mt-1" style="max-width: 200px;">
                  <span class="input-group-text">Above</span>
                  <input type="number" id="settingLargeTxAmount" class="form-control" value="1000" step="100">
                  <span class="input-group-text">USD</span>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingNotifyBudget">
                  <label class="form-check-label" for="settingNotifyBudget">Notify when approaching budget limits</label>
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingNotifyRecurring">
                  <label class="form-check-label" for="settingNotifyRecurring">Notify for upcoming recurring transactions</label>
                </div>
                <div class="input-group mt-1" style="max-width: 200px;">
                  <span class="input-group-text">Days before</span>
                  <input type="number" id="settingRecurringNotifyDays" class="form-control" value="3" min="1" max="30">
                </div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="settingEmailReports">
                  <label class="form-check-label" for="settingEmailReports">Email weekly/monthly reports</label>
                </div>
              </div>
            </div>
            
            <!-- Data Settings -->
            <div class="tab-pane fade" id="dataSettings">
              <div class="alert alert-warning">
                <i class="fa fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> These actions are irreversible. Make sure to backup your data first.
              </div>
              
              <div class="mb-3">
                <button class="btn btn-outline-primary w-100 mb-2" id="backupDataBtn">
                  <i class="fa fa-download me-2"></i>Backup All Data
                </button>
                <div class="form-text">Download a complete backup of all your transactions and settings</div>
              </div>
              
              <div class="mb-3">
                <button class="btn btn-outline-danger w-100 mb-2" id="clearAllDataBtn">
                  <i class="fa fa-trash me-2"></i>Clear All Transactions
                </button>
                <div class="form-text">Permanently delete all transactions. This cannot be undone.</div>
              </div>
              
              <div class="mb-3">
                <button class="btn btn-outline-secondary w-100 mb-2" id="exportSettingsBtn">
                  <i class="fa fa-cog me-2"></i>Export Settings
                </button>
                <div class="form-text">Export your application settings</div>
              </div>
              
              <div class="mb-3">
                <button class="btn btn-outline-info w-100" id="importSettingsBtn">
                  <i class="fa fa-upload me-2"></i>Import Settings
                </button>
                <div class="form-text">Import settings from a backup file</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Preview Modal -->
  <div class="modal fade" id="splitPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-eye me-2"></i>Preview Split Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            This will create the following transactions:
          </div>
          
          <div class="mb-3">
            <h6>Income Transaction</h6>
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <small class="text-muted">Amount</small>
                    <div id="previewIncomeAmount" class="fw-bold">$0.00</div>
                  </div>
                  <div class="col-md-4">
                    <small class="text-muted">Description</small>
                    <div id="previewIncomeDesc" class="fw-bold">-</div>
                  </div>
                  <div class="col-md-3">
                    <small class="text-muted">Bank</small>
                    <div id="previewIncomeBank" class="fw-bold">-</div>
                  </div>
                  <div class="col-md-2">
                    <small class="text-muted">Date</small>
                    <div id="previewIncomeDate" class="fw-bold">-</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <h6>Expense Transactions</h6>
          <div id="previewExpensesList">
            <!-- Expense previews will be added here -->
          </div>
          
          <div class="alert alert-warning mt-3" id="previewWarning" style="display: none;">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <span id="previewWarningText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmSplitSaveBtn" class="btn btn-primary">Confirm and Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recurring Transaction Modal -->
  <div class="modal fade" id="recurringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-redo me-2"></i>Create Recurring Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            This will create a template for transactions that repeat automatically.
          </div>
          
          <form id="recurringForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Transaction Template</label>
                <select id="recurringTemplate" class="form-select">
                  <option value="">Create new template</option>
                  <option value="rent">Rent/Mortgage</option>
                  <option value="salary">Salary</option>
                  <option value="utility">Utility Bills</option>
                  <option value="subscription">Subscriptions</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Template Name</label>
                <input type="text" id="recurringName" class="form-control" placeholder="e.g., Monthly Rent" />
              </div>
            </div>
            
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Frequency</label>
                <select id="recurringFrequency" class="form-select">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="biweekly">Bi-Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" id="recurringStartDate" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" id="recurringEndDate" class="form-control" />
                <div class="form-check mt-2">
                  <input type="checkbox" class="form-check-input" id="recurringNoEnd">
                  <label class="form-check-label small" for="recurringNoEnd">No end date</label>
                </div>
              </div>
            </div>
            
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Transaction Type</label>
                <select id="recurringType" class="form-select">
                  <option value="Expense">Expense</option>
                  <option value="Income">Income</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Amount</label>
                <input type="number" id="recurringAmount" class="form-control" step="0.01" placeholder="0.00" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Category</label>
                <select id="recurringCategory" class="form-select">
                  <option value="">Select category</option>
                </select>
              </div>
            </div>
            
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label">Description</label>
                <input type="text" id="recurringDescription" class="form-control" placeholder="Transaction description" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Bank Account</label>
                <select id="recurringBank" class="form-select">
                  <option value="">Select bank</option>
                </select>
              </div>
            </div>
            
            <div class="mt-3">
              <label class="form-label">Additional Settings</label>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="recurringAutoCreate">
                <label class="form-check-label" for="recurringAutoCreate">Automatically create transactions</label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="recurringNotify">
                <label class="form-check-label" for="recurringNotify">Send notification before due date</label>
              </div>
              <div class="row g-2 mt-2" id="recurringNotifySettings" style="display: none;">
                <div class="col-md-6">
                  <label class="form-label small">Days before</label>
                  <input type="number" id="recurringNotifyDays" class="form-control" value="3" min="1" max="30" />
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <h6>Preview</h6>
              <div class="card bg-light">
                <div class="card-body">
                  <div id="recurringPreview">
                    No preview available. Fill in the details to see a preview.
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveRecurringBtn" class="btn btn-primary">Save Recurring Template</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-folder me-2"></i>Manage Categories</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="input-group">
              <input type="text" id="newCategoryInput" class="form-control" placeholder="New category name" />
              <button class="btn btn-primary" id="addCategoryBtn">Add</button>
            </div>
          </div>
          
          <div class="mb-3">
            <h6>Existing Categories</h6>
            <div id="categoriesList" style="max-height: 300px; overflow-y: auto;">
              <!-- Categories will be listed here -->
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            <small>Categories are synced with your Chart of Accounts.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="syncCategoriesBtn" class="btn btn-outline-primary">Sync with COA</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Management Modal -->
  <div class="modal fade" id="tagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa fa-tags me-2"></i>Manage Tags</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" id="newTagInput" class="form-control" placeholder="New tag name" />
                  <button class="btn btn-primary" id="addTagBtn">Add</button>
                </div>
              </div>
              
              <div class="mb-3">
                <h6>Existing Tags</h6>
                <div id="tagsList" style="max-height: 300px; overflow-y: auto;">
                  <!-- Tags will be listed here -->
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Tag Colors</h6>
                  <div class="d-flex flex-wrap gap-2" id="tagColors">
                    <span class="badge bg-primary" data-color="primary">Primary</span>
                    <span class="badge bg-secondary" data-color="secondary">Secondary</span>
                    <span class="badge bg-success" data-color="success">Success</span>
                    <span class="badge bg-danger" data-color="danger">Danger</span>
                    <span class="badge bg-warning text-dark" data-color="warning">Warning</span>
                    <span class="badge bg-info" data-color="info">Info</span>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Click to set tag color</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            <small>Tags help you organize and filter transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="applyTagColorsBtn" class="btn btn-primary">Apply Colors</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Welcome Modal -->
  <div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-5">
          <div class="mb-4">
            <i class="fa fa-chart-line fa-4x text-primary mb-3"></i>
            <h2>Welcome to Finance Manager!</h2>
            <p class="text-muted">Let's set up your account to get started.</p>
          </div>
          
          <div class="row text-start mb-4">
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body text-center">
                  <i class="fa fa-exchange-alt fa-2x text-primary mb-3"></i>
                  <h5>Add Transactions</h5>
                  <p class="small">Start by adding your first transaction</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body text-center">
                  <i class="fa fa-wallet fa-2x text-success mb-3"></i>
                  <h5>Set Up Accounts</h5>
                  <p class="small">Add your bank accounts and categories</p>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body text-center">
                  <i class="fa fa-chart-pie fa-2x text-info mb-3"></i>
                  <h5>Track Finances</h5>
                  <p class="small">Monitor your income, expenses, and budgets</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <h5>Quick Setup Options</h5>
            <div class="d-flex justify-content-center gap-3 mt-3">
              <button class="btn btn-outline-primary" id="quickSetupSkip">Skip Setup</button>
              <button class="btn btn-primary" id="quickSetupStart">Start Guided Setup</button>
              <button class="btn btn-success" id="quickSetupImport">Import Data</button>
            </div>
          </div>
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="dontShowAgain">
            <label class="form-check-label" for="dontShowAgain">
              Don't show this welcome screen again
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Guided Setup Modal -->
  <div class="modal fade" id="guidedSetupModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="setupStepTitle">Step 1: Add Your First Bank Account</h5>
        </div>
        <div class="modal-body">
          <div class="setup-progress mb-4">
            <div class="progress" style="height: 8px;">
              <div id="setupProgressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span id="setupStepText">Step 1 of 5</span>
              <span id="setupPercent">0%</span>
            </div>
          </div>
          
          <div id="setupStepContent">
            <!-- Setup steps will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" id="setupPrevBtn" disabled>Previous</button>
          <button class="btn btn-primary" id="setupNextBtn">Next</button>
          <button class="btn btn-outline-primary" id="setupSkipBtn" style="display: none;">Skip</button>
        </div>
      </div>
    </div>
  </div>
  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit, writeBatch, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global state
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    let rowsPerPage = 10;
    let txToDelete = null;
    let balanceVisible = false;
    let isSubmitting = false;
    let lastVoucherNumber = 0;
    let currentTheme = 'light';
    let transactionsChartInstance = null;
    let selectedTransactions = new Set();
    let hasLoadedSavedState = false;
    let isFirstVisit = true;
    let userSettings = {};
    
    // COA data
    let coaAccounts = [];
    let coaBanks = [];
    let availableTags = [];
    let userCategories = [];
    let recurringTemplates = [];
    
    // DOM references
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const sidebarUsername = document.getElementById("sidebarUsername");
    const userEmail = document.getElementById("userEmail");
    const userAvatar = document.getElementById("userAvatar");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const sidebarLogoutBtn = document.getElementById("sidebarLogoutBtn");
    const mobileMenuToggle = document.getElementById("mobileMenuToggle");
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("mainContent");
    
    // Buttons
    const newIncomeBtn = document.getElementById("newIncomeBtn");
    const newExpenseBtn = document.getElementById("newExpenseBtn");
    const newTransferBtn = document.getElementById("newTransferBtn");
    const newRecurringBtn = document.getElementById("newRecurringBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const importBtn = document.getElementById("importBtn");
    const floatingAdd = document.getElementById("floatingAdd");
    const floatingSplit = document.getElementById("floatingSplit");
    const floatingDuplicate = document.getElementById("floatingDuplicate");
    const floatingAttachment = document.getElementById("floatingAttachment");
    const floatingMenu = document.getElementById("floatingMenu");
    
    // Balance toggle
    const balanceToggle = document.getElementById("balanceToggle");
    const themeToggleSwitch = document.getElementById("themeToggleSwitch");
    
    // Export/Import
    const exportCSV = document.getElementById("exportCSV");
    const exportPDF = document.getElementById("exportPDF");
    const exportExcel = document.getElementById("exportExcel");
    
    // Filters
    const filterToggleBtn = document.getElementById("filterToggleBtn");
    const filtersContainer = document.getElementById("filtersContainer");
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const tagsFilter = document.getElementById("tagsFilter");
    const searchDesc = document.getElementById("searchDesc");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const saveFilterBtn = document.getElementById("saveFilterBtn");
    const savedFilters = document.getElementById("savedFilters");
    const savedFiltersList = document.getElementById("savedFiltersList");
    const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
    const advancedFilters = document.getElementById("advancedFilters");
    const minAmount = document.getElementById("minAmount");
    const maxAmount = document.getElementById("maxAmount");
    const sortBy = document.getElementById("sortBy");
    const pageSize = document.getElementById("pageSize");
    
    // Table elements
    const transactionsTableBody = document.getElementById("transactionsTableBody");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const addFirstTransactionBtn = document.getElementById("addFirstTransactionBtn");
    
    // Pagination
    const paginationControls = document.getElementById("paginationControls");
    const paginationInfo = document.getElementById("paginationInfo");
    const paginationNav = document.getElementById("paginationNav");
    
    // Stats elements
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");
    const incomeChange = document.getElementById("incomeChange");
    const expenseChange = document.getElementById("expenseChange");
    const balanceChange = document.getElementById("balanceChange");
    const countChange = document.getElementById("countChange");
    
    // Dashboard elements
    const bankBalancesContainer = document.getElementById("bankBalances");
    const quickStatsContainer = document.getElementById("quickStats");
    const dashboardGrid = document.getElementById("dashboardGrid");
    const transactionsChart = document.getElementById("transactionsChart");
    const categoryChart = document.getElementById("categoryChart");
    const upcomingTransactions = document.getElementById("upcomingTransactions");
    const recentAlerts = document.getElementById("recentAlerts");
    
    // Bulk actions
    const bulkActions = document.getElementById("bulkActions");
    const selectedCount = document.getElementById("selectedCount");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkEditBtn = document.getElementById("bulkEditBtn");
    const bulkTagBtn = document.getElementById("bulkTagBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const selectAllBtn = document.querySelector("button[onclick*='selectAll']");
    const deselectAllBtn = document.querySelector("button[onclick*='deselectAll']");
    
    // Modals
    const transactionModalEl = document.getElementById("transactionModal");
    const transactionModal = new bootstrap.Modal(transactionModalEl);
    const quickAddModalEl = document.getElementById("quickAddModal");
    const quickAddModal = new bootstrap.Modal(quickAddModalEl);
    const splitIncomeModalEl = document.getElementById("splitIncomeModal");
    const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
    const bulkEditModalEl = document.getElementById("bulkEditModal");
    const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
    const bulkTagModalEl = document.getElementById("bulkTagModal");
    const bulkTagModal = new bootstrap.Modal(bulkTagModalEl);
    const importModalEl = document.getElementById("importModal");
    const importModal = new bootstrap.Modal(importModalEl);
    const exportModalEl = document.getElementById("exportModal");
    const exportModal = new bootstrap.Modal(exportModalEl);
    const attachmentModalEl = document.getElementById("attachmentModal");
    const attachmentModal = new bootstrap.Modal(attachmentModalEl);
    const confirmDeleteModalEl = document.getElementById("confirmDeleteModal");
    const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
    const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
    const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
    const loadingModalEl = document.getElementById("loadingModal");
    const loadingModal = new bootstrap.Modal(loadingModalEl);
    const budgetAlertModalEl = document.getElementById("budgetAlertModal");
    const budgetAlertModal = new bootstrap.Modal(budgetAlertModalEl);
    const transactionDetailsModalEl = document.getElementById("transactionDetailsModal");
    const transactionDetailsModal = new bootstrap.Modal(transactionDetailsModalEl);
    const settingsModalEl = document.getElementById("settingsModal");
    const settingsModal = new bootstrap.Modal(settingsModalEl);
    const splitPreviewModalEl = document.getElementById("splitPreviewModal");
    const splitPreviewModal = new bootstrap.Modal(splitPreviewModalEl);
    const recurringModalEl = document.getElementById("recurringModal");
    const recurringModal = new bootstrap.Modal(recurringModalEl);
    const categoryModalEl = document.getElementById("categoryModal");
    const categoryModal = new bootstrap.Modal(categoryModalEl);
    const tagModalEl = document.getElementById("tagModal");
    const tagModal = new bootstrap.Modal(tagModalEl);
    const welcomeModalEl = document.getElementById("welcomeModal");
    const welcomeModal = new bootstrap.Modal(welcomeModalEl);
    const guidedSetupModalEl = document.getElementById("guidedSetupModal");
    const guidedSetupModal = new bootstrap.Modal(guidedSetupModalEl);
    
    // Transaction form elements
    const form = document.getElementById("transactionForm");
    const txIdInput = document.getElementById("txId");
    const txRecurringInput = document.getElementById("txRecurring");
    const formDATE = document.getElementById("formDATE");
    const formTIME = document.getElementById("formTIME");
    const formSINO = document.getElementById("formSINO");
    const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formTRANSFERTO = document.getElementById("formTRANSFERTO");
    const formTYPE = document.getElementById("formTYPE");
    const formAMOUNT = document.getElementById("formAMOUNT");
    const formCURRENCY = document.getElementById("formCURRENCY");
    const formTAX = document.getElementById("formTAX");
    const formSTATUS = document.getElementById("formSTATUS");
    const formDESCRIPTION = document.getElementById("formDESCRIPTION");
    const formNOTES = document.getElementById("formNOTES");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentInfo = document.getElementById("attachmentInfo");
    const includeTimeCheckbox = document.getElementById("includeTime");
    const includeTax = document.getElementById("includeTax");
    const tagsInputContainer = document.getElementById("tagsInputContainer");
    const tagInput = document.getElementById("tagInput");
    const clearAttachmentBtn = document.getElementById("clearAttachmentBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadProgressBar = document.getElementById("uploadProgressBar");
    const saveTransactionBtn = document.getElementById("saveTransactionBtn");
    const saveDraftBtn = document.getElementById("saveDraftBtn");
    const saveAndNewBtn = document.getElementById("saveAndNewBtn");
    const generateRefBtn = document.getElementById("generateRefBtn");
    const recurringOptions = document.getElementById("recurringOptions");
    
    // Quick amount buttons
    const quickAmount100 = document.getElementById("quickAmount100");
    const quickAmount500 = document.getElementById("quickAmount500");
    const quickAmount1000 = document.getElementById("quickAmount1000");
    const quickAmountCustom = document.getElementById("quickAmountCustom");
    
    // Quick Add elements
    const quickAddInput = document.getElementById("quickAddInput");
    const quickAddDate = document.getElementById("quickAddDate");
    const quickAddAmount = document.getElementById("quickAddAmount");
    const quickAddParseBtn = document.getElementById("quickAddParseBtn");
    const processQuickAddBtn = document.getElementById("processQuickAddBtn");
    const quickAddType = document.getElementById("quickAddType");
    const quickAddAmountPreview = document.getElementById("quickAddAmountPreview");
    const quickAddAccount = document.getElementById("quickAddAccount");
    const quickAddCategory = document.getElementById("quickAddCategory");
    
    // Split income elements
    const splitIncomeAmount = document.getElementById("splitIncomeAmount");
    const splitIncomeDescription = document.getElementById("splitIncomeDescription");
    const splitIncomeBank = document.getElementById("splitIncomeBank");
    const splitIncomeDate = document.getElementById("splitIncomeDate");
    const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
    const clearSplitExpensesBtn = document.getElementById("clearSplitExpensesBtn");
    const splitExpensesContainer = document.getElementById("splitExpensesContainer");
    const splitSummary = document.getElementById("splitSummary");
    const previewSplitBtn = document.getElementById("previewSplitBtn");
    const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
    
    // Bulk edit elements
    const bulkEditField = document.getElementById("bulkEditField");
    const bulkEditValue = document.getElementById("bulkEditValue");
    const bulkEditValueContainer = document.getElementById("bulkEditValueContainer");
    const bulkEditTagsContainer = document.getElementById("bulkEditTagsContainer");
    const bulkTagInput = document.getElementById("bulkTagInput");
    const bulkEditCount = document.getElementById("bulkEditCount");
    const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
    const bulkDeleteCount = document.getElementById("bulkDeleteCount");
    const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
    
    // Import/Export elements
    const importFile = document.getElementById("importFile");
    const importMode = document.getElementById("importMode");
    const importFormat = document.getElementById("importFormat");
    const importMapping = document.getElementById("importMapping");
    const importMappingBody = document.getElementById("importMappingBody");
    const importPreview = document.getElementById("importPreview");
    const importPreviewHeader = document.getElementById("importPreviewHeader");
    const importPreviewBody = document.getElementById("importPreviewBody");
    const importProgress = document.getElementById("importProgress");
    const importProgressBar = document.getElementById("importProgressBar");
    const importStatus = document.getElementById("importStatus");
    const importMappingBtn = document.getElementById("importMappingBtn");
    const importProcessBtn = document.getElementById("importProcessBtn");
    
    const exportFormat = document.getElementById("exportFormat");
    const exportDateRange = document.getElementById("exportDateRange");
    const exportCustomRange = document.getElementById("exportCustomRange");
    const exportStartDate = document.getElementById("exportStartDate");
    const exportEndDate = document.getElementById("exportEndDate");
    const exportCount = document.getElementById("exportCount");
    const confirmExportBtn = document.getElementById("confirmExportBtn");
    
    // Settings elements
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const backupDataBtn = document.getElementById("backupDataBtn");
    const clearAllDataBtn = document.getElementById("clearAllDataBtn");
    const exportSettingsBtn = document.getElementById("exportSettingsBtn");
    const importSettingsBtn = document.getElementById("importSettingsBtn");
    
    // Welcome/Setup elements
    const quickSetupSkip = document.getElementById("quickSetupSkip");
    const quickSetupStart = document.getElementById("quickSetupStart");
    const quickSetupImport = document.getElementById("quickSetupImport");
    const dontShowAgain = document.getElementById("dontShowAgain");
    const setupPrevBtn = document.getElementById("setupPrevBtn");
    const setupNextBtn = document.getElementById("setupNextBtn");
    const setupSkipBtn = document.getElementById("setupSkipBtn");
    const setupStepTitle = document.getElementById("setupStepTitle");
    const setupStepText = document.getElementById("setupStepText");
    const setupStepContent = document.getElementById("setupStepContent");
    const setupProgressBar = document.getElementById("setupProgressBar");
    const setupPercent = document.getElementById("setupPercent");
    
    // Helper functions
    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }
    
    function formatCurrency(amount, currency = 'USD') {
      const symbols = {
        'USD': '$',
        'EUR': '',
        'GBP': '',
        'INR': '',
        'JPY': ''
      };
      
      const symbol = symbols[currency] || currency;
      const formatted = parseFloat(amount || 0).toFixed(2);
      
      if (balanceVisible) {
        return `${symbol}${formatted}`;
      } else {
        // Hide the actual amount with a blur effect
        return `<span class="balance-hidden">${symbol}</span>`;
      }
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Auth handling
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        const email = user.email || "user@example.com";
        
        usernameElem.textContent = name;
        sidebarUsername.textContent = name;
        userEmail.textContent = email;
        userAvatar.textContent = (name.charAt(0) || "U").toUpperCase();
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your transactions...");
        
        try {
          // Load user settings first
          await loadUserSettings();
          
          // Load theme preference
          loadThemePreference();
          
          // Check if first visit
          await checkFirstVisit();
          
          // Load all data in parallel for better performance
          await Promise.all([
            loadCOAData(),
            loadTransactions(),
            loadTags(),
            loadCategories(),
            loadRecurringTemplates()
          ]);
          
          // Load saved filters
          loadSavedFilters();
          
          // Initialize UI components
          initializeUI();
          
          // Load app state
          loadAppState();
          
          // Apply initial filters
          applyFilters();
          
          // Update all UI components
          updateDashboard();
          
          hideLoading();
          
          // Show welcome modal if first visit
          if (isFirstVisit && !userSettings.hideWelcome) {
            setTimeout(() => welcomeModal.show(), 1000);
          }
          
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          Swal.fire({ 
            icon: 'error', 
            title: 'Loading Error', 
            text: 'Failed to load data. Please refresh the page.' 
          });
        }
      } else {
        // Not logged in
        Swal.fire({ 
          icon: 'info', 
          title: 'Please login', 
          text: 'You will be redirected to login.' 
        }).then(() => {
          window.location.href = "index.html";
        });
      }
    });

    // Initialize UI components
    function initializeUI() {
      // Initialize Select2 for tags filter
      $(tagsFilter).select2({
        placeholder: "Filter by tags",
        allowClear: true,
        width: '100%'
      });
      
      // Initialize flatpickr for date inputs
      flatpickr("#formDATE", {
        dateFormat: "Y-m-d",
        defaultDate: "today"
      });
      
      flatpickr("#quickAddDate", {
        dateFormat: "Y-m-d",
        defaultDate: "today"
      });
      
      flatpickr("#splitIncomeDate", {
        dateFormat: "Y-m-d",
        defaultDate: "today"
      });
      
      // Setup event listeners
      setupEventListeners();
      
      // Initialize floating action menu
      initializeFloatingMenu();
      
      // Update UI based on settings
      updateUIFromSettings();
    }
    
    function setupEventListeners() {
      // Sidebar and navigation
      mobileMenuToggle.addEventListener("click", toggleMobileMenu);
      logoutBtn.addEventListener("click", handleLogout);
      sidebarLogoutBtn.addEventListener("click", handleLogout);
      
      // Theme toggle
      themeToggleSwitch.addEventListener("change", toggleTheme);
      
      // Transaction creation
      newIncomeBtn.addEventListener("click", () => openAddModal('Income'));
      newExpenseBtn.addEventListener("click", () => openAddModal('Expense'));
      newTransferBtn.addEventListener("click", () => openAddModal('Transfer'));
      newRecurringBtn.addEventListener("click", openRecurringModal);
      floatingAdd.addEventListener("click", () => openAddModal());
      quickAddBtn.addEventListener("click", openQuickAddModal);
      importBtn.addEventListener("click", openImportModal);
      addFirstTransactionBtn.addEventListener("click", () => openAddModal());
      
      // Quick Add
      quickAddParseBtn.addEventListener("click", parseQuickAddInput);
      quickAddInput.addEventListener("input", debounce(parseQuickAddInput, 500));
      processQuickAddBtn.addEventListener("click", processQuickAdd);
      
      // Balance toggle
      balanceToggle.addEventListener("click", toggleBalanceVisibility);
      
      // Filters
      filterToggleBtn.addEventListener("click", toggleFilters);
      dateFilter.addEventListener("change", handleDateFilterChange);
      applyFiltersBtn.addEventListener("click", applyFilters);
      resetFiltersBtn.addEventListener("click", resetFilters);
      saveFilterBtn.addEventListener("click", saveCurrentFilter);
      advancedFiltersBtn.addEventListener("click", toggleAdvancedFilters);
      
      // Bulk actions
      selectAllCheckbox.addEventListener("change", toggleSelectAll);
      bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
      bulkEditBtn.addEventListener("click", openBulkEditModal);
      bulkTagBtn.addEventListener("click", openBulkTagModal);
      clearSelectionBtn.addEventListener("click", clearSelection);
      confirmBulkEditBtn.addEventListener("click", processBulkEdit);
      confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
      
      // Split income
      floatingSplit.addEventListener("click", openSplitIncomeModal);
      addSplitExpenseBtn.addEventListener("click", addSplitExpense);
      clearSplitExpensesBtn.addEventListener("click", clearSplitExpenses);
      splitIncomeAmount.addEventListener("input", updateSplitSummary);
      splitIncomeDescription.addEventListener("input", updateSplitSummary);
      previewSplitBtn.addEventListener("click", previewSplitTransactions);
      saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);
      
      // Transaction form
      formTYPE.addEventListener("change", handleTransactionTypeChange);
      formATTACHFILE.addEventListener("change", handleFileUpload);
      clearAttachmentBtn.addEventListener("click", clearAttachment);
      includeTimeCheckbox.addEventListener("change", toggleTimeInput);
      includeTax.addEventListener("change", toggleTaxInput);
      generateRefBtn.addEventListener("click", generateReferenceNumber);
      saveTransactionBtn.addEventListener("click", saveTransaction);
      saveDraftBtn.addEventListener("click", saveTransactionAsDraft);
      saveAndNewBtn.addEventListener("click", saveTransactionAndNew);
      
      // Quick amount buttons
      quickAmount100.addEventListener("click", () => setQuickAmount(100));
      quickAmount500.addEventListener("click", () => setQuickAmount(500));
      quickAmount1000.addEventListener("click", () => setQuickAmount(1000));
      quickAmountCustom.addEventListener("click", promptCustomAmount);
      
      // Tags input
      tagInput.addEventListener("keydown", handleTagInput);
      
      // Export/Import
      exportCSV.addEventListener("click", () => openExportModal('csv'));
      exportPDF.addEventListener("click", () => openExportModal('pdf'));
      exportExcel.addEventListener("click", () => openExportModal('excel'));
      importFile.addEventListener("change", handleImportFileSelect);
      importProcessBtn.addEventListener("click", processImport);
      confirmExportBtn.addEventListener("click", processExport);
      
      // Settings
      saveSettingsBtn.addEventListener("click", saveUserSettings);
      backupDataBtn.addEventListener("click", backupAllData);
      clearAllDataBtn.addEventListener("click", confirmClearAllData);
      exportSettingsBtn.addEventListener("click", exportSettings);
      importSettingsBtn.addEventListener("click", importSettings);
      
      // Welcome/Setup
      quickSetupSkip.addEventListener("click", skipSetup);
      quickSetupStart.addEventListener("click", startGuidedSetup);
      quickSetupImport.addEventListener("click", startImportSetup);
      setupPrevBtn.addEventListener("click", previousSetupStep);
      setupNextBtn.addEventListener("click", nextSetupStep);
      setupSkipBtn.addEventListener("click", skipSetupStep);
      
      // Floating menu
      floatingDuplicate.addEventListener("click", duplicateSelectedTransaction);
      floatingAttachment.addEventListener("click", addAttachmentToSelected);
      
      // Other buttons
      document.getElementById("refreshBtn").addEventListener("click", refreshData);
      document.getElementById("viewAllBtn").addEventListener("click", viewAllTransactions);
      
      // Table event delegation
      transactionsTableBody.addEventListener("click", handleTableClick);
    }
    
    function initializeFloatingMenu() {
      let isMenuOpen = false;
      
      floatingAdd.addEventListener("click", () => {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
          floatingMenu.classList.add("show");
          floatingAdd.innerHTML = '<i class="fa fa-times fa-lg"></i>';
        } else {
          floatingMenu.classList.remove("show");
          floatingAdd.innerHTML = '<i class="fa fa-plus fa-lg"></i>';
        }
      });
      
      // Close menu when clicking elsewhere
      document.addEventListener("click", (e) => {
        if (!floatingAdd.contains(e.target) && !floatingMenu.contains(e.target)) {
          floatingMenu.classList.remove("show");
          floatingAdd.innerHTML = '<i class="fa fa-plus fa-lg"></i>';
          isMenuOpen = false;
        }
      });
    }
    
    async function loadUserSettings() {
      try {
        if (!currentUser) return;
        
        const settingsDoc = await getDoc(doc(db, "users", currentUser.uid, "settings", "preferences"));
        
        if (settingsDoc.exists()) {
          userSettings = settingsDoc.data();
          
          // Apply settings
          if (userSettings.theme) {
            currentTheme = userSettings.theme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            themeToggleSwitch.checked = currentTheme === 'dark';
          }
          
          if (userSettings.showBalances !== undefined) {
            balanceVisible = userSettings.showBalances;
            updateBalanceVisibility();
          }
          
          if (userSettings.pageSize) {
            rowsPerPage = parseInt(userSettings.pageSize);
            pageSize.value = rowsPerPage.toString();
          }
          
          if (userSettings.currency) {
            formCURRENCY.value = userSettings.currency;
          }
          
          if (userSettings.defaultType) {
            formTYPE.value = userSettings.defaultType;
          }
          
          if (userSettings.defaultBank) {
            formBANKNAME.value = userSettings.defaultBank;
          }
          
        } else {
          // Default settings
          userSettings = {
            theme: 'light',
            showBalances: false, // Default to hidden
            pageSize: 10,
            currency: 'USD',
            defaultType: 'Expense',
            defaultBank: '',
            hideWelcome: false
          };
          
          // Save default settings
          await setDoc(doc(db, "users", currentUser.uid, "settings", "preferences"), userSettings);
        }
      } catch (error) {
        console.error("Error loading settings:", error);
        userSettings = {
          theme: 'light',
          showBalances: false,
          pageSize: 10,
          currency: 'USD',
          defaultType: 'Expense',
          defaultBank: '',
          hideWelcome: false
        };
      }
    }
    
    async function checkFirstVisit() {
      try {
        const txQuery = query(
          collection(db, "users", currentUser.uid, "transactions"),
          limit(1)
        );
        const txSnapshot = await getDocs(txQuery);
        
        isFirstVisit = txSnapshot.empty;
      } catch (error) {
        console.error("Error checking first visit:", error);
        isFirstVisit = true;
      }
    }
    
    // Data loading functions
    async function loadCOAData() {
      try {
        if (!currentUser) return;
        
        // Get account headers from chartOfAccounts collection
        const accountsQuery = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"), 
          where("userId", "==", currentUser.uid)
        );
        const accountsSnapshot = await getDocs(accountsQuery);
        
        coaAccounts = [];
        coaBanks = [];
        
        accountsSnapshot.forEach(doc => {
          const data = doc.data();
          const name = data.name || '';
          
          if (name) {
            coaAccounts.push(name);
            
            // Check if this is a bank account
            if (data.category === "Bank" || data.category === "Cash" || 
                data.type === "Asset" && (name.toLowerCase().includes("bank") || 
                name.toLowerCase().includes("cash") || 
                name.toLowerCase().includes("account"))) {
              coaBanks.push(name);
            }
          }
        });
        
        // If no accounts found, set default accounts
        if (coaAccounts.length === 0) {
          coaAccounts = ["Rent", "Utilities", "Groceries", "Transportation", "Entertainment", "Healthcare", "Education", "Miscellaneous"];
        }
        
        if (coaBanks.length === 0) {
          coaBanks = ["Cash", "Checking Account", "Savings Account", "Credit Card"];
        }
        
        // Populate the dropdowns
        populateCOADropdowns();
        
      } catch (error) {
        console.warn('Error loading COA data:', error.message);
        // Use default accounts if COA is not available
        coaAccounts = ["Rent", "Utilities", "Groceries", "Transportation", "Entertainment", "Healthcare", "Education", "Miscellaneous"];
        coaBanks = ["Cash", "Checking Account", "Savings Account", "Credit Card"];
        populateCOADropdowns();
      }
    }
    
    async function loadTags() {
      try {
        if (!currentUser) return;
        
        const tagsQuery = query(
          collection(db, "users", currentUser.uid, "tags")
        );
        const tagsSnapshot = await getDocs(tagsQuery);
        
        availableTags = [];
        tagsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            availableTags.push({
              id: doc.id,
              name: data.name,
              color: data.color || 'secondary',
              count: data.count || 0
            });
          }
        });
        
        // Sort by count (most used first)
        availableTags.sort((a, b) => b.count - a.count);
        
        updateTagsFilter();
        
      } catch (error) {
        console.warn('Error loading tags:', error);
        availableTags = [];
      }
    }
    
    async function loadCategories() {
      try {
        if (!currentUser) return;
        
        const categoriesQuery = query(
          collection(db, "users", currentUser.uid, "categories")
        );
        const categoriesSnapshot = await getDocs(categoriesQuery);
        
        userCategories = [];
        categoriesSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            userCategories.push({
              id: doc.id,
              name: data.name,
              type: data.type || 'Expense',
              budget: data.budget || 0,
              color: data.color || 'primary'
            });
          }
        });
        
        // Sort alphabetically
        userCategories.sort((a, b) => a.name.localeCompare(b.name));
        
        updateCategoryFilter();
        
      } catch (error) {
        console.warn('Error loading categories:', error);
        userCategories = [];
      }
    }
    
    async function loadRecurringTemplates() {
      try {
        if (!currentUser) return;
        
        const recurringQuery = query(
          collection(db, "users", currentUser.uid, "recurringTemplates"),
          where("active", "==", true)
        );
        const recurringSnapshot = await getDocs(recurringQuery);
        
        recurringTemplates = [];
        recurringSnapshot.forEach(doc => {
          const data = doc.data();
          recurringTemplates.push({
            id: doc.id,
            ...data
          });
        });
        
        updateRecurringBadge();
        
      } catch (error) {
        console.warn('Error loading recurring templates:', error);
        recurringTemplates = [];
      }
    }
    
    // UI Update functions
    function populateCOADropdowns() {
      // Clear existing options
      const accountSelectors = [
        formACCOUNTHEADER,
        formTRANSFERTO,
        splitIncomeBank,
        document.getElementById("settingDefaultBank"),
        document.getElementById("recurringBank"),
        document.getElementById("recurringCategory")
      ];
      
      const bankSelectors = [
        formBANKNAME,
        bankFilter,
        categoryFilter
      ];
      
      // Add account headers
      accountSelectors.forEach(selector => {
        if (selector) {
          const currentValue = selector.value;
          selector.innerHTML = '<option value="">Select Category</option>';
          
          coaAccounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account;
            option.textContent = account;
            selector.appendChild(option);
          });
          
          // Restore previous value if exists
          if (currentValue && coaAccounts.includes(currentValue)) {
            selector.value = currentValue;
          }
        }
      });
      
      // Add bank names
      bankSelectors.forEach(selector => {
        if (selector) {
          const currentValue = selector.value;
          const isBankFilter = selector.id === 'bankFilter';
          const isCategoryFilter = selector.id === 'categoryFilter';
          
          if (isBankFilter) {
            selector.innerHTML = '<option value="all">All Banks</option>';
          } else if (isCategoryFilter) {
            selector.innerHTML = '<option value="all">All Categories</option>';
          } else {
            selector.innerHTML = '<option value="">Select Bank</option>';
          }
          
          coaBanks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank;
            option.textContent = bank;
            selector.appendChild(option);
            
            if (isBankFilter) {
              // Clone for bank filter
              const filterOption = option.cloneNode(true);
              selector.appendChild(filterOption);
            }
          });
          
          // Restore previous value
          if (currentValue && (coaBanks.includes(currentValue) || currentValue === 'all')) {
            selector.value = currentValue;
          }
        }
      });
      
      // Update split income bank select
      if (splitIncomeBank) {
        const currentValue = splitIncomeBank.value;
        splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
        
        coaBanks.forEach(bank => {
          const option = document.createElement('option');
          option.value = bank;
          option.textContent = bank;
          splitIncomeBank.appendChild(option);
        });
        
        if (currentValue && coaBanks.includes(currentValue)) {
          splitIncomeBank.value = currentValue;
        }
      }
    }
    
    function updateTagsFilter() {
      if (!tagsFilter) return;
      
      const currentValues = $(tagsFilter).val() || [];
      $(tagsFilter).empty();
      
      // Add "All Tags" option
      const allOption = new Option("All Tags", "all", false, false);
      tagsFilter.appendChild(allOption);
      
      // Add available tags
      availableTags.forEach(tag => {
        const option = new Option(tag.name, tag.id, false, false);
        tagsFilter.appendChild(option);
      });
      
      // Restore selected values
      $(tagsFilter).val(currentValues).trigger('change');
    }
    
    function updateCategoryFilter() {
      if (!categoryFilter) return;
      
      const currentValue = categoryFilter.value;
      categoryFilter.innerHTML = '<option value="all">All Categories</option>';
      
      userCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        categoryFilter.appendChild(option);
      });
      
      // Restore previous value
      if (currentValue && (userCategories.some(c => c.name === currentValue) || currentValue === 'all')) {
        categoryFilter.value = currentValue;
      }
    }
    
    function updateRecurringBadge() {
      const badge = document.getElementById("recurringCountBadge");
      if (badge) {
        badge.textContent = recurringTemplates.length.toString();
      }
    }
    
    // Transaction loading and management
    async function loadTransactions() {
      try {
        showLoading("Loading transactions...");
        
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        const txs = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
          BANK_NAME: d.data().BANK_NAME || d.data().MODE || "",
          TAGS: d.data().TAGS || [],
          STATUS: d.data().STATUS || 'completed',
          CURRENCY: d.data().CURRENCY || 'USD'
        }));
        
        allTransactions = txs;
        filteredTransactions = allTransactions.slice();
        
        if (!hasLoadedSavedState) {
          currentPage = 1;
        }
        
        // Calculate running balance
        calculateRunningBalance();
        
        // Build table and update UI
        buildTable();
        updateStats();
        updateBankBalances();
        updateQuickStats();
        updateDashboardCharts();
        
        // Update transaction count badge
        updateTransactionCountBadge();
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        transactionsTableBody.innerHTML = `
          <tr>
            <td colspan="12" class="text-center text-danger py-4">
              <i class="fa fa-exclamation-triangle me-2"></i>
              Failed to load transactions. Please try again.
            </td>
          </tr>
        `;
        return false;
      } finally {
        hideLoading();
      }
    }
    
    function calculateRunningBalance() {
      // Sort transactions by date ascending for balance calculation
      const sortedTransactions = [...allTransactions].sort((a, b) => {
        return new Date(a.DATE) - new Date(b.DATE);
      });
      
      let runningBalance = 0;
      
      sortedTransactions.forEach(tx => {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        runningBalance += (income - expense);
        tx.BALANCE = runningBalance;
      });
      
      return sortedTransactions;
    }
    
    function buildTable() {
      if (filteredTransactions.length === 0) {
        transactionsTableBody.innerHTML = `
          <tr>
            <td colspan="12" class="text-center text-muted py-5">
              <i class="fa fa-exchange-alt fa-2x mb-3 d-block"></i>
              <h5>No transactions found</h5>
              <p class="small">Add your first transaction to get started</p>
              <button id="addFirstTransactionBtn" class="btn btn-primary btn-sm">
                <i class="fa fa-plus me-1"></i>Add Transaction
              </button>
            </td>
          </tr>
        `;
        
        // Re-attach event listener for the button
        document.getElementById("addFirstTransactionBtn")?.addEventListener("click", () => openAddModal());
        
        paginationControls.innerHTML = "";
        return;
      }

      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

      let html = "";
      pageTransactions.forEach(tx => {
        const date = tx.DATE ? formatDate(tx.DATE) : "";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        const amount = income > 0 ? income : expense;
        const balance = parseFloat(tx.BALANCE) || 0;
        const isSelected = selectedTransactions.has(tx.id);
        const tags = tx.TAGS || [];
        const status = tx.STATUS || 'completed';
        const isRecurring = tx.RECURRING_ID || false;
        
        // Determine badge class based on type
        let badgeClass = '';
        let typeText = tx.TYPE || 'Expense';
        if (typeText === 'Income') badgeClass = 'badge-income';
        else if (typeText === 'Expense') badgeClass = 'badge-expense';
        else if (typeText === 'Transfer') badgeClass = 'badge-transfer';
        
        // Status badge
        let statusBadge = '';
        if (status === 'pending') statusBadge = '<span class="badge bg-warning">Pending</span>';
        else if (status === 'cancelled') statusBadge = '<span class="badge bg-secondary">Cancelled</span>';
        else if (status === 'reconciled') statusBadge = '<span class="badge bg-success">Reconciled</span>';
        
        // Tags display
        let tagsHtml = '';
        if (tags.length > 0) {
          tags.forEach(tag => {
            tagsHtml += `<span class="badge-tag">${escapeHtml(tag)}</span>`;
          });
        } else {
          tagsHtml = '<span class="text-muted small">-</span>';
        }
        
        html += `
          <tr class="${isSelected ? 'selected' : ''}" data-id="${tx.id}">
            <td>
              <input type="checkbox" class="transaction-checkbox row-checkbox" data-id="${tx.id}" ${isSelected ? 'checked' : ''}>
            </td>
            <td>
              ${escapeHtml(date)}
              ${isRecurring ? '<i class="fa fa-redo text-warning ms-1" title="Recurring"></i>' : ''}
            </td>
            <td>${escapeHtml(tx.ACCOUNT_HEADER || "-")}</td>
            <td>
              <div class="fw-semibold">${escapeHtml(tx.DESCRIPTION || tx.NOTES || "")}</div>
              ${tx.NOTES && tx.NOTES !== tx.DESCRIPTION ? `<small class="text-muted">${escapeHtml(tx.NOTES)}</small>` : ''}
            </td>
            <td><span class="badge ${badgeClass}">${escapeHtml(typeText)}</span></td>
            <td><code>${escapeHtml(tx.SINO || "")}</code></td>
            <td>${escapeHtml(tx.BANK_NAME || tx.MODE || "")}</td>
            <td style="text-align:right;" class="${income > 0 ? 'income-color' : 'expense-color'}">
              ${formatCurrency(amount, tx.CURRENCY)}
            </td>
            <td style="text-align:right;">${formatCurrency(balance, tx.CURRENCY)}</td>
            <td>${tagsHtml}</td>
            <td>${statusBadge}</td>
            <td>
              <div class="d-flex gap-1">
                <button class="action-btn btn-view" data-action="view" data-id="${tx.id}" title="View">
                  <i class="fa fa-eye"></i>
                </button>
                <button class="action-btn btn-edit" data-action="edit" data-id="${tx.id}" title="Edit">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="action-btn btn-del" data-action="delete" data-id="${tx.id}" title="Delete">
                  <i class="fa fa-trash"></i>
                </button>
                ${tx.ATTACHMENT ? `
                  <button class="action-btn btn-attach" data-action="attachment" data-attachment="${escapeHtml(tx.ATTACHMENT)}" title="View Attachment">
                    <i class="fa fa-paperclip"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      });
      
      transactionsTableBody.innerHTML = html;
      buildPagination();
      updatePaginationInfo();
    }
    
    function buildPagination() {
      const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
      if (totalPages <= 1) {
        paginationNav.innerHTML = "";
        return;
      }

      let html = '';

      // Previous button
      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">
            <i class="fa fa-chevron-left"></i>
          </a>
        </li>
      `;

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // First page
      if (startPage > 1) {
        html += `
          <li class="page-item">
            <a class="page-link" href="#" data-page="1">1</a>
          </li>
          ${startPage > 2 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
        `;
      }

      // Page range
      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      // Last page
      if (endPage < totalPages) {
        html += `
          ${endPage < totalPages - 1 ? '<li class="page-item disabled"><span class="page-link">...</span></li>' : ''}
          <li class="page-item">
            <a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>
          </li>
        `;
      }

      // Next button
      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">
            <i class="fa fa-chevron-right"></i>
          </a>
        </li>
      `;

      paginationNav.innerHTML = html;
    }
    
    function updatePaginationInfo() {
      const total = filteredTransactions.length;
      const start = Math.min((currentPage - 1) * rowsPerPage + 1, total);
      const end = Math.min(currentPage * rowsPerPage, total);
      
      paginationInfo.textContent = `Showing ${start}-${end} of ${total} transactions`;
    }
    
    // Event handlers
    function handleTableClick(e) {
      const button = e.target.closest("button");
      if (!button) return;
      
      const action = button.getAttribute("data-action");
      const id = button.getAttribute("data-id");
      const attachment = button.getAttribute("data-attachment");
      
      switch (action) {
        case "view":
          viewTransactionDetails(id);
          break;
        case "edit":
          editTransaction(id);
          break;
        case "delete":
          confirmDelete(id);
          break;
        case "attachment":
          viewAttachment(attachment);
          break;
      }
    }
    
    function toggleMobileMenu() {
      sidebar.classList.toggle("mobile-show");
    }
    
    async function handleLogout() {
      try {
        localStorage.removeItem('budgetAppState');
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        console.error("Logout error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Logout Failed',
          text: 'Unable to logout. Please try again.'
        });
      }
    }
    
    function toggleTheme() {
      currentTheme = themeToggleSwitch.checked ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      userSettings.theme = currentTheme;
      saveUserSettings();
    }
    
    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      userSettings.showBalances = balanceVisible;
      saveUserSettings();
      updateBalanceDisplay();
      updateBankBalances();
    }
    
    function updateBalanceDisplay() {
      const totalIncome = allTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      const totalExpense = allTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      statBalance.innerHTML = formatCurrency(balance, 'USD');
      balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
      
      // Update all balance displays in the table
      document.querySelectorAll('.balance-hidden').forEach(el => {
        if (balanceVisible) {
          el.classList.remove('balance-hidden');
        } else {
          el.classList.add('balance-hidden');
        }
      });
    }
    
    // Transaction modal functions
    async function openAddModal(type = null) {
      try {
        showLoading("Loading form...");
        
        // Reset form
        form.reset();
        txIdInput.value = "";
        txRecurringInput.value = "false";
        
        // Set default values
        const today = new Date().toISOString().split('T')[0];
        formDATE.value = today;
        formTYPE.value = type || userSettings.defaultType || 'Expense';
        formCURRENCY.value = userSettings.currency || 'USD';
        formBANKNAME.value = userSettings.defaultBank || '';
        formSTATUS.value = 'completed';
        formTIME.value = '';
        includeTimeCheckbox.checked = false;
        formTIME.disabled = true;
        
        // Generate reference number
        await generateReferenceNumber();
        
        // Clear tags
        tagsInputContainer.querySelectorAll('.tag-item').forEach(tag => tag.remove());
        tagInput.value = '';
        
        // Clear attachment
        clearAttachment();
        
        // Set modal title
        const modalTitle = document.getElementById("transactionModalLabel");
        modalTitle.innerHTML = `<i class="fa fa-exchange-alt me-2"></i>Add ${type || 'Transaction'}`;
        
        // Show/hide recurring options
        recurringOptions.style.display = 'none';
        
        // Handle transaction type specific settings
        handleTransactionTypeChange();
        
        // Enable all fields
        Array.from(form.elements).forEach(el => el.disabled = false);
        
        hideLoading();
        transactionModal.show();
        
      } catch (error) {
        hideLoading();
        console.error("Error opening modal:", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load form. Please try again.'
        });
      }
    }
    
    async function generateReferenceNumber() {
      try {
        const type = formVOUCHERTYPE.value || 'Payment';
        const prefix = {
          'Payment': 'PMT',
          'Receipt': 'RCT',
          'Journal': 'JRN',
          'Transfer': 'TRF'
        }[type] || 'TX';
        
        // Get last reference number
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"),
          where("SINO", ">=", prefix),
          where("SINO", "<=", prefix + "\uf8ff"),
          orderBy("SINO", "desc"),
          limit(1)
        );
        
        const snap = await getDocs(q);
        let nextNumber = 1;
        
        if (!snap.empty) {
          const lastRef = snap.docs[0].data().SINO;
          const match = lastRef.match(/\d+/);
          if (match) {
            nextNumber = parseInt(match[0]) + 1;
          }
        }
        
        formSINO.value = `${prefix}${nextNumber.toString().padStart(5, '0')}`;
        
      } catch (error) {
        console.error("Error generating reference:", error);
        // Fallback to timestamp
        formSINO.value = `TX${Date.now().toString().slice(-6)}`;
      }
    }
    
    function handleTransactionTypeChange() {
      const type = formTYPE.value;
      const transferToContainer = formTRANSFERTO.parentElement;
      const transferHelp = document.getElementById("transferAccountHelp");
      
      if (type === 'Transfer') {
        transferToContainer.style.display = 'block';
        transferHelp.style.display = 'block';
        formAMOUNT.placeholder = "Transfer amount";
      } else {
        transferToContainer.style.display = 'none';
        transferHelp.style.display = 'none';
        formAMOUNT.placeholder = type === 'Income' ? "Income amount" : "Expense amount";
      }
      
      // Update amount field label
      const amountLabel = formAMOUNT.previousElementSibling;
      if (amountLabel && amountLabel.classList.contains('form-label')) {
        amountLabel.textContent = type === 'Income' ? 'Income Amount' : 
                                 type === 'Transfer' ? 'Transfer Amount' : 'Expense Amount';
      }
    }
    
    function handleTagInput(e) {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const tag = tagInput.value.trim();
        if (tag) {
          addTagToInput(tag);
          tagInput.value = '';
        }
      }
    }
    
    function addTagToInput(tag) {
      const tagElement = document.createElement('div');
      tagElement.className = 'tag-item';
      tagElement.innerHTML = `
        ${escapeHtml(tag)}
        <button type="button" class="tag-remove" onclick="this.parentElement.remove()">
          <i class="fa fa-times"></i>
        </button>
      `;
      tagsInputContainer.insertBefore(tagElement, tagInput);
    }
    
    function getTagsFromInput() {
      const tags = [];
      tagsInputContainer.querySelectorAll('.tag-item').forEach(tag => {
        const tagText = tag.textContent.trim().replace('', '');
        if (tagText) tags.push(tagText);
      });
      return tags;
    }
    
    async function handleFileUpload() {
      const file = formATTACHFILE.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        Swal.fire({
          icon: 'error',
          title: 'File too large',
          text: 'Please select a file smaller than 10MB'
        });
        formATTACHFILE.value = '';
        return;
      }
      
      try {
        uploadProgress.style.display = "block";
        uploadProgressBar.style.width = "0%";
        
        // Simulate upload progress
        for (let i = 0; i <= 100; i += 10) {
          setTimeout(() => {
            uploadProgressBar.style.width = `${i}%`;
          }, i * 20);
        }
        
        // Read file as base64
        const reader = new FileReader();
        reader.onload = function(e) {
          formATTACH.value = "data:" + file.type + ";base64," + btoa(e.target.result);
          attachmentInfo.textContent = `Uploaded: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          
          if (file.type.startsWith('image/')) {
            attachmentPreview.src = URL.createObjectURL(file);
            attachmentPreview.style.display = "block";
          } else {
            attachmentPreview.style.display = "none";
          }
          
          uploadProgress.style.display = "none";
        };
        reader.readAsBinaryString(file);
        
      } catch (err) {
        console.error("Upload failed", err);
        uploadProgress.style.display = "none";
        Swal.fire({
          icon: 'error',
          title: 'Upload failed',
          text: 'Could not upload attachment'
        });
        formATTACHFILE.value = '';
      }
    }
    
    function clearAttachment() {
      formATTACHFILE.value = '';
      formATTACH.value = '';
      attachmentInfo.textContent = '';
      attachmentPreview.style.display = 'none';
      attachmentPreview.src = '';
    }
    
    function toggleTimeInput() {
      formTIME.disabled = !includeTimeCheckbox.checked;
      if (!includeTimeCheckbox.checked) {
        formTIME.value = '';
      }
    }
    
    function toggleTaxInput() {
      formTAX.disabled = !includeTax.checked;
      if (!includeTax.checked) {
        formTAX.value = '';
      }
    }
    
    function setQuickAmount(amount) {
      formAMOUNT.value = amount;
    }
    
    function promptCustomAmount() {
      Swal.fire({
        title: 'Enter Amount',
        input: 'number',
        inputAttributes: {
          step: '0.01',
          min: '0'
        },
        showCancelButton: true,
        confirmButtonText: 'Set Amount'
      }).then((result) => {
        if (result.isConfirmed && result.value) {
          formAMOUNT.value = parseFloat(result.value);
        }
      });
    }
    
    async function saveTransaction() {
      if (isSubmitting) return;
      isSubmitting = true;
      
      saveTransactionBtn.disabled = true;
      saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      
      try {
        // Validate form
        if (!formDATE.value) {
          throw new Error('Date is required');
        }
        
        if (!formAMOUNT.value || parseFloat(formAMOUNT.value) <= 0) {
          throw new Error('Valid amount is required');
        }
        
        if (!formDESCRIPTION.value.trim()) {
          throw new Error('Description is required');
        }
        
        // Prepare transaction data
        const txData = {
          DATE: formDATE.value,
          SINO: formSINO.value,
          ACCOUNT_HEADER: formACCOUNTHEADER.value,
          BANK_NAME: formBANKNAME.value,
          MODE: formBANKNAME.value,
          TYPE: formTYPE.value,
          INCOME: formTYPE.value === 'Income' ? parseFloat(formAMOUNT.value) : 0,
          EXPENSE: formTYPE.value === 'Expense' || formTYPE.value === 'Transfer' ? parseFloat(formAMOUNT.value) : 0,
          BALANCE: 0, // Will be calculated
          DESCRIPTION: formDESCRIPTION.value,
          NOTES: formNOTES.value,
          ATTACHMENT: formATTACH.value,
          CURRENCY: formCURRENCY.value,
          STATUS: formSTATUS.value,
          TAGS: getTagsFromInput(),
          TAX: includeTax.checked ? parseFloat(formTAX.value) || 0 : 0,
          createdAt: new Date(),
          updatedAt: new Date(),
          userId: currentUser.uid
        };
        
        // Add time if included
        if (includeTimeCheckbox.checked && formTIME.value) {
          txData.TIME = formTIME.value;
        }
        
        // Handle transfer
        if (formTYPE.value === 'Transfer' && formTRANSFERTO.value) {
          // For transfers, we might want to create two transactions
          // For simplicity, we'll just save the from transaction
          txData.TRANSFER_TO = formTRANSFERTO.value;
        }
        
        // Handle recurring
        if (txRecurringInput.value === 'true') {
          txData.RECURRING_ID = generateUniqueId();
          txData.RECURRING = true;
        }
        
        // Save to Firebase
        loadingMessage.textContent = "Saving transaction...";
        loadingModal.show();
        
        if (txIdInput.value) {
          // Update existing transaction
          await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), txData);
          Swal.fire({
            icon: 'success',
            title: 'Updated',
            text: 'Transaction updated successfully'
          });
        } else {
          // Add new transaction
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
          Swal.fire({
            icon: 'success',
            title: 'Added',
            text: 'Transaction added successfully'
          });
        }
        
        loadingModal.hide();
        transactionModal.hide();
        
        // Reload transactions
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("saveTransaction error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to save transaction'
        });
      } finally {
        isSubmitting = false;
        saveTransactionBtn.disabled = false;
        saveTransactionBtn.innerHTML = '<i class="fa fa-check me-1"></i>Save Transaction';
      }
    }
    
    function saveTransactionAsDraft() {
      formSTATUS.value = 'draft';
      saveTransaction();
    }
    
    async function saveTransactionAndNew() {
      await saveTransaction();
      if (!isSubmitting) {
        openAddModal();
      }
    }
    
    // View and edit transactions
    async function viewTransactionDetails(id) {
      try {
        showLoading("Loading transaction details...");
        
        const tx = allTransactions.find(t => t.id === id);
        if (!tx) throw new Error('Transaction not found');
        
        // Populate details modal
        document.getElementById("detailDescription").textContent = tx.DESCRIPTION || 'No description';
        document.getElementById("detailTypeBadge").textContent = tx.TYPE || 'Unknown';
        document.getElementById("detailTypeBadge").className = tx.TYPE === 'Income' ? 'badge-income' : 
                                                            tx.TYPE === 'Expense' ? 'badge-expense' : 'badge-transfer';
        
        document.getElementById("detailStatusBadge").textContent = tx.STATUS || 'completed';
        document.getElementById("detailAmount").innerHTML = formatCurrency(
          tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE, 
          tx.CURRENCY
        );
        document.getElementById("detailDate").textContent = formatDate(tx.DATE);
        document.getElementById("detailRef").textContent = tx.SINO || 'N/A';
        document.getElementById("detailCategory").textContent = tx.ACCOUNT_HEADER || 'Uncategorized';
        document.getElementById("detailBank").textContent = tx.BANK_NAME || 'Unknown';
        document.getElementById("detailNotes").textContent = tx.NOTES || 'No notes';
        document.getElementById("detailCreated").textContent = formatDate(tx.createdAt?.toDate?.() || tx.createdAt);
        document.getElementById("detailUpdated").textContent = formatDate(tx.updatedAt?.toDate?.() || tx.updatedAt);
        document.getElementById("detailCurrency").textContent = tx.CURRENCY || 'USD';
        document.getElementById("detailTax").innerHTML = formatCurrency(tx.TAX || 0, tx.CURRENCY);
        
        // Tags
        const tagsContainer = document.getElementById("detailTags");
        tagsContainer.innerHTML = '';
        if (tx.TAGS && tx.TAGS.length > 0) {
          tx.TAGS.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'badge-tag me-1 mb-1';
            span.textContent = tag;
            tagsContainer.appendChild(span);
          });
        } else {
          tagsContainer.innerHTML = '<span class="badge-tag">No tags</span>';
        }
        
        // Set up action buttons
        document.getElementById("detailEditBtn").onclick = () => {
          transactionDetailsModal.hide();
          editTransaction(id);
        };
        
        document.getElementById("detailDuplicateBtn").onclick = () => {
          transactionDetailsModal.hide();
          duplicateTransaction(id);
        };
        
        document.getElementById("detailAttachmentBtn").onclick = () => {
          if (tx.ATTACHMENT) {
            transactionDetailsModal.hide();
            viewAttachment(tx.ATTACHMENT);
          } else {
            Swal.fire({
              icon: 'info',
              title: 'No Attachment',
              text: 'This transaction has no attachment.'
            });
          }
        };
        
        document.getElementById("detailDeleteBtn").onclick = () => {
          transactionDetailsModal.hide();
          confirmDelete(id);
        };
        
        hideLoading();
        transactionDetailsModal.show();
        
      } catch (error) {
        hideLoading();
        console.error("Error viewing transaction:", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load transaction details.'
        });
      }
    }
    
    async function editTransaction(id) {
      try {
        showLoading("Loading transaction...");
        
        const tx = allTransactions.find(t => t.id === id);
        if (!tx) throw new Error('Transaction not found');
        
        // Populate form
        txIdInput.value = tx.id;
        formDATE.value = tx.DATE || '';
        formSINO.value = tx.SINO || '';
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || '';
        formBANKNAME.value = tx.BANK_NAME || '';
        formTYPE.value = tx.TYPE || 'Expense';
        formAMOUNT.value = tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE;
        formCURRENCY.value = tx.CURRENCY || 'USD';
        formSTATUS.value = tx.STATUS || 'completed';
        formDESCRIPTION.value = tx.DESCRIPTION || '';
        formNOTES.value = tx.NOTES || '';
        formATTACH.value = tx.ATTACHMENT || '';
        
        // Handle time
        if (tx.TIME) {
          formTIME.value = tx.TIME;
          includeTimeCheckbox.checked = true;
          formTIME.disabled = false;
        } else {
          formTIME.value = '';
          includeTimeCheckbox.checked = false;
          formTIME.disabled = true;
        }
        
        // Handle tax
        if (tx.TAX) {
          formTAX.value = tx.TAX;
          includeTax.checked = true;
          formTAX.disabled = false;
        } else {
          formTAX.value = '';
          includeTax.checked = false;
          formTAX.disabled = true;
        }
        
        // Handle tags
        tagsInputContainer.querySelectorAll('.tag-item').forEach(tag => tag.remove());
        if (tx.TAGS && tx.TAGS.length > 0) {
          tx.TAGS.forEach(tag => addTagToInput(tag));
        }
        
        // Handle attachment
        if (tx.ATTACHMENT) {
          attachmentInfo.textContent = 'Current attachment loaded';
        } else {
          clearAttachment();
        }
        
        // Handle transfer
        if (tx.TYPE === 'Transfer' && tx.TRANSFER_TO) {
          formTRANSFERTO.value = tx.TRANSFER_TO;
        }
        
        // Handle recurring
        if (tx.RECURRING_ID) {
          txRecurringInput.value = 'true';
          recurringOptions.style.display = 'block';
        }
        
        // Set modal title
        const modalTitle = document.getElementById("transactionModalLabel");
        modalTitle.innerHTML = `<i class="fa fa-edit me-2"></i>Edit Transaction`;
        
        hideLoading();
        transactionModal.show();
        
      } catch (error) {
        hideLoading();
        console.error("Error editing transaction:", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load transaction for editing.'
        });
      }
    }
    
    async function duplicateTransaction(id) {
      try {
        const tx = allTransactions.find(t => t.id === id);
        if (!tx) return;
        
        // Open add modal with duplicated data
        await openAddModal(tx.TYPE);
        
        // Populate with duplicated data (except ID and reference)
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || '';
        formBANKNAME.value = tx.BANK_NAME || '';
        formTYPE.value = tx.TYPE || 'Expense';
        formAMOUNT.value = tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE;
        formCURRENCY.value = tx.CURRENCY || 'USD';
        formDESCRIPTION.value = `Copy of ${tx.DESCRIPTION || ''}`;
        formNOTES.value = tx.NOTES || '';
        
        // Copy tags
        if (tx.TAGS && tx.TAGS.length > 0) {
          tx.TAGS.forEach(tag => addTagToInput(tag));
        }
        
        // Generate new reference
        await generateReferenceNumber();
        
      } catch (error) {
        console.error("Error duplicating transaction:", error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to duplicate transaction.'
        });
      }
    }
    
    async function confirmDelete(id) {
      txToDelete = id;
      confirmDeleteModal.show();
    }
    
    async function deleteTransaction() {
      if (!txToDelete) return;
      
      try {
        loadingMessage.textContent = "Deleting transaction...";
        loadingModal.show();
        
        await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
        
        loadingModal.hide();
        confirmDeleteModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Deleted',
          text: 'Transaction deleted successfully'
        });
        
        // Reload transactions
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("deleteTransaction error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to delete transaction'
        });
      }
    }
    
    // Bulk actions
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const id = checkbox.getAttribute('data-id');
        const row = checkbox.closest('tr');
        
        if (selectAllCheckbox.checked) {
          selectedTransactions.add(id);
          row?.classList.add('selected');
        } else {
          selectedTransactions.delete(id);
          row?.classList.remove('selected');
        }
      });
      
      updateBulkActions();
    }
    
    function clearSelection() {
      selectedTransactions.clear();
      selectAllCheckbox.checked = false;
      
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.closest('tr')?.classList.remove('selected');
      });
      
      updateBulkActions();
    }
    
    function updateBulkActions() {
      const count = selectedTransactions.size;
      selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
      
      if (count > 0) {
        bulkActions.classList.remove('hidden');
      } else {
        bulkActions.classList.add('hidden');
      }
    }
    
    async function confirmBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      bulkDeleteCount.textContent = count;
      confirmBulkDeleteModal.show();
    }
    
    async function processBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      try {
        loadingMessage.textContent = `Deleting ${count} transactions...`;
        loadingModal.show();
        
        // Use batch delete for better performance
        const batch = writeBatch(db);
        selectedTransactions.forEach(id => {
          const docRef = doc(db, "users", currentUser.uid, "transactions", id);
          batch.delete(docRef);
        });
        
        await batch.commit();
        
        loadingModal.hide();
        confirmBulkDeleteModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Deleted',
          text: `${count} transaction${count !== 1 ? 's' : ''} deleted successfully`
        });
        
        // Clear selection and reload
        selectedTransactions.clear();
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("bulkDeleteTransactions error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to delete transactions'
        });
      }
    }
    
    function openBulkEditModal() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      bulkEditCount.textContent = count;
      bulkEditValue.value = "";
      bulkEditModal.show();
    }
    
    function openBulkTagModal() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      // Populate tag selection
      const tagSelect = document.getElementById("bulkTagSelect");
      tagSelect.innerHTML = '';
      
      availableTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag.name;
        option.textContent = tag.name;
        tagSelect.appendChild(option);
      });
      
      document.getElementById("bulkTagCount").textContent = count;
      bulkTagModal.show();
    }
    
    async function processBulkEdit() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      const field = bulkEditField.value;
      const value = bulkEditValue.value.trim();
      
      if (!value && field !== 'TAGS') {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please enter a value'
        });
        return;
      }
      
      try {
        loadingMessage.textContent = `Updating ${count} transactions...`;
        loadingModal.show();
        
        const batch = writeBatch(db);
        selectedTransactions.forEach(id => {
          const docRef = doc(db, "users", currentUser.uid, "transactions", id);
          const updateData = {};
          updateData[field] = value;
          updateData.updatedAt = new Date();
          
          batch.update(docRef, updateData);
        });
        
        await batch.commit();
        
        loadingModal.hide();
        bulkEditModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Updated',
          text: `${count} transaction${count !== 1 ? 's' : ''} updated successfully`
        });
        
        // Clear selection and reload
        selectedTransactions.clear();
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("bulkEditTransactions error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to update transactions'
        });
      }
    }
    
    // Split income functions
    function openSplitIncomeModal() {
      splitIncomeAmount.value = "";
      splitIncomeDescription.value = "";
      splitIncomeBank.value = "";
      splitIncomeDate.value = new Date().toISOString().split('T')[0];
      splitExpensesContainer.innerHTML = "";
      splitSummary.innerHTML = "";
      
      addSplitExpense();
      splitIncomeModal.show();
    }
    
    function addSplitExpense() {
      const expenseId = 'expense-' + Date.now();
      const expenseHtml = `
        <div class="split-transaction-item" id="${expenseId}">
          <div class="split-header">
            <h6>Expense ${splitExpensesContainer.children.length + 1}</h6>
            <button type="button" class="remove-split" onclick="removeSplitExpense('${expenseId}')">
              <i class="fa fa-times"></i>
            </button>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control split-amount-input" placeholder="0.00" oninput="updateSplitSummary()">
            </div>
            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" class="form-control split-description-input" placeholder="Expense description">
            </div>
            <div class="col-md-4">
              <label class="form-label">Bank Account</label>
              <select class="form-select split-bank-input">
                <option value="">Select Bank</option>
                ${coaBanks.map(bank => `<option value="${escapeHtml(bank)}">${escapeHtml(bank)}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-12">
              <label class="form-label">Category</label>
              <select class="form-select split-account-input">
                <option value="">Select Category</option>
                ${coaAccounts.map(account => `<option value="${escapeHtml(account)}">${escapeHtml(account)}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      `;
      
      splitExpensesContainer.insertAdjacentHTML('beforeend', expenseHtml);
      updateSplitSummary();
    }
    
    function removeSplitExpense(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
        updateSplitSummary();
      }
    }
    
    function clearSplitExpenses() {
      splitExpensesContainer.innerHTML = "";
      updateSplitSummary();
    }
    
    function updateSplitSummary() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      
      let totalExpenses = 0;
      expenseElements.forEach(element => {
        const amountInput = element.querySelector('.split-amount-input');
        const amount = parseFloat(amountInput.value) || 0;
        totalExpenses += amount;
      });
      
      const remaining = incomeAmount - totalExpenses;
      
      let summaryHtml = '';
      if (incomeAmount > 0) {
        summaryHtml = `
          <div class="d-flex justify-content-between">
            <span>Total Income:</span>
            <span>$${incomeAmount.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Total Expenses:</span>
            <span>$${totalExpenses.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between ${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">
            <span>Remaining:</span>
            <span>$${remaining.toFixed(2)}</span>
          </div>
        `;
        
        if (remaining < 0) {
          summaryHtml += `<div class="text-danger small mt-1">Warning: Expenses exceed income by $${Math.abs(remaining).toFixed(2)}</div>`;
        } else if (remaining > 0) {
          summaryHtml += `<div class="text-warning small mt-1">Note: $${remaining.toFixed(2)} of income not allocated</div>`;
        } else {
          summaryHtml += `<div class="text-success small mt-1">Perfect! All income allocated to expenses</div>`;
        }
      }
      
      splitSummary.innerHTML = summaryHtml;
    }
    
    function previewSplitTransactions() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const incomeDescription = splitIncomeDescription.value.trim();
      const incomeBank = splitIncomeBank.value;
      const incomeDate = splitIncomeDate.value;
      
      if (!incomeAmount || incomeAmount <= 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please enter a valid income amount'
        });
        return;
      }
      
      // Populate preview
      document.getElementById("previewIncomeAmount").innerHTML = formatCurrency(incomeAmount, 'USD');
      document.getElementById("previewIncomeDesc").textContent = incomeDescription || 'No description';
      document.getElementById("previewIncomeBank").textContent = incomeBank || 'Not selected';
      document.getElementById("previewIncomeDate").textContent = formatDate(incomeDate);
      
      // Populate expenses preview
      const expensesContainer = document.getElementById("previewExpensesList");
      expensesContainer.innerHTML = '';
      
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      let totalExpenses = 0;
      
      expenseElements.forEach((element, index) => {
        const amount = parseFloat(element.querySelector('.split-amount-input').value) || 0;
        const description = element.querySelector('.split-description-input').value || 'No description';
        const bank = element.querySelector('.split-bank-input').value || 'Not selected';
        const category = element.querySelector('.split-account-input').value || 'Not selected';
        
        totalExpenses += amount;
        
        const expenseHtml = `
          <div class="card mb-2">
            <div class="card-body">
              <div class="row">
                <div class="col-md-2">
                  <small class="text-muted">#${index + 1}</small>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Amount</small>
                  <div class="fw-bold">$${amount.toFixed(2)}</div>
                </div>
                <div class="col-md-4">
                  <small class="text-muted">Description</small>
                  <div class="fw-bold">${escapeHtml(description)}</div>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Category</small>
                  <div class="fw-bold">${escapeHtml(category)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        expensesContainer.insertAdjacentHTML('beforeend', expenseHtml);
      });
      
      // Show warning if expenses exceed income
      const warningElement = document.getElementById("previewWarning");
      if (totalExpenses > incomeAmount) {
        warningElement.style.display = 'block';
        document.getElementById("previewWarningText").textContent = 
          `Warning: Expenses ($${totalExpenses.toFixed(2)}) exceed income ($${incomeAmount.toFixed(2)}) by $${(totalExpenses - incomeAmount).toFixed(2)}`;
      } else {
        warningElement.style.display = 'none';
      }
      
      splitPreviewModal.show();
    }
    
    async function saveSplitTransactions() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const incomeDescription = splitIncomeDescription.value.trim();
      const incomeBank = splitIncomeBank.value;
      const incomeDate = splitIncomeDate.value;
      
      if (!incomeAmount || incomeAmount <= 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please enter a valid income amount'
        });
        return;
      }
      
      if (!incomeDescription) {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please enter an income description'
        });
        return;
      }
      
      if (!incomeBank) {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please select an income bank account'
        });
        return;
      }
      
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      if (expenseElements.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Validation Error',
          text: 'Please add at least one expense'
        });
        return;
      }
      
      try {
        loadingMessage.textContent = "Saving split transactions...";
        loadingModal.show();
        
        // Save income transaction
        const incomeRef = await generateReferenceNumber();
        const incomeData = {
          DATE: incomeDate,
          SINO: formSINO.value,
          ACCOUNT_HEADER: "Income",
          BANK_NAME: incomeBank,
          MODE: incomeBank,
          TYPE: "Income",
          INCOME: incomeAmount,
          EXPENSE: 0,
          BALANCE: 0,
          DESCRIPTION: incomeDescription,
          NOTES: "Split income transaction",
          CURRENCY: "USD",
          STATUS: "completed",
          TAGS: ["split-income"],
          createdAt: new Date(),
          updatedAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), incomeData);
        
        // Save expense transactions
        for (const element of expenseElements) {
          const amount = parseFloat(element.querySelector('.split-amount-input').value) || 0;
          const description = element.querySelector('.split-description-input').value.trim();
          const bank = element.querySelector('.split-bank-input').value;
          const category = element.querySelector('.split-account-input').value;
          
          if (amount <= 0) continue;
          
          const expenseData = {
            DATE: incomeDate,
            SINO: await generateReferenceNumber(),
            ACCOUNT_HEADER: category || "Uncategorized",
            BANK_NAME: bank || incomeBank,
            MODE: bank || incomeBank,
            TYPE: "Expense",
            INCOME: 0,
            EXPENSE: amount,
            BALANCE: 0,
            DESCRIPTION: description || "Split expense",
            NOTES: "Split from income",
            CURRENCY: "USD",
            STATUS: "completed",
            TAGS: ["split-expense"],
            createdAt: new Date(),
            updatedAt: new Date(),
            userId: currentUser.uid
          };
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), expenseData);
        }
        
        loadingModal.hide();
        splitIncomeModal.hide();
        splitPreviewModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: `Created ${1 + expenseElements.length} transactions successfully`
        });
        
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("saveSplitTransactions error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to save transactions'
        });
      }
    }
    
    // Quick Add functions
    function openQuickAddModal() {
      quickAddInput.value = "";
      quickAddDate.value = new Date().toISOString().split('T')[0];
      quickAddAmount.value = "";
      
      // Clear preview
      quickAddType.textContent = "-";
      quickAddAmountPreview.textContent = "-";
      quickAddAccount.textContent = "-";
      quickAddCategory.textContent = "-";
      
      quickAddModal.show();
    }
    
    function parseQuickAddInput() {
      const text = quickAddInput.value.trim();
      if (!text) return;
      
      // Simple parsing logic
      const lowerText = text.toLowerCase();
      
      // Detect type
      let type = "Expense";
      if (lowerText.includes('received') || lowerText.includes('income') || lowerText.includes('salary') || 
          lowerText.includes('deposit') || lowerText.includes('payment received')) {
        type = "Income";
      } else if (lowerText.includes('transfer')) {
        type = "Transfer";
      }
      
      // Extract amount
      const amountMatch = text.match(/\d+(\.\d{1,2})?/);
      const amount = amountMatch ? parseFloat(amountMatch[0]) : 0;
      
      // Extract account (simple matching)
      let account = "";
      let category = "";
      
      for (const bank of coaBanks) {
        if (lowerText.includes(bank.toLowerCase())) {
          account = bank;
          break;
        }
      }
      
      for (const cat of coaAccounts) {
        if (lowerText.includes(cat.toLowerCase())) {
          category = cat;
          break;
        }
      }
      
      // Update preview
      quickAddType.textContent = type;
      quickAddType.className = type === 'Income' ? 'fw-bold text-success' : 
                               type === 'Expense' ? 'fw-bold text-danger' : 'fw-bold text-info';
      
      quickAddAmountPreview.textContent = amount > 0 ? `$${amount.toFixed(2)}` : "-";
      quickAddAccount.textContent = account || "-";
      quickAddCategory.textContent = category || "-";
      
      // Update form fields
      quickAddAmount.value = amount;
    }
    
    async function processQuickAdd() {
      const text = quickAddInput.value.trim();
      if (!text) {
        Swal.fire({
          icon: 'warning',
          title: 'Input required',
          text: 'Please enter a transaction description'
        });
        return;
      }
      
      const amount = parseFloat(quickAddAmount.value) || 0;
      if (amount <= 0) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid Amount',
          text: 'Please enter a valid amount'
        });
        return;
      }
      
      const type = quickAddType.textContent;
      const account = quickAddAccount.textContent;
      const category = quickAddCategory.textContent;
      const date = quickAddDate.value;
      
      try {
        loadingMessage.textContent = "Processing quick add...";
        loadingModal.show();
        
        const txData = {
          DATE: date,
          SINO: await generateReferenceNumber(),
          ACCOUNT_HEADER: category !== "-" ? category : "Uncategorized",
          BANK_NAME: account !== "-" ? account : "Cash",
          MODE: account !== "-" ? account : "Cash",
          TYPE: type,
          INCOME: type === "Income" ? amount : 0,
          EXPENSE: type === "Expense" || type === "Transfer" ? amount : 0,
          BALANCE: 0,
          DESCRIPTION: text,
          NOTES: "Quick add transaction",
          CURRENCY: "USD",
          STATUS: "completed",
          createdAt: new Date(),
          updatedAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
        
        loadingModal.hide();
        quickAddModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: 'Transaction added successfully'
        });
        
        await loadTransactions();
        
      } catch (err) {
        loadingModal.hide();
        console.error("processQuickAdd error:", err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to add transaction'
        });
      }
    }
    
    // Filter functions
    function toggleFilters() {
      const isVisible = filtersContainer.style.display === "block";
      filtersContainer.style.display = isVisible ? "none" : "block";
      filterToggleBtn.innerHTML = isVisible ? 
        '<i class="fa fa-filter me-1"></i> Show Filters' : 
        '<i class="fa fa-times me-1"></i> Hide Filters';
    }
    
    function handleDateFilterChange() {
      if (dateFilter.value === "custom") {
        customRangeControls.style.display = "flex";
      } else {
        customRangeControls.style.display = "none";
      }
    }
    
    function applyFilters() {
      filteredTransactions = allTransactions.slice();
      
      // Apply date filter
      const dateFilterValue = dateFilter.value;
      if (dateFilterValue !== "all") {
        const now = new Date();
        let startDate, endDate;
        
        switch (dateFilterValue) {
          case "today":
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "week":
            const day = now.getDay();
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
            break;
          case "month":
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
          case "year":
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear() + 1, 0, 1);
            break;
          case "custom":
            if (startDateInput.value && endDateInput.value) {
              startDate = new Date(startDateInput.value);
              endDate = new Date(endDateInput.value);
              endDate.setDate(endDate.getDate() + 1);
            }
            break;
          case "last7":
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "last30":
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "last90":
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 90);
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
        }
        
        if (startDate && endDate) {
          filteredTransactions = filteredTransactions.filter(tx => {
            if (!tx.DATE) return false;
            const txDate = new Date(tx.DATE);
            return txDate >= startDate && txDate < endDate;
          });
        }
      }
      
      // Apply type filter
      const typeFilterValue = typeFilter.value;
      if (typeFilterValue !== "all") {
        filteredTransactions = filteredTransactions.filter(tx => tx.TYPE === typeFilterValue);
      }
      
      // Apply bank filter
      const bankFilterValue = bankFilter.value;
      if (bankFilterValue !== "all") {
        filteredTransactions = filteredTransactions.filter(tx => 
          (tx.BANK_NAME || tx.MODE || "") === bankFilterValue
        );
      }
      
      // Apply category filter
      const categoryFilterValue = categoryFilter.value;
      if (categoryFilterValue !== "all") {
        filteredTransactions = filteredTransactions.filter(tx => 
          (tx.ACCOUNT_HEADER || "") === categoryFilterValue
        );
      }
      
      // Apply tags filter
      const selectedTags = $(tagsFilter).val() || [];
      if (selectedTags.length > 0 && !selectedTags.includes("all")) {
        filteredTransactions = filteredTransactions.filter(tx => {
          const txTags = tx.TAGS || [];
          return selectedTags.some(tagId => {
            const tag = availableTags.find(t => t.id === tagId);
            return tag && txTags.includes(tag.name);
          });
        });
      }
      
      // Apply search
      const searchTerm = searchDesc.value.trim().toLowerCase();
      if (searchTerm) {
        filteredTransactions = filteredTransactions.filter(tx => 
          (tx.DESCRIPTION || "").toLowerCase().includes(searchTerm) ||
          (tx.NOTES || "").toLowerCase().includes(searchTerm) ||
          (tx.SINO || "").toLowerCase().includes(searchTerm)
        );
      }
      
      // Apply amount filters
      const minAmountValue = parseFloat(minAmount.value);
      if (!isNaN(minAmountValue)) {
        filteredTransactions = filteredTransactions.filter(tx => {
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return amount >= minAmountValue;
        });
      }
      
      const maxAmountValue = parseFloat(maxAmount.value);
      if (!isNaN(maxAmountValue)) {
        filteredTransactions = filteredTransactions.filter(tx => {
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return amount <= maxAmountValue;
        });
      }
      
      // Apply sorting
      const sortValue = sortBy.value;
      switch (sortValue) {
        case "date-asc":
          filteredTransactions.sort((a, b) => new Date(a.DATE) - new Date(b.DATE));
          break;
        case "amount-desc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountB - amountA;
          });
          break;
        case "amount-asc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountA - amountB;
          });
          break;
        case "type":
          filteredTransactions.sort((a, b) => (a.TYPE || "").localeCompare(b.TYPE || ""));
          break;
        case "bank":
          filteredTransactions.sort((a, b) => (a.BANK_NAME || "").localeCompare(b.BANK_NAME || ""));
          break;
        default: // date-desc
          filteredTransactions.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
          break;
      }
      
      // Update page size
      const newPageSize = parseInt(pageSize.value);
      if (newPageSize !== rowsPerPage) {
        rowsPerPage = newPageSize;
        currentPage = 1;
      }
      
      // Reset to first page
      currentPage = 1;
      
      // Update UI
      buildTable();
      updateStats();
      saveAppState();
    }
    
    function resetFilters() {
      dateFilter.value = "all";
      typeFilter.value = "all";
      bankFilter.value = "all";
      categoryFilter.value = "all";
      $(tagsFilter).val([]).trigger('change');
      searchDesc.value = "";
      startDateInput.value = "";
      endDateInput.value = "";
      minAmount.value = "";
      maxAmount.value = "";
      sortBy.value = "date-desc";
      customRangeControls.style.display = "none";
      
      applyFilters();
    }
    
    function saveCurrentFilter() {
      const filterName = prompt("Enter a name for this filter:");
      if (!filterName) return;
      
      const filterData = {
        name: filterName,
        dateFilter: dateFilter.value,
        typeFilter: typeFilter.value,
        bankFilter: bankFilter.value,
        categoryFilter: categoryFilter.value,
        tagsFilter: $(tagsFilter).val(),
        searchDesc: searchDesc.value,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        minAmount: minAmount.value,
        maxAmount: maxAmount.value,
        sortBy: sortBy.value,
        savedAt: new Date().toISOString()
      };
      
      // Save to localStorage for now
      const savedFilters = JSON.parse(localStorage.getItem('savedFilters') || '[]');
      savedFilters.push(filterData);
      localStorage.setItem('savedFilters', JSON.stringify(savedFilters));
      
      Swal.fire({
        icon: 'success',
        title: 'Filter Saved',
        text: `Filter "${filterName}" has been saved.`
      });
      
      loadSavedFilters();
    }
    
    function loadSavedFilters() {
      const savedFilters = JSON.parse(localStorage.getItem('savedFilters') || '[]');
      if (savedFilters.length === 0) {
        savedFilters.style.display = 'none';
        return;
      }
      
      savedFiltersList.innerHTML = '';
      savedFilters.forEach((filter, index) => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary';
        button.textContent = filter.name;
        button.title = `Click to apply "${filter.name}" filter`;
        button.onclick = () => applySavedFilter(index);
        
        savedFiltersList.appendChild(button);
      });
      
      savedFilters.style.display = 'block';
    }
    
    function applySavedFilter(index) {
      const savedFilters = JSON.parse(localStorage.getItem('savedFilters') || '[]');
      if (index >= savedFilters.length) return;
      
      const filter = savedFilters[index];
      
      dateFilter.value = filter.dateFilter;
      typeFilter.value = filter.typeFilter;
      bankFilter.value = filter.bankFilter;
      categoryFilter.value = filter.categoryFilter;
      $(tagsFilter).val(filter.tagsFilter).trigger('change');
      searchDesc.value = filter.searchDesc;
      startDateInput.value = filter.startDate;
      endDateInput.value = filter.endDate;
      minAmount.value = filter.minAmount;
      maxAmount.value = filter.maxAmount;
      sortBy.value = filter.sortBy;
      
      if (dateFilter.value === "custom") {
        customRangeControls.style.display = "flex";
      }
      
      applyFilters();
      
      Swal.fire({
        icon: 'success',
        title: 'Filter Applied',
        text: `Applied filter "${filter.name}"`
      });
    }
    
    function toggleAdvancedFilters() {
      const isVisible = advancedFilters.style.display === "flex";
      advancedFilters.style.display = isVisible ? "none" : "flex";
      advancedFiltersBtn.textContent = isVisible ? "Advanced Filters" : "Hide Advanced";
    }
    
    // Stats and dashboard functions
    function updateStats() {
      const totalIncome = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      const count = filteredTransactions.length;
      
      statIncome.innerHTML = formatCurrency(totalIncome, 'USD');
      statExpense.innerHTML = formatCurrency(totalExpense, 'USD');
      statBalance.innerHTML = formatCurrency(balance, 'USD');
      statCount.textContent = count.toLocaleString();
      
      // Calculate changes (simplified)
      const incomeChangeValue = 0; // Would calculate from previous period
      const expenseChangeValue = 0;
      const balanceChangeValue = 0;
      const countChangeValue = 0;
      
      updateChangeIndicator(incomeChange, incomeChangeValue, true);
      updateChangeIndicator(expenseChange, expenseChangeValue, false);
      updateChangeIndicator(balanceChange, balanceChangeValue, balanceChangeValue >= 0);
      updateChangeIndicator(countChange, countChangeValue, true);
    }
    
    function updateChangeIndicator(element, value, isPositive) {
      if (!element) return;
      
      const prefix = value >= 0 ? '+' : '';
      element.textContent = `${prefix}${value.toFixed(1)}%`;
      element.className = `stat-change ${value >= 0 ? 'positive-change' : 'negative-change'}`;
    }
    
    function updateBankBalances() {
      const bankBalances = calculateBankBalances();
      
      bankBalancesContainer.innerHTML = "";
      
      // Add cash balance
      if (coaBanks.includes("Cash")) {
        const cashBalance = bankBalances["Cash"] || 0;
        addBankBalanceItem("Cash", cashBalance);
      }
      
      // Add other bank balances
      Object.entries(bankBalances).forEach(([bankName, balance]) => {
        if (bankName !== "Cash") {
          addBankBalanceItem(bankName, balance);
        }
      });
    }
    
    function calculateBankBalances() {
      const bankBalances = {};
      
      // Initialize with zero balances
      coaBanks.forEach(bank => {
        bankBalances[bank] = 0;
      });
      
      // Calculate balances from transactions
      allTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME || tx.MODE || "";
        if (bankName && coaBanks.includes(bankName)) {
          const income = parseFloat(tx.INCOME) || 0;
          const expense = parseFloat(tx.EXPENSE) || 0;
          bankBalances[bankName] += (income - expense);
        }
      });
      
      return bankBalances;
    }
    
    function addBankBalanceItem(name, balance) {
      const balanceItem = document.createElement("div");
      balanceItem.className = "bank-balance-item";
      balanceItem.innerHTML = `
        <div class="bank-balance-name">${escapeHtml(name)}</div>
        <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
          ${formatCurrency(balance, 'USD')}
        </div>
        <button class="balance-toggle" title="Toggle balance visibility" onclick="toggleBalanceVisibility()">
          <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
        </button>
      `;
      bankBalancesContainer.appendChild(balanceItem);
    }
    
    function updateQuickStats() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      // Monthly stats
      const monthlyIncome = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && 
                 txDate.getFullYear() === thisYear && 
                 tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && 
                 txDate.getFullYear() === thisYear && 
                 tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
        
      const savingsRate = monthlyIncome > 0 ? 
        ((monthlyIncome - monthlyExpenses) / monthlyIncome * 100) : 0;
      
      // Today's stats
      const today = now.toISOString().split('T')[0];
      const todayIncome = allTransactions
        .filter(tx => tx.DATE === today && tx.TYPE === 'Income')
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const todayExpenses = allTransactions
        .filter(tx => tx.DATE === today && tx.TYPE === 'Expense')
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      quickStatsContainer.innerHTML = `
        <div class="quick-stat">
          <i class="fa fa-arrow-up text-success"></i>
          <span>Monthly Income: <strong>${formatCurrency(monthlyIncome, 'USD')}</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-arrow-down text-danger"></i>
          <span>Monthly Expenses: <strong>${formatCurrency(monthlyExpenses, 'USD')}</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-percentage text-info"></i>
          <span>Savings Rate: <strong>${savingsRate.toFixed(1)}%</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-calendar-day text-primary"></i>
          <span>Today: <strong>${formatCurrency(todayIncome - todayExpenses, 'USD')}</strong></span>
        </div>
      `;
    }
    
    function updateDashboardCharts() {
      updateTransactionsChart();
      updateCategoryChart();
      updateUpcomingTransactions();
      updateRecentAlerts();
    }
    
    function updateTransactionsChart() {
      if (!transactionsChart) return;
      
      // Group by month
      const monthlyData = {};
      allTransactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = { income: 0, expense: 0, transfer: 0 };
          }
          
          if (tx.TYPE === 'Income') {
            monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
          } else if (tx.TYPE === 'Expense') {
            monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
          } else if (tx.TYPE === 'Transfer') {
            monthlyData[monthYear].transfer += (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          }
        }
      });
      
      // Sort months
      const sortedMonths = Object.keys(monthlyData).sort();
      const last6Months = sortedMonths.slice(-6);
      
      const incomeData = last6Months.map(month => monthlyData[month].income);
      const expenseData = last6Months.map(month => monthlyData[month].expense);
      
      const monthLabels = last6Months.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return date.toLocaleString('default', { month: 'short', year: '2-digit' });
      });
      
      // Destroy existing chart
      if (transactionsChartInstance) {
        transactionsChartInstance.destroy();
      }
      
      const ctx = transactionsChart.getContext('2d');
      transactionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Monthly Income vs Expenses'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': $' + context.raw.toFixed(2);
                }
              }
            }
          }
        }
      });
    }
    
    function updateCategoryChart() {
      if (!categoryChart) return;
      
      // Group expenses by category
      const categoryData = {};
      allTransactions
        .filter(tx => tx.TYPE === 'Expense')
        .forEach(tx => {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          const amount = parseFloat(tx.EXPENSE) || 0;
          
          categoryData[category] = (categoryData[category] || 0) + amount;
        });
      
      // Get top 5 categories
      const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const labels = sortedCategories.map(([category]) => category);
      const data = sortedCategories.map(([, amount]) => amount);
      
      // Colors for pie chart
      const backgroundColors = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)'
      ];
      
      const ctx = categoryChart.getContext('2d');
      
      // Destroy existing chart if any
      if (categoryChart._chart) {
        categoryChart._chart.destroy();
      }
      
      categoryChart._chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
            },
            title: {
              display: true,
              text: 'Top Expense Categories'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function updateUpcomingTransactions() {
      if (!upcomingTransactions) return;
      
      // Get transactions for next 7 days
      const today = new Date();
      const nextWeek = new Date();
      nextWeek.setDate(today.getDate() + 7);
      
      const upcoming = allTransactions
        .filter(tx => {
          if (!tx.DATE) return false;
          const txDate = new Date(tx.DATE);
          return txDate >= today && txDate <= nextWeek;
        })
        .sort((a, b) => new Date(a.DATE) - new Date(b.DATE))
        .slice(0, 5);
      
      if (upcoming.length === 0) {
        upcomingTransactions.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="fa fa-calendar fa-2x mb-2"></i>
            <p class="small">No upcoming transactions</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      upcoming.forEach(tx => {
        const date = formatDate(tx.DATE);
        const amount = tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE;
        const typeClass = tx.TYPE === 'Income' ? 'text-success' : 'text-danger';
        
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
            <div>
              <div class="fw-semibold">${escapeHtml(tx.DESCRIPTION || 'No description')}</div>
              <small class="text-muted">${date}  ${escapeHtml(tx.ACCOUNT_HEADER || 'Uncategorized')}</small>
            </div>
            <div class="${typeClass} fw-bold">
              ${tx.TYPE === 'Income' ? '+' : '-'}${formatCurrency(amount, tx.CURRENCY)}
            </div>
          </div>
        `;
      });
      
      upcomingTransactions.innerHTML = html;
    }
    
    function updateRecentAlerts() {
      if (!recentAlerts) return;
      
      // Generate sample alerts (in real app, these would come from your data)
      const alerts = [
        { type: 'warning', message: 'Monthly grocery budget is 80% used', time: '2 hours ago' },
        { type: 'info', message: 'Recurring subscription due in 3 days', time: '1 day ago' },
        { type: 'success', message: 'Savings goal for this month achieved', time: '2 days ago' }
      ];
      
      let html = '';
      alerts.forEach(alert => {
        const alertClass = alert.type === 'warning' ? 'alert-warning' : 
                          alert.type === 'info' ? 'alert-info' : 'alert-success';
        
        html += `
          <div class="alert ${alertClass} alert-sm mb-2">
            <div class="small">${alert.message}</div>
            <small class="text-muted">${alert.time}</small>
          </div>
        `;
      });
      
      recentAlerts.innerHTML = html;
    }
    
    function updateTransactionCountBadge() {
      const badge = document.getElementById("txCountBadge");
      if (badge) {
        badge.textContent = allTransactions.length.toString();
      }
    }
    
    function updateDashboard() {
      updateQuickStats();
      updateBankBalances();
      updateDashboardCharts();
    }
    
    // Import/Export functions
    function openImportModal() {
      importModal.show();
    }
    
    function handleImportFileSelect() {
      const file = importFile.files[0];
      if (!file) return;
      
      // Show preview
      importPreview.style.display = 'block';
      
      // Read file based on type
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = e.target.result;
        
        if (file.name.endsWith('.csv')) {
          parseCSVData(data);
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          parseExcelData(data);
        } else if (file.name.endsWith('.json')) {
          parseJSONData(data);
        }
      };
      
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      } else if (file.name.endsWith('.json')) {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    }
    
    function parseCSVData(csvText) {
      const rows = csvText.split('\n').map(row => row.split(','));
      if (rows.length < 2) return;
      
      const headers = rows[0];
      const previewRows = rows.slice(1, 6);
      
      // Update preview table
      importPreviewHeader.innerHTML = headers.map(header => 
        `<th>${escapeHtml(header)}</th>`
      ).join('');
      
      importPreviewBody.innerHTML = previewRows.map(row => 
        `<tr>${row.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`
      ).join('');
    }
    
    function parseExcelData(binaryData) {
      try {
        const workbook = XLSX.read(binaryData, { type: 'binary' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (data.length < 2) return;
        
        const headers = data[0];
        const previewRows = data.slice(1, 6);
        
        // Update preview table
        importPreviewHeader.innerHTML = headers.map(header => 
          `<th>${escapeHtml(header)}</th>`
        ).join('');
        
        importPreviewBody.innerHTML = previewRows.map(row => 
          `<tr>${headers.map((_, index) => 
            `<td>${escapeHtml(row[index] || '')}</td>`
          ).join('')}</tr>`
        ).join('');
        
      } catch (error) {
        console.error("Error parsing Excel file:", error);
        Swal.fire({
          icon: 'error',
          title: 'Parse Error',
          text: 'Failed to parse Excel file. Please check the format.'
        });
      }
    }
    
    function parseJSONData(jsonText) {
      try {
        const data = JSON.parse(jsonText);
        if (!Array.isArray(data) || data.length === 0) return;
        
        // Get headers from first object
        const firstItem = data[0];
        const headers = Object.keys(firstItem);
        const previewRows = data.slice(0, 5);
        
        // Update preview table
        importPreviewHeader.innerHTML = headers.map(header => 
          `<th>${escapeHtml(header)}</th>`
        ).join('');
        
        importPreviewBody.innerHTML = previewRows.map(row => 
          `<tr>${headers.map(header => 
            `<td>${escapeHtml(row[header] || '')}</td>`
          ).join('')}</tr>`
        ).join('');
        
      } catch (error) {
        console.error("Error parsing JSON file:", error);
        Swal.fire({
          icon: 'error',
          title: 'Parse Error',
          text: 'Failed to parse JSON file. Please check the format.'
        });
      }
    }
    
    async function processImport() {
      const file = importFile.files[0];
      if (!file) {
        Swal.fire({
          icon: 'warning',
          title: 'No File',
          text: 'Please select a file to import'
        });
        return;
      }
      
      try {
        loadingMessage.textContent = "Importing transactions...";
        loadingModal.show();
        importProgress.style.display = 'block';
        
        // Read file
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const data = e.target.result;
            let transactions = [];
            
            if (file.name.endsWith('.csv')) {
              transactions = parseCSVToTransactions(data);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
              transactions = parseExcelToTransactions(data);
            } else if (file.name.endsWith('.json')) {
              transactions = parseJSONToTransactions(data);
            }
            
            if (transactions.length === 0) {
              throw new Error('No valid transactions found in file');
            }
            
            // Save transactions to Firebase
            const batch = writeBatch(db);
            let importedCount = 0;
            
            for (const tx of transactions) {
              // Add required fields
              const txData = {
                ...tx,
                createdAt: new Date(),
                updatedAt: new Date(),
                userId: currentUser.uid,
                BALANCE: 0 // Will be recalculated
              };
              
              const docRef = doc(collection(db, "users", currentUser.uid, "transactions"));
              batch.set(docRef, txData);
              importedCount++;
              
              // Update progress
              const progress = Math.floor((importedCount / transactions.length) * 100);
              importProgressBar.style.width = `${progress}%`;
              importProgressBar.textContent = `${progress}%`;
              importStatus.textContent = `Imported ${importedCount} of ${transactions.length} transactions`;
            }
            
            await batch.commit();
            
            loadingModal.hide();
            importModal.hide();
            
            Swal.fire({
              icon: 'success',
              title: 'Import Complete',
              text: `Successfully imported ${importedCount} transactions`
            });
            
            // Reload data
            await loadTransactions();
            
          } catch (error) {
            loadingModal.hide();
            console.error("Import processing error:", error);
            Swal.fire({
              icon: 'error',
              title: 'Import Failed',
              text: error.message || 'Failed to import transactions'
            });
          }
        };
        
        if (file.name.endsWith('.csv') || file.name.endsWith('.json')) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
        
      } catch (error) {
        loadingModal.hide();
        console.error("Import error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Import Error',
          text: 'Failed to process import file'
        });
      }
    }
    
    function parseCSVToTransactions(csvText) {
      const rows = csvText.split('\n').filter(row => row.trim());
      if (rows.length < 2) return [];
      
      const headers = rows[0].split(',').map(h => h.trim());
      const transactions = [];
      
      for (let i = 1; i < rows.length; i++) {
        const values = rows[i].split(',').map(v => v.trim());
        if (values.length !== headers.length) continue;
        
        const tx = {};
        headers.forEach((header, index) => {
          tx[header] = values[index];
        });
        
        // Map to our transaction format
        const mappedTx = mapImportedTransaction(tx);
        if (mappedTx) {
          transactions.push(mappedTx);
        }
      }
      
      return transactions;
    }
    
    function mapImportedTransaction(rawTx) {
      try {
        // This is a simple mapping - in a real app, you'd have a mapping interface
        const tx = {
          DATE: rawTx.Date || rawTx.date || new Date().toISOString().split('T')[0],
          DESCRIPTION: rawTx.Description || rawTx.description || 'Imported transaction',
          NOTES: rawTx.Notes || rawTx.notes || '',
          CURRENCY: rawTx.Currency || rawTx.currency || 'USD',
          STATUS: 'completed'
        };
        
        // Determine type and amount
        if (rawTx.Type && rawTx.Type.toLowerCase() === 'income') {
          tx.TYPE = 'Income';
          tx.INCOME = parseFloat(rawTx.Amount || rawTx.amount || 0);
          tx.EXPENSE = 0;
        } else if (rawTx.Type && rawTx.Type.toLowerCase() === 'expense') {
          tx.TYPE = 'Expense';
          tx.INCOME = 0;
          tx.EXPENSE = parseFloat(rawTx.Amount || rawTx.amount || 0);
        } else {
          // Try to infer from amount sign
          const amount = parseFloat(rawTx.Amount || rawTx.amount || 0);
          if (amount >= 0) {
            tx.TYPE = 'Income';
            tx.INCOME = amount;
            tx.EXPENSE = 0;
          } else {
            tx.TYPE = 'Expense';
            tx.INCOME = 0;
            tx.EXPENSE = Math.abs(amount);
          }
        }
        
        // Bank and category
        tx.BANK_NAME = rawTx.Bank || rawTx.Account || rawTx.bank || 'Cash';
        tx.MODE = tx.BANK_NAME;
        tx.ACCOUNT_HEADER = rawTx.Category || rawTx.category || 'Uncategorized';
        
        // Generate reference
        tx.SINO = rawTx.Reference || rawTx.ref || `IMP${Date.now().toString().slice(-6)}`;
        
        return tx;
      } catch (error) {
        console.error("Error mapping transaction:", error);
        return null;
      }
    }
    
    function openExportModal(format) {
      if (format) {
        exportFormat.value = format;
      }
      
      exportCount.textContent = filteredTransactions.length.toLocaleString();
      exportModal.show();
    }
    
    async function processExport() {
      const format = exportFormat.value;
      const dateRange = exportDateRange.value;
      
      let transactionsToExport = filteredTransactions;
      
      // Apply date range filter
      if (dateRange === 'custom' && exportStartDate.value && exportEndDate.value) {
        const startDate = new Date(exportStartDate.value);
        const endDate = new Date(exportEndDate.value);
        endDate.setDate(endDate.getDate() + 1);
        
        transactionsToExport = transactionsToExport.filter(tx => {
          if (!tx.DATE) return false;
          const txDate = new Date(tx.DATE);
          return txDate >= startDate && txDate < endDate;
        });
      }
      
      if (transactionsToExport.length === 0) {
        Swal.fire({
          icon: 'warning',
          title: 'No Data',
          text: 'No transactions to export with the selected filters.'
        });
        return;
      }
      
      try {
        loadingMessage.textContent = "Preparing export...";
        loadingModal.show();
        
        switch (format) {
          case 'csv':
            exportToCSV(transactionsToExport);
            break;
          case 'excel':
            exportToExcel(transactionsToExport);
            break;
          case 'json':
            exportToJSON(transactionsToExport);
            break;
          case 'pdf':
            exportToPDF(transactionsToExport);
            break;
        }
        
        loadingModal.hide();
        exportModal.hide();
        
      } catch (error) {
        loadingModal.hide();
        console.error("Export error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Export Failed',
          text: 'Failed to export transactions'
        });
      }
    }
    
    function exportToCSV(transactions) {
      const headers = [
        'Date', 'Type', 'Description', 'Amount', 'Category', 'Bank', 
        'Reference', 'Status', 'Currency', 'Tags', 'Notes'
      ];
      
      const rows = transactions.map(tx => [
        tx.DATE || '',
        tx.TYPE || '',
        `"${(tx.DESCRIPTION || '').replace(/"/g, '""')}"`,
        tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE,
        tx.ACCOUNT_HEADER || '',
        tx.BANK_NAME || '',
        tx.SINO || '',
        tx.STATUS || '',
        tx.CURRENCY || '',
        (tx.TAGS || []).join(';'),
        `"${(tx.NOTES || '').replace(/"/g, '""')}"`
      ]);
      
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');
      
      downloadFile(csvContent, 'transactions.csv', 'text/csv');
    }
    
    function exportToExcel(transactions) {
      const data = transactions.map(tx => ({
        Date: tx.DATE || '',
        Type: tx.TYPE || '',
        Description: tx.DESCRIPTION || '',
        Amount: tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE,
        Category: tx.ACCOUNT_HEADER || '',
        Bank: tx.BANK_NAME || '',
        Reference: tx.SINO || '',
        Status: tx.STATUS || '',
        Currency: tx.CURRENCY || '',
        Tags: (tx.TAGS || []).join(';'),
        Notes: tx.NOTES || ''
      }));
      
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Transactions');
      
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      
      downloadFile(blob, 'transactions.xlsx', blob.type);
    }
    
    function exportToJSON(transactions) {
      const data = transactions.map(tx => ({
        id: tx.id,
        date: tx.DATE,
        type: tx.TYPE,
        description: tx.DESCRIPTION,
        amount: tx.TYPE === 'Income' ? tx.INCOME : tx.EXPENSE,
        category: tx.ACCOUNT_HEADER,
        bank: tx.BANK_NAME,
        reference: tx.SINO,
        status: tx.STATUS,
        currency: tx.CURRENCY,
        tags: tx.TAGS || [],
        notes: tx.NOTES,
        createdAt: tx.createdAt,
        updatedAt: tx.updatedAt
      }));
      
      const jsonContent = JSON.stringify(data, null, 2);
      downloadFile(jsonContent, 'transactions.json', 'application/json');
    }
    
    function exportToPDF(transactions) {
      // Simple PDF export using browser print
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Transactions Export</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .total { font-weight: bold; margin-top: 20px; }
            </style>
          </head>
          <body>
            <h1>Transactions Report</h1>
            <p>Generated on ${new Date().toLocaleDateString()}</p>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Category</th>
                  <th>Bank</th>
                </tr>
              </thead>
              <tbody>
                ${transactions.map(tx => `
                  <tr>
                    <td>${tx.DATE || ''}</td>
                    <td>${tx.TYPE || ''}</td>
                    <td>${tx.DESCRIPTION || ''}</td>
                    <td>${tx.TYPE === 'Income' ? '$' + tx.INCOME.toFixed(2) : '$' + tx.EXPENSE.toFixed(2)}</td>
                    <td>${tx.ACCOUNT_HEADER || ''}</td>
                    <td>${tx.BANK_NAME || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="total">
              Total Transactions: ${transactions.length}<br>
              Total Income: $${transactions.filter(t => t.TYPE === 'Income').reduce((sum, t) => sum + (t.INCOME || 0), 0).toFixed(2)}<br>
              Total Expenses: $${transactions.filter(t => t.TYPE === 'Expense').reduce((sum, t) => sum + (t.EXPENSE || 0), 0).toFixed(2)}
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    
    // Settings functions
    async function saveUserSettings() {
      try {
        // Collect settings
        userSettings.theme = document.getElementById("settingTheme").value;
        userSettings.showBalances = document.getElementById("settingShowBalances").checked;
        userSettings.pageSize = parseInt(document.getElementById("settingPageSize").value);
        userSettings.currency = document.getElementById("settingCurrency").value;
        userSettings.defaultType = document.getElementById("settingDefaultType").value;
        userSettings.defaultBank = document.getElementById("settingDefaultBank").value;
        userSettings.dateFormat = document.getElementById("settingDateFormat").value;
        userSettings.compactView = document.getElementById("settingCompactView").checked;
        userSettings.showCharts = document.getElementById("settingShowCharts").checked;
        
        // Notification settings
        userSettings.notifyLargeTx = document.getElementById("settingNotifyLargeTx").checked;
        userSettings.largeTxAmount = parseFloat(document.getElementById("settingLargeTxAmount").value) || 1000;
        userSettings.notifyBudget = document.getElementById("settingNotifyBudget").checked;
        userSettings.notifyRecurring = document.getElementById("settingNotifyRecurring").checked;
        userSettings.recurringNotifyDays = parseInt(document.getElementById("settingRecurringNotifyDays").value) || 3;
        userSettings.emailReports = document.getElementById("settingEmailReports").checked;
        
        // Save to Firebase
        await setDoc(doc(db, "users", currentUser.uid, "settings", "preferences"), userSettings);
        
        // Apply settings
        updateUIFromSettings();
        
        settingsModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Settings Saved',
          text: 'Your settings have been saved successfully.'
        });
        
      } catch (error) {
        console.error("Error saving settings:", error);
        Swal.fire({
          icon: 'error',
          title: 'Save Failed',
          text: 'Failed to save settings. Please try again.'
        });
      }
    }
    
    function updateUIFromSettings() {
      // Apply theme
      currentTheme = userSettings.theme || 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggleSwitch.checked = currentTheme === 'dark';
      
      // Apply balance visibility
      balanceVisible = userSettings.showBalances || false;
      updateBalanceDisplay();
      
      // Apply page size
      rowsPerPage = userSettings.pageSize || 10;
      if (pageSize) {
        pageSize.value = rowsPerPage.toString();
      }
      
      // Update form defaults
      if (formCURRENCY) formCURRENCY.value = userSettings.currency || 'USD';
      if (formTYPE) formTYPE.value = userSettings.defaultType || 'Expense';
      if (formBANKNAME) formBANKNAME.value = userSettings.defaultBank || '';
      
      // Show/hide charts based on setting
      if (userSettings.showCharts === false) {
        document.querySelectorAll('.chart-container, .dashboard-grid').forEach(el => {
          el.style.display = 'none';
        });
      }
    }
    
    async function backupAllData() {
      try {
        loadingMessage.textContent = "Creating backup...";
        loadingModal.show();
        
        // Get all user data
        const [txSnapshot, coaSnapshot, tagsSnapshot, categoriesSnapshot, settingsSnapshot] = await Promise.all([
          getDocs(collection(db, "users", currentUser.uid, "transactions")),
          getDocs(collection(db, "users", currentUser.uid, "chartOfAccounts")),
          getDocs(collection(db, "users", currentUser.uid, "tags")),
          getDocs(collection(db, "users", currentUser.uid, "categories")),
          getDocs(collection(db, "users", currentUser.uid, "settings"))
        ]);
        
        const backupData = {
          timestamp: new Date().toISOString(),
          userId: currentUser.uid,
          transactions: txSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
          chartOfAccounts: coaSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
          tags: tagsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
          categories: categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
          settings: settingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        };
        
        const jsonContent = JSON.stringify(backupData, null, 2);
        const filename = `finance-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
        
        loadingModal.hide();
        
        downloadFile(jsonContent, filename, 'application/json');
        
        Swal.fire({
          icon: 'success',
          title: 'Backup Created',
          text: 'All your data has been backed up successfully.'
        });
        
      } catch (error) {
        loadingModal.hide();
        console.error("Backup error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Backup Failed',
          text: 'Failed to create backup. Please try again.'
        });
      }
    }
    
    async function confirmClearAllData() {
      const result = await Swal.fire({
        icon: 'warning',
        title: 'Clear All Data?',
        text: 'This will permanently delete ALL your transactions. This action cannot be undone.',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete Everything',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#dc3545'
      });
      
      if (result.isConfirmed) {
        await clearAllData();
      }
    }
    
    async function clearAllData() {
      try {
        loadingMessage.textContent = "Clearing all data...";
        loadingModal.show();
        
        // Get all transactions
        const txSnapshot = await getDocs(collection(db, "users", currentUser.uid, "transactions"));
        
        // Delete in batches
        const batch = writeBatch(db);
        txSnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        loadingModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Data Cleared',
          text: 'All transactions have been deleted.'
        });
        
        // Reload transactions
        await loadTransactions();
        
      } catch (error) {
        loadingModal.hide();
        console.error("Clear data error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Clear Failed',
          text: 'Failed to clear data. Please try again.'
        });
      }
    }
    
    function exportSettings() {
      const settingsData = {
        timestamp: new Date().toISOString(),
        settings: userSettings
      };
      
      const jsonContent = JSON.stringify(settingsData, null, 2);
      downloadFile(jsonContent, 'finance-settings.json', 'application/json');
    }
    
    async function importSettings() {
      // This would implement settings import from file
      Swal.fire({
        icon: 'info',
        title: 'Import Settings',
        text: 'Settings import functionality would be implemented here.'
      });
    }
    
    // Welcome and setup functions
    function skipSetup() {
      if (dontShowAgain.checked) {
        userSettings.hideWelcome = true;
        saveUserSettings();
      }
      welcomeModal.hide();
    }
    
    function startGuidedSetup() {
      welcomeModal.hide();
      guidedSetupModal.show();
      loadSetupStep(1);
    }
    
    function startImportSetup() {
      welcomeModal.hide();
      importModal.show();
    }
    
    let currentSetupStep = 1;
    const totalSetupSteps = 5;
    
    function loadSetupStep(step) {
      currentSetupStep = step;
      
      // Update progress
      const progress = ((step - 1) / (totalSetupSteps - 1)) * 100;
      setupProgressBar.style.width = `${progress}%`;
      setupPercent.textContent = `${Math.round(progress)}%`;
      setupStepText.textContent = `Step ${step} of ${totalSetupSteps}`;
      
      // Update buttons
      setupPrevBtn.disabled = step === 1;
      setupNextBtn.textContent = step === totalSetupSteps ? 'Finish' : 'Next';
      setupSkipBtn.style.display = step < totalSetupSteps ? 'inline-block' : 'none';
      
      // Load step content
      let stepTitle = '';
      let stepContent = '';
      
      switch (step) {
        case 1:
          stepTitle = 'Add Your First Bank Account';
          stepContent = `
            <div class="mb-3">
              <label class="form-label">Bank Account Name</label>
              <input type="text" class="form-control" id="setupBankName" placeholder="e.g., Checking Account">
            </div>
            <div class="mb-3">
              <label class="form-label">Initial Balance</label>
              <input type="number" class="form-control" id="setupInitialBalance" placeholder="0.00" step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Account Type</label>
              <select class="form-select" id="setupAccountType">
                <option value="checking">Checking Account</option>
                <option value="savings">Savings Account</option>
                <option value="credit">Credit Card</option>
                <option value="cash">Cash</option>
              </select>
            </div>
          `;
          break;
          
        case 2:
          stepTitle = 'Set Up Income Categories';
          stepContent = `
            <p class="text-muted mb-3">Add common sources of income to track where your money comes from.</p>
            <div class="mb-3">
              <div class="input-group">
                <input type="text" class="form-control" id="setupIncomeCategory" placeholder="e.g., Salary, Freelance, Investments">
                <button class="btn btn-outline-primary" onclick="addSetupCategory('income')">Add</button>
              </div>
            </div>
            <div id="setupIncomeCategories" class="mb-3">
              <!-- Categories will be added here -->
            </div>
          `;
          break;
          
        case 3:
          stepTitle = 'Set Up Expense Categories';
          stepContent = `
            <p class="text-muted mb-3">Add common expense categories to track where your money goes.</p>
            <div class="mb-3">
              <div class="input-group">
                <input type="text" class="form-control" id="setupExpenseCategory" placeholder="e.g., Rent, Groceries, Transportation">
                <button class="btn btn-outline-primary" onclick="addSetupCategory('expense')">Add</button>
              </div>
            </div>
            <div id="setupExpenseCategories" class="mb-3">
              <!-- Categories will be added here -->
            </div>
          `;
          break;
          
        case 4:
          stepTitle = 'Add Your First Transaction';
          stepContent = `
            <p class="text-muted mb-3">Let's add your first transaction to get started.</p>
            <div class="mb-3">
              <label class="form-label">Transaction Type</label>
              <select class="form-select" id="setupTxType">
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Amount</label>
              <input type="number" class="form-control" id="setupTxAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" id="setupTxDescription" placeholder="What was this for?">
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select" id="setupTxCategory">
                <option value="">Select category</option>
              </select>
            </div>
          `;
          break;
          
        case 5:
          stepTitle = 'Setup Complete!';
          stepContent = `
            <div class="text-center py-4">
              <i class="fa fa-check-circle fa-4x text-success mb-3"></i>
              <h4>You're All Set!</h4>
              <p class="text-muted">Your Finance Manager is now ready to use. You can:</p>
              <ul class="text-start">
                <li>Add more transactions</li>
                <li>Set up budgets</li>
                <li>Create recurring transactions</li>
                <li>Generate reports</li>
              </ul>
            </div>
          `;
          break;
      }
      
      setupStepTitle.textContent = stepTitle;
      setupStepContent.innerHTML = stepContent;
      
      // Initialize step-specific functionality
      if (step === 4) {
        populateSetupCategories();
      }
    }
    
    function previousSetupStep() {
      if (currentSetupStep > 1) {
        loadSetupStep(currentSetupStep - 1);
      }
    }
    
    async function nextSetupStep() {
      if (currentSetupStep < totalSetupSteps) {
        // Save current step data if needed
        await saveSetupStepData(currentSetupStep);
        loadSetupStep(currentSetupStep + 1);
      } else {
        // Finish setup
        await finishSetup();
      }
    }
    
    function skipSetupStep() {
      if (currentSetupStep < totalSetupSteps) {
        loadSetupStep(currentSetupStep + 1);
      }
    }
    
    async function saveSetupStepData(step) {
      try {
        switch (step) {
          case 1:
            const bankName = document.getElementById("setupBankName").value;
            const initialBalance = parseFloat(document.getElementById("setupInitialBalance").value) || 0;
            const accountType = document.getElementById("setupAccountType").value;
            
            if (bankName) {
              // Save bank account to COA
              const bankData = {
                name: bankName,
                type: 'Asset',
                category: 'Bank',
                balance: initialBalance,
                createdAt: new Date(),
                userId: currentUser.uid
              };
              
              await addDoc(collection(db, "users", currentUser.uid, "chartOfAccounts"), bankData);
              
              // Add initial balance transaction if needed
              if (initialBalance > 0) {
                const txData = {
                  DATE: new Date().toISOString().split('T')[0],
                  SINO: `INIT${Date.now().toString().slice(-6)}`,
                  ACCOUNT_HEADER: 'Initial Balance',
                  BANK_NAME: bankName,
                  MODE: bankName,
                  TYPE: 'Income',
                  INCOME: initialBalance,
                  EXPENSE: 0,
                  BALANCE: initialBalance,
                  DESCRIPTION: 'Initial account balance',
                  NOTES: 'Setup transaction',
                  CURRENCY: 'USD',
                  STATUS: 'completed',
                  createdAt: new Date(),
                  updatedAt: new Date(),
                  userId: currentUser.uid
                };
                
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
              }
            }
            break;
            
          case 4:
            const txType = document.getElementById("setupTxType").value;
            const txAmount = parseFloat(document.getElementById("setupTxAmount").value) || 0;
            const txDescription = document.getElementById("setupTxDescription").value;
            const txCategory = document.getElementById("setupTxCategory").value;
            
            if (txAmount > 0 && txDescription && txCategory) {
              const txData = {
                DATE: new Date().toISOString().split('T')[0],
                SINO: `SETUP${Date.now().toString().slice(-6)}`,
                ACCOUNT_HEADER: txCategory,
                BANK_NAME: document.getElementById("setupBankName").value || 'Cash',
                MODE: document.getElementById("setupBankName").value || 'Cash',
                TYPE: txType,
                INCOME: txType === 'Income' ? txAmount : 0,
                EXPENSE: txType === 'Expense' ? txAmount : 0,
                BALANCE: 0,
                DESCRIPTION: txDescription,
                NOTES: 'Setup transaction',
                CURRENCY: 'USD',
                STATUS: 'completed',
                createdAt: new Date(),
                updatedAt: new Date(),
                userId: currentUser.uid
              };
              
              await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
            }
            break;
        }
      } catch (error) {
        console.error("Error saving setup data:", error);
      }
    }
    
    async function finishSetup() {
      try {
        // Save that setup is complete
        userSettings.setupComplete = true;
        userSettings.hideWelcome = dontShowAgain.checked;
        
        await setDoc(doc(db, "users", currentUser.uid, "settings", "preferences"), userSettings);
        
        guidedSetupModal.hide();
        
        Swal.fire({
          icon: 'success',
          title: 'Setup Complete!',
          text: 'Your Finance Manager is now ready to use.',
          confirmButtonText: 'Get Started'
        }).then(() => {
          // Reload data to show new transactions
          loadTransactions();
        });
        
      } catch (error) {
        console.error("Error finishing setup:", error);
        Swal.fire({
          icon: 'error',
          title: 'Setup Error',
          text: 'There was an error completing setup.'
        });
      }
    }
    
    // Utility functions for setup
    window.addSetupCategory = function(type) {
      const inputId = type === 'income' ? 'setupIncomeCategory' : 'setupExpenseCategory';
      const containerId = type === 'income' ? 'setupIncomeCategories' : 'setupExpenseCategories';
      
      const input = document.getElementById(inputId);
      const category = input.value.trim();
      
      if (!category) return;
      
      const categoryElement = document.createElement('div');
      categoryElement.className = 'badge bg-primary me-2 mb-2';
      categoryElement.style.cursor = 'pointer';
      categoryElement.innerHTML = `
        ${escapeHtml(category)}
        <span class="ms-1" onclick="this.parentElement.remove()"></span>
      `;
      
      document.getElementById(containerId).appendChild(categoryElement);
      input.value = '';
    };
    
    function populateSetupCategories() {
      const select = document.getElementById("setupTxCategory");
      select.innerHTML = '<option value="">Select category</option>';
      
      // Add income categories
      const incomeContainer = document.getElementById("setupIncomeCategories");
      if (incomeContainer) {
        incomeContainer.querySelectorAll('.badge').forEach(badge => {
          const option = document.createElement('option');
          option.value = badge.textContent.replace('', '').trim();
          option.textContent = option.value;
          select.appendChild(option);
        });
      }
      
      // Add expense categories
      const expenseContainer = document.getElementById("setupExpenseCategories");
      if (expenseContainer) {
        expenseContainer.querySelectorAll('.badge').forEach(badge => {
          const option = document.createElement('option');
          option.value = badge.textContent.replace('', '').trim();
          option.textContent = option.value;
          select.appendChild(option);
        });
      }
    }
    
    // Recurring transaction modal
    function openRecurringModal() {
      recurringModal.show();
    }
    
    // Category management modal
    function openCategoryModal() {
      categoryModal.show();
    }
    
    // Tag management modal
    function openTagModal() {
      tagModal.show();
    }
    
    // View all transactions
    function viewAllTransactions() {
      resetFilters();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Refresh data
    async function refreshData() {
      await loadTransactions();
      Swal.fire({
        icon: 'success',
        title: 'Refreshed',
        text: 'Data has been refreshed.',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    // Duplicate selected transaction
    async function duplicateSelectedTransaction() {
      if (selectedTransactions.size !== 1) {
        Swal.fire({
          icon: 'warning',
          title: 'Select One',
          text: 'Please select exactly one transaction to duplicate.'
        });
        return;
      }
      
      const selectedId = Array.from(selectedTransactions)[0];
      await duplicateTransaction(selectedId);
    }
    
    // Add attachment to selected transaction
    async function addAttachmentToSelected() {
      if (selectedTransactions.size !== 1) {
        Swal.fire({
          icon: 'warning',
          title: 'Select One',
          text: 'Please select exactly one transaction to add attachment to.'
        });
        return;
      }
      
      const selectedId = Array.from(selectedTransactions)[0];
      const tx = allTransactions.find(t => t.id === selectedId);
      
      if (!tx) return;
      
      // Open edit modal for the transaction
      await editTransaction(selectedId);
      
      // Focus on attachment field
      setTimeout(() => {
        formATTACHFILE.focus();
      }, 500);
    }
    
    // Save/Load app state
    function saveAppState() {
      const state = {
        currentPage: currentPage,
        dateFilter: dateFilter.value,
        typeFilter: typeFilter.value,
        bankFilter: bankFilter.value,
        categoryFilter: categoryFilter.value,
        tagsFilter: $(tagsFilter).val(),
        searchDesc: searchDesc.value,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        minAmount: minAmount.value,
        maxAmount: maxAmount.value,
        sortBy: sortBy.value,
        pageSize: pageSize.value,
        balanceVisible: balanceVisible,
        theme: currentTheme,
        filtersVisible: filtersContainer.style.display === 'block'
      };
      localStorage.setItem('budgetAppState', JSON.stringify(state));
    }
    
    function loadAppState() {
      const savedState = localStorage.getItem('budgetAppState');
      if (savedState) {
        const state = JSON.parse(savedState);
        
        currentPage = state.currentPage || 1;
        dateFilter.value = state.dateFilter || "all";
        typeFilter.value = state.typeFilter || "all";
        bankFilter.value = state.bankFilter || "all";
        categoryFilter.value = state.categoryFilter || "all";
        searchDesc.value = state.searchDesc || "";
        startDateInput.value = state.startDate || "";
        endDateInput.value = state.endDate || "";
        minAmount.value = state.minAmount || "";
        maxAmount.value = state.maxAmount || "";
        sortBy.value = state.sortBy || "date-desc";
        pageSize.value = state.pageSize || "10";
        
        if (state.tagsFilter) {
          $(tagsFilter).val(state.tagsFilter).trigger('change');
        }
        
        if (state.dateFilter === "custom") {
          customRangeControls.style.display = "flex";
        }
        
        if (state.filtersVisible) {
          filtersContainer.style.display = "block";
          filterToggleBtn.innerHTML = '<i class="fa fa-times me-1"></i> Hide Filters';
        }
        
        balanceVisible = state.balanceVisible || false;
        updateBalanceDisplay();
        
        if (state.theme && state.theme !== currentTheme) {
          currentTheme = state.theme;
          document.documentElement.setAttribute('data-theme', currentTheme);
          themeToggleSwitch.checked = currentTheme === 'dark';
        }
        
        hasLoadedSavedState = true;
      }
    }
    
    // Initialize theme preference
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme') || userSettings.theme;
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggleSwitch.checked = currentTheme === 'dark';
      }
    }
    
    // View attachment
    function viewAttachment(attachmentUrl) {
      if (!attachmentUrl) return;
      
      const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(attachmentUrl) || attachmentUrl.startsWith('data:image');
      const isPDF = /\.(pdf)$/i.test(attachmentUrl);
      
      let content = '';
      
      if (isImage) {
        content = `<img src="${attachmentUrl}" class="img-fluid" style="max-height: 70vh;" />`;
      } else if (isPDF) {
        content = `
          <iframe src="${attachmentUrl}" width="100%" height="500px" style="border: none;"></iframe>
          <div class="mt-3">
            <small class="text-muted">PDF preview may not work in all browsers. Use download button if needed.</small>
          </div>
        `;
      } else {
        content = `
          <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            This file type cannot be previewed. Please download to view.
          </div>
        `;
      }
      
      attachmentModalBody.innerHTML = content;
      document.getElementById("downloadAttachmentBtn").href = attachmentUrl;
      attachmentModal.show();
    }
    
    // Set up global functions for inline event handlers
    window.removeSplitExpense = removeSplitExpense;
    window.updateSplitSummary = updateSplitSummary;
    window.addSetupCategory = addSetupCategory;
    
    // Initialize confirm delete button
    confirmDeleteBtn.addEventListener("click", deleteTransaction);
    
    // Set today's date in date inputs
    const today = new Date().toISOString().split('T')[0];
    if (formDATE) formDATE.value = today;
    if (quickAddDate) quickAddDate.value = today;
    if (splitIncomeDate) splitIncomeDate.value = today;
    
    // Initialize balance visibility
    updateBalanceDisplay();
    
    // Export function for inline use
    window.formatCurrency = formatCurrency;
    
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>