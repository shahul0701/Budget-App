<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager Pro</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css">

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      transition: all 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-logo {
      font-weight: 700;
      font-size: 20px;
      color: var(--purple-1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      transition: all 0.2s;
      gap: 12px;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(111, 66, 193, 0.1);
      color: var(--purple-1);
      border-left: 3px solid var(--purple-1);
    }

    .sidebar-menu a i {
      width: 20px;
      text-align: center;
    }

    .sidebar-menu span {
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-menu span {
      opacity: 0;
      display: none;
    }

    .sidebar.collapsed .sidebar-logo span {
      display: none;
    }

    /* Main content with sidebar */
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: var(--sidebar-collapsed);
    }

    .page {
      max-width:1400px;
      margin:20px auto;
      padding:20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-trend { font-size:12px; display: flex; align-items: center; gap: 4px; margin-top: 5px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }
    .transactions-table tbody tr:hover td { background-color: rgba(111, 66, 193, 0.05); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.1); }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-recurring { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; right:30px; bottom:30px; width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(70,34,173,0.2); z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }

    /* responsive */
    @media (max-width: 1200px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .sidebar.show { transform: translateX(0); }
      .page { padding: 15px; }
    }
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: flex-end; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { width: 100%; min-width: unset; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      flex: 1;
      min-width: 200px;
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .quick-stat:hover {
      transform: translateY(-2px);
      background: var(--card-bg);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bg-primary);
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .split-summary {
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      font-weight: 600;
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }

    /* Tag system */
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .tag {
      background: var(--purple-1);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag-remove {
      background: none;
      border: none;
      color: white;
      padding: 0;
      cursor: pointer;
      font-size: 10px;
    }

    /* Search highlight */
    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
    }
    .nav-tabs .nav-link {
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
    }
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
    }

    /* Drag and drop */
    .drag-handle {
      cursor: move;
      color: var(--muted);
    }
    .dragging {
      opacity: 0.5;
      background: var(--bg-primary);
    }

    /* Recurring transactions */
    .recurring-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: black;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    /* AI Assistant */
    .ai-assistant {
      position: fixed;
      bottom: 100px;
      right: 30px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(70,34,173,0.3);
      z-index: 1100;
      transition: all 0.3s;
    }
    .ai-assistant:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(70,34,173,0.4);
    }
    .ai-panel {
      position: fixed;
      bottom: 170px;
      right: 30px;
      width: 350px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1099;
      display: none;
    }
    .ai-panel.show {
      display: block;
    }
    .ai-header {
      padding: 15px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-body {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .ai-message.user {
      background: rgba(111, 66, 193, 0.1);
      margin-left: 40px;
    }
    .ai-message.bot {
      background: var(--bg-primary);
      margin-right: 40px;
    }
    .ai-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid var(--border-color);
    }

    /* Mobile menu toggle */
    .mobile-menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 1200px) {
      .mobile-menu-toggle {
        display: flex;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Color picker */
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--purple-1);
    }

    /* Calendar Styles - ADDED */
    .calendar-wrapper {
      width: 100%;
    }
    .calendar-grid {
      display: flex;
      flex-direction: column;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }
    .calendar-cell {
      padding: 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-primary);
    }
    .calendar-body {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 100px;
      gap: 1px;
      background: var(--border-color);
    }
    .calendar-day {
      background: var(--card-bg);
      padding: 5px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .calendar-day:hover {
      background: var(--bg-primary);
    }
    .calendar-day.empty {
      background: var(--bg-primary);
      cursor: default;
    }
    .calendar-day.today {
      background: rgba(111, 66, 193, 0.1);
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
    }
    .calendar-day-today {
      background: var(--purple-1);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .calendar-day-transactions {
      font-size: 11px;
      max-height: 60px;
      overflow-y: auto;
    }
    .calendar-transaction-item {
      margin-bottom: 2px;
      padding: 2px 4px;
      border-radius: 3px;
      background: var(--bg-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .transaction-income {
      color: var(--success);
      border-left: 2px solid var(--success);
    }
    .transaction-expense {
      color: var(--danger);
      border-left: 2px solid var(--danger);
    }
    .transaction-transfer {
      color: var(--info);
      border-left: 2px solid var(--info);
    }
    .calendar-day-more {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      margin-top: 2px;
    }

    /* Grid View Styles - ADDED */
    .grid-view-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    .grid-card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .grid-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .grid-card-income {
      border-left: 4px solid var(--success);
    }
    .grid-card-expense {
      border-left: 4px solid var(--danger);
    }
    .grid-card-transfer {
      border-left: 4px solid var(--info);
    }
    .grid-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .grid-card-title {
      font-weight: 600;
      margin: 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .grid-card-amount {
      font-weight: 700;
      font-size: 16px;
    }
    .grid-card-body {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .grid-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .grid-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    .grid-tag {
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fa fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fa fa-chart-line"></i>
        <span>FinancePro</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fa fa-chevron-left"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active"><i class="fa fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fa fa-exchange-alt"></i> <span>Transactions</span></a></li>
      <li><a href="#"><i class="fa fa-chart-pie"></i> <span>Reports</span></a></li>
      <li><a href="#"><i class="fa fa-wallet"></i> <span>Accounts</span></a></li>
      <li><a href="#"><i class="fa fa-tags"></i> <span>Categories</span></a></li>
      <li><a href="#"><i class="fa fa-calendar-alt"></i> <span>Recurring</span></a></li>
      <li><a href="#"><i class="fa fa-bell"></i> <span>Reminders</span></a></li>
      <li><a href="#"><i class="fa fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="page">
      <!-- Loading Backdrop -->
      <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="backdropMessage">Loading...</p>
        </div>
      </div>
      
      <!-- Toast Container -->
      <div class="toast-container" id="toastContainer"></div>
      
      <!-- Navigation buttons -->
      <div class="nav-buttons">
        <button id="backBtn" class="btn btn-outline-primary">
          <i class="fa fa-arrow-left me-1"></i> Back
        </button>
        <button id="homeBtn" class="btn btn-outline-secondary">
          <i class="fa fa-home me-1"></i> Home
        </button>
        <button id="coaBtn" class="btn btn-outline-info">
          <i class="fa fa-chart-pie me-1"></i> Manage COA
        </button>
        <button id="recurringBtn" class="btn btn-outline-warning">
          <i class="fa fa-redo me-1"></i> Recurring
        </button>
        <button id="reportBtn" class="btn btn-outline-success">
          <i class="fa fa-chart-bar me-1"></i> Reports
        </button>
        <div class="export-buttons">
          <button id="exportCSV" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-csv me-1"></i> CSV
          </button>
          <button id="exportPDF" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-file-pdf me-1"></i> PDF
          </button>
          <button id="exportExcel" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-excel me-1"></i> Excel
          </button>
        </div>
      </div>
      
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager Pro</h2>
          <div class="header-actions">
            <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
            <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
            <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
            <button id="importBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-upload me-1"></i> Import</button>
            <button id="tagManagerBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-tags me-1"></i> Tags</button>
            <button id="themeToggle" class="theme-toggle">
              <i class="fa fa-moon"></i>
            </button>
            <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
            <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
              <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
              <div style="color:white; font-weight:600;" id="username">User</div>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="bulkCategoryBtn" class="btn btn-outline-success btn-sm">
            <i class="fa fa-folder me-1"></i> Change Category
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>

        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card" onclick="showIncomeDetails()">
            <div class="stat-label">Total Income</div>
            <div id="statIncome" class="stat-value income-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-up text-success"></i> <span id="incomeTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="showExpenseDetails()">
            <div class="stat-label">Total Expenses</div>
            <div id="statExpense" class="stat-value expense-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-down text-danger"></i> <span id="expenseTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="toggleBalanceVisibility()">
            <div class="stat-label">Current Balance</div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">
              <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          <div class="stat-card" onclick="showTransactionStats()">
            <div class="stat-label">Transactions</div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card" onclick="showCashflowChart()">
            <div class="stat-label">Cash Flow</div>
            <div id="statCashflow" class="stat-value">$0.00</div>
            <div class="small-muted">Monthly average</div>
          </div>
        </div>
        
        <!-- Quick stats -->
        <div class="quick-stats" id="quickStats">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart">
          <!-- Chart will be rendered here -->
        </div>
        
        <!-- Bank balances section -->
        <div class="info-banner">
          <i class="fa fa-info-circle me-2"></i> 
          <span id="dynamicTip">Manage your transactions, view attachments, and track your finances in one place.</span>
          <button class="btn btn-sm btn-outline-primary ms-3" onclick="showNextTip()">Next Tip</button>
          <span class="float-end" id="lastSync"></span>
        </div>
        
        <div class="content-body">
          <!-- Tabs for different views -->
          <ul class="nav nav-tabs mb-3" id="viewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#listView">List View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#gridView">Grid View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#calendarView">Calendar View</a>
            </li>
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content">
            <!-- List View -->
            <div class="tab-pane fade show active" id="listView">
              <!-- Bank balances -->
              <div id="bankBalances" class="bank-balances">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- filters -->
              <div class="filters mb-2">
                <select id="dateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="quarter">This Quarter</option>
                </select>

                <div id="customRangeControls" style="display:none; display:flex; gap:8px;">
                  <input id="startDate" type="date" class="form-control form-control-sm" />
                  <input id="endDate" type="date" class="form-control form-control-sm" />
                </div>

                <select id="typeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                  <option value="recurring">Recurring</option>
                </select>

                <!-- Bank Filter -->
                <select id="bankFilter" class="form-select form-select-sm">
                  <option value="all">All Banks</option>
                  <!-- Will be populated dynamically -->
                </select>

                <!-- Category Filter -->
                <select id="categoryFilter" class="form-select form-select-sm">
                  <option value="all">All Categories</option>
                  <!-- Will be populated dynamically -->
                </select>

                <select id="statusFilter" class="form-select form-select-sm">
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>

                <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes, tags..." />

                <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
                <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                <button id="advancedFiltersBtn" class="btn btn-sm btn-outline-info">Advanced</button>
                <button id="saveFilterBtn" class="btn btn-sm btn-outline-success" title="Save current filter as preset">
                  <i class="fa fa-save"></i>
                </button>
                <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
              </div>
              
              <!-- Advanced filters (initially hidden) -->
              <div id="advancedFilters" style="display: none;" class="filters mb-2">
                <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="Min Amount" step="0.01" />
                <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="Max Amount" step="0.01" />
                <input id="tagFilter" type="text" class="form-control form-control-sm" placeholder="Filter by tags (comma separated)" />
                <select id="sortBy" class="form-select form-select-sm">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="category">Category</option>
                  <option value="bank">Bank</option>
                </select>
                <select id="groupBy" class="form-select form-select-sm">
                  <option value="none">No Grouping</option>
                  <option value="date">Group by Date</option>
                  <option value="category">Group by Category</option>
                  <option value="bank">Group by Bank</option>
                  <option value="type">Group by Type</option>
                </select>
              </div>

              <!-- Filter presets -->
              <div id="filterPresets" class="filters mb-2" style="display: none;">
                <small class="text-muted me-2">Presets:</small>
                <!-- Will be populated dynamically -->
              </div>

              <!-- transactions table -->
              <div class="transactions-table">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th style="width:40px;">
                        <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                        <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
                      </th>
                      <th style="width:110px;">Date</th>
                      <th style="width:120px; text-align:right;">Account Header</th>
                      <th>Description</th>
                      <th style="width:120px;">Type</th>
                      <th style="width:110px;">Voucher #</th>
                      <th style="width:120px;">Bank Name</th>
                      <th style="width:120px; text-align:right;">Income</th>
                      <th style="width:120px; text-align:right;">Expense</th>
                      <th style="width:120px;">Balance</th>
                      <th style="width:120px;">Tags</th>
                      <th style="width:120px;">Attachment</th>
                      <th style="width:130px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr><td colspan="13" class="text-center text-muted py-4">No transactions loaded.</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- pagination for list view -->
              <div class="pagination-wrap mt-3" id="listPaginationControls"></div>
            </div>

            <!-- Grid View -->
            <div class="tab-pane fade" id="gridView">
              <div class="filters mb-2">
                <select id="gridDateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                </select>
                <select id="gridTypeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                </select>
                <input id="gridSearch" class="form-control form-control-sm" placeholder="Search..." />
                <button id="gridApplyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
              </div>
              
              <div class="grid-view-container" id="gridViewContainer">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- pagination for grid view -->
              <div class="pagination-wrap mt-3" id="gridPaginationControls"></div>
            </div>

            <!-- Calendar View -->
            <div class="tab-pane fade" id="calendarView">
              <div class="filters mb-2">
                <button class="btn btn-sm btn-outline-primary" onclick="prevMonth()">
                  <i class="fa fa-chevron-left me-1"></i> Previous
                </button>
                <button class="btn btn-sm btn-outline-primary mx-1" onclick="goToToday()">
                  Today
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                  Next <i class="fa fa-chevron-right ms-1"></i>
                </button>
                <select id="calendarTypeFilter" class="form-select form-select-sm ms-2" style="width: auto;" onchange="renderCalendarView()">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                </select>
              </div>
              
              <div id="calendarContainer">
                <!-- Calendar will be rendered here -->
              </div>
            </div>
          </div>

          <!-- Summary footer -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Selected Summary</h6>
                  <div id="selectedSummary">No transactions selected</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Filter Summary</h6>
                  <div id="filterSummary">Showing all transactions</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="ai-assistant" id="aiAssistant">
    <i class="fa fa-robot"></i>
  </div>
  <div class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <span>Finance Assistant</span>
      <button class="btn btn-sm btn-light" onclick="toggleAIPanel()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="ai-body" id="aiChat">
      <div class="ai-message bot">
        Hi! I'm your finance assistant. How can I help you today?
      </div>
    </div>
    <div class="ai-input">
      <input type="text" class="form-control" id="aiInput" placeholder="Ask me anything..." />
      <button class="btn btn-primary" onclick="sendAIMessage()">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- floating add button -->
  <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>

  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date *</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # (SINO) *</label>
                <input id="formSINO" type="text" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header *</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Account Header</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type *</label>
                <select id="formVOUCHERTYPE" class="form-select" required>
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Contra">Contra</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type *</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Adjustment">Adjustment</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name *</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency *</label>
                <select id="formCURRENCY" class="form-select" required>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="GBP">GBP (£)</option>
                  <option value="INR">INR (₹)</option>
                  <option value="JPY">JPY (¥)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Balance (manual)</label>
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description *</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description" required></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes"></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input id="formTAGS" type="text" class="form-control" placeholder="Enter tags (comma separated)" />
                <div class="tag-container mt-2" id="tagsPreview"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.csv" />
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>

            <!-- Recurring transaction options -->
            <div class="row g-2 mt-2" id="recurringOptions" style="display: none;">
              <div class="col-md-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Recurring Transaction</h6>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">Frequency</label>
                        <select id="formRECURRING_FREQ" class="form-select">
                          <option value="daily">Daily</option>
                          <option value="weekly">Weekly</option>
                          <option value="monthly">Monthly</option>
                          <option value="quarterly">Quarterly</option>
                          <option value="yearly">Yearly</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Interval</label>
                        <input id="formRECURRING_INTERVAL" type="number" class="form-control" value="1" min="1" />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input id="formRECURRING_ENDDATE" type="date" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="duplicateTransactionBtn">
            <i class="fa fa-copy me-1"></i> Duplicate
          </button>
          <button type="button" class="btn btn-info" id="makeRecurringBtn">
            <i class="fa fa-redo me-1"></i> Make Recurring
          </button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction details (e.g., "Lunch $20 Expense Food")</label>
            <input type="text" class="form-control" id="quickAddInput" placeholder="Description $amount Type [Category] [Tags]" />
            <div class="form-text">Format: Description $amount Type (optional: Category, Tags)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="processQuickAddBtn">Add Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Total Income Amount</label>
              <input type="number" step="0.01" class="form-control" id="splitIncomeAmount" placeholder="Enter total amount" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Description</label>
              <input type="text" class="form-control" id="splitIncomeDescription" placeholder="Income description" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Bank Account</label>
              <select class="form-select" id="splitIncomeBank">
                <option value="">Select Bank</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Date</label>
              <input type="date" class="form-control" id="splitIncomeDate" value="" />
            </div>
          </div>
          
          <div class="mt-4">
            <h6>Split Expenses</h6>
            <div id="splitExpensesContainer">
              <!-- Split items will be added here -->
            </div>
            <button type="button" class="btn btn-outline-primary mt-2" id="addSplitExpenseBtn">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div class="mt-4">
            <div class="split-summary" id="splitSummary">
              Total allocated: $0.00 | Remaining: $0.00
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveSplitTransactionsBtn">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <p>Editing <span id="bulkEditCount" class="badge bg-primary">0</span> transactions</p>
            <label class="form-label">Field to Update</label>
            <select class="form-select" id="bulkEditField">
              <option value="ACCOUNT_HEADER">Account Header</option>
              <option value="BANK_NAME">Bank Name</option>
              <option value="STATUS">Status</option>
              <option value="TYPE">Type</option>
              <option value="VOUCHER_TYPE">Voucher Type</option>
              <option value="CURRENCY">Currency</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Value</label>
            <input type="text" class="form-control" id="bulkEditValue" placeholder="Enter new value" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmBulkEditBtn">Update Selected</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal fade" id="bulkTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Tags to Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <p>Adding tags to <span id="bulkTagCount" class="badge bg-primary">0</span> transactions</p>
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" id="bulkTagsInput" placeholder="Enter tags (e.g., urgent, tax-deductible, personal)" />
            <div class="form-text">These tags will be added to all selected transactions</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmBulkTagBtn">Add Tags</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirmation Modal -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Confirm Bulk Delete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> You are about to delete <span id="bulkDeleteCount" class="badge bg-danger">0</span> transactions.
            This action cannot be undone!
          </div>
          <p>Are you sure you want to delete these transactions?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete Selected</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Select File</label>
            <input type="file" class="form-control" id="importFile" accept=".csv,.xlsx,.xls,.json" />
            <div class="form-text">Supported formats: CSV, Excel, JSON</div>
          </div>
          <div class="mb-3">
            <label class="form-label">File Format</label>
            <select class="form-select" id="importFormat">
              <option value="auto">Auto-detect</option>
              <option value="csv">CSV</option>
              <option value="excel">Excel</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="importOverwrite" />
              <label class="form-check-label" for="importOverwrite">
                Overwrite existing transactions with same voucher number
              </label>
            </div>
          </div>
          <div id="importPreview" style="display: none;">
            <h6>Preview</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="importPreviewTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="processImportBtn">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Generate Report</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Report Type</label>
              <select class="form-select" id="reportType">
                <option value="summary">Summary Report</option>
                <option value="detailed">Detailed Transaction Report</option>
                <option value="category">Category-wise Report</option>
                <option value="bank">Bank-wise Report</option>
                <option value="monthly">Monthly Report</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date Range</label>
              <select class="form-select" id="reportDateRange">
                <option value="all">All Time</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Format</label>
              <select class="form-select" id="reportFormat">
                <option value="html">HTML</option>
                <option value="pdf">PDF</option>
                <option value="csv">CSV</option>
                <option value="excel">Excel</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Include Charts</label>
              <select class="form-select" id="reportCharts">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div class="mt-4" id="customReportRange" style="display: none;">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="reportStartDate" />
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="reportEndDate" />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="generateReportBtn">Generate Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Manager Modal -->
  <div class="modal fade" id="tagManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tag Manager</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">All Tags</label>
                <div id="allTagsContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                  <!-- Tags will be populated here -->
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Add New Tag</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="newTagName" placeholder="Tag name" />
                  <button class="btn btn-primary" type="button" onclick="addNewTag()">Add</button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Tag Color</label>
                <input type="color" class="form-control form-control-color" id="newTagColor" value="#6f42c1" title="Choose tag color" />
              </div>
              <div class="alert alert-info">
                <small><i class="fa fa-info-circle me-1"></i> Click on a tag to see transactions with that tag.</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment Modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="attachmentModalBody">
          <!-- Attachment content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" class="btn btn-primary" id="downloadAttachmentBtn" download>Download</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Confirm Delete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-triangle me-2"></i>
            Are you sure you want to delete this transaction? This action cannot be undone!
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Flatpickr for date range selection -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Pickr for color picker -->
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for HTML to PDF conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========== GLOBAL VARIABLES AND STATE ==========
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let txToDelete = null;
    let balanceVisible = false;
    let isSubmitting = false;
    let lastVoucherNumber = 0;
    let currentTheme = 'light';
    let transactionsChartInstance = null;
    let selectedTransactions = new Set();
    let hasLoadedSavedState = false;
    let allTags = new Set();
    let recurringTransactions = [];
    let filterPresets = [];
    
    // COA data
    let coaAccounts = [];
    let coaBanks = [];
    
    // Chart instances
    let mainChart = null;
    let cashflowChart = null;
    let categoryChart = null;
    
    // Calendar state
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    let calendarTypeFilter = 'all';

    // Tips for dynamic tip banner
    const tips = [
      "Track your daily expenses to better understand your spending habits.",
      "Use tags to categorize transactions for better reporting.",
      "Set up recurring transactions for regular bills and income.",
      "Review your bank balances regularly to avoid overdraft fees.",
      "Export your transactions periodically for backup and tax purposes.",
      "Use the split income feature to allocate funds to different expenses.",
      "Try the calendar view to see your transactions by day.",
      "Use the AI assistant for financial insights and suggestions.",
      "Set up filter presets for frequently used views.",
      "Regularly reconcile your transactions with bank statements."
    ];

    // DOM Elements
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const newTxBtn = document.getElementById("newTxBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const splitIncomeBtn = document.getElementById("splitIncomeBtn");
    const floatingAdd = document.getElementById("floatingAdd");
    const balanceToggle = document.getElementById("balanceToggle");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const coaBtn = document.getElementById("coaBtn");
    const reportBtn = document.getElementById("reportBtn");
    const recurringBtn = document.getElementById("recurringBtn");
    const importBtn = document.getElementById("importBtn");
    const tagManagerBtn = document.getElementById("tagManagerBtn");
    const themeToggle = document.getElementById("themeToggle");
    const exportCSV = document.getElementById("exportCSV");
    const exportPDF = document.getElementById("exportPDF");
    const exportExcel = document.getElementById("exportExcel");
    const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
    const advancedFilters = document.getElementById("advancedFilters");
    const includeTimeCheckbox = document.getElementById("includeTime");
    const formTIME = document.getElementById("formTIME");
    const formCURRENCY = document.getElementById("formCURRENCY");
    const minAmount = document.getElementById("minAmount");
    const maxAmount = document.getElementById("maxAmount");
    const sortBy = document.getElementById("sortBy");
    const groupBy = document.getElementById("groupBy");
    const tagFilter = document.getElementById("tagFilter");
    const formDESCRIPTION = document.getElementById("formDESCRIPTION");
    const quickAddInput = document.getElementById("quickAddInput");
    const processQuickAddBtn = document.getElementById("processQuickAddBtn");
    const loadingModalEl = document.getElementById("loadingModal");
    const loadingModal = new bootstrap.Modal(loadingModalEl);
    const loadingMessage = document.getElementById("loadingMessage");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const bulkActions = document.getElementById("bulkActions");
    const selectedCount = document.getElementById("selectedCount");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkEditBtn = document.getElementById("bulkEditBtn");
    const bulkTagBtn = document.getElementById("bulkTagBtn");
    const bulkCategoryBtn = document.getElementById("bulkCategoryBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const splitIncomeModalEl = document.getElementById("splitIncomeModal");
    const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
    const splitIncomeAmount = document.getElementById("splitIncomeAmount");
    const splitIncomeDescription = document.getElementById("splitIncomeDescription");
    const splitIncomeBank = document.getElementById("splitIncomeBank");
    const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
    const splitExpensesContainer = document.getElementById("splitExpensesContainer");
    const splitSummary = document.getElementById("splitSummary");
    const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
    const bulkEditModalEl = document.getElementById("bulkEditModal");
    const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
    const bulkEditField = document.getElementById("bulkEditField");
    const bulkEditValue = document.getElementById("bulkEditValue");
    const bulkEditCount = document.getElementById("bulkEditCount");
    const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
    const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
    const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
    const bulkDeleteCount = document.getElementById("bulkDeleteCount");
    const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
    const duplicateTransactionBtn = document.getElementById("duplicateTransactionBtn");
    const makeRecurringBtn = document.getElementById("makeRecurringBtn");
    const sidebar = document.getElementById("sidebar");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const mobileMenuToggle = document.getElementById("mobileMenuToggle");
    const mainContent = document.getElementById("mainContent");
    const aiAssistant = document.getElementById("aiAssistant");
    const aiPanel = document.getElementById("aiPanel");
    const aiChat = document.getElementById("aiChat");
    const aiInput = document.getElementById("aiInput");
    const viewTabs = document.getElementById("viewTabs");
    const gridViewContainer = document.getElementById("gridViewContainer");
    const calendarContainer = document.getElementById("calendarContainer");
    const selectedSummary = document.getElementById("selectedSummary");
    const filterSummary = document.getElementById("filterSummary");
    const dynamicTip = document.getElementById("dynamicTip");
    const lastSync = document.getElementById("lastSync");
    const saveFilterBtn = document.getElementById("saveFilterBtn");
    const filterPresetsDiv = document.getElementById("filterPresets");
    const statusFilter = document.getElementById("statusFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const importModalEl = document.getElementById("importModal");
    const importModal = new bootstrap.Modal(importModalEl);
    const reportModalEl = document.getElementById("reportModal");
    const reportModal = new bootstrap.Modal(reportModalEl);
    const tagManagerModalEl = document.getElementById("tagManagerModal");
    const tagManagerModal = new bootstrap.Modal(tagManagerModalEl);
    const bulkTagModalEl = document.getElementById("bulkTagModal");
    const bulkTagModal = new bootstrap.Modal(bulkTagModalEl);
    const bulkTagsInput = document.getElementById("bulkTagsInput");
    const bulkTagCount = document.getElementById("bulkTagCount");
    const confirmBulkTagBtn = document.getElementById("confirmBulkTagBtn");

    // New DOM refs for grid and calendar
    const listPaginationControls = document.getElementById("listPaginationControls");
    const gridPaginationControls = document.getElementById("gridPaginationControls");
    const gridDateFilter = document.getElementById("gridDateFilter");
    const gridTypeFilter = document.getElementById("gridTypeFilter");
    const gridSearch = document.getElementById("gridSearch");
    const gridApplyFiltersBtn = document.getElementById("gridApplyFiltersBtn");
    const calendarTypeFilterElement = document.getElementById("calendarTypeFilter");

    // Other DOM refs
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const searchDesc = document.getElementById("searchDesc");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const transactionsTableBody = document.getElementById("transactionsTableBody");
    const bankBalancesContainer = document.getElementById("bankBalances");
    const quickStatsContainer = document.getElementById("quickStats");
    const transactionsChartElement = document.getElementById("transactionsChart");

    // Modal refs
    const transactionModalEl = document.getElementById("transactionModal");
    const transactionModal = new bootstrap.Modal(transactionModalEl);
    const quickAddModalEl = document.getElementById("quickAddModal");
    const quickAddModal = new bootstrap.Modal(quickAddModalEl);
    const form = document.getElementById("transactionForm");
    const txIdInput = document.getElementById("txId");
    const formDATE = document.getElementById("formDATE");
    const formSINO = document.getElementById("formSINO");
    const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
    const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
    const formTYPE = document.getElementById("formTYPE");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formBALANCE = document.getElementById("formBALANCE");
    const formNOTES = document.getElementById("formNOTES");
    const formTAGS = document.getElementById("formTAGS");
    const formSTATUS = document.getElementById("formSTATUS");
    const tagsPreview = document.getElementById("tagsPreview");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentInfo = document.getElementById("attachmentInfo");
    const saveTransactionBtn = document.getElementById("saveTransactionBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadProgressBar = document.getElementById("uploadProgressBar");
    const recurringOptions = document.getElementById("recurringOptions");

    const attachmentModalBody = document.getElementById("attachmentModalBody");

    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    // stats
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");
    const statCashflow = document.getElementById("statCashflow");
    const incomeTrend = document.getElementById("incomeTrend");
    const expenseTrend = document.getElementById("expenseTrend");

    // ========== HELPER FUNCTIONS ==========
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} 
            text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      const container = document.getElementById("toastContainer");
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    function formatDateToYyyyMmmDd(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.toLocaleString('default', { month: 'short' });
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function resetSaveButton() {
      isSubmitting = false;
      saveTransactionBtn.disabled = false;
      saveTransactionBtn.innerHTML = 'Save Transaction';
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupEventListeners();
      loadInitialData();
    });

    function initializeApp() {
      // Set current date in forms
      const today = new Date().toISOString().split('T')[0];
      formDATE.value = today;
      document.getElementById('splitIncomeDate').value = today;
      
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      // Set initial theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      setTheme(savedTheme);
    }

    function setupEventListeners() {
      // Navigation
      logoutBtn.addEventListener("click", handleLogout);
      newTxBtn.addEventListener("click", openAddModal);
      floatingAdd.addEventListener("click", openAddModal);
      balanceToggle.addEventListener("click", toggleBalanceVisibility);
      
      // Filters
      dateFilter.addEventListener("change", handleDateFilterChange);
      applyFiltersBtn.addEventListener("click", applyFilters);
      resetFiltersBtn.addEventListener("click", resetFilters);
      advancedFiltersBtn.addEventListener("click", toggleAdvancedFilters);
      
      // Modal buttons
      saveTransactionBtn.addEventListener("click", saveTransaction);
      confirmDeleteBtn.addEventListener("click", confirmDeleteTransaction);
      duplicateTransactionBtn.addEventListener("click", duplicateTransaction);
      makeRecurringBtn.addEventListener("click", toggleRecurringOptions);
      
      // Quick add
      quickAddBtn.addEventListener("click", () => quickAddModal.show());
      processQuickAddBtn.addEventListener("click", processQuickAdd);
      
      // Split income
      splitIncomeBtn.addEventListener("click", openSplitIncomeModal);
      addSplitExpenseBtn.addEventListener("click", addSplitExpense);
      saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);
      
      // Bulk actions
      selectAllBtn.addEventListener("click", selectAllTransactions);
      deselectAllBtn.addEventListener("click", deselectAllTransactions);
      selectAllCheckbox.addEventListener("change", toggleSelectAll);
      bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
      bulkEditBtn.addEventListener("click", openBulkEditModal);
      bulkTagBtn.addEventListener("click", openBulkTagModal);
      clearSelectionBtn.addEventListener("click", clearSelection);
      confirmBulkEditBtn.addEventListener("click", processBulkEdit);
      confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
      confirmBulkTagBtn.addEventListener("click", processBulkTags);
      
      // Sidebar
      sidebarToggle.addEventListener("click", toggleSidebar);
      mobileMenuToggle.addEventListener("click", toggleMobileMenu);
      
      // Theme
      themeToggle.addEventListener("click", toggleTheme);
      
      // Export
      exportCSV.addEventListener("click", exportToCSV);
      exportPDF.addEventListener("click", exportToPDF);
      exportExcel.addEventListener("click", exportToExcel);
      
      // AI Assistant
      aiAssistant.addEventListener("click", toggleAIPanel);
      aiInput.addEventListener("keypress", (e) => {
        if (e.key === 'Enter') sendAIMessage();
      });
      
      // Form inputs
      formTAGS.addEventListener("input", updateTagsPreview);
      formTYPE.addEventListener("change", updateFormFields);
      includeTimeCheckbox.addEventListener("change", () => {
        formTIME.disabled = !includeTimeCheckbox.checked;
        if (!includeTimeCheckbox.checked) formTIME.value = "";
      });
      
      // Tab switching
      viewTabs.addEventListener("shown.bs.tab", handleTabSwitch);
      
      // Grid filters
      gridApplyFiltersBtn.addEventListener("click", () => {
        applyFilters();
        if (document.querySelector('#gridView').classList.contains('active')) {
          renderGridView();
        }
      });
      
      // Calendar filter
      calendarTypeFilterElement.addEventListener("change", () => {
        calendarTypeFilter = calendarTypeFilterElement.value;
        renderCalendarView();
      });
    }

    function loadInitialData() {
      // Simulate loading data
      showLoading("Loading your financial data...");
      
      // Load sample data for demonstration
      setTimeout(() => {
        loadSampleData();
        updateStats();
        updateBankBalances();
        updateQuickStats();
        renderMainChart();
        updateSelectedSummary();
        updateFilterSummary();
        updateLastSync();
        hideLoading();
        showToast("Welcome to Transaction Manager Pro!", "success");
      }, 1500);
    }

    function loadSampleData() {
      // Sample account headers and banks
      coaAccounts = ["Salary", "Rent", "Groceries", "Utilities", "Entertainment", "Transportation", "Healthcare", "Savings", "Investments"];
      coaBanks = ["Chase Bank", "Bank of America", "Wells Fargo", "Citibank", "Capital One", "Cash"];
      
      // Populate dropdowns
      populateCOADropdowns();
      
      // Sample transactions
      allTransactions = [
        {
          id: "1",
          DATE: new Date().toISOString().split('T')[0],
          SINO: "RP-001",
          ACCOUNT_HEADER: "Salary",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: 5000.00,
          EXPENSE: 0.00,
          BALANCE: 5000.00,
          DESCRIPTION: "Monthly salary",
          NOTES: "Regular monthly income",
          TAGS: ["salary", "income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "2",
          DATE: new Date().toISOString().split('T')[0],
          SINO: "1",
          ACCOUNT_HEADER: "Rent",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Payment",
          TYPE: "Expense",
          INCOME: 0.00,
          EXPENSE: 1500.00,
          BALANCE: 3500.00,
          DESCRIPTION: "Monthly rent payment",
          NOTES: "Apartment rent",
          TAGS: ["housing", "bill"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "3",
          DATE: new Date(Date.now() - 86400000).toISOString().split('T')[0],
          SINO: "2",
          ACCOUNT_HEADER: "Groceries",
          BANK_NAME: "Bank of America",
          VOUCHERTYPE: "Payment",
          TYPE: "Expense",
          INCOME: 0.00,
          EXPENSE: 250.75,
          BALANCE: 3249.25,
          DESCRIPTION: "Weekly groceries",
          NOTES: "Supermarket shopping",
          TAGS: ["food", "shopping"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "4",
          DATE: new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0],
          SINO: "TR-001",
          ACCOUNT_HEADER: "Savings",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Transfer",
          TYPE: "Transfer",
          INCOME: 0.00,
          EXPENSE: 1000.00,
          BALANCE: 2249.25,
          DESCRIPTION: "Transfer to savings account",
          NOTES: "Monthly savings",
          TAGS: ["savings", "investment"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "5",
          DATE: new Date(Date.now() - 3 * 86400000).toISOString().split('T')[0],
          SINO: "RP-002",
          ACCOUNT_HEADER: "Freelance",
          BANK_NAME: "Cash",
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: 750.50,
          EXPENSE: 0.00,
          BALANCE: 2999.75,
          DESCRIPTION: "Freelance project payment",
          NOTES: "Web development project",
          TAGS: ["freelance", "income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];
      
      filteredTransactions = [...allTransactions];
      buildTable();
    }

    function populateCOADropdowns() {
      // Clear existing options
      formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
      formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
      categoryFilter.innerHTML = '<option value="all">All Categories</option>';
      
      // Add account headers
      coaAccounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account;
        option.textContent = account;
        formACCOUNTHEADER.appendChild(option);
        
        // Add to category filter
        const categoryOption = document.createElement('option');
        categoryOption.value = account;
        categoryOption.textContent = account;
        categoryFilter.appendChild(categoryOption);
      });
      
      // Add bank names
      coaBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        formBANKNAME.appendChild(option);
        splitIncomeBank.appendChild(option.cloneNode(true));
        
        // Also add to bank filter
        const filterOption = document.createElement('option');
        filterOption.value = bank;
        filterOption.textContent = bank;
        bankFilter.appendChild(filterOption);
      });
    }

    // ========== CORE FUNCTIONS ==========
    
    function openAddModal() {
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Add Transaction';
      txIdInput.value = '';
      
      // Set default voucher number
      getNextVoucherNumber('Payment').then(voucherNumber => {
        formSINO.value = voucherNumber;
      });
      
      transactionModal.show();
    }

    function resetTransactionForm() {
      form.reset();
      const today = new Date().toISOString().split('T')[0];
      formDATE.value = today;
      formSTATUS.value = 'completed';
      formCURRENCY.value = 'USD';
      formTYPE.value = 'Expense';
      tagsPreview.innerHTML = '';
      attachmentPreview.style.display = 'none';
      attachmentInfo.textContent = '';
      recurringOptions.style.display = 'none';
      includeTimeCheckbox.checked = false;
      formTIME.disabled = true;
    }

    function saveTransaction() {
      if (isSubmitting) return;
      isSubmitting = true;
      
      saveTransactionBtn.disabled = true;
      saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      
      // Basic validation
      if (!formDATE.value || !formSINO.value || !formDESCRIPTION.value) {
        showToast("Please fill in all required fields", "error");
        resetSaveButton();
        return;
      }
      
      const transactionData = {
        DATE: formDATE.value,
        SINO: formSINO.value,
        ACCOUNT_HEADER: formACCOUNTHEADER.value,
        BANK_NAME: formBANKNAME.value,
        VOUCHER_TYPE: formVOUCHERTYPE.value,
        TYPE: formTYPE.value,
        INCOME: parseFloat(formINCOME.value) || 0,
        EXPENSE: parseFloat(formEXPENSE.value) || 0,
        BALANCE: parseFloat(formBALANCE.value) || 0,
        DESCRIPTION: formDESCRIPTION.value,
        NOTES: formNOTES.value,
        TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        STATUS: formSTATUS.value,
        ATTACHMENT: formATTACH.value,
        CURRENCY: formCURRENCY.value,
        updatedAt: new Date()
      };
      
      if (includeTimeCheckbox.checked && formTIME.value) {
        transactionData.TIME = formTIME.value;
      }
      
      // Check if recurring
      if (recurringOptions.style.display === "block") {
        transactionData.RECURRING = {
          frequency: document.getElementById("formRECURRING_FREQ").value,
          interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1,
          endDate: document.getElementById("formRECURRING_ENDDATE").value,
          nextDate: calculateNextRecurringDate(transactionData.DATE, transactionData.RECURRING)
        };
      }
      
      // Simulate saving
      loadingMessage.textContent = "Saving transaction...";
      loadingModal.show();
      
      setTimeout(() => {
        if (txIdInput.value) {
          // Update existing
          const index = allTransactions.findIndex(t => t.id === txIdInput.value);
          if (index !== -1) {
            allTransactions[index] = { ...allTransactions[index], ...transactionData };
          }
          showToast("Transaction updated successfully", "success");
        } else {
          // Add new
          const newId = 'tx_' + Date.now();
          transactionData.id = newId;
          transactionData.createdAt = new Date();
          allTransactions.unshift(transactionData);
          showToast("Transaction added successfully", "success");
        }
        
        loadingModal.hide();
        transactionModal.hide();
        filteredTransactions = [...allTransactions];
        applyFilters();
        resetSaveButton();
      }, 1000);
    }

    function editTransaction(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Edit Transaction';
      txIdInput.value = transaction.id;
      
      // Populate form fields
      formDATE.value = transaction.DATE || '';
      formSINO.value = transaction.SINO || '';
      formACCOUNTHEADER.value = transaction.ACCOUNT_HEADER || '';
      formBANKNAME.value = transaction.BANK_NAME || '';
      formVOUCHERTYPE.value = transaction.VOUCHER_TYPE || 'Payment';
      formTYPE.value = transaction.TYPE || 'Expense';
      formINCOME.value = transaction.INCOME || '';
      formEXPENSE.value = transaction.EXPENSE || '';
      formBALANCE.value = transaction.BALANCE || '';
      formDESCRIPTION.value = transaction.DESCRIPTION || '';
      formNOTES.value = transaction.NOTES || '';
      formTAGS.value = transaction.TAGS ? transaction.TAGS.join(', ') : '';
      formSTATUS.value = transaction.STATUS || 'completed';
      formCURRENCY.value = transaction.CURRENCY || 'USD';
      formATTACH.value = transaction.ATTACHMENT || '';
      
      if (transaction.TIME) {
        includeTimeCheckbox.checked = true;
        formTIME.disabled = false;
        formTIME.value = transaction.TIME;
      }
      
      if (transaction.RECURRING) {
        recurringOptions.style.display = 'block';
        document.getElementById("formRECURRING_FREQ").value = transaction.RECURRING.frequency;
        document.getElementById("formRECURRING_INTERVAL").value = transaction.RECURRING.interval;
        document.getElementById("formRECURRING_ENDDATE").value = transaction.RECURRING.endDate;
      }
      
      updateTagsPreview();
      transactionModal.show();
    }

    function viewTransaction(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      const modalContent = `
        <div class="transaction-details">
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Date:</strong> ${formatDateToYyyyMmmDd(transaction.DATE)}
            </div>
            <div class="col-md-6">
              <strong>Voucher #:</strong> ${transaction.SINO}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Account Header:</strong> ${transaction.ACCOUNT_HEADER}
            </div>
            <div class="col-md-6">
              <strong>Bank:</strong> ${transaction.BANK_NAME}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Type:</strong> <span class="badge ${transaction.TYPE === 'Income' ? 'badge-income' : transaction.TYPE === 'Expense' ? 'badge-expense' : 'badge-transfer'}">${transaction.TYPE}</span>
            </div>
            <div class="col-md-6">
              <strong>Status:</strong> ${transaction.STATUS}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Income:</strong> <span class="income-color">${formatCurrency(transaction.INCOME || 0)}</span>
            </div>
            <div class="col-md-6">
              <strong>Expense:</strong> <span class="expense-color">${formatCurrency(transaction.EXPENSE || 0)}</span>
            </div>
          </div>
          <div class="mb-3">
            <strong>Description:</strong>
            <p>${transaction.DESCRIPTION || 'N/A'}</p>
          </div>
          ${transaction.NOTES ? `
            <div class="mb-3">
              <strong>Notes:</strong>
              <p>${transaction.NOTES}</p>
            </div>
          ` : ''}
          ${transaction.TAGS && transaction.TAGS.length > 0 ? `
            <div class="mb-3">
              <strong>Tags:</strong>
              <div class="tag-container">
                ${transaction.TAGS.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            </div>
          ` : ''}
          ${transaction.ATTACHMENT ? `
            <div class="mb-3">
              <strong>Attachment:</strong>
              <div>
                <a href="#" onclick="viewAttachment('${transaction.ATTACHMENT}')" class="btn btn-sm btn-outline-primary">
                  <i class="fa fa-paperclip"></i> View Attachment
                </a>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      Swal.fire({
        title: 'Transaction Details',
        html: modalContent,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function confirmDelete(id) {
      txToDelete = id;
      confirmDeleteModal.show();
    }

    function confirmDeleteTransaction() {
      if (!txToDelete) return;
      
      loadingMessage.textContent = "Deleting transaction...";
      loadingModal.show();
      
      setTimeout(() => {
        const index = allTransactions.findIndex(t => t.id === txToDelete);
        if (index !== -1) {
          allTransactions.splice(index, 1);
          showToast("Transaction deleted successfully", "success");
        }
        
        filteredTransactions = [...allTransactions];
        applyFilters();
        confirmDeleteModal.hide();
        loadingModal.hide();
        txToDelete = null;
      }, 1000);
    }

    function duplicateTransactionById(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Duplicate Transaction';
      txIdInput.value = '';
      
      // Duplicate all fields except ID and SINO
      formDATE.value = transaction.DATE || '';
      formACCOUNTHEADER.value = transaction.ACCOUNT_HEADER || '';
      formBANKNAME.value = transaction.BANK_NAME || '';
      formVOUCHERTYPE.value = transaction.VOUCHER_TYPE || 'Payment';
      formTYPE.value = transaction.TYPE || 'Expense';
      formINCOME.value = transaction.INCOME || '';
      formEXPENSE.value = transaction.EXPENSE || '';
      formBALANCE.value = transaction.BALANCE || '';
      formDESCRIPTION.value = transaction.DESCRIPTION || '';
      formNOTES.value = transaction.NOTES || '';
      formTAGS.value = transaction.TAGS ? transaction.TAGS.join(', ') : '';
      formSTATUS.value = transaction.STATUS || 'completed';
      formCURRENCY.value = transaction.CURRENCY || 'USD';
      
      // Generate new voucher number
      getNextVoucherNumber(transaction.VOUCHER_TYPE || 'Payment').then(voucherNumber => {
        formSINO.value = voucherNumber;
      });
      
      updateTagsPreview();
      transactionModal.show();
    }

    function getNextVoucherNumber(voucherType) {
      return new Promise((resolve) => {
        let maxNumber = 0;
        
        allTransactions.forEach(tx => {
          if (tx.VOUCHER_TYPE === voucherType && tx.SINO) {
            const match = tx.SINO.match(/\d+/);
            if (match) {
              const num = parseInt(match[0]);
              if (num > maxNumber) maxNumber = num;
            }
          }
        });
        
        let prefix = '';
        switch(voucherType) {
          case 'Receipt': prefix = 'RP-'; break;
          case 'Journal': prefix = 'JR-'; break;
          case 'Transfer': prefix = 'TR-'; break;
          case 'Contra': prefix = 'CT-'; break;
          default: prefix = ''; // Payment
        }
        
        const nextNumber = (maxNumber + 1).toString().padStart(3, '0');
        resolve(prefix + nextNumber);
      });
    }

        // ========== FILTERING AND SEARCH ==========
    function handleDateFilterChange() {
      if (dateFilter.value === "custom") {
        customRangeControls.style.display = "flex";
        const today = new Date().toISOString().split('T')[0];
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        endDateInput.value = today;
      } else {
        customRangeControls.style.display = "none";
      }
    }

    function applyFilters() {
      filteredTransactions = [...allTransactions];
      const now = new Date();

      function inRange(dateStr, start, end) {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        return d >= start && d <= end;
      }

      // Date filter
      if (dateFilter.value !== "all") {
        let start, end;
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        switch (dateFilter.value) {
          case "today":
            start = new Date(today);
            end = new Date(today);
            end.setDate(end.getDate() + 1);
            break;
          case "week":
            const day = now.getDay();
            start = new Date(today);
            start.setDate(start.getDate() - day);
            end = new Date(start);
            end.setDate(end.getDate() + 7);
            break;
          case "month":
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
          case "year":
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear() + 1, 0, 1);
            break;
          case "quarter":
            const quarter = Math.floor(now.getMonth() / 3);
            start = new Date(now.getFullYear(), quarter * 3, 1);
            end = new Date(now.getFullYear(), (quarter + 1) * 3, 1);
            break;
          case "last7":
            start = new Date(today);
            start.setDate(start.getDate() - 7);
            end = new Date(today);
            end.setDate(end.getDate() + 1);
            break;
          case "last30":
            start = new Date(today);
            start.setDate(start.getDate() - 30);
            end = new Date(today);
            end.setDate(end.getDate() + 1);
            break;
          case "custom":
            if (startDateInput.value && endDateInput.value) {
              start = new Date(startDateInput.value);
              end = new Date(endDateInput.value);
              end.setDate(end.getDate() + 1); // Include end date
            }
            break;
        }
        
        if (start && end) {
          filteredTransactions = filteredTransactions.filter(t => 
            t.DATE && inRange(t.DATE, start, end)
          );
        }
      }

      // Type filter
      if (typeFilter.value !== "all") {
        if (typeFilter.value === "recurring") {
          filteredTransactions = filteredTransactions.filter(t => t.RECURRING);
        } else {
          filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
        }
      }

      // Bank filter
      if (bankFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          t.BANK_NAME === bankFilter.value
        );
      }

      // Category filter
      if (categoryFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          t.ACCOUNT_HEADER === categoryFilter.value
        );
      }

      // Status filter
      if (statusFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          t.STATUS === statusFilter.value
        );
      }

      // Search filter
      if (searchDesc.value.trim()) {
        const term = searchDesc.value.trim().toLowerCase();
        filteredTransactions = filteredTransactions.filter(t => 
          (t.DESCRIPTION || "").toLowerCase().includes(term) ||
          (t.NOTES || "").toLowerCase().includes(term) ||
          (t.TAGS && t.TAGS.some(tag => tag.toLowerCase().includes(term))) ||
          (t.SINO || "").toLowerCase().includes(term)
        );
      }
      
      // Amount filters
      if (minAmount.value) {
        const min = parseFloat(minAmount.value);
        filteredTransactions = filteredTransactions.filter(t => {
          const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
          return amount >= min;
        });
      }
      
      if (maxAmount.value) {
        const max = parseFloat(maxAmount.value);
        filteredTransactions = filteredTransactions.filter(t => {
          const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
          return amount <= max;
        });
      }
      
      // Tag filter
      if (tagFilter.value.trim()) {
        const tags = tagFilter.value.split(',').map(tag => tag.trim().toLowerCase());
        filteredTransactions = filteredTransactions.filter(t => {
          if (!t.TAGS || !Array.isArray(t.TAGS)) return false;
          return tags.some(searchTag => 
            t.TAGS.some(tag => tag.toLowerCase().includes(searchTag))
          );
        });
      }
      
      // Sorting
      switch (sortBy.value) {
        case "date-asc":
          filteredTransactions.sort((a, b) => new Date(a.DATE) - new Date(b.DATE));
          break;
        case "amount-desc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountB - amountA;
          });
          break;
        case "amount-asc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountA - amountB;
          });
          break;
        case "category":
          filteredTransactions.sort((a, b) => (a.ACCOUNT_HEADER || "").localeCompare(b.ACCOUNT_HEADER || ""));
          break;
        case "bank":
          filteredTransactions.sort((a, b) => (a.BANK_NAME || "").localeCompare(b.BANK_NAME || ""));
          break;
        default: // date-desc
          filteredTransactions.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
          break;
      }
      
      // Grouping
      if (groupBy.value !== "none") {
        // Grouping will be handled in the table render function
      }

      currentPage = 1;
      buildTable();
      updateStats();
      updateSelectedSummary();
      updateFilterSummary();
    }

    function resetFilters() {
      dateFilter.value = "all";
      typeFilter.value = "all";
      bankFilter.value = "all";
      categoryFilter.value = "all";
      statusFilter.value = "all";
      searchDesc.value = "";
      startDateInput.value = "";
      endDateInput.value = "";
      minAmount.value = "";
      maxAmount.value = "";
      tagFilter.value = "";
      sortBy.value = "date-desc";
      groupBy.value = "none";
      customRangeControls.style.display = "none";
      advancedFilters.style.display = "none";
      advancedFiltersBtn.textContent = "Advanced";
      applyFilters();
    }

    function toggleAdvancedFilters() {
      const isVisible = advancedFilters.style.display === "flex";
      advancedFilters.style.display = isVisible ? "none" : "flex";
      advancedFiltersBtn.textContent = isVisible ? "Advanced" : "Hide Advanced";
    }

    // ========== TABLE BUILDING AND PAGINATION ==========
    function buildTable() {
      if (filteredTransactions.length === 0) {
        transactionsTableBody.innerHTML = `
          <tr>
            <td colspan="13" class="text-center text-muted py-5">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <i class="fa fa-exchange-alt"></i>
                </div>
                <h5>No transactions found</h5>
                <p class="text-muted">Try changing your filters or add a new transaction.</p>
                <button class="btn btn-primary mt-2" onclick="openAddModal()">
                  <i class="fa fa-plus me-1"></i> Add Transaction
                </button>
              </div>
            </td>
          </tr>`;
        listPaginationControls.innerHTML = "";
        return;
      }

      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

      let html = "";
      
      // Handle grouping
      if (groupBy.value !== "none") {
        const groups = {};
        pageTransactions.forEach(tx => {
          let groupKey;
          switch(groupBy.value) {
            case "date":
              groupKey = formatDateToYyyyMmmDd(tx.DATE);
              break;
            case "category":
              groupKey = tx.ACCOUNT_HEADER || "Uncategorized";
              break;
            case "bank":
              groupKey = tx.BANK_NAME || "No Bank";
              break;
            case "type":
              groupKey = tx.TYPE || "Unknown";
              break;
            default:
              groupKey = "Uncategorized";
          }
          
          if (!groups[groupKey]) {
            groups[groupKey] = [];
          }
          groups[groupKey].push(tx);
        });
        
        Object.entries(groups).forEach(([groupName, groupTransactions]) => {
          // Calculate group totals
          const groupIncome = groupTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
          const groupExpense = groupTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
          
          html += `
            <tr class="table-group">
              <td colspan="13" style="background: rgba(111, 66, 193, 0.1); font-weight: 600; padding: 10px 15px;">
                <div class="d-flex justify-content-between align-items-center">
                  <span>${groupBy.value}: ${escapeHtml(groupName)}</span>
                  <small>
                    <span class="income-color me-3">Income: ${formatCurrency(groupIncome)}</span>
                    <span class="expense-color">Expense: ${formatCurrency(groupExpense)}</span>
                    <span class="ms-3">${groupTransactions.length} transactions</span>
                  </small>
                </div>
              </td>
            </tr>
          `;
          
          html += groupTransactions.map(tx => renderTableRow(tx)).join('');
        });
      } else {
        pageTransactions.forEach(tx => {
          html += renderTableRow(tx);
        });
      }
      
      transactionsTableBody.innerHTML = html;

      // Add event listeners with event delegation
      transactionsTableBody.addEventListener("click", handleTableClick);
      transactionsTableBody.addEventListener("change", handleTableChange);

      // Build pagination
      buildPagination(listPaginationControls, filteredTransactions.length, rowsPerPage, currentPage);
    }

    function renderTableRow(tx) {
      const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
      const income = parseFloat(tx.INCOME) || 0;
      const expense = parseFloat(tx.EXPENSE) || 0;
      const balance = parseFloat(tx.BALANCE) || 0;
      const isSelected = selectedTransactions.has(tx.id);
      
      const incomeDisplay = income > 0 ? `<span class="income-color">${formatCurrency(income)}</span>` : "$0.00";
      const expenseDisplay = expense > 0 ? `<span class="expense-color">${formatCurrency(expense)}</span>` : "$0.00";
      const balanceDisplay = balanceVisible ? formatCurrency(balance) : "••••";
      
      let badgeClass = '';
      let badgeText = tx.TYPE;
      if (tx.TYPE === 'Income') badgeClass = 'badge-income';
      else if (tx.TYPE === 'Expense') badgeClass = 'badge-expense';
      else if (tx.TYPE === 'Transfer') badgeClass = 'badge-transfer';
      
      if (tx.RECURRING) {
        badgeClass = 'badge-recurring';
        badgeText = 'Recurring';
      }
      
      // Highlight search term
      let description = escapeHtml(tx.DESCRIPTION || tx.NOTES || "");
      if (searchDesc.value.trim()) {
        const term = searchDesc.value.trim();
        const regex = new RegExp(`(${escapeHtml(term)})`, 'gi');
        description = description.replace(regex, '<span class="highlight">$1</span>');
      }
      
      // Render tags
      let tagsHtml = '';
      if (tx.TAGS && tx.TAGS.length > 0) {
        tagsHtml = tx.TAGS.slice(0, 3).map(tag => `
          <span class="tag">
            ${escapeHtml(tag)}
            <button class="tag-remove" onclick="event.stopPropagation(); removeTagFromTransaction('${tx.id}', '${tag}')">
              <i class="fa fa-times"></i>
            </button>
          </span>
        `).join('');
        if (tx.TAGS.length > 3) {
          tagsHtml += `<span class="tag">+${tx.TAGS.length - 3}</span>`;
        }
      }
      
      return `
        <tr class="${isSelected ? 'selected' : ''}" data-id="${tx.id}" draggable="true">
          <td>
            <input type="checkbox" class="transaction-checkbox row-checkbox" data-id="${tx.id}" ${isSelected ? 'checked' : ''}>
            <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
          </td>
          <td>${date}</td>
          <td>${escapeHtml(tx.ACCOUNT_HEADER || "-")}</td>
          <td>${description}</td>
          <td><span class="badge ${badgeClass}">${badgeText}</span></td>
          <td>${escapeHtml(tx.SINO || "")}</td>
          <td>${escapeHtml(tx.BANK_NAME || "")}</td>
          <td style="text-align:right;">${incomeDisplay}</td>
          <td style="text-align:right;">${expenseDisplay}</td>
          <td style="text-align:right;">${balanceDisplay}</td>
          <td>
            <div class="tag-container">
              ${tagsHtml}
            </div>
          </td>
          <td>
            ${
              tx.ATTACHMENT
                ? `<button class="btn btn-sm btn-outline-primary view-attachment" data-attachment="${escapeHtml(tx.ATTACHMENT)}">
                    <i class="fa fa-paperclip"></i> View
                  </button>`
                : `<span class="text-muted">None</span>`
            }
          </td>
          <td>
            <div class="d-flex gap-1">
              <button class="action-btn btn-view view-tx" data-id="${tx.id}" title="View"><i class="fa fa-eye"></i></button>
              <button class="action-btn btn-edit edit-tx" data-id="${tx.id}" title="Edit"><i class="fa fa-edit"></i></button>
              <button class="action-btn btn-duplicate duplicate-tx" data-id="${tx.id}" title="Duplicate"><i class="fa fa-copy"></i></button>
              ${tx.RECURRING ? '<button class="action-btn btn-recurring" data-id="${tx.id}" title="Recurring"><i class="fa fa-redo"></i></button>' : ''}
              <button class="action-btn btn-del delete-tx" data-id="${tx.id}" title="Delete"><i class="fa fa-trash"></i></button>
            </div>
          </td>
        </tr>
      `;
    }

    function handleTableClick(e) {
      const target = e.target;
      const button = target.closest("button");
      
      if (!button) return;
      
      if (button.classList.contains("view-tx")) {
        const id = button.getAttribute("data-id");
        viewTransaction(id);
      } else if (button.classList.contains("edit-tx")) {
        const id = button.getAttribute("data-id");
        editTransaction(id);
      } else if (button.classList.contains("delete-tx")) {
        const id = button.getAttribute("data-id");
        confirmDelete(id);
      } else if (button.classList.contains("duplicate-tx")) {
        const id = button.getAttribute("data-id");
        duplicateTransactionById(id);
      } else if (button.classList.contains("view-attachment")) {
        const attachment = button.getAttribute("data-attachment");
        viewAttachment(attachment);
      } else if (button.classList.contains("tag-remove")) {
        // Event handled inline
      }
    }

    function handleTableChange(e) {
      if (e.target.classList.contains("row-checkbox")) {
        const id = e.target.getAttribute("data-id");
        const row = e.target.closest("tr");
        
        if (e.target.checked) {
          selectedTransactions.add(id);
          row.classList.add("selected");
        } else {
          selectedTransactions.delete(id);
          row.classList.remove("selected");
          selectAllCheckbox.checked = false;
        }
        
        updateBulkActions();
        updateSelectedSummary();
      }
    }

    function buildPagination(container, totalItems, itemsPerPage, currentPageNum) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) {
        container.innerHTML = "";
        return;
      }

      let html = `<nav><ul class="pagination pagination-sm">`;

      // Previous button
      html += `
        <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPageNum - 1}">
            <i class="fa fa-chevron-left"></i>
          </a>
        </li>
      `;

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPageNum - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPageNum ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      // Next button
      html += `
        <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPageNum + 1}">
            <i class="fa fa-chevron-right"></i>
          </a>
        </li>
      `;

      html += `</ul></nav>`;
      container.innerHTML = html;

      // Event delegation for pagination
      container.addEventListener("click", function(e) {
        const link = e.target.closest(".page-link");
        if (link) {
          e.preventDefault();
          const page = parseInt(link.getAttribute("data-page"));
          if (page && page !== currentPageNum && page > 0 && page <= totalPages) {
            currentPage = page;
            const activeView = document.querySelector('.tab-pane.active').id;
            if (activeView === "listView") {
              buildTable();
            } else if (activeView === "gridView") {
              renderGridView();
            }
          }
        }
      });
    }

    // ========== GRID VIEW ==========
    function renderGridView() {
      if (filteredTransactions.length === 0) {
        gridViewContainer.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fa fa-exchange-alt"></i>
              </div>
              <h5>No transactions found</h5>
              <p class="text-muted">Try changing your filters or add a new transaction.</p>
              <button class="btn btn-primary mt-2" onclick="openAddModal()">
                <i class="fa fa-plus me-1"></i> Add Transaction
              </button>
            </div>
          </div>
        `;
        gridPaginationControls.innerHTML = "";
        return;
      }

      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

      let html = '';
      pageTransactions.forEach(tx => {
        const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        const amount = income > 0 ? income : expense;
        const amountType = income > 0 ? 'income' : 'expense';
        
        // Determine card class based on transaction type
        let cardClass = '';
        if (tx.TYPE === 'Income') cardClass = 'grid-card-income';
        else if (tx.TYPE === 'Expense') cardClass = 'grid-card-expense';
        else if (tx.TYPE === 'Transfer') cardClass = 'grid-card-transfer';
        
        // Format description
        const description = escapeHtml(tx.DESCRIPTION || tx.NOTES || "");
        const shortDescription = description.length > 60 ? description.substring(0, 60) + '...' : description;
        const accountHeader = escapeHtml(tx.ACCOUNT_HEADER || "");
        const bankName = escapeHtml(tx.BANK_NAME || "");
        
        // Format amount with color
        const amountDisplay = amountType === 'income' 
          ? `<span class="text-success">+${formatCurrency(amount)}</span>`
          : `<span class="text-danger">-${formatCurrency(amount)}</span>`;
        
        // Determine badge
        let badgeClass = '';
        let badgeText = tx.TYPE;
        if (tx.TYPE === 'Income') badgeClass = 'badge-income';
        else if (tx.TYPE === 'Expense') badgeClass = 'badge-expense';
        else if (tx.TYPE === 'Transfer') badgeClass = 'badge-transfer';
        if (tx.RECURRING) {
          badgeClass = 'badge-recurring';
          badgeText = 'Recurring';
        }
        
        // Render tags
        let tagsHtml = '';
        if (tx.TAGS && tx.TAGS.length > 0) {
          tagsHtml = `
            <div class="grid-card-tags">
              ${tx.TAGS.slice(0, 3).map(tag => `
                <span class="grid-tag">${escapeHtml(tag)}</span>
              `).join('')}
              ${tx.TAGS.length > 3 ? `<span class="grid-tag">+${tx.TAGS.length - 3}</span>` : ''}
            </div>
          `;
        }
        
        html += `
          <div class="grid-card ${cardClass}" onclick="viewTransaction('${tx.id}')">
            <div class="grid-card-header">
              <h6 class="grid-card-title">${shortDescription}</h6>
              <div class="grid-card-amount">${amountDisplay}</div>
            </div>
            <div class="grid-card-body">
              <div><i class="fa fa-folder me-1"></i> ${accountHeader}</div>
              <div><i class="fa fa-bank me-1"></i> ${bankName}</div>
              <div><i class="fa fa-receipt me-1"></i> ${escapeHtml(tx.SINO || "")}</div>
              ${tx.RECURRING ? '<div><small class="text-warning"><i class="fa fa-redo me-1"></i> Recurring</small></div>' : ''}
              ${tagsHtml}
            </div>
            <div class="grid-card-footer">
              <span><i class="fa fa-calendar me-1"></i> ${date}</span>
              <span class="badge ${badgeClass}">
                ${badgeText}
              </span>
            </div>
          </div>
        `;
      });
      
      gridViewContainer.innerHTML = html;
      
      // Build pagination for grid view
      buildPagination(gridPaginationControls, filteredTransactions.length, rowsPerPage, currentPage);
    }

    // ========== CALENDAR VIEW ==========
    function renderCalendarView() {
      // Get filtered transactions for calendar
      let calendarTransactions = [...filteredTransactions];
      
      // Apply calendar type filter
      if (calendarTypeFilterElement.value !== 'all') {
        calendarTransactions = calendarTransactions.filter(tx => tx.TYPE === calendarTypeFilterElement.value);
      }
      
      if (calendarTransactions.length === 0) {
        calendarContainer.innerHTML = `
          <div class="card">
            <div class="card-body text-center py-5">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <i class="fa fa-calendar-alt"></i>
                </div>
                <h5>No transactions found</h5>
                <p class="text-muted">Try changing your filters or add a new transaction.</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      // Get month name
      const monthNames = ["January", "February", "March", "April", "May", "June",
                         "July", "August", "September", "October", "November", "December"];
      
      // Create calendar HTML
      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const firstDayIndex = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
      
      // Group transactions by day
      const transactionsByDay = {};
      calendarTransactions.forEach(tx => {
        if (tx.DATE) {
          const txDate = new Date(tx.DATE);
          if (txDate.getMonth() === calendarMonth && txDate.getFullYear() === calendarYear) {
            const day = txDate.getDate();
            if (!transactionsByDay[day]) {
              transactionsByDay[day] = [];
            }
            transactionsByDay[day].push(tx);
          }
        }
      });
      
      // Create calendar grid
      let calendarHtml = `
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">${monthNames[calendarMonth]} ${calendarYear}</h5>
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="prevMonth()">
                  <i class="fa fa-chevron-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary mx-2" onclick="goToToday()">
                  Today
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                  <i class="fa fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="calendar-wrapper">
              <div class="calendar-grid">
                <div class="calendar-header">
                  <div class="calendar-cell">Sun</div>
                  <div class="calendar-cell">Mon</div>
                  <div class="calendar-cell">Tue</div>
                  <div class="calendar-cell">Wed</div>
                  <div class="calendar-cell">Thu</div>
                  <div class="calendar-cell">Fri</div>
                  <div class="calendar-cell">Sat</div>
                </div>
                <div class="calendar-body" id="calendarDays">
      `;
      
      // Add empty cells for days before the first day of the month
      for (let i = 0; i < firstDayIndex; i++) {
        calendarHtml += `<div class="calendar-day empty"></div>`;
      }
      
      // Add cells for each day of the month
      const today = new Date();
      const isToday = (day) => {
        return day === today.getDate() && 
               calendarMonth === today.getMonth() && 
               calendarYear === today.getFullYear();
      };
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayTransactions = transactionsByDay[day] || [];
        const todayClass = isToday(day) ? ' today' : '';
        const hasTransactions = dayTransactions.length > 0 ? ' has-transactions' : '';
        
        let transactionsHtml = '';
        if (dayTransactions.length > 0) {
          // Show summary of transactions for the day
          const dayIncome = dayTransactions
            .filter(tx => tx.TYPE === 'Income')
            .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
          
          const dayExpense = dayTransactions
            .filter(tx => tx.TYPE === 'Expense')
            .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
          
          transactionsHtml = `
            <div class="calendar-day-transactions">
              ${dayIncome > 0 ? `
                <div class="calendar-transaction-item transaction-income" title="Income: ${formatCurrency(dayIncome)}">
                  <small><i class="fa fa-arrow-up"></i> ${formatCurrency(dayIncome)}</small>
                </div>
              ` : ''}
              ${dayExpense > 0 ? `
                <div class="calendar-transaction-item transaction-expense" title="Expense: ${formatCurrency(dayExpense)}">
                  <small><i class="fa fa-arrow-down"></i> ${formatCurrency(dayExpense)}</small>
                </div>
              ` : ''}
              ${dayTransactions.length > 2 ? `
                <div class="calendar-day-more">
                  +${dayTransactions.length - 2} more
                </div>
              ` : ''}
            </div>
          `;
        }
        
        calendarHtml += `
          <div class="calendar-day${todayClass}${hasTransactions}" onclick="showDayTransactions(${day}, ${calendarMonth}, ${calendarYear})">
            <div class="calendar-day-number">
              ${isToday(day) ? `<span class="calendar-day-today">${day}</span>` : day}
            </div>
            ${transactionsHtml}
          </div>
        `;
      }
      
      calendarHtml += `
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      calendarContainer.innerHTML = calendarHtml;
    }

    function showDayTransactions(day, month, year) {
      const targetDate = new Date(year, month, day);
      const dateStr = targetDate.toISOString().split('T')[0];
      
      // Filter transactions for this day
      const dayTransactions = filteredTransactions.filter(tx => {
        if (!tx.DATE) return false;
        const txDate = new Date(tx.DATE);
        return txDate.getDate() === day && 
               txDate.getMonth() === month && 
               txDate.getFullYear() === year;
      });
      
      if (dayTransactions.length === 0) {
        Swal.fire({
          title: `No transactions for ${targetDate.toLocaleDateString()}`,
          text: 'No transactions found for this date.',
          icon: 'info'
        });
        return;
      }
      
      // Create transactions list
      let transactionsHtml = '';
      dayTransactions.forEach(tx => {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        
        transactionsHtml += `
          <div class="card mb-2">
            <div class="card-body py-2">
              <div class="d-flex justify-content-between align-items-center">
                <div style="flex: 1;">
                  <strong>${escapeHtml(tx.DESCRIPTION || tx.NOTES || "")}</strong>
                  <div class="small text-muted">
                    ${escapeHtml(tx.ACCOUNT_HEADER || "")} • ${escapeHtml(tx.BANK_NAME || "")}
                  </div>
                  ${tx.TAGS && tx.TAGS.length > 0 ? `
                    <div class="mt-1">
                      ${tx.TAGS.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                    </div>
                  ` : ''}
                </div>
                <div class="text-end ms-3">
                  ${income > 0 ? 
                    `<span class="text-success fw-bold">+${formatCurrency(income)}</span>` : 
                    `<span class="text-danger fw-bold">-${formatCurrency(expense)}</span>`}
                  <div class="small mt-1">
                    <span class="badge ${tx.TYPE === 'Income' ? 'badge-income' : tx.TYPE === 'Expense' ? 'badge-expense' : 'badge-transfer'}">
                      ${tx.TYPE}
                    </span>
                  </div>
                </div>
              </div>
              <div class="mt-2 d-flex justify-content-end gap-1">
                <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${tx.id}')">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${tx.id}')">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      // Calculate day totals
      const dayIncome = dayTransactions
        .filter(tx => tx.TYPE === 'Income')
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      
      const dayExpense = dayTransactions
        .filter(tx => tx.TYPE === 'Expense')
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      const dayNet = dayIncome - dayExpense;
      
      const dateFormatted = targetDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      Swal.fire({
        title: `Transactions for ${dateFormatted}`,
        html: `
          <div class="mb-3">
            <div class="row text-center">
              <div class="col-4">
                <div class="text-success fw-bold">${formatCurrency(dayIncome)}</div>
                <small>Income</small>
              </div>
              <div class="col-4">
                <div class="text-danger fw-bold">${formatCurrency(dayExpense)}</div>
                <small>Expense</small>
              </div>
              <div class="col-4">
                <div class="fw-bold ${dayNet >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(dayNet)}</div>
                <small>Net</small>
              </div>
            </div>
          </div>
          ${transactionsHtml}
        `,
        width: 700,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function prevMonth() {
      calendarMonth--;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendarView();
    }

    function nextMonth() {
      calendarMonth++;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      }
      renderCalendarView();
    }

    function goToToday() {
      const today = new Date();
      calendarYear = today.getFullYear();
      calendarMonth = today.getMonth();
      renderCalendarView();
    }

    // ========== BULK OPERATIONS ==========
    function selectAllTransactions() {
      filteredTransactions.forEach(tx => {
        selectedTransactions.add(tx.id);
      });
      updateTableSelection();
      updateBulkActions();
      updateSelectedSummary();
    }

    function deselectAllTransactions() {
      selectedTransactions.clear();
      updateTableSelection();
      updateBulkActions();
      updateSelectedSummary();
    }

    function toggleSelectAll() {
      if (selectAllCheckbox.checked) {
        selectAllTransactions();
      } else {
        deselectAllTransactions();
      }
    }

    function updateTableSelection() {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(checkbox => {
        const id = checkbox.getAttribute('data-id');
        checkbox.checked = selectedTransactions.has(id);
        const row = checkbox.closest('tr');
        if (row) {
          row.classList.toggle('selected', selectedTransactions.has(id));
        }
      });
      selectAllCheckbox.checked = selectedTransactions.size === filteredTransactions.length;
    }

    function updateBulkActions() {
      const count = selectedTransactions.size;
      selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
      
      if (count > 0) {
        bulkActions.classList.remove('hidden');
      } else {
        bulkActions.classList.add('hidden');
      }
    }

    function clearSelection() {
      selectedTransactions.clear();
      updateTableSelection();
      updateBulkActions();
      updateSelectedSummary();
    }

    function openBulkEditModal() {
      const count = selectedTransactions.size;
      if (count === 0) {
        showToast("Please select transactions first", "error");
        return;
      }
      
      bulkEditCount.textContent = count;
      bulkEditField.value = "ACCOUNT_HEADER";
      bulkEditValue.value = "";
      bulkEditModal.show();
    }

    function processBulkEdit() {
      const field = bulkEditField.value;
      const value = bulkEditValue.value.trim();
      
      if (!value) {
        showToast("Please enter a value", "error");
        return;
      }
      
      loadingMessage.textContent = "Updating transactions...";
      loadingModal.show();
      
      setTimeout(() => {
        let updatedCount = 0;
        selectedTransactions.forEach(id => {
          const index = allTransactions.findIndex(t => t.id === id);
          if (index !== -1) {
            allTransactions[index][field] = value;
            allTransactions[index].updatedAt = new Date();
            updatedCount++;
          }
        });
        
        loadingModal.hide();
        bulkEditModal.hide();
        showToast(`Updated ${updatedCount} transaction${updatedCount !== 1 ? 's' : ''}`, "success");
        
        // Clear selection and refresh
        clearSelection();
        filteredTransactions = [...allTransactions];
        applyFilters();
      }, 1000);
    }

    function openBulkTagModal() {
      const count = selectedTransactions.size;
      if (count === 0) {
        showToast("Please select transactions first", "error");
        return;
      }
      
      bulkTagCount.textContent = count;
      bulkTagsInput.value = "";
      bulkTagModal.show();
    }

    function processBulkTags() {
      const tagsInput = bulkTagsInput.value.trim();
      
      if (!tagsInput) {
        showToast("Please enter tags", "error");
        return;
      }
      
      const newTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
      
      loadingMessage.textContent = "Adding tags to transactions...";
      loadingModal.show();
      
      setTimeout(() => {
        let updatedCount = 0;
        selectedTransactions.forEach(id => {
          const index = allTransactions.findIndex(t => t.id === id);
          if (index !== -1) {
            const existingTags = allTransactions[index].TAGS || [];
            // Add new tags, avoiding duplicates
            const updatedTags = [...new Set([...existingTags, ...newTags])];
            allTransactions[index].TAGS = updatedTags;
            allTransactions[index].updatedAt = new Date();
            updatedCount++;
          }
        });
        
        loadingModal.hide();
        bulkTagModal.hide();
        showToast(`Added tags to ${updatedCount} transaction${updatedCount !== 1 ? 's' : ''}`, "success");
        
        // Clear selection and refresh
        clearSelection();
        filteredTransactions = [...allTransactions];
        applyFilters();
      }, 1000);
    }

    function confirmBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) {
        showToast("Please select transactions first", "error");
        return;
      }
      
      bulkDeleteCount.textContent = count;
      confirmBulkDeleteModal.show();
    }

    function processBulkDelete() {
      loadingMessage.textContent = "Deleting transactions...";
      loadingModal.show();
      
      setTimeout(() => {
        let deletedCount = 0;
        selectedTransactions.forEach(id => {
          const index = allTransactions.findIndex(t => t.id === id);
          if (index !== -1) {
            allTransactions.splice(index, 1);
            deletedCount++;
          }
        });
        
        loadingModal.hide();
        confirmBulkDeleteModal.hide();
        showToast(`Deleted ${deletedCount} transaction${deletedCount !== 1 ? 's' : ''}`, "success");
        
        // Clear selection and refresh
        clearSelection();
        filteredTransactions = [...allTransactions];
        applyFilters();
      }, 1000);
    }

    // ========== SPLIT INCOME FEATURE ==========
    function openSplitIncomeModal() {
      splitIncomeAmount.value = "";
      splitIncomeDescription.value = "";
      splitIncomeBank.value = "";
      splitExpensesContainer.innerHTML = "";
      splitSummary.innerHTML = "Total allocated: $0.00 | Remaining: $0.00";
      
      // Add first expense row
      addSplitExpense();
      
      splitIncomeModal.show();
    }

    function addSplitExpense() {
      const expenseId = 'expense_' + Date.now() + Math.random().toString(36).substr(2, 9);
      const expenseRow = document.createElement('div');
      expenseRow.className = 'split-transaction-item';
      expenseRow.id = expenseId;
      expenseRow.innerHTML = `
        <div class="split-header">
          <h6 class="mb-0">Expense</h6>
          <button type="button" class="remove-split" onclick="removeSplitExpense('${expenseId}')">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Description</label>
            <input type="text" class="form-control expense-description" placeholder="Expense description" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control expense-amount" placeholder="0.00" oninput="updateSplitSummary()" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Account Header</label>
            <select class="form-select expense-category">
              <option value="">Select Category</option>
              ${coaAccounts.map(acc => `<option value="${acc}">${acc}</option>`).join('')}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control expense-date" value="${new Date().toISOString().split('T')[0]}" />
          </div>
        </div>
      `;
      
      splitExpensesContainer.appendChild(expenseRow);
      updateSplitSummary();
    }

    function removeSplitExpense(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
        updateSplitSummary();
      }
    }

    function updateSplitSummary() {
      const totalIncome = parseFloat(splitIncomeAmount.value) || 0;
      let totalAllocated = 0;
      
      // Calculate total allocated expenses
      const expenseAmounts = document.querySelectorAll('.expense-amount');
      expenseAmounts.forEach(input => {
        totalAllocated += parseFloat(input.value) || 0;
      });
      
      const remaining = totalIncome - totalAllocated;
      
      splitSummary.innerHTML = `
        Total allocated: <strong>${formatCurrency(totalAllocated)}</strong> | 
        Remaining: <strong class="${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">${formatCurrency(remaining)}</strong>
        ${remaining < 0 ? '<span class="text-danger ms-2"><i class="fa fa-exclamation-triangle"></i> Amount exceeded!</span>' : ''}
      `;
      
      // Enable/disable save button based on allocation
      saveSplitTransactionsBtn.disabled = Math.abs(remaining) > 0.01;
    }

    function saveSplitTransactions() {
      const totalIncome = parseFloat(splitIncomeAmount.value);
      const incomeDescription = splitIncomeDescription.value;
      const incomeBank = splitIncomeBank.value;
      const incomeDate = document.getElementById('splitIncomeDate').value;
      
      if (!totalIncome || !incomeDescription || !incomeBank || !incomeDate) {
        showToast("Please fill in all income details", "error");
        return;
      }
      
      // Get all expense details
      const expenses = [];
      const expenseItems = document.querySelectorAll('.split-transaction-item');
      let totalExpenses = 0;
      
      expenseItems.forEach(item => {
        const description = item.querySelector('.expense-description').value;
        const amount = parseFloat(item.querySelector('.expense-amount').value);
        const category = item.querySelector('.expense-category').value;
        const date = item.querySelector('.expense-date').value;
        
        if (description && amount && category && date) {
          expenses.push({ description, amount, category, date });
          totalExpenses += amount;
        }
      });
      
      if (expenses.length === 0) {
        showToast("Please add at least one expense", "error");
        return;
      }
      
      if (Math.abs(totalIncome - totalExpenses) > 0.01) {
        showToast("Income and expenses must balance", "error");
        return;
      }
      
      loadingMessage.textContent = "Saving split transactions...";
      loadingModal.show();
      
      setTimeout(() => {
        // Save income transaction
        const incomeTx = {
          id: 'tx_income_' + Date.now(),
          DATE: incomeDate,
          SINO: getNextVoucherNumberSync('Receipt'),
          ACCOUNT_HEADER: "Split Income",
          BANK_NAME: incomeBank,
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: totalIncome,
          EXPENSE: 0,
          BALANCE: 0,
          DESCRIPTION: incomeDescription,
          NOTES: "Split income into multiple expenses",
          TAGS: ["split-income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        };
        
        allTransactions.unshift(incomeTx);
        
        // Save expense transactions
        expenses.forEach((expense, index) => {
          const expenseTx = {
            id: 'tx_expense_' + Date.now() + '_' + index,
            DATE: expense.date,
            SINO: getNextVoucherNumberSync('Payment'),
            ACCOUNT_HEADER: expense.category,
            BANK_NAME: incomeBank,
            VOUCHER_TYPE: "Payment",
            TYPE: "Expense",
            INCOME: 0,
            EXPENSE: expense.amount,
            BALANCE: 0,
            DESCRIPTION: expense.description,
            NOTES: `Part of split from: ${incomeDescription}`,
            TAGS: ["split-expense"],
            STATUS: "completed",
            CURRENCY: "USD",
            createdAt: new Date(),
            updatedAt: new Date()
          };
          
          allTransactions.unshift(expenseTx);
        });
        
        loadingModal.hide();
        splitIncomeModal.hide();
        showToast(`Saved ${expenses.length + 1} transactions`, "success");
        
        // Refresh data
        filteredTransactions = [...allTransactions];
        applyFilters();
      }, 1500);
    }

    function getNextVoucherNumberSync(voucherType) {
      let maxNumber = 0;
      
      allTransactions.forEach(tx => {
        if (tx.VOUCHER_TYPE === voucherType && tx.SINO) {
          const match = tx.SINO.match(/\d+/);
          if (match) {
            const num = parseInt(match[0]);
            if (num > maxNumber) maxNumber = num;
          }
        }
      });
      
      let prefix = '';
      switch(voucherType) {
        case 'Receipt': prefix = 'RP-'; break;
        case 'Journal': prefix = 'JR-'; break;
        case 'Transfer': prefix = 'TR-'; break;
        case 'Contra': prefix = 'CT-'; break;
        default: prefix = ''; // Payment
      }
      
      const nextNumber = (maxNumber + 1).toString().padStart(3, '0');
      return prefix + nextNumber;
    }

    // ========== EXPORT FUNCTIONALITY ==========
    function exportToCSV() {
      if (filteredTransactions.length === 0) {
        showToast("No transactions to export", "warning");
        return;
      }
      
      const headers = ["Date", "Voucher #", "Account Header", "Bank", "Type", "Income", "Expense", "Description", "Notes", "Tags", "Status"];
      
      const csvData = filteredTransactions.map(tx => [
        tx.DATE || '',
        tx.SINO || '',
        tx.ACCOUNT_HEADER || '',
        tx.BANK_NAME || '',
        tx.TYPE || '',
        tx.INCOME || 0,
        tx.EXPENSE || 0,
        `"${(tx.DESCRIPTION || '').replace(/"/g, '""')}"`,
        `"${(tx.NOTES || '').replace(/"/g, '""')}"`,
        tx.TAGS ? tx.TAGS.join('; ') : '',
        tx.STATUS || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...csvData.map(row => row.join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`Exported ${filteredTransactions.length} transactions to CSV`, "success");
    }

    function exportToExcel() {
      if (filteredTransactions.length === 0) {
        showToast("No transactions to export", "warning");
        return;
      }
      
      // Create worksheet
      const wsData = [
        ["Date", "Voucher #", "Account Header", "Bank", "Type", "Income", "Expense", "Description", "Notes", "Tags", "Status"],
        ...filteredTransactions.map(tx => [
          tx.DATE || '',
          tx.SINO || '',
          tx.ACCOUNT_HEADER || '',
          tx.BANK_NAME || '',
          tx.TYPE || '',
          tx.INCOME || 0,
          tx.EXPENSE || 0,
          tx.DESCRIPTION || '',
          tx.NOTES || '',
          tx.TAGS ? tx.TAGS.join('; ') : '',
          tx.STATUS || ''
        ])
      ];
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Add some styling
      const wscols = [
        {wch: 12}, // Date
        {wch: 10}, // Voucher #
        {wch: 20}, // Account Header
        {wch: 15}, // Bank
        {wch: 10}, // Type
        {wch: 12}, // Income
        {wch: 12}, // Expense
        {wch: 30}, // Description
        {wch: 30}, // Notes
        {wch: 20}, // Tags
        {wch: 10}  // Status
      ];
      ws['!cols'] = wscols;
      
      XLSX.utils.book_append_sheet(wb, ws, "Transactions");
      
      // Generate and download
      XLSX.writeFile(wb, `transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showToast(`Exported ${filteredTransactions.length} transactions to Excel`, "success");
    }

    function exportToPDF() {
      if (filteredTransactions.length === 0) {
        showToast("No transactions to export", "warning");
        return;
      }
      
      loadingMessage.textContent = "Generating PDF...";
      loadingModal.show();
      
      // Create PDF content
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.text('Transaction Report', 105, 15, { align: 'center' });
      
      // Add date
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
      
      // Add summary
      const totalIncome = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      const net = totalIncome - totalExpense;
      
      doc.setFontSize(12);
      doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, 35);
      doc.text(`Total Expense: ${formatCurrency(totalExpense)}`, 20, 42);
      doc.text(`Net: ${formatCurrency(net)}`, 20, 49);
      doc.text(`Transactions: ${filteredTransactions.length}`, 20, 56);
      
      // Add table headers
      doc.setFontSize(10);
      const headers = [['Date', 'Description', 'Type', 'Income', 'Expense']];
      const body = filteredTransactions.map(tx => [
        formatDateToYyyyMmmDd(tx.DATE),
        (tx.DESCRIPTION || '').substring(0, 30),
        tx.TYPE,
        formatCurrency(tx.INCOME || 0),
        formatCurrency(tx.EXPENSE || 0)
      ]);
      
      doc.autoTable({
        head: headers,
        body: body,
        startY: 65,
        theme: 'striped',
        headStyles: { fillColor: [111, 66, 193] },
        columnStyles: {
          0: { cellWidth: 25 },
          1: { cellWidth: 70 },
          2: { cellWidth: 25 },
          3: { cellWidth: 30 },
          4: { cellWidth: 30 }
        }
      });
      
      // Save PDF
      doc.save(`transactions_${new Date().toISOString().split('T')[0]}.pdf`);
      
      loadingModal.hide();
      showToast(`Exported ${filteredTransactions.length} transactions to PDF`, "success");
    }

    // ========== STATISTICS AND CHARTS ==========
    function updateStats() {
      const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      statIncome.textContent = formatCurrency(totalIncome);
      statExpense.textContent = formatCurrency(totalExpense);
      statBalance.textContent = balanceVisible ? formatCurrency(balance) : '••••';
      statCount.textContent = filteredTransactions.length;
      
      // Calculate trends
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      
      const lastMonthIncome = allTransactions
        .filter(t => t.DATE && new Date(t.DATE) >= lastMonth && new Date(t.DATE) < thisMonthStart && t.TYPE === 'Income')
        .reduce((sum, t) => sum + (parseFloat(t.INCOME) || 0), 0);
      
      const thisMonthIncome = allTransactions
        .filter(t => t.DATE && new Date(t.DATE) >= thisMonthStart && t.TYPE === 'Income')
        .reduce((sum, t) => sum + (parseFloat(t.INCOME) || 0), 0);
      
      const lastMonthExpense = allTransactions
        .filter(t => t.DATE && new Date(t.DATE) >= lastMonth && new Date(t.DATE) < thisMonthStart && t.TYPE === 'Expense')
        .reduce((sum, t) => sum + (parseFloat(t.EXPENSE) || 0), 0);
      
      const thisMonthExpense = allTransactions
        .filter(t => t.DATE && new Date(t.DATE) >= thisMonthStart && t.TYPE === 'Expense')
        .reduce((sum, t) => sum + (parseFloat(t.EXPENSE) || 0), 0);
      
      const incomeTrendValue = lastMonthIncome > 0 ? ((thisMonthIncome - lastMonthIncome) / lastMonthIncome * 100).toFixed(1) : 0;
      const expenseTrendValue = lastMonthExpense > 0 ? ((thisMonthExpense - lastMonthExpense) / lastMonthExpense * 100).toFixed(1) : 0;
      
      incomeTrend.textContent = `${incomeTrendValue}%`;
      expenseTrend.textContent = `${expenseTrendValue}%`;
      
      // Update trend icons
      const incomeTrendIcon = incomeTrend.previousElementSibling;
      const expenseTrendIcon = expenseTrend.previousElementSibling;
      
      incomeTrendIcon.className = `fa fa-arrow-${incomeTrendValue >= 0 ? 'up text-success' : 'down text-danger'}`;
      expenseTrendIcon.className = `fa fa-arrow-${expenseTrendValue >= 0 ? 'up text-danger' : 'down text-success'}`;
    }

    function updateBankBalances() {
      const bankBalances = {};
      
      // Initialize all banks with zero balance
      coaBanks.forEach(bank => {
        bankBalances[bank] = 0;
      });
      
      // Calculate balances
      allTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME;
        if (bankName && bankBalances.hasOwnProperty(bankName)) {
          const income = parseFloat(tx.INCOME) || 0;
          const expense = parseFloat(tx.EXPENSE) || 0;
          bankBalances[bankName] += (income - expense);
        }
      });
      
      // Update UI
      bankBalancesContainer.innerHTML = "";
      
      Object.entries(bankBalances).forEach(([bankName, balance]) => {
        const bankItem = document.createElement("div");
        bankItem.className = "bank-balance-item";
        bankItem.innerHTML = `
          <div class="bank-balance-name">${escapeHtml(bankName)}</div>
          <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? formatCurrency(balance) : '••••'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(bankItem);
        
        bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
          toggleBalanceVisibility();
        });
      });
    }

    function updateQuickStats() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      // Current month stats
      const monthlyIncome = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      // Counts
      const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      // Average transaction amount
      const totalAmount = allTransactions.reduce((sum, tx) => {
        const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        return sum + amount;
      }, 0);
      
      const avgTransaction = allTransactions.length > 0 ? totalAmount / allTransactions.length : 0;
      
      quickStatsContainer.innerHTML = `
        <div class="quick-stat" onclick="showIncomeDetails()">
          <i class="fa fa-arrow-up text-success"></i>
          <span>Monthly Income: <strong>${formatCurrency(monthlyIncome)}</strong></span>
        </div>
        <div class="quick-stat" onclick="showExpenseDetails()">
          <i class="fa fa-arrow-down text-danger"></i>
          <span>Monthly Expenses: <strong>${formatCurrency(monthlyExpenses)}</strong></span>
        </div>
        <div class="quick-stat" onclick="showTransactionStats()">
          <i class="fa fa-chart-line text-info"></i>
          <span>Avg Transaction: <strong>${formatCurrency(avgTransaction)}</strong></span>
        </div>
        <div class="quick-stat" onclick="showTransactionStats()">
          <i class="fa fa-list text-primary"></i>
          <span>Counts: <strong>${incomeCount}/${expenseCount}/${transferCount}</strong></span>
        </div>
      `;
    }

    function renderMainChart() {
      if (mainChart) {
        mainChart.destroy();
      }
      
      const monthlyData = {};
      
      // Group by month
      allTransactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = { income: 0, expense: 0 };
          }
          
          if (tx.TYPE === 'Income') {
            monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
          } else if (tx.TYPE === 'Expense') {
            monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
          }
        }
      });
      
      // Sort months
      const sortedMonths = Object.keys(monthlyData).sort();
      
      // Get last 6 months
      const recentMonths = sortedMonths.slice(-6);
      
      const incomeData = recentMonths.map(month => monthlyData[month].income);
      const expenseData = recentMonths.map(month => monthlyData[month].expense);
      
      // Format month labels
      const monthLabels = recentMonths.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return date.toLocaleString('default', { month: 'short', year: '2-digit' });
      });
      
      const ctx = transactionsChartElement.getContext('2d');
      mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Monthly Income vs Expenses'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + formatCurrency(context.raw);
                }
              }
            }
          }
        }
      });
    }
    // ========== THEME MANAGEMENT ==========
    function toggleTheme() {
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }

    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      
      // Update theme toggle icon
      const icon = themeToggle.querySelector('i');
      icon.className = theme === 'dark' ? 'fa fa-sun' : 'fa fa-moon';
      
      // Update chart colors if chart exists
      if (mainChart) {
        mainChart.destroy();
        renderMainChart();
      }
      
      showToast(`${theme === 'dark' ? 'Dark' : 'Light'} theme activated`, "success");
    }

    // ========== AI ASSISTANT ==========
    function toggleAIPanel() {
      aiPanel.classList.toggle('show');
      if (aiPanel.classList.contains('show')) {
        aiInput.focus();
      }
    }

    function sendAIMessage() {
      const message = aiInput.value.trim();
      if (!message) return;
      
      // Add user message
      addAIMessage(message, 'user');
      aiInput.value = '';
      
      // Show typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'ai-message bot';
      typingIndicator.innerHTML = '<i class="fa fa-ellipsis-h"></i>';
      aiChat.appendChild(typingIndicator);
      aiChat.scrollTop = aiChat.scrollHeight;
      
      // Simulate AI response
      setTimeout(() => {
        typingIndicator.remove();
        const response = generateAIResponse(message);
        addAIMessage(response, 'bot');
      }, 1000 + Math.random() * 1000);
    }

    function addAIMessage(message, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ${sender}`;
      messageDiv.textContent = message;
      aiChat.appendChild(messageDiv);
      aiChat.scrollTop = aiChat.scrollHeight;
    }

    function generateAIResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      // Financial analysis responses
      if (lowerMessage.includes('balance') || lowerMessage.includes('how much')) {
        const totalIncome = allTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        const totalExpense = allTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
        const balance = totalIncome - totalExpense;
        
        return `Your current balance is ${formatCurrency(balance)}. Total income: ${formatCurrency(totalIncome)}, Total expenses: ${formatCurrency(totalExpense)}.`;
      }
      
      if (lowerMessage.includes('expense') && lowerMessage.includes('high')) {
        const expenses = allTransactions.filter(tx => tx.TYPE === 'Expense');
        if (expenses.length === 0) return "No expenses found.";
        
        const highestExpense = expenses.reduce((max, tx) => 
          (parseFloat(tx.EXPENSE) || 0) > (parseFloat(max.EXPENSE) || 0) ? tx : max
        );
        
        return `Your highest expense was ${formatCurrency(highestExpense.EXPENSE)} for "${highestExpense.DESCRIPTION}" on ${formatDateToYyyyMmmDd(highestExpense.DATE)}.`;
      }
      
      if (lowerMessage.includes('income') || lowerMessage.includes('earning')) {
        const recentIncome = allTransactions
          .filter(tx => tx.TYPE === 'Income')
          .slice(0, 5)
          .map(tx => `${formatCurrency(tx.INCOME)} - ${tx.DESCRIPTION}`)
          .join(', ');
        
        return recentIncome ? `Recent income sources: ${recentIncome}` : "No recent income found.";
      }
      
      if (lowerMessage.includes('suggest') || lowerMessage.includes('advice')) {
        const tips = [
          "Consider setting a monthly budget for better expense control.",
          "Review your recurring expenses and cancel unused subscriptions.",
          "Try to save at least 20% of your income each month.",
          "Use the split income feature to allocate funds to different categories.",
          "Regularly review your transactions to identify spending patterns."
        ];
        return tips[Math.floor(Math.random() * tips.length)];
      }
      
      if (lowerMessage.includes('report') || lowerMessage.includes('summary')) {
        const monthlyIncome = allTransactions
          .filter(tx => tx.TYPE === 'Income')
          .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
        const monthlyExpense = allTransactions
          .filter(tx => tx.TYPE === 'Expense')
          .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
        
        return `Monthly Summary: Income: ${formatCurrency(monthlyIncome)}, Expenses: ${formatCurrency(monthlyExpense)}, Net: ${formatCurrency(monthlyIncome - monthlyExpense)}. You have ${allTransactions.length} total transactions.`;
      }
      
      if (lowerMessage.includes('tag') || lowerMessage.includes('category')) {
        const tags = new Set();
        allTransactions.forEach(tx => {
          if (tx.TAGS) {
            tx.TAGS.forEach(tag => tags.add(tag));
          }
        });
        
        return tags.size > 0 
          ? `You have ${tags.size} tags: ${Array.from(tags).join(', ')}. Use tags to better categorize your transactions.`
          : "You haven't used any tags yet. Try adding tags to your transactions for better organization.";
      }
      
      // Default responses
      const responses = [
        "I can help you analyze your finances. Try asking about your balance, expenses, or income.",
        "You can ask me to generate reports, suggest budgeting tips, or analyze your spending patterns.",
        "I recommend reviewing your transactions regularly to stay on top of your finances.",
        "Try using the split income feature to allocate funds to different expense categories.",
        "Use tags to categorize your transactions for better reporting and analysis."
      ];
      
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // ========== QUICK ADD FUNCTIONALITY ==========
    function processQuickAdd() {
      const input = quickAddInput.value.trim();
      if (!input) {
        showToast("Please enter transaction details", "error");
        return;
      }
      
      // Parse quick add format: "Description $amount Type [Category] [Tags]"
      const parts = input.split(' ');
      let description = '';
      let amount = 0;
      let type = 'Expense';
      let category = coaAccounts[0] || 'Miscellaneous';
      let tags = [];
      
      // Simple parser
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        
        // Check for amount (starts with $)
        if (part.startsWith('$')) {
          amount = parseFloat(part.substring(1)) || 0;
        }
        // Check for type keywords
        else if (['income', 'expense', 'transfer'].includes(part.toLowerCase())) {
          type = part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
        }
        // Check for tags (starts with #)
        else if (part.startsWith('#')) {
          tags.push(part.substring(1));
        }
        // Otherwise, it's part of description or category
        else if (coaAccounts.includes(part)) {
          category = part;
        } else {
          description += part + ' ';
        }
      }
      
      description = description.trim();
      
      if (!description || amount === 0) {
        showToast("Could not parse transaction. Format: 'Description $amount Type [Category] [#tags]'", "error");
        return;
      }
      
      // Create transaction
      const today = new Date().toISOString().split('T')[0];
      const transaction = {
        id: 'tx_quick_' + Date.now(),
        DATE: today,
        SINO: getNextVoucherNumberSync(type === 'Income' ? 'Receipt' : 'Payment'),
        ACCOUNT_HEADER: category,
        BANK_NAME: coaBanks[0] || 'Cash',
        VOUCHER_TYPE: type === 'Income' ? 'Receipt' : 'Payment',
        TYPE: type,
        INCOME: type === 'Income' ? amount : 0,
        EXPENSE: type !== 'Income' ? amount : 0,
        BALANCE: 0,
        DESCRIPTION: description,
        NOTES: "Added via quick add",
        TAGS: tags,
        STATUS: "completed",
        CURRENCY: "USD",
        createdAt: new Date(),
        updatedAt: new Date()
      };
      
      loadingMessage.textContent = "Adding transaction...";
      loadingModal.show();
      
      setTimeout(() => {
        allTransactions.unshift(transaction);
        filteredTransactions = [...allTransactions];
        applyFilters();
        
        quickAddModal.hide();
        loadingModal.hide();
        showToast("Transaction added successfully", "success");
        quickAddInput.value = "";
      }, 800);
    }

    // ========== TAG MANAGEMENT ==========
    function updateTagsPreview() {
      const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag);
      tagsPreview.innerHTML = '';
      
      tags.forEach(tag => {
        if (tag) {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'tag';
          tagSpan.innerHTML = `
            ${escapeHtml(tag)}
            <button class="tag-remove" onclick="removeTagFromPreview('${tag}')">
              <i class="fa fa-times"></i>
            </button>
          `;
          tagsPreview.appendChild(tagSpan);
        }
      });
    }

    function removeTagFromPreview(tagToRemove) {
      const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag && tag !== tagToRemove);
      formTAGS.value = tags.join(', ');
      updateTagsPreview();
    }

    function removeTagFromTransaction(txId, tagToRemove) {
      const index = allTransactions.findIndex(t => t.id === txId);
      if (index !== -1) {
        const tx = allTransactions[index];
        const updatedTags = tx.TAGS.filter(tag => tag !== tagToRemove);
        allTransactions[index].TAGS = updatedTags;
        allTransactions[index].updatedAt = new Date();
        
        // Refresh display
        filteredTransactions = [...allTransactions];
        applyFilters();
        showToast(`Removed tag "${tagToRemove}"`, "success");
      }
    }

    function showTagManager() {
      tagManagerModal.show();
      loadAllTags();
    }

    function loadAllTags() {
      const allTags = new Set();
      allTransactions.forEach(tx => {
        if (tx.TAGS && Array.isArray(tx.TAGS)) {
          tx.TAGS.forEach(tag => allTags.add(tag));
        }
      });
      
      const tagsContainer = document.getElementById('allTagsContainer');
      tagsContainer.innerHTML = '';
      
      if (allTags.size === 0) {
        tagsContainer.innerHTML = '<div class="text-muted text-center py-3">No tags yet</div>';
        return;
      }
      
      Array.from(allTags).sort().forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
        tagElement.innerHTML = `
          <div>
            <span class="badge bg-primary me-2">${escapeHtml(tag)}</span>
            <small class="text-muted">${countTransactionsWithTag(tag)} transactions</small>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="filterByTag('${tag}')">
              <i class="fa fa-filter"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteTag('${tag}')">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        `;
        tagsContainer.appendChild(tagElement);
      });
    }

    function countTransactionsWithTag(tag) {
      return allTransactions.filter(tx => 
        tx.TAGS && tx.TAGS.includes(tag)
      ).length;
    }

    function filterByTag(tag) {
      tagFilter.value = tag;
      applyFilters();
      tagManagerModal.hide();
      showToast(`Filtering by tag: ${tag}`, "success");
    }

    function deleteTag(tag) {
      Swal.fire({
        title: 'Delete Tag?',
        text: `This will remove the tag "${tag}" from all transactions.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Delete',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          let updatedCount = 0;
          
          allTransactions.forEach(tx => {
            if (tx.TAGS && tx.TAGS.includes(tag)) {
              tx.TAGS = tx.TAGS.filter(t => t !== tag);
              tx.updatedAt = new Date();
              updatedCount++;
            }
          });
          
          filteredTransactions = [...allTransactions];
          applyFilters();
          loadAllTags();
          
          showToast(`Removed tag "${tag}" from ${updatedCount} transactions`, "success");
        }
      });
    }

    function addNewTag() {
      const tagName = document.getElementById('newTagName').value.trim();
      const tagColor = document.getElementById('newTagColor').value;
      
      if (!tagName) {
        showToast("Please enter a tag name", "error");
        return;
      }
      
      // Check if tag already exists
      const tagExists = Array.from(allTags).some(tag => tag.toLowerCase() === tagName.toLowerCase());
      if (tagExists) {
        showToast("Tag already exists", "error");
        return;
      }
      
      allTags.add(tagName);
      loadAllTags();
      
      document.getElementById('newTagName').value = '';
      showToast(`Tag "${tagName}" added`, "success");
    }

    // ========== ATTACHMENT HANDLING ==========
    function viewAttachment(attachmentUrl) {
      attachmentModalBody.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Loading attachment...</p>
        </div>
      `;
      
      attachmentModal.show();
      
      // Simulate attachment loading
      setTimeout(() => {
        // For demo purposes, show a placeholder
        // In a real app, you would fetch the actual attachment
        attachmentModalBody.innerHTML = `
          <div class="text-center">
            <i class="fa fa-file-alt fa-4x text-muted mb-3"></i>
            <h5>Attachment Preview</h5>
            <p class="text-muted">This is a preview of the attached file.</p>
            <div class="alert alert-info">
              <small>
                <i class="fa fa-info-circle me-1"></i>
                In a real application, this would show the actual file content.
                Supported formats: PDF, images, documents.
              </small>
            </div>
          </div>
        `;
        
        // Set download link
        const downloadBtn = document.getElementById('downloadAttachmentBtn');
        downloadBtn.href = attachmentUrl;
        downloadBtn.download = attachmentUrl.split('/').pop() || 'attachment';
      }, 1000);
    }

    // ========== RECURRING TRANSACTIONS ==========
    function toggleRecurringOptions() {
      const isVisible = recurringOptions.style.display === "block";
      recurringOptions.style.display = isVisible ? "none" : "block";
    }

    function calculateNextRecurringDate(startDate, recurringConfig) {
      if (!recurringConfig) return null;
      
      const start = new Date(startDate);
      const frequency = recurringConfig.frequency;
      const interval = recurringConfig.interval || 1;
      
      const nextDate = new Date(start);
      
      switch (frequency) {
        case 'daily':
          nextDate.setDate(nextDate.getDate() + interval);
          break;
        case 'weekly':
          nextDate.setDate(nextDate.getDate() + (interval * 7));
          break;
        case 'monthly':
          nextDate.setMonth(nextDate.getMonth() + interval);
          break;
        case 'quarterly':
          nextDate.setMonth(nextDate.getMonth() + (interval * 3));
          break;
        case 'yearly':
          nextDate.setFullYear(nextDate.getFullYear() + interval);
          break;
      }
      
      return nextDate.toISOString().split('T')[0];
    }

    function showRecurringTransactions() {
      const recurringTxs = allTransactions.filter(tx => tx.RECURRING);
      
      if (recurringTxs.length === 0) {
        Swal.fire({
          title: 'Recurring Transactions',
          text: 'No recurring transactions found.',
          icon: 'info'
        });
        return;
      }
      
      let html = `
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Frequency</th>
                <th>Next Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      recurringTxs.forEach(tx => {
        const amount = tx.INCOME > 0 ? formatCurrency(tx.INCOME) : formatCurrency(tx.EXPENSE);
        const amountClass = tx.INCOME > 0 ? 'text-success' : 'text-danger';
        
        html += `
          <tr>
            <td>${escapeHtml(tx.DESCRIPTION)}</td>
            <td class="${amountClass} fw-bold">${amount}</td>
            <td>${tx.RECURRING.frequency} (every ${tx.RECURRING.interval})</td>
            <td>${tx.RECURRING.nextDate ? formatDateToYyyyMmmDd(tx.RECURRING.nextDate) : 'N/A'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editTransaction('${tx.id}')">
                <i class="fa fa-edit"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      Swal.fire({
        title: 'Recurring Transactions',
        html: html,
        width: 800,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    // ========== IMPORT FUNCTIONALITY ==========
    function showImportModal() {
      importModal.show();
    }

    function processImport() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast("Please select a file to import", "error");
        return;
      }
      
      loadingMessage.textContent = "Importing transactions...";
      loadingModal.show();
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          let transactions = [];
          
          // Parse based on file type
          if (file.name.endsWith('.csv')) {
            transactions = parseCSV(content);
          } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            transactions = parseExcel(content);
          } else if (file.name.endsWith('.json')) {
            transactions = JSON.parse(content);
          } else {
            throw new Error('Unsupported file format');
          }
          
          // Validate and process transactions
          const validTransactions = transactions
            .map(tx => validateTransaction(tx))
            .filter(tx => tx !== null);
          
          // Add to existing transactions
          validTransactions.forEach(tx => {
            tx.id = 'tx_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            tx.createdAt = new Date();
            tx.updatedAt = new Date();
            allTransactions.unshift(tx);
          });
          
          loadingModal.hide();
          importModal.hide();
          
          showToast(`Successfully imported ${validTransactions.length} transactions`, "success");
          
          // Refresh data
          filteredTransactions = [...allTransactions];
          applyFilters();
          
        } catch (error) {
          loadingModal.hide();
          showToast(`Import failed: ${error.message}`, "error");
        }
      };
      
      reader.readAsText(file);
    }

    function parseCSV(content) {
      // Simple CSV parser
      const lines = content.split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      
      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const transaction = {};
        
        headers.forEach((header, index) => {
          if (values[index]) {
            transaction[header] = values[index];
          }
        });
        
        return transaction;
      }).filter(tx => Object.keys(tx).length > 0);
    }

    function parseExcel(content) {
      // For demo purposes, return sample data
      // In a real app, use XLSX library properly
      return [
        {
          DATE: new Date().toISOString().split('T')[0],
          DESCRIPTION: 'Imported Transaction',
          AMOUNT: '100.00',
          TYPE: 'Expense',
          CATEGORY: 'Miscellaneous'
        }
      ];
    }

    function validateTransaction(tx) {
      // Basic validation
      if (!tx.DATE || !tx.DESCRIPTION) {
        return null;
      }
      
      const amount = parseFloat(tx.AMOUNT || tx.INCOME || tx.EXPENSE || 0);
      const type = (tx.TYPE || 'expense').toLowerCase();
      
      return {
        DATE: tx.DATE,
        SINO: tx.SINO || getNextVoucherNumberSync(type === 'income' ? 'Receipt' : 'Payment'),
        ACCOUNT_HEADER: tx.CATEGORY || tx.ACCOUNT_HEADER || coaAccounts[0] || 'Miscellaneous',
        BANK_NAME: tx.BANK || tx.BANK_NAME || coaBanks[0] || 'Cash',
        VOUCHER_TYPE: type === 'income' ? 'Receipt' : 'Payment',
        TYPE: type.charAt(0).toUpperCase() + type.slice(1),
        INCOME: type === 'income' ? amount : 0,
        EXPENSE: type !== 'income' ? amount : 0,
        BALANCE: 0,
        DESCRIPTION: tx.DESCRIPTION,
        NOTES: tx.NOTES || 'Imported transaction',
        TAGS: tx.TAGS ? (Array.isArray(tx.TAGS) ? tx.TAGS : tx.TAGS.split(',').map(t => t.trim())) : [],
        STATUS: tx.STATUS || 'completed',
        CURRENCY: tx.CURRENCY || 'USD'
      };
    }

    // ========== REPORT GENERATION ==========
    function showReportModal() {
      reportModal.show();
    }

    function generateReport() {
      const reportType = document.getElementById('reportType').value;
      const dateRange = document.getElementById('reportDateRange').value;
      const format = document.getElementById('reportFormat').value;
      const includeCharts = document.getElementById('reportCharts').value === 'yes';
      
      loadingMessage.textContent = "Generating report...";
      loadingModal.show();
      
      setTimeout(() => {
        loadingModal.hide();
        
        // Filter transactions based on date range
        let reportTransactions = [...allTransactions];
        
        if (dateRange !== 'all') {
          const now = new Date();
          let startDate, endDate;
          
          switch(dateRange) {
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
              break;
            case 'quarter':
              const quarter = Math.floor(now.getMonth() / 3);
              startDate = new Date(now.getFullYear(), quarter * 3, 1);
              endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
              break;
            case 'year':
              startDate = new Date(now.getFullYear(), 0, 1);
              endDate = new Date(now.getFullYear(), 11, 31);
              break;
            case 'custom':
              const customStart = document.getElementById('reportStartDate').value;
              const customEnd = document.getElementById('reportEndDate').value;
              if (customStart && customEnd) {
                startDate = new Date(customStart);
                endDate = new Date(customEnd);
              }
              break;
          }
          
          if (startDate && endDate) {
            reportTransactions = reportTransactions.filter(tx => {
              const txDate = new Date(tx.DATE);
              return txDate >= startDate && txDate <= endDate;
            });
          }
        }
        
        // Generate report based on type
        let reportContent = '';
        let reportTitle = '';
        
        switch(reportType) {
          case 'summary':
            reportTitle = 'Transaction Summary Report';
            reportContent = generateSummaryReport(reportTransactions);
            break;
          case 'detailed':
            reportTitle = 'Detailed Transaction Report';
            reportContent = generateDetailedReport(reportTransactions);
            break;
          case 'category':
            reportTitle = 'Category-wise Report';
            reportContent = generateCategoryReport(reportTransactions);
            break;
          case 'bank':
            reportTitle = 'Bank-wise Report';
            reportContent = generateBankReport(reportTransactions);
            break;
          case 'monthly':
            reportTitle = 'Monthly Report';
            reportContent = generateMonthlyReport(reportTransactions);
            break;
        }
        
        // Export based on format
        switch(format) {
          case 'html':
            showHTMLReport(reportTitle, reportContent);
            break;
          case 'pdf':
            exportPDFReport(reportTitle, reportContent);
            break;
          case 'csv':
            exportCSVReport(reportTitle, reportTransactions);
            break;
          case 'excel':
            exportExcelReport(reportTitle, reportTransactions);
            break;
        }
        
      }, 1500);
    }

    function generateSummaryReport(transactions) {
      const totalIncome = transactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      const totalExpense = transactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      const net = totalIncome - totalExpense;
      
      const incomeCount = transactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = transactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = transactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      return `
        <h4>Summary Report</h4>
        <p><strong>Period:</strong> ${getReportPeriod()}</p>
        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
        <p><strong>Total Income:</strong> <span class="text-success">${formatCurrency(totalIncome)}</span></p>
        <p><strong>Total Expenses:</strong> <span class="text-danger">${formatCurrency(totalExpense)}</span></p>
        <p><strong>Net Balance:</strong> <span class="${net >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(net)}</span></p>
        <p><strong>Transaction Counts:</strong> Income: ${incomeCount}, Expense: ${expenseCount}, Transfer: ${transferCount}</p>
      `;
    }

    function generateDetailedReport(transactions) {
      let html = `
        <h4>Detailed Transaction Report</h4>
        <p><strong>Period:</strong> ${getReportPeriod()}</p>
        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Bank</th>
                <th>Type</th>
                <th>Income</th>
                <th>Expense</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      transactions.forEach(tx => {
        html += `
          <tr>
            <td>${formatDateToYyyyMmmDd(tx.DATE)}</td>
            <td>${escapeHtml(tx.DESCRIPTION)}</td>
            <td>${escapeHtml(tx.ACCOUNT_HEADER)}</td>
            <td>${escapeHtml(tx.BANK_NAME)}</td>
            <td><span class="badge ${tx.TYPE === 'Income' ? 'badge-income' : tx.TYPE === 'Expense' ? 'badge-expense' : 'badge-transfer'}">${tx.TYPE}</span></td>
            <td class="text-success">${tx.INCOME > 0 ? formatCurrency(tx.INCOME) : '-'}</td>
            <td class="text-danger">${tx.EXPENSE > 0 ? formatCurrency(tx.EXPENSE) : '-'}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      return html;
    }

    function generateCategoryReport(transactions) {
      const categories = {};
      
      transactions.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || 'Uncategorized';
        if (!categories[category]) {
          categories[category] = { income: 0, expense: 0, count: 0 };
        }
        
        categories[category].income += parseFloat(tx.INCOME) || 0;
        categories[category].expense += parseFloat(tx.EXPENSE) || 0;
        categories[category].count++;
      });
      
      let html = `
        <h4>Category-wise Report</h4>
        <p><strong>Period:</strong> ${getReportPeriod()}</p>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Category</th>
                <th>Count</th>
                <th>Total Income</th>
                <th>Total Expense</th>
                <th>Net</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      Object.entries(categories).forEach(([category, data]) => {
        const net = data.income - data.expense;
        html += `
          <tr>
            <td>${escapeHtml(category)}</td>
            <td>${data.count}</td>
            <td class="text-success">${formatCurrency(data.income)}</td>
            <td class="text-danger">${formatCurrency(data.expense)}</td>
            <td class="${net >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(net)}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      return html;
    }

    function getReportPeriod() {
      const now = new Date();
      return now.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    function showHTMLReport(title, content) {
      Swal.fire({
        title: title,
        html: content,
        width: 900,
        showCloseButton: true,
        showConfirmButton: true,
        confirmButtonText: 'Print',
        showDenyButton: true,
        denyButtonText: 'Export as PDF'
      }).then((result) => {
        if (result.isConfirmed) {
          window.print();
        } else if (result.isDenied) {
          exportPDFReport(title, content);
        }
      });
    }

    function exportPDFReport(title, content) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(16);
      doc.text(title, 105, 15, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
      
      // Convert HTML content to plain text for PDF
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      const plainText = tempDiv.textContent || tempDiv.innerText || '';
      
      const splitText = doc.splitTextToSize(plainText, 180);
      doc.setFontSize(10);
      doc.text(splitText, 15, 30);
      
      doc.save(`${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
      showToast("PDF report generated successfully", "success");
    }

    function exportCSVReport(title, transactions) {
      const headers = ["Date", "Description", "Category", "Bank", "Type", "Income", "Expense", "Status"];
      
      const csvData = transactions.map(tx => [
        tx.DATE || '',
        `"${(tx.DESCRIPTION || '').replace(/"/g, '""')}"`,
        tx.ACCOUNT_HEADER || '',
        tx.BANK_NAME || '',
        tx.TYPE || '',
        tx.INCOME || 0,
        tx.EXPENSE || 0,
        tx.STATUS || ''
      ]);
      
      const csvContent = [
        headers.join(','),
        ...csvData.map(row => row.join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast("CSV report generated successfully", "success");
    }

    function exportExcelReport(title, transactions) {
      const wsData = [
        ["Date", "Description", "Category", "Bank", "Type", "Income", "Expense", "Status"],
        ...transactions.map(tx => [
          tx.DATE || '',
          tx.DESCRIPTION || '',
          tx.ACCOUNT_HEADER || '',
          tx.BANK_NAME || '',
          tx.TYPE || '',
          tx.INCOME || 0,
          tx.EXPENSE || 0,
          tx.STATUS || ''
        ])
      ];
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showToast("Excel report generated successfully", "success");
    }

    // ========== FORM FIELD UPDATES ==========
    function updateFormFields() {
      const type = formTYPE.value;
      
      // Show/hide fields based on transaction type
      if (type === 'Income') {
        formINCOME.value = formINCOME.value || '';
        formEXPENSE.value = '';
      } else if (type === 'Expense') {
        formEXPENSE.value = formEXPENSE.value || '';
        formINCOME.value = '';
      } else if (type === 'Transfer') {
        formINCOME.value = '';
        formEXPENSE.value = '';
      }
      
      // Update voucher type based on transaction type
      if (type === 'Income') {
        formVOUCHERTYPE.value = 'Receipt';
      } else if (type === 'Expense') {
        formVOUCHERTYPE.value = 'Payment';
      } else if (type === 'Transfer') {
        formVOUCHERTYPE.value = 'Transfer';
      }
    }

    // ========== SIDEBAR AND NAVIGATION ==========
    function toggleSidebar() {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');
      
      // Update toggle icon
      const icon = sidebarToggle.querySelector('i');
      icon.className = sidebar.classList.contains('collapsed') ? 'fa fa-chevron-right' : 'fa fa-chevron-left';
    }

    function toggleMobileMenu() {
      sidebar.classList.toggle('show');
    }

    function handleLogout() {
      Swal.fire({
        title: 'Logout?',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // In a real app, you would call your logout function here
          // For demo, just show a message
          showToast("Logged out successfully", "success");
          setTimeout(() => {
            window.location.href = 'login.html'; // Redirect to login page
          }, 1000);
        }
      });
    }

    function handleTabSwitch(event) {
      const activeTab = event.target.getAttribute("href");
      if (activeTab === "#gridView") {
        renderGridView();
      } else if (activeTab === "#calendarView") {
        renderCalendarView();
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function updateSelectedSummary() {
      const count = selectedTransactions.size;
      if (count === 0) {
        selectedSummary.innerHTML = "No transactions selected";
        return;
      }
      
      let totalIncome = 0;
      let totalExpense = 0;
      
      selectedTransactions.forEach(id => {
        const tx = allTransactions.find(t => t.id === id);
        if (tx) {
          totalIncome += parseFloat(tx.INCOME) || 0;
          totalExpense += parseFloat(tx.EXPENSE) || 0;
        }
      });
      
      const net = totalIncome - totalExpense;
      
      selectedSummary.innerHTML = `
        <div class="row">
          <div class="col-4">Selected: <strong>${count}</strong></div>
          <div class="col-4">Income: <strong class="text-success">${formatCurrency(totalIncome)}</strong></div>
          <div class="col-4">Expense: <strong class="text-danger">${formatCurrency(totalExpense)}</strong></div>
        </div>
        <div class="row mt-1">
          <div class="col-12">Net: <strong class="${net >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(net)}</strong></div>
        </div>
      `;
    }

    function updateFilterSummary() {
      const count = filteredTransactions.length;
      const total = allTransactions.length;
      const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
      
      let filterDetails = '';
      
      if (dateFilter.value !== 'all') {
        filterDetails += `<br><small>Date: ${dateFilter.options[dateFilter.selectedIndex].text}</small>`;
      }
      if (typeFilter.value !== 'all') {
        filterDetails += `<br><small>Type: ${typeFilter.options[typeFilter.selectedIndex].text}</small>`;
      }
      if (bankFilter.value !== 'all') {
        filterDetails += `<br><small>Bank: ${bankFilter.options[bankFilter.selectedIndex].text}</small>`;
      }
      if (searchDesc.value) {
        filterDetails += `<br><small>Search: "${searchDesc.value}"</small>`;
      }
      
      filterSummary.innerHTML = `
        Showing ${count} of ${total} transactions (${percentage}%)
        ${filterDetails}
      `;
    }

    function updateLastSync() {
      const now = new Date();
      lastSync.textContent = `Last sync: ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      
      // Update main balance
      const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
      const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
      const balance = totalIncome - totalExpense;
      
      statBalance.textContent = balanceVisible ? formatCurrency(balance) : '••••';
      statBalance.classList.toggle('balance-hidden', !balanceVisible);
      
      // Update toggle button
      balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
      
      // Update bank balances
      updateBankBalances();
      
      // Refresh table to update balance display
      buildTable();
      
      showToast(balanceVisible ? "Balance visible" : "Balance hidden", "info");
    }

    // ========== UI ENHANCEMENT FUNCTIONS ==========
    function showIncomeDetails() {
      const incomeTransactions = allTransactions.filter(tx => tx.TYPE === 'Income');
      const totalIncome = incomeTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      
      Swal.fire({
        title: 'Income Details',
        html: `
          <h5>Total Income: <span class="text-success">${formatCurrency(totalIncome)}</span></h5>
          <p>Number of income transactions: ${incomeTransactions.length}</p>
          <div class="text-start mt-3">
            <h6>Recent Income:</h6>
            <ul class="list-group">
              ${incomeTransactions.slice(0, 5).map(tx => `
                <li class="list-group-item">
                  ${formatDateToYyyyMmmDd(tx.DATE)} - ${escapeHtml(tx.DESCRIPTION)}: 
                  <span class="text-success">${formatCurrency(tx.INCOME)}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function showExpenseDetails() {
      const expenseTransactions = allTransactions.filter(tx => tx.TYPE === 'Expense');
      const totalExpense = expenseTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      Swal.fire({
        title: 'Expense Details',
        html: `
          <h5>Total Expenses: <span class="text-danger">${formatCurrency(totalExpense)}</span></h5>
          <p>Number of expense transactions: ${expenseTransactions.length}</p>
          <div class="text-start mt-3">
            <h6>Recent Expenses:</h6>
            <ul class="list-group">
              ${expenseTransactions.slice(0, 5).map(tx => `
                <li class="list-group-item">
                  ${formatDateToYyyyMmmDd(tx.DATE)} - ${escapeHtml(tx.DESCRIPTION)}: 
                  <span class="text-danger">${formatCurrency(tx.EXPENSE)}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function showTransactionStats() {
      const totalTransactions = allTransactions.length;
      const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      const totalAmount = allTransactions.reduce((sum, tx) => {
        return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
      }, 0);
      
      const avgTransaction = totalTransactions > 0 ? totalAmount / totalTransactions : 0;
      
      Swal.fire({
        title: 'Transaction Statistics',
        html: `
          <div class="text-start">
            <p><strong>Total Transactions:</strong> ${totalTransactions}</p>
            <p><strong>Transaction Distribution:</strong></p>
            <ul>
              <li>Income: ${incomeCount} (${totalTransactions > 0 ? ((incomeCount/totalTransactions)*100).toFixed(1) : 0}%)</li>
              <li>Expense: ${expenseCount} (${totalTransactions > 0 ? ((expenseCount/totalTransactions)*100).toFixed(1) : 0}%)</li>
              <li>Transfer: ${transferCount} (${totalTransactions > 0 ? ((transferCount/totalTransactions)*100).toFixed(1) : 0}%)</li>
            </ul>
            <p><strong>Average Transaction Amount:</strong> ${formatCurrency(avgTransaction)}</p>
            <p><strong>Total Amount Processed:</strong> ${formatCurrency(totalAmount)}</p>
          </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function showCashflowChart() {
      // For demo, show a simple cashflow chart
      Swal.fire({
        title: 'Cash Flow Analysis',
        html: `
          <div class="text-center">
            <p class="text-muted">Cash flow chart would appear here</p>
            <p><i class="fa fa-chart-line fa-3x text-primary"></i></p>
            <p>In a real implementation, this would show a detailed cash flow chart</p>
          </div>
        `,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function showNextTip() {
      const randomIndex = Math.floor(Math.random() * tips.length);
      dynamicTip.textContent = tips[randomIndex];
    }

    // ========== INITIALIZATION ==========
    // Set up remaining event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Set up import button
      document.getElementById('processImportBtn').addEventListener('click', processImport);
      
      // Set up report button
      document.getElementById('generateReportBtn').addEventListener('click', generateReport);
      
      // Set up report date range change
      document.getElementById('reportDateRange').addEventListener('change', function() {
        document.getElementById('customReportRange').style.display = 
          this.value === 'custom' ? 'block' : 'none';
      });
      
      // Initialize date inputs
      const today = new Date().toISOString().split('T')[0];
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      
      document.getElementById('reportStartDate').value = oneMonthAgo.toISOString().split('T')[0];
      document.getElementById('reportEndDate').value = today;
      document.getElementById('splitIncomeDate').value = today;
      
      // Show initial tip
      showNextTip();
      
      // Update last sync time
      updateLastSync();
      
      // Start periodic sync (every 30 seconds)
      setInterval(updateLastSync, 30000);
      
      // Make functions available globally
      window.openAddModal = openAddModal;
      window.toggleBalanceVisibility = toggleBalanceVisibility;
      window.showIncomeDetails = showIncomeDetails;
      window.showExpenseDetails = showExpenseDetails;
      window.showTransactionStats = showTransactionStats;
      window.showCashflowChart = showCashflowChart;
      window.showRecurringTransactions = showRecurringTransactions;
      window.showNextTip = showNextTip;
      window.prevMonth = prevMonth;
      window.nextMonth = nextMonth;
      window.goToToday = goToToday;
      window.showDayTransactions = showDayTransactions;
      window.toggleAIPanel = toggleAIPanel;
      window.sendAIMessage = sendAIMessage;
      window.editTransaction = editTransaction;
      window.duplicateTransactionById = duplicateTransactionById;
      window.removeTagFromTransaction = removeTagFromTransaction;
      window.addNewTag = addNewTag;
      window.showTagManager = showTagManager;
      window.showImportModal = showImportModal;
      window.showReportModal = showReportModal;
      window.viewAttachment = viewAttachment;
    });

    // ========== WINDOW EVENT LISTENERS ==========
    window.addEventListener('resize', function() {
      // Handle responsive adjustments
      if (window.innerWidth <= 1200) {
        mobileMenuToggle.style.display = 'flex';
      } else {
        mobileMenuToggle.style.display = 'none';
        sidebar.classList.remove('show');
      }
      
      // Re-render chart on resize
      if (mainChart) {
        setTimeout(() => {
          mainChart.resize();
        }, 100);
      }
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
      if (window.innerWidth <= 1200 && 
          !sidebar.contains(event.target) && 
          !mobileMenuToggle.contains(event.target) &&
          sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
      }
      
      // Close AI panel when clicking outside
      if (!aiPanel.contains(event.target) && 
          !aiAssistant.contains(event.target) &&
          aiPanel.classList.contains('show')) {
        aiPanel.classList.remove('show');
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      // Ctrl/Cmd + N: New transaction
      if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
        event.preventDefault();
        openAddModal();
      }
      
      // Ctrl/Cmd + F: Focus search
      if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
        event.preventDefault();
        searchDesc.focus();
      }
      
      // Ctrl/Cmd + E: Export
      if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
        event.preventDefault();
        exportToCSV();
      }
      
      // Escape: Close modals
      if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.show');
        if (modals.length > 0) {
          bootstrap.Modal.getInstance(modals[0]).hide();
        }
        
        // Close AI panel
        if (aiPanel.classList.contains('show')) {
          aiPanel.classList.remove('show');
        }
      }
    });

    // ========== FINAL INITIALIZATION ==========
    console.log('Transaction Manager Pro initialized successfully!');
    console.log('Features available:');
    console.log('- Transaction CRUD operations');
    console.log('- List/Grid/Calendar views');
    console.log('- Advanced filtering and search');
    console.log('- Bulk operations');
    console.log('- Split income feature');
    console.log('- Export (CSV, Excel, PDF)');
    console.log('- Import functionality');
    console.log('- Report generation');
    console.log('- AI Assistant');
    console.log('- Tag management');
    console.log('- Theme switching (light/dark)');
    console.log('- Responsive design');
    
        // Show welcome message
    setTimeout(() => {
      showToast("Transaction Manager Pro is ready!", "success");
      
      // Optional: Show quick tutorial
      if (!localStorage.getItem('tutorialShown')) {
        setTimeout(() => {
          Swal.fire({
            title: 'Welcome to Transaction Manager Pro!',
            html: `
              <div class="text-start">
                <p><strong>Quick Start Guide:</strong></p>
                <ol>
                  <li>Click the <i class="fa fa-plus"></i> button to add transactions</li>
                  <li>Use filters to find specific transactions</li>
                  <li>Switch between List, Grid, and Calendar views</li>
                  <li>Use bulk actions for multiple transactions</li>
                  <li>Click the AI Assistant <i class="fa fa-robot"></i> for financial insights</li>
                </ol>
                <p class="text-muted">You can always find help in the AI Assistant.</p>
              </div>
            `,
            icon: 'info',
            confirmButtonText: 'Get Started',
            showCloseButton: true
          });
          localStorage.setItem('tutorialShown', 'true');
        }, 1500);
      }
    }, 1000);

    // Performance monitoring (optional)
    setInterval(() => {
      if (allTransactions.length > 1000) {
        console.warn('Large dataset detected:', allTransactions.length, 'transactions');
        showToast(`Managing ${allTransactions.length} transactions. Consider archiving old data.`, 'info');
      }
    }, 60000); // Check every minute
  </script>
</body>
</html>
    