<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager Pro</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      transition: all 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-logo {
      font-weight: 700;
      font-size: 20px;
      color: var(--purple-1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      transition: all 0.2s;
      gap: 12px;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(111, 66, 193, 0.1);
      color: var(--purple-1);
      border-left: 3px solid var(--purple-1);
    }

    .sidebar-menu a i {
      width: 20px;
      text-align: center;
    }

    .sidebar-menu span {
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-menu span {
      opacity: 0;
      display: none;
    }

    .sidebar.collapsed .sidebar-logo span {
      display: none;
    }

    /* Main content with sidebar */
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: var(--sidebar-collapsed);
    }

    .page {
      max-width:1400px;
      margin:20px auto;
      padding:20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-trend { font-size:12px; display: flex; align-items: center; gap: 4px; margin-top: 5px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }
    .transactions-table tbody tr:hover td { background-color: rgba(111, 66, 193, 0.05); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.1); }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-recurring { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; right:30px; bottom:30px; width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(70,34,173,0.2); z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }

    /* responsive */
    @media (max-width: 1200px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .sidebar.show { transform: translateX(0); }
      .page { padding: 15px; }
    }
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: flex-end; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { width: 100%; min-width: unset; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      flex: 1;
      min-width: 200px;
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .quick-stat:hover {
      transform: translateY(-2px);
      background: var(--card-bg);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bg-primary);
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .split-summary {
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      font-weight: 600;
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }

    /* Tag system */
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .tag {
      background: var(--purple-1);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag-remove {
      background: none;
      border: none;
      color: white;
      padding: 0;
      cursor: pointer;
      font-size: 10px;
    }

    /* Search highlight */
    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
    }
    .nav-tabs .nav-link {
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
    }
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
    }

    /* Drag and drop */
    .drag-handle {
      cursor: move;
      color: var(--muted);
    }
    .dragging {
      opacity: 0.5;
      background: var(--bg-primary);
    }

    /* Recurring transactions */
    .recurring-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: black;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    /* AI Assistant */
    .ai-assistant {
      position: fixed;
      bottom: 100px;
      right: 30px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(70,34,173,0.3);
      z-index: 1100;
      transition: all 0.3s;
    }
    .ai-assistant:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(70,34,173,0.4);
    }
    .ai-panel {
      position: fixed;
      bottom: 170px;
      right: 30px;
      width: 350px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1099;
      display: none;
    }
    .ai-panel.show {
      display: block;
    }
    .ai-header {
      padding: 15px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-body {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .ai-message.user {
      background: rgba(111, 66, 193, 0.1);
      margin-left: 40px;
    }
    .ai-message.bot {
      background: var(--bg-primary);
      margin-right: 40px;
    }
    .ai-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid var(--border-color);
    }

    /* Mobile menu toggle */
    .mobile-menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 1200px) {
      .mobile-menu-toggle {
        display: flex;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Color picker */
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--purple-1);
    }

    /* Grid View Styles */
    .grid-card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 15px;
      transition: all 0.3s;
      height: 100%;
    }
    .grid-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .grid-card-income {
      border-left: 4px solid var(--success);
    }
    .grid-card-expense {
      border-left: 4px solid var(--danger);
    }
    .grid-card-transfer {
      border-left: 4px solid var(--info);
    }
    .grid-card-recurring {
      border-left: 4px solid var(--warning);
    }
    .grid-amount {
      font-size: 18px;
      font-weight: 700;
      margin: 10px 0;
    }
    .grid-date {
      font-size: 12px;
      color: var(--muted);
    }
    .grid-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
    }

    /* Calendar View Styles */
    .calendar {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 20px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      padding: 10px;
      color: var(--muted);
      font-size: 14px;
    }
    .calendar-day {
      min-height: 80px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 8px;
      background: var(--bg-primary);
      transition: all 0.2s;
    }
    .calendar-day:hover {
      background: rgba(111, 66, 193, 0.1);
    }
    .calendar-day.empty {
      background: transparent;
      border: none;
    }
    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .calendar-day-transactions {
      font-size: 11px;
    }
    .calendar-transaction {
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .calendar-transaction-income {
      background: rgba(25, 135, 84, 0.1);
      color: var(--success);
    }
    .calendar-transaction-expense {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    .calendar-nav-btn {
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .calendar-nav-btn:hover {
      background: var(--purple-2);
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fa fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fa fa-chart-line"></i>
        <span>FinancePro</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fa fa-chevron-left"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active"><i class="fa fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fa fa-exchange-alt"></i> <span>Transactions</span></a></li>
      <li><a href="#"><i class="fa fa-wallet"></i> <span>Accounts</span></a></li>
      <li><a href="#"><i class="fa fa-tags"></i> <span>Categories</span></a></li>
      <li><a href="#"><i class="fa fa-calendar-alt"></i> <span>Recurring</span></a></li>
      <li><a href="#"><i class="fa fa-bell"></i> <span>Reminders</span></a></li>
      <li><a href="#"><i class="fa fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="page">
      <!-- Loading Backdrop -->
      <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="backdropMessage">Loading...</p>
        </div>
      </div>
      
      <!-- Toast Container -->
      <div class="toast-container" id="toastContainer"></div>
      
      <!-- Navigation buttons -->
      <div class="nav-buttons">
        <button id="backBtn" class="btn btn-outline-primary">
          <i class="fa fa-arrow-left me-1"></i> Back
        </button>
        <button id="homeBtn" class="btn btn-outline-secondary">
          <i class="fa fa-home me-1"></i> Home
        </button>
        <button id="coaBtn" class="btn btn-outline-info">
          <i class="fa fa-chart-pie me-1"></i> Manage COA
        </button>
        <button id="recurringBtn" class="btn btn-outline-warning">
          <i class="fa fa-redo me-1"></i> Recurring
        </button>
        <div class="export-buttons">
          <button id="exportCSV" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-csv me-1"></i> CSV
          </button>
          <button id="exportExcel" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-excel me-1"></i> Excel
          </button>
        </div>
      </div>
      
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager Pro</h2>
          <div class="header-actions">
            <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
            <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
            <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
            <button id="tagManagerBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-tags me-1"></i> Tags</button>
            <button id="themeToggle" class="theme-toggle">
              <i class="fa fa-moon"></i>
            </button>
            <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
            <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
              <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
              <div style="color:white; font-weight:600;" id="username">User</div>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="bulkCategoryBtn" class="btn btn-outline-success btn-sm">
            <i class="fa fa-folder me-1"></i> Change Category
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>


        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card" onclick="showIncomeDetails()">
            <div class="stat-label">Total Income</div>
            <div id="statIncome" class="stat-value income-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-up text-success"></i> <span id="incomeTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="showExpenseDetails()">
            <div class="stat-label">Total Expenses</div>
            <div id="statExpense" class="stat-value expense-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-down text-danger"></i> <span id="expenseTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="toggleBalanceVisibility()">
            <div class="stat-label">Current Balance</div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">
              <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          <div class="stat-card" onclick="showTransactionStats()">
            <div class="stat-label">Transactions</div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card" onclick="showCashflowChart()">
            <div class="stat-label">Cash Flow</div>
            <div id="statCashflow" class="stat-value">$0.00</div>
            <div class="small-muted">Monthly average</div>
          </div>
        </div>
        
        <!-- Quick stats -->
        <div class="quick-stats" id="quickStats">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart">
          <!-- Chart will be rendered here -->
        </div>
        
        <!-- Bank balances section -->
        <div class="info-banner">
          <i class="fa fa-info-circle me-2"></i> 
          <span id="dynamicTip">Manage your transactions, view attachments, and track your finances in one place.</span>
          <button class="btn btn-sm btn-outline-primary ms-3" onclick="showNextTip()">Next Tip</button>
          <span class="float-end" id="lastSync"></span>
        </div>
        
        <div class="content-body">
          <!-- Tabs for different views -->
          <ul class="nav nav-tabs mb-3" id="viewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#listView">List View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#gridView">Grid View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#calendarView">Calendar View</a>
            </li>
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content">
            <!-- List View -->
            <div class="tab-pane fade show active" id="listView">
              <!-- Bank balances -->
              <div id="bankBalances" class="bank-balances">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- filters -->
              <div class="filters mb-2">
                <select id="dateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="quarter">This Quarter</option>
                </select>

                <div id="customRangeControls" style="display:none; gap:8px;">
                  <input id="startDate" type="date" class="form-control form-control-sm" />
                  <input id="endDate" type="date" class="form-control form-control-sm" />
                </div>

                <select id="typeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                  <option value="recurring">Recurring</option>
                </select>

                <!-- Bank Filter -->
                <select id="bankFilter" class="form-select form-select-sm">
                  <option value="all">All Banks</option>
                  <!-- Will be populated dynamically -->
                </select>

                <!-- Category Filter -->
                <select id="categoryFilter" class="form-select form-select-sm">
                  <option value="all">All Categories</option>
                  <!-- Will be populated dynamically -->
                </select>

                <select id="statusFilter" class="form-select form-select-sm">
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>

                <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes, tags..." />

                <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
                <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                <button id="advancedFiltersBtn" class="btn btn-sm btn-outline-info">Advanced</button>
                <button id="saveFilterBtn" class="btn btn-sm btn-outline-success" title="Save current filter as preset">
                  <i class="fa fa-save"></i>
                </button>
                <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
              </div>
              
              <!-- Advanced filters (initially hidden) -->
              <div id="advancedFilters" style="display: none;" class="filters mb-2">
                <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="Min Amount" step="0.01" />
                <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="Max Amount" step="0.01" />
                <input id="tagFilter" type="text" class="form-control form-control-sm" placeholder="Filter by tags (comma separated)" />
                <select id="sortBy" class="form-select form-select-sm">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="category">Category</option>
                  <option value="bank">Bank</option>
                </select>
                <select id="groupBy" class="form-select form-select-sm">
                  <option value="none">No Grouping</option>
                  <option value="date">Group by Date</option>
                  <option value="category">Group by Category</option>
                  <option value="bank">Group by Bank</option>
                  <option value="type">Group by Type</option>
                </select>
              </div>

              <!-- transactions table -->
              <div class="transactions-table">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th style="width:40px;">
                        <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                        <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
                      </th>
                      <th style="width:110px;">Date</th>
                      <th style="width:120px; text-align:right;">Account Header</th>
                      <th>Description</th>
                      <th style="width:120px;">Type</th>
                      <th style="width:110px;">Voucher #</th>
                      <th style="width:120px;">Bank Name</th>
                      <th style="width:120px; text-align:right;">Income</th>
                      <th style="width:120px; text-align:right;">Expense</th>
                      <th style="width:120px;">Balance</th>
                      <th style="width:120px;">Tags</th>
                      <th style="width:120px;">Attachment</th>
                      <th style="width:130px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr><td colspan="13" class="text-center text-muted py-4">No transactions loaded.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Grid View -->
            <div class="tab-pane fade" id="gridView">
              <div class="row" id="gridViewContainer">
                <!-- Will be populated dynamically -->
              </div>
              <div class="pagination-wrap mt-3" id="gridPaginationControls"></div>
            </div>

            <!-- Calendar View -->
            <div class="tab-pane fade" id="calendarView">
              <div id="calendarContainer">
                <!-- Calendar will be rendered here -->
              </div>
            </div>
          </div>

          <!-- pagination -->
          <div class="pagination-wrap mt-3" id="paginationControls"></div>
          
          <!-- Summary footer -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Selected Summary</h6>
                  <div id="selectedSummary">No transactions selected</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Filter Summary</h6>
                  <div id="filterSummary">Showing all transactions</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="ai-assistant" id="aiAssistant">
    <i class="fa fa-robot"></i>
  </div>
  <div class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <span>Finance Assistant</span>
      <button class="btn btn-sm btn-light" onclick="toggleAIPanel()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="ai-body" id="aiChat">
      <div class="ai-message bot">
        Hi! I'm your finance assistant. How can I help you today?
      </div>
    </div>
    <div class="ai-input">
      <input type="text" class="form-control" id="aiInput" placeholder="Ask me anything..." />
      <button class="btn btn-primary" onclick="sendAIMessage()">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- floating add button -->
  <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>


  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date *</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # (SINO) *</label>
                <input id="formSINO" type="text" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header *</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Account Header</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type *</label>
                <select id="formVOUCHERTYPE" class="form-select" required>
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Contra">Contra</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type *</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Adjustment">Adjustment</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name *</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency *</label>
                <select id="formCURRENCY" class="form-select" required>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="GBP">GBP (£)</option>
                  <option value="INR">INR (₹)</option>
                  <option value="JPY">JPY (¥)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Balance (manual)</label>
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description *</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description" required></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes"></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input id="formTAGS" type="text" class="form-control" placeholder="Enter tags (comma separated)" />
                <div class="tag-container mt-2" id="tagsPreview"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.csv" />
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>

            <!-- Recurring transaction options -->
            <div class="row g-2 mt-2" id="recurringOptions" style="display: none;">
              <div class="col-md-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Recurring Transaction</h6>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">Frequency</label>
                        <select id="formRECURRING_FREQ" class="form-select">
                          <option value="daily">Daily</option>
                          <option value="weekly">Weekly</option>
                          <option value="monthly">Monthly</option>
                          <option value="quarterly">Quarterly</option>
                          <option value="yearly">Yearly</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Interval</label>
                        <input id="formRECURRING_INTERVAL" type="number" class="form-control" value="1" min="1" />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input id="formRECURRING_ENDDATE" type="date" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="duplicateTransactionBtn">
            <i class="fa fa-copy me-1"></i> Duplicate
          </button>
          <button type="button" class="btn btn-info" id="makeRecurringBtn">
            <i class="fa fa-redo me-1"></i> Make Recurring
          </button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction in natural language:</label>
            <textarea id="quickAddInput" class="form-control" rows="3" placeholder="Examples:&#10;• Add 500 to cash&#10;• Spent 200 on petrol from SBI&#10;• Received 1000 payment from client in AXIS&#10;• Transfer 500 from SBI to HDFC"></textarea>
          </div>
          <div class="card bg-light">
            <div class="card-body py-2">
              <small class="text-muted">
                <strong>Format examples:</strong><br>
                • Add [amount] to [account]<br>
                • Spent [amount] on [category] from [bank]<br>
                • Received [amount] for [description] in [bank]<br>
                • Transfer [amount] from [bank1] to [bank2]<br>
                • You can include dates like "yesterday", "last friday", "15th jan"
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="processQuickAddBtn" class="btn btn-primary">Process</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Multiple Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Income Amount to Split</label>
            <input id="splitIncomeAmount" type="number" step="0.01" class="form-control" placeholder="Enter total income amount" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Description</label>
            <input id="splitIncomeDescription" type="text" class="form-control" placeholder="Description for the income transaction" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Bank Account</label>
            <select id="splitIncomeBank" class="form-select">
              <option value="">Select Bank</option>
              <!-- Will be populated from COA -->
            </select>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Expense Transactions</h6>
            <button type="button" id="addSplitExpenseBtn" class="btn btn-sm btn-primary">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div id="splitExpensesContainer">
            <!-- Split expense items will be added here -->
          </div>
          
          <div id="splitSummary" class="split-summary">
            <!-- Summary will be updated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="saveSplitTransactionsBtn" class="btn btn-primary">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Update Field</label>
            <select id="bulkEditField" class="form-select">
              <option value="BANK_NAME">Bank Name</option>
              <option value="ACCOUNT_HEADER">Account Header</option>
              <option value="TYPE">Transaction Type</option>
              <option value="VOUCHER_TYPE">Voucher Type</option>
              <option value="STATUS">Status</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Value</label>
            <input id="bulkEditValue" type="text" class="form-control" placeholder="Enter new value" />
          </div>
          <div class="alert alert-info">
            <small>This will update <span id="bulkEditCount">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkEditBtn" class="btn btn-primary">Update Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal fade" id="bulkTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Tags to Selected Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tags (comma separated)</label>
            <input id="bulkTagsInput" type="text" class="form-control" placeholder="e.g., business, travel, tax-deductible" />
            <small class="text-muted">Existing tags will be preserved, new tags will be added.</small>
          </div>
          <div class="alert alert-info">
            <small>This will add tags to <span id="bulkTagCount">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkTagBtn" class="btn btn-primary">Add Tags</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Manager Modal -->
  <div class="modal fade" id="tagManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tag Manager</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Manage Tags</h6>
              <div class="input-group mb-3">
                <input type="text" class="form-control" id="newTagInput" placeholder="New tag name" />
                <button class="btn btn-primary" onclick="addNewTag()">Add Tag</button>
              </div>
              <div id="tagList" class="mb-3">
                <!-- Tags will be listed here -->
              </div>
            </div>
            <div class="col-md-6">
              <h6>Tag Statistics</h6>
              <div id="tagStats">
                <!-- Tag statistics will be shown here -->
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Attachment modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="attachmentModalBody">
          <!-- filled dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete this transaction?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirm -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete <span id="bulkDeleteCount">0</span> selected transactions?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkDeleteBtn" class="btn btn-danger">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing transaction...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Flatpickr for date range selection -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Cloudinary Upload Widget -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<!-- Firebase + App logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
  measurementId: "G-YFFJL2H54X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// Cloudinary Configuration
const cloudinaryConfig = {
  cloudName: 'dpwdsyvz8',
  uploadPreset: 'my_app_uploads',
  apiKey: '715749169628849',
  folder: 'transaction_attachments',
  sources: ['local', 'camera', 'url'],
  multiple: false,
  maxFileSize: 5000000, // 5MB
  clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'txt', 'csv'],
  showAdvancedOptions: false,
  cropping: false,
  resourceType: 'auto'
};

// Initialize Cloudinary widget
let cloudinaryWidget = null;

function initializeCloudinaryWidget() {
  cloudinaryWidget = cloudinary.createUploadWidget(
    cloudinaryConfig,
    (error, result) => {
      if (!error && result && result.event === "success") {
        console.log("Cloudinary upload successful:", result.info);
        
        // Set the Cloudinary URL in the form
        const cloudinaryUrl = result.info.secure_url;
        document.getElementById('formATTACH').value = cloudinaryUrl;
        document.getElementById('attachmentInfo').textContent = "Uploaded: " + result.info.original_filename;
        
        // Show preview for images
        if (result.info.resource_type === 'image') {
          const attachmentPreview = document.getElementById('attachmentPreview');
          attachmentPreview.src = cloudinaryUrl;
          attachmentPreview.style.display = "block";
        }
        
        // Hide progress bar
        document.getElementById('uploadProgress').style.display = "none";
        
        showToast("File uploaded successfully to Cloudinary", "success");
      } else if (error) {
        console.error("Cloudinary upload error:", error);
        showToast("File upload failed: " + error.message, "error");
        document.getElementById('uploadProgress').style.display = "none";
      }
    }
  );
}

// Function to open Cloudinary upload widget
function openCloudinaryUpload() {
  if (!cloudinaryWidget) {
    initializeCloudinaryWidget();
  }
  
  // Show progress bar
  const uploadProgress = document.getElementById('uploadProgress');
  const uploadProgressBar = document.getElementById('uploadProgressBar');
  uploadProgress.style.display = "block";
  uploadProgressBar.style.width = "0%";
  
  // Simulate progress animation
  const progressInterval = setInterval(() => {
    if (uploadProgressBar.style.width === "100%") {
      clearInterval(progressInterval);
    } else {
      const currentWidth = parseInt(uploadProgressBar.style.width) || 0;
      uploadProgressBar.style.width = Math.min(currentWidth + 10, 100) + "%";
    }
  }, 200);
  
  // Open Cloudinary widget
  setTimeout(() => {
    cloudinaryWidget.open();
  }, 500);
}

// state
let currentUser = null;
let allTransactions = [];
let filteredTransactions = [];
let currentPage = 1;
const rowsPerPage = 10;
let txToDelete = null;
let balanceVisible = false;
let isSubmitting = false;
let lastVoucherNumber = 0;
let currentTheme = 'light';
let mainChart = null;
let selectedTransactions = new Set();
let hasLoadedSavedState = false;
let allTags = new Set();
let recurringTransactions = [];
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// COA data
let coaAccounts = [];
let coaBanks = [];

// DOM refs
const loadingBackdrop = document.getElementById("loadingBackdrop");
const backdropMessage = document.getElementById("backdropMessage");
const usernameElem = document.getElementById("username");
const initialsElem = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const newTxBtn = document.getElementById("newTxBtn");
const quickAddBtn = document.getElementById("quickAddBtn");
const splitIncomeBtn = document.getElementById("splitIncomeBtn");
const floatingAdd = document.getElementById("floatingAdd");
const balanceToggle = document.getElementById("balanceToggle");
const backBtn = document.getElementById("backBtn");
const homeBtn = document.getElementById("homeBtn");
const coaBtn = document.getElementById("coaBtn");
const recurringBtn = document.getElementById("recurringBtn");
const tagManagerBtn = document.getElementById("tagManagerBtn");
const themeToggle = document.getElementById("themeToggle");
const exportCSV = document.getElementById("exportCSV");
const exportExcel = document.getElementById("exportExcel");
const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
const advancedFilters = document.getElementById("advancedFilters");
const includeTimeCheckbox = document.getElementById("includeTime");
const formTIME = document.getElementById("formTIME");
const formCURRENCY = document.getElementById("formCURRENCY");
const minAmount = document.getElementById("minAmount");
const maxAmount = document.getElementById("maxAmount");
const sortBy = document.getElementById("sortBy");
const groupBy = document.getElementById("groupBy");
const tagFilter = document.getElementById("tagFilter");
const formDESCRIPTION = document.getElementById("formDESCRIPTION");
const quickAddInput = document.getElementById("quickAddInput");
const processQuickAddBtn = document.getElementById("processQuickAddBtn");
const loadingModalEl = document.getElementById("loadingModal");
const loadingModal = new bootstrap.Modal(loadingModalEl);
const loadingMessage = document.getElementById("loadingMessage");
const selectAllBtn = document.getElementById("selectAllBtn");
const deselectAllBtn = document.getElementById("deselectAllBtn");
const selectAllCheckbox = document.getElementById("selectAllCheckbox");
const bulkActions = document.getElementById("bulkActions");
const selectedCount = document.getElementById("selectedCount");
const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
const bulkEditBtn = document.getElementById("bulkEditBtn");
const bulkTagBtn = document.getElementById("bulkTagBtn");
const bulkCategoryBtn = document.getElementById("bulkCategoryBtn");
const clearSelectionBtn = document.getElementById("clearSelectionBtn");
const splitIncomeModalEl = document.getElementById("splitIncomeModal");
const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
const splitIncomeAmount = document.getElementById("splitIncomeAmount");
const splitIncomeDescription = document.getElementById("splitIncomeDescription");
const splitIncomeBank = document.getElementById("splitIncomeBank");
const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
const splitExpensesContainer = document.getElementById("splitExpensesContainer");
const splitSummary = document.getElementById("splitSummary");
const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
const bulkEditModalEl = document.getElementById("bulkEditModal");
const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
const bulkEditField = document.getElementById("bulkEditField");
const bulkEditValue = document.getElementById("bulkEditValue");
const bulkEditCount = document.getElementById("bulkEditCount");
const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
const bulkDeleteCount = document.getElementById("bulkDeleteCount");
const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
const duplicateTransactionBtn = document.getElementById("duplicateTransactionBtn");
const makeRecurringBtn = document.getElementById("makeRecurringBtn");
const sidebar = document.getElementById("sidebar");
const sidebarToggle = document.getElementById("sidebarToggle");
const mobileMenuToggle = document.getElementById("mobileMenuToggle");
const mainContent = document.getElementById("mainContent");
const aiAssistant = document.getElementById("aiAssistant");
const aiPanel = document.getElementById("aiPanel");
const aiChat = document.getElementById("aiChat");
const aiInput = document.getElementById("aiInput");
const viewTabs = document.getElementById("viewTabs");
const gridViewContainer = document.getElementById("gridViewContainer");
const calendarContainer = document.getElementById("calendarContainer");
const selectedSummary = document.getElementById("selectedSummary");
const filterSummary = document.getElementById("filterSummary");
const dynamicTip = document.getElementById("dynamicTip");
const lastSync = document.getElementById("lastSync");
const saveFilterBtn = document.getElementById("saveFilterBtn");
const statusFilter = document.getElementById("statusFilter");
const categoryFilter = document.getElementById("categoryFilter");
const tagManagerModalEl = document.getElementById("tagManagerModal");
const tagManagerModal = new bootstrap.Modal(tagManagerModalEl);
const bulkTagModalEl = document.getElementById("bulkTagModal");
const bulkTagModal = new bootstrap.Modal(bulkTagModalEl);
const bulkTagsInput = document.getElementById("bulkTagsInput");
const bulkTagCount = document.getElementById("bulkTagCount");
const confirmBulkTagBtn = document.getElementById("confirmBulkTagBtn");

// Other DOM refs
const dateFilter = document.getElementById("dateFilter");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const customRangeControls = document.getElementById("customRangeControls");
const typeFilter = document.getElementById("typeFilter");
const bankFilter = document.getElementById("bankFilter");
const searchDesc = document.getElementById("searchDesc");
const applyFiltersBtn = document.getElementById("applyFiltersBtn");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");
const transactionsTableBody = document.getElementById("transactionsTableBody");
const paginationControls = document.getElementById("paginationControls");
const gridPaginationControls = document.getElementById("gridPaginationControls");
const bankBalancesContainer = document.getElementById("bankBalances");
const quickStatsContainer = document.getElementById("quickStats");
const transactionsChart = document.getElementById("transactionsChart");

// Modal refs
const transactionModalEl = document.getElementById("transactionModal");
const transactionModal = new bootstrap.Modal(transactionModalEl);
const quickAddModalEl = document.getElementById("quickAddModal");
const quickAddModal = new bootstrap.Modal(quickAddModalEl);
const form = document.getElementById("transactionForm");
const txIdInput = document.getElementById("txId");
const formDATE = document.getElementById("formDATE");
const formSINO = document.getElementById("formSINO");
const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
const formTYPE = document.getElementById("formTYPE");
const formBANKNAME = document.getElementById("formBANKNAME");
const formINCOME = document.getElementById("formINCOME");
const formEXPENSE = document.getElementById("formEXPENSE");
const formBALANCE = document.getElementById("formBALANCE");
const formNOTES = document.getElementById("formNOTES");
const formTAGS = document.getElementById("formTAGS");
const formSTATUS = document.getElementById("formSTATUS");
const tagsPreview = document.getElementById("tagsPreview");
const formATTACHFILE = document.getElementById("formATTACHFILE");
const formATTACH = document.getElementById("formATTACH");
const attachmentPreview = document.getElementById("attachmentPreview");
const attachmentInfo = document.getElementById("attachmentInfo");
const saveTransactionBtn = document.getElementById("saveTransactionBtn");
const uploadProgress = document.getElementById("uploadProgress");
const uploadProgressBar = document.getElementById("uploadProgressBar");
const recurringOptions = document.getElementById("recurringOptions");

const attachmentModalEl = document.getElementById("attachmentModal");
const attachmentModal = new bootstrap.Modal(attachmentModalEl);
const attachmentModalBody = document.getElementById("attachmentModalBody");

const confirmDeleteModalEl = document.getElementById("confirmDeleteModal");
const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

// stats
const statIncome = document.getElementById("statIncome");
const statExpense = document.getElementById("statExpense");
const statBalance = document.getElementById("statBalance");
const statCount = document.getElementById("statCount");
const statCashflow = document.getElementById("statCashflow");
const incomeTrend = document.getElementById("incomeTrend");
const expenseTrend = document.getElementById("expenseTrend");

// Helper functions
function escapeHtml(text) {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function showLoading(message = "Loading...") {
  backdropMessage.textContent = message;
  loadingBackdrop.style.display = "flex";
}

function hideLoading() {
  loadingBackdrop.style.display = "none";
}

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} 
        text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  const container = document.getElementById("toastContainer");
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = "slideIn 0.3s ease reverse";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function formatDateToYyyyMmmDd(dateString) {
  if (!dateString) return "";
  try {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = date.toLocaleString('default', { month: 'short' });
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (e) {
    return dateString;
  }
}



// Auth handling
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const name = user.displayName || user.email || "User";
    usernameElem.textContent = name;
    initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
    
    showLoading("Loading your transactions...");
    
    try {
      // Load theme preference
      loadThemePreference();
      
      // Initialize Cloudinary widget
      initializeCloudinaryWidget();
      
      // Load user preferences and data
      await Promise.all([
        loadUserPreferences(),
        loadCOAData(),
        loadTransactions(),
        loadTags(),
        loadRecurringTransactions()
      ]);
      
      loadAppState();
      applyFilters();
      updateLastSync();
      startPeriodicSync();
      
      hideLoading();
      showToast("Welcome back!", "success");
    } catch (error) {
      hideLoading();
      console.error("Initialization error:", error);
      Swal.fire({ 
        icon: 'error', 
        title: 'Loading Error', 
        text: 'Failed to load data. Please refresh the page.' 
      });
    }
  } else {
    // not logged in
    Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(()=> {
      window.location.href = "index.html";
    });
  }
});

// Event listeners
logoutBtn.addEventListener("click", async () => {
  localStorage.removeItem('budgetAppState');
  await signOut(auth);
  window.location.href = "index.html";
});

newTxBtn.addEventListener("click", () => openAddModal());
floatingAdd.addEventListener("click", () => openAddModal());

balanceToggle.addEventListener("click", () => {
  toggleBalanceVisibility();
});

dateFilter.addEventListener("change", () => {
  if (dateFilter.value === "custom") {
    customRangeControls.style.display = "flex";
  } else {
    customRangeControls.style.display = "none";
  }
});

applyFiltersBtn.addEventListener("click", () => { applyFilters(); });
resetFiltersBtn.addEventListener("click", () => {
  dateFilter.value = "all";
  typeFilter.value = "all";
  bankFilter.value = "all";
  categoryFilter.value = "all";
  statusFilter.value = "all";
  searchDesc.value = "";
  startDateInput.value = "";
  endDateInput.value = "";
  minAmount.value = "";
  maxAmount.value = "";
  tagFilter.value = "";
  sortBy.value = "date-desc";
  groupBy.value = "none";
  customRangeControls.style.display = "none";
  advancedFilters.style.display = "none";
  advancedFiltersBtn.textContent = "Advanced";
  applyFilters();
});

// Navigation button handlers
backBtn.addEventListener("click", () => window.history.back());
homeBtn.addEventListener("click", () => window.location.href = "home.html");
coaBtn.addEventListener("click", () => window.location.href = "coa.html");
recurringBtn.addEventListener("click", () => showRecurringTransactions());
tagManagerBtn.addEventListener("click", () => tagManagerModal.show());

// Theme toggle
themeToggle.addEventListener("click", () => toggleTheme());

// Export buttons
exportCSV.addEventListener("click", () => exportToCSV());
exportExcel.addEventListener("click", () => exportToExcel());

// Advanced filters toggle
advancedFiltersBtn.addEventListener("click", () => {
  const isVisible = advancedFilters.style.display === "flex";
  advancedFilters.style.display = isVisible ? "none" : "flex";
  advancedFiltersBtn.textContent = isVisible ? "Advanced" : "Hide Advanced";
});

// Time toggle
includeTimeCheckbox.addEventListener("change", () => {
  formTIME.disabled = !includeTimeCheckbox.checked;
  if (!includeTimeCheckbox.checked) formTIME.value = "";
});

// Quick Add button
quickAddBtn.addEventListener("click", () => {
  quickAddInput.value = "";
  quickAddModal.show();
});
processQuickAddBtn.addEventListener("click", processQuickAdd);

// Split Income button
splitIncomeBtn.addEventListener("click", () => openSplitIncomeModal());

// Bulk action buttons
selectAllBtn.addEventListener("click", selectAllTransactions);
deselectAllBtn.addEventListener("click", deselectAllTransactions);
selectAllCheckbox.addEventListener("change", toggleSelectAll);
bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
bulkEditBtn.addEventListener("click", openBulkEditModal);
bulkTagBtn.addEventListener("click", openBulkTagModal);
bulkCategoryBtn.addEventListener("click", openBulkCategoryModal);
clearSelectionBtn.addEventListener("click", clearSelection);
confirmBulkEditBtn.addEventListener("click", processBulkEdit);
confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
confirmBulkTagBtn.addEventListener("click", processBulkTags);
duplicateTransactionBtn.addEventListener("click", duplicateTransaction);
makeRecurringBtn.addEventListener("click", toggleRecurringOptions);
saveFilterBtn.addEventListener("click", saveFilterPreset);

// Sidebar toggle
sidebarToggle.addEventListener("click", toggleSidebar);
mobileMenuToggle.addEventListener("click", toggleMobileMenu);

// AI Assistant
aiAssistant.addEventListener("click", toggleAIPanel);
aiInput.addEventListener("keypress", (e) => {
  if (e.key === 'Enter') sendAIMessage();
});

// Form inputs
formTAGS.addEventListener("input", updateTagsPreview);
formTYPE.addEventListener("change", updateFormFields);

// Replace Firebase file upload with Cloudinary
formATTACHFILE.addEventListener("click", (e) => {
  e.preventDefault();
  openCloudinaryUpload();
});

// Tab switching - UPDATED FOR GRID AND CALENDAR VIEWS
viewTabs.addEventListener("shown.bs.tab", (event) => {
  const activeTab = event.target.getAttribute("href");
  console.log("Switching to tab:", activeTab);
  
  if (activeTab === "#gridView") {
    renderGridView();
  } else if (activeTab === "#calendarView") {
    renderCalendarView();
  }
});

// Save transaction
saveTransactionBtn.addEventListener("click", async () => {
  if (isSubmitting) return;
  isSubmitting = true;
      
  saveTransactionBtn.disabled = true;
  saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
  
  if (!formDATE.value) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Date is required' });
    resetSaveButton();
    return;
  }

  if (!formSINO.value) {
    Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Voucher number is required' });
    resetSaveButton();
    return;
  }
      
  const txData = {
    DATE: formDATE.value,
    SINO: formSINO.value,
    ACCOUNT_HEADER: formACCOUNTHEADER.value,
    MODE: formBANKNAME.value,
    BANK_NAME: formBANKNAME.value,
    VOUCHER_TYPE: formVOUCHERTYPE.value,
    TYPE: formTYPE.value,
    INCOME: parseFloat(formINCOME.value) || 0,
    EXPENSE: parseFloat(formEXPENSE.value) || 0,
    BALANCE: parseFloat(formBALANCE.value) || 0,
    DESCRIPTION: formDESCRIPTION.value,
    NOTES: formNOTES.value,
    TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
    STATUS: formSTATUS.value,
    ATTACHMENT: formATTACH.value,
    CURRENCY: formCURRENCY.value,
    createdAt: new Date(),
    updatedAt: new Date(),
    userId: currentUser.uid
  };
  
  if (includeTimeCheckbox.checked && formTIME.value) {
    txData.TIME = formTIME.value;
  }
  
  // Check if recurring
  if (recurringOptions.style.display === "block") {
    txData.RECURRING = {
      frequency: document.getElementById("formRECURRING_FREQ").value,
      interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1,
      endDate: document.getElementById("formRECURRING_ENDDATE").value,
      nextDate: calculateNextRecurringDate(txData.DATE, {
        frequency: document.getElementById("formRECURRING_FREQ").value,
        interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1
      })
    };
  }
  
  try {
    loadingMessage.textContent = "Saving transaction...";
    loadingModal.show();
    
    if (txIdInput.value) {
      // Update existing transaction
      await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), txData);
      showToast("Transaction updated successfully", "success");
    } else {
      // Add new transaction
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
      showToast("Transaction added successfully", "success");
      
      // Update tags collection
      await updateTagsCollection(txData.TAGS);
    }
    
    loadingModal.hide();
    transactionModal.hide();
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("saveTransaction", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transaction' });
  } finally {
    resetSaveButton();
  }
});

confirmDeleteBtn.addEventListener("click", async () => {
  if (!txToDelete) return;
  
  try {
    loadingMessage.textContent = "Deleting transaction...";
    loadingModal.show();
    
    await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
    
    loadingModal.hide();
    showToast("Transaction deleted successfully", "success");
    await loadTransactions();
    confirmDeleteModal.hide();
  } catch (err) {
    loadingModal.hide();
    console.error("deleteTransaction", err);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transaction' });
  }
});

// Load COA data
async function loadCOAData() {
  try {
    if (!currentUser) return;
    
    // Get account headers from chartOfAccounts collection
    const accountsQuery = query(
      collection(db, "users", currentUser.uid, "chartOfAccounts"), 
      where("userId", "==", currentUser.uid)
    );
    const accountsSnapshot = await getDocs(accountsQuery);
    
    coaAccounts = [];
    coaBanks = [];
    
    accountsSnapshot.forEach(doc => {
      const data = doc.data();
      coaAccounts.push(data.name);
      
      // Check if this is a bank account
      if (data.category === "Bank" || data.category === "Cash" || 
          data.type === "Asset" && data.name.toLowerCase().includes("bank")) {
        coaBanks.push(data.name);
      }
    });
    
    // If no accounts found, set default accounts
    if (coaAccounts.length === 0) {
      coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
    }
    
    if (coaBanks.length === 0) {
      coaBanks = ["AXIS", "BOM", "Cash"];
    }
    
    // Populate the dropdowns
    populateCOADropdowns();
    
  } catch (error) {
    console.warn('Error loading COA data:', error.message);
    // Use default accounts if COA is not available
    coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
    coaBanks = ["AXIS", "BOM", "Cash"];
    populateCOADropdowns();
  }
}

function populateCOADropdowns() {
  // Clear existing options (except the first one)
  formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
  formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
  bankFilter.innerHTML = '<option value="all">All Banks</option>';
  splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
  categoryFilter.innerHTML = '<option value="all">All Categories</option>';
  
  // Add account headers
  coaAccounts.forEach(account => {
    const option = document.createElement('option');
    option.value = account;
    option.textContent = account;
    formACCOUNTHEADER.appendChild(option);
    
    // Add to category filter
    const categoryOption = document.createElement('option');
    categoryOption.value = account;
    categoryOption.textContent = account;
    categoryFilter.appendChild(categoryOption);
  });
  
  // Add bank names
  coaBanks.forEach(bank => {
    const option = document.createElement('option');
    option.value = bank;
    option.textContent = bank;
    formBANKNAME.appendChild(option);
    splitIncomeBank.appendChild(option.cloneNode(true));
    
    // Also add to bank filter
    const filterOption = document.createElement('option');
    filterOption.value = bank;
    filterOption.textContent = bank;
    bankFilter.appendChild(filterOption);
  });
}

// Load user preferences
async function loadUserPreferences() {
  try {
    const userPrefsRef = doc(db, "users", currentUser.uid, "preferences", "settings");
    const userPrefsSnap = await getDoc(userPrefsRef);
    
    if (userPrefsSnap.exists()) {
      const prefs = userPrefsSnap.data();
      // Apply user preferences
      if (prefs.defaultCurrency) {
        formCURRENCY.value = prefs.defaultCurrency;
      }
      if (prefs.defaultBank) {
        formBANKNAME.value = prefs.defaultBank;
      }
    }
  } catch (error) {
    console.warn('Error loading user preferences:', error.message);
  }
}

// Optimized transaction loading
async function loadTransactions() {
  try {
    transactionsTableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4 small-muted">Loading transactions...</td></tr>`;
    
    const q = query(
      collection(db, "users", currentUser.uid, "transactions"), 
      orderBy("createdAt", "desc")
    );
    
    const snap = await getDocs(q);
    const txs = snap.docs.map(d => ({ 
      id: d.id, 
      ...d.data(),
      NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
      BANK_NAME: d.data().BANK_NAME || d.data().MODE || "",
      TAGS: d.data().TAGS || [],
      STATUS: d.data().STATUS || "completed"
    }));
    
    allTransactions = txs;
    filteredTransactions = allTransactions.slice();
    
    if (!hasLoadedSavedState) {
      currentPage = 1;
    }
    
    // Calculate running balance once for all transactions
    calculateRunningBalance();
    buildTable();
    updateStats();
    updateBankBalances();
    updateQuickStats();
    renderMainChart();
    updateSelectedSummary();
    updateFilterSummary();
    
    // Refresh grid and calendar views if they're active
    if (document.querySelector('#viewTabs .nav-link.active').getAttribute('href') === '#gridView') {
      renderGridView();
    } else if (document.querySelector('#viewTabs .nav-link.active').getAttribute('href') === '#calendarView') {
      renderCalendarView();
    }
    
    // Initialize voucher numbering (non-blocking)
    setTimeout(() => initVoucherNumbering(), 100);
    
    return true;
  } catch (err) {
    console.error("loadTransactions error:", err);
    transactionsTableBody.innerHTML = `<tr><td colspan="13" class="text-center text-danger py-4">
      <i class="fa fa-exclamation-triangle me-2"></i>Failed to load transactions. Please try again.
    </td></tr>`;
    return false;
  }
}

async function loadTags() {
  try {
    const tagsRef = collection(db, "users", currentUser.uid, "tags");
    const tagsSnap = await getDocs(tagsRef);
    
    allTags.clear();
    tagsSnap.forEach(doc => {
      const tagData = doc.data();
      allTags.add(tagData.name);
    });
    
    // Also extract tags from transactions
    allTransactions.forEach(tx => {
      if (tx.TAGS && Array.isArray(tx.TAGS)) {
        tx.TAGS.forEach(tag => allTags.add(tag));
      }
    });
  } catch (error) {
    console.warn('Error loading tags:', error.message);
  }
}

async function loadRecurringTransactions() {
  try {
    const recurringQuery = query(
      collection(db, "users", currentUser.uid, "transactions"),
      where("RECURRING", "!=", null)
    );
    
    const recurringSnap = await getDocs(recurringQuery);
    recurringTransactions = recurringSnap.docs.map(d => ({
      id: d.id,
      ...d.data()
    }));
  } catch (error) {
    console.warn('Error loading recurring transactions:', error.message);
  }
}

async function initVoucherNumbering() {
  try {
    const q = query(
      collection(db, "users", currentUser.uid, "transactions"),
      orderBy("SINO", "desc"),
      limit(1)
    );
    const snap = await getDocs(q);
    
    if (!snap.empty) {
      const lastTx = snap.docs[0].data();
      if (lastTx.SINO) {
        const match = lastTx.SINO.match(/\d+$/);
        if (match) {
          lastVoucherNumber = parseInt(match[0]);
        }
      }
    }
  } catch (error) {
    console.error("Error initializing voucher numbering:", error);
  }
}

async function getNextVoucherNumber(voucherType) {
  try {
    // For better performance, use local allTransactions array
    let highestPaymentNumber = 0;
    let highestReceiptNumber = 0;
    let highestJournalNumber = 0;
    let highestTransferNumber = 0;
    let highestContraNumber = 0;
    
    // Find the highest numbers for each type from local data
    allTransactions.forEach(tx => {
      if (tx.SINO) {
        if (/^\d+$/.test(tx.SINO)) {
          const num = parseInt(tx.SINO);
          if (num > highestPaymentNumber) highestPaymentNumber = num;
        }
        else if (tx.SINO.startsWith('RP-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestReceiptNumber) highestReceiptNumber = num;
        }
        else if (tx.SINO.startsWith('JR-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestJournalNumber) highestJournalNumber = num;
        }
        else if (tx.SINO.startsWith('TR-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestTransferNumber) highestTransferNumber = num;
        }
        else if (tx.SINO.startsWith('CT-')) {
          const num = parseInt(tx.SINO.substring(3));
          if (num > highestContraNumber) highestContraNumber = num;
        }
      }
    });
    
    // Generate the next number based on voucher type
    if (voucherType === "Payment") {
      return (highestPaymentNumber + 1).toString();
    } else if (voucherType === "Receipt") {
      return `RP-${(highestReceiptNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Journal") {
      return `JR-${(highestJournalNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Transfer") {
      return `TR-${(highestTransferNumber + 1).toString().padStart(3, '0')}`;
    } else if (voucherType === "Contra") {
      return `CT-${(highestContraNumber + 1).toString().padStart(3, '0')}`;
    }
    
    return `${voucherType.substring(0, 2).toUpperCase()}-001`;
    
  } catch (error) {
    console.error("Error getting voucher number:", error);
    // Fallback based on type
    if (voucherType === "Payment") {
      const paymentNumbers = allTransactions
        .filter(tx => tx.SINO && /^\d+$/.test(tx.SINO))
        .map(tx => parseInt(tx.SINO))
        .filter(num => !isNaN(num));
      
      const highestNumber = paymentNumbers.length > 0 ? Math.max(...paymentNumbers) : 0;
      return (highestNumber + 1).toString();
    } else if (voucherType === "Receipt") {
      return "RP-001";
    } else if (voucherType === "Journal") {
      return "JR-001";
    } else if (voucherType === "Transfer") {
      return "TR-001";
    } else if (voucherType === "Contra") {
      return "CT-001";
    }
    
    return `${voucherType.substring(0, 2).toUpperCase()}-001`;
  }
}

function calculateRunningBalance() {
  const sortedTransactions = [...allTransactions].sort((a, b) => {
    return new Date(a.DATE) - new Date(b.DATE);
  });
  
  let runningBalance = 0;
  
  sortedTransactions.forEach(tx => {
    const income = parseFloat(tx.INCOME) || 0;
    const expense = parseFloat(tx.EXPENSE) || 0;
    runningBalance += (income - expense);
    tx.BALANCE = runningBalance;
  });
  
  return sortedTransactions;
}

function calculateBankBalances() {
  const bankBalances = {};
  
  coaBanks.forEach(bank => {
    bankBalances[bank] = 0;
  });
  
  allTransactions.forEach(tx => {
    const bankName = tx.BANK_NAME || tx.MODE || "";
    if (bankName && coaBanks.includes(bankName)) {
      const income = parseFloat(tx.INCOME) || 0;
      const expense = parseFloat(tx.EXPENSE) || 0;
      bankBalances[bankName] += (income - expense);
    }
  });
  
  return bankBalances;
}

function updateBankBalances() {
  const bankBalances = calculateBankBalances();
  
  bankBalancesContainer.innerHTML = "";
  
  // Add cash balance
  let hasCash = false;
  allTransactions.forEach(tx => {
    if ((tx.BANK_NAME === "Cash" || tx.MODE === "Cash") && !coaBanks.includes("Cash")) {
      hasCash = true;
    }
  });
  
  if (hasCash) {
    let cashBalance = 0;
    allTransactions.forEach(tx => {
      if (tx.BANK_NAME === "Cash" || tx.MODE === "Cash") {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        cashBalance += (income - expense);
      }
    });
    
    const cashItem = document.createElement("div");
    cashItem.className = "bank-balance-item";
    cashItem.innerHTML = `
      <div class="bank-balance-name">Cash</div>
      <div class="bank-balance-value ${cashBalance >= 0 ? 'positive-balance' : 'negative-balance'}">
        ${balanceVisible ? `$${cashBalance.toFixed(2)}` : '••••'}
      </div>
      <button class="balance-toggle" title="Toggle balance visibility">
        <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
      </button>
    `;
    bankBalancesContainer.appendChild(cashItem);
    
    cashItem.querySelector('.balance-toggle').addEventListener('click', () => {
      toggleBalanceVisibility();
    });
  }
  
  // Add bank balances
  Object.entries(bankBalances).forEach(([bankName, balance]) => {
    const bankItem = document.createElement("div");
    bankItem.className = "bank-balance-item";
    bankItem.innerHTML = `
      <div class="bank-balance-name">${escapeHtml(bankName)}</div>
      <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
        ${balanceVisible ? `$${balance.toFixed(2)}` : '••••'}
      </div>
      <button class="balance-toggle" title="Toggle balance visibility">
        <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
      </button>
    `;
    bankBalancesContainer.appendChild(bankItem);
    
    bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
      toggleBalanceVisibility();
    });
  });
}

function toggleBalanceVisibility() {
  balanceVisible = !balanceVisible;
  updateBalanceDisplay();
  saveAppState();
}

function updateBalanceDisplay() {
  const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
  const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
  const balance = totalIncome - totalExpense;
  
  statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '••••';
  statBalance.classList.toggle('balance-hidden', !balanceVisible);
  
  balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
  
  updateBankBalances();
  buildTable(); // Refresh table to update balance display
}

function updateQuickStats() {
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const lastMonth = thisMonth === 0 ? 11 : thisMonth - 1;
  const lastMonthYear = thisMonth === 0 ? thisYear - 1 : thisYear;
  
  // Current month stats
  const monthlyIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const monthlyExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
  // Last month stats
  const lastMonthIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === lastMonth && txDate.getFullYear() === lastMonthYear && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const lastMonthExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === lastMonth && txDate.getFullYear() === lastMonthYear && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
  // Calculate trends
  const incomeTrendValue = lastMonthIncome > 0 ? ((monthlyIncome - lastMonthIncome) / lastMonthIncome * 100).toFixed(1) : 0;
  const expenseTrendValue = lastMonthExpenses > 0 ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1) : 0;
  
  incomeTrend.textContent = `${incomeTrendValue}%`;
  expenseTrend.textContent = `${expenseTrendValue}%`;
  
  // Total amount and average
  const totalAmount = allTransactions.reduce((sum, tx) => {
    const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
    return sum + amount;
  }, 0);
  
  const avgTransaction = allTransactions.length > 0 ? totalAmount / allTransactions.length : 0;
  
  // Counts
  const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
  const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
  const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
  const recurringCount = recurringTransactions.length;
  
  // Cash flow (last 30 days)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const recentIncome = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate >= thirtyDaysAgo && tx.TYPE === 'Income';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
  const recentExpenses = allTransactions
    .filter(tx => {
      try {
        const txDate = new Date(tx.DATE);
        return txDate >= thirtyDaysAgo && tx.TYPE === 'Expense';
      } catch (e) {
        return false;
      }
    })
    .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  
  const cashflow = recentIncome - recentExpenses;
  statCashflow.textContent = `$${cashflow.toFixed(2)}`;
  
  quickStatsContainer.innerHTML = `
    <div class="quick-stat" onclick="showIncomeDetails()">
      <i class="fa fa-arrow-up text-success"></i>
      <span>Monthly Income: <strong>$${monthlyIncome.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showExpenseDetails()">
      <i class="fa fa-arrow-down text-danger"></i>
      <span>Monthly Expenses: <strong>$${monthlyExpenses.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showTransactionStats()">
      <i class="fa fa-chart-line text-info"></i>
      <span>Avg Transaction: <strong>$${avgTransaction.toFixed(2)}</strong></span>
    </div>
    <div class="quick-stat" onclick="showTransactionStats()">
      <i class="fa fa-list text-primary"></i>
      <span>Counts: <strong>${incomeCount}/${expenseCount}/${transferCount}</strong></span>
    </div>
    <div class="quick-stat" onclick="showRecurringTransactions()">
      <i class="fa fa-redo text-warning"></i>
      <span>Recurring: <strong>${recurringCount}</strong></span>
    </div>
  `;
}

function renderMainChart() {
  if (mainChart) {
    mainChart.destroy();
  }
  
  const monthlyData = {};
  allTransactions.forEach(tx => {
    if (tx.DATE) {
      try {
        const date = new Date(tx.DATE);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        
        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = { income: 0, expense: 0 };
        }
        
        if (tx.TYPE === 'Income') {
          monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
        } else if (tx.TYPE === 'Expense') {
          monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
        }
      } catch (e) {
        // Skip invalid dates
      }
    }
  });
  
  const sortedMonths = Object.keys(monthlyData).sort();
  
  const incomeData = sortedMonths.map(month => monthlyData[month].income);
  const expenseData = sortedMonths.map(month => monthlyData[month].expense);
  
  const monthLabels = sortedMonths.map(month => {
    const [year, monthNum] = month.split('-');
    const date = new Date(year, monthNum - 1);
    return date.toLocaleString('default', { month: 'short', year: 'numeric' });
  });
  
  const ctx = transactionsChart.getContext('2d');
  mainChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [
        {
          label: 'Income',
          data: incomeData,
          backgroundColor: 'rgba(25, 135, 84, 0.7)',
          borderColor: 'rgba(25, 135, 84, 1)',
          borderWidth: 1
        },
        {
          label: 'Expenses',
          data: expenseData,
          backgroundColor: 'rgba(220, 53, 69, 0.7)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value;
            }
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Monthly Income vs Expenses'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': $' + context.raw.toFixed(2);
            }
          }
        }
      }
    }
  });
}

function applyFilters(){
  filteredTransactions = allTransactions.slice();
  const now = new Date();

  function inRange(dateStr, start, end){
    if (!dateStr) return false;
    try {
      const d = new Date(dateStr);
      return d >= start && d <= end;
    } catch (e) {
      return false;
    }
  }

  // Date filter
  if (dateFilter.value !== "all") {
    let start, end;
    switch (dateFilter.value) {
      case "today":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "week":
        const day = now.getDay();
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
        break;
      case "month":
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        break;
      case "year":
        start = new Date(now.getFullYear(), 0, 1);
        end = new Date(now.getFullYear() + 1, 0, 1);
        break;
      case "quarter":
        const quarter = Math.floor(now.getMonth() / 3);
        start = new Date(now.getFullYear(), quarter * 3, 1);
        end = new Date(now.getFullYear(), (quarter + 1) * 3, 1);
        break;
      case "last7":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "last30":
        start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
        end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        break;
      case "custom":
        if (startDateInput.value && endDateInput.value) {
          start = new Date(startDateInput.value);
          end = new Date(endDateInput.value);
          end.setDate(end.getDate() + 1);
        }
        break;
    }
    if (start && end) {
      filteredTransactions = filteredTransactions.filter(t => inRange(t.DATE, start, end));
    }
  }

  // Type filter
  if (typeFilter.value !== "all") {
    if (typeFilter.value === "recurring") {
      filteredTransactions = filteredTransactions.filter(t => t.RECURRING);
    } else {
      filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
    }
  }

  // Bank filter
  if (bankFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      (t.BANK_NAME || t.MODE || "") === bankFilter.value
    );
  }

  // Category filter
  if (categoryFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      t.ACCOUNT_HEADER === categoryFilter.value
    );
  }

  // Status filter
  if (statusFilter.value !== "all") {
    filteredTransactions = filteredTransactions.filter(t => 
      t.STATUS === statusFilter.value
    );
  }

  // Search filter
  if (searchDesc.value.trim()) {
    const term = searchDesc.value.trim().toLowerCase();
    filteredTransactions = filteredTransactions.filter(t => 
      (t.DESCRIPTION || "").toLowerCase().includes(term) ||
      (t.NOTES || "").toLowerCase().includes(term) ||
      (t.TAGS && t.TAGS.some(tag => tag.toLowerCase().includes(term))) ||
      (t.SINO || "").toLowerCase().includes(term)
    );
  }
  
  // Amount filters
  if (minAmount.value) {
    const min = parseFloat(minAmount.value);
    filteredTransactions = filteredTransactions.filter(t => {
      const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
      return amount >= min;
    });
  }
  
  if (maxAmount.value) {
    const max = parseFloat(maxAmount.value);
    filteredTransactions = filteredTransactions.filter(t => {
      const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
      return amount <= max;
    });
  }
  
  // Tag filter
  if (tagFilter.value.trim()) {
    const tags = tagFilter.value.split(',').map(tag => tag.trim().toLowerCase());
    filteredTransactions = filteredTransactions.filter(t => {
      if (!t.TAGS || !Array.isArray(t.TAGS)) return false;
      return tags.every(tag => 
        t.TAGS.some(t => t.toLowerCase().includes(tag))
      );
    });
  }
  
  // Sorting
  switch (sortBy.value) {
    case "date-asc":
      filteredTransactions.sort((a, b) => {
        try {
          return new Date(a.DATE) - new Date(b.DATE);
        } catch (e) {
          return 0;
        }
      });
      break;
    case "amount-desc":
      filteredTransactions.sort((a, b) => {
        const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
        const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
        return amountB - amountA;
      });
      break;
    case "amount-asc":
      filteredTransactions.sort((a, b) => {
        const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
        const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
        return amountA - amountB;
      });
      break;
    case "category":
      filteredTransactions.sort((a, b) => (a.ACCOUNT_HEADER || "").localeCompare(b.ACCOUNT_HEADER || ""));
      break;
    case "bank":
      filteredTransactions.sort((a, b) => (a.BANK_NAME || "").localeCompare(b.BANK_NAME || ""));
      break;
    default: // date-desc
      filteredTransactions.sort((a, b) => {
        try {
          return new Date(b.DATE) - new Date(a.DATE);
        } catch (e) {
          return 0;
        }
      });
      break;
  }
  
  // Grouping
  if (groupBy.value !== "none") {
    // Grouping will be handled in the table render function
  }

  currentPage = 1;
  gridCurrentPage = 1; // Reset grid pagination too
  
  // Refresh active view
  const activeTab = document.querySelector('#viewTabs .nav-link.active').getAttribute('href');
  if (activeTab === "#listView") {
    buildTable();
  } else if (activeTab === "#gridView") {
    renderGridView();
  } else if (activeTab === "#calendarView") {
    renderCalendarView();
  }
  
  updateStats();
  updateSelectedSummary();
  updateFilterSummary();
  saveAppState();
}



// Function to reset save button state
function resetSaveButton() {
  isSubmitting = false;
  saveTransactionBtn.disabled = false;
  saveTransactionBtn.innerHTML = 'Save Transaction';
}

// Function to open add transaction modal
function openAddModal(tx = null) {
  // Reset form
  form.reset();
  txIdInput.value = "";
  transactionModalLabel.textContent = tx ? "Edit Transaction" : "Add Transaction";
  
  // Set current date as default
  const today = new Date().toISOString().split('T')[0];
  formDATE.value = today;
  
  // Generate voucher number based on selected type
  const defaultVoucherType = formVOUCHERTYPE.value || "Payment";
  getNextVoucherNumber(defaultVoucherType).then(voucherNo => {
    formSINO.value = voucherNo;
  });
  
  // Set default currency from user preferences
  if (tx) {
    // Fill form with existing transaction data
    txIdInput.value = tx.id;
    formDATE.value = tx.DATE || today;
    formSINO.value = tx.SINO || "";
    formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
    formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
    formTYPE.value = tx.TYPE || "Expense";
    formBANKNAME.value = tx.BANK_NAME || tx.MODE || "";
    formINCOME.value = tx.INCOME || 0;
    formEXPENSE.value = tx.EXPENSE || 0;
    formBALANCE.value = tx.BALANCE || 0;
    formDESCRIPTION.value = tx.DESCRIPTION || "";
    formNOTES.value = tx.NOTES || "";
    formSTATUS.value = tx.STATUS || "completed";
    formCURRENCY.value = tx.CURRENCY || "USD";
    formTAGS.value = (tx.TAGS && Array.isArray(tx.TAGS)) ? tx.TAGS.join(", ") : "";
    formATTACH.value = tx.ATTACHMENT || "";
    
    if (tx.TIME) {
      includeTimeCheckbox.checked = true;
      formTIME.value = tx.TIME;
      formTIME.disabled = false;
    } else {
      includeTimeCheckbox.checked = false;
      formTIME.value = "";
      formTIME.disabled = true;
    }
    
    // Show/hide recurring options
    if (tx.RECURRING) {
      recurringOptions.style.display = "block";
      document.getElementById("formRECURRING_FREQ").value = tx.RECURRING.frequency || "monthly";
      document.getElementById("formRECURRING_INTERVAL").value = tx.RECURRING.interval || 1;
      document.getElementById("formRECURRING_ENDDATE").value = tx.RECURRING.endDate || "";
    } else {
      recurringOptions.style.display = "none";
    }
    
    // Update tags preview
    updateTagsPreview();
    
    // Show attachment if exists
    if (tx.ATTACHMENT) {
      attachmentInfo.textContent = "File attached";
      if (tx.ATTACHMENT.match(/\.(jpg|jpeg|png|gif)$/i)) {
        attachmentPreview.src = tx.ATTACHMENT;
        attachmentPreview.style.display = "block";
      }
    } else {
      attachmentInfo.textContent = "";
      attachmentPreview.style.display = "none";
    }
    
    // Update form fields based on type
    updateFormFields();
  } else {
    // Reset to defaults for new transaction
    includeTimeCheckbox.checked = false;
    formTIME.value = "";
    formTIME.disabled = true;
    recurringOptions.style.display = "none";
    attachmentInfo.textContent = "";
    attachmentPreview.style.display = "none";
    tagsPreview.innerHTML = "";
    
    // Set default values
    formTYPE.value = "Expense";
    formVOUCHERTYPE.value = "Payment";
    formSTATUS.value = "completed";
    formINCOME.value = "";
    formEXPENSE.value = "";
    formBALANCE.value = "";
    updateFormFields();
  }
  
  transactionModal.show();
}

// Function to update form fields based on transaction type
function updateFormFields() {
  const type = formTYPE.value;
  
  // Show/hide fields based on type
  if (type === "Income") {
    formEXPENSE.value = "";
    formEXPENSE.disabled = true;
    formINCOME.disabled = false;
  } else if (type === "Expense") {
    formINCOME.value = "";
    formINCOME.disabled = true;
    formEXPENSE.disabled = false;
  } else {
    // For Transfer or Adjustment
    formINCOME.disabled = false;
    formEXPENSE.disabled = false;
  }
}

// Function to update tags preview
function updateTagsPreview() {
  const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag);
  tagsPreview.innerHTML = "";
  
  tags.forEach(tag => {
    const tagElement = document.createElement("span");
    tagElement.className = "tag";
    tagElement.innerHTML = `
      ${tag}
      <button type="button" class="tag-remove" onclick="removeTag('${tag}')">
        <i class="fa fa-times"></i>
      </button>
    `;
    tagsPreview.appendChild(tagElement);
  });
}

// Function to remove tag from preview
function removeTag(tagToRemove) {
  const tags = formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag);
  const updatedTags = tags.filter(tag => tag !== tagToRemove);
  formTAGS.value = updatedTags.join(", ");
  updateTagsPreview();
}

// Function to build transactions table
function buildTable() {
  if (filteredTransactions.length === 0) {
    transactionsTableBody.innerHTML = `
      <tr><td colspan="13" class="text-center py-4 text-muted">
        <i class="fa fa-inbox fa-2x mb-2 d-block"></i>
        No transactions found
      </td></tr>
    `;
    paginationControls.innerHTML = "";
    return;
  }
  
  const startIdx = (currentPage - 1) * rowsPerPage;
  const endIdx = startIdx + rowsPerPage;
  const pageTransactions = filteredTransactions.slice(startIdx, endIdx);
  const searchTerm = searchDesc.value.trim().toLowerCase();
  
  // Clear table body
  transactionsTableBody.innerHTML = "";
  
  // Handle grouping if enabled
  let groupedTransactions = pageTransactions;
  let groupHeaders = [];
  
  if (groupBy.value !== "none") {
    const groups = {};
    
    pageTransactions.forEach(tx => {
      let groupKey;
      switch (groupBy.value) {
        case "date":
          groupKey = tx.DATE || "No Date";
          break;
        case "category":
          groupKey = tx.ACCOUNT_HEADER || "Uncategorized";
          break;
        case "bank":
          groupKey = tx.BANK_NAME || "No Bank";
          break;
        case "type":
          groupKey = tx.TYPE || "Unknown";
          break;
        default:
          groupKey = "Ungrouped";
      }
      
      if (!groups[groupKey]) groups[groupKey] = [];
      groups[groupKey].push(tx);
    });
    
    groupedTransactions = [];
    groupHeaders = Object.keys(groups);
    
    groupHeaders.forEach(header => {
      // Add group header row
      const groupRow = document.createElement("tr");
      groupRow.className = "group-header bg-light";
      groupRow.innerHTML = `
        <td colspan="13" class="fw-bold">
          <i class="fa fa-folder me-2"></i>
          ${header} (${groups[header].length} transactions)
        </td>
      `;
      transactionsTableBody.appendChild(groupRow);
      
      // Add transactions for this group
      groups[header].forEach(tx => {
        const row = createTransactionRow(tx, searchTerm);
        transactionsTableBody.appendChild(row);
      });
    });
  } else {
    // No grouping
    pageTransactions.forEach(tx => {
      const row = createTransactionRow(tx, searchTerm);
      transactionsTableBody.appendChild(row);
    });
  }
  
  // Update pagination
  updatePagination();
  
  // Update select all checkbox
  updateSelectAllCheckbox();
}

// Function to create a transaction row
function createTransactionRow(tx, searchTerm = "") {
  const row = document.createElement("tr");
  row.dataset.id = tx.id;
  
  // Check if transaction is selected
  const isSelected = selectedTransactions.has(tx.id);
  
  // Format date
  const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
  const time = tx.TIME || "";
  const dateTimeDisplay = time ? `${date} ${time}` : date;
  
  // Calculate amount and balance
  const income = parseFloat(tx.INCOME) || 0;
  const expense = parseFloat(tx.EXPENSE) || 0;
  const amount = income > 0 ? income : expense;
  const balance = parseFloat(tx.BALANCE) || 0;
  
  // Highlight search term in description and notes
  let description = escapeHtml(tx.DESCRIPTION || "");
  let notes = escapeHtml(tx.NOTES || "");
  
  if (searchTerm) {
    description = highlightText(description, searchTerm);
    notes = highlightText(notes, searchTerm);
  }
  
  // Create type badge
  let typeBadge = "";
  if (tx.RECURRING) {
    typeBadge = '<span class="badge-recurring me-1"><i class="fa fa-redo me-1"></i>Recurring</span>';
  }
  
  switch (tx.TYPE) {
    case "Income":
      typeBadge += '<span class="badge-income">Income</span>';
      break;
    case "Expense":
      typeBadge += '<span class="badge-expense">Expense</span>';
      break;
    case "Transfer":
      typeBadge += '<span class="badge-transfer">Transfer</span>';
      break;
    case "Adjustment":
      typeBadge += '<span class="badge-transfer">Adjustment</span>';
      break;
  }
  
  // Create tags display
  let tagsHtml = "";
  if (tx.TAGS && Array.isArray(tx.TAGS) && tx.TAGS.length > 0) {
    tagsHtml = tx.TAGS.map(tag => {
      const highlightedTag = searchTerm ? highlightText(tag, searchTerm) : tag;
      return `<span class="badge bg-secondary me-1">${highlightedTag}</span>`;
    }).join("");
  }
  
  // Create attachment button
  let attachmentHtml = "";
  if (tx.ATTACHMENT) {
    const fileExt = tx.ATTACHMENT.split('.').pop().toLowerCase();
    let fileIcon = "fa-file";
    if (fileExt.match(/^(jpg|jpeg|png|gif)$/)) fileIcon = "fa-file-image";
    else if (fileExt === "pdf") fileIcon = "fa-file-pdf";
    else if (fileExt.match(/^(doc|docx)$/)) fileIcon = "fa-file-word";
    else if (fileExt.match(/^(xls|xlsx)$/)) fileIcon = "fa-file-excel";
    
    attachmentHtml = `
      <button class="btn btn-sm btn-outline-info" onclick="viewAttachment('${tx.id}')" title="View attachment">
        <i class="fa ${fileIcon}"></i>
      </button>
    `;
  }
  
  // Format currency
  const currency = tx.CURRENCY || "USD";
  const currencySymbol = getCurrencySymbol(currency);
  
  // Create row HTML
  row.innerHTML = `
    <td>
      <input type="checkbox" class="transaction-checkbox" data-id="${tx.id}" ${isSelected ? "checked" : ""}>
      <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
    </td>
    <td>
      <div class="small">${dateTimeDisplay}</div>
      <div class="small text-muted">${tx.STATUS || "completed"}</div>
    </td>
    <td style="text-align:right;">
      <div class="fw-bold">${escapeHtml(tx.ACCOUNT_HEADER || "")}</div>
      <div class="small text-muted">${tx.VOUCHER_TYPE || ""}</div>
    </td>
    <td>
      <div class="fw-bold">${description}</div>
      <div class="small text-muted">${notes}</div>
    </td>
    <td>${typeBadge}</td>
    <td class="fw-bold">${escapeHtml(tx.SINO || "")}</td>
    <td>${escapeHtml(tx.BANK_NAME || tx.MODE || "")}</td>
    <td style="text-align:right; color: var(--success); font-weight:600;">
      ${income > 0 ? `${currencySymbol}${income.toFixed(2)}` : "-"}
    </td>
    <td style="text-align:right; color: var(--danger); font-weight:600;">
      ${expense > 0 ? `${currencySymbol}${expense.toFixed(2)}` : "-"}
    </td>
    <td style="text-align:right; font-weight:600;">
      ${balanceVisible ? `${currencySymbol}${balance.toFixed(2)}` : "••••"}
    </td>
    <td>${tagsHtml}</td>
    <td>${attachmentHtml}</td>
    <td>
      <div class="d-flex gap-1">
        <button class="action-btn btn-view" onclick="viewTransaction('${tx.id}')" title="View">
          <i class="fa fa-eye"></i>
        </button>
        <button class="action-btn btn-edit" onclick="editTransaction('${tx.id}')" title="Edit">
          <i class="fa fa-edit"></i>
        </button>
        <button class="action-btn btn-duplicate" onclick="duplicateTransaction('${tx.id}')" title="Duplicate">
          <i class="fa fa-copy"></i>
        </button>
        <button class="action-btn btn-del" onclick="deleteTransaction('${tx.id}')" title="Delete">
          <i class="fa fa-trash"></i>
        </button>
      </div>
    </td>
  `;
  
  // Add click event for checkbox
  const checkbox = row.querySelector('.transaction-checkbox');
  checkbox.addEventListener('change', (e) => {
    toggleTransactionSelection(tx.id, e.target.checked);
  });
  
  // Add hover effect
  row.addEventListener('mouseenter', () => {
    row.classList.add('hover');
  });
  
  row.addEventListener('mouseleave', () => {
    row.classList.remove('hover');
  });
  
  return row;
}

// Function to highlight search terms
function highlightText(text, searchTerm) {
  if (!searchTerm || !text) return escapeHtml(text);
  
  const escapedText = escapeHtml(text);
  const regex = new RegExp(`(${searchTerm})`, 'gi');
  return escapedText.replace(regex, '<span class="highlight">$1</span>');
}

// Function to get currency symbol
function getCurrencySymbol(currencyCode) {
  const symbols = {
    'USD': '$',
    'EUR': '€',
    'GBP': '£',
    'INR': '₹',
    'JPY': '¥',
    'CAD': 'C$',
    'AUD': 'A$'
  };
  return symbols[currencyCode] || '$';
}

// Function to update pagination
function updatePagination() {
  const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
  
  if (totalPages <= 1) {
    paginationControls.innerHTML = "";
    return;
  }
  
  let paginationHtml = `
    <nav aria-label="Transaction pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
  `;
  
  // Show first page, current page, and last page
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  for (let i = startPage; i <= endPage; i++) {
    paginationHtml += `
      <li class="page-item ${i === currentPage ? 'active' : ''}">
        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
      </li>
    `;
  }
  
  paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  `;
  
  paginationControls.innerHTML = paginationHtml;
}

// Function to change page
function changePage(page) {
  if (page < 1 || page > Math.ceil(filteredTransactions.length / rowsPerPage)) return;
  
  currentPage = page;
  buildTable();
  
  // Scroll to top of table
  transactionsTableBody.parentElement.scrollIntoView({ behavior: 'smooth' });
}

// Function to view transaction
function viewTransaction(id) {
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  openAddModal(tx);
}

// Function to edit transaction
function editTransaction(id) {
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  openAddModal(tx);
}

// Function to delete transaction
function deleteTransaction(id) {
  const tx = allTransactions.find(t => t.id === id);
  if (!tx) return;
  
  txToDelete = id;
  
  Swal.fire({
    title: 'Delete Transaction?',
    text: `Are you sure you want to delete this transaction: ${tx.DESCRIPTION || "Untitled"}?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Delete',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      confirmDeleteTransaction();
    }
  });
}

// Function to confirm delete transaction
async function confirmDeleteTransaction() {
  if (!txToDelete) return;
  
  try {
    loadingMessage.textContent = "Deleting transaction...";
    loadingModal.show();
    
    await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
    
    loadingModal.hide();
    showToast("Transaction deleted successfully", "success");
    
    // Remove from selected transactions if it was selected
    selectedTransactions.delete(txToDelete);
    updateBulkActions();
    
    await loadTransactions();
  } catch (err) {
    loadingModal.hide();
    console.error("deleteTransaction", err);
    showToast("Failed to delete transaction", "error");
  }
}

// Function to view attachment
function viewAttachment(id) {
  const tx = allTransactions.find(t => t.id === id);
  if (!tx || !tx.ATTACHMENT) return;
  
  const fileUrl = tx.ATTACHMENT;
  const fileExt = fileUrl.split('.').pop().toLowerCase();
  
  let content = "";
  
  if (fileExt.match(/^(jpg|jpeg|png|gif)$/)) {
    content = `<img src="${fileUrl}" class="img-fluid" alt="Attachment">`;
  } else if (fileExt === "pdf") {
    content = `<iframe src="${fileUrl}" width="100%" height="600px"></iframe>`;
  } else {
    content = `
      <div class="text-center">
        <i class="fa fa-file fa-4x mb-3"></i>
        <p>${fileUrl}</p>
        <a href="${fileUrl}" target="_blank" class="btn btn-primary mt-2">
          <i class="fa fa-download me-2"></i>Download File
        </a>
      </div>
    `;
  }
  
  attachmentModalBody.innerHTML = content;
  attachmentModal.show();
}

// Grid View Functions
let gridCurrentPage = 1;
const gridItemsPerPage = 12;

function renderGridView() {
  if (filteredTransactions.length === 0) {
    gridViewContainer.innerHTML = `
      <div class="col-12 text-center py-5">
        <i class="fa fa-inbox fa-3x mb-3 text-muted"></i>
        <h5>No transactions found</h5>
        <p class="text-muted">Try adjusting your filters or add a new transaction</p>
      </div>
    `;
    gridPaginationControls.innerHTML = "";
    return;
  }
  
  const startIdx = (gridCurrentPage - 1) * gridItemsPerPage;
  const endIdx = startIdx + gridItemsPerPage;
  const pageTransactions = filteredTransactions.slice(startIdx, endIdx);
  
  gridViewContainer.innerHTML = "";
  
  pageTransactions.forEach(tx => {
    const gridCard = createGridCard(tx);
    gridViewContainer.appendChild(gridCard);
  });
  
  updateGridPagination();
}

function createGridCard(tx) {
  const col = document.createElement("div");
  col.className = "col-md-4 col-lg-3 mb-3";
  
  const income = parseFloat(tx.INCOME) || 0;
  const expense = parseFloat(tx.EXPENSE) || 0;
  const amount = income > 0 ? income : expense;
  const currency = tx.CURRENCY || "USD";
  const currencySymbol = getCurrencySymbol(currency);
  
  let cardClass = "grid-card ";
  if (tx.RECURRING) {
    cardClass += "grid-card-recurring";
  } else {
    switch (tx.TYPE) {
      case "Income":
        cardClass += "grid-card-income";
        break;
      case "Expense":
        cardClass += "grid-card-expense";
        break;
      case "Transfer":
        cardClass += "grid-card-transfer";
        break;
    }
  }
  
  let typeBadge = "";
  switch (tx.TYPE) {
    case "Income":
      typeBadge = '<span class="badge-income grid-badge">Income</span>';
      break;
    case "Expense":
      typeBadge = '<span class="badge-expense grid-badge">Expense</span>';
      break;
    case "Transfer":
      typeBadge = '<span class="badge-transfer grid-badge">Transfer</span>';
      break;
  }
  
  if (tx.RECURRING) {
    typeBadge += '<span class="badge-recurring grid-badge ms-1"><i class="fa fa-redo"></i></span>';
  }
  
  const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
  const description = escapeHtml(tx.DESCRIPTION || "").substring(0, 50) + (tx.DESCRIPTION && tx.DESCRIPTION.length > 50 ? "..." : "");
  const notes = escapeHtml(tx.NOTES || "").substring(0, 30) + (tx.NOTES && tx.NOTES.length > 30 ? "..." : "");
  
  let tagsHtml = "";
  if (tx.TAGS && Array.isArray(tx.TAGS) && tx.TAGS.length > 0) {
    tagsHtml = tx.TAGS.slice(0, 3).map(tag => 
      `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(tag)}</span>`
    ).join("");
  }
  
  col.innerHTML = `
    <div class="${cardClass}" onclick="editTransaction('${tx.id}')" style="cursor: pointer;">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <div class="grid-date">${date}</div>
          <div class="small text-muted">${escapeHtml(tx.BANK_NAME || "")}</div>
        </div>
        <div class="text-end">
          ${typeBadge}
          <div class="grid-amount ${tx.TYPE === 'Income' ? 'income-color' : 'expense-color'}">
            ${tx.TYPE === 'Income' ? '+' : '-'}${currencySymbol}${amount.toFixed(2)}
          </div>
        </div>
      </div>
      
      <div class="mb-2">
        <div class="fw-bold mb-1">${description}</div>
        ${notes ? `<div class="small text-muted">${notes}</div>` : ''}
      </div>
      
      <div class="mb-2">
        <div class="small">
          <strong>Voucher:</strong> ${escapeHtml(tx.SINO || "")}
        </div>
        <div class="small">
          <strong>Account:</strong> ${escapeHtml(tx.ACCOUNT_HEADER || "")}
        </div>
      </div>
      
      ${tagsHtml ? `<div class="mb-2">${tagsHtml}</div>` : ''}
      
      <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
        <span class="badge bg-light text-dark">${tx.STATUS || "completed"}</span>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTransaction('${tx.id}')">
            <i class="fa fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="event.stopPropagation(); deleteTransaction('${tx.id}')">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  
  return col;
}

function updateGridPagination() {
  const totalPages = Math.ceil(filteredTransactions.length / gridItemsPerPage);
  
  if (totalPages <= 1) {
    gridPaginationControls.innerHTML = "";
    return;
  }
  
  let paginationHtml = `
    <nav aria-label="Grid pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item ${gridCurrentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeGridPage(${gridCurrentPage - 1})" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
  `;
  
  const maxVisiblePages = 5;
  let startPage = Math.max(1, gridCurrentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  for (let i = startPage; i <= endPage; i++) {
    paginationHtml += `
      <li class="page-item ${i === gridCurrentPage ? 'active' : ''}">
        <a class="page-link" href="#" onclick="changeGridPage(${i})">${i}</a>
      </li>
    `;
  }
  
  paginationHtml += `
        <li class="page-item ${gridCurrentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changeGridPage(${gridCurrentPage + 1})" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  `;
  
  gridPaginationControls.innerHTML = paginationHtml;
}

function changeGridPage(page) {
  if (page < 1 || page > Math.ceil(filteredTransactions.length / gridItemsPerPage)) return;
  
  gridCurrentPage = page;
  renderGridView();
  
  // Scroll to top of grid
  gridViewContainer.scrollIntoView({ behavior: 'smooth' });
}

// Calendar View Functions
function renderCalendarView() {
  const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];
  
  const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  
  // Get first day of month and number of days
  const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
  const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
  
  // Get transactions for this month
  const monthTransactions = filteredTransactions.filter(tx => {
    try {
      const txDate = new Date(tx.DATE);
      return txDate.getMonth() === currentCalendarMonth && 
             txDate.getFullYear() === currentCalendarYear;
    } catch (e) {
      return false;
    }
  });
  
  // Group transactions by day
  const transactionsByDay = {};
  monthTransactions.forEach(tx => {
    const txDate = new Date(tx.DATE);
    const day = txDate.getDate();
    
    if (!transactionsByDay[day]) {
      transactionsByDay[day] = [];
    }
    
    transactionsByDay[day].push(tx);
  });
  
  let calendarHtml = `
    <div class="calendar">
      <div class="calendar-header">
        <button class="calendar-nav-btn" onclick="prevMonth()">
          <i class="fa fa-chevron-left"></i>
        </button>
        <h4 class="mb-0">${monthNames[currentCalendarMonth]} ${currentCalendarYear}</h4>
        <button class="calendar-nav-btn" onclick="nextMonth()">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      
      <div class="calendar-grid">
  `;
  
  // Add day headers
  daysOfWeek.forEach(day => {
    calendarHtml += `<div class="calendar-day-header">${day}</div>`;
  });
  
  // Add empty cells for days before the first day of month
  for (let i = 0; i < startingDay; i++) {
    calendarHtml += `<div class="calendar-day empty"></div>`;
  }
  
  // Add days of month
  for (let day = 1; day <= daysInMonth; day++) {
    const dayTransactions = transactionsByDay[day] || [];
    const totalIncome = dayTransactions
      .filter(tx => tx.TYPE === 'Income')
      .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    
    const totalExpense = dayTransactions
      .filter(tx => tx.TYPE === 'Expense')
      .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    
    const netAmount = totalIncome - totalExpense;
    
    let transactionsHtml = "";
    dayTransactions.slice(0, 3).forEach(tx => {
      const amount = (parseFloat(tx.INCOME) || 0) - (parseFloat(tx.EXPENSE) || 0);
      const amountClass = amount >= 0 ? 'calendar-transaction-income' : 'calendar-transaction-expense';
      const sign = amount >= 0 ? '+' : '-';
      const absAmount = Math.abs(amount);
      const currency = tx.CURRENCY || "USD";
      const currencySymbol = getCurrencySymbol(currency);
      
      transactionsHtml += `
        <div class="calendar-transaction ${amountClass}" title="${escapeHtml(tx.DESCRIPTION || '')}">
          ${sign}${currencySymbol}${absAmount.toFixed(0)}
        </div>
      `;
    });
    
    if (dayTransactions.length > 3) {
      transactionsHtml += `<div class="calendar-transaction text-muted">+${dayTransactions.length - 3} more</div>`;
    }
    
    const today = new Date();
    const isToday = today.getDate() === day && 
                    today.getMonth() === currentCalendarMonth && 
                    today.getFullYear() === currentCalendarYear;
    
    calendarHtml += `
      <div class="calendar-day ${isToday ? 'bg-light' : ''}" onclick="showDayTransactions(${day})">
        <div class="calendar-day-number ${isToday ? 'text-primary fw-bold' : ''}">
          ${day}
          ${netAmount !== 0 ? `
            <span class="float-end small ${netAmount > 0 ? 'text-success' : 'text-danger'}">
              ${netAmount > 0 ? '+' : ''}${netAmount.toFixed(0)}
            </span>
          ` : ''}
        </div>
        <div class="calendar-day-transactions">
          ${transactionsHtml}
        </div>
      </div>
    `;
  }
  
  // Calculate total empty cells needed to complete the grid (multiple of 7)
  const totalCells = startingDay + daysInMonth;
  const emptyCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  
  for (let i = 0; i < emptyCells; i++) {
    calendarHtml += `<div class="calendar-day empty"></div>`;
  }
  
  calendarHtml += `
      </div>
    </div>
  `;
  
  calendarContainer.innerHTML = calendarHtml;
}

function prevMonth() {
  currentCalendarMonth--;
  if (currentCalendarMonth < 0) {
    currentCalendarMonth = 11;
    currentCalendarYear--;
  }
  renderCalendarView();
}

function nextMonth() {
  currentCalendarMonth++;
  if (currentCalendarMonth > 11) {
    currentCalendarMonth = 0;
    currentCalendarYear++;
  }
  renderCalendarView();
}

function showDayTransactions(day) {
  const date = new Date(currentCalendarYear, currentCalendarMonth, day);
  const dateStr = date.toISOString().split('T')[0];
  
  // Set date filter to this day
  dateFilter.value = "custom";
  startDateInput.value = dateStr;
  endDateInput.value = dateStr;
  customRangeControls.style.display = "flex";
  
  // Apply filters
  applyFilters();
  
  // Switch to list view
  document.querySelector('#viewTabs a[href="#listView"]').click();
}

// Theme Functions
function toggleTheme() {
  currentTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  // Update icon
  themeToggle.innerHTML = currentTheme === 'dark' ? 
    '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
  
  // Save to localStorage
  localStorage.setItem('theme', currentTheme);
}

function loadThemePreference() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  currentTheme = savedTheme;
  document.documentElement.setAttribute('data-theme', currentTheme);
  
  // Update icon
  themeToggle.innerHTML = currentTheme === 'dark' ? 
    '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
}

// Quick Add Functions
async function processQuickAdd() {
  const text = quickAddInput.value.trim();
  if (!text) {
    showToast("Please enter transaction details", "error");
    return;
  }
  
  loadingMessage.textContent = "Processing your request...";
  loadingModal.show();
  
  try {
    // Parse natural language
    const parsed = parseNaturalLanguage(text);
    
    if (!parsed) {
      loadingModal.hide();
      showToast("Could not understand your input. Please check the format examples.", "error");
      return;
    }
    
    // Create transaction from parsed data
    const txData = {
      DATE: parsed.date || new Date().toISOString().split('T')[0],
      SINO: await getNextVoucherNumber(parsed.voucherType || "Payment"),
      ACCOUNT_HEADER: parsed.category || "Uncategorized",
      BANK_NAME: parsed.bank || "",
      VOUCHER_TYPE: parsed.voucherType || "Payment",
      TYPE: parsed.type || "Expense",
      INCOME: parsed.type === "Income" ? parsed.amount : 0,
      EXPENSE: parsed.type === "Expense" ? parsed.amount : 0,
      DESCRIPTION: parsed.description || text.substring(0, 100),
      NOTES: `Quick add: ${text}`,
      TAGS: parsed.tags || [],
      STATUS: "completed",
      CURRENCY: formCURRENCY.value,
      createdAt: new Date(),
      updatedAt: new Date(),
      userId: currentUser.uid
    };
    
    // Calculate balance
    txData.BALANCE = getTransactionBalance(txData);
    
    // Save transaction
    await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
    
    loadingModal.hide();
    quickAddModal.hide();
    showToast("Transaction added successfully!", "success");
    
    // Reload transactions
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Quick add error:", error);
    showToast("Failed to add transaction", "error");
  }
}

function parseNaturalLanguage(text) {
  const lowerText = text.toLowerCase();
  
  // Initialize result
  const result = {
    amount: 0,
    type: "Expense",
    description: text
  };
  
  // Extract amount (look for numbers with currency symbols or words)
  const amountMatch = lowerText.match(/(\d+(\.\d{1,2})?)/);
  if (amountMatch) {
    result.amount = parseFloat(amountMatch[1]);
  }
  
  // Determine type based on keywords
  if (lowerText.includes("add") || lowerText.includes("receive") || 
      lowerText.includes("income") || lowerText.includes("deposit")) {
    result.type = "Income";
  } else if (lowerText.includes("spent") || lowerText.includes("pay") || 
             lowerText.includes("expense") || lowerText.includes("cost")) {
    result.type = "Expense";
  } else if (lowerText.includes("transfer")) {
    result.type = "Transfer";
  }
  
  // Extract bank names
  const banks = ["axis", "bom", "hdfc", "sbi", "icici", "cash"];
  for (const bank of banks) {
    if (lowerText.includes(bank)) {
      result.bank = bank.charAt(0).toUpperCase() + bank.slice(1);
      break;
    }
  }
  
  // Extract categories
  const categories = ["rent", "food", "fuel", "shopping", "entertainment", "travel"];
  for (const category of categories) {
    if (lowerText.includes(category)) {
      result.category = category.charAt(0).toUpperCase() + category.slice(1);
      break;
    }
  }
  
  // Extract date keywords
  const today = new Date();
  if (lowerText.includes("yesterday")) {
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    result.date = yesterday.toISOString().split('T')[0];
  } else if (lowerText.includes("tomorrow")) {
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    result.date = tomorrow.toISOString().split('T')[0];
  } else if (lowerText.includes("last friday") || lowerText.includes("last friday")) {
    // Simple date parsing - in real app you'd want more robust parsing
    result.date = today.toISOString().split('T')[0];
  }
  
  // Determine voucher type based on transaction type
  if (result.type === "Income") {
    result.voucherType = "Receipt";
  } else if (result.type === "Expense") {
    result.voucherType = "Payment";
  } else if (result.type === "Transfer") {
    result.voucherType = "Transfer";
  }
  
  return result;
}

// Selection and Bulk Actions
function toggleTransactionSelection(id, selected) {
  if (selected) {
    selectedTransactions.add(id);
  } else {
    selectedTransactions.delete(id);
  }
  
  updateBulkActions();
  updateSelectedSummary();
  updateSelectAllCheckbox();
  
  // Update row appearance
  const row = document.querySelector(`tr[data-id="${id}"]`);
  if (row) {
    if (selected) {
      row.classList.add('selected');
    } else {
      row.classList.remove('selected');
    }
  }
}

function selectAllTransactions() {
  const startIdx = (currentPage - 1) * rowsPerPage;
  const endIdx = startIdx + rowsPerPage;
  const pageTransactions = filteredTransactions.slice(startIdx, endIdx);
  
  pageTransactions.forEach(tx => {
    selectedTransactions.add(tx.id);
  });
  
  updateBulkActions();
  updateSelectedSummary();
  updateSelectAllCheckbox();
  buildTable();
}

function deselectAllTransactions() {
  selectedTransactions.clear();
  updateBulkActions();
  updateSelectedSummary();
  updateSelectAllCheckbox();
  buildTable();
}

function toggleSelectAll() {
  if (selectAllCheckbox.checked) {
    selectAllTransactions();
  } else {
    deselectAllTransactions();
  }
}

function updateSelectAllCheckbox() {
  const startIdx = (currentPage - 1) * rowsPerPage;
  const endIdx = startIdx + rowsPerPage;
  const pageTransactions = filteredTransactions.slice(startIdx, endIdx);
  
  if (pageTransactions.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.disabled = true;
    return;
  }
  
  selectAllCheckbox.disabled = false;
  
  const allSelected = pageTransactions.every(tx => selectedTransactions.has(tx.id));
  selectAllCheckbox.checked = allSelected;
}

function updateBulkActions() {
  const count = selectedTransactions.size;
  
  if (count > 0) {
    bulkActions.classList.remove('hidden');
    selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
    
    // Update button states
    bulkDeleteBtn.disabled = false;
    bulkEditBtn.disabled = false;
    bulkTagBtn.disabled = false;
    bulkCategoryBtn.disabled = false;
  } else {
    bulkActions.classList.add('hidden');
  }
}

function clearSelection() {
  selectedTransactions.clear();
  updateBulkActions();
  updateSelectedSummary();
  updateSelectAllCheckbox();
  buildTable();
}

function confirmBulkDelete() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkDeleteCount.textContent = count;
  confirmBulkDeleteModal.show();
}

async function processBulkDelete() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  loadingMessage.textContent = `Deleting ${count} transactions...`;
  loadingModal.show();
  confirmBulkDeleteModal.hide();
  
  try {
    const batch = writeBatch(db);
    
    for (const id of selectedTransactions) {
      const txRef = doc(db, "users", currentUser.uid, "transactions", id);
      batch.delete(txRef);
    }
    
    await batch.commit();
    
    // Clear selection
    selectedTransactions.clear();
    
    loadingModal.hide();
    showToast(`${count} transactions deleted successfully`, "success");
    
    // Reload transactions
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Bulk delete error:", error);
    showToast("Failed to delete transactions", "error");
  }
}

function openBulkEditModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkEditCount.textContent = count;
  bulkEditValue.value = "";
  bulkEditModal.show();
}

async function processBulkEdit() {
  const field = bulkEditField.value;
  const value = bulkEditValue.value.trim();
  
  if (!value) {
    showToast("Please enter a value", "error");
    return;
  }
  
  const count = selectedTransactions.size;
  loadingMessage.textContent = `Updating ${count} transactions...`;
  loadingModal.show();
  bulkEditModal.hide();
  
  try {
    const batch = writeBatch(db);
    const fieldMap = {
      'BANK_NAME': 'BANK_NAME',
      'ACCOUNT_HEADER': 'ACCOUNT_HEADER',
      'TYPE': 'TYPE',
      'VOUCHER_TYPE': 'VOUCHER_TYPE',
      'STATUS': 'STATUS'
    };
    
    const fieldName = fieldMap[field];
    
    for (const id of selectedTransactions) {
      const txRef = doc(db, "users", currentUser.uid, "transactions", id);
      batch.update(txRef, { 
        [fieldName]: value,
        updatedAt: new Date()
      });
    }
    
    await batch.commit();
    
    loadingModal.hide();
    showToast(`${count} transactions updated successfully`, "success");
    
    // Reload transactions
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Bulk edit error:", error);
    showToast("Failed to update transactions", "error");
  }
}

function openBulkTagModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  bulkTagCount.textContent = count;
  bulkTagsInput.value = "";
  bulkTagModal.show();
}

async function processBulkTags() {
  const tagsInput = bulkTagsInput.value.trim();
  if (!tagsInput) {
    showToast("Please enter at least one tag", "error");
    return;
  }
  
  const newTags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
  if (newTags.length === 0) {
    showToast("Please enter valid tags", "error");
    return;
  }
  
  const count = selectedTransactions.size;
  loadingMessage.textContent = `Adding tags to ${count} transactions...`;
  loadingModal.show();
  bulkTagModal.hide();
  
  try {
    // Get current transactions to preserve existing tags
    const transactionsToUpdate = allTransactions.filter(tx => selectedTransactions.has(tx.id));
    
    const batch = writeBatch(db);
    
    for (const tx of transactionsToUpdate) {
      const existingTags = tx.TAGS || [];
      const updatedTags = [...new Set([...existingTags, ...newTags])];
      
      const txRef = doc(db, "users", currentUser.uid, "transactions", tx.id);
      batch.update(txRef, { 
        TAGS: updatedTags,
        updatedAt: new Date()
      });
    }
    
    await batch.commit();
    
    // Update tags collection
    await updateTagsCollection(newTags);
    
    loadingModal.hide();
    showToast(`Tags added to ${count} transactions`, "success");
    
    // Reload transactions
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Bulk tag error:", error);
    showToast("Failed to add tags", "error");
  }
}

function openBulkCategoryModal() {
  const count = selectedTransactions.size;
  if (count === 0) return;
  
  Swal.fire({
    title: 'Change Category',
    input: 'select',
    inputOptions: coaAccounts.reduce((obj, account) => {
      obj[account] = account;
      return obj;
    }, {}),
    inputPlaceholder: 'Select category',
    showCancelButton: true,
    confirmButtonText: 'Update',
    cancelButtonText: 'Cancel',
    preConfirm: (category) => {
      if (!category) {
        Swal.showValidationMessage('Please select a category');
      }
      return category;
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      loadingMessage.textContent = `Updating category for ${count} transactions...`;
      loadingModal.show();
      
      try {
        const batch = writeBatch(db);
        
        for (const id of selectedTransactions) {
          const txRef = doc(db, "users", currentUser.uid, "transactions", id);
          batch.update(txRef, { 
            ACCOUNT_HEADER: result.value,
            updatedAt: new Date()
          });
        }
        
        await batch.commit();
        
        loadingModal.hide();
        showToast(`Category updated for ${count} transactions`, "success");
        
        // Reload transactions
        await loadTransactions();
      } catch (error) {
        loadingModal.hide();
        console.error("Bulk category error:", error);
        showToast("Failed to update category", "error");
      }
    }
  });
}

// Split Income Functions
function openSplitIncomeModal() {
  splitIncomeModal.show();
  splitExpensesContainer.innerHTML = "";
  splitSummary.innerHTML = "";
  splitIncomeAmount.value = "";
  splitIncomeDescription.value = "";
  splitIncomeBank.value = "";
  
  // Add first expense
  addSplitExpense();
}

function addSplitExpense() {
  const expenseId = Date.now() + Math.random();
  const expenseItem = document.createElement("div");
  expenseItem.className = "split-transaction-item";
  expenseItem.id = `split-expense-${expenseId}`;
  
  expenseItem.innerHTML = `
    <div class="split-header">
      <h6 class="mb-0">Expense #${document.querySelectorAll('.split-transaction-item').length + 1}</h6>
      <button type="button" class="remove-split" onclick="removeSplitExpense(${expenseId})">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Description *</label>
        <input type="text" class="form-control split-expense-desc" placeholder="Expense description" required />
      </div>
      <div class="col-md-4">
        <label class="form-label">Amount *</label>
        <input type="number" class="form-control split-expense-amount" placeholder="0.00" step="0.01" required />
      </div>
      <div class="col-md-2">
        <label class="form-label">Bank</label>
        <select class="form-select split-expense-bank">
          <option value="">Select Bank</option>
          ${coaBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-6">
        <label class="form-label">Category</label>
        <select class="form-select split-expense-category">
          <option value="">Select Category</option>
          ${coaAccounts.map(account => `<option value="${account}">${account}</option>`).join('')}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Date</label>
        <input type="date" class="form-control split-expense-date" value="${new Date().toISOString().split('T')[0]}" />
      </div>
    </div>
  `;
  
  splitExpensesContainer.appendChild(expenseItem);
  
  // Update summary
  updateSplitSummary();
}

function removeSplitExpense(id) {
  const expenseItem = document.getElementById(`split-expense-${id}`);
  if (expenseItem) {
    expenseItem.remove();
    updateSplitSummary();
    
    // Renumber remaining expenses
    const expenses = document.querySelectorAll('.split-transaction-item');
    expenses.forEach((expense, index) => {
      const header = expense.querySelector('h6');
      if (header) {
        header.textContent = `Expense #${index + 1}`;
      }
    });
  }
}

function updateSplitSummary() {
  const totalIncome = parseFloat(splitIncomeAmount.value) || 0;
  const expenses = document.querySelectorAll('.split-transaction-item');
  
  let totalExpenses = 0;
  expenses.forEach(expense => {
    const amountInput = expense.querySelector('.split-expense-amount');
    const amount = parseFloat(amountInput?.value) || 0;
    totalExpenses += amount;
  });
  
  const remaining = totalIncome - totalExpenses;
  
  let summaryHtml = `
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Total Income:</strong> $${totalIncome.toFixed(2)}
      </div>
      <div>
        <strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)}
      </div>
      <div class="${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">
        <strong>Remaining:</strong> $${remaining.toFixed(2)}
      </div>
    </div>
  `;
  
  if (remaining < 0) {
    summaryHtml += `
      <div class="alert alert-danger mt-2 mb-0">
        <i class="fa fa-exclamation-triangle me-2"></i>
        Total expenses exceed income by $${Math.abs(remaining).toFixed(2)}
      </div>
    `;
  } else if (remaining > 0) {
    summaryHtml += `
      <div class="alert alert-warning mt-2 mb-0">
        <i class="fa fa-info-circle me-2"></i>
        $${remaining.toFixed(2)} of income is not allocated
      </div>
    `;
  } else {
    summaryHtml += `
      <div class="alert alert-success mt-2 mb-0">
        <i class="fa fa-check-circle me-2"></i>
        Income fully allocated
      </div>
    `;
  }
  
  splitSummary.innerHTML = summaryHtml;
}

// Add event listeners for split income form
addSplitExpenseBtn.addEventListener("click", addSplitExpense);
splitIncomeAmount.addEventListener("input", updateSplitSummary);

// Listen for changes in expense amounts
document.addEventListener("input", (e) => {
  if (e.target.classList.contains('split-expense-amount')) {
    updateSplitSummary();
  }
});

saveSplitTransactionsBtn.addEventListener("click", async () => {
  const totalIncome = parseFloat(splitIncomeAmount.value) || 0;
  const incomeDescription = splitIncomeDescription.value.trim();
  const incomeBank = splitIncomeBank.value;
  
  if (!totalIncome) {
    showToast("Please enter income amount", "error");
    return;
  }
  
  if (!incomeDescription) {
    showToast("Please enter income description", "error");
    return;
  }
  
  if (!incomeBank) {
    showToast("Please select income bank account", "error");
    return;
  }
  
  const expenses = document.querySelectorAll('.split-transaction-item');
  if (expenses.length === 0) {
    showToast("Please add at least one expense", "error");
    return;
  }
  
  let totalExpenses = 0;
  const expenseData = [];
  
  // Validate expenses
  for (const expense of expenses) {
    const description = expense.querySelector('.split-expense-desc').value.trim();
    const amount = parseFloat(expense.querySelector('.split-expense-amount').value) || 0;
    const bank = expense.querySelector('.split-expense-bank').value;
    const category = expense.querySelector('.split-expense-category').value;
    const date = expense.querySelector('.split-expense-date').value;
    
    if (!description) {
      showToast("Please enter description for all expenses", "error");
      return;
    }
    
    if (!amount) {
      showToast("Please enter amount for all expenses", "error");
      return;
    }
    
    totalExpenses += amount;
    expenseData.push({ description, amount, bank, category, date });
  }
  
  if (totalExpenses > totalIncome) {
    showToast("Total expenses cannot exceed income amount", "error");
    return;
  }
  
  loadingMessage.textContent = "Saving split transactions...";
  loadingModal.show();
  
  try {
    const today = new Date().toISOString().split('T')[0];
    
    // 1. Save income transaction
    const incomeTxData = {
      DATE: today,
      SINO: await getNextVoucherNumber("Receipt"),
      ACCOUNT_HEADER: "Income",
      BANK_NAME: incomeBank,
      VOUCHER_TYPE: "Receipt",
      TYPE: "Income",
      INCOME: totalIncome,
      EXPENSE: 0,
      DESCRIPTION: incomeDescription,
      NOTES: `Split income into ${expenses.length} expense${expenses.length !== 1 ? 's' : ''}`,
      TAGS: ["split-income"],
      STATUS: "completed",
      CURRENCY: formCURRENCY.value,
      createdAt: new Date(),
      updatedAt: new Date(),
      userId: currentUser.uid
    };
    
    incomeTxData.BALANCE = getTransactionBalance(incomeTxData);
    
    await addDoc(collection(db, "users", currentUser.uid, "transactions"), incomeTxData);
    
    // 2. Save expense transactions
    for (const expense of expenseData) {
      const expenseTxData = {
        DATE: expense.date || today,
        SINO: await getNextVoucherNumber("Payment"),
        ACCOUNT_HEADER: expense.category || "Uncategorized",
        BANK_NAME: expense.bank || "",
        VOUCHER_TYPE: "Payment",
        TYPE: "Expense",
        INCOME: 0,
        EXPENSE: expense.amount,
        DESCRIPTION: expense.description,
        NOTES: `Part of split income: ${incomeDescription}`,
        TAGS: ["split-expense"],
        STATUS: "completed",
        CURRENCY: formCURRENCY.value,
        createdAt: new Date(),
        updatedAt: new Date(),
        userId: currentUser.uid
      };
      
      expenseTxData.BALANCE = getTransactionBalance(expenseTxData);
      
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), expenseTxData);
    }
    
    loadingModal.hide();
    splitIncomeModal.hide();
    showToast(`${expenses.length + 1} transactions saved successfully`, "success");
    
    // Reload transactions
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Split income error:", error);
    showToast("Failed to save split transactions", "error");
  }
});

// Recurring Transactions
function toggleRecurringOptions() {
  const isVisible = recurringOptions.style.display === "block";
  recurringOptions.style.display = isVisible ? "none" : "block";
  
  makeRecurringBtn.innerHTML = isVisible ? 
    '<i class="fa fa-redo me-1"></i> Make Recurring' :
    '<i class="fa fa-times me-1"></i> Cancel Recurring';
}

function calculateNextRecurringDate(startDate, recurringConfig) {
  const start = new Date(startDate);
  const { frequency, interval } = recurringConfig;
  
  const nextDate = new Date(start);
  
  switch (frequency) {
    case "daily":
      nextDate.setDate(start.getDate() + interval);
      break;
    case "weekly":
      nextDate.setDate(start.getDate() + (7 * interval));
      break;
    case "monthly":
      nextDate.setMonth(start.getMonth() + interval);
      break;
    case "quarterly":
      nextDate.setMonth(start.getMonth() + (3 * interval));
      break;
    case "yearly":
      nextDate.setFullYear(start.getFullYear() + interval);
      break;
  }
  
  return nextDate.toISOString().split('T')[0];
}

async function processRecurringTransactions() {
  const today = new Date().toISOString().split('T')[0];
  
  for (const recurringTx of recurringTransactions) {
    const nextDate = recurringTx.RECURRING.nextDate;
    const endDate = recurringTx.RECURRING.endDate;
    
    // Check if transaction is due
    if (nextDate <= today && (!endDate || nextDate <= endDate)) {
      // Create new transaction
      const newTxData = { ...recurringTx };
      delete newTxData.id;
      delete newTxData.RECURRING.nextDate;
      
      newTxData.DATE = nextDate;
      newTxData.SINO = await getNextVoucherNumber(newTxData.VOUCHER_TYPE);
      newTxData.createdAt = new Date();
      newTxData.updatedAt = new Date();
      
      // Save new transaction
      await addDoc(collection(db, "users", currentUser.uid, "transactions"), newTxData);
      
      // Update next date in recurring transaction
      const txRef = doc(db, "users", currentUser.uid, "transactions", recurringTx.id);
      await updateDoc(txRef, {
        'RECURRING.nextDate': calculateNextRecurringDate(nextDate, recurringTx.RECURRING)
      });
    }
  }
}

// Sidebar Functions
function toggleSidebar() {
  sidebar.classList.toggle('collapsed');
  mainContent.classList.toggle('expanded');
  
  const icon = sidebarToggle.querySelector('i');
  if (sidebar.classList.contains('collapsed')) {
    icon.className = 'fa fa-chevron-right';
  } else {
    icon.className = 'fa fa-chevron-left';
  }
  
  // Save state
  localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

function toggleMobileMenu() {
  sidebar.classList.toggle('show');
}

// Load sidebar state
function loadSidebarState() {
  const collapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if (collapsed) {
    sidebar.classList.add('collapsed');
    mainContent.classList.add('expanded');
    sidebarToggle.querySelector('i').className = 'fa fa-chevron-right';
  }
}

// AI Assistant Functions
function toggleAIPanel() {
  aiPanel.classList.toggle('show');
}

function sendAIMessage() {
  const message = aiInput.value.trim();
  if (!message) return;
  
  // Add user message
  addAIMessage(message, 'user');
  aiInput.value = '';
  
  // Simulate AI response (in a real app, you would call an AI API)
  setTimeout(() => {
    const response = generateAIResponse(message);
    addAIMessage(response, 'bot');
  }, 1000);
}

function addAIMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `ai-message ${sender}`;
  messageDiv.textContent = text;
  
  aiChat.appendChild(messageDiv);
  aiChat.scrollTop = aiChat.scrollHeight;
}

function generateAIResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('balance') || lowerMessage.includes('total')) {
    const balance = calculateTotalBalance();
    return `Your current total balance is $${balance.toFixed(2)}.`;
  }
  
  if (lowerMessage.includes('income') || lowerMessage.includes('revenue')) {
    const totalIncome = allTransactions
      .filter(tx => tx.TYPE === 'Income')
      .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
    return `Your total income is $${totalIncome.toFixed(2)}.`;
  }
  
  if (lowerMessage.includes('expense') || lowerMessage.includes('spending')) {
    const totalExpense = allTransactions
      .filter(tx => tx.TYPE === 'Expense')
      .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
    return `Your total expenses are $${totalExpense.toFixed(2)}.`;
  }
  
  if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
    return `I can help you with:
• Check your balance and financial stats
• Analyze your income and expenses
• Find transactions by description
• Give financial tips
• Help categorize transactions
• Calculate totals for specific periods`;
  }
  
  if (lowerMessage.includes('transaction') && lowerMessage.includes('find')) {
    // Try to find transactions
    const searchTerm = message.toLowerCase().replace(/find|transaction|search/g, '').trim();
    if (searchTerm) {
      const matching = allTransactions.filter(tx => 
        (tx.DESCRIPTION && tx.DESCRIPTION.toLowerCase().includes(searchTerm)) ||
        (tx.NOTES && tx.NOTES.toLowerCase().includes(searchTerm))
      ).slice(0, 5);
      
      if (matching.length > 0) {
        return `Found ${matching.length} transaction${matching.length !== 1 ? 's' : ''}:
${matching.map(tx => `• ${tx.DATE}: ${tx.DESCRIPTION} - $${(parseFloat(tx.INCOME) || parseFloat(tx.EXPENSE) || 0).toFixed(2)}`).join('\n')}`;
      }
    }
  }
  
  // Default response
  const tips = [
    "Consider setting up a budget for your main spending categories.",
    "Review your recurring transactions regularly to cancel unused subscriptions.",
    "Try to save at least 20% of your income each month.",
    "Use tags to better categorize and track your expenses.",
    "Set up reminders for bill payments to avoid late fees.",
    "Consider automating your savings with recurring transfers."
  ];
  
  return `I understand you said: "${message}". Here's a financial tip: ${tips[Math.floor(Math.random() * tips.length)]}`;
}

// Tags Functions
async function updateTagsCollection(tags) {
  try {
    for (const tag of tags) {
      if (!allTags.has(tag)) {
        allTags.add(tag);
        
        // Add to Firestore
        await setDoc(doc(db, "users", currentUser.uid, "tags", tag.toLowerCase().replace(/\s+/g, '-')), {
          name: tag,
          count: 1,
          createdAt: new Date(),
          updatedAt: new Date()
        });
      } else {
        // Update count
        const tagRef = doc(db, "users", currentUser.uid, "tags", tag.toLowerCase().replace(/\s+/g, '-'));
        const tagSnap = await getDoc(tagRef);
        
        if (tagSnap.exists()) {
          await updateDoc(tagRef, {
            count: (tagSnap.data().count || 0) + 1,
            updatedAt: new Date()
          });
        }
      }
    }
  } catch (error) {
    console.warn("Error updating tags collection:", error);
  }
}

async function loadTagManager() {
  // Load tags for tag manager
  const tagsRef = collection(db, "users", currentUser.uid, "tags");
  const tagsSnap = await getDocs(tagsRef);
  
  const tagList = document.getElementById('tagList');
  const tagStats = document.getElementById('tagStats');
  
  tagList.innerHTML = '';
  tagStats.innerHTML = '';
  
  const tags = [];
  tagsSnap.forEach(doc => {
    tags.push(doc.data());
  });
  
  // Sort by count
  tags.sort((a, b) => b.count - a.count);
  
  // Display tags
  tags.forEach(tag => {
    const tagElement = document.createElement('div');
    tagElement.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded';
    tagElement.innerHTML = `
      <span>
        <span class="badge bg-primary me-2">${tag.count}</span>
        ${tag.name}
      </span>
      <div>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteTag('${tag.name}')">
          <i class="fa fa-trash"></i>
        </button>
      </div>
    `;
    tagList.appendChild(tagElement);
  });
  
  // Display statistics
  const totalTaggedTransactions = allTransactions.filter(tx => tx.TAGS && tx.TAGS.length > 0).length;
  const totalTransactions = allTransactions.length;
  const tagUsagePercent = totalTransactions > 0 ? ((totalTaggedTransactions / totalTransactions) * 100).toFixed(1) : 0;
  
  tagStats.innerHTML = `
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Tag Statistics</h6>
        <div class="mb-2">
          <div class="small">Total Tags: <strong>${tags.length}</strong></div>
          <div class="small">Tagged Transactions: <strong>${totalTaggedTransactions}/${totalTransactions}</strong></div>
          <div class="small">Tag Usage: <strong>${tagUsagePercent}%</strong></div>
        </div>
        <div class="progress mb-2" style="height: 10px;">
          <div class="progress-bar bg-success" style="width: ${tagUsagePercent}%"></div>
        </div>
        <div class="small text-muted">
          Tags help you organize and filter transactions more effectively.
        </div>
      </div>
    </div>
  `;
}

async function addNewTag() {
  const newTagInput = document.getElementById('newTagInput');
  const tagName = newTagInput.value.trim();
  
  if (!tagName) {
    showToast("Please enter a tag name", "error");
    return;
  }
  
  if (allTags.has(tagName)) {
    showToast("Tag already exists", "warning");
    return;
  }
  
  try {
    await updateTagsCollection([tagName]);
    newTagInput.value = "";
    showToast("Tag added successfully", "success");
    await loadTagManager();
  } catch (error) {
    showToast("Failed to add tag", "error");
  }
}

async function deleteTag(tagName) {
  const result = await Swal.fire({
    title: 'Delete Tag?',
    text: `Are you sure you want to delete the tag "${tagName}"? This will remove it from all transactions.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Delete',
    cancelButtonText: 'Cancel'
  });
  
  if (result.isConfirmed) {
    try {
      // Remove from tags collection
      const tagRef = doc(db, "users", currentUser.uid, "tags", tagName.toLowerCase().replace(/\s+/g, '-'));
      await deleteDoc(tagRef);
      
      // Remove from all transactions
      const batch = writeBatch(db);
      const transactionsWithTag = allTransactions.filter(tx => tx.TAGS && tx.TAGS.includes(tagName));
      
      for (const tx of transactionsWithTag) {
        const updatedTags = tx.TAGS.filter(t => t !== tagName);
        const txRef = doc(db, "users", currentUser.uid, "transactions", tx.id);
        batch.update(txRef, { TAGS: updatedTags });
      }
      
      await batch.commit();
      
      // Update local state
      allTags.delete(tagName);
      
      showToast("Tag deleted successfully", "success");
      await loadTransactions();
      await loadTagManager();
    } catch (error) {
      console.error("Delete tag error:", error);
      showToast("Failed to delete tag", "error");
    }
  }
}

// Duplicate transaction function
async function duplicateTransaction(id = null) {
  let txToDuplicate;
  
  if (id) {
    // Duplicate specific transaction
    txToDuplicate = allTransactions.find(t => t.id === id);
  } else {
    // Duplicate current form transaction
    if (!formSINO.value) {
      showToast("Please save the transaction first", "warning");
      return;
    }
    
    txToDuplicate = {
      DATE: formDATE.value,
      ACCOUNT_HEADER: formACCOUNTHEADER.value,
      BANK_NAME: formBANKNAME.value,
      VOUCHER_TYPE: formVOUCHERTYPE.value,
      TYPE: formTYPE.value,
      INCOME: parseFloat(formINCOME.value) || 0,
      EXPENSE: parseFloat(formEXPENSE.value) || 0,
      DESCRIPTION: formDESCRIPTION.value,
      NOTES: formNOTES.value,
      TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
      STATUS: formSTATUS.value,
      ATTACHMENT: formATTACH.value,
      CURRENCY: formCURRENCY.value
    };
  }
  
  if (!txToDuplicate) return;
  
  try {
    // Generate new voucher number
    const newSINO = await getNextVoucherNumber(txToDuplicate.VOUCHER_TYPE || "Payment");
    
    const duplicatedTx = {
      ...txToDuplicate,
      SINO: newSINO,
      DATE: new Date().toISOString().split('T')[0], // Today's date for duplicate
      DESCRIPTION: `${txToDuplicate.DESCRIPTION} (Copy)`,
      createdAt: new Date(),
      updatedAt: new Date(),
      userId: currentUser.uid
    };
    
    // Calculate balance
    duplicatedTx.BALANCE = getTransactionBalance(duplicatedTx);
    
    loadingMessage.textContent = "Duplicating transaction...";
    loadingModal.show();
    
    await addDoc(collection(db, "users", currentUser.uid, "transactions"), duplicatedTx);
    
    loadingModal.hide();
    
    if (id) {
      showToast("Transaction duplicated successfully", "success");
      transactionModal.hide();
    } else {
      // If duplicating from form, show success and keep modal open
      showToast("Transaction duplicated. You can now edit the duplicate.", "success");
      // Reset form with duplicated data
      formSINO.value = await getNextVoucherNumber(formVOUCHERTYPE.value);
      formDESCRIPTION.value = `${formDESCRIPTION.value} (Copy)`;
    }
    
    await loadTransactions();
  } catch (error) {
    loadingModal.hide();
    console.error("Duplicate error:", error);
    showToast("Failed to duplicate transaction", "error");
  }
}

// Update selected summary
function updateSelectedSummary() {
  const count = selectedTransactions.size;
  
  if (count === 0) {
    selectedSummary.innerHTML = "No transactions selected";
    return;
  }
  
  let totalIncome = 0;
  let totalExpense = 0;
  
  for (const id of selectedTransactions) {
    const tx = allTransactions.find(t => t.id === id);
    if (tx) {
      totalIncome += parseFloat(tx.INCOME) || 0;
      totalExpense += parseFloat(tx.EXPENSE) || 0;
    }
  }
  
  const net = totalIncome - totalExpense;
  
  selectedSummary.innerHTML = `
    <div class="row">
      <div class="col-6">
        <div class="small">Count: <strong>${count}</strong></div>
        <div class="small text-success">Income: <strong>$${totalIncome.toFixed(2)}</strong></div>
      </div>
      <div class="col-6">
        <div class="small text-danger">Expense: <strong>$${totalExpense.toFixed(2)}</strong></div>
        <div class="small ${net >= 0 ? 'text-success' : 'text-danger'}">
          Net: <strong>$${net.toFixed(2)}</strong>
        </div>
      </div>
    </div>
  `;
}

// Update filter summary
function updateFilterSummary() {
  const total = filteredTransactions.length;
  const totalAll = allTransactions.length;
  const percent = totalAll > 0 ? ((total / totalAll) * 100).toFixed(1) : 0;
  
  // Calculate totals for filtered transactions
  const totalIncome = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
  const totalExpense = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  const net = totalIncome - totalExpense;
  
  filterSummary.innerHTML = `
    <div class="row">
      <div class="col-md-4">
        <div class="small">Showing: <strong>${total}</strong> of ${totalAll} (${percent}%)</div>
      </div>
      <div class="col-md-4">
        <div class="small text-success">Income: <strong>$${totalIncome.toFixed(2)}</strong></div>
        <div class="small text-danger">Expense: <strong>$${totalExpense.toFixed(2)}</strong></div>
      </div>
      <div class="col-md-4">
        <div class="small ${net >= 0 ? 'text-success' : 'text-danger'}">
          Net: <strong>$${net.toFixed(2)}</strong>
        </div>
      </div>
    </div>
  `;
}

// Show transaction details
function showIncomeDetails() {
  const incomeTransactions = allTransactions.filter(tx => tx.TYPE === 'Income');
  const totalIncome = incomeTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
  const count = incomeTransactions.length;
  const avgIncome = count > 0 ? totalIncome / count : 0;
  
  Swal.fire({
    title: 'Income Details',
    html: `
      <div class="text-start">
        <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
        <p><strong>Number of Transactions:</strong> ${count}</p>
        <p><strong>Average Income per Transaction:</strong> $${avgIncome.toFixed(2)}</p>
        <p><strong>Top Categories:</strong></p>
        <ul>
          ${getTopCategories('Income').map(cat => `<li>${cat.name}: $${cat.total.toFixed(2)}</li>`).join('')}
        </ul>
      </div>
    `,
    icon: 'info',
    confirmButtonText: 'OK'
  });
}

function showExpenseDetails() {
  const expenseTransactions = allTransactions.filter(tx => tx.TYPE === 'Expense');
  const totalExpense = expenseTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
  const count = expenseTransactions.length;
  const avgExpense = count > 0 ? totalExpense / count : 0;
  
  Swal.fire({
    title: 'Expense Details',
    html: `
      <div class="text-start">
        <p><strong>Total Expenses:</strong> $${totalExpense.toFixed(2)}</p>
        <p><strong>Number of Transactions:</strong> ${count}</p>
        <p><strong>Average Expense per Transaction:</strong> $${avgExpense.toFixed(2)}</p>
        <p><strong>Top Categories:</strong></p>
        <ul>
          ${getTopCategories('Expense').map(cat => `<li>${cat.name}: $${cat.total.toFixed(2)}</li>`).join('')}
        </ul>
      </div>
    `,
    icon: 'info',
    confirmButtonText: 'OK'
  });
}

function getTopCategories(type) {
  const transactions = allTransactions.filter(tx => tx.TYPE === type);
  const categoryTotals = {};
  
  transactions.forEach(tx => {
    const category = tx.ACCOUNT_HEADER || 'Uncategorized';
    const amount = type === 'Income' ? (parseFloat(tx.INCOME) || 0) : (parseFloat(tx.EXPENSE) || 0);
    
    if (!categoryTotals[category]) {
      categoryTotals[category] = 0;
    }
    categoryTotals[category] += amount;
  });
  
  return Object.entries(categoryTotals)
    .map(([name, total]) => ({ name, total }))
    .sort((a, b) => b.total - a.total)
    .slice(0, 5);
}

function showTransactionStats() {
  const totalTransactions = allTransactions.length;
  const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
  const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
  const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
  
  const totalAmount = allTransactions.reduce((sum, tx) => {
    const income = parseFloat(tx.INCOME) || 0;
    const expense = parseFloat(tx.EXPENSE) || 0;
    return sum + income + expense;
  }, 0);
  
  const avgTransaction = totalTransactions > 0 ? totalAmount / totalTransactions : 0;
  
  Swal.fire({
    title: 'Transaction Statistics',
    html: `
      <div class="text-start">
        <p><strong>Total Transactions:</strong> ${totalTransactions}</p>
        <p><strong>Income Transactions:</strong> ${incomeCount} (${totalTransactions > 0 ? ((incomeCount/totalTransactions)*100).toFixed(1) : 0}%)</p>
        <p><strong>Expense Transactions:</strong> ${expenseCount} (${totalTransactions > 0 ? ((expenseCount/totalTransactions)*100).toFixed(1) : 0}%)</p>
        <p><strong>Transfer Transactions:</strong> ${transferCount} (${totalTransactions > 0 ? ((transferCount/totalTransactions)*100).toFixed(1) : 0}%)</p>
        <hr>
        <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
        <p><strong>Average Transaction:</strong> $${avgTransaction.toFixed(2)}</p>
      </div>
    `,
    icon: 'info',
    confirmButtonText: 'OK'
  });
}

function showCashflowChart() {
  // This would show a more detailed cashflow chart
  // For now, just show a message
  Swal.fire({
    title: 'Cash Flow Analysis',
    text: 'Cash flow chart shows your income vs expenses over time. Green bars represent income, red bars represent expenses.',
    icon: 'info',
    confirmButtonText: 'OK'
  });
}

function showRecurringTransactions() {
  if (recurringTransactions.length === 0) {
    Swal.fire({
      title: 'Recurring Transactions',
      text: 'No recurring transactions found.',
      icon: 'info',
      confirmButtonText: 'OK'
    });
    return;
  }
  
  let html = '<div class="text-start"><ul>';
  
  recurringTransactions.forEach(tx => {
    const amount = (parseFloat(tx.INCOME) || 0) - (parseFloat(tx.EXPENSE) || 0);
    const sign = amount >= 0 ? '+' : '-';
    const absAmount = Math.abs(amount);
    
    html += `
      <li class="mb-2">
        <strong>${tx.DESCRIPTION}</strong><br>
        <small>
          ${tx.RECURRING.frequency} | Next: ${tx.RECURRING.nextDate}<br>
          Amount: ${sign}$${absAmount.toFixed(2)} | Bank: ${tx.BANK_NAME}
        </small>
      </li>
    `;
  });
  
  html += '</ul></div>';
  
  Swal.fire({
    title: 'Recurring Transactions',
    html: html,
    icon: 'info',
    confirmButtonText: 'OK',
    width: '600px'
  });
}

// Export functions
function exportToCSV() {
  if (filteredTransactions.length === 0) {
    showToast("No transactions to export", "warning");
    return;
  }
  
  const headers = ['Date', 'Voucher #', 'Account Header', 'Bank Name', 'Type', 'Income', 'Expense', 'Balance', 'Description', 'Notes', 'Tags', 'Status'];
  
  const csvRows = [
    headers.join(','),
    ...filteredTransactions.map(tx => [
      tx.DATE || '',
      `"${tx.SINO || ''}"`,
      `"${tx.ACCOUNT_HEADER || ''}"`,
      `"${tx.BANK_NAME || ''}"`,
      tx.TYPE || '',
      tx.INCOME || 0,
      tx.EXPENSE || 0,
      tx.BALANCE || 0,
      `"${(tx.DESCRIPTION || '').replace(/"/g, '""')}"`,
      `"${(tx.NOTES || '').replace(/"/g, '""')}"`,
      `"${(tx.TAGS || []).join(', ')}"`,
      tx.STATUS || ''
    ].join(','))
  ];
  
  const csvString = csvRows.join('\n');
  const blob = new Blob([csvString], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('href', url);
  a.setAttribute('download', `transactions_${new Date().toISOString().slice(0, 10)}.csv`);
  a.click();
  
  showToast("CSV exported successfully", "success");
}

function exportToExcel() {
  if (filteredTransactions.length === 0) {
    showToast("No transactions to export", "warning");
    return;
  }
  
  try {
    const wsData = filteredTransactions.map(tx => ({
      'Date': tx.DATE || '',
      'Voucher #': tx.SINO || '',
      'Account Header': tx.ACCOUNT_HEADER || '',
      'Bank Name': tx.BANK_NAME || '',
      'Type': tx.TYPE || '',
      'Income': tx.INCOME || 0,
      'Expense': tx.EXPENSE || 0,
      'Balance': tx.BALANCE || 0,
      'Description': tx.DESCRIPTION || '',
      'Notes': tx.NOTES || '',
      'Tags': (tx.TAGS || []).join(', '),
      'Status': tx.STATUS || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
    XLSX.writeFile(wb, `transactions_${new Date().toISOString().slice(0, 10)}.xlsx`);
    
    showToast("Excel file exported successfully", "success");
  } catch (error) {
    console.error("Excel export error:", error);
    showToast("Failed to export Excel file", "error");
  }
}

// App state management
function saveAppState() {
  const state = {
    filters: {
      date: dateFilter.value,
      type: typeFilter.value,
      bank: bankFilter.value,
      category: categoryFilter.value,
      status: statusFilter.value,
      search: searchDesc.value,
      startDate: startDateInput.value,
      endDate: endDateInput.value,
      minAmount: minAmount.value,
      maxAmount: maxAmount.value,
      tagFilter: tagFilter.value,
      sortBy: sortBy.value,
      groupBy: groupBy.value
    },
    currentPage: currentPage,
    gridCurrentPage: gridCurrentPage,
    balanceVisible: balanceVisible,
    theme: currentTheme,
    sidebarCollapsed: sidebar.classList.contains('collapsed'),
    selectedTransactions: Array.from(selectedTransactions)
  };
  
  localStorage.setItem('budgetAppState', JSON.stringify(state));
}

function loadAppState() {
  const savedState = localStorage.getItem('budgetAppState');
  if (!savedState) return;
  
  try {
    const state = JSON.parse(savedState);
    
    // Apply filters
    dateFilter.value = state.filters.date || 'all';
    typeFilter.value = state.filters.type || 'all';
    bankFilter.value = state.filters.bank || 'all';
    categoryFilter.value = state.filters.category || 'all';
    statusFilter.value = state.filters.status || 'all';
    searchDesc.value = state.filters.search || '';
    startDateInput.value = state.filters.startDate || '';
    endDateInput.value = state.filters.endDate || '';
    minAmount.value = state.filters.minAmount || '';
    maxAmount.value = state.filters.maxAmount || '';
    tagFilter.value = state.filters.tagFilter || '';
    sortBy.value = state.filters.sortBy || 'date-desc';
    groupBy.value = state.filters.groupBy || 'none';
    
    // Show custom range controls if needed
    if (dateFilter.value === 'custom' && (startDateInput.value || endDateInput.value)) {
      customRangeControls.style.display = 'flex';
    }
    
    // Apply pagination
    currentPage = state.currentPage || 1;
    gridCurrentPage = state.gridCurrentPage || 1;
    
    // Apply theme
    if (state.theme) {
      currentTheme = state.theme;
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'dark' ? 
        '<i class="fa fa-sun"></i>' : '<i class="fa fa-moon"></i>';
    }
    
    // Apply sidebar state
    if (state.sidebarCollapsed) {
      sidebar.classList.add('collapsed');
      mainContent.classList.add('expanded');
      sidebarToggle.querySelector('i').className = 'fa fa-chevron-right';
    }
    
    // Apply balance visibility
    balanceVisible = state.balanceVisible || false;
    updateBalanceDisplay();
    
    // Apply selected transactions
    if (state.selectedTransactions && Array.isArray(state.selectedTransactions)) {
      selectedTransactions = new Set(state.selectedTransactions);
    }
    
    hasLoadedSavedState = true;
  } catch (error) {
    console.error("Error loading app state:", error);
  }
}

// Update last sync time
function updateLastSync() {
  const now = new Date();
  const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  lastSync.textContent = `Last sync: ${timeString}`;
  
  // Update dynamic tip
  const tips = [
    "Tip: Use tags to categorize transactions for better filtering.",
    "Tip: You can split income into multiple expense transactions.",
    "Tip: Use recurring transactions for regular bills and income.",
    "Tip: Export your transactions to CSV or Excel for backup.",
    "Tip: Use the calendar view to see transactions by date.",
    "Tip: Try the AI assistant for financial insights and help.",
    "Tip: Use bulk actions to edit or delete multiple transactions.",
    "Tip: Set up different bank accounts for better tracking.",
    "Tip: Use the quick add feature for fast transaction entry.",
    "Tip: Regularly review and categorize uncategorized transactions."
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  dynamicTip.textContent = randomTip;
}

function showNextTip() {
  const tips = [
    "Tip: Use tags to categorize transactions for better filtering.",
    "Tip: You can split income into multiple expense transactions.",
    "Tip: Use recurring transactions for regular bills and income.",
    "Tip: Export your transactions to CSV or Excel for backup.",
    "Tip: Use the calendar view to see transactions by date.",
    "Tip: Try the AI assistant for financial insights and help.",
    "Tip: Use bulk actions to edit or delete multiple transactions.",
    "Tip: Set up different bank accounts for better tracking.",
    "Tip: Use the quick add feature for fast transaction entry.",
    "Tip: Regularly review and categorize uncategorized transactions.",
    "Tip: Use the search feature to find transactions quickly.",
    "Tip: Filter by date range to analyze specific periods.",
    "Tip: Set transaction status to track pending payments.",
    "Tip: Use attachments to keep receipts and documents.",
    "Tip: Monitor your bank balances in the dashboard.",
    "Tip: Use the chart to visualize income vs expenses.",
    "Tip: Try different views (list, grid, calendar) for better overview.",
    "Tip: Use voucher numbering to keep track of transactions.",
    "Tip: Set default currency in user preferences.",
    "Tip: Use the tag manager to organize your tags."
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  dynamicTip.textContent = randomTip;
}

// Periodic sync
function startPeriodicSync() {
  // Update sync time every minute
  setInterval(updateLastSync, 60000);
  
  // Check for recurring transactions every hour
  setInterval(async () => {
    await processRecurringTransactions();
    await loadTransactions();
  }, 3600000);
}

// Save filter preset
function saveFilterPreset() {
  Swal.fire({
    title: 'Save Filter Preset',
    input: 'text',
    inputLabel: 'Preset Name',
    inputPlaceholder: 'Enter a name for this filter',
    showCancelButton: true,
    confirmButtonText: 'Save',
    cancelButtonText: 'Cancel',
    inputValidator: (value) => {
      if (!value) {
        return 'Please enter a name for the preset';
      }
    }
  }).then(async (result) => {
    if (result.isConfirmed) {
      const presetName = result.value;
      const presetData = {
        date: dateFilter.value,
        type: typeFilter.value,
        bank: bankFilter.value,
        category: categoryFilter.value,
        status: statusFilter.value,
        search: searchDesc.value,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        minAmount: minAmount.value,
        maxAmount: maxAmount.value,
        tagFilter: tagFilter.value,
        sortBy: sortBy.value,
        groupBy: groupBy.value,
        name: presetName,
        createdAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "users", currentUser.uid, "filterPresets"), presetData);
        showToast("Filter preset saved successfully", "success");
      } catch (error) {
        console.error("Save filter preset error:", error);
        showToast("Failed to save filter preset", "error");
      }
    }
  });
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Initialize flatpickr for date inputs
  flatpickr("#startDate", {
    dateFormat: "Y-m-d",
    defaultDate: new Date()
  });
  
  flatpickr("#endDate", {
    dateFormat: "Y-m-d",
    defaultDate: new Date()
  });
  
  // Load sidebar state
  loadSidebarState();
  
  // Add input event listeners for real-time filtering
  searchDesc.addEventListener('input', debounce(() => {
    if (searchDesc.value.length === 0 || searchDesc.value.length >= 3) {
      applyFilters();
    }
  }, 500));
  
  // Add change event listeners for filters
  [dateFilter, typeFilter, bankFilter, categoryFilter, statusFilter, 
   minAmount, maxAmount, tagFilter, sortBy, groupBy].forEach(element => {
    element.addEventListener('change', () => {
      applyFilters();
      saveAppState();
    });
  });
  
  // Add input event listeners for amount filters
  [minAmount, maxAmount].forEach(element => {
    element.addEventListener('input', debounce(() => {
      applyFilters();
      saveAppState();
    }, 500));
  });
  
  // Add event listener for date inputs
  [startDateInput, endDateInput].forEach(element => {
    element.addEventListener('change', () => {
      if (dateFilter.value === 'custom') {
        applyFilters();
        saveAppState();
      }
    });
  });
});

// Debounce function for search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Add this to make functions available globally
window.editTransaction = editTransaction;
window.deleteTransaction = deleteTransaction;
window.viewAttachment = viewAttachment;
window.duplicateTransaction = duplicateTransaction;
window.showIncomeDetails = showIncomeDetails;
window.showExpenseDetails = showExpenseDetails;
window.showTransactionStats = showTransactionStats;
window.showCashflowChart = showCashflowChart;
window.showRecurringTransactions = showRecurringTransactions;
window.showNextTip = showNextTip;
window.toggleBalanceVisibility = toggleBalanceVisibility;
window.removeTag = removeTag;
window.addNewTag = addNewTag;
window.deleteTag = deleteTag;
window.changePage = changePage;
window.changeGridPage = changeGridPage;
window.prevMonth = prevMonth;
window.nextMonth = nextMonth;
window.showDayTransactions = showDayTransactions;
window.toggleAIPanel = toggleAIPanel;
window.sendAIMessage = sendAIMessage;
window.removeSplitExpense = removeSplitExpense;

// Initialize when page loads
setTimeout(() => {
  // Check if user is logged in
  if (!currentUser) {
    // User not logged in, Firebase auth will handle redirect
    return;
  }
  
  // User is logged in, initialize the rest
  updateLastSync();
  
  // Add resize listener for sidebar
  window.addEventListener('resize', () => {
    if (window.innerWidth <= 1200) {
      sidebar.classList.remove('collapsed');
      mainContent.classList.remove('expanded');
    }
  });
}, 1000);
</script>
</body>
</html>