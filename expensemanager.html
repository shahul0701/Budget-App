<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
    }

    body {
      background-color: #f5f7fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 20px;
      color: #333;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto 40px;
      padding: 25px;
    }

    .card-app {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 25px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: white;
      border-radius: 10px;
      margin-bottom: 25px;
    }

    .header h1 { margin: 0; font-weight: 600; font-size: 28px; }

    .header .user-area { display:flex; gap:12px; align-items:center; }
    .user-initials {
      background: rgba(255,255,255,0.15);
      width:36px; height:36px; display:flex; align-items:center; justify-content:center;
      border-radius:50%; font-weight:700;
    }

    .table-responsive { border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

    th { background-color: var(--primary); color: white; padding: 12px; font-weight: 600; text-align:left; }
    td { padding: 12px; border-bottom: 1px solid #eaeaea; vertical-align: middle; }

    tr:nth-child(even) { background-color: #f9fafc; }
    tr:hover { background-color: #edf2ff; }

    .income { color: #28a745; font-weight:600; }
    .expense { color: #dc3545; font-weight:600; }

    .btn-view { background-color: var(--success); color: white; border: none; padding: 6px 10px; border-radius: 6px; }
    .btn-edit { background-color: #ffc107; color: #212529; border: none; padding: 6px 10px; border-radius: 6px; }
    .btn-delete { background-color: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 6px; }

    .floating-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
      background: linear-gradient(120deg, var(--primary), var(--secondary)); color: white; border-radius: 50%;
      display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      z-index:1000; text-decoration:none; }

    .attachment-preview { max-width: 100%; border-radius: 8px; margin-top: 10px; display:none; }
    .filter-section { background-color: white; padding: 18px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

    .pagination { margin: 20px 0 0 0; justify-content:center; }

    @media (max-width:768px) {
      .header { flex-direction: column; gap: 12px; text-align:center; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="card-app">

      <div class="header">
        <h1><i class="fas fa-money-bill-wave me-2"></i>Transaction Manager</h1>
        <div class="user-area">
          <div id="userInitials" class="user-initials">U</div>
          <div id="username" style="font-weight:600;">User</div>
          <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
        </div>
      </div>

      <!-- Stats (static placeholders; can be wired up later) -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card stats-card p-3 text-center">
            <div class="stats-label">Total Income</div>
            <div id="statIncome" class="stats-number income">$0.00</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card p-3 text-center">
            <div class="stats-label">Total Expenses</div>
            <div id="statExpense" class="stats-number expense">$0.00</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card p-3 text-center">
            <div class="stats-label">Current Balance</div>
            <div id="statBalance" class="stats-number">$0.00</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stats-card p-3 text-center">
            <div class="stats-label">Transactions</div>
            <div id="statCount" class="stats-number">0</div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filter-section mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Date Range</label>
            <select id="dateFilter" class="form-select">
              <option value="all">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
              <option value="custom">Custom Range</option>
            </select>
          </div>
          <div id="customDateRange" class="col-sm-4" style="display:none;">
            <label class="form-label">Custom Range</label>
            <div class="d-flex gap-2">
              <input id="startDate" type="date" class="form-control" />
              <input id="endDate" type="date" class="form-control" />
            </div>
          </div>
          <div class="col-sm-3">
            <label class="form-label">Type</label>
            <select id="incomeExpenseFilter" class="form-select">
              <option value="all">All</option>
              <option value="income">Income Only</option>
              <option value="expense">Expense Only</option>
            </select>
          </div>
          <div class="col-sm-2 text-end">
            <button id="applyFiltersBtn" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Apply</button>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-sm-4">
            <input id="descFilter" class="form-control" placeholder="Search description..." />
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Voucher #</th>
              <th>Type</th>
              <th>Income</th>
              <th>Expense</th>
              <th>Balance</th>
              <th>Attachment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            <tr><td colspan="9" class="text-center text-muted">No transactions loaded.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav aria-label="Transaction pagination" class="mt-3">
        <ul class="pagination justify-content-center" id="paginationControls">
          <!-- Prev/Next handled by JS -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Add/Edit Modal (uses original markup, but IDs match script) -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add / Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />

            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Date</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Voucher # (SINO)</label>
                <input id="formVOUCHERNO" type="text" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Description / Account Header</label>
                <input id="formPARTICULAR" type="text" class="form-control" />
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-4">
                <label class="form-label">Voucher Type</label>
                <select id="formVOUCHERTYPE" class="form-select">
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Type</label>
                <select id="formTYPE" class="form-select">
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Mode</label>
                <select id="formMODE" class="form-select">
                  <option value="Cash">Cash</option>
                  <option value="Bank">Bank</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-4">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Balance</label>
                <!-- Manual balance entry (no auto-updates) -->
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-8">
                <label class="form-label">Notes</label>
                <input id="formNOTES" type="text" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Attachment (file upload)</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*" />
                <input id="formATTACH" type="hidden" />
                <img id="attachmentPreview" class="attachment-preview" alt="Attachment preview" />
              </div>
            </div>

          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="saveBtn" type="button" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment Preview Modal (view larger) -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="attachmentModalBody">
          <!-- Filled by JS -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <p class="mb-0">Are you sure you want to delete this transaction?</p>
        </div>
        <div class="modal-footer">
          <button id="cancelDeleteBtn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating button -->
  <a href="#" class="floating-btn" id="floatingAddBtn" data-bs-toggle="modal" data-bs-target="#transactionModal">
    <i class="fas fa-plus"></i>
  </a>

  <!-- Firebase + App Logic (module) -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ---------- CONFIG - replace with your config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };
    // -------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM refs
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const tableBody = document.getElementById("transactionsTableBody");

    const transactionModalEl = document.getElementById("transactionModal");
    const transactionForm = document.getElementById("transactionForm");
    const saveBtn = document.getElementById("saveBtn");
    const floatingAddBtn = document.getElementById("floatingAddBtn");

    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const dateFilter = document.getElementById("dateFilter");
    const incomeExpenseFilter = document.getElementById("incomeExpenseFilter");
    const descFilter = document.getElementById("descFilter");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const customDateRange = document.getElementById("customDateRange");

    const formDATE = document.getElementById("formDATE");
    const formVOUCHERNO = document.getElementById("formVOUCHERNO");
    const formPARTICULAR = document.getElementById("formPARTICULAR");
    const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
    const formTYPE = document.getElementById("formTYPE");
    const formMODE = document.getElementById("formMODE");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formBALANCE = document.getElementById("formBALANCE");
    const formNOTES = document.getElementById("formNOTES");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const txIdInput = document.getElementById("txId");

    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentModal = new bootstrap.Modal(document.getElementById("attachmentModal"));
    const attachmentModalBody = document.getElementById("attachmentModalBody");

    const confirmDeleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    // pagination & arrays
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let txMap = {};
    let currentPage = 1;
    const rowsPerPage = 10;
    let txToDelete = null;

    // Utility escape
    function escapeHtml(text) {
      if (typeof text !== "string") {
        if (text === undefined || text === null) return "";
        try { text = String(text); } catch { return ""; }
      }
      return text.replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[m]);
    }

    // Auth listener
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();

        await loadTransactions();
        updateStats();
      } else {
        alert("Please login first.");
        window.location.href = "index.html";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // Cloudinary config (update if needed)
    const CLOUDINARY_UPLOAD_PRESET = "my_app_uploads"; // keep same as your preset
    const CLOUDINARY_CLOUD_NAME = "dpwdsyvz8";
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

    // Load transactions from Firestore
    async function loadTransactions() {
      try {
        // show loading placeholder
        tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>`;

        // Query transactions for current user ordered by DATE desc
        // Note: ordering by DATE string works if dates stored as yyyy-mm-dd
        const q = query(collection(db, "users", currentUser.uid, "transactions"), orderBy("DATE", "desc"));
        const snap = await getDocs(q);
        const transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        allTransactions = transactions;
        filteredTransactions = allTransactions.slice();
        currentPage = 1;

        populateFiltersOptions(allTransactions);
        buildTable();
        updateStats();
      } catch (err) {
        console.error("Error loading transactions:", err);
        tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Failed to load transactions.</td></tr>`;
      }
    }

    // Populate filter options (not complex here, left minimal)
    function populateFiltersOptions(data) {
      // nothing fancy in this iteration — could populate mode/banks if available
    }

    // Apply filters
    function applyFilters() {
      filteredTransactions = allTransactions.slice();
      const now = new Date();

      function isInRange(dateStr, start, end) {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        if (isNaN(d)) return false;
        return d >= start && d <= end;
      }

      switch (dateFilter.value) {
        case "today": {
          const start = new Date(now); start.setHours(0,0,0,0);
          const end = new Date(now); end.setHours(23,59,59,999);
          filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, end));
          break;
        }
        case "week": {
          const start = new Date(now);
          const day = start.getDay(); // 0..6
          start.setHours(0,0,0,0);
          start.setDate(start.getDate() - day);
          const end = new Date(now);
          filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, end));
          break;
        }
        case "month": {
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          const end = new Date(now);
          filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, end));
          break;
        }
        case "year": {
          const start = new Date(now.getFullYear(), 0, 1);
          filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, now));
          break;
        }
        case "custom": {
          if (startDateInput.value && endDateInput.value) {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);
            end.setHours(23,59,59,999);
            if (!isNaN(start) && !isNaN(end)) {
              filteredTransactions = filteredTransactions.filter(t => isInRange(t.DATE, start, end));
            }
          }
          break;
        }
      }

      if (incomeExpenseFilter.value === "income") {
        filteredTransactions = filteredTransactions.filter(t => (parseFloat(t.INCOME) || 0) > 0);
      } else if (incomeExpenseFilter.value === "expense") {
        filteredTransactions = filteredTransactions.filter(t => (parseFloat(t.EXPENSE) || 0) > 0);
      }

      if (descFilter.value.trim()) {
        const s = descFilter.value.trim().toLowerCase();
        filteredTransactions = filteredTransactions.filter(t => (t.DESCRIPTION || "").toLowerCase().includes(s) || (t.ACCOUNT_HEADER || "").toLowerCase().includes(s));
      }

      currentPage = 1;
      buildTable();
    }

    applyFiltersBtn.addEventListener("click", applyFilters);

    dateFilter.addEventListener("change", () => {
      if (dateFilter.value === "custom") customDateRange.style.display = "flex";
      else { customDateRange.style.display = "none"; startDateInput.value = ""; endDateInput.value = ""; }
    });

    // Build table with pagination
    function buildTable() {
      txMap = {};
      const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / rowsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageItems = filteredTransactions.slice(start, end);

      tableBody.innerHTML = "";

      if (pageItems.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No transactions found.</td></tr>`;
        renderPaginationControls(totalPages);
        return;
      }

      pageItems.forEach(d => {
        txMap[d.id] = d;
        const incomeCell = (parseFloat(d.INCOME) || 0) > 0 ? `<span class="income">${(parseFloat(d.INCOME)||0).toFixed(2)}</span>` : "";
        const expenseCell = (parseFloat(d.EXPENSE) || 0) > 0 ? `<span class="expense">${(parseFloat(d.EXPENSE)||0).toFixed(2)}</span>` : "";
        const balanceCell = (d.BALANCE != null && d.BALANCE !== "") ? (parseFloat(d.BALANCE || 0).toFixed(2)) : "";

        // Attachment rendering
        let attachmentHtml = `<span class="text-muted">None</span>`;
        if (d.ATTACHMENT && typeof d.ATTACHMENT === "string" && d.ATTACHMENT.trim() !== "" &&
            (d.ATTACHMENT.startsWith("http://") || d.ATTACHMENT.startsWith("https://"))) {
          // extract filename
          const parts = d.ATTACHMENT.split("/");
          const filename = parts[parts.length - 1] || "attachment";
          const shortName = filename.length > 20 ? filename.slice(0,17) + "..." : filename;

          // show view & download
          attachmentHtml = `
            <div class="d-flex flex-column">
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-view" data-url="${escapeHtml(d.ATTACHMENT)}" title="View"><i class="fas fa-eye"></i></button>
                <a class="btn btn-sm btn-primary" href="${escapeHtml(d.ATTACHMENT)}" download="${escapeHtml(filename)}" title="Download"><i class="fas fa-download"></i></a>
              </div>
              <small class="text-muted mt-1">${escapeHtml(shortName)}</small>
            </div>
          `;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${escapeHtml(d.DATE || "")}</td>
          <td>${escapeHtml(d.ACCOUNT_HEADER || d.DESCRIPTION || d.PARTICULAR || "")}</td>
          <td>${escapeHtml(d.SINO || d.VOUCHERNO || "")}</td>
          <td>${escapeHtml(d.TYPE || d.VOUCHER_TYPE || d.TYPE || "")}</td>
          <td>${incomeCell}</td>
          <td>${expenseCell}</td>
          <td>${escapeHtml(balanceCell)}</td>
          <td>${attachmentHtml}</td>
          <td>
            <button class="btn-edit btn btn-sm me-1" data-id="${d.id}"><i class="fas fa-edit"></i></button>
            <button class="btn-delete btn btn-sm" data-id="${d.id}"><i class="fas fa-trash"></i></button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      // wire buttons
      document.querySelectorAll(".btn-edit").forEach(b => b.addEventListener("click", e => openEditModal(e.currentTarget.dataset.id)));
      document.querySelectorAll(".btn-delete").forEach(b => b.addEventListener("click", e => openDeleteConfirm(e.currentTarget.dataset.id)));
      document.querySelectorAll(".btn-view").forEach(b => b.addEventListener("click", e => openAttachmentViewer(e.currentTarget.dataset.url)));

      renderPaginationControls(totalPages);
    }

    // Pagination UI
    function renderPaginationControls(totalPages) {
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";

      const prevLi = document.createElement("li");
      prevLi.className = "page-item " + (currentPage <= 1 ? "disabled":"");
      prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">Previous</a>`;
      prevLi.addEventListener("click", (ev) => { ev.preventDefault(); if (currentPage>1) { currentPage--; buildTable(); } });
      container.appendChild(prevLi);

      // show up to 5 pages
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      for (let p = startPage; p <= endPage; p++) {
        const li = document.createElement("li");
        li.className = "page-item " + (p===currentPage ? "active":"");
        li.innerHTML = `<a class="page-link" href="#">${p}</a>`;
        li.addEventListener("click", (ev)=>{ ev.preventDefault(); currentPage=p; buildTable(); });
        container.appendChild(li);
      }

      const nextLi = document.createElement("li");
      nextLi.className = "page-item " + (currentPage >= totalPages ? "disabled":"");
      nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">Next</a>`;
      nextLi.addEventListener("click", (ev) => { ev.preventDefault(); if (currentPage < totalPages) { currentPage++; buildTable(); } });
      container.appendChild(nextLi);
    }

    // Open add modal
    function openAddModal() {
      txIdInput.value = "";
      transactionForm.reset();
      formATTACH.value = "";
      attachmentPreview.src = "";
      attachmentPreview.style.display = "none";

      // set default date
      const now = new Date();
      formDATE.value = now.toISOString().slice(0,10);
      // Auto generate next SINO (optional): we'll compute client-side based on existing max SINO
      const nextSINO = allTransactions.length > 0 ? Math.max(...allTransactions.map(t => parseInt(t.SINO || t.VOUCHERNO || 0) || 0)) + 1 : 1;
      formVOUCHERNO.value = nextSINO;

      const bsModal = new bootstrap.Modal(transactionModalEl);
      bsModal.show();
    }

    // Open edit modal
    function openEditModal(id) {
      const tx = txMap[id];
      if (!tx) return;

      txIdInput.value = id;
      formDATE.value = tx.DATE || "";
      formVOUCHERNO.value = tx.SINO || tx.VOUCHERNO || "";
      formPARTICULAR.value = tx.ACCOUNT_HEADER || tx.PARTICULAR || tx.DESCRIPTION || "";
      formVOUCHERTYPE.value = tx.VOUCHER_TYPE || tx.VOUCHERTYPE || "";
      formTYPE.value = tx.TYPE || ( (parseFloat(tx.INCOME)||0)>0 ? "Income":"Expense" );
      formMODE.value = tx.MODE || "Cash";
      formINCOME.value = tx.INCOME || "";
      formEXPENSE.value = tx.EXPENSE || "";
      formBALANCE.value = tx.BALANCE || "";
      formNOTES.value = tx.DESCRIPTION || tx.NOTES || "";

      formATTACH.value = tx.ATTACHMENT || "";
      if (formATTACH.value) {
        attachmentPreview.src = formATTACH.value;
        attachmentPreview.style.display = formATTACH.value.match(/\.(jpeg|jpg|png|gif|webp)$/i) ? "block":"none";
      } else {
        attachmentPreview.style.display = "none";
        attachmentPreview.src = "";
      }

      const bsModal = new bootstrap.Modal(transactionModalEl);
      bsModal.show();
    }

    // Delete handling
    function openDeleteConfirm(id) {
      txToDelete = id;
      confirmDeleteModal.show();
    }
    confirmDeleteBtn.addEventListener("click", async () => {
      if (!txToDelete) return;
      try {
        await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
        txToDelete = null;
        confirmDeleteModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("Delete error:", err);
        alert("Failed to delete transaction.");
      }
    });

    // Attachment viewer
    function openAttachmentViewer(url) {
      attachmentModalBody.innerHTML = "";
      if (!url) return;
      // If image, embed; else provide link & iframe for documents (if supported)
      const lower = url.toLowerCase();
      if (lower.match(/\.(jpg|jpeg|png|gif|webp)$/)) {
        attachmentModalBody.innerHTML = `<img src="${escapeHtml(url)}" class="img-fluid" alt="Attachment">`;
      } else if (lower.match(/\.(pdf)$/)) {
        // embed pdf using iframe
        attachmentModalBody.innerHTML = `<iframe src="${escapeHtml(url)}" style="width:100%; height:70vh; border:none;"></iframe>`;
      } else {
        attachmentModalBody.innerHTML = `<p><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">Open attachment in new tab</a></p>`;
      }
      attachmentModal.show();
    }

    // File upload to Cloudinary when user selects a file in modal (update hidden field with URL)
    formATTACHFILE.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      // Validate size (<=10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert("File must be less than 10MB.");
        this.value = "";
        return;
      }

      // Allowed types (docs & images)
      const allowed = ["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        "image/jpeg","image/png","image/gif","image/webp","text/plain"];
      if (!allowed.includes(file.type)) {
        alert("Only documents and images allowed (no video).");
        this.value = "";
        return;
      }

      try {
        // show small preview for images
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (e) => {
            attachmentPreview.src = e.target.result;
            attachmentPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          attachmentPreview.style.display = "none";
          attachmentPreview.src = "";
        }

        // upload
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
        if (!res.ok) throw new Error("Upload failed");
        const data = await res.json();
        formATTACH.value = data.secure_url || "";
        // success feedback
        // (we keep UI simple: no Swal dependency here)
      } catch (err) {
        console.error("Upload error:", err);
        alert("Failed to upload attachment.");
      }
    });

    // Save transaction (create or update)
    saveBtn.addEventListener("click", async () => {
      // Basic validation
      if (!formDATE.value) { alert("Please enter a date."); return; }

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      try {
        const docData = {
          DATE: formDATE.value,
          SINO: formVOUCHERNO.value || "",
          VOUCHERNO: formVOUCHERNO.value || "",
          ACCOUNT_HEADER: formPARTICULAR.value || "",
          PARTICULAR: formPARTICULAR.value || "",
          VOUCHER_TYPE: formVOUCHERTYPE.value || "",
          TYPE: formTYPE.value || "",
          MODE: formMODE.value || "Cash",
          INCOME: formINCOME.value ? parseFloat(formINCOME.value) : 0,
          EXPENSE: formEXPENSE.value ? parseFloat(formEXPENSE.value) : 0,
          BALANCE: formBALANCE.value ? parseFloat(formBALANCE.value) : 0,
          DESCRIPTION: formNOTES.value || "",
          ATTACHMENT: formATTACH.value || "",
          userId: currentUser.uid
        };

        if (txIdInput.value) {
          // update
          await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), docData);
        } else {
          // add new
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), docData);
        }

        // close modal & refresh
        const bsModal = bootstrap.Modal.getInstance(transactionModalEl);
        if (bsModal) bsModal.hide();
        await loadTransactions();
      } catch (err) {
        console.error("Save error:", err);
        alert("Failed to save transaction.");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Transaction";
      }
    });

    // Open Add Modal from floating button
    floatingAddBtn.addEventListener("click", (ev) => {
      ev.preventDefault();
      openAddModal();
    });

    // Update stats (simple totals from loaded transactions)
    function updateStats() {
      const totalIncome = allTransactions.reduce((s,t) => s + (parseFloat(t.INCOME)||0), 0);
      const totalExpense = allTransactions.reduce((s,t) => s + (parseFloat(t.EXPENSE)||0), 0);
      const balance = allTransactions.length ? allTransactions[allTransactions.length-1].BALANCE || 0 : 0; // not auto-calculated; placeholder
      document.getElementById("statIncome").textContent = `$${totalIncome.toFixed(2)}`;
      document.getElementById("statExpense").textContent = `$${totalExpense.toFixed(2)}`;
      document.getElementById("statBalance").textContent = `$${(balance || 0).toFixed(2)}`;
      document.getElementById("statCount").textContent = `${allTransactions.length}`;
    }

    // Initial placeholder (ensure modals work)
    document.addEventListener("DOMContentLoaded", () => {
      // nothing extra required
    });

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
