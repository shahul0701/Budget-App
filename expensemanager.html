<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }

    .page {
      max-width:1200px;
      margin:36px auto;
      padding:22px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(4,1fr); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1000px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    /* Floating action buttons */
    .floating-actions {
      position:fixed; 
      right:30px; 
      bottom:30px; 
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:15px;
      z-index:1200;
    }
    
    .floating-add {
      width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; 
      box-shadow:0 10px 30px rgba(70,34,173,0.2);
      cursor:pointer;
      order: 2;
    }
    
    .floating-help {
      width:56px; height:56px; border-radius:50%;
      background: linear-gradient(180deg,var(--info),#0da5c2);
      color:white; display:flex; align-items:center; justify-content:center; 
      box-shadow:0 8px 25px rgba(13, 202, 240, 0.3);
      cursor:pointer;
      order: 1;
    }
    
    .floating-help.hidden {
      display:none;
    }

    /* responsive */
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .tm-header { flex-direction:column; align-items:flex-start; gap:12px; border-radius:14px 14px 0 0; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s;
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bg-primary);
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .split-summary {
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      font-weight: 600;
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }
    
    /* NEW: View Toggle Styles */
    .view-toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .view-toggle-buttons {
      display: flex;
      gap: 8px;
    }
    
    .view-toggle-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }
    
    .view-toggle-btn:hover {
      background: var(--card-bg);
      border-color: var(--purple-1);
    }
    
    .view-toggle-btn.active {
      background: var(--purple-1);
      color: white;
      border-color: var(--purple-1);
    }
    
    /* NEW: Grid View Styles */
    .transactions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    .transaction-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .transaction-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .transaction-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .transaction-card-date {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    
    .transaction-card-type {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .transaction-card-description {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .transaction-card-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .transaction-card-detail {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    
    .transaction-card-detail-label {
      color: var(--muted);
    }
    
    .transaction-card-detail-value {
      font-weight: 600;
    }
    
    .transaction-card-amount {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      margin: 10px 0;
    }
    
    .transaction-card-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }
    
    /* NEW: Calendar View Styles */
    .calendar-view {
      height: 600px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      display: none;
    }
    
    .fc {
      background: var(--card-bg);
      border-radius: 10px;
    }
    
    .fc-theme-standard .fc-scrollgrid {
      border-color: var(--border-color);
    }
    
    .fc-theme-standard td, .fc-theme-standard th {
      border-color: var(--border-color);
    }
    
    .fc .fc-toolbar-title {
      color: var(--text-primary);
    }
    
    .fc .fc-col-header-cell-cushion {
      color: var(--text-primary);
    }
    
    .fc .fc-daygrid-day-number {
      color: var(--text-primary);
    }
    
    .fc .fc-daygrid-day.fc-day-today {
      background-color: rgba(111, 66, 193, 0.1);
    }
    
    /* NEW: Grid Pagination */
    .grid-pagination-wrap {
      display: flex;
      justify-content: center;
      padding-top: 18px;
      gap: 10px;
      display: none;
    }
    
    /* NEW: Enhanced AI Chat Modal Styles */
    .chat-messages-container {
      height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 15px;
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .chat-message {
      margin-bottom: 15px;
      max-width: 85%;
      animation: fadeIn 0.3s ease-in;
    }
    
    .chat-message.user {
      margin-left: auto;
    }
    
    .chat-message-content {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-line;
    }
    
    .chat-message.user .chat-message-content {
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(111, 66, 193, 0.2);
    }
    
    .chat-message.assistant .chat-message-content {
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .chat-message.assistant .chat-message-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
    }
    
    .chat-message.assistant .chat-message-content th {
      background: var(--bg-primary);
      padding: 8px;
      text-align: left;
      border: 1px solid var(--border-color);
      font-weight: 600;
    }
    
    .chat-message.assistant .chat-message-content td {
      padding: 8px;
      border: 1px solid var(--border-color);
    }
    
    .chat-message.assistant .chat-message-content .insight-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin: 2px 4px 2px 0;
    }
    
    .chat-message.assistant .chat-message-content .insight-good {
      background: rgba(25, 135, 84, 0.15);
      color: var(--success);
    }
    
    .chat-message.assistant .chat-message-content .insight-warning {
      background: rgba(255, 193, 7, 0.15);
      color: var(--warning);
    }
    
    .chat-message.assistant .chat-message-content .insight-danger {
      background: rgba(220, 53, 69, 0.15);
      color: var(--danger);
    }
    
    .chat-message.assistant .chat-message-content .insight-info {
      background: rgba(13, 202, 240, 0.15);
      color: var(--info);
    }
    
    .chat-message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }
    
    .chat-input-container {
      display: flex;
      gap: 10px;
    }
    
    .suggested-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .suggested-question {
      padding: 6px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .suggested-question:hover {
      background: var(--card-bg);
      border-color: var(--purple-1);
      transform: translateY(-1px);
    }
    
    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
      padding: 10px;
      animation: pulse 1.5s infinite;
    }
    
    .thinking-dots {
      display: flex;
      gap: 4px;
    }
    
    .thinking-dot {
      width: 8px;
      height: 8px;
      background: var(--muted);
      border-radius: 50%;
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    .thinking-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .thinking-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    /* NEW: AI Chat Header */
    .ai-chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 15px;
    }
    
    .ai-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }
    
    .ai-header-text h6 {
      margin: 0;
      font-weight: 600;
    }
    
    .ai-header-text p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }
    
    /* NEW: Quick Actions in AI Chat */
    .ai-quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .ai-quick-action {
      padding: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 13px;
    }
    
    .ai-quick-action:hover {
      background: var(--card-bg);
      border-color: var(--purple-1);
      transform: translateY(-2px);
    }
    
    .ai-quick-action i {
      display: block;
      font-size: 16px;
      margin-bottom: 5px;
      color: var(--purple-1);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    
    /* NEW: Grid view controls */
    .grid-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .grid-results-count {
      font-size: 14px;
      color: var(--muted);
    }
    
    .grid-pagination-controls {
      display: flex;
      gap: 5px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Loading Backdrop -->
    <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p id="backdropMessage">Loading...</p>
      </div>
    </div>
    
    <!-- Navigation buttons -->
    <div class="nav-buttons">
      <button id="backBtn" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left me-1"></i> Back
      </button>
      <button id="homeBtn" class="btn btn-outline-secondary">
        <i class="fa fa-home me-1"></i> Home
      </button>
      <button id="coaBtn" class="btn btn-outline-info">
        <i class="fa fa-chart-pie me-1"></i> Manage COA
      </button>
      <div class="export-buttons">
        <button id="exportCSV" class="btn btn-outline-success btn-sm">
          <i class="fa fa-file-csv me-1"></i> Export CSV
        </button>
        <button id="exportPDF" class="btn btn-outline-danger btn-sm">
          <i class="fa fa-file-pdf me-1"></i> Export PDF
        </button>
      </div>
    </div>
    
    <div class="app-card">
      <!-- header -->
      <div class="tm-header">
        <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager</h2>
        <div class="header-actions">
          <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
          <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
          <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
          <button id="themeToggle" class="theme-toggle">
            <i class="fa fa-moon"></i>
          </button>
          <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
          <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
            <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
            <div style="color:white; font-weight:600;" id="username">User</div>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
          </div>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div id="bulkActions" class="bulk-actions hidden">
        <span class="bulk-count" id="selectedCount">0 transactions selected</span>
        <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
          <i class="fa fa-trash me-1"></i> Delete Selected
        </button>
        <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
          <i class="fa fa-edit me-1"></i> Edit Selected
        </button>
        <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-times me-1"></i> Clear Selection
        </button>
      </div>

      <!-- top cards -->
      <div class="top-cards" id="topCards">
        <div class="stat-card">
          <div class="stat-label">Total Income</div>
          <div id="statIncome" class="stat-value income-color">$0.00</div>
          <div class="small-muted"><i class="fa fa-arrow-up text-success"></i> 0.0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Expenses</div>
          <div id="statExpense" class="stat-value expense-color">$0.00</div>
          <div class="small-muted"><i class="fa fa-arrow-down text-danger"></i> 0.0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Current Balance</div>
          <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
          <div class="small-muted">
            <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Transactions</div>
          <div id="statCount" class="stat-value">0</div>
          <div class="small-muted">This month</div>
        </div>
      </div>
      
      <!-- Quick stats -->
      <div class="quick-stats" id="quickStats">
        <!-- Will be populated dynamically -->
      </div>
      
      <!-- Chart container -->
      <div class="chart-container" id="transactionsChart">
        <!-- Chart will be rendered here -->
      </div>
      
      <!-- Bank balances section -->
      <div class="info-banner">
        <i class="fa fa-info-circle me-2"></i> Manage your transactions, view attachments, and track your finances in one place.
      </div>
      
      <div class="content-body">
        <!-- Bank balances -->
        <div id="bankBalances" class="bank-balances">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- NEW: View Toggle Container -->
        <div class="view-toggle-container">
          <div class="view-toggle-buttons">
            <button id="tableViewBtn" class="view-toggle-btn active" data-view="table">
              <i class="fa fa-table"></i> Table View
            </button>
            <button id="gridViewBtn" class="view-toggle-btn" data-view="grid">
              <i class="fa fa-th-large"></i> Grid View
            </button>
            <button id="calendarViewBtn" class="view-toggle-btn" data-view="calendar">
              <i class="fa fa-calendar"></i> Calendar View
            </button>
          </div>
          
          <!-- View-specific info -->
          <div id="viewInfo" class="small-muted">
            Showing all transactions
          </div>
        </div>
        
        <!-- filters -->
        <div class="filters mb-2">
          <select id="dateFilter" class="form-select form-select-sm">
            <option value="all">All Dates</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>

          <div id="customRangeControls" style="display:none; display:flex; gap:8px;">
            <input id="startDate" type="date" class="form-control form-control-sm" />
            <input id="endDate" type="date" class="form-control form-control-sm" />
          </div>

          <select id="typeFilter" class="form-select form-select-sm">
            <option value="all">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
            <option value="transfer">Transfer</option>
          </select>

          <!-- Bank Filter -->
          <select id="bankFilter" class="form-select form-select-sm">
            <option value="all">All Banks</option>
            <!-- Will be populated dynamically -->
          </select>

          <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description..." />

          <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
          <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
          <button id="advancedFiltersBtn" class="btn btn-sm btn-outline-info">Advanced</button>
          <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
          <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
        </div>
        
        <!-- Advanced filters (initially hidden) -->
        <div id="advancedFilters" style="display: none;" class="filters mb-2">
          <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="Min Amount" step="0.01" />
          <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="Max Amount" step="0.01" />
          <select id="sortBy" class="form-select form-select-sm">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="amount-desc">Amount (High to Low)</option>
            <option value="amount-asc">Amount (Low to High)</option>
          </select>
        </div>

        <!-- NEW: Grid View Controls -->
        <div id="gridControls" class="grid-controls">
          <div class="grid-results-count" id="gridResultsCount">0 transactions</div>
          <div class="grid-pagination-controls">
            <button id="gridPrevBtn" class="btn btn-sm btn-outline-secondary">
              <i class="fa fa-chevron-left"></i>
            </button>
            <span id="gridPageInfo" class="small-muted mx-2">Page 1 of 1</span>
            <button id="gridNextBtn" class="btn btn-sm btn-outline-secondary">
              <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <!-- NEW: Grid View Container -->
        <div id="gridViewContainer" class="transactions-grid">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- NEW: Grid Pagination -->
        <div id="gridPagination" class="grid-pagination-wrap">
          <!-- Pagination for grid view will be inserted here -->
        </div>
        
        <!-- NEW: Calendar View Container -->
        <div id="calendarViewContainer" class="calendar-view">
          <!-- Calendar will be rendered here -->
        </div>
        
        <!-- transactions table -->
        <div id="tableViewContainer" class="transactions-table">
          <table class="table mb-0">
            <thead>
              <tr>
                <th style="width:40px;">
                  <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                </th>
                <th style="width:110px;">Date</th>
                <th style="width:120px; text-align:right;">Account Header</th>
                <th>Description</th>
                <th style="width:120px;">Type</th>
                <th style="width:110px;">Voucher #</th>
                <th style="width:120px;">Bank Name</th>
                <th style="width:120px; text-align:right;">Income</th>
                <th style="width:120px; text-align:right;">Expense</th>
                <th style="width:120px;">Balance</th>
                <th style="width:120px;">Attachment</th>
                <th style="width:130px;">Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <tr><td colspan="12" class="text-center text-muted py-4">No transactions loaded.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- pagination -->
        <div class="pagination-wrap mt-3" id="paginationControls"></div>
      </div>
    </div>
  </div>

  <!-- NEW: Enhanced AI Chat Assistant Modal -->
  <div class="modal fade" id="aiChatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div class="ai-chat-header">
            <div class="ai-avatar">
              <i class="fa fa-robot"></i>
            </div>
            <div class="ai-header-text">
              <h6>Transaction Assistant</h6>
              <p>Ask me anything about your transactions</p>
            </div>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- NEW: Quick Actions -->
          <div class="ai-quick-actions">
            <div class="ai-quick-action" data-question="Show me this month's summary">
              <i class="fa fa-calendar-alt"></i>
              Monthly Summary
            </div>
            <div class="ai-quick-action" data-question="What are my top expenses?">
              <i class="fa fa-chart-bar"></i>
              Top Expenses
            </div>
            <div class="ai-quick-action" data-question="Show me transactions from SBI bank">
              <i class="fa fa-university"></i>
              Bank Analysis
            </div>
            <div class="ai-quick-action" data-question="How much did I spend on groceries last week?">
              <i class="fa fa-shopping-cart"></i>
              Category Search
            </div>
          </div>
          
          <div class="chat-messages-container" id="chatMessages">
            <div class="chat-message assistant">
              <div class="chat-message-content">
                üëã Hello! I'm your Transaction Assistant. I can help you analyze your finances in many ways:
                
                üí∞ **Financial Analysis:**
                ‚Ä¢ Income vs expenses
                ‚Ä¢ Spending trends
                ‚Ä¢ Category breakdown
                ‚Ä¢ Bank balances
                
                üîç **Search & Filter:**
                ‚Ä¢ Transactions by date, bank, or type
                ‚Ä¢ Specific descriptions or accounts
                ‚Ä¢ Amount ranges
                ‚Ä¢ Time periods
                
                üìä **Insights & Reports:**
                ‚Ä¢ Monthly summaries
                ‚Ä¢ Top spending categories
                ‚Ä¢ Savings rate analysis
                ‚Ä¢ Financial recommendations
                
                <span class="insight-badge insight-info">Ask me anything!</span>
              </div>
              <div class="chat-message-time">Just now</div>
            </div>
          </div>
          
          <div class="suggested-questions" id="suggestedQuestions">
            <div class="suggested-question" data-question="Show me transactions from last week">Last week's transactions</div>
            <div class="suggested-question" data-question="How much did I spend on fuel this month?">Fuel spending</div>
            <div class="suggested-question" data-question="What's my highest transaction amount?">Highest transaction</div>
            <div class="suggested-question" data-question="Show me all income transactions from AXIS bank">AXIS income</div>
          </div>
          
          <div class="chat-input-container mt-3">
            <input type="text" id="chatInput" class="form-control" placeholder="Ask about your transactions. Examples: 'transactions from yesterday', 'spending on groceries', 'income this month'..." />
            <button id="sendChatBtn" class="btn btn-primary">
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <small class="text-muted">AI Assistant analyzes your transaction data locally for privacy.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # (SINO)</label>
                <input id="formSINO" type="text" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header</label>
                <select id="formACCOUNTHEADER" class="form-select">
                  <option value="">Select Account Header</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type</label>
                <select id="formVOUCHERTYPE" class="form-select">
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type</label>
                <select id="formTYPE" class="form-select">
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name</label>
                <select id="formBANKNAME" class="form-select">
                  <option value="">Select Bank</option>
                  <!-- Will be populated from COA -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency</label>
                <select id="formCURRENCY" class="form-select">
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                  <option value="GBP">GBP (¬£)</option>
                  <option value="INR">INR (‚Çπ)</option>
                  <option value="JPY">JPY (¬•)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Balance (manual)</label>
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Notes</label>
                <input id="formNOTES" type="text" class="form-control" placeholder="Enter notes" />
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description"></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*" />
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction in natural language:</label>
            <textarea id="quickAddInput" class="form-control" rows="3" placeholder="Examples:&#10;‚Ä¢ Add 500 to cash&#10;‚Ä¢ Spent 200 on petrol from SBI&#10;‚Ä¢ Received 1000 payment from client in AXIS&#10;‚Ä¢ Transfer 500 from SBI to HDFC"></textarea>
          </div>
          <div class="card bg-light">
            <div class="card-body py-2">
              <small class="text-muted">
                <strong>Format examples:</strong><br>
                ‚Ä¢ Add [amount] to [account]<br>
                ‚Ä¢ Spent [amount] on [category] from [bank]<br>
                ‚Ä¢ Received [amount] for [description] in [bank]<br>
                ‚Ä¢ Transfer [amount] from [bank1] to [bank2]<br>
                ‚Ä¢ You can include dates like "yesterday", "last friday", "15th jan"
              </small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="processQuickAddBtn" class="btn btn-primary">Process</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Multiple Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Income Amount to Split</label>
            <input id="splitIncomeAmount" type="number" step="0.01" class="form-control" placeholder="Enter total income amount" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Description</label>
            <input id="splitIncomeDescription" type="text" class="form-control" placeholder="Description for the income transaction" />
          </div>
          <div class="mb-3">
            <label class="form-label">Income Bank Account</label>
            <select id="splitIncomeBank" class="form-select">
              <option value="">Select Bank</option>
              <!-- Will be populated from COA -->
            </select>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6>Expense Transactions</h6>
            <button type="button" id="addSplitExpenseBtn" class="btn btn-sm btn-primary">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div id="splitExpensesContainer">
            <!-- Split expense items will be added here -->
          </div>
          
          <div id="splitSummary" class="split-summary">
            <!-- Summary will be updated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button data-bs-dismiss="modal" class="btn btn-outline-secondary">Cancel</button>
          <button id="saveSplitTransactionsBtn" class="btn btn-primary">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Update Field</label>
            <select id="bulkEditField" class="form-select">
              <option value="BANK_NAME">Bank Name</option>
              <option value="ACCOUNT_HEADER">Account Header</option>
              <option value="TYPE">Transaction Type</option>
              <option value="VOUCHER_TYPE">Voucher Type</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Value</label>
            <input id="bulkEditValue" type="text" class="form-control" placeholder="Enter new value" />
          </div>
          <div class="alert alert-info">
            <small>This will update <span id="bulkEditCount">0</span> selected transactions.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkEditBtn" class="btn btn-primary">Update Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="attachmentModalBody">
          <!-- filled dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirm -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete this transaction?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirm -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">Are you sure you want to delete <span id="bulkDeleteCount">0</span> selected transactions?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmBulkDeleteBtn" class="btn btn-danger">Delete All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing transaction...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Floating Action Buttons -->
  <div class="floating-actions">
    <div class="floating-help" id="floatingHelp" title="AI Assistant">
      <i class="fa fa-robot fa-lg"></i>
    </div>
    <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>
  </div>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- FullCalendar for calendar view -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
      authDomain: "budget-app-1365f.firebaseapp.com",
      projectId: "budget-app-1365f",
      storageBucket: "budget-app-1365f.appspot.com",
      messagingSenderId: "1036194450411",
      appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
      measurementId: "G-YFFJL2H54X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // state
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const rowsPerPage = 10; // Fixed to show 10 entries
    let txToDelete = null;
    let balanceVisible = false;
    let isSubmitting = false;
    let lastVoucherNumber = 0;
    let currentTheme = 'light';
    let transactionsChartInstance = null;
    let selectedTransactions = new Set();
    let hasLoadedSavedState = false;
    let currentView = 'table'; // NEW: Current view state
    
    // NEW: Grid view pagination
    let gridCurrentPage = 1;
    const gridRowsPerPage = 12; // 12 cards per page in grid view
    
    // COA data
    let coaAccounts = [];
    let coaBanks = [];
    
    // NEW: Calendar instance
    let calendar = null;

    // DOM refs
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const newTxBtn = document.getElementById("newTxBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const splitIncomeBtn = document.getElementById("splitIncomeBtn");
    const floatingAdd = document.getElementById("floatingAdd");
    const floatingHelp = document.getElementById("floatingHelp"); // NEW
    const balanceToggle = document.getElementById("balanceToggle");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const coaBtn = document.getElementById("coaBtn");
    const themeToggle = document.getElementById("themeToggle");
    const exportCSV = document.getElementById("exportCSV");
    const exportPDF = document.getElementById("exportPDF");
    const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
    const advancedFilters = document.getElementById("advancedFilters");
    const includeTimeCheckbox = document.getElementById("includeTime");
    const formTIME = document.getElementById("formTIME");
    const formCURRENCY = document.getElementById("formCURRENCY");
    const minAmount = document.getElementById("minAmount");
    const maxAmount = document.getElementById("maxAmount");
    const sortBy = document.getElementById("sortBy");
    const formDESCRIPTION = document.getElementById("formDESCRIPTION");
    const quickAddInput = document.getElementById("quickAddInput");
    const processQuickAddBtn = document.getElementById("processQuickAddBtn");
    const loadingModalEl = document.getElementById("loadingModal");
    const loadingModal = new bootstrap.Modal(loadingModalEl);
    const loadingMessage = document.getElementById("loadingMessage");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const bulkActions = document.getElementById("bulkActions");
    const selectedCount = document.getElementById("selectedCount");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkEditBtn = document.getElementById("bulkEditBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const splitIncomeModalEl = document.getElementById("splitIncomeModal");
    const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
    const splitIncomeAmount = document.getElementById("splitIncomeAmount");
    const splitIncomeDescription = document.getElementById("splitIncomeDescription");
    const splitIncomeBank = document.getElementById("splitIncomeBank");
    const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
    const splitExpensesContainer = document.getElementById("splitExpensesContainer");
    const splitSummary = document.getElementById("splitSummary");
    const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
    const bulkEditModalEl = document.getElementById("bulkEditModal");
    const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
    const bulkEditField = document.getElementById("bulkEditField");
    const bulkEditValue = document.getElementById("bulkEditValue");
    const bulkEditCount = document.getElementById("bulkEditCount");
    const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
    const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
    const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
    const bulkDeleteCount = document.getElementById("bulkDeleteCount");
    const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
    const viewInfo = document.getElementById("viewInfo"); // NEW
    
    // NEW: View toggle DOM refs
    const tableViewBtn = document.getElementById("tableViewBtn");
    const gridViewBtn = document.getElementById("gridViewBtn");
    const calendarViewBtn = document.getElementById("calendarViewBtn");
    const tableViewContainer = document.getElementById("tableViewContainer");
    const gridViewContainer = document.getElementById("gridViewContainer");
    const calendarViewContainer = document.getElementById("calendarViewContainer");
    
    // NEW: Grid pagination DOM refs
    const gridControls = document.getElementById("gridControls");
    const gridResultsCount = document.getElementById("gridResultsCount");
    const gridPrevBtn = document.getElementById("gridPrevBtn");
    const gridNextBtn = document.getElementById("gridNextBtn");
    const gridPageInfo = document.getElementById("gridPageInfo");
    const gridPagination = document.getElementById("gridPagination");
    
    // NEW: AI Chat DOM refs
    const aiChatModalEl = document.getElementById("aiChatModal");
    const aiChatModal = new bootstrap.Modal(aiChatModalEl);
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");
    const suggestedQuestions = document.getElementById("suggestedQuestions");
    const aiQuickActions = document.querySelector('.ai-quick-actions');

    // Other DOM refs (filters, table, etc.)
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const searchDesc = document.getElementById("searchDesc");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const transactionsTableBody = document.getElementById("transactionsTableBody");
    const paginationControls = document.getElementById("paginationControls");
    const bankBalancesContainer = document.getElementById("bankBalances");
    const quickStatsContainer = document.getElementById("quickStats");
    const transactionsChart = document.getElementById("transactionsChart");

    // Modal refs
    const transactionModalEl = document.getElementById("transactionModal");
    const transactionModal = new bootstrap.Modal(transactionModalEl);
    const quickAddModalEl = document.getElementById("quickAddModal");
    const quickAddModal = new bootstrap.Modal(quickAddModalEl);
    const form = document.getElementById("transactionForm");
    const txIdInput = document.getElementById("txId");
    const formDATE = document.getElementById("formDATE");
    const formSINO = document.getElementById("formSINO");
    const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
    const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
    const formTYPE = document.getElementById("formTYPE");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formBALANCE = document.getElementById("formBALANCE");
    const formNOTES = document.getElementById("formNOTES");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentInfo = document.getElementById("attachmentInfo");
    const saveTransactionBtn = document.getElementById("saveTransactionBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadProgressBar = document.getElementById("uploadProgressBar");

    const attachmentModalEl = document.getElementById("attachmentModal");
    const attachmentModal = new bootstrap.Modal(attachmentModalEl);
    const attachmentModalBody = document.getElementById("attachmentModalBody");

    const confirmDeleteModalEl = document.getElementById("confirmDeleteModal");
    const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    // stats
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");

    // Helper functions
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    // Auth handling
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        const name = user.displayName || user.email || "User";
        usernameElem.textContent = name;
        initialsElem.textContent = (name.charAt(0) || "U").toUpperCase();
        
        showLoading("Loading your transactions...");
        
        try {
          // Load theme preference
          loadThemePreference();
          
          // Load COA data and transactions in parallel for better performance
          await Promise.all([loadCOAData(), loadTransactions()]);
          
          loadAppState();
          applyFilters();
          
          hideLoading();
        } catch (error) {
          hideLoading();
          console.error("Initialization error:", error);
          Swal.fire({ 
            icon: 'error', 
            title: 'Loading Error', 
            text: 'Failed to load data. Please refresh the page.' 
          });
        }
      } else {
        // not logged in
        Swal.fire({ icon: 'info', title: 'Please login', text: 'You will be redirected to login.' }).then(()=> {
          window.location.href = "index.html";
        });
      }
    });

    // Event listeners
    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem('budgetAppState');
      await signOut(auth);
      window.location.href = "index.html";
    });

    newTxBtn.addEventListener("click", () => openAddModal());
    floatingAdd.addEventListener("click", () => openAddModal());
    
    // NEW: Floating help button
    floatingHelp.addEventListener("click", () => openAIChat());
    
    balanceToggle.addEventListener("click", () => {
      balanceVisible = !balanceVisible;
      updateBalanceVisibility();
      saveAppState();
    });

    dateFilter.addEventListener("change", () => {
      if (dateFilter.value === "custom") customRangeControls.style.display = "flex";
      else customRangeControls.style.display = "none";
    });

    applyFiltersBtn.addEventListener("click", () => { applyFilters(); });
    resetFiltersBtn.addEventListener("click", () => {
      dateFilter.value = "all";
      typeFilter.value = "all";
      bankFilter.value = "all";
      searchDesc.value = "";
      startDateInput.value = "";
      endDateInput.value = "";
      minAmount.value = "";
      maxAmount.value = "";
      sortBy.value = "date-desc";
      customRangeControls.style.display = "none";
      advancedFilters.style.display = "none";
      advancedFiltersBtn.textContent = "Advanced";
      applyFilters();
    });

    // Navigation button handlers
    backBtn.addEventListener("click", () => window.history.back());
    homeBtn.addEventListener("click", () => window.location.href = "home.html");
    coaBtn.addEventListener("click", () => window.location.href = "coa.html");

    // Theme toggle
    themeToggle.addEventListener("click", () => toggleTheme());

    // Export buttons
    exportCSV.addEventListener("click", () => exportToCSV());
    exportPDF.addEventListener("click", () => exportToPDF());

    // Advanced filters toggle
    advancedFiltersBtn.addEventListener("click", () => {
      const isVisible = advancedFilters.style.display === "flex";
      advancedFilters.style.display = isVisible ? "none" : "flex";
      advancedFiltersBtn.textContent = isVisible ? "Advanced" : "Hide Advanced";
    });

    // Time toggle
    includeTimeCheckbox.addEventListener("change", () => {
      formTIME.disabled = !includeTimeCheckbox.checked;
      if (!includeTimeCheckbox.checked) formTIME.value = "";
    });

    // Quick Add button
    quickAddBtn.addEventListener("click", () => {
      quickAddInput.value = "";
      quickAddModal.show();
    });
    processQuickAddBtn.addEventListener("click", processQuickAdd);

    // Split Income button
    splitIncomeBtn.addEventListener("click", () => openSplitIncomeModal());

    // Bulk action buttons
    selectAllBtn.addEventListener("click", selectAllTransactions);
    deselectAllBtn.addEventListener("click", deselectAllTransactions);
    selectAllCheckbox.addEventListener("change", toggleSelectAll);
    bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
    bulkEditBtn.addEventListener("click", openBulkEditModal);
    clearSelectionBtn.addEventListener("click", clearSelection);
    confirmBulkEditBtn.addEventListener("click", processBulkEdit);
    confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);

    // Split income functionality
    addSplitExpenseBtn.addEventListener("click", addSplitExpense);
    saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);
    splitIncomeAmount.addEventListener("input", updateSplitSummary);

    // Save transaction
    saveTransactionBtn.addEventListener("click", async () => {
      if (isSubmitting) return;
      isSubmitting = true;
          
      saveTransactionBtn.disabled = true;
      saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      
      if (!formDATE.value) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Date is required' });
        resetSaveButton();
        return;
      }

      if (!formSINO.value) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Voucher number is required' });
        resetSaveButton();
        return;
      }
          
      const txData = {
        DATE: formDATE.value,
        SINO: formSINO.value,
        ACCOUNT_HEADER: formACCOUNTHEADER.value,
        MODE: formBANKNAME.value,
        BANK_NAME: formBANKNAME.value,
        VOUCHER_TYPE: formVOUCHERTYPE.value,
        TYPE: formTYPE.value,
        INCOME: parseFloat(formINCOME.value) || 0,
        EXPENSE: parseFloat(formEXPENSE.value) || 0,
        BALANCE: parseFloat(formBALANCE.value) || 0,
        DESCRIPTION: formDESCRIPTION.value,
        NOTES: formNOTES.value,
        ATTACHMENT: formATTACH.value,
        CURRENCY: formCURRENCY.value,
        createdAt: new Date(),
        userId: currentUser.uid
      };
      
      if (includeTimeCheckbox.checked && formTIME.value) {
        txData.TIME = formTIME.value;
      }
      
      try {
        loadingMessage.textContent = "Saving transaction...";
        loadingModal.show();
        
        if (txIdInput.value) {
          // Update existing transaction
          await updateDoc(doc(db, "users", currentUser.uid, "transactions", txIdInput.value), txData);
          Swal.fire({ icon: 'success', title: 'Updated', text: 'Transaction updated successfully' });
        } else {
          // Add new transaction
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
          Swal.fire({ icon: 'success', title: 'Added', text: 'Transaction added successfully' });
        }
        
        loadingModal.hide();
        transactionModal.hide();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("saveTransaction", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transaction' });
      } finally {
        resetSaveButton();
      }
    });

    confirmDeleteBtn.addEventListener("click", async () => {
      if (!txToDelete) return;
      
      try {
        loadingMessage.textContent = "Deleting transaction...";
        loadingModal.show();
        
        await deleteDoc(doc(db, "users", currentUser.uid, "transactions", txToDelete));
        
        loadingModal.hide();
        Swal.fire({ icon: 'success', title: 'Deleted', text: 'Transaction deleted successfully' });
        await loadTransactions();
        confirmDeleteModal.hide();
      } catch (err) {
        loadingModal.hide();
        console.error("deleteTransaction", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transaction' });
      }
    });

    // NEW: View toggle event listeners
    tableViewBtn.addEventListener("click", () => switchView('table'));
    gridViewBtn.addEventListener("click", () => switchView('grid'));
    calendarViewBtn.addEventListener("click", () => switchView('calendar'));

    // NEW: Grid pagination event listeners
    gridPrevBtn.addEventListener("click", () => navigateGridPage(-1));
    gridNextBtn.addEventListener("click", () => navigateGridPage(1));

    // NEW: AI Chat event listeners
    sendChatBtn.addEventListener("click", sendChatMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });

    // Suggested questions event delegation
    suggestedQuestions.addEventListener("click", (e) => {
      if (e.target.classList.contains('suggested-question')) {
        const question = e.target.getAttribute('data-question');
        chatInput.value = question;
        sendChatMessage();
      }
    });

    // NEW: AI Quick Actions event delegation
    aiQuickActions.addEventListener("click", (e) => {
      const quickAction = e.target.closest('.ai-quick-action');
      if (quickAction) {
        const question = quickAction.getAttribute('data-question');
        chatInput.value = question;
        sendChatMessage();
      }
    });

    // Load COA data
    async function loadCOAData() {
      try {
        if (!currentUser) return;
        
        // Get account headers from chartOfAccounts collection
        const accountsQuery = query(
          collection(db, "users", currentUser.uid, "chartOfAccounts"), 
          where("userId", "==", currentUser.uid)
        );
        const accountsSnapshot = await getDocs(accountsQuery);
        
        coaAccounts = [];
        coaBanks = [];
        
        accountsSnapshot.forEach(doc => {
          const data = doc.data();
          coaAccounts.push(data.name);
          
          // Check if this is a bank account
          if (data.category === "Bank" || data.category === "Cash" || 
              data.type === "Asset" && data.name.toLowerCase().includes("bank")) {
            coaBanks.push(data.name);
          }
        });
        
        // If no accounts found, set default accounts
        if (coaAccounts.length === 0) {
          coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
        }
        
        if (coaBanks.length === 0) {
          coaBanks = ["AXIS", "BOM", "Cash"];
        }
        
        // Populate the dropdowns
        populateCOADropdowns();
        
      } catch (error) {
        console.warn('Error loading COA data:', error.message);
        // Use default accounts if COA is not available
        coaAccounts = ["Rent", "AXIS", "Amount Tally", "Meals & Entertainment", "BOM", "Fuel", "Shopping", "Miscellaneous"];
        coaBanks = ["AXIS", "BOM", "Cash"];
        populateCOADropdowns();
      }
    }
    
    function populateCOADropdowns() {
      // Clear existing options (except the first one)
      formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
      formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
      
      // Add account headers
      coaAccounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account;
        option.textContent = account;
        formACCOUNTHEADER.appendChild(option);
      });
      
      // Add bank names
      coaBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        formBANKNAME.appendChild(option);
        splitIncomeBank.appendChild(option.cloneNode(true));
        
        // Also add to bank filter
        const filterOption = document.createElement('option');
        filterOption.value = bank;
        filterOption.textContent = bank;
        bankFilter.appendChild(filterOption);
      });
    }

    // Optimized transaction loading with error handling
    async function loadTransactions() {
      try {
        transactionsTableBody.innerHTML = `<tr><td colspan="12" class="text-center py-4 small-muted">Loading transactions...</td></tr>`;
        
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"), 
          orderBy("createdAt", "desc")
        );
        
        const snap = await getDocs(q);
        const txs = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
          BANK_NAME: d.data().BANK_NAME || d.data().MODE || ""
        }));
        
        allTransactions = txs;
        filteredTransactions = allTransactions.slice();
        
        if (!hasLoadedSavedState) {
          currentPage = 1;
          gridCurrentPage = 1;
        }
        
        // Calculate running balance once for all transactions
        calculateRunningBalance();
        buildTable();
        updateStats();
        updateBankBalances();
        updateQuickStats();
        renderTransactionsChart();
        
        // Initialize voucher numbering (non-blocking)
        setTimeout(() => initVoucherNumbering(), 100);
        
        // NEW: Update other views
        updateGridView();
        updateCalendarView();
        
        return true;
      } catch (err) {
        console.error("loadTransactions error:", err);
        transactionsTableBody.innerHTML = `<tr><td colspan="12" class="text-center text-danger py-4">
          <i class="fa fa-exclamation-triangle me-2"></i>Failed to load transactions. Please try again.
        </td></tr>`;
        return false;
      }
    }

    async function initVoucherNumbering() {
      try {
        const q = query(
          collection(db, "users", currentUser.uid, "transactions"),
          orderBy("SINO", "desc"),
          limit(1)
        );
        const snap = await getDocs(q);
        
        if (!snap.empty) {
          const lastTx = snap.docs[0].data();
          if (lastTx.SINO) {
            const match = lastTx.SINO.match(/\d+$/);
            if (match) {
              lastVoucherNumber = parseInt(match[0]);
            }
          }
        }
      } catch (error) {
        console.error("Error initializing voucher numbering:", error);
      }
    }

    async function getNextVoucherNumber(voucherType) {
      try {
        // For better performance, use local allTransactions array
        let highestPaymentNumber = 0;
        let highestReceiptNumber = 0;
        let highestJournalNumber = 0;
        let highestTransferNumber = 0;
        
        // Find the highest numbers for each type from local data
        allTransactions.forEach(tx => {
          if (tx.SINO) {
            if (/^\d+$/.test(tx.SINO)) {
              const num = parseInt(tx.SINO);
              if (num > highestPaymentNumber) highestPaymentNumber = num;
            }
            else if (tx.SINO.startsWith('RP-')) {
              const num = parseInt(tx.SINO.substring(3));
              if (num > highestReceiptNumber) highestReceiptNumber = num;
            }
            else if (tx.SINO.startsWith('JR-')) {
              const num = parseInt(tx.SINO.substring(3));
              if (num > highestJournalNumber) highestJournalNumber = num;
            }
            else if (tx.SINO.startsWith('TR-')) {
              const num = parseInt(tx.SINO.substring(3));
              if (num > highestTransferNumber) highestTransferNumber = num;
            }
          }
        });
        
        // Generate the next number based on voucher type
        if (voucherType === "Payment") {
          return (highestPaymentNumber + 1).toString();
        } else if (voucherType === "Receipt") {
          return `RP-${(highestReceiptNumber + 1).toString().padStart(3, '0')}`;
        } else if (voucherType === "Journal") {
          return `JR-${(highestJournalNumber + 1).toString().padStart(3, '0')}`;
        } else if (voucherType === "Transfer") {
          return `TR-${(highestTransferNumber + 1).toString().padStart(3, '0')}`;
        }
        
        return `${voucherType.substring(0, 2).toUpperCase()}-001`;
        
      } catch (error) {
        console.error("Error getting voucher number:", error);
        // Fallback based on type
        if (voucherType === "Payment") {
          const paymentNumbers = allTransactions
            .filter(tx => tx.SINO && /^\d+$/.test(tx.SINO))
            .map(tx => parseInt(tx.SINO))
            .filter(num => !isNaN(num));
          
          const highestNumber = paymentNumbers.length > 0 ? Math.max(...paymentNumbers) : 0;
          return (highestNumber + 1).toString();
        } else if (voucherType === "Receipt") {
          return "RP-001";
        } else if (voucherType === "Journal") {
          return "JR-001";
        } else if (voucherType === "Transfer") {
          return "TR-001";
        }
        
        return `${voucherType.substring(0, 2).toUpperCase()}-001`;
      }
    }

    function calculateRunningBalance() {
      const sortedTransactions = [...allTransactions].sort((a, b) => {
        return new Date(a.DATE) - new Date(b.DATE);
      });
      
      let runningBalance = 0;
      
      sortedTransactions.forEach(tx => {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        runningBalance += (income - expense);
        tx.BALANCE = runningBalance;
      });
      
      return sortedTransactions;
    }

    function calculateBankBalances() {
      const bankBalances = {};
      
      coaBanks.forEach(bank => {
        bankBalances[bank] = 0;
      });
      
      allTransactions.forEach(tx => {
        const bankName = tx.BANK_NAME || tx.MODE || "";
        if (bankName && coaBanks.includes(bankName)) {
          const income = parseFloat(tx.INCOME) || 0;
          const expense = parseFloat(tx.EXPENSE) || 0;
          bankBalances[bankName] += (income - expense);
        }
      });
      
      return bankBalances;
    }
    
    function updateBankBalances() {
      const bankBalances = calculateBankBalances();
      
      bankBalancesContainer.innerHTML = "";
      
      // Add cash balance
      let hasCash = false;
      allTransactions.forEach(tx => {
        if ((tx.BANK_NAME === "Cash" || tx.MODE === "Cash") && !coaBanks.includes("Cash")) {
          hasCash = true;
        }
      });
      
      if (hasCash) {
        let cashBalance = 0;
        allTransactions.forEach(tx => {
          if (tx.BANK_NAME === "Cash" || tx.MODE === "Cash") {
            const income = parseFloat(tx.INCOME) || 0;
            const expense = parseFloat(tx.EXPENSE) || 0;
            cashBalance += (income - expense);
          }
        });
        
        const cashItem = document.createElement("div");
        cashItem.className = "bank-balance-item";
        cashItem.innerHTML = `
          <div class="bank-balance-name">Cash</div>
          <div class="bank-balance-value ${cashBalance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? `$${cashBalance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(cashItem);
        
        cashItem.querySelector('.balance-toggle').addEventListener('click', () => {
          balanceVisible = !balanceVisible;
          updateBalanceVisibility();
        });
      }
      
      // Add bank balances
      Object.entries(bankBalances).forEach(([bankName, balance]) => {
        const bankItem = document.createElement("div");
        bankItem.className = "bank-balance-item";
        bankItem.innerHTML = `
          <div class="bank-balance-name">${escapeHtml(bankName)}</div>
          <div class="bank-balance-value ${balance >= 0 ? 'positive-balance' : 'negative-balance'}">
            ${balanceVisible ? `$${balance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
          </div>
          <button class="balance-toggle" title="Toggle balance visibility">
            <i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
        `;
        bankBalancesContainer.appendChild(bankItem);
        
        bankItem.querySelector('.balance-toggle').addEventListener('click', () => {
          balanceVisible = !balanceVisible;
          updateBalanceVisibility();
        });
      });
    }
    
    function updateBalanceVisibility() {
      const totalIncome = allTransactions.reduce((s,t)=> s + (parseFloat(t.INCOME)||0), 0);
      const totalExpense = allTransactions.reduce((s,t)=> s + (parseFloat(t.EXPENSE)||0), 0);
      const balance = totalIncome - totalExpense;
      
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      statBalance.classList.toggle('balance-hidden', !balanceVisible);
      
      balanceToggle.innerHTML = `<i class="fa ${balanceVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>`;
      
      updateBankBalances();
    }

    function updateQuickStats() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      const monthlyIncome = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = allTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
        
      const totalAmount = allTransactions.reduce((sum, tx) => {
        const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        return sum + amount;
      }, 0);
      
      const avgTransaction = allTransactions.length > 0 ? totalAmount / allTransactions.length : 0;
      
      const incomeCount = allTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = allTransactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = allTransactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      quickStatsContainer.innerHTML = `
        <div class="quick-stat">
          <i class="fa fa-arrow-up text-success"></i>
          <span>Monthly Income: <strong>$${monthlyIncome.toFixed(2)}</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-arrow-down text-danger"></i>
          <span>Monthly Expenses: <strong>$${monthlyExpenses.toFixed(2)}</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-chart-line text-info"></i>
          <span>Avg Transaction: <strong>$${avgTransaction.toFixed(2)}</strong></span>
        </div>
        <div class="quick-stat">
          <i class="fa fa-list text-primary"></i>
          <span>Transactions: <strong>${incomeCount}/${expenseCount}/${transferCount}</strong></span>
        </div>
      `;
    }
    
    function renderTransactionsChart() {
      if (transactionsChartInstance) {
        transactionsChartInstance.destroy();
      }
      
      const monthlyData = {};
      allTransactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = { income: 0, expense: 0, transfer: 0 };
          }
          
          if (tx.TYPE === 'Income') {
            monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
          } else if (tx.TYPE === 'Expense') {
            monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
          } else if (tx.TYPE === 'Transfer') {
            monthlyData[monthYear].transfer += (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          }
        }
      });
      
      const sortedMonths = Object.keys(monthlyData).sort();
      
      const incomeData = sortedMonths.map(month => monthlyData[month].income);
      const expenseData = sortedMonths.map(month => monthlyData[month].expense);
      const transferData = sortedMonths.map(month => monthlyData[month].transfer);
      
      const monthLabels = sortedMonths.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        return date.toLocaleString('default', { month: 'short', year: 'numeric' });
      });
      
      const ctx = transactionsChart.getContext('2d');
      transactionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              backgroundColor: 'rgba(25, 135, 84, 0.7)',
              borderColor: 'rgba(25, 135, 84, 1)',
              borderWidth: 1
            },
            {
              label: 'Expenses',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.7)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Transfers',
              data: transferData,
              backgroundColor: 'rgba(13, 202, 240, 0.7)',
              borderColor: 'rgba(13, 202, 240, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Monthly Income vs Expenses vs Transfers'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': $' + context.raw.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    function applyFilters(){
      filteredTransactions = allTransactions.slice();
      const now = new Date();

      function inRange(dateStr, start, end){
        if (!dateStr) return false;
        const d = new Date(dateStr);
        return d >= start && d <= end;
      }

      // Date filter
      if (dateFilter.value !== "all") {
        let start, end;
        switch (dateFilter.value) {
          case "today":
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            break;
          case "week":
            const day = now.getDay();
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (6 - day) + 1);
            break;
          case "month":
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            break;
          case "year":
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear() + 1, 0, 1);
            break;
          case "custom":
            if (startDateInput.value && endDateInput.value) {
              start = new Date(startDateInput.value);
              end = new Date(endDateInput.value);
              end.setDate(end.getDate() + 1);
            }
            break;
        }
        if (start && end) {
          filteredTransactions = filteredTransactions.filter(t => inRange(t.DATE, start, end));
        }
      }

      // Type filter
      if (typeFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => t.TYPE === typeFilter.value);
      }

      // Bank filter
      if (bankFilter.value !== "all") {
        filteredTransactions = filteredTransactions.filter(t => 
          (t.BANK_NAME || t.MODE || "") === bankFilter.value
        );
      }

      // Search filter
      if (searchDesc.value.trim()) {
        const term = searchDesc.value.trim().toLowerCase();
        filteredTransactions = filteredTransactions.filter(t => 
          (t.DESCRIPTION || "").toLowerCase().includes(term) ||
          (t.NOTES || "").toLowerCase().includes(term) ||
          (t.ACCOUNT_HEADER || "").toLowerCase().includes(term) ||
          (t.BANK_NAME || "").toLowerCase().includes(term)
        );
      }
      
      // Amount filters
      if (minAmount.value) {
        const min = parseFloat(minAmount.value);
        filteredTransactions = filteredTransactions.filter(t => {
          const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
          return amount >= min;
        });
      }
      
      if (maxAmount.value) {
        const max = parseFloat(maxAmount.value);
        filteredTransactions = filteredTransactions.filter(t => {
          const amount = (parseFloat(t.INCOME) || 0) + (parseFloat(t.EXPENSE) || 0);
          return amount <= max;
        });
      }
      
      // Sorting
      switch (sortBy.value) {
        case "date-asc":
          filteredTransactions.sort((a, b) => new Date(a.DATE) - new Date(b.DATE));
          break;
        case "amount-desc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountB - amountA;
          });
          break;
        case "amount-asc":
          filteredTransactions.sort((a, b) => {
            const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
            const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
            return amountA - amountB;
          });
          break;
        default: // date-desc
          filteredTransactions.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
          break;
      }

      currentPage = 1;
      gridCurrentPage = 1;
      buildTable();
      updateStats();
      
      // NEW: Update other views
      updateGridView();
      updateCalendarView();
      updateViewInfo();
      
      saveAppState();
    }

    // Optimized table building
    function buildTable(){
      if (filteredTransactions.length === 0) {
        transactionsTableBody.innerHTML = `<tr><td colspan="12" class="text-center text-muted py-4">No transactions match your filters.</td></tr>`;
        paginationControls.innerHTML = "";
        return;
      }

      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

      let html = "";
      pageTransactions.forEach(tx => {
        const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        const balance = parseFloat(tx.BALANCE) || 0;
        const isSelected = selectedTransactions.has(tx.id);
        
        const incomeDisplay = income > 0 ? `<span class="income-color">$${income.toFixed(2)}</span>` : "$0.00";
        const expenseDisplay = expense > 0 ? `<span class="expense-color">$${expense.toFixed(2)}</span>` : "$0.00";
        const balanceDisplay = balanceVisible ? `$${balance.toFixed(2)}` : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        
        let badgeClass = '';
        if (tx.TYPE === 'Income') badgeClass = 'badge-income';
        else if (tx.TYPE === 'Expense') badgeClass = 'badge-expense';
        else if (tx.TYPE === 'Transfer') badgeClass = 'badge-transfer';
        
        html += `
          <tr class="${isSelected ? 'selected' : ''}">
            <td>
              <input type="checkbox" class="transaction-checkbox row-checkbox" data-id="${tx.id}" ${isSelected ? 'checked' : ''}>
            </td>
            <td>${escapeHtml(date)}</td>
            <td>${escapeHtml(tx.ACCOUNT_HEADER || "-")}</td>
            <td>${escapeHtml(tx.DESCRIPTION || tx.NOTES || "")}</td>
            <td><span class="badge ${badgeClass}">${escapeHtml(tx.TYPE)}</span></td>
            <td>${escapeHtml(tx.SINO || "")}</td>
            <td>${escapeHtml(tx.BANK_NAME || tx.MODE || "")}</td>
            <td style="text-align:right;">${incomeDisplay}</td>
            <td style="text-align:right;">${expenseDisplay}</td>
            <td style="text-align:right;">${balanceDisplay}</td>
            <td>
              ${
                tx.ATTACHMENT
                  ? `<button class="btn btn-sm btn-outline-primary view-attachment" data-attachment="${escapeHtml(tx.ATTACHMENT)}">
                      <i class="fa fa-paperclip"></i> View
                    </button>`
                  : `<span class="text-muted">None</span>`
              }
            </td>
            <td>
              <div class="d-flex gap-1">
                <button class="action-btn btn-view view-tx" data-id="${tx.id}"><i class="fa fa-eye"></i></button>
                <button class="action-btn btn-edit edit-tx" data-id="${tx.id}"><i class="fa fa-edit"></i></button>
                <button class="action-btn btn-del delete-tx" data-id="${tx.id}"><i class="fa fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `;
      });
      
      transactionsTableBody.innerHTML = html;

      // Add event listeners with event delegation for better performance
      transactionsTableBody.addEventListener("click", function(e) {
        const target = e.target;
        const button = target.closest("button");
        
        if (!button) return;
        
        if (button.classList.contains("view-tx")) {
          const id = button.getAttribute("data-id");
          viewTransaction(id);
        } else if (button.classList.contains("edit-tx")) {
          const id = button.getAttribute("data-id");
          editTransaction(id);
        } else if (button.classList.contains("delete-tx")) {
          const id = button.getAttribute("data-id");
          confirmDelete(id);
        } else if (button.classList.contains("view-attachment")) {
          const attachment = button.getAttribute("data-attachment");
          viewAttachment(attachment);
        }
      });

      // Checkbox event delegation
      transactionsTableBody.addEventListener("change", function(e) {
        if (e.target.classList.contains("row-checkbox")) {
          const id = e.target.getAttribute("data-id");
          const row = e.target.closest("tr");
          
          if (e.target.checked) {
            selectedTransactions.add(id);
            row.classList.add("selected");
          } else {
            selectedTransactions.delete(id);
            row.classList.remove("selected");
            selectAllCheckbox.checked = false;
          }
          
          updateBulkActions();
        }
      });

      // Build pagination
      buildPagination();
    }

    function buildPagination() {
      const totalPages = Math.ceil(filteredTransactions.length / rowsPerPage);
      if (totalPages <= 1) {
        paginationControls.innerHTML = "";
        return;
      }

      let html = `<nav><ul class="pagination pagination-sm">`;

      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>
      `;

      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>
      `;

      paginationControls.innerHTML = html;

      // Event delegation for pagination
      paginationControls.addEventListener("click", function(e) {
        const link = e.target.closest(".page-link");
        if (link) {
          e.preventDefault();
          const page = parseInt(link.getAttribute("data-page"));
          if (page && page !== currentPage && page > 0 && page <= totalPages) {
            currentPage = page;
            buildTable();
            saveAppState();
          }
        }
      });
    }

    function updateStats(){
      const totalIncome = filteredTransactions.reduce((s, t) => s + (parseFloat(t.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((s, t) => s + (parseFloat(t.EXPENSE) || 0), 0);
      const balance = totalIncome - totalExpense;
      
      statIncome.textContent = `$${totalIncome.toFixed(2)}`;
      statExpense.textContent = `$${totalExpense.toFixed(2)}`;
      statBalance.textContent = balanceVisible ? `$${balance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      statCount.textContent = filteredTransactions.length;
      
      statIncome.className = "stat-value income-color";
      statExpense.className = "stat-value expense-color";
    }

    // Optimized modal opening
    async function openAddModal(){
      showLoading("Loading form...");
      
      try {
        txIdInput.value = "";
        form.reset();
        formDATE.value = new Date().toISOString().split('T')[0];
        formTYPE.value = "Income";
        formVOUCHERTYPE.value = "Payment";
        formTIME.disabled = true;
        includeTimeCheckbox.checked = false;
        formCURRENCY.value = "USD";
        
        // Generate voucher number (non-blocking)
        const voucherNumber = await getNextVoucherNumber(formVOUCHERTYPE.value);
        formSINO.value = voucherNumber;
        
        formINCOME.value = "";
        formEXPENSE.value = "";
        formBALANCE.value = "";
        formNOTES.value = "";
        formDESCRIPTION.value = "";
        formATTACH.value = "";
        attachmentPreview.style.display = "none";
        attachmentInfo.textContent = "";
        uploadProgress.style.display = "none";
        
        Array.from(form.elements).forEach(el => el.disabled = false);
        formTIME.disabled = true;
        saveTransactionBtn.style.display = "block";
        saveTransactionBtn.disabled = false;
        saveTransactionBtn.innerHTML = 'Save Transaction';

        formVOUCHERTYPE.addEventListener("change", async function() {
          if (!txIdInput.value) {
            formSINO.value = await getNextVoucherNumber(this.value);
          }
        }, { once: true });
        
        setupIncomeExpenseBehavior();
        
        document.getElementById("transactionModalLabel").textContent = "Add Transaction";
        
        // Hide loading and show modal
        setTimeout(() => {
          hideLoading();
          transactionModal.show();
        }, 100);
        
      } catch (error) {
        hideLoading();
        console.error("Error opening modal:", error);
        Swal.fire({ 
          icon: 'error', 
          title: 'Error', 
          text: 'Failed to load form. Please try again.' 
        });
      }
    }

    function viewTransaction(id){
      const tx = allTransactions.find(t => t.id === id);
      if (!tx) return;
      
      showLoading("Loading transaction...");
      
      setTimeout(() => {
        txIdInput.value = tx.id;
        formDATE.value = tx.DATE || "";
        formSINO.value = tx.SINO || "";
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
        formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
        formTYPE.value = tx.TYPE || "Income";
        formBANKNAME.value = tx.BANK_NAME || tx.MODE || "";
        formINCOME.value = tx.INCOME || "";
        formEXPENSE.value = tx.EXPENSE || "";
        formBALANCE.value = tx.BALANCE || "";
        formNOTES.value = tx.NOTES || "";
        formDESCRIPTION.value = tx.DESCRIPTION || "";
        formCURRENCY.value = tx.CURRENCY || "USD";
        
        if (tx.TIME) {
          formTIME.value = tx.TIME;
          includeTimeCheckbox.checked = true;
          formTIME.disabled = false;
        } else {
          formTIME.value = "";
          includeTimeCheckbox.checked = false;
          formTIME.disabled = true;
        }
        
        if (tx.ATTACHMENT) {
          attachmentInfo.textContent = "Attachment: " + tx.ATTACHMENT;
        } else {
          attachmentInfo.textContent = "";
        }
        
        document.getElementById("transactionModalLabel").textContent = "View Transaction";
        
        Array.from(form.elements).forEach(el => el.disabled = true);
        saveTransactionBtn.style.display = "none";
        
        hideLoading();
        transactionModal.show();
      }, 100);
    }

    function editTransaction(id){
      const tx = allTransactions.find(t => t.id === id);
      if (!tx) return;
      
      showLoading("Loading transaction...");
      
      setTimeout(() => {
        txIdInput.value = tx.id;
        formDATE.value = tx.DATE || "";
        formSINO.value = tx.SINO || "";
        formACCOUNTHEADER.value = tx.ACCOUNT_HEADER || "";
        formVOUCHERTYPE.value = tx.VOUCHER_TYPE || "Payment";
        formTYPE.value = tx.TYPE || "Income";
        formBANKNAME.value = tx.BANK_NAME || tx.MODE || "";
        formINCOME.value = tx.INCOME || "";
        formEXPENSE.value = tx.EXPENSE || "";
        formBALANCE.value = tx.BALANCE || "";
        formNOTES.value = tx.NOTES || "";
        formDESCRIPTION.value = tx.DESCRIPTION || "";
        formCURRENCY.value = tx.CURRENCY || "USD";
        
        if (tx.TIME) {
          formTIME.value = tx.TIME;
          includeTimeCheckbox.checked = true;
          formTIME.disabled = false;
        } else {
          formTIME.value = "";
          includeTimeCheckbox.checked = false;
          formTIME.disabled = true;
        }
        
        if (tx.ATTACHMENT) {
          attachmentInfo.textContent = "Current: " + tx.ATTACHMENT;
        } else {
          attachmentInfo.textContent = "";
        }
        
        setupIncomeExpenseBehavior();
        
        document.getElementById("transactionModalLabel").textContent = "Edit Transaction";
        
        Array.from(form.elements).forEach(el => el.disabled = false);
        formTIME.disabled = !includeTimeCheckbox.checked;
        saveTransactionBtn.style.display = "block";
        saveTransactionBtn.disabled = false;
        saveTransactionBtn.innerHTML = 'Save Transaction';
        
        hideLoading();
        transactionModal.show();
      }, 100);
    }

    function confirmDelete(id){
      txToDelete = id;
      confirmDeleteModal.show();
    }

    function resetSaveButton() {
      isSubmitting = false;
      saveTransactionBtn.disabled = false;
      saveTransactionBtn.innerHTML = 'Save Transaction';
    }

    // File attachment handling
    formATTACHFILE.addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;
      
      if (file.size > 10 * 1024 * 1024) {
        Swal.fire({ icon: 'error', title: 'File too large', text: 'Please select a file smaller than 10MB' });
        this.value = '';
        return;
      }

      // Use local storage for demo if Cloudinary not configured
      if (file.size < 2 * 1024 * 1024) { // Less than 2MB
        try {
          uploadProgress.style.display = "block";
          uploadProgressBar.style.width = "0%";
          
          // Simulate upload progress
          for (let i = 0; i <= 100; i += 10) {
            setTimeout(() => {
              uploadProgressBar.style.width = `${i}%`;
            }, i * 20);
          }
          
          setTimeout(() => {
            const reader = new FileReader();
            reader.onload = function(e) {
              formATTACH.value = "data:" + file.type + ";base64," + btoa(e.target.result);
              attachmentInfo.textContent = "Uploaded: " + file.name;
              
              if (file.type.startsWith('image/')) {
                attachmentPreview.src = URL.createObjectURL(file);
                attachmentPreview.style.display = "block";
              } else {
                attachmentPreview.style.display = "none";
              }
              
              uploadProgress.style.display = "none";
            };
            reader.readAsBinaryString(file);
          }, 500);
          
        } catch (err) {
          console.error("Upload failed", err);
          uploadProgress.style.display = "none";
          Swal.fire({ 
            icon: 'error', 
            title: 'Upload failed', 
            text: 'Could not upload attachment' 
          });
          this.value = '';
        }
      } else {
        Swal.fire({ 
          icon: 'info', 
          title: 'Large File', 
          text: 'For large files, please configure Cloudinary for proper file uploads.' 
        });
      }
    });

    function viewAttachment(attachmentUrl) {
      if (!attachmentUrl) return;

      const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(attachmentUrl) || attachmentUrl.startsWith('data:image');
      const isPDF = /\.(pdf)$/i.test(attachmentUrl);
      const isDocument = /\.(doc|docx|xls|xlsx|txt)$/i.test(attachmentUrl);

      attachmentModalBody.innerHTML = `
        <div class="mb-3">
          <h6>Attachment Preview</h6>
          ${isImage 
            ? `<img src="${attachmentUrl}" class="img-fluid" style="max-height: 400px;" />`
            : isPDF
              ? `<iframe src="${attachmentUrl}" width="100%" height="400px"></iframe>`
              : isDocument
                ? `<div class="alert alert-info">Document files can be downloaded but not previewed</div>`
                : `<div class="alert alert-info">File type not supported for preview</div>`
          }
        </div>
        <div>
          <a class="btn btn-primary" href="${attachmentUrl}" download target="_blank">
            <i class="fa fa-download me-1"></i> Download
          </a>
        </div>
      `;

      attachmentModal.show();
    }

    // Setup income/expense behavior
    function setupIncomeExpenseBehavior() {
      const typeSelect = document.getElementById("formTYPE");
      const incomeInput = document.getElementById("formINCOME");
      const expenseInput = document.getElementById("formEXPENSE");
      
      function updateFieldVisibility() {
        if (typeSelect.value === "Income") {
          incomeInput.disabled = false;
          expenseInput.disabled = true;
          expenseInput.value = "";
        } else if (typeSelect.value === "Expense") {
          incomeInput.disabled = true;
          incomeInput.value = "";
          expenseInput.disabled = false;
        } else if (typeSelect.value === "Transfer") {
          incomeInput.disabled = false;
          expenseInput.disabled = false;
        } else {
          incomeInput.disabled = false;
          expenseInput.disabled = false;
        }
      }
      
      updateFieldVisibility();
      typeSelect.addEventListener("change", updateFieldVisibility);
    }

    // Quick Add processing
    async function processQuickAdd() {
      const text = quickAddInput.value.trim();
      if (!text) {
        Swal.fire({ icon: 'warning', title: 'Input required', text: 'Please enter a transaction description' });
        return;
      }

      try {
        loadingMessage.textContent = "Processing your request...";
        loadingModal.show();
        
        const parsedData = parseQuickAddInput(text);
        
        if (!parsedData.amount) {
          loadingModal.hide();
          Swal.fire({ icon: 'warning', title: 'Invalid Input', text: 'Could not detect an amount in your input' });
          return;
        }

        const txData = {
          DATE: parsedData.date || new Date().toISOString().split('T')[0],
          SINO: "",
          ACCOUNT_HEADER: parsedData.accountHeader,
          BANK_NAME: parsedData.bankName,
          MODE: parsedData.bankName,
          VOUCHER_TYPE: parsedData.voucherType,
          TYPE: parsedData.type,
          INCOME: parsedData.type === "Income" ? parsedData.amount : 0,
          EXPENSE: parsedData.type === "Expense" ? parsedData.amount : 0,
          BALANCE: 0,
          DESCRIPTION: parsedData.description,
          NOTES: "Quick add transaction",
          CURRENCY: "USD",
          createdAt: new Date(),
          userId: currentUser.uid
        };

        if (parsedData.type === "Transfer") {
          const fromTx = {
            ...txData,
            SINO: await getNextVoucherNumber("Transfer"),
            ACCOUNT_HEADER: parsedData.fromBank,
            BANK_NAME: parsedData.fromBank,
            MODE: parsedData.fromBank,
            EXPENSE: parsedData.amount,
            INCOME: 0,
            DESCRIPTION: `Transfer to ${parsedData.toBank}`
          };
          
          const toTx = {
            ...txData,
            SINO: await getNextVoucherNumber("Transfer"),
            ACCOUNT_HEADER: parsedData.toBank,
            BANK_NAME: parsedData.toBank,
            MODE: parsedData.toBank,
            INCOME: parsedData.amount,
            EXPENSE: 0,
            DESCRIPTION: `Transfer from ${parsedData.fromBank}`
          };
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), fromTx);
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), toTx);
          
          loadingModal.hide();
          Swal.fire({ icon: 'success', title: 'Success', text: 'Transfer completed successfully' });
        } else {
          const voucherNumber = await getNextVoucherNumber(parsedData.voucherType);
          txData.SINO = voucherNumber;
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
          loadingModal.hide();
          Swal.fire({ icon: 'success', title: 'Success', text: 'Transaction added successfully' });
        }
        
        quickAddModal.hide();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("Quick add error", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add transaction' });
      }
    }

    function parseQuickAddInput(text) {
      const lowerText = text.toLowerCase();
      let amount = 0;
      let type = "";
      let accountHeader = "";
      let bankName = "";
      let description = text;
      let date = null;
      let fromBank = "";
      let toBank = "";
      
      const amountMatch = text.match(/(\d+)(\.\d+)?/);
      if (amountMatch) {
        amount = parseFloat(amountMatch[0]);
      }
      
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (lowerText.includes('today')) {
        date = today.toISOString().split('T')[0];
      } else if (lowerText.includes('yesterday')) {
        date = yesterday.toISOString().split('T')[0];
      } else {
        const relativeDateMatch = lowerText.match(/(\d+) days? ago/);
        if (relativeDateMatch) {
          const daysAgo = parseInt(relativeDateMatch[1]);
          const pastDate = new Date(today);
          pastDate.setDate(pastDate.getDate() - daysAgo);
          date = pastDate.toISOString().split('T')[0];
        }
        
        const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
        for (let i = 0; i < monthNames.length; i++) {
          if (lowerText.includes(monthNames[i])) {
            const dayMatch = lowerText.match(/(\d+)(?:st|nd|rd|th)?/);
            if (dayMatch) {
              const day = parseInt(dayMatch[1]);
              const year = today.getFullYear();
              const month = i;
              date = new Date(year, month, day).toISOString().split('T')[0];
              break;
            }
          }
        }
      }

      if (lowerText.includes('transfer') && lowerText.includes('from') && lowerText.includes('to')) {
        type = "Transfer";
        const transferMatch = lowerText.match(/transfer.*?(\d+).*?from (.*?) to (.*)/);
        if (transferMatch) {
          amount = parseFloat(transferMatch[1]);
          fromBank = findMatchingBank(transferMatch[2]);
          toBank = findMatchingBank(transferMatch[3]);
          description = `Transfer from ${fromBank} to ${toBank}`;
        }
      } else if (lowerText.includes('add') || lowerText.includes('receive') || lowerText.includes('income') || 
          lowerText.includes('deposit') || lowerText.includes('credit')) {
        type = "Income";
      } else if (lowerText.includes('spent') || lowerText.includes('spend') || lowerText.includes('pay') || 
                 lowerText.includes('expense') || lowerText.includes('debit') || lowerText.includes('withdraw')) {
        type = "Expense";
      }

      if (type !== "Transfer") {
        for (const bank of coaBanks) {
          if (lowerText.includes(bank.toLowerCase())) {
            bankName = bank;
            break;
          }
        }

        for (const account of coaAccounts) {
          if (lowerText.includes(account.toLowerCase())) {
            accountHeader = account;
            break;
          }
        }

        if (!accountHeader) {
          if (lowerText.includes('petrol') || lowerText.includes('fuel') || lowerText.includes('gas')) {
            accountHeader = "Fuel";
          } else if (lowerText.includes('food') || lowerText.includes('meal') || lowerText.includes('restaurant')) {
            accountHeader = "Meals & Entertainment";
          } else if (lowerText.includes('rent') || lowerText.includes('house') || lowerText.includes('apartment')) {
            accountHeader = "Rent";
          } else if (lowerText.includes('shopping') || lowerText.includes('store') || lowerText.includes('buy')) {
            accountHeader = "Shopping";
          } else if (bankName) {
            accountHeader = bankName;
          } else {
            accountHeader = "Miscellaneous";
          }
        }

        if (!bankName && lowerText.includes('cash')) {
          bankName = "Cash";
        }
      }

      let voucherType = "Payment";
      if (type === "Income") voucherType = "Receipt";
      else if (type === "Transfer") voucherType = "Transfer";

      return {
        amount,
        type,
        accountHeader,
        bankName,
        description,
        date,
        voucherType,
        fromBank,
        toBank
      };
    }

    function findMatchingBank(bankText) {
      for (const bank of coaBanks) {
        if (bank.toLowerCase().includes(bankText.trim()) || bankText.trim().includes(bank.toLowerCase())) {
          return bank;
        }
      }
      return bankText;
    }

    // Theme functions
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      localStorage.setItem('theme', currentTheme);
      
      if (transactionsChartInstance) {
        renderTransactionsChart();
      }
      
      // NEW: Reinitialize calendar with new theme
      if (calendar) {
        calendar.destroy();
        initializeCalendar();
      }
    }
    
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
      }
    }
    
    // Export functions
    function exportToCSV() {
      if (filteredTransactions.length === 0) {
        Swal.fire({ icon: 'warning', title: 'No Data', text: 'There are no transactions to export.' });
        return;
      }
      
      const headers = ['Date', 'Account Header', 'Description', 'Type', 'Voucher #', 'Bank Name', 'Income', 'Expense', 'Balance', 'Currency'];
      
      let csvContent = headers.join(',') + '\n';
      
      filteredTransactions.forEach(tx => {
        const row = [
          tx.DATE || '',
          tx.ACCOUNT_HEADER || '',
          `"${(tx.DESCRIPTION || tx.NOTES || '').replace(/"/g, '""')}"`,
          tx.TYPE || '',
          tx.SINO || '',
          tx.BANK_NAME || tx.MODE || '',
          tx.INCOME || 0,
          tx.EXPENSE || 0,
          tx.BALANCE || 0,
          tx.CURRENCY || ''
        ];
        csvContent += row.join(',') + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `transactions_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function exportToPDF() {
      Swal.fire({ icon: 'info', title: 'PDF Export', text: 'PDF export functionality would typically require a library like jsPDF or browser print functionality.' });
      window.print();
    }
    
    // Save/Load app state
    function saveAppState() {
      const state = {
        currentPage: currentPage,
        gridCurrentPage: gridCurrentPage,
        dateFilter: dateFilter.value,
        typeFilter: typeFilter.value,
        bankFilter: bankFilter.value,
        searchDesc: searchDesc.value,
        startDate: startDateInput.value,
        endDate: endDateInput.value,
        minAmount: minAmount.value,
        maxAmount: maxAmount.value,
        sortBy: sortBy.value,
        balanceVisible: balanceVisible,
        theme: currentTheme,
        currentView: currentView // NEW: Save current view
      };
      localStorage.setItem('budgetAppState', JSON.stringify(state));
    }

    function loadAppState() {
      const savedState = localStorage.getItem('budgetAppState');
      if (savedState) {
        const state = JSON.parse(savedState);
        currentPage = state.currentPage || 1;
        gridCurrentPage = state.gridCurrentPage || 1;
        dateFilter.value = state.dateFilter || "all";
        typeFilter.value = state.typeFilter || "all";
        bankFilter.value = state.bankFilter || "all";
        searchDesc.value = state.searchDesc || "";
        startDateInput.value = state.startDate || "";
        endDateInput.value = state.endDate || "";
        minAmount.value = state.minAmount || "";
        maxAmount.value = state.maxAmount || "";
        sortBy.value = state.sortBy || "date-desc";
        balanceVisible = state.balanceVisible || false;
        
        // NEW: Load current view
        currentView = state.currentView || 'table';
        
        if (state.theme) {
          currentTheme = state.theme;
          document.documentElement.setAttribute('data-theme', currentTheme);
          themeToggle.innerHTML = currentTheme === 'light' ? '<i class="fa fa-moon"></i>' : '<i class="fa fa-sun"></i>';
        }
        
        if (dateFilter.value === "custom") {
          customRangeControls.style.display = "flex";
        }
        updateBalanceVisibility();
        
        // NEW: Switch to saved view
        switchView(currentView);
        
        hasLoadedSavedState = true;
      }
    }
    
    // Initialize with balance hidden
    updateBalanceVisibility();

    function formatDateToYyyyMmmDd(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.toLocaleString('default', { month: 'short' });
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Multiple Selection Functions
    function selectAllTransactions() {
      const pageTransactions = filteredTransactions.slice(
        (currentPage - 1) * rowsPerPage,
        currentPage * rowsPerPage
      );
      
      pageTransactions.forEach(tx => {
        selectedTransactions.add(tx.id);
      });
      
      buildTable();
      updateBulkActions();
    }

    function deselectAllTransactions() {
      selectedTransactions.clear();
      buildTable();
      updateBulkActions();
    }

    function toggleSelectAll() {
      if (selectAllCheckbox.checked) {
        selectAllTransactions();
      } else {
        deselectAllTransactions();
      }
    }

    function clearSelection() {
      selectedTransactions.clear();
      buildTable();
      updateBulkActions();
    }

    function updateBulkActions() {
      const count = selectedTransactions.size;
      selectedCount.textContent = `${count} transaction${count !== 1 ? 's' : ''} selected`;
      
      if (count > 0) {
        bulkActions.classList.remove('hidden');
      } else {
        bulkActions.classList.add('hidden');
      }
    }

    function confirmBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      bulkDeleteCount.textContent = count;
      confirmBulkDeleteModal.show();
    }

    async function processBulkDelete() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      try {
        loadingMessage.textContent = `Deleting ${count} transactions...`;
        loadingModal.show();
        
        const deletePromises = Array.from(selectedTransactions).map(id => 
          deleteDoc(doc(db, "users", currentUser.uid, "transactions", id))
        );
        
        await Promise.all(deletePromises);
        
        loadingModal.hide();
        Swal.fire({ 
          icon: 'success', 
          title: 'Deleted', 
          text: `${count} transaction${count !== 1 ? 's' : ''} deleted successfully` 
        });
        
        selectedTransactions.clear();
        confirmBulkDeleteModal.hide();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("bulkDeleteTransactions", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete transactions' });
      }
    }

    function openBulkEditModal() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      bulkEditCount.textContent = count;
      bulkEditValue.value = "";
      bulkEditModal.show();
    }

    async function processBulkEdit() {
      const count = selectedTransactions.size;
      if (count === 0) return;
      
      const field = bulkEditField.value;
      const value = bulkEditValue.value.trim();
      
      if (!value) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a value' });
        return;
      }
      
      try {
        loadingMessage.textContent = `Updating ${count} transactions...`;
        loadingModal.show();
        
        const updatePromises = Array.from(selectedTransactions).map(id => {
          const updateData = {};
          updateData[field] = value;
          
          return updateDoc(doc(db, "users", currentUser.uid, "transactions", id), updateData);
        });
        
        await Promise.all(updatePromises);
        
        loadingModal.hide();
        Swal.fire({ 
          icon: 'success', 
          title: 'Updated', 
          text: `${count} transaction${count !== 1 ? 's' : ''} updated successfully` 
        });
        
        selectedTransactions.clear();
        bulkEditModal.hide();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("bulkEditTransactions", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update transactions' });
      }
    }

    // Split Income Functions
    function openSplitIncomeModal() {
      splitIncomeAmount.value = "";
      splitIncomeDescription.value = "";
      splitIncomeBank.value = "";
      splitExpensesContainer.innerHTML = "";
      splitSummary.innerHTML = "";
      
      addSplitExpense();
      
      splitIncomeModal.show();
    }

    function addSplitExpense() {
      const expenseId = 'expense-' + Date.now();
      const expenseHtml = `
        <div class="split-transaction-item" id="${expenseId}">
          <div class="split-header">
            <h6>Expense</h6>
            <button type="button" class="remove-split" onclick="removeSplitExpense('${expenseId}')">
              <i class="fa fa-times"></i>
            </button>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input type="number" step="0.01" class="form-control split-amount-input" placeholder="0.00" oninput="updateSplitSummary()">
            </div>
            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" class="form-control split-description-input" placeholder="Expense description">
            </div>
            <div class="col-md-4">
              <label class="form-label">Bank Account</label>
              <select class="form-select split-bank-input">
                <option value="">Select Bank</option>
                ${coaBanks.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-12">
              <label class="form-label">Account Header</label>
              <select class="form-select split-account-input">
                <option value="">Select Account Header</option>
                ${coaAccounts.map(account => `<option value="${account}">${account}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      `;
      
      splitExpensesContainer.insertAdjacentHTML('beforeend', expenseHtml);
      updateSplitSummary();
    }

    function removeSplitExpense(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
        updateSplitSummary();
      }
    }

    function updateSplitSummary() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      
      let totalExpenses = 0;
      expenseElements.forEach(element => {
        const amountInput = element.querySelector('.split-amount-input');
        const amount = parseFloat(amountInput.value) || 0;
        totalExpenses += amount;
      });
      
      const remaining = incomeAmount - totalExpenses;
      
      let summaryHtml = '';
      if (incomeAmount > 0) {
        summaryHtml = `
          <div class="d-flex justify-content-between">
            <span>Total Income:</span>
            <span>$${incomeAmount.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Total Expenses:</span>
            <span>$${totalExpenses.toFixed(2)}</span>
          </div>
          <div class="d-flex justify-content-between ${remaining >= 0 ? 'amount-remaining' : 'amount-exceeded'}">
            <span>Remaining:</span>
            <span>$${remaining.toFixed(2)}</span>
          </div>
        `;
        
        if (remaining < 0) {
          summaryHtml += `<div class="text-danger small mt-1">Warning: Expenses exceed income by $${Math.abs(remaining).toFixed(2)}</div>`;
        } else if (remaining > 0) {
          summaryHtml += `<div class="text-warning small mt-1">Note: $${remaining.toFixed(2)} of income not allocated</div>`;
        } else {
          summaryHtml += `<div class="text-success small mt-1">Perfect! All income allocated to expenses</div>`;
        }
      }
      
      splitSummary.innerHTML = summaryHtml;
    }

    async function saveSplitTransactions() {
      const incomeAmount = parseFloat(splitIncomeAmount.value) || 0;
      const incomeDescription = splitIncomeDescription.value.trim();
      const incomeBank = splitIncomeBank.value;
      
      if (!incomeAmount || incomeAmount <= 0) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter a valid income amount' });
        return;
      }
      
      if (!incomeDescription) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please enter an income description' });
        return;
      }
      
      if (!incomeBank) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please select an income bank account' });
        return;
      }
      
      const expenseElements = splitExpensesContainer.querySelectorAll('.split-transaction-item');
      if (expenseElements.length === 0) {
        Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'Please add at least one expense' });
        return;
      }
      
      let totalExpenses = 0;
      const expenses = [];
      
      for (const element of expenseElements) {
        const amountInput = element.querySelector('.split-amount-input');
        const descriptionInput = element.querySelector('.split-description-input');
        const bankInput = element.querySelector('.split-bank-input');
        const accountInput = element.querySelector('.split-account-input');
        
        const amount = parseFloat(amountInput.value) || 0;
        const description = descriptionInput.value.trim();
        const bank = bankInput.value;
        const account = accountInput.value;
        
        if (amount <= 0) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a positive amount' });
          return;
        }
        
        if (!description) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a description' });
          return;
        }
        
        if (!bank) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have a bank account selected' });
          return;
        }
        
        if (!account) {
          Swal.fire({ icon: 'warning', title: 'Validation Error', text: 'All expenses must have an account header selected' });
          return;
        }
        
        totalExpenses += amount;
        expenses.push({ amount, description, bank, account });
      }
      
      const remaining = incomeAmount - totalExpenses;
      if (remaining < 0) {
        const result = await Swal.fire({
          icon: 'warning',
          title: 'Expenses Exceed Income',
          text: `Your expenses ($${totalExpenses.toFixed(2)}) exceed your income ($${incomeAmount.toFixed(2)}) by $${Math.abs(remaining).toFixed(2)}. Do you want to continue?`,
          showCancelButton: true,
          confirmButtonText: 'Yes, Continue',
          cancelButtonText: 'No, Cancel'
        });
        
        if (!result.isConfirmed) {
          return;
        }
      }
      
      try {
        loadingMessage.textContent = "Saving split transactions...";
        loadingModal.show();
        
        const today = new Date().toISOString().split('T')[0];
        
        // Save income transaction
        const incomeVoucher = await getNextVoucherNumber("Receipt");
        const incomeData = {
          DATE: today,
          SINO: incomeVoucher,
          ACCOUNT_HEADER: "Income",
          BANK_NAME: incomeBank,
          MODE: incomeBank,
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: incomeAmount,
          EXPENSE: 0,
          BALANCE: 0,
          DESCRIPTION: incomeDescription,
          NOTES: "Split income transaction",
          CURRENCY: "USD",
          createdAt: new Date(),
          userId: currentUser.uid
        };
        
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), incomeData);
        
        // Save all expense transactions
        for (const expense of expenses) {
          const expenseVoucher = await getNextVoucherNumber("Payment");
          const expenseData = {
            DATE: today,
            SINO: expenseVoucher,
            ACCOUNT_HEADER: expense.account,
            BANK_NAME: expense.bank,
            MODE: expense.bank,
            VOUCHER_TYPE: "Payment",
            TYPE: "Expense",
            INCOME: 0,
            EXPENSE: expense.amount,
            BALANCE: 0,
            DESCRIPTION: expense.description,
            NOTES: "Split from income",
            CURRENCY: "USD",
            createdAt: new Date(),
            userId: currentUser.uid
          };
          
          await addDoc(collection(db, "users", currentUser.uid, "transactions"), expenseData);
        }
        
        loadingModal.hide();
        Swal.fire({ 
          icon: 'success', 
          title: 'Success', 
          text: `Created ${1 + expenses.length} transactions successfully` 
        });
        
        splitIncomeModal.hide();
        await loadTransactions();
      } catch (err) {
        loadingModal.hide();
        console.error("saveSplitTransactions", err);
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save transactions' });
      }
    }

    // NEW: View Switching Functions
    function switchView(view) {
      currentView = view;
      
      // Update button states
      tableViewBtn.classList.toggle('active', view === 'table');
      gridViewBtn.classList.toggle('active', view === 'grid');
      calendarViewBtn.classList.toggle('active', view === 'calendar');
      
      // Show/hide containers
      tableViewContainer.style.display = view === 'table' ? 'block' : 'none';
      gridViewContainer.style.display = view === 'grid' ? 'block' : 'none';
      calendarViewContainer.style.display = view === 'calendar' ? 'block' : 'none';
      
      // Show/hide pagination and controls
      paginationControls.style.display = view === 'table' ? 'flex' : 'none';
      gridControls.style.display = view === 'grid' ? 'flex' : 'none';
      gridPagination.style.display = view === 'grid' ? 'flex' : 'none';
      
      // Show/hide bulk actions (only for table view)
      bulkActions.style.display = view === 'table' ? 'flex' : 'none';
      
      // Initialize calendar if switching to calendar view
      if (view === 'calendar' && !calendar) {
        initializeCalendar();
      }
      
      // Update grid view if needed
      if (view === 'grid') {
        updateGridView();
      }
      
      // Update view info
      updateViewInfo();
      
      saveAppState();
    }
    
    // NEW: Grid View Functions
    function updateGridView() {
      if (currentView !== 'grid') return;
      
      if (filteredTransactions.length === 0) {
        gridViewContainer.innerHTML = `
          <div class="col-12 text-center text-muted py-5">
            <i class="fa fa-inbox fa-3x mb-3"></i>
            <h5>No transactions match your filters.</h5>
          </div>
        `;
        gridControls.style.display = 'none';
        gridPagination.style.display = 'none';
        return;
      }
      
      const startIndex = (gridCurrentPage - 1) * gridRowsPerPage;
      const endIndex = Math.min(startIndex + gridRowsPerPage, filteredTransactions.length);
      const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
      
      // Update grid controls
      gridResultsCount.textContent = `${filteredTransactions.length} transactions`;
      const totalGridPages = Math.ceil(filteredTransactions.length / gridRowsPerPage);
      gridPageInfo.textContent = `Page ${gridCurrentPage} of ${totalGridPages}`;
      gridPrevBtn.disabled = gridCurrentPage === 1;
      gridNextBtn.disabled = gridCurrentPage === totalGridPages;
      
      // Build grid cards
      let html = '';
      pageTransactions.forEach(tx => {
        const date = tx.DATE ? formatDateToYyyyMmmDd(tx.DATE) : "";
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        const amount = income > 0 ? income : expense;
        
        let typeClass = '';
        let typeText = '';
        if (tx.TYPE === 'Income') {
          typeClass = 'badge-income';
          typeText = 'Income';
        } else if (tx.TYPE === 'Expense') {
          typeClass = 'badge-expense';
          typeText = 'Expense';
        } else if (tx.TYPE === 'Transfer') {
          typeClass = 'badge-transfer';
          typeText = 'Transfer';
        }
        
        // Format time if available
        let timeDisplay = '';
        if (tx.TIME) {
          timeDisplay = `<div class="small text-muted">${tx.TIME}</div>`;
        }
        
        html += `
          <div class="transaction-card">
            <div class="transaction-card-header">
              <div>
                <div class="transaction-card-date">${escapeHtml(date)}</div>
                ${timeDisplay}
              </div>
              <div class="transaction-card-type ${typeClass}">${escapeHtml(typeText)}</div>
            </div>
            
            <div class="transaction-card-description">
              ${escapeHtml(tx.DESCRIPTION || tx.NOTES || "No description")}
            </div>
            
            <div class="transaction-card-details">
              <div class="transaction-card-detail">
                <span class="transaction-card-detail-label">Account:</span>
                <span class="transaction-card-detail-value">${escapeHtml(tx.ACCOUNT_HEADER || "-")}</span>
              </div>
              <div class="transaction-card-detail">
                <span class="transaction-card-detail-label">Bank:</span>
                <span class="transaction-card-detail-value">${escapeHtml(tx.BANK_NAME || tx.MODE || "-")}</span>
              </div>
              <div class="transaction-card-detail">
                <span class="transaction-card-detail-label">Voucher:</span>
                <span class="transaction-card-detail-value">${escapeHtml(tx.SINO || "-")}</span>
              </div>
              <div class="transaction-card-detail">
                <span class="transaction-card-detail-label">Type:</span>
                <span class="transaction-card-detail-value">${escapeHtml(tx.VOUCHER_TYPE || "-")}</span>
              </div>
            </div>
            
            <div class="transaction-card-amount ${tx.TYPE === 'Income' ? 'income-color' : 'expense-color'}">
              ${tx.TYPE === 'Income' ? '+' : '-'}$${amount.toFixed(2)}
              <div class="small text-muted">${tx.CURRENCY || 'USD'}</div>
            </div>
            
            <div class="transaction-card-actions">
              <button class="btn btn-sm btn-outline-info view-tx-grid" data-id="${tx.id}" title="View">
                <i class="fa fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-warning edit-tx-grid" data-id="${tx.id}" title="Edit">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger delete-tx-grid" data-id="${tx.id}" title="Delete">
                <i class="fa fa-trash"></i>
              </button>
              ${tx.ATTACHMENT ? 
                `<button class="btn btn-sm btn-outline-primary view-attachment-grid" data-attachment="${escapeHtml(tx.ATTACHMENT)}" title="Attachment">
                  <i class="fa fa-paperclip"></i>
                </button>` 
                : ''
              }
            </div>
          </div>
        `;
      });
      
      gridViewContainer.innerHTML = html;
      
      // Add event listeners for grid view buttons
      gridViewContainer.addEventListener("click", function(e) {
        const target = e.target;
        const button = target.closest("button");
        
        if (!button) return;
        
        if (button.classList.contains("view-tx-grid")) {
          const id = button.getAttribute("data-id");
          viewTransaction(id);
        } else if (button.classList.contains("edit-tx-grid")) {
          const id = button.getAttribute("data-id");
          editTransaction(id);
        } else if (button.classList.contains("delete-tx-grid")) {
          const id = button.getAttribute("data-id");
          confirmDelete(id);
        } else if (button.classList.contains("view-attachment-grid")) {
          const attachment = button.getAttribute("data-attachment");
          viewAttachment(attachment);
        }
      });
      
      // Build grid pagination
      buildGridPagination(totalGridPages);
    }
    
    // NEW: Grid Pagination
    function buildGridPagination(totalPages) {
      if (totalPages <= 1) {
        gridPagination.innerHTML = '';
        return;
      }
      
      let html = `<nav><ul class="pagination pagination-sm">`;

      html += `
        <li class="page-item ${gridCurrentPage === 1 ? 'disabled' : ''}">
          <a class="page-link grid-page-link" href="#" data-page="${gridCurrentPage - 1}">Previous</a>
        </li>
      `;

      const startPage = Math.max(1, gridCurrentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);

      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === gridCurrentPage ? 'active' : ''}">
            <a class="page-link grid-page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }

      html += `
        <li class="page-item ${gridCurrentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link grid-page-link" href="#" data-page="${gridCurrentPage + 1}">Next</a>
        </li>
      `;

      gridPagination.innerHTML = html;

      // Event delegation for grid pagination
      gridPagination.addEventListener("click", function(e) {
        const link = e.target.closest(".grid-page-link");
        if (link) {
          e.preventDefault();
          const page = parseInt(link.getAttribute("data-page"));
          if (page && page !== gridCurrentPage && page > 0 && page <= totalPages) {
            gridCurrentPage = page;
            updateGridView();
            saveAppState();
          }
        }
      });
    }
    
    // NEW: Grid page navigation
    function navigateGridPage(direction) {
      const totalPages = Math.ceil(filteredTransactions.length / gridRowsPerPage);
      const newPage = gridCurrentPage + direction;
      
      if (newPage > 0 && newPage <= totalPages) {
        gridCurrentPage = newPage;
        updateGridView();
        saveAppState();
      }
    }
    
    // NEW: Calendar View Functions
    function initializeCalendar() {
      const calendarEl = calendarViewContainer;
      
      // Clear any existing calendar
      if (calendar) {
        calendar.destroy();
      }
      
      // Prepare events from transactions
      const events = filteredTransactions.map(tx => {
        const income = parseFloat(tx.INCOME) || 0;
        const expense = parseFloat(tx.EXPENSE) || 0;
        const amount = income > 0 ? income : expense;
        
        let backgroundColor = '#6c757d'; // Default gray
        if (tx.TYPE === 'Income') {
          backgroundColor = '#198754'; // Green
        } else if (tx.TYPE === 'Expense') {
          backgroundColor = '#dc3545'; // Red
        } else if (tx.TYPE === 'Transfer') {
          backgroundColor = '#0dcaf0'; // Blue
        }
        
        return {
          title: `${tx.TYPE}: $${amount.toFixed(2)}`,
          start: tx.DATE,
          allDay: true,
          backgroundColor: backgroundColor,
          borderColor: backgroundColor,
          extendedProps: {
            id: tx.id,
            type: tx.TYPE,
            amount: amount,
            description: tx.DESCRIPTION || tx.NOTES || '',
            bank: tx.BANK_NAME || tx.MODE || '',
            account: tx.ACCOUNT_HEADER || '',
            voucher: tx.SINO || ''
          }
        };
      });
      
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
        eventClick: function(info) {
          const txId = info.event.extendedProps.id;
          viewTransaction(txId);
        },
        eventContent: function(arg) {
          const type = arg.event.extendedProps.type;
          const amount = arg.event.extendedProps.amount;
          const description = arg.event.extendedProps.description;
          
          let typeIcon = '';
          if (type === 'Income') {
            typeIcon = '<i class="fa fa-arrow-up me-1"></i>';
          } else if (type === 'Expense') {
            typeIcon = '<i class="fa fa-arrow-down me-1"></i>';
          } else if (type === 'Transfer') {
            typeIcon = '<i class="fa fa-exchange-alt me-1"></i>';
          }
          
          return {
            html: `
              <div class="fc-event-content">
                <div class="fc-event-title">${typeIcon}$${amount.toFixed(2)}</div>
                <div class="fc-event-description small">${description.substring(0, 20)}${description.length > 20 ? '...' : ''}</div>
              </div>
            `
          };
        },
        height: 'auto'
      });
      
      calendar.render();
    }
    
    function updateCalendarView() {
      if (currentView === 'calendar' && calendar) {
        calendar.destroy();
        initializeCalendar();
      }
    }
    
    // NEW: Update view info
    function updateViewInfo() {
      let info = '';
      const filteredCount = filteredTransactions.length;
      const totalCount = allTransactions.length;
      
      if (filteredCount === totalCount) {
        info = `Showing all ${totalCount} transactions`;
      } else {
        info = `Showing ${filteredCount} of ${totalCount} transactions`;
      }
      
      // Add filter info
      const filters = [];
      if (dateFilter.value !== 'all') filters.push(dateFilter.value);
      if (typeFilter.value !== 'all') filters.push(typeFilter.value);
      if (bankFilter.value !== 'all') filters.push(bankFilter.value);
      if (searchDesc.value) filters.push(`"${searchDesc.value}"`);
      
      if (filters.length > 0) {
        info += ` (filtered by: ${filters.join(', ')})`;
      }
      
      viewInfo.textContent = info;
    }
    
    // NEW: AI Chat Functions
    function openAIChat() {
      aiChatModal.show();
    }
    
    function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Add user message to chat
      addChatMessage(message, 'user');
      chatInput.value = '';
      
      // Show thinking indicator
      showThinkingIndicator();
      
      // Process the message with a delay to simulate AI thinking
      setTimeout(() => {
        processAIMessage(message);
      }, 800);
    }
    
    function addChatMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="chat-message-content">${escapeHtml(text)}</div>
        <div class="chat-message-time">${timeString}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Remove thinking indicator if present
      removeThinkingIndicator();
    }
    
    function showThinkingIndicator() {
      removeThinkingIndicator();
      
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'thinking-indicator';
      thinkingDiv.id = 'thinkingIndicator';
      
      thinkingDiv.innerHTML = `
        <span>Analyzing your transactions</span>
        <div class="thinking-dots">
          <div class="thinking-dot"></div>
          <div class="thinking-dot"></div>
          <div class="thinking-dot"></div>
        </div>
      `;
      
      chatMessages.appendChild(thinkingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function removeThinkingIndicator() {
      const existingIndicator = document.getElementById('thinkingIndicator');
      if (existingIndicator) {
        existingIndicator.remove();
      }
    }
    
    function processAIMessage(message) {
      const lowerMessage = message.toLowerCase();
      let response = '';
      
      // Enhanced transaction search capabilities
      if (containsTransactionSearch(lowerMessage)) {
        response = generateTransactionSearchResponse(message);
      } 
      // Analyze transactions and generate response
      else if (lowerMessage.includes('top expense') || lowerMessage.includes('biggest expense') || lowerMessage.includes('largest expense')) {
        response = generateTopExpensesResponse();
      } else if (lowerMessage.includes('income') && lowerMessage.includes('expense') || lowerMessage.includes('income vs expense')) {
        response = generateIncomeExpenseBreakdown();
      } else if (lowerMessage.includes('balance') || lowerMessage.includes('highest balance') || lowerMessage.includes('bank balance')) {
        response = generateBankBalanceResponse();
      } else if (lowerMessage.includes('trend') || lowerMessage.includes('spending trend') || lowerMessage.includes('trend analysis')) {
        response = generateSpendingTrendResponse();
      } else if (lowerMessage.includes('month') || lowerMessage.includes('this month') || lowerMessage.includes('monthly summary')) {
        response = generateMonthlySummary();
      } else if (lowerMessage.includes('help') || lowerMessage.includes('what can you do') || lowerMessage.includes('capabilities')) {
        response = generateHelpResponse();
      } else if (lowerMessage.includes('total') || lowerMessage.includes('how much') || lowerMessage.includes('sum')) {
        response = generateTotalSummary();
      } else if (lowerMessage.includes('category') || lowerMessage.includes('categories')) {
        response = generateCategoryAnalysis();
      } else if (lowerMessage.includes('recent') || lowerMessage.includes('latest') || lowerMessage.includes('last few')) {
        response = generateRecentTransactions();
      } else if (lowerMessage.includes('average') || lowerMessage.includes('avg') || lowerMessage.includes('mean')) {
        response = generateAverageAnalysis();
      } else {
        response = generateGeneralResponse(message);
      }
      
      addChatMessage(response, 'assistant');
    }
    
    // NEW: Check if message contains transaction search keywords
    function containsTransactionSearch(message) {
      const searchKeywords = [
        'transaction', 'transactions', 'show me', 'find', 'search', 'list',
        'from', 'to', 'between', 'on', 'in', 'during',
        'yesterday', 'today', 'tomorrow', 'week', 'month', 'year',
        'january', 'february', 'march', 'april', 'may', 'june',
        'july', 'august', 'september', 'october', 'november', 'december',
        'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday',
        'axis', 'sbi', 'hdfc', 'icici', 'bom', 'cash',
        'income', 'expense', 'transfer', 'payment', 'receipt',
        'description', 'account', 'bank', 'voucher', 'type'
      ];
      
      return searchKeywords.some(keyword => message.includes(keyword));
    }
    
    // NEW: Generate transaction search response
    function generateTransactionSearchResponse(message) {
      const lowerMessage = message.toLowerCase();
      let searchResults = filteredTransactions;
      
      // Parse search parameters
      const searchParams = parseSearchParameters(lowerMessage);
      
      // Apply search filters
      if (searchParams.date) {
        searchResults = searchResults.filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate >= searchParams.date.start && txDate <= searchParams.date.end;
        });
      }
      
      if (searchParams.bank) {
        searchResults = searchResults.filter(tx => {
          const bankName = (tx.BANK_NAME || tx.MODE || '').toLowerCase();
          return bankName.includes(searchParams.bank.toLowerCase());
        });
      }
      
      if (searchParams.account) {
        searchResults = searchResults.filter(tx => {
          const accountHeader = (tx.ACCOUNT_HEADER || '').toLowerCase();
          return accountHeader.includes(searchParams.account.toLowerCase());
        });
      }
      
      if (searchParams.type) {
        searchResults = searchResults.filter(tx => tx.TYPE.toLowerCase() === searchParams.type.toLowerCase());
      }
      
      if (searchParams.description) {
        searchResults = searchResults.filter(tx => {
          const description = (tx.DESCRIPTION || tx.NOTES || '').toLowerCase();
          return description.includes(searchParams.description.toLowerCase());
        });
      }
      
      if (searchParams.minAmount) {
        searchResults = searchResults.filter(tx => {
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return amount >= searchParams.minAmount;
        });
      }
      
      if (searchParams.maxAmount) {
        searchResults = searchResults.filter(tx => {
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return amount <= searchParams.maxAmount;
        });
      }
      
      // Sort results
      if (searchParams.sortBy === 'date-desc') {
        searchResults.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
      } else if (searchParams.sortBy === 'date-asc') {
        searchResults.sort((a, b) => new Date(a.DATE) - new Date(b.DATE));
      } else if (searchParams.sortBy === 'amount-desc') {
        searchResults.sort((a, b) => {
          const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
          const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
          return amountB - amountA;
        });
      } else if (searchParams.sortBy === 'amount-asc') {
        searchResults.sort((a, b) => {
          const amountA = (parseFloat(a.INCOME) || 0) + (parseFloat(a.EXPENSE) || 0);
          const amountB = (parseFloat(b.INCOME) || 0) + (parseFloat(b.EXPENSE) || 0);
          return amountA - amountB;
        });
      }
      
      // Limit results
      if (searchResults.length > 20) {
        searchResults = searchResults.slice(0, 20);
      }
      
      // Generate response
      if (searchResults.length === 0) {
        return `üîç **Search Results**\n\nNo transactions found matching your search criteria.\n\n**Search query:** "${message}"\n\nTry refining your search with:\n‚Ä¢ Specific dates\n‚Ä¢ Bank names\n‚Ä¢ Account headers\n‚Ä¢ Amount ranges\n‚Ä¢ Transaction types`;
      }
      
      let response = `üîç **Search Results**\n\nFound **${searchResults.length}** transaction${searchResults.length !== 1 ? 's' : ''} matching your search.\n\n`;
      
      if (searchResults.length <= 10) {
        // Show all results in a table
        response += `| Date | Description | Type | Amount | Bank |\n`;
        response += `|------|-------------|------|--------|------|\n`;
        
        searchResults.forEach(tx => {
          const date = formatDateToYyyyMmmDd(tx.DATE);
          const description = (tx.DESCRIPTION || tx.NOTES || '').substring(0, 30);
          const type = tx.TYPE;
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          const bank = tx.BANK_NAME || tx.MODE || '';
          
          response += `| ${date} | ${description} | ${type} | $${amount.toFixed(2)} | ${bank} |\n`;
        });
        
        const totalAmount = searchResults.reduce((sum, tx) => {
          return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        }, 0);
        
        response += `\n**Total Amount:** $${totalAmount.toFixed(2)}\n`;
        response += `**Average Transaction:** $${(totalAmount / searchResults.length).toFixed(2)}\n`;
      } else {
        // Show summary for large result sets
        const totalAmount = searchResults.reduce((sum, tx) => {
          return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        }, 0);
        
        const incomeCount = searchResults.filter(tx => tx.TYPE === 'Income').length;
        const expenseCount = searchResults.filter(tx => tx.TYPE === 'Expense').length;
        const transferCount = searchResults.filter(tx => tx.TYPE === 'Transfer').length;
        
        response += `üìä **Summary:**\n`;
        response += `‚Ä¢ **Total Amount:** $${totalAmount.toFixed(2)}\n`;
        response += `‚Ä¢ **Average Transaction:** $${(totalAmount / searchResults.length).toFixed(2)}\n`;
        response += `‚Ä¢ **By Type:** ${incomeCount} Income, ${expenseCount} Expense, ${transferCount} Transfer\n\n`;
        
        // Show top 5 results
        response += `üìã **Top ${Math.min(5, searchResults.length)} Results:**\n\n`;
        
        searchResults.slice(0, 5).forEach((tx, index) => {
          const date = formatDateToYyyyMmmDd(tx.DATE);
          const description = (tx.DESCRIPTION || tx.NOTES || '').substring(0, 40);
          const type = tx.TYPE;
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          
          response += `${index + 1}. **${date}** - ${description}\n`;
          response += `   *${type}*: $${amount.toFixed(2)} | ${tx.BANK_NAME || tx.MODE || ''}\n\n`;
        });
        
        response += `\n*Showing ${Math.min(5, searchResults.length)} of ${searchResults.length} results.*`;
      }
      
      // Add insights
      if (searchResults.length > 0) {
        const highestTx = searchResults.reduce((highest, tx) => {
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return amount > highest.amount ? { amount, tx } : highest;
        }, { amount: 0, tx: null });
        
        if (highestTx.tx) {
          response += `\n\nüí° **Insight:** The highest transaction in your search results is **$${highestTx.amount.toFixed(2)}** on ${formatDateToYyyyMmmDd(highestTx.tx.DATE)} for "${highestTx.tx.DESCRIPTION || highestTx.tx.NOTES || ''}"`;
        }
      }
      
      return response;
    }
    
    // NEW: Parse search parameters from message
    function parseSearchParameters(message) {
      const params = {
        date: null,
        bank: null,
        account: null,
        type: null,
        description: null,
        minAmount: null,
        maxAmount: null,
        sortBy: 'date-desc'
      };
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      // Parse date
      if (message.includes('today')) {
        params.date = { start: today, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
      } else if (message.includes('yesterday')) {
        params.date = { start: yesterday, end: today };
      } else if (message.includes('this week')) {
        const day = now.getDay();
        const start = new Date(today);
        start.setDate(start.getDate() - day);
        const end = new Date(start);
        end.setDate(end.getDate() + 7);
        params.date = { start, end };
      } else if (message.includes('this month')) {
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        params.date = { start, end };
      } else if (message.includes('this year')) {
        const start = new Date(now.getFullYear(), 0, 1);
        const end = new Date(now.getFullYear() + 1, 0, 1);
        params.date = { start, end };
      } else if (message.includes('last week')) {
        const day = now.getDay();
        const start = new Date(today);
        start.setDate(start.getDate() - day - 7);
        const end = new Date(start);
        end.setDate(end.getDate() + 7);
        params.date = { start, end };
      } else if (message.includes('last month')) {
        const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const end = new Date(now.getFullYear(), now.getMonth(), 1);
        params.date = { start, end };
      }
      
      // Parse specific dates
      const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      for (let i = 0; i < monthNames.length; i++) {
        if (message.includes(monthNames[i])) {
          const year = now.getFullYear();
          const month = i;
          const dayMatch = message.match(/(\d+)(?:st|nd|rd|th)?/);
          if (dayMatch) {
            const day = parseInt(dayMatch[1]);
            const date = new Date(year, month, day);
            params.date = { start: date, end: new Date(date.getTime() + 24 * 60 * 60 * 1000) };
          }
          break;
        }
      }
      
      // Parse bank names
      for (const bank of coaBanks) {
        if (message.includes(bank.toLowerCase())) {
          params.bank = bank;
          break;
        }
      }
      
      // Parse account headers
      for (const account of coaAccounts) {
        if (message.includes(account.toLowerCase())) {
          params.account = account;
          break;
        }
      }
      
      // Parse transaction type
      if (message.includes('income')) {
        params.type = 'Income';
      } else if (message.includes('expense')) {
        params.type = 'Expense';
      } else if (message.includes('transfer')) {
        params.type = 'Transfer';
      }
      
      // Parse amount ranges
      const amountMatches = message.match(/(\d+)(\.\d+)?/g);
      if (amountMatches) {
        const amounts = amountMatches.map(match => parseFloat(match));
        if (amounts.length === 1) {
          // Single amount - could be min or exact
          if (message.includes('more than') || message.includes('greater than') || message.includes('above')) {
            params.minAmount = amounts[0];
          } else if (message.includes('less than') || message.includes('below')) {
            params.maxAmount = amounts[0];
          }
        } else if (amounts.length >= 2) {
          // Range
          params.minAmount = Math.min(amounts[0], amounts[1]);
          params.maxAmount = Math.max(amounts[0], amounts[1]);
        }
      }
      
      // Parse sorting
      if (message.includes('newest') || message.includes('recent')) {
        params.sortBy = 'date-desc';
      } else if (message.includes('oldest')) {
        params.sortBy = 'date-asc';
      } else if (message.includes('highest') || message.includes('largest')) {
        params.sortBy = 'amount-desc';
      } else if (message.includes('lowest') || message.includes('smallest')) {
        params.sortBy = 'amount-asc';
      }
      
      return params;
    }
    
    function generateTopExpensesResponse() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      const monthlyExpenses = filteredTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
        })
        .sort((a, b) => (parseFloat(b.EXPENSE) || 0) - (parseFloat(a.EXPENSE) || 0))
        .slice(0, 10);
      
      if (monthlyExpenses.length === 0) {
        return `üìâ **Top Expenses Analysis**\n\nI don't see any expense transactions ${filteredTransactions.length < allTransactions.length ? 'matching your current filters' : 'for this month'}.\n\nTry adjusting your filters or ask about a different time period.`;
      }
      
      let response = `üìâ **Top Expenses Analysis (This Month)**\n\n`;
      
      monthlyExpenses.forEach((tx, index) => {
        const amount = parseFloat(tx.EXPENSE) || 0;
        const description = tx.DESCRIPTION || tx.NOTES || 'No description';
        const date = formatDateToYyyyMmmDd(tx.DATE);
        const bank = tx.BANK_NAME || tx.MODE || '';
        
        response += `${index + 1}. **$${amount.toFixed(2)}** - ${description}\n`;
        response += `   *${date}* | ${bank}\n\n`;
      });
      
      const totalMonthlyExpenses = monthlyExpenses.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      response += `üí∞ **Total this month:** $${totalMonthlyExpenses.toFixed(2)}\n`;
      
      // Add insights
      if (monthlyExpenses.length >= 3) {
        const topCategory = getMostCommonCategory(monthlyExpenses);
        response += `\nüí° **Insights:**\n`;
        response += `‚Ä¢ Your highest expense category is **${topCategory}**\n`;
        
        if (totalMonthlyExpenses > 1000) {
          response += `‚Ä¢ Consider reviewing expenses above $500 for potential savings\n`;
        }
      }
      
      return response;
    }
    
    function generateIncomeExpenseBreakdown() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      
      const monthlyIncome = filteredTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Income';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = filteredTransactions
        .filter(tx => {
          const txDate = new Date(tx.DATE);
          return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear && tx.TYPE === 'Expense';
        })
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      const net = monthlyIncome - monthlyExpenses;
      const savingsRate = monthlyIncome > 0 ? (net / monthlyIncome * 100).toFixed(1) : '0.0';
      
      let response = `üí∞ **Income vs Expense Breakdown (This Month)**\n\n`;
      response += `| Metric | Amount |\n|--------|--------|\n`;
      response += `| **Total Income** | $${monthlyIncome.toFixed(2)} |\n`;
      response += `| **Total Expenses** | $${monthlyExpenses.toFixed(2)} |\n`;
      response += `| **Net Balance** | $${net.toFixed(2)} ${net >= 0 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
      response += `| **Savings Rate** | ${savingsRate}% |\n\n`;
      
      if (monthlyExpenses > 0) {
        const avgDailySpending = (monthlyExpenses / now.getDate()).toFixed(2);
        response += `üìÖ **Daily Analysis:**\n`;
        response += `‚Ä¢ Average daily spending: **$${avgDailySpending}**\n`;
        response += `‚Ä¢ Days remaining this month: **${new Date(thisYear, thisMonth + 1, 0).getDate() - now.getDate()}**\n\n`;
      }
      
      // Add insights
      response += `üí° **Financial Insights:**\n`;
      
      if (net > 0) {
        response += `<span class="insight-badge insight-good">Positive cash flow</span> Great job! You're saving money this month.\n`;
        
        if (parseFloat(savingsRate) > 20) {
          response += `<span class="insight-badge insight-good">High savings rate</span> You're saving ${savingsRate}% of your income. Excellent!\n`;
        }
      } else {
        response += `<span class="insight-badge insight-danger">Negative cash flow</span> You're spending more than you earn this month.\n`;
        
        if (monthlyExpenses > monthlyIncome * 1.5) {
          response += `<span class="insight-badge insight-warning">High spending alert</span> Expenses are ${((monthlyExpenses/monthlyIncome)*100).toFixed(0)}% of income. Consider reducing discretionary spending.\n`;
        }
      }
      
      if (monthlyExpenses > 0 && monthlyIncome > 0) {
        const expenseRatio = (monthlyExpenses / monthlyIncome * 100).toFixed(1);
        if (parseFloat(expenseRatio) > 80) {
          response += `<span class="insight-badge insight-warning">High expense ratio</span> ${expenseRatio}% of income goes to expenses. Aim for 50-70%.\n`;
        }
      }
      
      return response;
    }
    
    function generateBankBalanceResponse() {
      const bankBalances = calculateBankBalances();
      
      if (Object.keys(bankBalances).length === 0) {
        return `üè¶ **Bank Balance Analysis**\n\nI don't see any bank accounts in your transactions.\n\nAdd bank accounts to your Chart of Accounts to track balances.`;
      }
      
      // Sort banks by balance
      const sortedBanks = Object.entries(bankBalances)
        .sort((a, b) => b[1] - a[1]);
      
      let response = `üè¶ **Bank Balance Analysis**\n\n`;
      response += `| Bank | Balance | Status |\n|------|---------|--------|\n`;
      
      sortedBanks.forEach(([bank, balance]) => {
        const formattedBalance = balanceVisible ? `$${balance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        const status = balance >= 0 ? '‚úÖ' : '‚ö†Ô∏è';
        response += `| ${bank} | ${formattedBalance} | ${status} |\n`;
      });
      
      const highestBank = sortedBanks[0];
      const lowestBank = sortedBanks[sortedBanks.length - 1];
      
      if (highestBank && lowestBank) {
        response += `\nüìä **Key Findings:**\n`;
        response += `‚Ä¢ **Highest balance:** ${highestBank[0]} with ${balanceVisible ? `$${highestBank[1].toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}\n`;
        response += `‚Ä¢ **Lowest balance:** ${lowestBank[0]} with ${balanceVisible ? `$${lowestBank[1].toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}\n`;
        
        if (lowestBank[1] < 0) {
          response += `<span class="insight-badge insight-danger">Overdraft warning</span> ${lowestBank[0]} has a negative balance.\n`;
        }
        
        const totalBalance = sortedBanks.reduce((sum, [_, balance]) => sum + balance, 0);
        response += `‚Ä¢ **Total across all banks:** ${balanceVisible ? `$${totalBalance.toFixed(2)}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}\n`;
      }
      
      return response;
    }
    
    function generateSpendingTrendResponse() {
      const monthlyData = {};
      
      filteredTransactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = { income: 0, expense: 0, count: 0 };
          }
          
          if (tx.TYPE === 'Income') {
            monthlyData[monthYear].income += (parseFloat(tx.INCOME) || 0);
          } else if (tx.TYPE === 'Expense') {
            monthlyData[monthYear].expense += (parseFloat(tx.EXPENSE) || 0);
          }
          
          monthlyData[monthYear].count++;
        }
      });
      
      const sortedMonths = Object.keys(monthlyData).sort().slice(-6); // Last 6 months
      
      if (sortedMonths.length === 0) {
        return `üìà **Spending Trend Analysis**\n\nI don't have enough data to analyze spending trends.\n\nMake sure you have transactions spanning multiple months.`;
      }
      
      let response = `üìà **Spending Trend Analysis (Last ${sortedMonths.length} months)**\n\n`;
      response += `| Month | Income | Expenses | Net | Trend |\n|-------|--------|----------|-----|-------|\n`;
      
      sortedMonths.forEach(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(year, monthNum - 1);
        const monthName = date.toLocaleString('default', { month: 'short', year: '2-digit' });
        
        const income = monthlyData[month].income;
        const expense = monthlyData[month].expense;
        const net = income - expense;
        const trend = net >= 0 ? 'üìà' : 'üìâ';
        
        response += `| ${monthName} | $${income.toFixed(2)} | $${expense.toFixed(2)} | $${net.toFixed(2)} | ${trend} |\n`;
      });
      
      // Calculate trend
      if (sortedMonths.length >= 2) {
        const lastMonth = monthlyData[sortedMonths[sortedMonths.length - 1]];
        const prevMonth = monthlyData[sortedMonths[sortedMonths.length - 2]];
        
        const incomeChange = lastMonth.income - prevMonth.income;
        const expenseChange = lastMonth.expense - prevMonth.expense;
        const netChange = (lastMonth.income - lastMonth.expense) - (prevMonth.income - prevMonth.expense);
        
        const incomePercent = prevMonth.income > 0 ? (incomeChange / prevMonth.income * 100).toFixed(1) : '0.0';
        const expensePercent = prevMonth.expense > 0 ? (expenseChange / prevMonth.expense * 100).toFixed(1) : '0.0';
        
        response += `\nüìä **Month-over-Month Changes:**\n`;
        response += `‚Ä¢ **Income:** ${incomeChange >= 0 ? '+' : ''}$${incomeChange.toFixed(2)} (${incomePercent}%)\n`;
        response += `‚Ä¢ **Expenses:** ${expenseChange >= 0 ? '+' : ''}$${expenseChange.toFixed(2)} (${expensePercent}%)\n`;
        response += `‚Ä¢ **Net Change:** ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)}\n`;
        
        // Add insights
        response += `\nüí° **Trend Insights:**\n`;
        
        if (expenseChange > 0 && incomeChange <= expenseChange) {
          response += `<span class="insight-badge insight-warning">Spending increasing</span> Expenses are growing faster than income.\n`;
        } else if (expenseChange < 0 && incomeChange > 0) {
          response += `<span class="insight-badge insight-good">Positive trend</span> Income up, expenses down. Great financial management!\n`;
        } else if (lastMonth.expense > lastMonth.income * 0.8) {
          response += `<span class="insight-badge insight-danger">High spending</span> Expenses are ${((lastMonth.expense/lastMonth.income)*100).toFixed(0)}% of income last month.\n`;
        }
      }
      
      return response;
    }
    
    function generateMonthlySummary() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
      
      const monthlyTransactions = filteredTransactions.filter(tx => {
        const txDate = new Date(tx.DATE);
        return txDate.getMonth() === thisMonth && txDate.getFullYear() === thisYear;
      });
      
      const monthlyIncome = monthlyTransactions
        .filter(tx => tx.TYPE === 'Income')
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const monthlyExpenses = monthlyTransactions
        .filter(tx => tx.TYPE === 'Expense')
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      const incomeCount = monthlyTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = monthlyTransactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = monthlyTransactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      let response = `üìÖ **Monthly Summary (${monthName})**\n\n`;
      response += `| Metric | Value |\n|--------|-------|\n`;
      response += `| **Total Transactions** | ${monthlyTransactions.length} |\n`;
      response += `| ‚Ä¢ Income Transactions | ${incomeCount} |\n`;
      response += `| ‚Ä¢ Expense Transactions | ${expenseCount} |\n`;
      response += `| ‚Ä¢ Transfer Transactions | ${transferCount} |\n`;
      response += `| **Total Income** | $${monthlyIncome.toFixed(2)} |\n`;
      response += `| **Total Expenses** | $${monthlyExpenses.toFixed(2)} |\n`;
      response += `| **Net Balance** | $${(monthlyIncome - monthlyExpenses).toFixed(2)} |\n`;
      
      const daysRemaining = new Date(thisYear, thisMonth + 1, 0).getDate() - now.getDate();
      const avgDailySpending = monthlyExpenses / now.getDate();
      const projectedMonthlySpending = avgDailySpending * new Date(thisYear, thisMonth + 1, 0).getDate();
      
      response += `\nüìä **Projections:**\n`;
      response += `‚Ä¢ **Days remaining:** ${daysRemaining}\n`;
      response += `‚Ä¢ **Avg daily spending:** $${avgDailySpending.toFixed(2)}\n`;
      response += `‚Ä¢ **Projected monthly spending:** $${projectedMonthlySpending.toFixed(2)}\n`;
      
      if (monthlyExpenses > 0 && monthlyIncome > 0) {
        const expenseToIncomeRatio = (monthlyExpenses / monthlyIncome * 100).toFixed(1);
        const savingsRate = ((monthlyIncome - monthlyExpenses) / monthlyIncome * 100).toFixed(1);
        
        response += `‚Ä¢ **Expense to income ratio:** ${expenseToIncomeRatio}%\n`;
        response += `‚Ä¢ **Savings rate:** ${savingsRate}%\n`;
        
        // Add insights
        response += `\nüí° **Financial Health Assessment:**\n`;
        
        if (parseFloat(savingsRate) > 20) {
          response += `<span class="insight-badge insight-good">Excellent savings</span> You're saving ${savingsRate}% of your income! Keep it up.\n`;
        } else if (parseFloat(savingsRate) > 10) {
          response += `<span class="insight-badge insight-good">Good savings rate</span> ${savingsRate}% savings is a healthy rate.\n`;
        } else if (parseFloat(savingsRate) > 0) {
          response += `<span class="insight-badge insight-warning">Low savings</span> Only ${savingsRate}% savings rate. Consider increasing income or reducing expenses.\n`;
        } else {
          response += `<span class="insight-badge insight-danger">Negative savings</span> You're spending more than you earn. Immediate action needed.\n`;
        }
        
        if (parseFloat(expenseToIncomeRatio) > 80) {
          response += `<span class="insight-badge insight-warning">High expense ratio</span> ${expenseToIncomeRatio}% of income goes to expenses. Target 50-70%.\n`;
        }
      }
      
      // Top categories
      const topCategories = getTopCategories(monthlyTransactions.filter(tx => tx.TYPE === 'Expense'), 3);
      if (topCategories.length > 0) {
        response += `\nüè∑Ô∏è **Top Spending Categories:**\n`;
        topCategories.forEach(([category, amount], index) => {
          const percentage = monthlyExpenses > 0 ? ((amount / monthlyExpenses) * 100).toFixed(1) : '0.0';
          response += `${index + 1}. **${category}**: $${amount.toFixed(2)} (${percentage}%)\n`;
        });
      }
      
      return response;
    }
    
    function generateHelpResponse() {
      let response = `ü§ñ **Transaction Assistant Help**\n\n`;
      response += `I can help you analyze your transactions in many ways:\n\n`;
      
      response += `üîç **Search & Find Transactions:**\n`;
      response += `‚Ä¢ "Show me transactions from yesterday"\n`;
      response += `‚Ä¢ "Find expenses from SBI bank"\n`;
      response += `‚Ä¢ "Transactions with amount over $500"\n`;
      response += `‚Ä¢ "Search for 'groceries' in description"\n\n`;
      
      response += `üìä **Financial Analysis:**\n`;
      response += `‚Ä¢ "Income vs expenses this month"\n`;
      response += `‚Ä¢ "Top expenses"\n`;
      response += `‚Ä¢ "Spending trends"\n`;
      response += `‚Ä¢ "Bank balances"\n\n`;
      
      response += `üìà **Reports & Insights:**\n`;
      response += `‚Ä¢ "Monthly summary"\n`;
      response += `‚Ä¢ "Category breakdown"\n`;
      response += `‚Ä¢ "Average transaction amount"\n`;
      response += `‚Ä¢ "Financial health assessment"\n\n`;
      
      response += `üí° **Smart Analysis:**\n`;
      response += `‚Ä¢ I can analyze dates, amounts, banks, accounts, and descriptions\n`;
      response += `‚Ä¢ I understand relative dates like "last week", "this month"\n`;
      response += `‚Ä¢ I can compare periods and identify trends\n`;
      response += `‚Ä¢ I provide actionable insights and recommendations\n\n`;
      
      response += `*Tip: Be specific in your questions for more accurate results!*`;
      
      return response;
    }
    
    function generateTotalSummary() {
      const totalIncome = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
      const totalExpense = filteredTransactions.reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      const netBalance = totalIncome - totalExpense;
      
      const incomeCount = filteredTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = filteredTransactions.filter(tx => tx.TYPE === 'Expense').length;
      const transferCount = filteredTransactions.filter(tx => tx.TYPE === 'Transfer').length;
      
      let response = `üìä **Total Transaction Summary**\n\n`;
      response += `| Metric | Value |\n|--------|-------|\n`;
      response += `| **Total Transactions** | ${filteredTransactions.length} |\n`;
      response += `| ‚Ä¢ Income | ${incomeCount} |\n`;
      response += `| ‚Ä¢ Expenses | ${expenseCount} |\n`;
      response += `| ‚Ä¢ Transfers | ${transferCount} |\n`;
      response += `| **Total Income** | $${totalIncome.toFixed(2)} |\n`;
      response += `| **Total Expenses** | $${totalExpense.toFixed(2)} |\n`;
      response += `| **Net Balance** | $${netBalance.toFixed(2)} ${netBalance >= 0 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
      
      if (filteredTransactions.length > 0) {
        const avgTransaction = (totalIncome + totalExpense) / filteredTransactions.length;
        response += `| **Average Transaction** | $${avgTransaction.toFixed(2)} |\n`;
        
        const earliestTx = filteredTransactions.reduce((earliest, tx) => {
          const txDate = new Date(tx.DATE);
          return txDate < earliest ? txDate : earliest;
        }, new Date());
        
        const monthsActive = Math.max(1, (new Date().getFullYear() - earliestTx.getFullYear()) * 12 + 
          (new Date().getMonth() - earliestTx.getMonth()));
        
        const avgMonthlyIncome = totalIncome / monthsActive;
        const avgMonthlyExpense = totalExpense / monthsActive;
        
        response += `| **Avg Monthly Income** | $${avgMonthlyIncome.toFixed(2)} |\n`;
        response += `| **Avg Monthly Expense** | $${avgMonthlyExpense.toFixed(2)} |\n`;
        response += `| **Avg Monthly Net** | $${(avgMonthlyIncome - avgMonthlyExpense).toFixed(2)} |\n`;
        
        // Add insights
        response += `\nüí° **Overall Financial Health:**\n`;
        
        if (netBalance > 0) {
          response += `<span class="insight-badge insight-good">Positive net worth</span> Your overall balance is positive.\n`;
        } else {
          response += `<span class="insight-badge insight-danger">Negative net worth</span> Your overall balance is negative.\n`;
        }
        
        const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome * 100).toFixed(1) : '0.0';
        if (parseFloat(savingsRate) > 0) {
          response += `<span class="insight-badge insight-good">Overall savings</span> You're saving ${savingsRate}% of your total income.\n`;
        }
      }
      
      return response;
    }
    
    // NEW: Helper functions for analysis
    function getMostCommonCategory(transactions) {
      const categories = {};
      transactions.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || 'Uncategorized';
        categories[category] = (categories[category] || 0) + 1;
      });
      
      let mostCommon = 'Uncategorized';
      let maxCount = 0;
      
      Object.entries(categories).forEach(([category, count]) => {
        if (count > maxCount) {
          mostCommon = category;
          maxCount = count;
        }
      });
      
      return mostCommon;
    }
    
    function getTopCategories(transactions, limit = 5) {
      const categories = {};
      transactions.forEach(tx => {
        const category = tx.ACCOUNT_HEADER || 'Uncategorized';
        const amount = parseFloat(tx.EXPENSE) || 0;
        categories[category] = (categories[category] || 0) + amount;
      });
      
      return Object.entries(categories)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit);
    }
    
    function generateCategoryAnalysis() {
      const categoryData = {};
      
      filteredTransactions.forEach(tx => {
        if (tx.TYPE === 'Expense') {
          const category = tx.ACCOUNT_HEADER || 'Uncategorized';
          const amount = parseFloat(tx.EXPENSE) || 0;
          categoryData[category] = (categoryData[category] || 0) + amount;
        }
      });
      
      if (Object.keys(categoryData).length === 0) {
        return `üè∑Ô∏è **Category Analysis**\n\nNo expense transactions found to analyze categories.\n\nTry adjusting your filters or ask about a specific category.`;
      }
      
      const sortedCategories = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1]);
      
      const totalExpenses = sortedCategories.reduce((sum, [_, amount]) => sum + amount, 0);
      
      let response = `üè∑Ô∏è **Spending Category Analysis**\n\n`;
      response += `| Category | Amount | % of Total |\n|----------|--------|------------|\n`;
      
      sortedCategories.forEach(([category, amount]) => {
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        response += `| ${category} | $${amount.toFixed(2)} | ${percentage}% |\n`;
      });
      
      response += `\nüí∞ **Total Expenses:** $${totalExpenses.toFixed(2)}\n`;
      
      // Add insights
      if (sortedCategories.length > 0) {
        const topCategory = sortedCategories[0];
        const topPercentage = ((topCategory[1] / totalExpenses) * 100).toFixed(1);
        
        response += `\nüí° **Insights:**\n`;
        response += `‚Ä¢ **Top category:** ${topCategory[0]} (${topPercentage}% of expenses)\n`;
        
        if (parseFloat(topPercentage) > 50) {
          response += `<span class="insight-badge insight-warning">Category concentration</span> ${topCategory[0]} represents over 50% of your expenses.\n`;
        }
        
        // Check for discretionary vs essential
        const essentialCategories = ['Rent', 'Utilities', 'Groceries', 'Insurance', 'Loan'];
        const discretionaryCategories = ['Entertainment', 'Dining', 'Shopping', 'Travel'];
        
        let essentialTotal = 0;
        let discretionaryTotal = 0;
        
        sortedCategories.forEach(([category, amount]) => {
          if (essentialCategories.some(essential => category.toLowerCase().includes(essential.toLowerCase()))) {
            essentialTotal += amount;
          } else if (discretionaryCategories.some(discretionary => category.toLowerCase().includes(discretionary.toLowerCase()))) {
            discretionaryTotal += amount;
          }
        });
        
        if (essentialTotal > 0 || discretionaryTotal > 0) {
          const essentialPercent = ((essentialTotal / totalExpenses) * 100).toFixed(1);
          const discretionaryPercent = ((discretionaryTotal / totalExpenses) * 100).toFixed(1);
          
          response += `‚Ä¢ **Essential spending:** ${essentialPercent}% ($${essentialTotal.toFixed(2)})\n`;
          response += `‚Ä¢ **Discretionary spending:** ${discretionaryPercent}% ($${discretionaryTotal.toFixed(2)})\n`;
          
          if (parseFloat(discretionaryPercent) > 30) {
            response += `<span class="insight-badge insight-info">High discretionary spending</span> Consider reducing non-essential expenses.\n`;
          }
        }
      }
      
      return response;
    }
    
    function generateRecentTransactions() {
      const recentTransactions = [...filteredTransactions]
        .sort((a, b) => new Date(b.DATE) - new Date(a.DATE))
        .slice(0, 10);
      
      if (recentTransactions.length === 0) {
        return `üïí **Recent Transactions**\n\nNo transactions found.\n\nAdd some transactions or adjust your filters.`;
      }
      
      let response = `üïí **Recent Transactions (Latest 10)**\n\n`;
      
      recentTransactions.forEach((tx, index) => {
        const date = formatDateToYyyyMmmDd(tx.DATE);
        const description = tx.DESCRIPTION || tx.NOTES || 'No description';
        const type = tx.TYPE;
        const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        const bank = tx.BANK_NAME || tx.MODE || '';
        
        response += `${index + 1}. **${date}** - ${description}\n`;
        response += `   *${type}*: $${amount.toFixed(2)} | ${bank}\n\n`;
      });
      
      const totalAmount = recentTransactions.reduce((sum, tx) => {
        return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
      }, 0);
      
      response += `üìä **Summary of recent transactions:**\n`;
      response += `‚Ä¢ **Total amount:** $${totalAmount.toFixed(2)}\n`;
      response += `‚Ä¢ **Average transaction:** $${(totalAmount / recentTransactions.length).toFixed(2)}\n`;
      
      const incomeCount = recentTransactions.filter(tx => tx.TYPE === 'Income').length;
      const expenseCount = recentTransactions.filter(tx => tx.TYPE === 'Expense').length;
      
      response += `‚Ä¢ **Income/Expense ratio:** ${incomeCount}/${expenseCount}\n`;
      
      return response;
    }
    
    function generateAverageAnalysis() {
      if (filteredTransactions.length === 0) {
        return `üìê **Average Transaction Analysis**\n\nNo transactions to analyze.\n\nAdd some transactions or adjust your filters.`;
      }
      
      const totalAmount = filteredTransactions.reduce((sum, tx) => {
        return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
      }, 0);
      
      const avgTransaction = totalAmount / filteredTransactions.length;
      
      // Find min and max
      let minAmount = Infinity;
      let maxAmount = 0;
      let minTx = null;
      let maxTx = null;
      
      filteredTransactions.forEach(tx => {
        const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        if (amount < minAmount) {
          minAmount = amount;
          minTx = tx;
        }
        if (amount > maxAmount) {
          maxAmount = amount;
          maxTx = tx;
        }
      });
      
      // Calculate median
      const amounts = filteredTransactions.map(tx => (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0))
        .sort((a, b) => a - b);
      
      const median = amounts.length % 2 === 0 
        ? (amounts[amounts.length / 2 - 1] + amounts[amounts.length / 2]) / 2
        : amounts[Math.floor(amounts.length / 2)];
      
      let response = `üìê **Transaction Amount Analysis**\n\n`;
      response += `| Statistic | Value |\n|-----------|-------|\n`;
      response += `| **Number of Transactions** | ${filteredTransactions.length} |\n`;
      response += `| **Total Amount** | $${totalAmount.toFixed(2)} |\n`;
      response += `| **Average Transaction** | $${avgTransaction.toFixed(2)} |\n`;
      response += `| **Median Transaction** | $${median.toFixed(2)} |\n`;
      response += `| **Smallest Transaction** | $${minAmount.toFixed(2)} |\n`;
      response += `| **Largest Transaction** | $${maxAmount.toFixed(2)} |\n`;
      
      // Add insights
      response += `\nüí° **Insights:**\n`;
      
      if (maxAmount > avgTransaction * 5) {
        response += `<span class="insight-badge insight-info">Large transaction outlier</span> Your largest transaction is ${(maxAmount/avgTransaction).toFixed(1)}x the average.\n`;
      }
      
      if (maxTx) {
        response += `‚Ä¢ **Largest transaction:** $${maxAmount.toFixed(2)} on ${formatDateToYyyyMmmDd(maxTx.DATE)} for "${maxTx.DESCRIPTION || maxTx.NOTES || ''}"\n`;
      }
      
      if (minTx) {
        response += `‚Ä¢ **Smallest transaction:** $${minAmount.toFixed(2)} on ${formatDateToYyyyMmmDd(minTx.DATE)}\n`;
      }
      
      // Distribution analysis
      const lowCount = amounts.filter(amount => amount < avgTransaction * 0.5).length;
      const highCount = amounts.filter(amount => amount > avgTransaction * 1.5).length;
      const normalCount = amounts.length - lowCount - highCount;
      
      const lowPercent = ((lowCount / amounts.length) * 100).toFixed(1);
      const highPercent = ((highCount / amounts.length) * 100).toFixed(1);
      const normalPercent = ((normalCount / amounts.length) * 100).toFixed(1);
      
      response += `\nüìä **Amount Distribution:**\n`;
      response += `‚Ä¢ **Below average (<50%):** ${lowCount} transactions (${lowPercent}%)\n`;
      response += `‚Ä¢ **Around average (¬±50%):** ${normalCount} transactions (${normalPercent}%)\n`;
      response += `‚Ä¢ **Above average (>150%):** ${highCount} transactions (${highPercent}%)\n`;
      
      return response;
    }
    
    function generateGeneralResponse(message) {
      // Try to extract specific information
      const lowerMessage = message.toLowerCase();
      
      // Check for specific bank
      for (const bank of coaBanks) {
        if (lowerMessage.includes(bank.toLowerCase())) {
          return generateBankSpecificAnalysis(bank);
        }
      }
      
      // Check for specific account
      for (const account of coaAccounts) {
        if (lowerMessage.includes(account.toLowerCase())) {
          return generateAccountSpecificAnalysis(account);
        }
      }
      
      // Check for specific amount
      const amountMatch = message.match(/(\d+)(\.\d+)?/);
      if (amountMatch) {
        const amount = parseFloat(amountMatch[0]);
        return generateAmountSpecificAnalysis(amount, message);
      }
      
      // Default response
      return `ü§î **I've analyzed your query:** "${message}"\n\n`;
    }
    
    // NEW: Bank-specific analysis
    function generateBankSpecificAnalysis(bankName) {
      const bankTransactions = filteredTransactions.filter(tx => 
        (tx.BANK_NAME || tx.MODE || '').toLowerCase().includes(bankName.toLowerCase())
      );
      
      if (bankTransactions.length === 0) {
        return `üè¶ **Bank Analysis: ${bankName}**\n\nNo transactions found for ${bankName}.\n\nTry checking your bank name spelling or use a different bank.`;
      }
      
      const bankIncome = bankTransactions
        .filter(tx => tx.TYPE === 'Income')
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const bankExpenses = bankTransactions
        .filter(tx => tx.TYPE === 'Expense')
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      const net = bankIncome - bankExpenses;
      
      let response = `üè¶ **Bank Analysis: ${bankName}**\n\n`;
      response += `| Metric | Value |\n|--------|-------|\n`;
      response += `| **Total Transactions** | ${bankTransactions.length} |\n`;
      response += `| **Total Income** | $${bankIncome.toFixed(2)} |\n`;
      response += `| **Total Expenses** | $${bankExpenses.toFixed(2)} |\n`;
      response += `| **Net Flow** | $${net.toFixed(2)} ${net >= 0 ? '‚úÖ' : '‚ö†Ô∏è'} |\n`;
      response += `| **Average Transaction** | $${((bankIncome + bankExpenses) / bankTransactions.length).toFixed(2)} |\n`;
      
      // Recent transactions
      const recentBankTx = [...bankTransactions]
        .sort((a, b) => new Date(b.DATE) - new Date(a.DATE))
        .slice(0, 5);
      
      if (recentBankTx.length > 0) {
        response += `\nüïí **Recent ${bankName} Transactions:**\n\n`;
        
        recentBankTx.forEach(tx => {
          const date = formatDateToYyyyMmmDd(tx.DATE);
          const description = (tx.DESCRIPTION || tx.NOTES || '').substring(0, 30);
          const type = tx.TYPE;
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          
          response += `‚Ä¢ **${date}** - ${description}\n`;
          response += `  *${type}*: $${amount.toFixed(2)}\n\n`;
        });
      }
      
      // Add insights
      response += `üí° **Bank Insights:**\n`;
      
      if (net > 0) {
        response += `<span class="insight-badge insight-good">Positive cash flow</span> ${bankName} has more deposits than withdrawals.\n`;
      } else {
        response += `<span class="insight-badge insight-warning">Negative cash flow</span> More money is leaving ${bankName} than entering.\n`;
      }
      
      if (bankTransactions.length > 10) {
        const avgMonthlyTx = bankTransactions.length / Math.max(1, getTransactionMonths(bankTransactions));
        response += `‚Ä¢ **Avg monthly transactions:** ${avgMonthlyTx.toFixed(1)}\n`;
      }
      
      return response;
    }
    
    // NEW: Account-specific analysis
    function generateAccountSpecificAnalysis(accountName) {
      const accountTransactions = filteredTransactions.filter(tx => 
        (tx.ACCOUNT_HEADER || '').toLowerCase().includes(accountName.toLowerCase())
      );
      
      if (accountTransactions.length === 0) {
        return `üìÅ **Account Analysis: ${accountName}**\n\nNo transactions found for account "${accountName}".\n\nTry checking the account name or use a different account.`;
      }
      
      const accountIncome = accountTransactions
        .filter(tx => tx.TYPE === 'Income')
        .reduce((sum, tx) => sum + (parseFloat(tx.INCOME) || 0), 0);
        
      const accountExpenses = accountTransactions
        .filter(tx => tx.TYPE === 'Expense')
        .reduce((sum, tx) => sum + (parseFloat(tx.EXPENSE) || 0), 0);
      
      let response = `üìÅ **Account Analysis: ${accountName}**\n\n`;
      response += `| Metric | Value |\n|--------|-------|\n`;
      response += `| **Total Transactions** | ${accountTransactions.length} |\n`;
      response += `| **Total Income** | $${accountIncome.toFixed(2)} |\n`;
      response += `| **Total Expenses** | $${accountExpenses.toFixed(2)} |\n`;
      response += `| **Net Amount** | $${(accountIncome - accountExpenses).toFixed(2)} |\n`;
      
      // Transaction frequency
      const months = getTransactionMonths(accountTransactions);
      if (months > 0) {
        const avgMonthly = accountTransactions.length / months;
        response += `| **Avg monthly transactions** | ${avgMonthly.toFixed(1)} |\n`;
      }
      
      // Most common banks for this account
      const bankFrequency = {};
      accountTransactions.forEach(tx => {
        const bank = tx.BANK_NAME || tx.MODE || 'Unknown';
        bankFrequency[bank] = (bankFrequency[bank] || 0) + 1;
      });
      
      const mostCommonBank = Object.entries(bankFrequency)
        .sort((a, b) => b[1] - a[1])[0];
      
      if (mostCommonBank) {
        response += `| **Most common bank** | ${mostCommonBank[0]} (${mostCommonBank[1]} tx) |\n`;
      }
      
      // Recent activity
      const recentAccountTx = [...accountTransactions]
        .sort((a, b) => new Date(b.DATE) - new Date(a.DATE))
        .slice(0, 3);
      
      if (recentAccountTx.length > 0) {
        response += `\nüïí **Recent Activity:**\n\n`;
        
        recentAccountTx.forEach(tx => {
          const date = formatDateToYyyyMmmDd(tx.DATE);
          const description = (tx.DESCRIPTION || tx.NOTES || '').substring(0, 25);
          const type = tx.TYPE;
          const amount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          
          response += `‚Ä¢ **${date}** - ${description}\n`;
          response += `  *${type}*: $${amount.toFixed(2)}\n\n`;
        });
      }
      
      return response;
    }
    
    // NEW: Amount-specific analysis
    function generateAmountSpecificAnalysis(amount, originalMessage) {
      const lowerMessage = originalMessage.toLowerCase();
      
      let comparisonTransactions = filteredTransactions;
      
      if (lowerMessage.includes('more than') || lowerMessage.includes('greater than') || lowerMessage.includes('above')) {
        comparisonTransactions = filteredTransactions.filter(tx => {
          const txAmount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return txAmount > amount;
        });
      } else if (lowerMessage.includes('less than') || lowerMessage.includes('below')) {
        comparisonTransactions = filteredTransactions.filter(tx => {
          const txAmount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return txAmount < amount;
        });
      } else if (lowerMessage.includes('around') || lowerMessage.includes('approximately')) {
        comparisonTransactions = filteredTransactions.filter(tx => {
          const txAmount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return txAmount >= amount * 0.9 && txAmount <= amount * 1.1;
        });
      } else {
        // Exact amount (with tolerance)
        comparisonTransactions = filteredTransactions.filter(tx => {
          const txAmount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
          return Math.abs(txAmount - amount) < 0.01; // Allow for rounding
        });
      }
      
      if (comparisonTransactions.length === 0) {
        let comparisonText = '';
        if (lowerMessage.includes('more than')) comparisonText = `more than $${amount}`;
        else if (lowerMessage.includes('less than')) comparisonText = `less than $${amount}`;
        else comparisonText = `$${amount}`;
        
        return `üí∞ **Amount Analysis: ${comparisonText}**\n\nNo transactions found ${comparisonText !== `$${amount}` ? `with amount ${comparisonText}` : `for exactly $${amount}`}.\n\nTry a different amount or adjust your filters.`;
      }
      
      const totalAmount = comparisonTransactions.reduce((sum, tx) => {
        return sum + (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
      }, 0);
      
      let response = `üí∞ **Amount Analysis**\n\n`;
      
      let comparisonText = '';
      if (lowerMessage.includes('more than')) {
        comparisonText = `> $${amount}`;
        response += `Transactions with amount **greater than $${amount}**:\n\n`;
      } else if (lowerMessage.includes('less than')) {
        comparisonText = `< $${amount}`;
        response += `Transactions with amount **less than $${amount}**:\n\n`;
      } else {
        comparisonText = `‚âà $${amount}`;
        response += `Transactions with amount **around $${amount}**:\n\n`;
      }
      
      response += `| Date | Description | Type | Amount |\n|------|-------------|------|--------|\n`;
      
      comparisonTransactions.slice(0, 10).forEach(tx => {
        const date = formatDateToYyyyMmmDd(tx.DATE);
        const description = (tx.DESCRIPTION || tx.NOTES || '').substring(0, 25);
        const type = tx.TYPE;
        const txAmount = (parseFloat(tx.INCOME) || 0) + (parseFloat(tx.EXPENSE) || 0);
        
        response += `| ${date} | ${description} | ${type} | $${txAmount.toFixed(2)} |\n`;
      });
      
      response += `\nüìä **Summary:**\n`;
      response += `‚Ä¢ **Number of transactions:** ${comparisonTransactions.length}\n`;
      response += `‚Ä¢ **Total amount:** $${totalAmount.toFixed(2)}\n`;
      response += `‚Ä¢ **Average transaction:** $${(totalAmount / comparisonTransactions.length).toFixed(2)}\n`;
      
      if (comparisonTransactions.length > 10) {
        response += `\n*Showing 10 of ${comparisonTransactions.length} transactions.*\n`;
      }
      
      // Add insights
      if (comparisonTransactions.length > 5) {
        const mostCommonType = getMostCommonType(comparisonTransactions);
        const mostCommonBank = getMostCommonBank(comparisonTransactions);
        
        response += `\nüí° **Insights:**\n`;
        response += `‚Ä¢ **Most common type:** ${mostCommonType}\n`;
        if (mostCommonBank) {
          response += `‚Ä¢ **Most common bank:** ${mostCommonBank}\n`;
        }
      }
      
      return response;
    }
    
    // NEW: Helper function to get most common transaction type
    function getMostCommonType(transactions) {
      const types = {};
      transactions.forEach(tx => {
        types[tx.TYPE] = (types[tx.TYPE] || 0) + 1;
      });
      
      let mostCommon = 'Unknown';
      let maxCount = 0;
      
      Object.entries(types).forEach(([type, count]) => {
        if (count > maxCount) {
          mostCommon = type;
          maxCount = count;
        }
      });
      
      return mostCommon;
    }
    
    // NEW: Helper function to get most common bank
    function getMostCommonBank(transactions) {
      const banks = {};
      transactions.forEach(tx => {
        const bank = tx.BANK_NAME || tx.MODE || 'Unknown';
        banks[bank] = (banks[bank] || 0) + 1;
      });
      
      let mostCommon = null;
      let maxCount = 0;
      
      Object.entries(banks).forEach(([bank, count]) => {
        if (bank !== 'Unknown' && count > maxCount) {
          mostCommon = bank;
          maxCount = count;
        }
      });
      
      return mostCommon;
    }
    
    // NEW: Helper function to get number of months with transactions
    function getTransactionMonths(transactions) {
      const months = new Set();
      transactions.forEach(tx => {
        if (tx.DATE) {
          const date = new Date(tx.DATE);
          const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
          months.add(monthYear);
        }
      });
      return Math.max(1, months.size);
    }

    // Make functions available globally for inline event handlers
    window.removeSplitExpense = removeSplitExpense;
    window.updateSplitSummary = updateSplitSummary;
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
