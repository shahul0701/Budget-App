<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Manager Pro</title>

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css">

  <style>
    :root{
      --purple-1:#6f42c1;
      --purple-2:#6a3dd6;
      --accent:#5b2ce7;
      --card-bg:#ffffff;
      --muted:#69707a;
      --text-primary:#222;
      --bg-primary:#f4f6fb;
      --border-color:#eaeef2;
      --success:#198754;
      --warning:#ffc107;
      --info:#0dcaf0;
      --danger:#dc3545;
      --secondary:#6c757d;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --purple-1:#8b66cc;
      --purple-2:#7d5ddb;
      --accent:#6d45f0;
      --card-bg:#2a2d3a;
      --muted:#a0a7b3;
      --text-primary:#f0f2f5;
      --bg-primary:#1a1d28;
      --border-color:#3a3f50;
      --success:#20c997;
      --warning:#fd7e14;
      --info:#3dd5f3;
      --danger:#e66572;
      --secondary:#8f96a1;
    }

    html,body { 
      height:100%; 
      background:var(--bg-primary); 
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; 
      color:var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      transition: all 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-logo {
      font-weight: 700;
      font-size: 20px;
      color: var(--purple-1);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 20px 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin-bottom: 5px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--text-primary);
      text-decoration: none;
      transition: all 0.2s;
      gap: 12px;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: rgba(111, 66, 193, 0.1);
      color: var(--purple-1);
      border-left: 3px solid var(--purple-1);
    }

    .sidebar-menu a i {
      width: 20px;
      text-align: center;
    }

    .sidebar-menu span {
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-menu span {
      opacity: 0;
      display: none;
    }

    .sidebar.collapsed .sidebar-logo span {
      display: none;
    }

    /* Main content with sidebar */
    .main-content {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
      min-height: 100vh;
    }

    .main-content.expanded {
      margin-left: var(--sidebar-collapsed);
    }

    .page {
      max-width:1400px;
      margin:20px auto;
      padding:20px;
    }

    .app-card {
      background:var(--card-bg);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(26,29,40,0.06);
      overflow:visible;
      padding:0;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Header */
    .tm-header {
      border-radius:14px 14px 0 0;
      padding:20px 28px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color:white;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap: wrap;
    }
    .tm-header h2 { margin:0; font-weight:700; font-size:20px; display:flex; align-items:center; gap:12px; }
    .tm-header .header-actions { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn-outline-light {
      border: 1px solid rgba(255,255,255,0.15);
      color: white;
      background: rgba(255,255,255,0.06);
    }

    /* top cards */
    .top-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px; padding:22px; }
    .stat-card {
      background:linear-gradient(180deg,var(--card-bg), var(--card-bg));
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(25,30,40,0.04);
      border:1px solid var(--border-color);
      transition: all 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(25,30,40,0.1);
    }
    .stat-label { font-size:12px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .stat-value { font-size:22px; font-weight:800; margin-top:8px; }
    .stat-trend { font-size:12px; display: flex; align-items: center; gap: 4px; margin-top: 5px; }

    /* info banner */
    .info-banner { 
      padding:14px 22px; 
      border-top:1px solid var(--border-color); 
      border-bottom:1px solid var(--border-color); 
      background:var(--card-bg); 
      color:var(--text-primary);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* content body */
    .content-body { padding:20px 22px 32px; }

    /* table */
    .transactions-table { 
      border-radius:10px; 
      overflow:hidden; 
      border:1px solid var(--border-color); 
      background:var(--card-bg); 
      box-shadow:0 6px 18px rgba(10,12,20,0.02); 
      max-height: 500px; 
      overflow: auto; 
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table table { margin:0; min-width: 1200px; }
    .transactions-table thead th { 
      background:var(--card-bg); 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid var(--border-color); 
      padding:14px 16px; 
      position: sticky;
      top: 0;
      background-color: var(--card-bg);
      z-index: 10;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .transactions-table tbody td { 
      padding:14px 16px; 
      vertical-align:middle; 
      border-bottom:1px solid var(--border-color); 
      transition: background-color 0.3s;
    }
    .transactions-table tbody tr:nth-child(even) td { background: var(--bg-primary); }
    .transactions-table tbody tr.selected td { background-color: rgba(111, 66, 193, 0.1); }
    .transactions-table tbody tr:hover td { background-color: rgba(111, 66, 193, 0.05); }

    .badge-income { 
      background-color: rgba(15, 122, 58, 0.15);
      color: var(--success);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-expense { 
      background-color: rgba(220, 53, 69, 0.15);
      color: var(--danger);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-transfer { 
      background-color: rgba(13, 202, 240, 0.15);
      color: var(--info);
      font-weight:700;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .badge-recurring {
      background-color: rgba(255, 193, 7, 0.15);
      color: var(--warning);
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* action buttons */
    .action-btn { width:38px; height:38px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; color:white; border:none; transition: all 0.2s; }
    .action-btn:hover { transform: scale(1.1); }
    .btn-view { background:var(--info); }
    .btn-edit { background:var(--warning); color:#111; }
    .btn-del { background:var(--danger); }
    .btn-duplicate { background:var(--secondary); }
    .btn-recurring { background:var(--purple-1); }

    /* pagination */
    .pagination-wrap { display:flex; justify-content:center; padding-top:18px; gap:10px; }
    .page-link {
      color: var(--purple-1);
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    .page-link:hover {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }
    .page-item.active .page-link {
      color: white;
      background-color: var(--purple-1);
      border-color: var(--purple-1);
    }

    .floating-add {
      position:fixed; right:30px; bottom:30px; width:62px; height:62px; border-radius:50%;
      background: linear-gradient(180deg,var(--accent),#4a24d6);
      color:white; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(70,34,173,0.2); z-index:1200;
      cursor:pointer;
      transition: all 0.3s;
    }
    .floating-add:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(70,34,173,0.3);
    }

    /* responsive */
    @media (max-width: 1200px) {
      .sidebar { transform: translateX(-100%); }
      .main-content { margin-left: 0; }
      .sidebar.show { transform: translateX(0); }
      .page { padding: 15px; }
    }
    @media (max-width: 980px) {
      .top-cards { grid-template-columns: repeat(2,1fr); }
      .tm-header { flex-direction: column; align-items: flex-start; gap: 15px; }
      .header-actions { width: 100%; justify-content: flex-end; }
    }
    @media (max-width: 640px) {
      .top-cards { grid-template-columns: 1fr; gap:10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters .form-select, .filters .form-control { width: 100%; min-width: unset; }
    }

    /* filters area inside content */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .filters .form-select, .filters .form-control { 
      min-width:160px; 
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .small-muted { font-size:13px; color:var(--muted); }
    
    /* Bank balance section */
    .bank-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .bank-balance-item {
      background: var(--bg-primary);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      min-width: 180px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      flex: 1;
      min-width: 200px;
    }
    .bank-balance-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .bank-balance-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    .bank-balance-value {
      font-weight: 700;
      font-size: 16px;
    }
    .positive-balance { color: var(--success); }
    .negative-balance { color: var(--danger); }
    
    /* Balance visibility toggle */
    .balance-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      margin-left: 8px;
    }
    .balance-hidden {
      filter: blur(5px);
      user-select: none;
    }
    
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    /* Attachment preview */
    .attachment-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      display: none;
    }
    
    /* Color coding for income and expense */
    .income-color {
      color: var(--success);
    }
    .expense-color {
      color: var(--danger);
    }
    
    /* Upload progress bar */
    .upload-progress {
      height: 6px;
      margin-top: 8px;
      border-radius: 3px;
      background: var(--border-color);
      display: none;
    }
    .upload-progress-bar {
      height: 100%;
      border-radius: 3px;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loading spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    /* Time toggle */
    .time-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    /* Form styles */
    .form-control, .form-select {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .form-control:focus, .form-select:focus {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--purple-1);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }
    
    /* Modal styles */
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .modal-header {
      border-bottom-color: var(--border-color);
    }
    .modal-footer {
      border-top-color: var(--border-color);
    }
    
    /* Chart container */
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    
    /* Quick stats */
    .quick-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-stat {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .quick-stat:hover {
      transform: translateY(-2px);
      background: var(--card-bg);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Loading modal */
    #loadingModal .modal-content {
      background: transparent;
      border: none;
      box-shadow: none;
    }
    #loadingModal .modal-body {
      text-align: center;
      color: white;
    }
    
    /* Bulk actions */
    .bulk-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      align-items: center;
      flex-wrap: wrap;
    }
    .bulk-actions.hidden {
      display: none;
    }
    .bulk-count {
      font-weight: 600;
      color: var(--purple-1);
    }
    
    /* Split transaction styles */
    .split-transaction-item {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: var(--bg-primary);
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .split-amount {
      font-weight: 700;
      color: var(--purple-1);
    }
    .remove-split {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .split-summary {
      margin-top: 15px;
      padding: 10px;
      background: var(--card-bg);
      border-radius: 6px;
      font-weight: 600;
    }
    .amount-remaining {
      color: var(--success);
    }
    .amount-exceeded {
      color: var(--danger);
    }
    
    /* Checkbox in table */
    .transaction-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }
    
    /* Animation for modal opening */
    .modal.fade .modal-dialog {
      transition: transform 0.2s ease-out;
    }

    /* Tag system */
    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }
    .tag {
      background: var(--purple-1);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .tag-remove {
      background: none;
      border: none;
      color: white;
      padding: 0;
      cursor: pointer;
      font-size: 10px;
    }

    /* Search highlight */
    .highlight {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Tabs */
    .nav-tabs {
      border-bottom: 1px solid var(--border-color);
    }
    .nav-tabs .nav-link {
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
    }
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--purple-1);
      border-bottom: 2px solid var(--purple-1);
    }

    /* Drag and drop */
    .drag-handle {
      cursor: move;
      color: var(--muted);
    }
    .dragging {
      opacity: 0.5;
      background: var(--bg-primary);
    }

    /* Recurring transactions */
    .recurring-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--warning);
      color: black;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    /* AI Assistant */
    .ai-assistant {
      position: fixed;
      bottom: 100px;
      right: 30px;
      background: linear-gradient(135deg, var(--purple-1), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(70,34,173,0.3);
      z-index: 1100;
      transition: all 0.3s;
    }
    .ai-assistant:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 30px rgba(70,34,173,0.4);
    }
    .ai-panel {
      position: fixed;
      bottom: 170px;
      right: 30px;
      width: 350px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1099;
      display: none;
    }
    .ai-panel.show {
      display: block;
    }
    .ai-header {
      padding: 15px;
      background: linear-gradient(90deg, var(--purple-1), var(--purple-2));
      color: white;
      border-radius: 15px 15px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ai-body {
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .ai-message.user {
      background: rgba(111, 66, 193, 0.1);
      margin-left: 40px;
    }
    .ai-message.bot {
      background: var(--bg-primary);
      margin-right: 40px;
    }
    .ai-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid var(--border-color);
    }

    /* Mobile menu toggle */
    .mobile-menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--purple-1);
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    @media (max-width: 1200px) {
      .mobile-menu-toggle {
        display: flex;
      }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Color picker */
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--purple-1);
    }

    /* Calendar Styles - ADDED */
    .calendar-wrapper {
      width: 100%;
    }
    .calendar-grid {
      display: flex;
      flex-direction: column;
    }
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
    }
    .calendar-cell {
      padding: 10px;
      text-align: center;
      font-weight: 600;
      color: var(--text-primary);
    }
    .calendar-body {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 100px;
      gap: 1px;
      background: var(--border-color);
    }
    .calendar-day {
      background: var(--card-bg);
      padding: 5px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .calendar-day:hover {
      background: var(--bg-primary);
    }
    .calendar-day.empty {
      background: var(--bg-primary);
      cursor: default;
    }
    .calendar-day.today {
      background: rgba(111, 66, 193, 0.1);
    }
    .calendar-day-number {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
    }
    .calendar-day-today {
      background: var(--purple-1);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .calendar-day-transactions {
      font-size: 11px;
      max-height: 60px;
      overflow-y: auto;
    }
    .calendar-transaction-item {
      margin-bottom: 2px;
      padding: 2px 4px;
      border-radius: 3px;
      background: var(--bg-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .transaction-income {
      color: var(--success);
      border-left: 2px solid var(--success);
    }
    .transaction-expense {
      color: var(--danger);
      border-left: 2px solid var(--danger);
    }
    .transaction-transfer {
      color: var(--info);
      border-left: 2px solid var(--info);
    }
    .calendar-day-more {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      margin-top: 2px;
    }

    /* Grid View Styles - ADDED */
    .grid-view-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }
    .grid-card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      padding: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .grid-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .grid-card-income {
      border-left: 4px solid var(--success);
    }
    .grid-card-expense {
      border-left: 4px solid var(--danger);
    }
    .grid-card-transfer {
      border-left: 4px solid var(--info);
    }
    .grid-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .grid-card-title {
      font-weight: 600;
      margin: 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .grid-card-amount {
      font-weight: 700;
      font-size: 16px;
    }
    .grid-card-body {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .grid-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .grid-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    .grid-tag {
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fa fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fa fa-chart-line"></i>
        <span>FinancePro</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fa fa-chevron-left"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="active"><i class="fa fa-home"></i> <span>Dashboard</span></a></li>
      <li><a href="#"><i class="fa fa-exchange-alt"></i> <span>Transactions</span></a></li>
      <li><a href="#"><i class="fa fa-chart-pie"></i> <span>Reports</span></a></li>
      <li><a href="#"><i class="fa fa-wallet"></i> <span>Accounts</span></a></li>
      <li><a href="#"><i class="fa fa-tags"></i> <span>Categories</span></a></li>
      <li><a href="#"><i class="fa fa-calendar-alt"></i> <span>Recurring</span></a></li>
      <li><a href="#"><i class="fa fa-bell"></i> <span>Reminders</span></a></li>
      <li><a href="#"><i class="fa fa-cog"></i> <span>Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="page">
      <!-- Loading Backdrop -->
      <div id="loadingBackdrop" class="loading-backdrop" style="display: none;">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="backdropMessage">Loading...</p>
        </div>
      </div>
      
      <!-- Toast Container -->
      <div class="toast-container" id="toastContainer"></div>
      
      <!-- Navigation buttons -->
      <div class="nav-buttons">
        <button id="backBtn" class="btn btn-outline-primary">
          <i class="fa fa-arrow-left me-1"></i> Back
        </button>
        <button id="homeBtn" class="btn btn-outline-secondary">
          <i class="fa fa-home me-1"></i> Home
        </button>
        <button id="coaBtn" class="btn btn-outline-info">
          <i class="fa fa-chart-pie me-1"></i> Manage COA
        </button>
        <button id="recurringBtn" class="btn btn-outline-warning">
          <i class="fa fa-redo me-1"></i> Recurring
        </button>
        <button id="reportBtn" class="btn btn-outline-success">
          <i class="fa fa-chart-bar me-1"></i> Reports
        </button>
        <div class="export-buttons">
          <button id="exportCSV" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-csv me-1"></i> CSV
          </button>
          <button id="exportPDF" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-file-pdf me-1"></i> PDF
          </button>
          <button id="exportExcel" class="btn btn-outline-success btn-sm">
            <i class="fa fa-file-excel me-1"></i> Excel
          </button>
        </div>
      </div>
      
      <div class="app-card">
        <!-- header -->
        <div class="tm-header">
          <h2><i class="fa fa-money-bill-wave"></i> Transaction Manager Pro</h2>
          <div class="header-actions">
            <button id="newTxBtn" class="btn btn-light btn-sm text-primary"><i class="fa fa-plus me-1"></i> New Transaction</button>
            <button id="quickAddBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-bolt me-1"></i> Quick Add</button>
            <button id="splitIncomeBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-share-alt me-1"></i> Split Income</button>
            <button id="importBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-upload me-1"></i> Import</button>
            <button id="tagManagerBtn" class="btn btn-light btn-sm text-primary ms-2"><i class="fa fa-tags me-1"></i> Tags</button>
            <button id="themeToggle" class="theme-toggle">
              <i class="fa fa-moon"></i>
            </button>
            <div style="width:1px;height:36px;background:rgba(255,255,255,0.12); margin-left:8px;"></div>
            <div style="display:flex;align-items:center; gap:10px; margin-left:8px;">
              <div id="userInitials" style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.12); display:flex;align-items:center;justify-content:center;font-weight:700;">U</div>
              <div style="color:white; font-weight:600;" id="username">User</div>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Logout</button>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions hidden">
          <span class="bulk-count" id="selectedCount">0 transactions selected</span>
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm">
            <i class="fa fa-trash me-1"></i> Delete Selected
          </button>
          <button id="bulkEditBtn" class="btn btn-outline-warning btn-sm">
            <i class="fa fa-edit me-1"></i> Edit Selected
          </button>
          <button id="bulkTagBtn" class="btn btn-outline-info btn-sm">
            <i class="fa fa-tag me-1"></i> Add Tags
          </button>
          <button id="bulkCategoryBtn" class="btn btn-outline-success btn-sm">
            <i class="fa fa-folder me-1"></i> Change Category
          </button>
          <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-times me-1"></i> Clear Selection
          </button>
        </div>

        <!-- top cards -->
        <div class="top-cards" id="topCards">
          <div class="stat-card" onclick="showIncomeDetails()">
            <div class="stat-label">Total Income</div>
            <div id="statIncome" class="stat-value income-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-up text-success"></i> <span id="incomeTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="showExpenseDetails()">
            <div class="stat-label">Total Expenses</div>
            <div id="statExpense" class="stat-value expense-color">$0.00</div>
            <div class="stat-trend"><i class="fa fa-arrow-down text-danger"></i> <span id="expenseTrend">0.0%</span></div>
          </div>
          <div class="stat-card" onclick="toggleBalanceVisibility()">
            <div class="stat-label">Current Balance</div>
            <div id="statBalance" class="stat-value balance-hidden">$0.00</div>
            <div class="small-muted">
              <button id="balanceToggle" class="balance-toggle" title="Toggle balance visibility">
                <i class="fa fa-eye-slash"></i>
              </button>
            </div>
          </div>
          <div class="stat-card" onclick="showTransactionStats()">
            <div class="stat-label">Transactions</div>
            <div id="statCount" class="stat-value">0</div>
            <div class="small-muted">This month</div>
          </div>
          <div class="stat-card" onclick="showCashflowChart()">
            <div class="stat-label">Cash Flow</div>
            <div id="statCashflow" class="stat-value">$0.00</div>
            <div class="small-muted">Monthly average</div>
          </div>
        </div>
        
        <!-- Quick stats -->
        <div class="quick-stats" id="quickStats">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Chart container -->
        <div class="chart-container" id="transactionsChart">
          <!-- Chart will be rendered here -->
        </div>
        
        <!-- Bank balances section -->
        <div class="info-banner">
          <i class="fa fa-info-circle me-2"></i> 
          <span id="dynamicTip">Manage your transactions, view attachments, and track your finances in one place.</span>
          <button class="btn btn-sm btn-outline-primary ms-3" onclick="showNextTip()">Next Tip</button>
          <span class="float-end" id="lastSync"></span>
        </div>
        
        <div class="content-body">
          <!-- Tabs for different views -->
          <ul class="nav nav-tabs mb-3" id="viewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#listView">List View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#gridView">Grid View</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#calendarView">Calendar View</a>
            </li>
          </ul>
          
          <!-- Tab content -->
          <div class="tab-content">
            <!-- List View -->
            <div class="tab-pane fade show active" id="listView">
              <!-- Bank balances -->
              <div id="bankBalances" class="bank-balances">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- filters -->
              <div class="filters mb-2">
                <select id="dateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                  <option value="custom">Custom Range</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="quarter">This Quarter</option>
                </select>

                <div id="customRangeControls" style="display:none; display:flex; gap:8px;">
                  <input id="startDate" type="date" class="form-control form-control-sm" />
                  <input id="endDate" type="date" class="form-control form-control-sm" />
                </div>

                <select id="typeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                  <option value="recurring">Recurring</option>
                </select>

                <!-- Bank Filter -->
                <select id="bankFilter" class="form-select form-select-sm">
                  <option value="all">All Banks</option>
                  <!-- Will be populated dynamically -->
                </select>

                <!-- Category Filter -->
                <select id="categoryFilter" class="form-select form-select-sm">
                  <option value="all">All Categories</option>
                  <!-- Will be populated dynamically -->
                </select>

                <select id="statusFilter" class="form-select form-select-sm">
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>

                <input id="searchDesc" class="form-control form-control-sm" placeholder="Search description, notes, tags..." />

                <button id="applyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
                <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                <button id="advancedFiltersBtn" class="btn btn-sm btn-outline-info">Advanced</button>
                <button id="saveFilterBtn" class="btn btn-sm btn-outline-success" title="Save current filter as preset">
                  <i class="fa fa-save"></i>
                </button>
                <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
              </div>
              
              <!-- Advanced filters (initially hidden) -->
              <div id="advancedFilters" style="display: none;" class="filters mb-2">
                <input id="minAmount" type="number" class="form-control form-control-sm" placeholder="Min Amount" step="0.01" />
                <input id="maxAmount" type="number" class="form-control form-control-sm" placeholder="Max Amount" step="0.01" />
                <input id="tagFilter" type="text" class="form-control form-control-sm" placeholder="Filter by tags (comma separated)" />
                <select id="sortBy" class="form-select form-select-sm">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="category">Category</option>
                  <option value="bank">Bank</option>
                </select>
                <select id="groupBy" class="form-select form-select-sm">
                  <option value="none">No Grouping</option>
                  <option value="date">Group by Date</option>
                  <option value="category">Group by Category</option>
                  <option value="bank">Group by Bank</option>
                  <option value="type">Group by Type</option>
                </select>
              </div>

              <!-- Filter presets -->
              <div id="filterPresets" class="filters mb-2" style="display: none;">
                <small class="text-muted me-2">Presets:</small>
                <!-- Will be populated dynamically -->
              </div>

              <!-- transactions table -->
              <div class="transactions-table">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th style="width:40px;">
                        <input type="checkbox" id="selectAllCheckbox" class="transaction-checkbox">
                        <i class="fa fa-grip-vertical drag-handle ms-1" title="Drag to reorder"></i>
                      </th>
                      <th style="width:110px;">Date</th>
                      <th style="width:120px; text-align:right;">Account Header</th>
                      <th>Description</th>
                      <th style="width:120px;">Type</th>
                      <th style="width:110px;">Voucher #</th>
                      <th style="width:120px;">Bank Name</th>
                      <th style="width:120px; text-align:right;">Income</th>
                      <th style="width:120px; text-align:right;">Expense</th>
                      <th style="width:120px;">Balance</th>
                      <th style="width:120px;">Tags</th>
                      <th style="width:120px;">Attachment</th>
                      <th style="width:130px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <tr><td colspan="13" class="text-center text-muted py-4">No transactions loaded.</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- pagination for list view -->
              <div class="pagination-wrap mt-3" id="listPaginationControls"></div>
            </div>

            <!-- Grid View -->
            <div class="tab-pane fade" id="gridView">
              <div class="filters mb-2">
                <select id="gridDateFilter" class="form-select form-select-sm">
                  <option value="all">All Dates</option>
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                </select>
                <select id="gridTypeFilter" class="form-select form-select-sm">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="transfer">Transfer</option>
                </select>
                <input id="gridSearch" class="form-control form-control-sm" placeholder="Search..." />
                <button id="gridApplyFiltersBtn" class="btn btn-sm btn-primary"><i class="fa fa-search me-1"></i> Apply</button>
              </div>
              
              <div class="grid-view-container" id="gridViewContainer">
                <!-- Will be populated dynamically -->
              </div>
              
              <!-- pagination for grid view -->
              <div class="pagination-wrap mt-3" id="gridPaginationControls"></div>
            </div>

            <!-- Calendar View -->
            <div class="tab-pane fade" id="calendarView">
              <div class="filters mb-2">
                <button class="btn btn-sm btn-outline-primary" onclick="prevMonth()">
                  <i class="fa fa-chevron-left me-1"></i> Previous
                </button>
                <button class="btn btn-sm btn-outline-primary mx-1" onclick="goToToday()">
                  Today
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                  Next <i class="fa fa-chevron-right ms-1"></i>
                </button>
                <select id="calendarTypeFilter" class="form-select form-select-sm ms-2" style="width: auto;" onchange="renderCalendarView()">
                  <option value="all">All Types</option>
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                </select>
              </div>
              
              <div id="calendarContainer">
                <!-- Calendar will be rendered here -->
              </div>
            </div>
          </div>

          <!-- Summary footer -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Selected Summary</h6>
                  <div id="selectedSummary">No transactions selected</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Filter Summary</h6>
                  <div id="filterSummary">Showing all transactions</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant -->
  <div class="ai-assistant" id="aiAssistant">
    <i class="fa fa-robot"></i>
  </div>
  <div class="ai-panel" id="aiPanel">
    <div class="ai-header">
      <span>Finance Assistant</span>
      <button class="btn btn-sm btn-light" onclick="toggleAIPanel()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="ai-body" id="aiChat">
      <div class="ai-message bot">
        Hi! I'm your finance assistant. How can I help you today?
      </div>
    </div>
    <div class="ai-input">
      <input type="text" class="form-control" id="aiInput" placeholder="Ask me anything..." />
      <button class="btn btn-primary" onclick="sendAIMessage()">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- floating add button -->
  <div class="floating-add" id="floatingAdd"><i class="fa fa-plus fa-lg"></i></div>

  <!-- Modals -->
  <!-- Add/Edit Transaction Modal -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="transactionForm">
            <input type="hidden" id="txId" />
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Date *</label>
                <input id="formDATE" type="date" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Time (Optional)</label>
                <input id="formTIME" type="time" class="form-control" />
                <div class="time-toggle-container">
                  <input type="checkbox" id="includeTime" class="form-check-input">
                  <label class="form-check-label small-muted" for="includeTime">Include time</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Voucher # (SINO) *</label>
                <input id="formSINO" type="text" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label class="form-label">Account Header *</label>
                <select id="formACCOUNTHEADER" class="form-select" required>
                  <option value="">Select Account Header</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Voucher Type *</label>
                <select id="formVOUCHERTYPE" class="form-select" required>
                  <option value="Payment">Payment</option>
                  <option value="Receipt">Receipt</option>
                  <option value="Journal">Journal</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Contra">Contra</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type *</label>
                <select id="formTYPE" class="form-select" required>
                  <option value="Income">Income</option>
                  <option value="Expense">Expense</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Adjustment">Adjustment</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Bank Name *</label>
                <select id="formBANKNAME" class="form-select" required>
                  <option value="">Select Bank</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Currency *</label>
                <select id="formCURRENCY" class="form-select" required>
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="GBP">GBP (£)</option>
                  <option value="INR">INR (₹)</option>
                  <option value="JPY">JPY (¥)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-3">
                <label class="form-label">Income</label>
                <input id="formINCOME" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Expense</label>
                <input id="formEXPENSE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Balance (manual)</label>
                <input id="formBALANCE" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="formSTATUS" class="form-select">
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-8">
                <label class="form-label">Description *</label>
                <textarea id="formDESCRIPTION" class="form-control" rows="2" placeholder="Enter description" required></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">Notes</label>
                <textarea id="formNOTES" class="form-control" rows="2" placeholder="Additional notes"></textarea>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input id="formTAGS" type="text" class="form-control" placeholder="Enter tags (comma separated)" />
                <div class="tag-container mt-2" id="tagsPreview"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Attachment</label>
                <input id="formATTACHFILE" type="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,image/*,.csv" />
                <input id="formATTACH" type="hidden" />
                <div class="upload-progress" id="uploadProgress">
                  <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
                <img id="attachmentPreview" class="attachment-preview" alt="Preview" />
                <div id="attachmentInfo" class="small-muted mt-1"></div>
              </div>
            </div>

            <!-- Recurring transaction options -->
            <div class="row g-2 mt-2" id="recurringOptions" style="display: none;">
              <div class="col-md-12">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Recurring Transaction</h6>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">Frequency</label>
                        <select id="formRECURRING_FREQ" class="form-select">
                          <option value="daily">Daily</option>
                          <option value="weekly">Weekly</option>
                          <option value="monthly">Monthly</option>
                          <option value="quarterly">Quarterly</option>
                          <option value="yearly">Yearly</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Interval</label>
                        <input id="formRECURRING_INTERVAL" type="number" class="form-control" value="1" min="1" />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input id="formRECURRING_ENDDATE" type="date" class="form-control" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="duplicateTransactionBtn">
            <i class="fa fa-copy me-1"></i> Duplicate
          </button>
          <button type="button" class="btn btn-info" id="makeRecurringBtn">
            <i class="fa fa-redo me-1"></i> Make Recurring
          </button>
          <button type="button" id="saveTransactionBtn" class="btn btn-primary">Save Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quick Add Transaction</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Enter transaction details (e.g., "Lunch $20 Expense Food")</label>
            <input type="text" class="form-control" id="quickAddInput" placeholder="Description $amount Type [Category] [Tags]" />
            <div class="form-text">Format: Description $amount Type (optional: Category, Tags)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="processQuickAddBtn">Add Transaction</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split Income Modal -->
  <div class="modal fade" id="splitIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Split Income into Expenses</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Total Income Amount</label>
              <input type="number" step="0.01" class="form-control" id="splitIncomeAmount" placeholder="Enter total amount" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Description</label>
              <input type="text" class="form-control" id="splitIncomeDescription" placeholder="Income description" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Bank Account</label>
              <select class="form-select" id="splitIncomeBank">
                <option value="">Select Bank</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Income Date</label>
              <input type="date" class="form-control" id="splitIncomeDate" value="" />
            </div>
          </div>
          
          <div class="mt-4">
            <h6>Split Expenses</h6>
            <div id="splitExpensesContainer">
              <!-- Split items will be added here -->
            </div>
            <button type="button" class="btn btn-outline-primary mt-2" id="addSplitExpenseBtn">
              <i class="fa fa-plus me-1"></i> Add Expense
            </button>
          </div>
          
          <div class="mt-4">
            <div class="split-summary" id="splitSummary">
              Total allocated: $0.00 | Remaining: $0.00
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveSplitTransactionsBtn">Save All Transactions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bulk Edit Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <p>Editing <span id="bulkEditCount" class="badge bg-primary">0</span> transactions</p>
            <label class="form-label">Field to Update</label>
            <select class="form-select" id="bulkEditField">
              <option value="ACCOUNT_HEADER">Account Header</option>
              <option value="BANK_NAME">Bank Name</option>
              <option value="STATUS">Status</option>
              <option value="TYPE">Type</option>
              <option value="VOUCHER_TYPE">Voucher Type</option>
              <option value="CURRENCY">Currency</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">New Value</label>
            <input type="text" class="form-control" id="bulkEditValue" placeholder="Enter new value" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmBulkEditBtn">Update Selected</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Tag Modal -->
  <div class="modal fade" id="bulkTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Tags to Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <p>Adding tags to <span id="bulkTagCount" class="badge bg-primary">0</span> transactions</p>
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" id="bulkTagsInput" placeholder="Enter tags (e.g., urgent, tax-deductible, personal)" />
            <div class="form-text">These tags will be added to all selected transactions</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmBulkTagBtn">Add Tags</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Delete Confirmation Modal -->
  <div class="modal fade" id="confirmBulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Confirm Bulk Delete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> You are about to delete <span id="bulkDeleteCount" class="badge bg-danger">0</span> transactions.
            This action cannot be undone!
          </div>
          <p>Are you sure you want to delete these transactions?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete Selected</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import Transactions</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Select File</label>
            <input type="file" class="form-control" id="importFile" accept=".csv,.xlsx,.xls,.json" />
            <div class="form-text">Supported formats: CSV, Excel, JSON</div>
          </div>
          <div class="mb-3">
            <label class="form-label">File Format</label>
            <select class="form-select" id="importFormat">
              <option value="auto">Auto-detect</option>
              <option value="csv">CSV</option>
              <option value="excel">Excel</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="importOverwrite" />
              <label class="form-check-label" for="importOverwrite">
                Overwrite existing transactions with same voucher number
              </label>
            </div>
          </div>
          <div id="importPreview" style="display: none;">
            <h6>Preview</h6>
            <div class="table-responsive">
              <table class="table table-sm" id="importPreviewTable">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="processImportBtn">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Generate Report</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Report Type</label>
              <select class="form-select" id="reportType">
                <option value="summary">Summary Report</option>
                <option value="detailed">Detailed Transaction Report</option>
                <option value="category">Category-wise Report</option>
                <option value="bank">Bank-wise Report</option>
                <option value="monthly">Monthly Report</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date Range</label>
              <select class="form-select" id="reportDateRange">
                <option value="all">All Time</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Format</label>
              <select class="form-select" id="reportFormat">
                <option value="html">HTML</option>
                <option value="pdf">PDF</option>
                <option value="csv">CSV</option>
                <option value="excel">Excel</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Include Charts</label>
              <select class="form-select" id="reportCharts">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div class="mt-4" id="customReportRange" style="display: none;">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="reportStartDate" />
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="reportEndDate" />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="generateReportBtn">Generate Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Manager Modal -->
  <div class="modal fade" id="tagManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tag Manager</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">All Tags</label>
                <div id="allTagsContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                  <!-- Tags will be populated here -->
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Add New Tag</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="newTagName" placeholder="Tag name" />
                  <button class="btn btn-primary" type="button" onclick="addNewTag()">Add</button>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Tag Color</label>
                <input type="color" class="form-control form-control-color" id="newTagColor" value="#6f42c1" title="Choose tag color" />
              </div>
              <div class="alert alert-info">
                <small><i class="fa fa-info-circle me-1"></i> Click on a tag to see transactions with that tag.</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attachment Modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Attachment</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="attachmentModalBody">
          <!-- Attachment content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" class="btn btn-primary" id="downloadAttachmentBtn" download>Download</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Confirm Delete</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-triangle me-2"></i>
            Are you sure you want to delete this transaction? This action cannot be undone!
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p id="loadingMessage">Processing...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Flatpickr for date range selection -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Pickr for color picker -->
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <!-- XLSX for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for HTML to PDF conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========== GLOBAL VARIABLES AND STATE ==========
    let currentUser = null;
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let txToDelete = null;
    let balanceVisible = false;
    let isSubmitting = false;
    let lastVoucherNumber = 0;
    let currentTheme = 'light';
    let transactionsChartInstance = null;
    let selectedTransactions = new Set();
    let hasLoadedSavedState = false;
    let allTags = new Set();
    let recurringTransactions = [];
    let filterPresets = [];
    
    // COA data
    let coaAccounts = [];
    let coaBanks = [];
    
    // Chart instances
    let mainChart = null;
    let cashflowChart = null;
    let categoryChart = null;
    
    // Calendar state
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    let calendarTypeFilter = 'all';

    // Tips for dynamic tip banner
    const tips = [
      "Track your daily expenses to better understand your spending habits.",
      "Use tags to categorize transactions for better reporting.",
      "Set up recurring transactions for regular bills and income.",
      "Review your bank balances regularly to avoid overdraft fees.",
      "Export your transactions periodically for backup and tax purposes.",
      "Use the split income feature to allocate funds to different expenses.",
      "Try the calendar view to see your transactions by day.",
      "Use the AI assistant for financial insights and suggestions.",
      "Set up filter presets for frequently used views.",
      "Regularly reconcile your transactions with bank statements."
    ];

    // DOM Elements
    const loadingBackdrop = document.getElementById("loadingBackdrop");
    const backdropMessage = document.getElementById("backdropMessage");
    const usernameElem = document.getElementById("username");
    const initialsElem = document.getElementById("userInitials");
    const logoutBtn = document.getElementById("logoutBtn");
    const newTxBtn = document.getElementById("newTxBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const splitIncomeBtn = document.getElementById("splitIncomeBtn");
    const floatingAdd = document.getElementById("floatingAdd");
    const balanceToggle = document.getElementById("balanceToggle");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const coaBtn = document.getElementById("coaBtn");
    const reportBtn = document.getElementById("reportBtn");
    const recurringBtn = document.getElementById("recurringBtn");
    const importBtn = document.getElementById("importBtn");
    const tagManagerBtn = document.getElementById("tagManagerBtn");
    const themeToggle = document.getElementById("themeToggle");
    const exportCSV = document.getElementById("exportCSV");
    const exportPDF = document.getElementById("exportPDF");
    const exportExcel = document.getElementById("exportExcel");
    const advancedFiltersBtn = document.getElementById("advancedFiltersBtn");
    const advancedFilters = document.getElementById("advancedFilters");
    const includeTimeCheckbox = document.getElementById("includeTime");
    const formTIME = document.getElementById("formTIME");
    const formCURRENCY = document.getElementById("formCURRENCY");
    const minAmount = document.getElementById("minAmount");
    const maxAmount = document.getElementById("maxAmount");
    const sortBy = document.getElementById("sortBy");
    const groupBy = document.getElementById("groupBy");
    const tagFilter = document.getElementById("tagFilter");
    const formDESCRIPTION = document.getElementById("formDESCRIPTION");
    const quickAddInput = document.getElementById("quickAddInput");
    const processQuickAddBtn = document.getElementById("processQuickAddBtn");
    const loadingModalEl = document.getElementById("loadingModal");
    const loadingModal = new bootstrap.Modal(loadingModalEl);
    const loadingMessage = document.getElementById("loadingMessage");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const selectAllCheckbox = document.getElementById("selectAllCheckbox");
    const bulkActions = document.getElementById("bulkActions");
    const selectedCount = document.getElementById("selectedCount");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkEditBtn = document.getElementById("bulkEditBtn");
    const bulkTagBtn = document.getElementById("bulkTagBtn");
    const bulkCategoryBtn = document.getElementById("bulkCategoryBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const splitIncomeModalEl = document.getElementById("splitIncomeModal");
    const splitIncomeModal = new bootstrap.Modal(splitIncomeModalEl);
    const splitIncomeAmount = document.getElementById("splitIncomeAmount");
    const splitIncomeDescription = document.getElementById("splitIncomeDescription");
    const splitIncomeBank = document.getElementById("splitIncomeBank");
    const addSplitExpenseBtn = document.getElementById("addSplitExpenseBtn");
    const splitExpensesContainer = document.getElementById("splitExpensesContainer");
    const splitSummary = document.getElementById("splitSummary");
    const saveSplitTransactionsBtn = document.getElementById("saveSplitTransactionsBtn");
    const bulkEditModalEl = document.getElementById("bulkEditModal");
    const bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
    const bulkEditField = document.getElementById("bulkEditField");
    const bulkEditValue = document.getElementById("bulkEditValue");
    const bulkEditCount = document.getElementById("bulkEditCount");
    const confirmBulkEditBtn = document.getElementById("confirmBulkEditBtn");
    const confirmBulkDeleteModalEl = document.getElementById("confirmBulkDeleteModal");
    const confirmBulkDeleteModal = new bootstrap.Modal(confirmBulkDeleteModalEl);
    const bulkDeleteCount = document.getElementById("bulkDeleteCount");
    const confirmBulkDeleteBtn = document.getElementById("confirmBulkDeleteBtn");
    const duplicateTransactionBtn = document.getElementById("duplicateTransactionBtn");
    const makeRecurringBtn = document.getElementById("makeRecurringBtn");
    const sidebar = document.getElementById("sidebar");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const mobileMenuToggle = document.getElementById("mobileMenuToggle");
    const mainContent = document.getElementById("mainContent");
    const aiAssistant = document.getElementById("aiAssistant");
    const aiPanel = document.getElementById("aiPanel");
    const aiChat = document.getElementById("aiChat");
    const aiInput = document.getElementById("aiInput");
    const viewTabs = document.getElementById("viewTabs");
    const gridViewContainer = document.getElementById("gridViewContainer");
    const calendarContainer = document.getElementById("calendarContainer");
    const selectedSummary = document.getElementById("selectedSummary");
    const filterSummary = document.getElementById("filterSummary");
    const dynamicTip = document.getElementById("dynamicTip");
    const lastSync = document.getElementById("lastSync");
    const saveFilterBtn = document.getElementById("saveFilterBtn");
    const filterPresetsDiv = document.getElementById("filterPresets");
    const statusFilter = document.getElementById("statusFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const importModalEl = document.getElementById("importModal");
    const importModal = new bootstrap.Modal(importModalEl);
    const reportModalEl = document.getElementById("reportModal");
    const reportModal = new bootstrap.Modal(reportModalEl);
    const tagManagerModalEl = document.getElementById("tagManagerModal");
    const tagManagerModal = new bootstrap.Modal(tagManagerModalEl);
    const bulkTagModalEl = document.getElementById("bulkTagModal");
    const bulkTagModal = new bootstrap.Modal(bulkTagModalEl);
    const bulkTagsInput = document.getElementById("bulkTagsInput");
    const bulkTagCount = document.getElementById("bulkTagCount");
    const confirmBulkTagBtn = document.getElementById("confirmBulkTagBtn");

    // New DOM refs for grid and calendar
    const listPaginationControls = document.getElementById("listPaginationControls");
    const gridPaginationControls = document.getElementById("gridPaginationControls");
    const gridDateFilter = document.getElementById("gridDateFilter");
    const gridTypeFilter = document.getElementById("gridTypeFilter");
    const gridSearch = document.getElementById("gridSearch");
    const gridApplyFiltersBtn = document.getElementById("gridApplyFiltersBtn");
    const calendarTypeFilterElement = document.getElementById("calendarTypeFilter");

    // Other DOM refs
    const dateFilter = document.getElementById("dateFilter");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const customRangeControls = document.getElementById("customRangeControls");
    const typeFilter = document.getElementById("typeFilter");
    const bankFilter = document.getElementById("bankFilter");
    const searchDesc = document.getElementById("searchDesc");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const resetFiltersBtn = document.getElementById("resetFiltersBtn");
    const transactionsTableBody = document.getElementById("transactionsTableBody");
    const bankBalancesContainer = document.getElementById("bankBalances");
    const quickStatsContainer = document.getElementById("quickStats");
    const transactionsChartElement = document.getElementById("transactionsChart");

    // Modal refs
    const transactionModalEl = document.getElementById("transactionModal");
    const transactionModal = new bootstrap.Modal(transactionModalEl);
    const quickAddModalEl = document.getElementById("quickAddModal");
    const quickAddModal = new bootstrap.Modal(quickAddModalEl);
    const form = document.getElementById("transactionForm");
    const txIdInput = document.getElementById("txId");
    const formDATE = document.getElementById("formDATE");
    const formSINO = document.getElementById("formSINO");
    const formACCOUNTHEADER = document.getElementById("formACCOUNTHEADER");
    const formVOUCHERTYPE = document.getElementById("formVOUCHERTYPE");
    const formTYPE = document.getElementById("formTYPE");
    const formBANKNAME = document.getElementById("formBANKNAME");
    const formINCOME = document.getElementById("formINCOME");
    const formEXPENSE = document.getElementById("formEXPENSE");
    const formBALANCE = document.getElementById("formBALANCE");
    const formNOTES = document.getElementById("formNOTES");
    const formTAGS = document.getElementById("formTAGS");
    const formSTATUS = document.getElementById("formSTATUS");
    const tagsPreview = document.getElementById("tagsPreview");
    const formATTACHFILE = document.getElementById("formATTACHFILE");
    const formATTACH = document.getElementById("formATTACH");
    const attachmentPreview = document.getElementById("attachmentPreview");
    const attachmentInfo = document.getElementById("attachmentInfo");
    const saveTransactionBtn = document.getElementById("saveTransactionBtn");
    const uploadProgress = document.getElementById("uploadProgress");
    const uploadProgressBar = document.getElementById("uploadProgressBar");
    const recurringOptions = document.getElementById("recurringOptions");

    const attachmentModalBody = document.getElementById("attachmentModalBody");

    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    // stats
    const statIncome = document.getElementById("statIncome");
    const statExpense = document.getElementById("statExpense");
    const statBalance = document.getElementById("statBalance");
    const statCount = document.getElementById("statCount");
    const statCashflow = document.getElementById("statCashflow");
    const incomeTrend = document.getElementById("incomeTrend");
    const expenseTrend = document.getElementById("expenseTrend");

    // ========== HELPER FUNCTIONS ==========
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(message = "Loading...") {
      backdropMessage.textContent = message;
      loadingBackdrop.style.display = "flex";
    }

    function hideLoading() {
      loadingBackdrop.style.display = "none";
    }

    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} 
            text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      const container = document.getElementById("toastContainer");
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    function formatDateToYyyyMmmDd(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.toLocaleString('default', { month: 'short' });
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function resetSaveButton() {
      isSubmitting = false;
      saveTransactionBtn.disabled = false;
      saveTransactionBtn.innerHTML = 'Save Transaction';
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupEventListeners();
      loadInitialData();
    });

    function initializeApp() {
      // Set current date in forms
      const today = new Date().toISOString().split('T')[0];
      formDATE.value = today;
      document.getElementById('splitIncomeDate').value = today;
      
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      // Set initial theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      setTheme(savedTheme);
    }

    function setupEventListeners() {
      // Navigation
      logoutBtn.addEventListener("click", handleLogout);
      newTxBtn.addEventListener("click", openAddModal);
      floatingAdd.addEventListener("click", openAddModal);
      balanceToggle.addEventListener("click", toggleBalanceVisibility);
      
      // Filters
      dateFilter.addEventListener("change", handleDateFilterChange);
      applyFiltersBtn.addEventListener("click", applyFilters);
      resetFiltersBtn.addEventListener("click", resetFilters);
      advancedFiltersBtn.addEventListener("click", toggleAdvancedFilters);
      
      // Modal buttons
      saveTransactionBtn.addEventListener("click", saveTransaction);
      confirmDeleteBtn.addEventListener("click", confirmDeleteTransaction);
      duplicateTransactionBtn.addEventListener("click", duplicateTransaction);
      makeRecurringBtn.addEventListener("click", toggleRecurringOptions);
      
      // Quick add
      quickAddBtn.addEventListener("click", () => quickAddModal.show());
      processQuickAddBtn.addEventListener("click", processQuickAdd);
      
      // Split income
      splitIncomeBtn.addEventListener("click", openSplitIncomeModal);
      addSplitExpenseBtn.addEventListener("click", addSplitExpense);
      saveSplitTransactionsBtn.addEventListener("click", saveSplitTransactions);
      
      // Bulk actions
      selectAllBtn.addEventListener("click", selectAllTransactions);
      deselectAllBtn.addEventListener("click", deselectAllTransactions);
      selectAllCheckbox.addEventListener("change", toggleSelectAll);
      bulkDeleteBtn.addEventListener("click", confirmBulkDelete);
      bulkEditBtn.addEventListener("click", openBulkEditModal);
      bulkTagBtn.addEventListener("click", openBulkTagModal);
      clearSelectionBtn.addEventListener("click", clearSelection);
      confirmBulkEditBtn.addEventListener("click", processBulkEdit);
      confirmBulkDeleteBtn.addEventListener("click", processBulkDelete);
      confirmBulkTagBtn.addEventListener("click", processBulkTags);
      
      // Sidebar
      sidebarToggle.addEventListener("click", toggleSidebar);
      mobileMenuToggle.addEventListener("click", toggleMobileMenu);
      
      // Theme
      themeToggle.addEventListener("click", toggleTheme);
      
      // Export
      exportCSV.addEventListener("click", exportToCSV);
      exportPDF.addEventListener("click", exportToPDF);
      exportExcel.addEventListener("click", exportToExcel);
      
      // AI Assistant
      aiAssistant.addEventListener("click", toggleAIPanel);
      aiInput.addEventListener("keypress", (e) => {
        if (e.key === 'Enter') sendAIMessage();
      });
      
      // Form inputs
      formTAGS.addEventListener("input", updateTagsPreview);
      formTYPE.addEventListener("change", updateFormFields);
      includeTimeCheckbox.addEventListener("change", () => {
        formTIME.disabled = !includeTimeCheckbox.checked;
        if (!includeTimeCheckbox.checked) formTIME.value = "";
      });
      
      // Tab switching
      viewTabs.addEventListener("shown.bs.tab", handleTabSwitch);
      
      // Grid filters
      gridApplyFiltersBtn.addEventListener("click", () => {
        applyFilters();
        if (document.querySelector('#gridView').classList.contains('active')) {
          renderGridView();
        }
      });
      
      // Calendar filter
      calendarTypeFilterElement.addEventListener("change", () => {
        calendarTypeFilter = calendarTypeFilterElement.value;
        renderCalendarView();
      });
    }

    function loadInitialData() {
      // Simulate loading data
      showLoading("Loading your financial data...");
      
      // Load sample data for demonstration
      setTimeout(() => {
        loadSampleData();
        updateStats();
        updateBankBalances();
        updateQuickStats();
        renderMainChart();
        updateSelectedSummary();
        updateFilterSummary();
        updateLastSync();
        hideLoading();
        showToast("Welcome to Transaction Manager Pro!", "success");
      }, 1500);
    }

    function loadSampleData() {
      // Sample account headers and banks
      coaAccounts = ["Salary", "Rent", "Groceries", "Utilities", "Entertainment", "Transportation", "Healthcare", "Savings", "Investments"];
      coaBanks = ["Chase Bank", "Bank of America", "Wells Fargo", "Citibank", "Capital One", "Cash"];
      
      // Populate dropdowns
      populateCOADropdowns();
      
      // Sample transactions
      allTransactions = [
        {
          id: "1",
          DATE: new Date().toISOString().split('T')[0],
          SINO: "RP-001",
          ACCOUNT_HEADER: "Salary",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: 5000.00,
          EXPENSE: 0.00,
          BALANCE: 5000.00,
          DESCRIPTION: "Monthly salary",
          NOTES: "Regular monthly income",
          TAGS: ["salary", "income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "2",
          DATE: new Date().toISOString().split('T')[0],
          SINO: "1",
          ACCOUNT_HEADER: "Rent",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Payment",
          TYPE: "Expense",
          INCOME: 0.00,
          EXPENSE: 1500.00,
          BALANCE: 3500.00,
          DESCRIPTION: "Monthly rent payment",
          NOTES: "Apartment rent",
          TAGS: ["housing", "bill"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "3",
          DATE: new Date(Date.now() - 86400000).toISOString().split('T')[0],
          SINO: "2",
          ACCOUNT_HEADER: "Groceries",
          BANK_NAME: "Bank of America",
          VOUCHERTYPE: "Payment",
          TYPE: "Expense",
          INCOME: 0.00,
          EXPENSE: 250.75,
          BALANCE: 3249.25,
          DESCRIPTION: "Weekly groceries",
          NOTES: "Supermarket shopping",
          TAGS: ["food", "shopping"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "4",
          DATE: new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0],
          SINO: "TR-001",
          ACCOUNT_HEADER: "Savings",
          BANK_NAME: "Chase Bank",
          VOUCHER_TYPE: "Transfer",
          TYPE: "Transfer",
          INCOME: 0.00,
          EXPENSE: 1000.00,
          BALANCE: 2249.25,
          DESCRIPTION: "Transfer to savings account",
          NOTES: "Monthly savings",
          TAGS: ["savings", "investment"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          id: "5",
          DATE: new Date(Date.now() - 3 * 86400000).toISOString().split('T')[0],
          SINO: "RP-002",
          ACCOUNT_HEADER: "Freelance",
          BANK_NAME: "Cash",
          VOUCHER_TYPE: "Receipt",
          TYPE: "Income",
          INCOME: 750.50,
          EXPENSE: 0.00,
          BALANCE: 2999.75,
          DESCRIPTION: "Freelance project payment",
          NOTES: "Web development project",
          TAGS: ["freelance", "income"],
          STATUS: "completed",
          CURRENCY: "USD",
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];
      
      filteredTransactions = [...allTransactions];
      buildTable();
    }

    function populateCOADropdowns() {
      // Clear existing options
      formACCOUNTHEADER.innerHTML = '<option value="">Select Account Header</option>';
      formBANKNAME.innerHTML = '<option value="">Select Bank</option>';
      bankFilter.innerHTML = '<option value="all">All Banks</option>';
      splitIncomeBank.innerHTML = '<option value="">Select Bank</option>';
      categoryFilter.innerHTML = '<option value="all">All Categories</option>';
      
      // Add account headers
      coaAccounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account;
        option.textContent = account;
        formACCOUNTHEADER.appendChild(option);
        
        // Add to category filter
        const categoryOption = document.createElement('option');
        categoryOption.value = account;
        categoryOption.textContent = account;
        categoryFilter.appendChild(categoryOption);
      });
      
      // Add bank names
      coaBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank;
        option.textContent = bank;
        formBANKNAME.appendChild(option);
        splitIncomeBank.appendChild(option.cloneNode(true));
        
        // Also add to bank filter
        const filterOption = document.createElement('option');
        filterOption.value = bank;
        filterOption.textContent = bank;
        bankFilter.appendChild(filterOption);
      });
    }

    // ========== CORE FUNCTIONS ==========
    
    function openAddModal() {
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Add Transaction';
      txIdInput.value = '';
      
      // Set default voucher number
      getNextVoucherNumber('Payment').then(voucherNumber => {
        formSINO.value = voucherNumber;
      });
      
      transactionModal.show();
    }

    function resetTransactionForm() {
      form.reset();
      const today = new Date().toISOString().split('T')[0];
      formDATE.value = today;
      formSTATUS.value = 'completed';
      formCURRENCY.value = 'USD';
      formTYPE.value = 'Expense';
      tagsPreview.innerHTML = '';
      attachmentPreview.style.display = 'none';
      attachmentInfo.textContent = '';
      recurringOptions.style.display = 'none';
      includeTimeCheckbox.checked = false;
      formTIME.disabled = true;
    }

    function saveTransaction() {
      if (isSubmitting) return;
      isSubmitting = true;
      
      saveTransactionBtn.disabled = true;
      saveTransactionBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
      
      // Basic validation
      if (!formDATE.value || !formSINO.value || !formDESCRIPTION.value) {
        showToast("Please fill in all required fields", "error");
        resetSaveButton();
        return;
      }
      
      const transactionData = {
        DATE: formDATE.value,
        SINO: formSINO.value,
        ACCOUNT_HEADER: formACCOUNTHEADER.value,
        BANK_NAME: formBANKNAME.value,
        VOUCHER_TYPE: formVOUCHERTYPE.value,
        TYPE: formTYPE.value,
        INCOME: parseFloat(formINCOME.value) || 0,
        EXPENSE: parseFloat(formEXPENSE.value) || 0,
        BALANCE: parseFloat(formBALANCE.value) || 0,
        DESCRIPTION: formDESCRIPTION.value,
        NOTES: formNOTES.value,
        TAGS: formTAGS.value.split(',').map(tag => tag.trim()).filter(tag => tag),
        STATUS: formSTATUS.value,
        ATTACHMENT: formATTACH.value,
        CURRENCY: formCURRENCY.value,
        updatedAt: new Date()
      };
      
      if (includeTimeCheckbox.checked && formTIME.value) {
        transactionData.TIME = formTIME.value;
      }
      
      // Check if recurring
      if (recurringOptions.style.display === "block") {
        transactionData.RECURRING = {
          frequency: document.getElementById("formRECURRING_FREQ").value,
          interval: parseInt(document.getElementById("formRECURRING_INTERVAL").value) || 1,
          endDate: document.getElementById("formRECURRING_ENDDATE").value,
          nextDate: calculateNextRecurringDate(transactionData.DATE, transactionData.RECURRING)
        };
      }
      
      // Simulate saving
      loadingMessage.textContent = "Saving transaction...";
      loadingModal.show();
      
      setTimeout(() => {
        if (txIdInput.value) {
          // Update existing
          const index = allTransactions.findIndex(t => t.id === txIdInput.value);
          if (index !== -1) {
            allTransactions[index] = { ...allTransactions[index], ...transactionData };
          }
          showToast("Transaction updated successfully", "success");
        } else {
          // Add new
          const newId = 'tx_' + Date.now();
          transactionData.id = newId;
          transactionData.createdAt = new Date();
          allTransactions.unshift(transactionData);
          showToast("Transaction added successfully", "success");
        }
        
        loadingModal.hide();
        transactionModal.hide();
        filteredTransactions = [...allTransactions];
        applyFilters();
        resetSaveButton();
      }, 1000);
    }

    function editTransaction(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Edit Transaction';
      txIdInput.value = transaction.id;
      
      // Populate form fields
      formDATE.value = transaction.DATE || '';
      formSINO.value = transaction.SINO || '';
      formACCOUNTHEADER.value = transaction.ACCOUNT_HEADER || '';
      formBANKNAME.value = transaction.BANK_NAME || '';
      formVOUCHERTYPE.value = transaction.VOUCHER_TYPE || 'Payment';
      formTYPE.value = transaction.TYPE || 'Expense';
      formINCOME.value = transaction.INCOME || '';
      formEXPENSE.value = transaction.EXPENSE || '';
      formBALANCE.value = transaction.BALANCE || '';
      formDESCRIPTION.value = transaction.DESCRIPTION || '';
      formNOTES.value = transaction.NOTES || '';
      formTAGS.value = transaction.TAGS ? transaction.TAGS.join(', ') : '';
      formSTATUS.value = transaction.STATUS || 'completed';
      formCURRENCY.value = transaction.CURRENCY || 'USD';
      formATTACH.value = transaction.ATTACHMENT || '';
      
      if (transaction.TIME) {
        includeTimeCheckbox.checked = true;
        formTIME.disabled = false;
        formTIME.value = transaction.TIME;
      }
      
      if (transaction.RECURRING) {
        recurringOptions.style.display = 'block';
        document.getElementById("formRECURRING_FREQ").value = transaction.RECURRING.frequency;
        document.getElementById("formRECURRING_INTERVAL").value = transaction.RECURRING.interval;
        document.getElementById("formRECURRING_ENDDATE").value = transaction.RECURRING.endDate;
      }
      
      updateTagsPreview();
      transactionModal.show();
    }

    function viewTransaction(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      const modalContent = `
        <div class="transaction-details">
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Date:</strong> ${formatDateToYyyyMmmDd(transaction.DATE)}
            </div>
            <div class="col-md-6">
              <strong>Voucher #:</strong> ${transaction.SINO}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Account Header:</strong> ${transaction.ACCOUNT_HEADER}
            </div>
            <div class="col-md-6">
              <strong>Bank:</strong> ${transaction.BANK_NAME}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Type:</strong> <span class="badge ${transaction.TYPE === 'Income' ? 'badge-income' : transaction.TYPE === 'Expense' ? 'badge-expense' : 'badge-transfer'}">${transaction.TYPE}</span>
            </div>
            <div class="col-md-6">
              <strong>Status:</strong> ${transaction.STATUS}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Income:</strong> <span class="income-color">${formatCurrency(transaction.INCOME || 0)}</span>
            </div>
            <div class="col-md-6">
              <strong>Expense:</strong> <span class="expense-color">${formatCurrency(transaction.EXPENSE || 0)}</span>
            </div>
          </div>
          <div class="mb-3">
            <strong>Description:</strong>
            <p>${transaction.DESCRIPTION || 'N/A'}</p>
          </div>
          ${transaction.NOTES ? `
            <div class="mb-3">
              <strong>Notes:</strong>
              <p>${transaction.NOTES}</p>
            </div>
          ` : ''}
          ${transaction.TAGS && transaction.TAGS.length > 0 ? `
            <div class="mb-3">
              <strong>Tags:</strong>
              <div class="tag-container">
                ${transaction.TAGS.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            </div>
          ` : ''}
          ${transaction.ATTACHMENT ? `
            <div class="mb-3">
              <strong>Attachment:</strong>
              <div>
                <a href="#" onclick="viewAttachment('${transaction.ATTACHMENT}')" class="btn btn-sm btn-outline-primary">
                  <i class="fa fa-paperclip"></i> View Attachment
                </a>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      Swal.fire({
        title: 'Transaction Details',
        html: modalContent,
        width: 600,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function confirmDelete(id) {
      txToDelete = id;
      confirmDeleteModal.show();
    }

    function confirmDeleteTransaction() {
      if (!txToDelete) return;
      
      loadingMessage.textContent = "Deleting transaction...";
      loadingModal.show();
      
      setTimeout(() => {
        const index = allTransactions.findIndex(t => t.id === txToDelete);
        if (index !== -1) {
          allTransactions.splice(index, 1);
          showToast("Transaction deleted successfully", "success");
        }
        
        filteredTransactions = [...allTransactions];
        applyFilters();
        confirmDeleteModal.hide();
        loadingModal.hide();
        txToDelete = null;
      }, 1000);
    }

    function duplicateTransactionById(id) {
      const transaction = allTransactions.find(t => t.id === id);
      if (!transaction) return;
      
      resetTransactionForm();
      document.getElementById('transactionModalLabel').textContent = 'Duplicate Transaction';
      txIdInput.value = '';
      
      // Duplicate all fields except ID and SINO
      formDATE.value = transaction.DATE || '';
      formACCOUNTHEADER.value = transaction.ACCOUNT_HEADER || '';
      formBANKNAME.value = transaction.BANK_NAME || '';
      formVOUCHERTYPE.value = transaction.VOUCHER_TYPE || 'Payment';
      formTYPE.value = transaction.TYPE || 'Expense';
      formINCOME.value = transaction.INCOME || '';
      formEXPENSE.value = transaction.EXPENSE || '';
      formBALANCE.value = transaction.BALANCE || '';
      formDESCRIPTION.value = transaction.DESCRIPTION || '';
      formNOTES.value = transaction.NOTES || '';
      formTAGS.value = transaction.TAGS ? transaction.TAGS.join(', ') : '';
      formSTATUS.value = transaction.STATUS || 'completed';
      formCURRENCY.value = transaction.CURRENCY || 'USD';
      
      // Generate new voucher number
      getNextVoucherNumber(transaction.VOUCHER_TYPE || 'Payment').then(voucherNumber => {
        formSINO.value = voucherNumber;
      });
      
      updateTagsPreview();
      transactionModal.show();
    }

    function getNextVoucherNumber(voucherType) {
      return new Promise((resolve) => {
        let maxNumber = 0;
        
        allTransactions.forEach(tx => {
          if (tx.VOUCHER_TYPE === voucherType && tx.SINO) {
            const match = tx.SINO.match(/\d+/);
            if (match) {
              const num = parseInt(match[0]);
              if (num > maxNumber) maxNumber = num;
            }
          }
        });
        
        let prefix = '';
        switch(voucherType) {
          case 'Receipt': prefix = 'RP-'; break;
          case 'Journal': prefix = 'JR-'; break;
          case 'Transfer': prefix = 'TR-'; break;
          case 'Contra': prefix = 'CT-'; break;
          default: prefix = ''; // Payment
        }
        
        const nextNumber = (maxNumber + 1).toString().padStart(3, '0');
        resolve(prefix + nextNumber);
      });
    }

    