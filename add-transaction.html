<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add/Edit Transaction</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11/sweetalert2.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11/sweetalert2.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f5; margin: 0; padding: 0; min-height: 100vh; }
    header { background: #007bff; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    button { cursor: pointer; }
    button#openModalBtn { background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 16px; }
    .modal { display: none; justify-content: center; align-items: center; height: 100vh; background: rgba(0,0,0,0.4); position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; }
    .modal-content {
      background: #fff; padding: 24px 28px; border-radius: 8px; width: 420px; max-width: 95%; max-height: 90vh;
      overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content label { display: block; margin-bottom: 12px; font-size: 14px; color: #444; }
    .modal-content input, .modal-content select { width: 100%; padding: 8px 10px; font-size: 14px; margin-top: 4px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .buttons { display: flex; justify-content: space-between; margin-top: 22px; }
    .primary-btn { background: #007bff; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-size: 15px; font-weight: 600; }
    .cancel-btn { background: #6c757d; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-size: 15px; font-weight: 600; }
    #bankLabel { display: none; }
  </style>
</head>
<body>
  <header>
    <button id="homeBtn">Home</button>
    <span class="username" id="usernameDisplay">Not logged in</span>
    <button id="logoutBtn" style="background:#dc3545;">Logout</button>
  </header>

  <main>
    <button id="openModalBtn" disabled>Add Transaction</button>
  </main>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="title">Add Transaction</h2>
      <form id="txForm" autocomplete="off">
        <input type="hidden" id="txId" />
        <input type="hidden" id="txSINO" />
        <label>SINO <input type="number" id="txSINOVisible" disabled /></label>
        <label>Date <input type="date" id="txDate" required /></label>
        <label>Time <input type="time" id="txTime" required /></label>
        <label>Account Header
          <select id="txAccountHeader" required>
            <option value="">Select Account Header</option>
          </select>
        </label>
        <label>Mode
          <select id="txMode" required>
            <option value="">Select Mode</option><option value="Cash">Cash</option><option value="Bank">Bank</option>
          </select>
        </label>
        <label id="bankLabel">Bank Name
          <select id="txBankName" required>
            <option value="">Select Bank</option>
          </select>
        </label>
        <label>Type
          <select id="txType" required>
            <option value="">Income vs Expense</option><option value="income">Income</option><option value="expense">Expense</option>
          </select>
        </label>
        <div id="incomeGroup" style="display:none;">
          <label>Income Amount <input type="number" id="txIncome" step="0.01" min="0" /></label>
        </div>
        <div id="expenseGroup" style="display:none;">
          <label>Expense Amount <input type="number" id="txExpense" step="0.01" min="0" /></label>
        </div>
        <label>Balance <input type="number" id="txBalance" disabled /></label>
        <label>Description <input type="text" id="txDesc" maxlength="200" /></label>
        <label>Attachment <input type="file" id="txAttachFile" accept="image/*,application/pdf" /><input type="hidden" id="txAttachUrl" /></label>
        <div class="buttons">
          <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
          <button type="submit" class="primary-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, collection, addDoc, getDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

   const firebaseConfig = {
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.firebasestorage.app",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae", };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const modal = document.getElementById("modal"), title = document.getElementById("title"), txForm = document.getElementById("txForm");
    const cancelBtn = document.getElementById("cancelBtn"), openModalBtn = document.getElementById("openModalBtn");
    const txId = document.getElementById("txId"), txSINO = document.getElementById("txSINO"), txSINOVisible = document.getElementById("txSINOVisible");
    const txDate = document.getElementById("txDate"), txTime = document.getElementById("txTime"), txAccountHeader = document.getElementById("txAccountHeader");
    const txMode = document.getElementById("txMode"), bankLabel = document.getElementById("bankLabel"), txBankName = document.getElementById("txBankName");
    const txType = document.getElementById("txType"), incomeGroup = document.getElementById("incomeGroup"), expenseGroup = document.getElementById("expenseGroup");
    const txIncome = document.getElementById("txIncome"), txExpense = document.getElementById("txExpense"), txBalance = document.getElementById("txBalance");
    const txDesc = document.getElementById("txDesc"), txAttachFile = document.getElementById("txAttachFile"), txAttachUrl = document.getElementById("txAttachUrl");
    const usernameDisplay = document.getElementById("usernameDisplay"), logoutBtn = document.getElementById("logoutBtn"), homeBtn = document.getElementById("homeBtn");

    let currentUser = null, coaAccounts = [];

    async function loadChartOfAccounts() {
      if (!currentUser) return;
      const q = query(collection(db, "chartOfAccounts"), where("userId", "==", currentUser.uid));
      const snapshot = await getDocs(q);
      coaAccounts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      txAccountHeader.innerHTML = '<option value="">Select Account Header</option>';
      coaAccounts.forEach(acc => txAccountHeader.insertAdjacentHTML("beforeend", `<option value="${acc.name}">${acc.name}</option>`));

      txBankName.innerHTML = '<option value="">Select Bank</option>';
      coaAccounts.filter(acc =>
        acc.type?.toLowerCase() === "asset" &&
        ["bank", "credit card"].includes((acc.category || "").toLowerCase())
      ).forEach(acc => txBankName.insertAdjacentHTML("beforeend", `<option value="${acc.name}">${acc.name}</option>`));
    }

    async function generateNextSINO() {
      const snap = await getDocs(collection(db, "users", currentUser.uid, "transactions"));
      let max = 0;
      snap.docs.forEach(d => { const s = parseInt(d.data().SINO); if (!isNaN(s) && s > max) max = s; });
      const next = max + 1;
      txSINO.value = next;
      txSINOVisible.value = next;
    }

    async function showModal() {
      await loadChartOfAccounts();
      title.textContent = "Add Transaction";
      txDate.value = new Date().toISOString().split("T")[0];
      txTime.value = new Date().toISOString().split("T")[1].slice(0,5);
      txAccountHeader.value = txMode.value = txBankName.value = txType.value = "";
      txIncome.value = txExpense.value = txBalance.value = txDesc.value = txAttachFile.value = txAttachUrl.value = "";
      bankLabel.style.display = incomeGroup.style.display = expenseGroup.style.display = "none";
      await generateNextSINO();
      modal.style.display = "flex";
    }

    function hideModal() { modal.style.display = "none"; }
    function updateBalance() { txBalance.value = ((parseFloat(txIncome.value)||0) - (parseFloat(txExpense.value)||0)).toFixed(2); }

    txMode.addEventListener("change", () => {
      if (txMode.value === "Bank") { bankLabel.style.display = "block"; txBankName.required = true; }
      else { bankLabel.style.display = "none"; txBankName.required = false; txBankName.value = ""; }
    });
    txType.addEventListener("change", () => {
      if (txType.value === "income") { incomeGroup.style.display = "block"; txIncome.required = true; expenseGroup.style.display = "none"; txExpense.required = false; }
      else if (txType.value === "expense") { expenseGroup.style.display = "block"; txExpense.required = true; incomeGroup.style.display = "none"; txIncome.required = false; }
      else { incomeGroup.style.display = expenseGroup.style.display = "none"; txIncome.required = txExpense.required = false; txIncome.value = txExpense.value = ""; }
      updateBalance();
    });
    txIncome.addEventListener("input", updateBalance);
    txExpense.addEventListener("input", updateBalance);

    openModalBtn.addEventListener("click", showModal);
    cancelBtn.addEventListener("click", hideModal);
    window.addEventListener("click", e => { if (e.target === modal) hideModal(); });

    txForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!currentUser) return Swal.fire("Error", "You must be logged in.", "error");
      if (!txDate.value || !txTime.value || !txAccountHeader.value || !txMode.value || !txType.value) {
        return Swal.fire("Validation Error", "Please fill all required fields.", "warning");
      }
      if (txMode.value === "Bank" && !txBankName.value) {
        return Swal.fire("Validation Error", "Please select a Bank Name.", "warning");
      }

      const txData = {
        userId: currentUser.uid,
        Date: txDate.value,
        Time: txTime.value,
        AccountHeader: txAccountHeader.value,
        Mode: txMode.value,
        BankName: txMode.value === "Bank" ? txBankName.value : "",
        Type: txType.value,
        Income: txType.value === "income" ? parseFloat(txIncome.value) : 0,
        Expense: txType.value === "expense" ? parseFloat(txExpense.value) : 0,
        Balance: parseFloat(txBalance.value) || 0,
        Description: txDesc.value || "",
        Attachment: txAttachUrl.value || "",
        SINO: parseInt(txSINO.value),
        timestamp: new Date().toISOString()
      };
      console.log("Saving transaction:", txData);

      try {
        const userDocRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userDocRef);
        if (!userSnap.exists()) {
          await setDoc(userDocRef, { userId: currentUser.uid, createdAt: new Date().toISOString() });
        }
        await addDoc(collection(db, "users", currentUser.uid, "transactions"), txData);
        Swal.fire("Success", "Transaction added!", "success");
        hideModal();
      } catch (err) {
        console.error("Error saving transaction:", err);
        Swal.fire("Error", err.message, "error");
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        usernameDisplay.textContent = user.email || "User";
        openModalBtn.disabled = false;
      } else {
        usernameDisplay.textContent = "Not logged in";
        openModalBtn.disabled = true;
        hideModal();
      }
    });

    logoutBtn.addEventListener("click", () => signOut(auth));
    homeBtn.addEventListener("click", () => window.location.href = "index.html");
  </script>
</body>
</html>
