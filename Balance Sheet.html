<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Balance Sheet</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
/* Your CSS remains the same */
body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;color:#333;margin:0;padding:0;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
header{background:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);border-radius:8px;margin-bottom:30px;}
.header-left a{text-decoration:none;color:#3498db;font-weight:bold;font-size:18px;display:flex;align-items:center;gap:8px;}
.header-right{display:flex;align-items:center;gap:15px;}
#userInitials{background:#3498db;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
#logoutBtn{background:#e74c3c;color:white;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
#logoutBtn:hover{background:#c0392b;}
h1{text-align:center;margin-bottom:30px;}
.view-toggle{display:flex;justify-content:center;gap:20px;margin-bottom:20px;}
.view-toggle button{padding:8px 14px;border-radius:4px;border:none;background:#3498db;color:white;cursor:pointer;}
.view-toggle button.active{background:#2980b9;}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px;}
.summary-card{background:white;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.summary-card.assets{border-top:4px solid #2ecc71;}
.summary-card.liabilities{border-top:4px solid #e74c3c;}
.summary-card.equity{border-top:4px solid #3498db;}
.card-title{font-size:16px;color:#95a5a6;margin-bottom:10px;}
.card-value{font-size:24px;font-weight:700;}
.assets .card-value{color:#2ecc71;}
.liabilities .card-value{color:#e74c3c;}
.equity .card-value{color:#3498db;}
.table-container{background:white;border-radius:8px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-bottom:20px;overflow-x:auto;}
.table-container table{width:100%;border-collapse:collapse;}
.table-container th, .table-container td{border:1px solid #ddd;padding:8px;text-align:right;}
.table-container th{background:#f1f1f1;color:#2c3e50;}
.table-container td.name{text-align:left;}
.export-buttons{display:flex;gap:10px;margin-bottom:20px;}
.export-buttons button{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
.export-buttons button:hover{background:#2980b9;}
.loading-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;}
.loading-content{background:white;padding:30px;border-radius:8px;text-align:center;}
.empty-state{text-align:center;padding:20px;color:#95a5a6;}
</style>
</head>
<body>

<header>
<div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
<div class="header-right">
<div id="userInitials">U</div>
<div id="username">User</div>
<button id="logoutBtn">Logout</button>
</div>
</header>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Balance Sheet</h1>

<div class="view-toggle">
<button id="professionalView" class="active">Professional View</button>
<button id="companyView">Company View</button>
</div>

<div class="summary-cards">
<div class="summary-card assets"><div class="card-title">Total Assets</div><div class="card-value" id="totalAssets">₹0.00</div></div>
<div class="summary-card liabilities"><div class="card-title">Total Liabilities</div><div class="card-value" id="totalLiabilities">₹0.00</div></div>
<div class="summary-card equity"><div class="card-title">Total Equity</div><div class="card-value" id="totalEquity">₹0.00</div></div>
</div>

<div class="table-container" id="balanceSheetTable"></div>

<div class="export-buttons">
<button id="exportCSV"><i class="fa fa-file-csv"></i> CSV</button>
<button id="exportPDF"><i class="fa fa-file-pdf"></i> PDF</button>
</div>
</div>

<div id="loadingModal" class="loading-modal">
<div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;margin-bottom:15px;"></i><p>Loading Balance Sheet...</p></div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
  authDomain: "budget-app-1365f.firebaseapp.com",
  projectId: "budget-app-1365f",
  storageBucket: "budget-app-1365f.appspot.com",
  messagingSenderId: "1036194450411",
  appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
});

const db = getFirestore(app);
const auth = getAuth(app);

// DOM Elements
const usernameElem = document.getElementById("username");
const initialsElem = document.getElementById("userInitials");
const logoutBtn = document.getElementById("logoutBtn");
const balanceSheetTable = document.getElementById("balanceSheetTable");
const professionalViewBtn = document.getElementById("professionalView");
const companyViewBtn = document.getElementById("companyView");
const totalAssetsElem = document.getElementById("totalAssets");
const totalLiabilitiesElem = document.getElementById("totalLiabilities");
const totalEquityElem = document.getElementById("totalEquity");
const exportCSVBtn = document.getElementById("exportCSV");
const exportPDFBtn = document.getElementById("exportPDF");
const loadingModal = document.getElementById("loadingModal");

let currentUser = null;
let transactions = [];

// ===== Auth =====
onAuthStateChanged(auth, user => {
  if(user){
    currentUser = user;
    const name = user.displayName || user.email || "User";
    usernameElem.textContent = name;
    initialsElem.textContent = name.charAt(0).toUpperCase();
    loadBalanceSheet();
  } else {
    alert("Login first."); 
    window.location.href="index.html";
  }
});

logoutBtn.addEventListener("click", async()=>{
  await signOut(auth);
  window.location.href="index.html";
});

// ===== View toggle =====
professionalViewBtn.addEventListener("click", ()=>{
  professionalViewBtn.classList.add("active");
  companyViewBtn.classList.remove("active");
  renderBalanceSheet("professional");
});
companyViewBtn.addEventListener("click", ()=>{
  companyViewBtn.classList.add("active");
  professionalViewBtn.classList.remove("active");
  renderBalanceSheet("company");
});

let coaAccounts = []; // will store all accounts

async function loadBalanceSheet(){
  loadingModal.style.display = "flex";
  try{
    // Load Chart of Accounts first
    const coaSnap = await getDocs(collection(db, "chartOfAccounts"));
    coaAccounts = coaSnap.docs
      .filter(d => d.data().userId === currentUser.uid)
      .map(d => ({ id: d.id, ...d.data() }));

    // Load transactions
    const q = query(collection(db,"users",currentUser.uid,"transactions"), orderBy("DATE","asc"));
    const snap = await getDocs(q);
    transactions = snap.docs.map(d => ({id:d.id,...d.data()}));

    renderBalanceSheet("professional");
  } catch(err){
    console.error(err);
    alert("Error: "+err.message);
  } finally{
    loadingModal.style.display = "none";
  }
}

// ===== Calculate Balances =====
function calculateBalances(){
  let assets = {};
  let liabilities = {};
  let equity = {};

  // Initialize with accounts from Chart of Accounts
  coaAccounts.forEach(acc => {
    if (acc.type === "Asset") {
      assets[acc.name] = 0;
    } else if (acc.type === "Liability") {
      liabilities[acc.name] = 0;
    } else if (acc.type === "Equity") {
      equity[acc.name] = 0;
    }
  });

  // Process transactions
  transactions.forEach(tx => {
    // Find matching account from CoA
    const acc = coaAccounts.find(a => a.id === tx.accountId || a.name === tx.ACCOUNT_HEADER);
    
    if (acc) {
      const amount = parseFloat(tx.INCOME || tx.EXPENSE || tx.amount || 0);
      const isCredit = tx.TYPE === "CREDIT" || tx.type === "CREDIT" || tx.INCOME > 0;
      
      if (acc.type === "Asset") {
        // Assets increase with debits, decrease with credits
        assets[acc.name] = (assets[acc.name] || 0) + (isCredit ? -amount : amount);
      } else if (acc.type === "Liability") {
        // Liabilities increase with credits, decrease with debits
        liabilities[acc.name] = (liabilities[acc.name] || 0) + (isCredit ? amount : -amount);
      } else if (acc.type === "Equity") {
        // Equity increases with credits, decreases with debits
        equity[acc.name] = (equity[acc.name] || 0) + (isCredit ? amount : -amount);
      }
    }
  });

  // Remove accounts with zero balance
  Object.keys(assets).forEach(key => {
    if (assets[key] === 0) delete assets[key];
  });
  Object.keys(liabilities).forEach(key => {
    if (liabilities[key] === 0) delete liabilities[key];
  });
  Object.keys(equity).forEach(key => {
    if (equity[key] === 0) delete equity[key];
  });

  const totalAssets = Object.values(assets).reduce((a, b) => a + b, 0);
  const totalLiabilities = Object.values(liabilities).reduce((a, b) => a + b, 0);
  const totalEquity = Object.values(equity).reduce((a, b) => a + b, 0);

  totalAssetsElem.textContent = `₹${totalAssets.toFixed(2)}`;
  totalLiabilitiesElem.textContent = `₹${totalLiabilities.toFixed(2)}`;
  totalEquityElem.textContent = `₹${totalEquity.toFixed(2)}`;

  return { assets, liabilities, equity };
}

// ===== Render Table =====
function renderBalanceSheet(viewType){
  const { assets, liabilities, equity } = calculateBalances();
  let html = "";

  if(viewType === "professional"){
    html += `<h3>Assets</h3><table><thead><tr><th>Account</th><th>Amount</th></tr></thead><tbody>`;
    for(const k in assets){ 
      html += `<tr><td class="name">${k}</td><td>₹${assets[k].toFixed(2)}</td></tr>`;
    }
    html += `<tr><td class="name"><strong>Total Assets</strong></td><td><strong>₹${Object.values(assets).reduce((a, b) => a + b, 0).toFixed(2)}</strong></td></tr>`;
    html += `</tbody></table>`;

    html += `<h3>Liabilities</h3><table><thead><tr><th>Account</th><th>Amount</th></tr></thead><tbody>`;
    for(const k in liabilities){ 
      html += `<tr><td class="name">${k}</td><td>₹${liabilities[k].toFixed(2)}</td></tr>`;
    }
    html += `<tr><td class="name"><strong>Total Liabilities</strong></td><td><strong>₹${Object.values(liabilities).reduce((a, b) => a + b, 0).toFixed(2)}</strong></td></tr>`;
    html += `</tbody></table>`;

    html += `<h3>Equity</h3><table><thead><tr><th>Account</th><th>Amount</th></tr></thead><tbody>`;
    for(const k in equity){ 
      html += `<tr><td class="name">${k}</td><td>₹${equity[k].toFixed(2)}</td></tr>`;
    }
    html += `<tr><td class="name"><strong>Total Equity</strong></td><td><strong>₹${Object.values(equity).reduce((a, b) => a + b, 0).toFixed(2)}</strong></td></tr>`;
    html += `</tbody></table>`;
  }
  else if(viewType === "company"){
    html += `<table><thead><tr><th>Type</th><th>Account</th><th>Amount</th></tr></thead><tbody>`;
    for(const k in assets){ 
      html += `<tr><td>Asset</td><td class="name">${k}</td><td>₹${assets[k].toFixed(2)}</td></tr>`;
    }
    for(const k in liabilities){ 
      html += `<tr><td>Liability</td><td class="name">${k}</td><td>₹${liabilities[k].toFixed(2)}</td></tr>`;
    }
    for(const k in equity){ 
      html += `<tr><td>Equity</td><td class="name">${k}</td><td>₹${equity[k].toFixed(2)}</td></tr>`;
    }
    html += `</tbody></table>`;
  }

  balanceSheetTable.innerHTML = html || `<div class="empty-state">No balance sheet data available</div>`;
}

// ===== Export CSV =====
exportCSVBtn.addEventListener("click", ()=>{
  const { assets, liabilities, equity } = calculateBalances();
  let csv = "Type,Account,Amount\n";
  for(const k in assets){ csv += `Asset,${k},${assets[k].toFixed(2)}\n`; }
  for(const k in liabilities){ csv += `Liability,${k},${liabilities[k].toFixed(2)}\n`; }
  for(const k in equity){ csv += `Equity,${k},${equity[k].toFixed(2)}\n`; }

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download="BalanceSheet.csv"; a.click();
  URL.revokeObjectURL(url);
});

// ===== Export PDF =====
exportPDFBtn.addEventListener("click", ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { assets, liabilities, equity } = calculateBalances();

  doc.setFontSize(18); doc.text("Balance Sheet",105,15,null,null,"center");
  doc.setFontSize(12); doc.text(`Generated for ${currentUser.email || "User"}`,105,23,null,null,"center");

  const rows = [];
  for(const k in assets){ rows.push(["Asset", k, `₹${assets[k].toFixed(2)}`]);}
  for(const k in liabilities){ rows.push(["Liability", k, `₹${liabilities[k].toFixed(2)}`]);}
  for(const k in equity){ rows.push(["Equity", k, `₹${equity[k].toFixed(2)}`]);}

  doc.autoTable({startY:35, head:[["Type","Account","Amount"]], body:rows, theme:"grid"});
  doc.save("BalanceSheet.pdf");
});
</script>
</body>
</html>