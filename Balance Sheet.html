<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Balance Sheet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-left {
      font-weight: bold;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #userInitials {
      background: #007bff;
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    #username {
      font-weight: bold;
    }

    #logoutBtn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #a71d2a;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .date-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-control label {
      font-weight: bold;
    }

    .date-control input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background-color: #218838;
    }

    .btn-primary {
      background-color: #007bff;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }

    .summary-card.assets {
      border-top: 4px solid #28a745;
      background-color: #f8fff9;
    }

    .summary-card.liabilities {
      border-top: 4px solid #dc3545;
      background-color: #fff8f8;
    }

    .summary-card.equity {
      border-top: 4px solid #007bff;
      background-color: #f8f9ff;
    }

    .card-title {
      font-size: 16px;
      color: #6c757d;
      margin-bottom: 10px;
    }

    .card-value {
      font-size: 24px;
      font-weight: bold;
    }

    .assets .card-value {
      color: #28a745;
    }

    .liabilities .card-value {
      color: #dc3545;
    }

    .equity .card-value {
      color: #007bff;
    }

    .balance-validation {
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .balance-valid {
      background-color: #d4edda;
      color: #155724;
    }

    .balance-invalid {
      background-color: #f8d7da;
      color: #721c24;
    }

    .chart-container {
      height: 300px;
      margin-bottom: 30px;
    }

    .balance-sheet-section {
      margin-bottom: 30px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }

    .section-header {
      padding: 15px;
      background-color: #f8f9fa;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
    }

    .section-body {
      padding: 15px;
    }

    .account-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .account-item:last-child {
      border-bottom: none;
    }

    .account-total {
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }

    .export-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body>

<!-- Top Header -->
<div class="header">
  <div class="header-left">
    <a href="home.html" style="text-decoration:none; color:#007bff; font-weight:bold;">
      <i class="fa fa-home"></i> Home
    </a>
    <span style="margin-left: 20px;" id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <h2><i class="fas fa-balance-scale"></i> Balance Sheet</h2>
  
  <!-- Controls -->
  <div class="controls">
    <div class="date-control">
      <label for="balanceSheetDate">As of:</label>
      <input type="date" id="balanceSheetDate" />
    </div>
    <div>
      <button id="generateReportBtn" class="btn-primary">
        <i class="fas fa-sync"></i> Generate Report
      </button>
      <button id="backToCOABtn" class="btn-secondary">
        <i class="fas fa-chart-pie"></i> Chart of Accounts
      </button>
    </div>
  </div>
  
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card assets">
      <div class="card-title">Total Assets</div>
      <div id="statAssets" class="card-value">$0.00</div>
    </div>
    <div class="summary-card liabilities">
      <div class="card-title">Total Liabilities</div>
      <div id="statLiabilities" class="card-value">$0.00</div>
    </div>
    <div class="summary-card equity">
      <div class="card-title">Total Equity</div>
      <div id="statEquity" class="card-value">$0.00</div>
    </div>
  </div>
  
  <!-- Balance Validation -->
  <div id="balanceValidation" class="balance-validation">
    Balance Sheet: <span id="balanceStatus">Not Calculated</span>
  </div>
  
  <!-- Chart -->
  <div class="chart-container">
    <canvas id="balanceSheetChart"></canvas>
  </div>
  
  <!-- Assets Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Assets</div>
    <div class="section-body" id="assetsBreakdown">
      <div class="account-item">
        <div>Loading assets...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Assets</div>
        <div id="totalAssetsValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Liabilities Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Liabilities</div>
    <div class="section-body" id="liabilitiesBreakdown">
      <div class="account-item">
        <div>Loading liabilities...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Liabilities</div>
        <div id="totalLiabilitiesValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Equity Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Equity</div>
    <div class="section-body" id="equityBreakdown">
      <div class="account-item">
        <div>Loading equity...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Equity</div>
        <div id="totalEquityValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Export Buttons -->
  <div class="export-buttons">
    <button id="exportCSV" class="btn-secondary">
      <i class="fas fa-file-csv"></i> Export CSV
    </button>
    <button id="exportPDF" class="btn-primary">
      <i class="fas fa-file-pdf"></i> Export PDF
    </button>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM elements
  const balanceSheetDateInput = document.getElementById("balanceSheetDate");
  const generateReportBtn = document.getElementById("generateReportBtn");
  const backToCOABtn = document.getElementById("backToCOABtn");
  const statAssets = document.getElementById("statAssets");
  const statLiabilities = document.getElementById("statLiabilities");
  const statEquity = document.getElementById("statEquity");
  const balanceValidation = document.getElementById("balanceValidation");
  const balanceStatus = document.getElementById("balanceStatus");
  const assetsBreakdown = document.getElementById("assetsBreakdown");
  const liabilitiesBreakdown = document.getElementById("liabilitiesBreakdown");
  const equityBreakdown = document.getElementById("equityBreakdown");
  const totalAssetsValue = document.getElementById("totalAssetsValue");
  const totalLiabilitiesValue = document.getElementById("totalLiabilitiesValue");
  const totalEquityValue = document.getElementById("totalEquityValue");
  const exportCSV = document.getElementById("exportCSV");
  const exportPDF = document.getElementById("exportPDF");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");

  let currentUser = null;
  let balanceSheetChartInstance = null;

  // Real-time clock
  function updateTime() {
    const now = new Date();
    if (datetimeElem) {
      datetimeElem.textContent = now.toLocaleString();
    }
  }
  setInterval(updateTime, 1000);
  updateTime();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;

      // Display name
      const nameToStore = user.displayName || user.email;
      usernameElem.textContent = nameToStore;
      profileCircle.textContent = nameToStore.charAt(0).toUpperCase();

      // Set default date to today
      const today = new Date();
      balanceSheetDateInput.value = formatDate(today);
      
      // Generate initial balance sheet
      await generateBalanceSheet();
    } else {
      setTimeout(() => {
        if (!auth.currentUser) {
          alert("You must be logged in.");
          window.location.href = "index.html";
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
  });

  backToCOABtn.addEventListener("click", () => {
    window.location.href = "coa.html";
  });

  generateReportBtn.addEventListener("click", () => {
    generateBalanceSheet();
  });

  // Format date to YYYY-MM-DD
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Load transactions up to the selected date
  async function loadTransactions(asOfDate) {
    try {
      const asOfTimestamp = new Date(asOfDate);
      asOfTimestamp.setHours(23, 59, 59, 999);
      
      const q = query(
        collection(db, "users", currentUser.uid, "transactions"), 
        orderBy("DATE", "asc")
      );
      
      const snap = await getDocs(q);
      const txs = snap.docs.map(d => ({ 
        id: d.id, 
        ...d.data(),
        NOTES: d.data().NOTES || d.data().DESCRIPTION || "",
        BANK_NAME: d.data().BANK_NAME || d.data().MODE || ""
      }));
      
      // Filter transactions that occurred on or before the selected date
      return txs.filter(tx => {
        if (!tx.DATE) return false;
        
        let transactionDate;
        if (typeof tx.DATE === 'string') {
          transactionDate = new Date(tx.DATE);
        } else if (tx.DATE && typeof tx.DATE.toDate === 'function') {
          transactionDate = tx.DATE.toDate();
        } else if (tx.DATE && typeof tx.DATE === 'object') {
          transactionDate = new Date(tx.DATE);
        } else {
          return false;
        }
        
        return transactionDate <= asOfTimestamp;
      });
    } catch (err) {
      console.error("loadTransactions", err);
      alert("Failed to load transactions");
      return [];
    }
  }

  // Load COA data
  async function loadCOAData() {
    try {
      const q = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"), 
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);
      const accounts = [];
      snapshot.forEach((docSnap) => {
        accounts.push({ id: docSnap.id, ...docSnap.data() });
      });
      return accounts;
    } catch (error) {
      console.error("Error loading COA data:", error);
      return [];
    }
  }

  // Generate balance sheet
  async function generateBalanceSheet() {
    const asOfDate = balanceSheetDateInput.value;
    if (!asOfDate) {
      alert("Please select a date for the balance sheet.");
      return;
    }
    
    const transactions = await loadTransactions(asOfDate);
    const coaAccounts = await loadCOAData();
    
    if (transactions.length === 0) {
      alert("No transactions found up to the selected date.");
      resetBalanceSheet();
      return;
    }
    
    // Process transactions to create balance sheet
    const balanceSheetData = processBalanceSheetData(transactions, coaAccounts);
    
    // Calculate totals
    const totalAssets = calculateTotal(balanceSheetData.assets);
    const totalLiabilities = calculateTotal(balanceSheetData.liabilities);
    const totalEquity = calculateTotal(balanceSheetData.equity);
    
    // Update UI
    updateBalanceSheetUI(balanceSheetData, totalAssets, totalLiabilities, totalEquity);
  }

  // Process transactions into balance sheet data
  function processBalanceSheetData(transactions, coaAccounts) {
    const balanceSheetData = {
      assets: {},
      liabilities: {},
      equity: {}
    };
    
    // Create account type mapping from COA
    const accountTypeMap = {};
    coaAccounts.forEach(account => {
      accountTypeMap[account.name] = account.type;
    });
    
    // Process each transaction
    transactions.forEach(tx => {
      const accountName = tx.ACCOUNT_HEADER || "Uncategorized";
      const income = parseFloat(tx.INCOME || 0);
      const expense = parseFloat(tx.EXPENSE || 0);
      const netAmount = income - expense;
      
      if (netAmount === 0) return;
      
      // Determine account type
      let accountType = accountTypeMap[accountName];
      
      // If account not found in COA, use intelligent classification
      if (!accountType) {
        accountType = classifyAccount(accountName, netAmount);
      }
      
      // Add to appropriate balance sheet category
      if (accountType === "Asset") {
        balanceSheetData.assets[accountName] = (balanceSheetData.assets[accountName] || 0) + netAmount;
      } else if (accountType === "Liability") {
        balanceSheetData.liabilities[accountName] = (balanceSheetData.liabilities[accountName] || 0) + netAmount;
      } else if (accountType === "Equity") {
        balanceSheetData.equity[accountName] = (balanceSheetData.equity[accountName] || 0) + netAmount;
      } else if (accountType === "Income") {
        // Income increases equity
        balanceSheetData.equity[accountName] = (balanceSheetData.equity[accountName] || 0) + netAmount;
      } else if (accountType === "Expense" || accountType === "COGS" || accountType === "OtherExpense") {
        // Expenses decrease equity
        balanceSheetData.equity[accountName] = (balanceSheetData.equity[accountName] || 0) - Math.abs(netAmount);
      }
    });
    
    return balanceSheetData;
  }

  // Intelligent account classification
  function classifyAccount(accountName, amount) {
    const name = accountName.toLowerCase();
    
    // Asset accounts
    if (name.includes('cash') || name.includes('bank') || name.includes('sbi') || 
        name.includes('axis') || name.includes('bom') || name.includes('investment') ||
        name.includes('property') || name.includes('equipment') || name.includes('asset') ||
        name.includes('account') || name.includes('saving') || name.includes('deposit')) {
      return "Asset";
    }
    
    // Liability accounts
    if (name.includes('loan') || name.includes('debt') || name.includes('credit') || 
        name.includes('payable') || name.includes('liability') || name.includes('borrow') ||
        name.includes('mortgage') || name.includes('overdraft')) {
      return "Liability";
    }
    
    // Equity accounts
    if (name.includes('equity') || name.includes('capital') || name.includes('retained') ||
        name.includes('owner') || name.includes('partner') || name.includes('share')) {
      return "Equity";
    }
    
    // Income accounts
    if (name.includes('sale') || name.includes('revenue') || name.includes('income') ||
        name.includes('fee') || name.includes('commission') || name.includes('interest')) {
      return "Income";
    }
    
    // Expense accounts
    if (name.includes('expense') || name.includes('cost') || name.includes('salary') ||
        name.includes('rent') || name.includes('utility') || name.includes('travel') ||
        name.includes('meal') || name.includes('petrol') || name.includes('auto') ||
        name.includes('home') || name.includes('medical') || name.includes('repair')) {
      return "Expense";
    }
    
    // Default based on amount
    return amount > 0 ? "Income" : "Expense";
  }

  // Calculate total for a category
  function calculateTotal(accounts) {
    return Object.values(accounts).reduce((total, amount) => total + amount, 0);
  }

  // Update balance sheet UI
  function updateBalanceSheetUI(balanceSheetData, totalAssets, totalLiabilities, totalEquity) {
    statAssets.textContent = `$${totalAssets.toFixed(2)}`;
    statLiabilities.textContent = `$${totalLiabilities.toFixed(2)}`;
    statEquity.textContent = `$${totalEquity.toFixed(2)}`;
    
    totalAssetsValue.textContent = `$${totalAssets.toFixed(2)}`;
    totalLiabilitiesValue.textContent = `$${totalLiabilities.toFixed(2)}`;
    totalEquityValue.textContent = `$${totalEquity.toFixed(2)}`;
    
    // Check if balance sheet balances
    const netWorth = totalAssets - (totalLiabilities + totalEquity);
    const isBalanced = Math.abs(netWorth) < 0.01;
    
    if (isBalanced) {
      balanceValidation.className = "balance-validation balance-valid";
      balanceStatus.textContent = "BALANCED ✓";
      balanceStatus.style.color = "#155724";
    } else {
      balanceValidation.className = "balance-validation balance-invalid";
      balanceStatus.textContent = `NOT BALANCED (Difference: $${Math.abs(netWorth).toFixed(2)}) ✗`;
      balanceStatus.style.color = "#721c24";
    }
    
    // Update breakdowns
    updateBreakdown(balanceSheetData.assets, assetsBreakdown);
    updateBreakdown(balanceSheetData.liabilities, liabilitiesBreakdown);
    updateBreakdown(balanceSheetData.equity, equityBreakdown);
    
    // Update chart
    updateChart(totalAssets, totalLiabilities, totalEquity);
  }

  // Reset balance sheet display
  function resetBalanceSheet() {
    statAssets.textContent = "$0.00";
    statLiabilities.textContent = "$0.00";
    statEquity.textContent = "$0.00";
    
    totalAssetsValue.textContent = "$0.00";
    totalLiabilitiesValue.textContent = "$0.00";
    totalEquityValue.textContent = "$0.00";
    
    assetsBreakdown.innerHTML = '<div class="account-item"><div>No assets data</div><div>$0.00</div></div>';
    liabilitiesBreakdown.innerHTML = '<div class="account-item"><div>No liabilities data</div><div>$0.00</div></div>';
    equityBreakdown.innerHTML = '<div class="account-item"><div>No equity data</div><div>$0.00</div></div>';
    
    balanceValidation.className = "balance-validation";
    balanceStatus.textContent = "Not Calculated";
    
    if (balanceSheetChartInstance) {
      balanceSheetChartInstance.destroy();
    }
  }

  // Update breakdown display
  function updateBreakdown(accounts, container) {
    if (Object.keys(accounts).length === 0) {
      container.innerHTML = '<div class="account-item"><div>No data available</div><div>$0.00</div></div>';
      return;
    }
    
    let html = "";
    Object.entries(accounts).forEach(([name, amount]) => {
      html += `
        <div class="account-item">
          <div>${escapeHtml(name)}</div>
          <div>$${amount.toFixed(2)}</div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  // Update chart
  function updateChart(totalAssets, totalLiabilities, totalEquity) {
    const ctx = document.getElementById('balanceSheetChart').getContext('2d');
    
    if (balanceSheetChartInstance) {
      balanceSheetChartInstance.destroy();
    }
    
    if (totalAssets === 0 && totalLiabilities === 0 && totalEquity === 0) {
      return;
    }
    
    balanceSheetChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ["Assets", "Liabilities", "Equity"],
        datasets: [{
          data: [totalAssets, totalLiabilities, totalEquity],
          backgroundColor: ["#28a745", "#dc3545", "#007bff"]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Balance Sheet Composition'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': $' + context.raw.toFixed(2);
              }
            }
          }
        }
      }
    });
  }

  // Export to CSV
  exportCSV.addEventListener("click", async () => {
    const asOfDate = balanceSheetDateInput.value;
    const transactions = await loadTransactions(asOfDate);
    const coaAccounts = await loadCOAData();
    const balanceSheetData = processBalanceSheetData(transactions, coaAccounts);
    
    const totalAssets = calculateTotal(balanceSheetData.assets);
    const totalLiabilities = calculateTotal(balanceSheetData.liabilities);
    const totalEquity = calculateTotal(balanceSheetData.equity);
    
    if (totalAssets === 0 && totalLiabilities === 0 && totalEquity === 0) {
      alert("There is no balance sheet data to export.");
      return;
    }
    
    let csvContent = "Category,Account,Amount\n";
    
    // Add assets
    csvContent += "Assets,,\n";
    Object.entries(balanceSheetData.assets).forEach(([name, amount]) => {
      csvContent += `,${name},${amount.toFixed(2)}\n`;
    });
    csvContent += `,Total Assets,${totalAssets.toFixed(2)}\n\n`;
    
    // Add liabilities
    csvContent += "Liabilities,,\n";
    Object.entries(balanceSheetData.liabilities).forEach(([name, amount]) => {
      csvContent += `,${name},${amount.toFixed(2)}\n`;
    });
    csvContent += `,Total Liabilities,${totalLiabilities.toFixed(2)}\n\n`;
    
    // Add equity
    csvContent += "Equity,,\n";
    Object.entries(balanceSheetData.equity).forEach(([name, amount]) => {
      csvContent += `,${name},${amount.toFixed(2)}\n`;
    });
    csvContent += `,Total Equity,${totalEquity.toFixed(2)}\n\n`;
    
    // Add totals
    csvContent += `,Total Liabilities & Equity,${(totalLiabilities + totalEquity).toFixed(2)}\n`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `balance_sheet_${asOfDate}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // Export to PDF
  exportPDF.addEventListener("click", () => {
    alert("PDF export would typically use a library like jsPDF. For now, you can use your browser's print functionality.");
    window.print();
  });

  // Helper function to escape HTML
  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>