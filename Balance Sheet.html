<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Balance Sheet</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;margin:0;padding:0;color:#333;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
header{background:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);border-radius:8px;margin-bottom:30px;}
.header-left a{text-decoration:none;color:#3498db;font-weight:bold;font-size:18px;display:flex;align-items:center;gap:8px;}
.header-right{display:flex;align-items:center;gap:15px;}
#userInitials{background:#3498db;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
#logoutBtn{background:#e74c3c;color:white;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
#logoutBtn:hover{background:#c0392b;}
h1{text-align:center;margin-bottom:30px;}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px;}
.summary-card{background:white;border-radius:8px;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.card-title{font-size:16px;color:#95a5a6;margin-bottom:10px;}
.card-value{font-size:24px;font-weight:700;}
.assets .card-value{color:#2ecc71;}
.liabilities .card-value{color:#e74c3c;}
.equity .card-value{color:#3498db;}
.details-section{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:768px){.details-section{grid-template-columns:1fr;}}
.assets-details,.liabilities-details{background:white;border-radius:8px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.section-title{font-size:18px;color:#2c3e50;margin-bottom:10px;border-bottom:1px solid #ecf0f1;padding-bottom:5px;}
.transaction-item{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f1f1f1;}
.transaction-item:last-child{border-bottom:none;}
.transaction-category{font-weight:600;}
.transaction-amount{font-weight:600;}
.assets-details .transaction-amount{color:#2ecc71;}
.liabilities-details .transaction-amount{color:#e74c3c;}
.chart-container{background:white;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
.export-buttons{display:flex;gap:10px;margin-bottom:20px;}
.export-buttons button{background:#3498db;color:white;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
.export-buttons button:hover{background:#2980b9;}
.loading-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;}
.loading-content{background:white;padding:30px;border-radius:8px;text-align:center;}
.empty-state{text-align:center;padding:20px;color:#95a5a6;}
.report-period{text-align:center;margin-bottom:20px;font-style:italic;color:#95a5a6;}
</style>
</head>
<body>

<header>
<div class="header-left"><a href="home.html"><i class="fa fa-home"></i> Home</a></div>
<div class="header-right">
<div id="userInitials">U</div>
<div id="username">User</div>
<button id="logoutBtn">Logout</button>
</div>
</header>

<div class="container">
<h1><i class="fas fa-balance-scale"></i> Balance Sheet</h1>

<div class="export-buttons">
<button id="exportCSV"><i class="fa fa-file-csv"></i> CSV</button>
<button id="exportPDF"><i class="fa fa-file-pdf"></i> PDF</button>
</div>

<div id="reportPeriodDisplay" class="report-period"></div>

<div class="summary-cards">
<div class="summary-card assets"><div class="card-title">Total Assets</div><div class="card-value" id="totalAssets">₹0.00</div></div>
<div class="summary-card liabilities"><div class="card-title">Total Liabilities</div><div class="card-value" id="totalLiabilities">₹0.00</div></div>
<div class="summary-card equity"><div class="card-title">Equity</div><div class="card-value" id="totalEquity">₹0.00</div></div>
</div>

<div class="chart-container">
<canvas id="balanceSheetChart"></canvas>
</div>

<div class="details-section">
<div class="assets-details">
<h3 class="section-title">Assets Breakdown</h3>
<div id="assetsBreakdown"></div>
</div>
<div class="liabilities-details">
<h3 class="section-title">Liabilities Breakdown</h3>
<div id="liabilitiesBreakdown"></div>
</div>
</div>
</div>

<div id="loadingModal" class="loading-modal">
<div class="loading-content"><i class="fa fa-spinner fa-spin" style="font-size:40px;margin-bottom:15px;"></i><p>Loading data...</p></div>
</div>

<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
            apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
            authDomain: "budget-app-1365f.firebaseapp.com",
            projectId: "budget-app-1365f",
            storageBucket: "budget-app-1365f.appspot.com",
            messagingSenderId: "1036194450411",
            appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
            measurementId: "G-YFFJL2H54X"
        });


const db = getFirestore(app);
const auth = getAuth(app);

// DOM Elements
const usernameElem=document.getElementById("username");
const initialsElem=document.getElementById("userInitials");
const logoutBtn=document.getElementById("logoutBtn");
const totalAssetsElem=document.getElementById("totalAssets");
const totalLiabilitiesElem=document.getElementById("totalLiabilities");
const totalEquityElem=document.getElementById("totalEquity");
const assetsBreakdownElem=document.getElementById("assetsBreakdown");
const liabilitiesBreakdownElem=document.getElementById("liabilitiesBreakdown");
const chartCanvas=document.getElementById("balanceSheetChart").getContext("2d");
const exportCSVBtn=document.getElementById("exportCSV");
const exportPDFBtn=document.getElementById("exportPDF");
const loadingModal=document.getElementById("loadingModal");

let currentUser=null;
let allAccounts=[];
let balanceChart=null;

// ===== Auth =====
onAuthStateChanged(auth,user=>{
if(user){
currentUser=user;
const name=user.displayName||user.email||"User";
usernameElem.textContent=name;
initialsElem.textContent=name.charAt(0).toUpperCase();
loadBalanceSheet();
}else{alert("Login required.");window.location.href="index.html";}
});

logoutBtn.addEventListener("click",async()=>{await signOut(auth);window.location.href="index.html";});

// ===== Load Balance Sheet =====
async function loadBalanceSheet(){
loadingModal.style.display="flex";
try{
const q=query(collection(db,"users",currentUser.uid,"accounts"),orderBy("ACCOUNT_TYPE"));
const snap=await getDocs(q);
allAccounts=snap.docs.map(d=>({id:d.id,...d.data()}));
updateBalanceSheet();
}catch(err){console.error(err);alert("Error: "+err.message);}finally{loadingModal.style.display="none";}
}

// ===== Update UI =====
function updateBalanceSheet(){
const assets=allAccounts.filter(a=>a.ACCOUNT_TYPE==="Asset");
const liabilities=allAccounts.filter(a=>a.ACCOUNT_TYPE==="Liability");

const totalAssets=assets.reduce((s,a)=>s+parseFloat(a.BALANCE||0),0);
const totalLiabilities=liabilities.reduce((s,a)=>s+parseFloat(a.BALANCE||0),0);
const totalEquity=totalAssets-totalLiabilities;

totalAssetsElem.textContent=`₹${totalAssets.toFixed(2)}`;
totalLiabilitiesElem.textContent=`₹${totalLiabilities.toFixed(2)}`;
totalEquityElem.textContent=`₹${totalEquity.toFixed(2)}`;

// Breakdown
updateBreakdown(assets,assetsBreakdownElem,"assets");
updateBreakdown(liabilities,liabilitiesBreakdownElem,"liabilities");

// Chart
updateChart(assets,totalAssets,liabilities,totalLiabilities,totalEquity);
}

function updateBreakdown(items,container,type){
if(items.length===0){container.innerHTML='<p class="empty-state"><i class="fa fa-info-circle"></i> No data</p>';return;}
container.innerHTML=items.map(i=>`<div class="transaction-item"><div class="transaction-category">${i.ACCOUNT_HEADER||i.ACCOUNT_NAME}</div><div class="transaction-amount">₹${parseFloat(i.BALANCE||0).toFixed(2)}</div></div>`).join("");
}

function updateChart(assets,totalAssets,liabilities,totalLiabilities,totalEquity){
const labels=["Assets","Liabilities","Equity"];
const data=[totalAssets,totalLiabilities,totalEquity];
if(balanceChart){balanceChart.destroy();}
balanceChart=new Chart(chartCanvas,{type:"doughnut",data:{labels,data,backgroundColor:["#2ecc71","#e74c3c","#3498db"]},options:{responsive:true}});
}

// ===== Export =====
exportCSVBtn.addEventListener("click",()=>{
if(allAccounts.length===0){alert("No data to export.");return;}
let csv="Account Type,Account Name,Balance\n";
allAccounts.forEach(a=>{csv+=`${a.ACCOUNT_TYPE},${a.ACCOUNT_HEADER||a.ACCOUNT_NAME},${a.BALANCE||0}\n`;});
const blob=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="BalanceSheet.csv";a.click();URL.revokeObjectURL(url);
});

exportPDFBtn.addEventListener("click",()=>{
if(allAccounts.length===0){alert("No data to export.");return;}
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.setFontSize(18);doc.text("Balance Sheet",105,15,null,null,"center");
doc.setFontSize(12);doc.text(`Generated for ${currentUser.email||"User"}`,105,23,null,null,"center");
doc.autoTable({startY:35,head:[["Type","Account","Balance"]],
body:allAccounts.map(a=>[a.ACCOUNT_TYPE,a.ACCOUNT_HEADER||a.ACCOUNT_NAME,a.BALANCE||0]),theme:"grid"});
doc.save("BalanceSheet.pdf");
});
</script>
</body>
</html>
