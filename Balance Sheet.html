<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Balance Sheet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      color: #4cd964;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #userInitials {
      background: #4cd964;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    #username {
      font-weight: bold;
      font-size: 16px;
    }

    #logoutBtn {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    #logoutBtn:hover {
      background-color: #c0392b;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: linear-gradient(to right, #f8f9fa, #e9ecef);
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .date-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-control label {
      font-weight: bold;
      color: #495057;
    }

    .date-control input {
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .date-control input:focus {
      outline: none;
      border-color: #4a6491;
      box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.2);
    }

    .controls-buttons {
      display: flex;
      gap: 15px;
    }

    button {
      background-color: #3498db;
      color: #fff;
      padding: 12px 24px;
      border: none;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #2980b9, #21618c);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }

    .btn-success {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #27ae60, #219653);
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
      margin-bottom: 35px;
    }

    .summary-card {
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: transform 0.3s;
    }

    .summary-card:hover {
      transform: translateY(-5px);
    }

    .summary-card.assets {
      border-top: 5px solid #2ecc71;
      background: linear-gradient(to bottom right, #f0f9f0, #e1f7e1);
    }

    .summary-card.liabilities {
      border-top: 5px solid #e74c3c;
      background: linear-gradient(to bottom right, #fdf0f0, #f9e1e1);
    }

    .summary-card.equity {
      border-top: 5px solid #3498db;
      background: linear-gradient(to bottom right, #f0f5ff, #e1ebff);
    }

    .card-title {
      font-size: 18px;
      color: #6c757d;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .card-value {
      font-size: 32px;
      font-weight: bold;
    }

    .assets .card-value {
      color: #27ae60;
    }

    .liabilities .card-value {
      color: #c0392b;
    }

    .equity .card-value {
      color: #2980b9;
    }

    .balance-validation {
      padding: 20px;
      margin: 25px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .balance-valid {
      background: linear-gradient(to right, #d4edda, #c3e6cb);
      color: #155724;
      border-left: 5px solid #28a745;
    }

    .balance-invalid {
      background: linear-gradient(to right, #f8d7da, #f1b0b7);
      color: #721c24;
      border-left: 5px solid #dc3545;
    }

    .chart-container {
      height: 320px;
      margin-bottom: 35px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .balance-sheet-section {
      margin-bottom: 30px;
      border: 1px solid #e1e5e9;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-header {
      padding: 18px 20px;
      background: linear-gradient(to right, #4a6491, #2c3e50);
      color: white;
      font-weight: bold;
      font-size: 20px;
      border-bottom: 1px solid #ddd;
    }

    .section-body {
      padding: 20px;
    }

    .account-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }

    .account-item:hover {
      background-color: #f8f9fa;
    }

    .account-item:last-child {
      border-bottom: none;
    }

    .account-total {
      font-weight: bold;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #ddd;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
    }

    .export-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
    }

    @media (max-width: 992px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .controls {
        flex-direction: column;
        gap: 20px;
      }
      
      .controls-buttons {
        width: 100%;
        justify-content: center;
      }
      
      .export-buttons {
        justify-content: center;
      }
    }

    .account-positive {
      color: #27ae60;
    }

    .account-negative {
      color: #e74c3c;
    }

    .account-name {
      font-weight: 500;
    }
  </style>
</head>
<body>

<!-- Top Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">
      <i class="fas fa-balance-scale"></i>
      FinanceTracker
    </div>
    <span id="datetime">Loading time...</span>
  </div>
  <div class="header-right">
    <div id="userInitials">U</div>
    <span id="username">User</span>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <h2><i class="fas fa-balance-scale"></i> Balance Sheet</h2>
  
  <!-- Controls -->
  <div class="controls">
    <div class="date-control">
      <label for="balanceSheetDate">As of:</label>
      <input type="date" id="balanceSheetDate" />
    </div>
    <div class="controls-buttons">
      <button id="generateReportBtn" class="btn-primary">
        <i class="fas fa-sync"></i> Generate Report
      </button>
      <button id="backToCOABtn" class="btn-secondary">
        <i class="fas fa-chart-pie"></i> Chart of Accounts
      </button>
    </div>
  </div>
  
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card assets">
      <div class="card-title">Total Assets</div>
      <div id="statAssets" class="card-value">$0.00</div>
    </div>
    <div class="summary-card liabilities">
      <div class="card-title">Total Liabilities</div>
      <div id="statLiabilities" class="card-value">$0.00</div>
    </div>
    <div class="summary-card equity">
      <div class="card-title">Total Equity</div>
      <div id="statEquity" class="card-value">$0.00</div>
    </div>
  </div>
  
  <!-- Balance Validation -->
  <div id="balanceValidation" class="balance-validation">
    Balance Sheet: <span id="balanceStatus">Not Calculated</span>
  </div>
  
  <!-- Chart -->
  <div class="chart-container">
    <canvas id="balanceSheetChart"></canvas>
  </div>
  
  <!-- Assets Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Assets</div>
    <div class="section-body" id="assetsBreakdown">
      <div class="account-item">
        <div>Loading assets...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Assets</div>
        <div id="totalAssetsValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Liabilities Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Liabilities</div>
    <div class="section-body" id="liabilitiesBreakdown">
      <div class="account-item">
        <div>Loading liabilities...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Liabilities</div>
        <div id="totalLiabilitiesValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Equity Section -->
  <div class="balance-sheet-section">
    <div class="section-header">Equity</div>
    <div class="section-body" id="equityBreakdown">
      <div class="account-item">
        <div>Loading equity...</div>
        <div>$0.00</div>
      </div>
    </div>
    <div class="section-body">
      <div class="account-item account-total">
        <div>Total Equity</div>
        <div id="totalEquityValue">$0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Export Buttons -->
  <div class="export-buttons">
    <button id="exportCSV" class="btn-secondary">
      <i class="fas fa-file-csv"></i> Export CSV
    </button>
    <button id="exportPDF" class="btn-success">
      <i class="fas fa-file-pdf"></i> Export PDF
    </button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhjgu6vpBRhMVjMs5RgSL4aViJq6GYy1A",
    authDomain: "budget-app-1365f.firebaseapp.com",
    projectId: "budget-app-1365f",
    storageBucket: "budget-app-1365f.appspot.com",
    messagingSenderId: "1036194450411",
    appId: "1:1036194450411:web:78ca39a5a82ab9db6c67ae",
    measurementId: "G-YFFJL2H54X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM elements
  const balanceSheetDateInput = document.getElementById("balanceSheetDate");
  const generateReportBtn = document.getElementById("generateReportBtn");
  const backToCOABtn = document.getElementById("backToCOABtn");
  const statAssets = document.getElementById("statAssets");
  const statLiabilities = document.getElementById("statLiabilities");
  const statEquity = document.getElementById("statEquity");
  const balanceValidation = document.getElementById("balanceValidation");
  const balanceStatus = document.getElementById("balanceStatus");
  const assetsBreakdown = document.getElementById("assetsBreakdown");
  const liabilitiesBreakdown = document.getElementById("liabilitiesBreakdown");
  const equityBreakdown = document.getElementById("equityBreakdown");
  const totalAssetsValue = document.getElementById("totalAssetsValue");
  const totalLiabilitiesValue = document.getElementById("totalLiabilitiesValue");
  const totalEquityValue = document.getElementById("totalEquityValue");
  const exportCSV = document.getElementById("exportCSV");
  const exportPDF = document.getElementById("exportPDF");
  const usernameElem = document.getElementById("username");
  const profileCircle = document.getElementById("userInitials");
  const logoutBtn = document.getElementById("logoutBtn");
  const datetimeElem = document.getElementById("datetime");

  let balanceSheetChartInstance = null;
  let currentUser = null;

  // Real-time clock
  function updateTime() {
    const now = new Date();
    if (datetimeElem) {
      datetimeElem.textContent = now.toLocaleString();
    }
  }
  setInterval(updateTime, 1000);
  updateTime();

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const storedUsername = localStorage.getItem("username");
      if (storedUsername) {
        usernameElem.textContent = storedUsername;
        profileCircle.textContent = storedUsername.charAt(0).toUpperCase();
      } else {
        const nameToStore = user.displayName || user.email;
        usernameElem.textContent = nameToStore;
        profileCircle.textContent = nameToStore.charAt(0).toUpperCase();
      }

      await initApp();
    } else {
      setTimeout(() => {
        if (!auth.currentUser) {
          alert("You must be logged in.");
          window.location.href = "index.html";
        }
      }, 500);
    }
  });

  logoutBtn.addEventListener("click", async () => {
    localStorage.removeItem("username");
    await signOut(auth);
    window.location.href = "index.html";
  });

  backToCOABtn.addEventListener("click", () => {
    window.location.href = "coa.html";
  });

  // Initialize the application
  async function initApp() {
    // Set default date to today
    const today = new Date();
    balanceSheetDateInput.value = formatDate(today);
    
    // Generate initial balance sheet
    await generateBalanceSheet();
  }

  // Event listeners
  generateReportBtn.addEventListener("click", async () => {
    await generateBalanceSheet();
  });

  // Format date to YYYY-MM-DD
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Generate balance sheet from Firebase data
  async function generateBalanceSheet() {
    if (!currentUser) return;

    try {
      // Get accounts from Chart of Accounts
      const accountsQuery = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid)
      );
      const accountsSnapshot = await getDocs(accountsQuery);
      
      const accounts = [];
      accountsSnapshot.forEach(doc => {
        accounts.push({ id: doc.id, ...doc.data() });
      });

      // Get all transactions
      const transactionsQuery = query(
        collection(db, "users", currentUser.uid, "transactions")
      );
      const transactionsSnapshot = await getDocs(transactionsQuery);
      
      // Calculate account balances
      const accountBalances = {};
      
      // Initialize all accounts with zero balance
      accounts.forEach(account => {
        accountBalances[account.id] = {
          name: account.name,
          type: account.type,
          category: account.category,
          balance: 0
        };
      });

      // Calculate balances from transactions
      transactionsSnapshot.forEach(doc => {
        const transaction = doc.data();
        const accountId = transaction.accountId;
        const amount = Number(transaction.amount || 0);
        
        if (accountBalances[accountId]) {
          accountBalances[accountId].balance += amount;
        }
      });

      // Categorize into balance sheet sections
      const balanceSheetData = {
        assets: {},
        liabilities: {},
        equity: {}
      };

      // Process each account based on type
      Object.values(accountBalances).forEach(account => {
        const balance = account.balance;
        
        switch(account.type) {
          case 'Asset':
            balanceSheetData.assets[account.name] = balance;
            break;
          case 'Liability':
            balanceSheetData.liabilities[account.name] = balance;
            break;
          case 'Equity':
            balanceSheetData.equity[account.name] = balance;
            break;
          case 'Income':
            // Income increases equity (credit balance)
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) + balance;
            break;
          case 'Expense':
          case 'COGS':
          case 'OtherExpense':
            // Expenses decrease equity (debit balance)
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) - balance;
            break;
          case 'OtherIncome':
            // Other income increases equity
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) + balance;
            break;
        }
      });

      // Calculate totals
      const totalAssets = calculateTotal(balanceSheetData.assets);
      const totalLiabilities = calculateTotal(balanceSheetData.liabilities);
      const totalEquity = calculateTotal(balanceSheetData.equity);
      
      // Update UI
      updateBalanceSheetUI(balanceSheetData, totalAssets, totalLiabilities, totalEquity);
      
    } catch (error) {
      console.error("Error generating balance sheet:", error);
      alert("Error generating balance sheet: " + error.message);
    }
  }

  // Update balance sheet UI
  function updateBalanceSheetUI(balanceSheetData, totalAssets, totalLiabilities, totalEquity) {
    statAssets.textContent = `$${totalAssets.toFixed(2)}`;
    statLiabilities.textContent = `$${totalLiabilities.toFixed(2)}`;
    statEquity.textContent = `$${totalEquity.toFixed(2)}`;
    
    totalAssetsValue.textContent = `$${totalAssets.toFixed(2)}`;
    totalLiabilitiesValue.textContent = `$${totalLiabilities.toFixed(2)}`;
    totalEquityValue.textContent = `$${totalEquity.toFixed(2)}`;
    
    // Check if balance sheet balances
    const netWorth = totalAssets - (totalLiabilities + totalEquity);
    const isBalanced = Math.abs(netWorth) < 0.01;
    
    if (isBalanced) {
      balanceValidation.className = "balance-validation balance-valid";
      balanceStatus.textContent = "BALANCED ✓";
      balanceStatus.style.color = "#155724";
    } else {
      balanceValidation.className = "balance-validation balance-invalid";
      balanceStatus.textContent = `NOT BALANCED (Difference: $${Math.abs(netWorth).toFixed(2)}) ✗`;
      balanceStatus.style.color = "#721c24";
    }
    
    // Update breakdowns
    updateBreakdown(balanceSheetData.assets, assetsBreakdown);
    updateBreakdown(balanceSheetData.liabilities, liabilitiesBreakdown);
    updateBreakdown(balanceSheetData.equity, equityBreakdown);
    
    // Update chart
    updateChart(totalAssets, totalLiabilities, totalEquity);
  }

  // Calculate total for a category
  function calculateTotal(accounts) {
    return Object.values(accounts).reduce((total, amount) => total + amount, 0);
  }

  // Update breakdown display
  function updateBreakdown(accounts, container) {
    if (Object.keys(accounts).length === 0) {
      container.innerHTML = '<div class="account-item"><div>No accounts found</div><div>$0.00</div></div>';
      return;
    }
    
    let html = "";
    Object.entries(accounts).forEach(([name, amount]) => {
      const amountClass = amount >= 0 ? "account-positive" : "account-negative";
      const amountDisplay = amount >= 0 ? `$${amount.toFixed(2)}` : `-$${Math.abs(amount).toFixed(2)}`;
      
      html += `
        <div class="account-item">
          <div class="account-name">${escapeHtml(name)}</div>
          <div class="${amountClass}">${amountDisplay}</div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  // Update chart
  function updateChart(totalAssets, totalLiabilities, totalEquity) {
    const ctx = document.getElementById('balanceSheetChart').getContext('2d');
    
    if (balanceSheetChartInstance) {
      balanceSheetChartInstance.destroy();
    }
    
    if (totalAssets === 0 && totalLiabilities === 0 && totalEquity === 0) {
      // Show empty state
      ctx.font = "16px Arial";
      ctx.fillStyle = "#6c757d";
      ctx.textAlign = "center";
      ctx.fillText("No balance sheet data available", ctx.canvas.width / 2, ctx.canvas.height / 2);
      return;
    }
    
    balanceSheetChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ["Assets", "Liabilities", "Equity"],
        datasets: [{
          data: [totalAssets, totalLiabilities, totalEquity],
          backgroundColor: ["#2ecc71", "#e74c3c", "#3498db"],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              font: {
                size: 14
              },
              padding: 20
            }
          },
          title: {
            display: true,
            text: 'Balance Sheet Composition',
            font: {
              size: 18
            },
            padding: 20
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': $' + context.raw.toFixed(2);
              }
            }
          }
        },
        cutout: '50%'
      }
    });
  }

  // Export to CSV
  exportCSV.addEventListener("click", async () => {
    if (!currentUser) return;

    try {
      // Regenerate data for export
      const accountsQuery = query(
        collection(db, "users", currentUser.uid, "chartOfAccounts"),
        where("userId", "==", currentUser.uid)
      );
      const accountsSnapshot = await getDocs(accountsQuery);
      
      const accounts = [];
      accountsSnapshot.forEach(doc => {
        accounts.push({ id: doc.id, ...doc.data() });
      });

      const transactionsQuery = query(
        collection(db, "users", currentUser.uid, "transactions")
      );
      const transactionsSnapshot = await getDocs(transactionsQuery);
      
      const accountBalances = {};
      accounts.forEach(account => {
        accountBalances[account.id] = {
          name: account.name,
          type: account.type,
          balance: 0
        };
      });

      transactionsSnapshot.forEach(doc => {
        const transaction = doc.data();
        const accountId = transaction.accountId;
        const amount = Number(transaction.amount || 0);
        
        if (accountBalances[accountId]) {
          accountBalances[accountId].balance += amount;
        }
      });

      const balanceSheetData = {
        assets: {},
        liabilities: {},
        equity: {}
      };

      Object.values(accountBalances).forEach(account => {
        const balance = account.balance;
        
        switch(account.type) {
          case 'Asset':
            balanceSheetData.assets[account.name] = balance;
            break;
          case 'Liability':
            balanceSheetData.liabilities[account.name] = balance;
            break;
          case 'Equity':
            balanceSheetData.equity[account.name] = balance;
            break;
          case 'Income':
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) + balance;
            break;
          case 'Expense':
          case 'COGS':
          case 'OtherExpense':
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) - balance;
            break;
          case 'OtherIncome':
            balanceSheetData.equity[account.name] = (balanceSheetData.equity[account.name] || 0) + balance;
            break;
        }
      });

      const totalAssets = calculateTotal(balanceSheetData.assets);
      const totalLiabilities = calculateTotal(balanceSheetData.liabilities);
      const totalEquity = calculateTotal(balanceSheetData.equity);
      
      if (totalAssets === 0 && totalLiabilities === 0 && totalEquity === 0) {
        alert("There is no balance sheet data to export.");
        return;
      }
      
      let csvContent = "Category,Account,Amount\n";
      
      // Add assets
      csvContent += "Assets,,\n";
      Object.entries(balanceSheetData.assets).forEach(([name, amount]) => {
        csvContent += `,${name},${amount.toFixed(2)}\n`;
      });
      csvContent += `,Total Assets,${totalAssets.toFixed(2)}\n\n`;
      
      // Add liabilities
      csvContent += "Liabilities,,\n";
      Object.entries(balanceSheetData.liabilities).forEach(([name, amount]) => {
        csvContent += `,${name},${amount.toFixed(2)}\n`;
      });
      csvContent += `,Total Liabilities,${totalLiabilities.toFixed(2)}\n\n`;
      
      // Add equity
      csvContent += "Equity,,\n";
      Object.entries(balanceSheetData.equity).forEach(([name, amount]) => {
        csvContent += `,${name},${amount.toFixed(2)}\n`;
      });
      csvContent += `,Total Equity,${totalEquity.toFixed(2)}\n\n`;
      
      // Add totals
      csvContent += `,Total Liabilities & Equity,${(totalLiabilities + totalEquity).toFixed(2)}\n`;
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `balance_sheet_${balanceSheetDateInput.value}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
    } catch (error) {
      alert("Error exporting CSV: " + error.message);
    }
  });

  // Export to PDF
  exportPDF.addEventListener("click", () => {
    alert("PDF export would typically use a library like jsPDF. For now, you can use your browser's print functionality.");
    window.print();
  });

  // Helper function to escape HTML
  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>